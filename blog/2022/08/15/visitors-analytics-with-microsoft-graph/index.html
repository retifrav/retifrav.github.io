<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Visitors analytics with Microsoft Graph | Declaration of VAR</title>
    <link rel="canonical" href="https://decovar.dev/blog/2022/08/15/visitors-analytics-with-microsoft-graph/" />

    <meta name="generator" content="Hugo 0.115.4" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <link href="/favicon.png" rel="icon">

    <meta name="author" content="retif" />
    <meta name="description" content="If your company uses Office 365 and Azure AD, and in turn you rely on SAML SSO login on your websites/resources, then for the purpose of analyzing your visitors you can query some useful data from Microsoft Graph and make some charts out of it." />

    <link rel="alternate" type="application/rss+xml" href="/index.xml" title="Declaration of VAR" />

    <meta property="og:title" content="Visitors analytics with Microsoft Graph" />
<meta property="og:description" content="If your company uses Office 365 and Azure AD, and in turn you rely on SAML SSO login on your websites/resources, then for the purpose of analyzing your visitors you can query some useful data from Microsoft Graph and make some charts out of it." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://retifrav.github.io/blog/2022/08/15/visitors-analytics-with-microsoft-graph/" /><meta property="article:section" content="blog" />
<meta property="article:published_time" content="2022-08-15T15:50:40+02:00" />
<meta property="article:modified_time" content="2022-08-15T15:50:40+02:00" />


    <link rel="stylesheet" href="https://retifrav.github.io/css/main.min.c1a9d5434fbba746ef09ebde219b0064b5d4318930fc8463f51550f13a0e1b54.css" />
    <link rel="stylesheet" href="/css/default.css" />
    <link rel="stylesheet" href="/css/post.css" />
    <link rel="stylesheet" href="/css/page.css" />
    <link rel="stylesheet" href="/css/comments.css" />

    <script src="/js/mark.js"></script>

    
    
  </head>
  <body>
    <div id="body-hat">
      <div id="title-block">
        <h1 id="blog-title"><a href="/">Declaration of VAR</a></h1>
        <p>and some other stuff</p>
      </div>
    </div>
    <div style="background-color:orange; padding:4px 16px; font-size:0.8em; text-align:center; font-style:italic;">
        On 19.05.2021 the website was moved to
        <a href="https://decovar.dev/blog/2022/08/15/visitors-analytics-with-microsoft-graph/" style="color:black; font-weight:bold;">
            https://decovar.dev/</a>. This is just a mirror now.
    </div>
    <div id="body-flex">
      <main class="app-container">
        
  <div id="main-container">
    <article class="post">
      <header class="post-header">
        <h1 class ="post-title">Visitors analytics with Microsoft Graph</h1>
        <div class="post-meta">
          <div><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-calendar">
  <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line>
</svg> 2022-08-15 15:50:40 &#43;0200</div>
          <div><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-clock">
  <circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline>
</svg> 27 min read</div>
        </div>
      </header>
      <div class="post-content">
        <p>Our company uses Office 365 and <a href="https://azure.microsoft.com/en-us/services/active-directory/">Azure Active Directory</a>, which allows us to rely on <a href="https://docs.microsoft.com/en-us/azure/active-directory/develop/active-directory-saml-protocol-reference">SAML SSO</a> for authenticating company users on our websites. At some point we got curious about what kind of users visit our websites - not quantities but kind of &ldquo;corporate demographics&rdquo;: what is their team/department name, their role/job title, their manager, country where their office is and so on.</p>


    <img class="image-post" loading="lazy" src="/blog/2022/08/15/visitors-analytics-with-microsoft-graph/images/microsoft-graph-charts.png" alt="Microsoft Graph and charts">

<p>We don&rsquo;t collect any of this data on our websites (<em>we probably could, at least on those where we control the authentication process, but we don&rsquo;t</em>). The only piece of information that we do have about our visitors (<em>aside from IP-addresses in web-servers access logs</em>) is their e-mails and GUIDs, thanks to SAML SSO. That might not seem like much, but knowing just the e-mails (<em>or GUIDs</em>) is actually quite enough, as one can use <a href="https://docs.microsoft.com/en-us/graph/overview">Microsoft Graph</a> to query more data using those. And for the actual analytics purposes that data can then be visualized/presented using <a href="https://matplotlib.org">Matplotlib</a> charts.</p>
<nav id="TableOfContents">
  <ul>
    <li><a href="#collecting-e-mails">Collecting e-mails</a>
      <ul>
        <li><a href="#in-house-cms">In-house CMS</a></li>
        <li><a href="#gitlab">GitLab</a></li>
        <li><a href="#jfrog-artifactory">JFrog Artifactory</a></li>
        <li><a href="#merging-e-mails-lists">Merging e-mails lists</a></li>
      </ul>
    </li>
    <li><a href="#querying-microsoft-graph">Querying Microsoft Graph</a>
      <ul>
        <li><a href="#api-access-token">API access token</a></li>
        <li><a href="#some-queries-examples">Some queries examples</a>
          <ul>
            <li><a href="#get-user-by-e-mail">Get user by e-mail</a></li>
            <li><a href="#get-users-manager">Get user&rsquo;s manager</a>
              <ul>
                <li><a href="#get-users-full-managers-chain">Get user&rsquo;s full managers chain</a></li>
              </ul>
            </li>
            <li><a href="#get-a-selected-set-of-users-properties">Get a selected set of user&rsquo;s properties</a></li>
            <li><a href="#get-all-users-groups">Get all user&rsquo;s groups</a>
              <ul>
                <li><a href="#get-only-meaningful-users-groups">Get only meaningful user&rsquo;s groups</a></li>
              </ul>
            </li>
          </ul>
        </li>
        <li><a href="#fetching-information-about-users">Fetching information about users</a></li>
      </ul>
    </li>
    <li><a href="#analytics">Analytics</a>
      <ul>
        <li><a href="#data-normalization">Data normalization</a></li>
        <li><a href="#charts">Charts</a>
          <ul>
            <li><a href="#users-by-countries">Users by countries</a></li>
            <li><a href="#users-heatmap-by-countries">Users heatmap by countries</a></li>
            <li><a href="#users-count-by-companies">Users count by companies</a></li>
            <li><a href="#joint-countries-and-companies-heatmap">Joint countries and companies heatmap</a></li>
            <li><a href="#users-by-job-titles">Users by job titles</a></li>
            <li><a href="#visualizing-the-managers-tree">Visualizing the managers tree</a>
              <ul>
                <li><a href="#composing-a-newick-tree">Composing a Newick tree</a></li>
                <li><a href="#ete-graphs">ETE graphs</a>
                  <ul>
                    <li><a href="#a-simple-tree-graph">A simple tree graph</a></li>
                    <li><a href="#rendering-problems-on-different-platforms">Rendering problems on different platforms</a></li>
                    <li><a href="#managers-tree-graph">Managers tree graph</a></li>
                  </ul>
                </li>
              </ul>
            </li>
          </ul>
        </li>
        <li><a href="#conclusion">Conclusion</a></li>
      </ul>
    </li>
  </ul>
</nav>
<h1 id="collecting-e-mails">Collecting e-mails</h1>
<p>We have several internal websites and services that rely on Azure AD SAML SSO for authentication:</p>
<ul>
<li>an in-house-made CMS</li>
<li>self-hosted <a href="https://gitlab.com">GitLab</a> instance</li>
<li>self-hosted <a href="https://jfrog.com/artifactory/">JFrog Artifactory</a> instance</li>
</ul>
<p>So the first task is to export users e-mails from each of those and merge them into one list.</p>
<h2 id="in-house-cms">In-house CMS</h2>
<p>This one is the easiest, as it uses our own SQLite database, and all the users e-mails get be queried like this:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#66d9ef">SELECT</span> email <span style="color:#66d9ef">FROM</span> users;</span></span></code></pre></div>
<p>Or, if we want to exclude our team (<em>roles <code>1</code> and <code>2</code></em>):</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#66d9ef">SELECT</span> <span style="color:#66d9ef">DISTINCT</span>(email) <span style="color:#66d9ef">FROM</span> users <span style="color:#66d9ef">AS</span> u
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">LEFT</span> <span style="color:#66d9ef">JOIN</span> users_roles <span style="color:#66d9ef">AS</span> r <span style="color:#66d9ef">ON</span> r.user_id <span style="color:#f92672">=</span> u.id
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">WHERE</span> r.role_id <span style="color:#66d9ef">IS</span> <span style="color:#66d9ef">NULL</span> <span style="color:#66d9ef">OR</span> r.role_id <span style="color:#66d9ef">NOT</span> <span style="color:#66d9ef">IN</span> (<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">2</span>);</span></span></code></pre></div>
<p>For convenience, that could be done in one line via SSH:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ ssh cms.our-company.com <span style="color:#e6db74">&#34;sqlite3 /data/cms.our-company.com/database.db &#39;SELECT DISTINCT(email) FROM users AS u LEFT JOIN users_roles AS r ON r.user_id = u.id WHERE r.role_id IS NULL OR r.role_id NOT IN (1, 2);&#39;&#34;</span> &gt; emails-cms.txt</span></span></code></pre></div>
<p>Of course, all that is unlikely to be directly applicable to your infrastructure, but it might be somewhat useful still, so I decided to mention this too.</p>
<h2 id="gitlab">GitLab</h2>
<p>Users profiles can be fetched using GitLab&rsquo;s <a href="https://docs.gitlab.com/ee/api/#rest-api">REST API</a>, for example:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ curl <span style="color:#e6db74">&#34;https://gitlab.our-company.com/api/v4/users?per_page=100&amp;page=1&#34;</span> -H <span style="color:#e6db74">&#39;Authorization: Bearer ADMIN-TOKEN-HERE&#39;</span> -o ./users-gitlab.json</span></span></code></pre></div>
<p>Results are paginated, and one page can only have 100 items maximum, so you&rsquo;ll have to execute as many requests as there are pages (<em><code>&amp;page=1</code>, <code>&amp;page=2</code>, etc</em>). If you have too many pages, perhaps you&rsquo;d want to automate the pages iteration too.</p>
<p>This endpoint returns the entire users profiles, not just e-mails, so you&rsquo;ll need to write some script to extract just the e-mails, for example <code>extract-emails-from-api-results.py</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-py" data-lang="py"><span style="display:flex;"><span><span style="color:#f92672">import</span> sys
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> json
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> pathlib
</span></span><span style="display:flex;"><span><span style="color:#75715e"># common auxiliary module</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> etc
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>argc <span style="color:#f92672">=</span> len(sys<span style="color:#f92672">.</span>argv)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> argc <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">2</span> <span style="color:#f92672">or</span> argc <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">2</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">raise</span> <span style="color:#a6e22e">SystemExit</span>(
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34; &#34;</span><span style="color:#f92672">.</span>join((
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;[ERROR] Expected the path to JSON file (.json) with results&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;from GitLab (and nothing else)&#34;</span>
</span></span><span style="display:flex;"><span>        ))
</span></span><span style="display:flex;"><span>    )
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>jsonFile <span style="color:#f92672">=</span> pathlib<span style="color:#f92672">.</span>Path(sys<span style="color:#f92672">.</span>argv[<span style="color:#ae81ff">1</span>])
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> jsonFile<span style="color:#f92672">.</span>suffix <span style="color:#f92672">!=</span> <span style="color:#e6db74">&#34;.json&#34;</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">raise</span> <span style="color:#a6e22e">SystemExit</span>(<span style="color:#e6db74">&#34;[ERROR] That doesn&#39;t look like a .json file&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> jsonFile<span style="color:#f92672">.</span>is_file():
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">raise</span> <span style="color:#a6e22e">SystemExit</span>(<span style="color:#e6db74">&#34;[ERROR] There is no such file&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>usersEmails <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span><span style="color:#75715e"># cnt = 0</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># cntWOus = 0</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">with</span> open(jsonFile, <span style="color:#e6db74">&#34;r&#34;</span>) <span style="color:#66d9ef">as</span> f:
</span></span><span style="display:flex;"><span>    gitlabUsers <span style="color:#f92672">=</span> json<span style="color:#f92672">.</span>load(f)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> user <span style="color:#f92672">in</span> gitlabUsers:
</span></span><span style="display:flex;"><span>        email <span style="color:#f92672">=</span> user[<span style="color:#e6db74">&#34;email&#34;</span>]
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># print(email)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># cnt += 1</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> etc<span style="color:#f92672">.</span>shouldIgnoreThatUser(email):
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># cntWOus += 1</span>
</span></span><span style="display:flex;"><span>            usersEmails<span style="color:#f92672">.</span>append(email)
</span></span><span style="display:flex;"><span><span style="color:#75715e"># print(f&#34;Total users: {cnt}, without our team: {cntWOus}&#34;)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># rename emails.txt to something else, for example emails-gitlab.txt,</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># otherwise you might forget and accidentally overwrite it</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">with</span> open(<span style="color:#e6db74">&#34;./emails.txt&#34;</span>, <span style="color:#e6db74">&#34;w&#34;</span>) <span style="color:#66d9ef">as</span> f:
</span></span><span style="display:flex;"><span>    f<span style="color:#f92672">.</span>write(<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span><span style="color:#f92672">.</span>join(usersEmails))</span></span></code></pre></div>
<p>The <code>etc.py</code> script contains some shared code that could be used by other scripts, such as blacklisting users from your team so they don&rsquo;t add &ldquo;noise&rdquo; into visitors analytics:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-py" data-lang="py"><span style="display:flex;"><span>yourCompanyUsers <span style="color:#f92672">=</span> [
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;witch.doctor@your-company.com&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;phantom.assassin@your-company.com&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;bounty.hunter@your-company.com&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># ...</span>
</span></span><span style="display:flex;"><span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">shouldIgnoreThatUser</span>(email):
</span></span><span style="display:flex;"><span>    email <span style="color:#f92672">=</span> email<span style="color:#f92672">.</span>lower()
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (
</span></span><span style="display:flex;"><span>        email <span style="color:#f92672">in</span> yourCompanyUsers
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">or</span> email<span style="color:#f92672">.</span>endswith(<span style="color:#e6db74">&#34;dota2.com&#34;</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">or</span> email<span style="color:#f92672">.</span>endswith(<span style="color:#e6db74">&#34;valvesoftware.com&#34;</span>)
</span></span><span style="display:flex;"><span>    ):
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">True</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">False</span></span></span></code></pre></div>
<p>And then you can extract the e-mails like this:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ python /path/to/extract-emails-from-api-results.py ./users-gitlab.json</span></span></code></pre></div>
<p>Alternatively, one can likely extract users e-mails directly from the database (<em>given that he has access to it</em>).</p>
<h2 id="jfrog-artifactory">JFrog Artifactory</h2>
<p>The Artifactory also has a <a href="https://jfrog.com/confluence/display/JFROG/Artifactory+REST+API">REST API</a>, and here&rsquo;s how you can get users profiles:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ curl -u admin:TOKEN-HERE https://artifactory.our-company.com/artifactory/api/security/users -o ./users-artifactory.json</span></span></code></pre></div>
<p>You can use the same <code>extract-emails-from-api-results.py</code> script as with <a href="#gitlab">GitLab</a>, just replace <code>user[&quot;email&quot;]</code> with <code>user[&quot;name&quot;]</code> and:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ python /path/to/extract-emails-from-api-results.py ./users-artifactory.json</span></span></code></pre></div>
<p>Some usernames in the Artifactory might not be e-mails, for example if you are also using local Active Directory authentication for your team or manually created accounts for external users. In that case you&rsquo;d need to get e-mails for each of such users from a <a href="https://jfrog.com/confluence/display/JFROG/Artifactory+REST+API#ArtifactoryRESTAPI-GetUserDetails">different endpoint/method</a>, which is tiresome. Luckily, we are not really interested in such users, as all the SAML SSO users do have e-mails as their usernames, so we can just filter out non-emails strings with <code>^[^@]*$</code> RegEx, either in a text editor or with <code>sed</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ sed -i <span style="color:#e6db74">&#34;/^[^@]*</span>$<span style="color:#e6db74">/d&#34;</span> /path/to/emails-artifactory.txt</span></span></code></pre></div>
<p>And again, instead of all that, one can probably just extract users e-mails directly from the database.</p>
<h2 id="merging-e-mails-lists">Merging e-mails lists</h2>
<p>Now when we have 3 lists of e-mails from all the websites, we can copy-paste them, for example, into Sublime Text and execute <code>Edit</code> → <code>Permute lines</code> → <code>Unique</code>, to get a merged list of unique e-mails.</p>
<p>Alternatively, you can try to do this with standard CLI tools. First merge all of them into one:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ sort -u ./emails-cms.txt ./emails-gitlab.txt ./emails-artifactory.txt &gt; ./merged.txt</span></span></code></pre></div>
<p>and then, for some weird reason, you&rsquo;d need to open the <code>merged.txt</code> and save it again without any modifications. Only after that the following will work properly:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ uniq ./merged.txt ./unique-emails.txt</span></span></code></pre></div>
<p>At least, that&rsquo;s how it was for me on Mac OS.</p>
<h1 id="querying-microsoft-graph">Querying Microsoft Graph</h1>
<p>Once you have a list of e-mails, you can query users data from Microsoft Graph.</p>
<h2 id="api-access-token">API access token</h2>
<p>Sign in to <a href="https://developer.microsoft.com/en-us/graph/graph-explorer">Graph Explorer</a> with your company&rsquo;s Office 365 account, open your browser&rsquo;s developer tools, go to <code>Network</code> tab and then click on <code>Run query</code> on the page. In the list of requests on the <code>Network</code> tab you&rsquo;ll be able to extract the <code>Authorization</code> header from one of the newly appeared GET requests. Or just copy it from <code>Access token</code> tab in the query editor on the page.</p>
<p>Having the token you&rsquo;ll be able to send requests to Microsoft Graph:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ curl <span style="color:#e6db74">&#34;https://graph.microsoft.com/v1.0/me/&#34;</span> -H <span style="color:#e6db74">&#39;Authorization: Bearer HERE-GOES-THE-BEARER-TOKEN-VALUE&#39;</span></span></span></code></pre></div>
<p>Microsoft&rsquo;s <a href="https://docs.microsoft.com/en-us/graph/auth/auth-concepts">documentation</a> and <a href="https://developer.microsoft.com/en-us/graph/quick-start">samples</a> suggest to register an application and obtain a permanent(?) access token, but for our purpose this looked like an overcomplicated overkill, while quickly getting a temporary access token in a manner that is described above was much easier.</p>
<h2 id="some-queries-examples">Some queries examples</h2>
<p>Knowing users e-mails (<em>or GUIDs</em>), you can query quite a lot of information about them. Perhaps, in your case this might be restricted by your company&rsquo;s Office 365 / Azure AD administrators, but I think this is the same information that is available when you hover over a user profile in Outlook or Teams clients, so chances are that this kind of data is always available to anyone (<em>within your organization, of course</em>).</p>
<h3 id="get-user-by-e-mail">Get user by e-mail</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ curl <span style="color:#e6db74">&#34;https://graph.microsoft.com/v1.0/users(&#39;someone@our-company.com&#39;)&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>     -H <span style="color:#e6db74">&#39;Authorization: Bearer HERE-GOES-THE-BEARER-TOKEN-VALUE&#39;</span></span></span></code></pre></div>
<p>From there you can get the user <code>id</code> (<em>which is his GUID</em>) and use it for the other queries (<em>or just continue to use the e-mail</em>).</p>
<h3 id="get-users-manager">Get user&rsquo;s manager</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ curl <span style="color:#e6db74">&#34;https://graph.microsoft.com/v1.0/users/USER-EMAIL-OR-GUID-HERE/manager&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>     -H <span style="color:#e6db74">&#39;Authorization: Bearer HERE-GOES-THE-BEARER-TOKEN-VALUE&#39;</span></span></span></code></pre></div>
<h4 id="get-users-full-managers-chain">Get user&rsquo;s full managers chain</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>curl <span style="color:#e6db74">&#34;https://graph.microsoft.com/v1.0/users/USER-EMAIL-OR-GUID-HERE?</span>$expand<span style="color:#e6db74">=manager(</span>$levels<span style="color:#e6db74">%3Dmax%3B</span>$select<span style="color:#e6db74">%3Dmail)&amp;</span>$select<span style="color:#e6db74">=id,displayName&amp;</span>$count<span style="color:#e6db74">=true&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>     -H <span style="color:#e6db74">&#39;Authorization: Bearer HERE-GOES-THE-BEARER-TOKEN-VALUE&#39;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>     -H <span style="color:#e6db74">&#39;ConsistencyLevel: eventual&#39;</span></span></span></code></pre></div>
<h3 id="get-a-selected-set-of-users-properties">Get a selected set of user&rsquo;s properties</h3>
<p>Specified user&rsquo;s <a href="https://docs.microsoft.com/en-us/graph/api/resources/user?view=graph-rest-1.0">properties</a> and his manager:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>curl <span style="color:#e6db74">&#34;https://graph.microsoft.com/v1.0/users/USER-EMAIL-OR-GUID-HERE?</span>$select<span style="color:#e6db74">=id,mail,displayName,createdDateTime,country,city,usageLocation,officeLocation,companyName,department,jobTitle&amp;</span>$expand<span style="color:#e6db74">=manager(</span>$select<span style="color:#e6db74">%3Did,mail,displayName)&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>     -H <span style="color:#e6db74">&#39;Authorization: Bearer HERE-GOES-THE-BEARER-TOKEN-VALUE&#39;</span></span></span></code></pre></div>
<p>This is the query that we&rsquo;ll be using <a href="#fetching-information-about-users">below</a> for fetching users data.</p>
<h3 id="get-all-users-groups">Get all user&rsquo;s groups</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ curl <span style="color:#e6db74">&#34;https://graph.microsoft.com/v1.0/users/USER-EMAIL-OR-GUID-HERE/memberOf/microsoft.graph.group?</span>$count<span style="color:#e6db74">=true&amp;</span>$orderby<span style="color:#e6db74">=displayName&amp;</span>$select<span style="color:#e6db74">=id,displayName&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>     -H <span style="color:#e6db74">&#39;Authorization: Bearer HERE-GOES-THE-BEARER-TOKEN-VALUE&#39;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>     -H <span style="color:#e6db74">&#39;ConsistencyLevel: eventual&#39;</span></span></span></code></pre></div>
<h4 id="get-only-meaningful-users-groups">Get only meaningful user&rsquo;s groups</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ curl -X <span style="color:#e6db74">&#34;POST&#34;</span> <span style="color:#e6db74">&#34;https://graph.microsoft.com/v1.0/users/USER-EMAIL-OR-GUID-HERE/getMemberGroups&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>     -H <span style="color:#e6db74">&#39;Authorization: Bearer HERE-GOES-THE-BEARER-TOKEN-VALUE&#39;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>     -H <span style="color:#e6db74">&#39;Content-Type: application/json; charset=utf-8&#39;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>     -d <span style="color:#e6db74">$&#39;{&#34;securityEnabledOnly&#34;: true}&#39;</span></span></span></code></pre></div>
<h2 id="fetching-information-about-users">Fetching information about users</h2>
<p>The querying of users data can be performed like this:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-py" data-lang="py"><span style="display:flex;"><span><span style="color:#f92672">import</span> sys
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> json
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> time
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> pandas
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> pandera
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> pathlib
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> requests
</span></span><span style="display:flex;"><span><span style="color:#75715e"># common auxiliary module</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> etc
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>argc <span style="color:#f92672">=</span> len(sys<span style="color:#f92672">.</span>argv)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> argc <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">2</span> <span style="color:#f92672">or</span> argc <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">2</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">raise</span> <span style="color:#a6e22e">SystemExit</span>(
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34; &#34;</span><span style="color:#f92672">.</span>join((
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;[ERROR] Expected the path to text file (.txt) with e-mails&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;(and nothing else)&#34;</span>
</span></span><span style="display:flex;"><span>        ))
</span></span><span style="display:flex;"><span>    )
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>txtFile <span style="color:#f92672">=</span> pathlib<span style="color:#f92672">.</span>Path(sys<span style="color:#f92672">.</span>argv[<span style="color:#ae81ff">1</span>])
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> txtFile<span style="color:#f92672">.</span>suffix <span style="color:#f92672">!=</span> <span style="color:#e6db74">&#34;.txt&#34;</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">raise</span> <span style="color:#a6e22e">SystemExit</span>(<span style="color:#e6db74">&#34;[ERROR] That doesn&#39;t look like a .txt file&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> txtFile<span style="color:#f92672">.</span>is_file():
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">raise</span> <span style="color:#a6e22e">SystemExit</span>(<span style="color:#e6db74">&#34;[ERROR] There is no such file&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>microsoftGraphAPI <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;https://graph.microsoft.com/v1.0&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># you can get token from https://developer.microsoft.com/en-us/graph/graph-explorer</span>
</span></span><span style="display:flex;"><span>authHeader <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Bearer TOKEN-HERE&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>emails <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">with</span> open(txtFile, <span style="color:#e6db74">&#34;r&#34;</span>) <span style="color:#66d9ef">as</span> f:
</span></span><span style="display:flex;"><span>    emails <span style="color:#f92672">=</span> f<span style="color:#f92672">.</span>read()<span style="color:#f92672">.</span>splitlines()
</span></span><span style="display:flex;"><span><span style="color:#75715e"># print(emails)</span>
</span></span><span style="display:flex;"><span>emailsCnt <span style="color:#f92672">=</span> len(emails)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># this is entirely optional, just some attempts to enforce types safety,</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># you most likely will be fine without it</span>
</span></span><span style="display:flex;"><span>usersTableSchema <span style="color:#f92672">=</span> pandera<span style="color:#f92672">.</span>DataFrameSchema(
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;id&#34;</span>: pandera<span style="color:#f92672">.</span>Column(str),
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;mail&#34;</span>: pandera<span style="color:#f92672">.</span>Column(str),
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;displayName&#34;</span>: pandera<span style="color:#f92672">.</span>Column(str, nullable<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>),
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;createdDateTime&#34;</span>: pandera<span style="color:#f92672">.</span>Column(str, nullable<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>),
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;country&#34;</span>: pandera<span style="color:#f92672">.</span>Column(str, nullable<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>),
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;city&#34;</span>: pandera<span style="color:#f92672">.</span>Column(str, nullable<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>),
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;usageLocation&#34;</span>: pandera<span style="color:#f92672">.</span>Column(str, nullable<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>),
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;officeLocation&#34;</span>: pandera<span style="color:#f92672">.</span>Column(str, nullable<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>),
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;companyName&#34;</span>: pandera<span style="color:#f92672">.</span>Column(str, nullable<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>),
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;department&#34;</span>: pandera<span style="color:#f92672">.</span>Column(str, nullable<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>),
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;jobTitle&#34;</span>: pandera<span style="color:#f92672">.</span>Column(str, nullable<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>),
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;managerID&#34;</span>: pandera<span style="color:#f92672">.</span>Column(str, nullable<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>),
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;managerMail&#34;</span>: pandera<span style="color:#f92672">.</span>Column(str, nullable<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>),
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;managerDisplayName&#34;</span>: pandera<span style="color:#f92672">.</span>Column(str, nullable<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>usersTable <span style="color:#f92672">=</span> pandas<span style="color:#f92672">.</span>DataFrame()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>failedLookup <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>cnt <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>successfulCnt <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>ignoredCnt <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> email <span style="color:#f92672">in</span> emails:
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">&#34;---&#34;</span>)
</span></span><span style="display:flex;"><span>    cnt <span style="color:#f92672">+=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;[</span><span style="color:#e6db74">{</span>cnt<span style="color:#e6db74">}</span><span style="color:#e6db74">/</span><span style="color:#e6db74">{</span>emailsCnt<span style="color:#e6db74">}</span><span style="color:#e6db74">] Looking up </span><span style="color:#e6db74">{</span>email<span style="color:#e6db74">}</span><span style="color:#e6db74">...&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> etc<span style="color:#f92672">.</span>shouldIgnoreThatUser(email):
</span></span><span style="display:flex;"><span>        ignoredCnt <span style="color:#f92672">+=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>        print(<span style="color:#e6db74">&#34;That is our team member, skipping&#34;</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">continue</span>
</span></span><span style="display:flex;"><span>    microsoftGraphRequest <span style="color:#f92672">=</span> requests<span style="color:#f92672">.</span>get(
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;</span><span style="color:#f92672">.</span>join((
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">{</span>microsoftGraphAPI<span style="color:#e6db74">}</span><span style="color:#e6db74">/users(&#39;</span><span style="color:#e6db74">{</span>email<span style="color:#e6db74">}</span><span style="color:#e6db74">&#39;)&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;?$select=id,mail,displayName,createdDateTime,country,city,&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;usageLocation,officeLocation,companyName,department,jobTitle&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;&amp;$expand=manager($select=id,mail,displayName)&#34;</span>
</span></span><span style="display:flex;"><span>        )),
</span></span><span style="display:flex;"><span>        headers<span style="color:#f92672">=</span>{<span style="color:#e6db74">&#34;Authorization&#34;</span>: authHeader}
</span></span><span style="display:flex;"><span>    )
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> microsoftGraphRequest<span style="color:#f92672">.</span>status_code <span style="color:#f92672">!=</span> <span style="color:#ae81ff">200</span>:
</span></span><span style="display:flex;"><span>        print(
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34; &#34;</span><span style="color:#f92672">.</span>join((
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;[ERROR] Request failed, status code:&#34;</span>,
</span></span><span style="display:flex;"><span>                str(microsoftGraphRequest<span style="color:#f92672">.</span>status_code)
</span></span><span style="display:flex;"><span>            ))
</span></span><span style="display:flex;"><span>        )
</span></span><span style="display:flex;"><span>        failedLookup<span style="color:#f92672">.</span>append(email)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>        successfulCnt <span style="color:#f92672">+=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>        userData <span style="color:#f92672">=</span> microsoftGraphRequest<span style="color:#f92672">.</span>json()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        managerData <span style="color:#f92672">=</span> userData<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#34;manager&#34;</span>)
</span></span><span style="display:flex;"><span>        row <span style="color:#f92672">=</span> pandas<span style="color:#f92672">.</span>DataFrame(
</span></span><span style="display:flex;"><span>            {
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;id&#34;</span>: userData[<span style="color:#e6db74">&#34;id&#34;</span>],
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;mail&#34;</span>: userData[<span style="color:#e6db74">&#34;mail&#34;</span>],
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;displayName&#34;</span>: userData[<span style="color:#e6db74">&#34;displayName&#34;</span>],
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;createdDateTime&#34;</span>: userData[<span style="color:#e6db74">&#34;createdDateTime&#34;</span>],
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;country&#34;</span>: userData[<span style="color:#e6db74">&#34;country&#34;</span>],
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;city&#34;</span>: userData[<span style="color:#e6db74">&#34;city&#34;</span>],
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;usageLocation&#34;</span>: userData[<span style="color:#e6db74">&#34;usageLocation&#34;</span>],
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;officeLocation&#34;</span>: userData[<span style="color:#e6db74">&#34;officeLocation&#34;</span>],
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;companyName&#34;</span>: userData[<span style="color:#e6db74">&#34;companyName&#34;</span>],
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;department&#34;</span>: userData[<span style="color:#e6db74">&#34;department&#34;</span>],
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;jobTitle&#34;</span>: userData[<span style="color:#e6db74">&#34;jobTitle&#34;</span>],
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;managerID&#34;</span>: managerData[<span style="color:#e6db74">&#34;id&#34;</span>] <span style="color:#66d9ef">if</span> managerData <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">None</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;managerMail&#34;</span>: managerData[<span style="color:#e6db74">&#34;mail&#34;</span>] <span style="color:#66d9ef">if</span> managerData <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">None</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;managerDisplayName&#34;</span>: managerData[<span style="color:#e6db74">&#34;displayName&#34;</span>] <span style="color:#66d9ef">if</span> managerData <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>            },
</span></span><span style="display:flex;"><span>            index<span style="color:#f92672">=</span>[cnt]
</span></span><span style="display:flex;"><span>        )
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># this is just to raise an exception in case of getting wrong types,</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># if you are using pandera to table schema validation</span>
</span></span><span style="display:flex;"><span>            usersTableSchema(row)
</span></span><span style="display:flex;"><span>            usersTable <span style="color:#f92672">=</span> pandas<span style="color:#f92672">.</span>concat([usersTable, row])
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">except</span> <span style="color:#a6e22e">Exception</span> <span style="color:#66d9ef">as</span> ex:
</span></span><span style="display:flex;"><span>            failedLookup<span style="color:#f92672">.</span>append(email)
</span></span><span style="display:flex;"><span>            print(
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;[ERROR] Wrong types, cannot insert that into the table. </span><span style="color:#e6db74">{</span>ex<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>,
</span></span><span style="display:flex;"><span>                file<span style="color:#f92672">=</span>sys<span style="color:#f92672">.</span>stderr
</span></span><span style="display:flex;"><span>            )
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># don&#39;t overwhelm Microsoft&#39;s servers, don&#39;t get banned</span>
</span></span><span style="display:flex;"><span>    time<span style="color:#f92672">.</span>sleep(<span style="color:#ae81ff">0.5</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>successfulLookups <span style="color:#f92672">=</span> usersTable<span style="color:#f92672">.</span>shape[<span style="color:#ae81ff">0</span>]
</span></span><span style="display:flex;"><span><span style="color:#75715e"># print()</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># print(usersTable)</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> (successfulLookups <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span>):
</span></span><span style="display:flex;"><span>    pickleFile <span style="color:#f92672">=</span> pathlib<span style="color:#f92672">.</span>Path(<span style="color:#e6db74">&#34;./users-table.pkl&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>        usersTable<span style="color:#f92672">.</span>to_pickle(pickleFile)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">except</span> <span style="color:#a6e22e">Exception</span> <span style="color:#66d9ef">as</span> ex:
</span></span><span style="display:flex;"><span>        print(
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;[ERROR] Couldn&#39;t save results to </span><span style="color:#e6db74">{</span>pickleFile<span style="color:#e6db74">}</span><span style="color:#e6db74">: </span><span style="color:#e6db74">{</span>ex<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>,
</span></span><span style="display:flex;"><span>            file<span style="color:#f92672">=</span>sys<span style="color:#f92672">.</span>stderr
</span></span><span style="display:flex;"><span>        )
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>failedLookupCnt <span style="color:#f92672">=</span> len(failedLookup)
</span></span><span style="display:flex;"><span>print(
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34; &#34;</span><span style="color:#f92672">.</span>join((
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">Total e-mails processed: </span><span style="color:#e6db74">{</span>emailsCnt<span style="color:#e6db74">}</span><span style="color:#e6db74">,&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;succeeded: </span><span style="color:#e6db74">{</span>successfulLookups<span style="color:#e6db74">}</span><span style="color:#e6db74">,&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;ignored: </span><span style="color:#e6db74">{</span>ignoredCnt<span style="color:#e6db74">}</span><span style="color:#e6db74">,&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;failed: </span><span style="color:#e6db74">{</span>failedLookupCnt<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>    ))
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> failedLookupCnt <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span>:
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">Failed e-mails (probably those are not from our company (or left it)):&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> email <span style="color:#f92672">in</span> failedLookup:
</span></span><span style="display:flex;"><span>        print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;- </span><span style="color:#e6db74">{</span>email<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)</span></span></code></pre></div>
<p>In short, what&rsquo;s going on here: for every e-mail in the list we query Microsoft Graph for user data and append it into resulting <a href="https://pandas.pydata.org">pandas</a> data frame.</p>
<p>When no data is returned for a particular user from Microsoft Graph, it can mean 3 things:</p>
<ol>
<li>This user is not from your company, so there is no information about him;</li>
<li>This user is from your company, but he has left it by now. I don&rsquo;t know why the user data wouldn&rsquo;t remain to be available in that case, but it&rsquo;s not;</li>
<li>Less likely, but still: just an error with the request, sending it again might succeed.</li>
</ol>
<p>To execute the script:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ python /path/to/lookup-users-in-microsoft-graph.py /path/to/unique-emails.txt</span></span></code></pre></div>
<p>The results will be saved to <code>users-table.pkl</code> pandas pickle, which we will then use to make charts/graphs for analytics.</p>
<h1 id="analytics">Analytics</h1>
<h2 id="data-normalization">Data normalization</h2>
<p>First thing we need to do is to normalize the data in <code>users-table.pkl</code> data frame. The reason is that users data is filled by different managers/administrators, and for example the same company name or job title might end up spelled differently, while for analytics purposes they should be spelled identically.</p>
<p>Here are some of the things that we&rsquo;d need to normalize:</p>
<ol>
<li>Company/department/team names, to &ldquo;merge&rdquo; different spelling of the same thing into one;</li>
<li>Country names, so they would correspond to their ISO values;</li>
<li>Job titles, to &ldquo;merge&rdquo; all the &ldquo;senior developer&rdquo;, &ldquo;backend developer&rdquo;, &ldquo;mega-dev-engineer&rdquo;, etc into just the &ldquo;developer&rdquo;.</li>
</ol>
<p>Such normalization can be performed like this:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-py" data-lang="py"><span style="display:flex;"><span><span style="color:#f92672">import</span> pandas
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> pathlib
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>tbl <span style="color:#f92672">=</span> pandas<span style="color:#f92672">.</span>read_pickle(<span style="color:#e6db74">&#34;/path/to/users-table.pkl&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>tblNormalized <span style="color:#f92672">=</span> tbl<span style="color:#f92672">.</span>copy()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>tblNormalized<span style="color:#f92672">.</span>companyName <span style="color:#f92672">=</span> (
</span></span><span style="display:flex;"><span>    tblNormalized<span style="color:#f92672">.</span>companyName
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># default company is Our Company (we have one global company consisting of several acquired ones),</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># so users without company property set in their profiles will get this value</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># and also different spelling variants of the name will end up as &#34;Our Company&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">.</span>apply(<span style="color:#66d9ef">lambda</span> x: <span style="color:#e6db74">&#34;Our Company&#34;</span> <span style="color:#66d9ef">if</span> (str(x) <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;Our Company AB&#34;</span> <span style="color:#f92672">or</span> <span style="color:#f92672">not</span> x) <span style="color:#66d9ef">else</span> x)
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># different variations of the same company name get the common part,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># for example &#34;Something Ltd&#34; and &#34;Something AS&#34; will become just &#34;Something&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">.</span>apply(<span style="color:#66d9ef">lambda</span> x: <span style="color:#e6db74">&#34;Something&#34;</span> <span style="color:#66d9ef">if</span> str(x)<span style="color:#f92672">.</span>startswith(<span style="color:#e6db74">&#34;Something&#34;</span>) <span style="color:#66d9ef">else</span> x)
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># and so on</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>tblNormalized<span style="color:#f92672">.</span>country <span style="color:#f92672">=</span> (
</span></span><span style="display:flex;"><span>    tblNormalized<span style="color:#f92672">.</span>country
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># default country name</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">.</span>apply(<span style="color:#66d9ef">lambda</span> x: <span style="color:#e6db74">&#34;Unknown&#34;</span> <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> x <span style="color:#66d9ef">else</span> x)
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># enforcing common/standardized names according to some dictionary/database</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">.</span>apply(<span style="color:#66d9ef">lambda</span> x: <span style="color:#e6db74">&#34;Switzerland&#34;</span> <span style="color:#66d9ef">if</span> (str(x) <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;SWITZERLAND&#34;</span>) <span style="color:#66d9ef">else</span> x)
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">.</span>apply(<span style="color:#66d9ef">lambda</span> x: <span style="color:#e6db74">&#34;Czechia&#34;</span> <span style="color:#66d9ef">if</span> (str(x) <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;Czech Republic&#34;</span>) <span style="color:#66d9ef">else</span> x)
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">.</span>apply(<span style="color:#66d9ef">lambda</span> x: <span style="color:#e6db74">&#34;UK&#34;</span> <span style="color:#66d9ef">if</span> (str(x) <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;United Kingdom&#34;</span>) <span style="color:#66d9ef">else</span> x)
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">.</span>apply(<span style="color:#66d9ef">lambda</span> x: <span style="color:#e6db74">&#34;USA&#34;</span> <span style="color:#66d9ef">if</span> (str(x) <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;United States&#34;</span> <span style="color:#f92672">or</span> str(x) <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;United States of America&#34;</span>) <span style="color:#66d9ef">else</span> x)
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># and so on</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># You&#39;ll be amazed by the number of possible variations of spelling the same job title.</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Unfortunately, you can&#39;t predict them all, so you can only inspect what you have</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># and adjust your normalization accordingly. Let&#39;s say we crudely grouped all the job titles</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># into the following categories:</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># - sales</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># - support</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># - developer</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># - architect</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># - lead</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># - manager</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># - director</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># - chief officer</span>
</span></span><span style="display:flex;"><span>tblNormalized<span style="color:#f92672">.</span>jobTitle <span style="color:#f92672">=</span> (
</span></span><span style="display:flex;"><span>    tblNormalized<span style="color:#f92672">.</span>jobTitle
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">.</span>apply(<span style="color:#66d9ef">lambda</span> x: <span style="color:#e6db74">&#34;Sales&#34;</span> <span style="color:#66d9ef">if</span> (
</span></span><span style="display:flex;"><span>            str(x) <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;Sales Representative / Account Manager&#34;</span>
</span></span><span style="display:flex;"><span>        ) <span style="color:#66d9ef">else</span> x)
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">.</span>apply(<span style="color:#66d9ef">lambda</span> x: <span style="color:#e6db74">&#34;Support&#34;</span> <span style="color:#66d9ef">if</span> (
</span></span><span style="display:flex;"><span>            str(x) <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;Support Engineer&#34;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">or</span> str(x) <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;Customer Support Engineer&#34;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">or</span> str(x) <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;Airborne Support Engineer&#34;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">or</span> str(x) <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;DevOps Engineer&#34;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">or</span> str(x) <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;Quality Assurance Engineer&#34;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">or</span> str(x) <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;Senior IT System Engineer&#34;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">or</span> str(x) <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;Software Test Engineer&#34;</span>
</span></span><span style="display:flex;"><span>        ) <span style="color:#66d9ef">else</span> x)
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">.</span>apply(<span style="color:#66d9ef">lambda</span> x: <span style="color:#e6db74">&#34;Developer&#34;</span> <span style="color:#66d9ef">if</span> (
</span></span><span style="display:flex;"><span>            str(x) <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;Developer&#34;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">or</span> str(x) <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;Application Engineer&#34;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">or</span> str(x) <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;C++ System Developer&#34;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">or</span> str(x) <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;Computer Vision Engineer&#34;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">or</span> str(x) <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;Développeur Logiciel&#34;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">or</span> str(x) <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;Entwicklung | Development&#34;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">or</span> str(x) <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;Experienced Software Engineer&#34;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">or</span> str(x) <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;external employee&#34;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">or</span> str(x) <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;Firmware Developer&#34;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">or</span> str(x) <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;Front End Developer&#34;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">or</span> str(x) <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;Fullstack Developer&#34;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">or</span> str(x) <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;Lead Software Engineer&#34;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">or</span> str(x) <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;Machining Process Engineer&#34;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">or</span> str(x) <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;Principal Developer&#34;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">or</span> str(x) <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;Senior Developer&#34;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">or</span> str(x) <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;Senior Software Developer&#34;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">or</span> str(x) <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;Software Developer&#34;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">or</span> str(x) <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;Senior Engineer&#34;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">or</span> str(x) <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;Senior Software Engineer&#34;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">or</span> str(x) <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;Consultant&#34;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">or</span> str(x) <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;Software Consultant&#34;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">or</span> str(x) <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;Principal Software Consultant&#34;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">or</span> str(x) <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;Principal Software Developer&#34;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">or</span> str(x) <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;Principal Software Engineer&#34;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">or</span> str(x) <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;Product Engineer&#34;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">or</span> str(x) <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;Project Engineer&#34;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">or</span> str(x) <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;R&amp;D Engineer&#34;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">or</span> str(x) <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;Senior Data Scientist&#34;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">or</span> str(x) <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;Senior Development Engineer&#34;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">or</span> str(x) <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;Senior Embedded Software Engineer&#34;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">or</span> str(x) <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;Senior Software Consultant&#34;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">or</span> str(x) <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;Software Development&#34;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">or</span> str(x) <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;Software Entwickler&#34;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">or</span> str(x) <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;Software Scientist&#34;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">or</span> str(x) <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;SR Software Engineer&#34;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">or</span> str(x) <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;Sr. Geospatial Scientist&#34;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">or</span> str(x) <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;Sr. SW Engineer&#34;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">or</span> str(x) <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;Sr., SW Developer&#34;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">or</span> str(x) <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;Web Developer&#34;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">or</span> str(x) <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;Software Integration Expert&#34;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">or</span> str(x) <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;Technical Prod. Spec-Content Hybrid/Sens&#34;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">or</span> str(x)<span style="color:#f92672">.</span>startswith(<span style="color:#e6db74">&#34;SW Developer&#34;</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">or</span> str(x)<span style="color:#f92672">.</span>startswith(<span style="color:#e6db74">&#34;SW Engineer&#34;</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">or</span> str(x)<span style="color:#f92672">.</span>startswith(<span style="color:#e6db74">&#34;Software Engineer&#34;</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">or</span> str(x)<span style="color:#f92672">.</span>startswith(<span style="color:#e6db74">&#34;Software Product Specialist&#34;</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">or</span> str(x)<span style="color:#f92672">.</span>startswith(<span style="color:#e6db74">&#34;Software Product Analyst&#34;</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">or</span> str(x)<span style="color:#f92672">.</span>startswith(<span style="color:#e6db74">&#34;Software Programmer&#34;</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">or</span> str(x)<span style="color:#f92672">.</span>startswith(<span style="color:#e6db74">&#34;Senior Industry Solution Consultant&#34;</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">or</span> str(x)<span style="color:#f92672">.</span>startswith(<span style="color:#e6db74">&#34;Contractor&#34;</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">or</span> str(x)<span style="color:#f92672">.</span>startswith(<span style="color:#e6db74">&#34;Development Eng&#34;</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">or</span> str(x)<span style="color:#f92672">.</span>startswith(<span style="color:#e6db74">&#34;Eng-Software-Level&#34;</span>)
</span></span><span style="display:flex;"><span>        ) <span style="color:#66d9ef">else</span> x)
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">.</span>apply(<span style="color:#66d9ef">lambda</span> x: <span style="color:#e6db74">&#34;Architect&#34;</span> <span style="color:#66d9ef">if</span> <span style="color:#e6db74">&#34;architect&#34;</span> <span style="color:#f92672">in</span> str(x)<span style="color:#f92672">.</span>lower() <span style="color:#66d9ef">else</span> x)
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">.</span>apply(<span style="color:#66d9ef">lambda</span> x: <span style="color:#e6db74">&#34;Lead&#34;</span> <span style="color:#66d9ef">if</span> <span style="color:#e6db74">&#34;lead&#34;</span> <span style="color:#f92672">in</span> str(x)<span style="color:#f92672">.</span>lower() <span style="color:#66d9ef">else</span> x)
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">.</span>apply(<span style="color:#66d9ef">lambda</span> x: <span style="color:#e6db74">&#34;Manager&#34;</span> <span style="color:#66d9ef">if</span> (
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;manager&#34;</span> <span style="color:#f92672">in</span> str(x)<span style="color:#f92672">.</span>lower()
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">or</span> <span style="color:#e6db74">&#34;head&#34;</span> <span style="color:#f92672">in</span> str(x)<span style="color:#f92672">.</span>lower()
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">or</span> <span style="color:#e6db74">&#34;owner&#34;</span> <span style="color:#f92672">in</span> str(x)<span style="color:#f92672">.</span>lower()
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">or</span> <span style="color:#e6db74">&#34;supervisor&#34;</span> <span style="color:#f92672">in</span> str(x)<span style="color:#f92672">.</span>lower()
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">or</span> str(x)<span style="color:#f92672">.</span>startswith(<span style="color:#e6db74">&#34;Mgr&#34;</span>)
</span></span><span style="display:flex;"><span>        ) <span style="color:#66d9ef">else</span> x)
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">.</span>apply(<span style="color:#66d9ef">lambda</span> x: <span style="color:#e6db74">&#34;Director&#34;</span> <span style="color:#66d9ef">if</span> <span style="color:#e6db74">&#34;director&#34;</span> <span style="color:#f92672">in</span> str(x)<span style="color:#f92672">.</span>lower() <span style="color:#66d9ef">else</span> x)
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">.</span>apply(<span style="color:#66d9ef">lambda</span> x: <span style="color:#e6db74">&#34;Chief Officer&#34;</span> <span style="color:#66d9ef">if</span> (
</span></span><span style="display:flex;"><span>            str(x) <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;CTO&#34;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">or</span> <span style="color:#e6db74">&#34;chief&#34;</span> <span style="color:#f92672">in</span> str(x)<span style="color:#f92672">.</span>lower()
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">or</span> <span style="color:#e6db74">&#34;vp&#34;</span> <span style="color:#f92672">in</span> str(x)<span style="color:#f92672">.</span>lower()
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">or</span> <span style="color:#e6db74">&#34;president&#34;</span> <span style="color:#f92672">in</span> str(x)<span style="color:#f92672">.</span>lower()
</span></span><span style="display:flex;"><span>        ) <span style="color:#66d9ef">else</span> x)
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># exclude our team</span>
</span></span><span style="display:flex;"><span>tblNormalized <span style="color:#f92672">=</span> tblNormalized[tblNormalized<span style="color:#f92672">.</span>companyName <span style="color:#f92672">!=</span> <span style="color:#e6db74">&#34;ourTeamName&#34;</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># just in case</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#tblNormalized.to_pickle(&#34;./users-table-normalized.pkl&#34;)</span></span></span></code></pre></div>
<p>Below we&rsquo;ll be using the normalized pandas data frame (<em><code>tblNormalized</code>, stored in <code>users-table-normalized.pkl</code></em>) for making charts.</p>
<h2 id="charts">Charts</h2>
<h3 id="users-by-countries">Users by countries</h3>
<p>The script:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-py" data-lang="py"><span style="display:flex;"><span><span style="color:#f92672">import</span> numpy
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> pandas
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> matplotlib.pyplot <span style="color:#66d9ef">as</span> plt
</span></span><span style="display:flex;"><span>plt<span style="color:#f92672">.</span>rcParams[<span style="color:#e6db74">&#34;figure.facecolor&#34;</span>] <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;white&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>tblNormalized <span style="color:#f92672">=</span> pandas<span style="color:#f92672">.</span>read_pickle(<span style="color:#e6db74">&#34;./users-table-normalized.pkl&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>countriesCounts <span style="color:#f92672">=</span> tblNormalized<span style="color:#f92672">.</span>value_counts(subset<span style="color:#f92672">=</span>[<span style="color:#e6db74">&#34;country&#34;</span>])
</span></span><span style="display:flex;"><span><span style="color:#75715e"># print([c[0] for c in countriesCounts.index.to_numpy()])</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># print(countriesCounts.values)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>fig, ax <span style="color:#f92672">=</span> plt<span style="color:#f92672">.</span>subplots(
</span></span><span style="display:flex;"><span>    <span style="color:#ae81ff">1</span>,
</span></span><span style="display:flex;"><span>    figsize<span style="color:#f92672">=</span>(<span style="color:#ae81ff">12</span>, <span style="color:#ae81ff">8</span>),
</span></span><span style="display:flex;"><span>    dpi<span style="color:#f92672">=</span><span style="color:#ae81ff">120</span>,
</span></span><span style="display:flex;"><span>    tight_layout<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>ax<span style="color:#f92672">.</span>bar(
</span></span><span style="display:flex;"><span>    [c[<span style="color:#ae81ff">0</span>] <span style="color:#66d9ef">for</span> c <span style="color:#f92672">in</span> countriesCounts<span style="color:#f92672">.</span>index<span style="color:#f92672">.</span>to_numpy()],
</span></span><span style="display:flex;"><span>    countriesCounts<span style="color:#f92672">.</span>values,
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">#edgecolor=&#34;green&#34;,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># linewidth=1.0,</span>
</span></span><span style="display:flex;"><span>    label<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;Number of visitors&#34;</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> i, v <span style="color:#f92672">in</span> enumerate(countriesCounts<span style="color:#f92672">.</span>values):
</span></span><span style="display:flex;"><span>    ax<span style="color:#f92672">.</span>annotate(str(v), xy<span style="color:#f92672">=</span>(i,v), xytext<span style="color:#f92672">=</span>(<span style="color:#f92672">-</span><span style="color:#ae81ff">6</span>,<span style="color:#ae81ff">6</span>), textcoords<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;offset points&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>locs, labels <span style="color:#f92672">=</span> plt<span style="color:#f92672">.</span>xticks()
</span></span><span style="display:flex;"><span>plt<span style="color:#f92672">.</span>setp(labels, rotation<span style="color:#f92672">=</span><span style="color:#ae81ff">45</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>ax<span style="color:#f92672">.</span>grid(<span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>ax<span style="color:#f92672">.</span>legend()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#plt.show()</span>
</span></span><span style="display:flex;"><span>plt<span style="color:#f92672">.</span>savefig(<span style="color:#e6db74">&#34;./countries-counts.png&#34;</span>)
</span></span><span style="display:flex;"><span>plt<span style="color:#f92672">.</span>close(fig)</span></span></code></pre></div>
<p>Result:</p>


    <img class="image-post" loading="lazy" src="/blog/2022/08/15/visitors-analytics-with-microsoft-graph/images/countries-counts.png" alt="Countries count">

<h3 id="users-heatmap-by-countries">Users heatmap by countries</h3>
<p>The script (<em>based on <a href="https://stackoverflow.com/a/59301096/1688203">this</a></em>):</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-py" data-lang="py"><span style="display:flex;"><span><span style="color:#f92672">import</span> numpy
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> pandas
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> matplotlib.pyplot <span style="color:#66d9ef">as</span> plt
</span></span><span style="display:flex;"><span>plt<span style="color:#f92672">.</span>rcParams[<span style="color:#e6db74">&#34;figure.facecolor&#34;</span>] <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;white&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> plotly.express <span style="color:#66d9ef">as</span> px
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>tblNormalized <span style="color:#f92672">=</span> pandas<span style="color:#f92672">.</span>read_pickle(<span style="color:#e6db74">&#34;./users-table-normalized.pkl&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>tblISOcountries <span style="color:#f92672">=</span> tblNormalized<span style="color:#f92672">.</span>copy()
</span></span><span style="display:flex;"><span>tblISOcountries<span style="color:#f92672">.</span>country <span style="color:#f92672">=</span> (
</span></span><span style="display:flex;"><span>    tblISOcountries<span style="color:#f92672">.</span>country
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">.</span>apply(<span style="color:#66d9ef">lambda</span> x: <span style="color:#e6db74">&#34;Czech Republic&#34;</span> <span style="color:#66d9ef">if</span> (str(x) <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;Czechia&#34;</span>) <span style="color:#66d9ef">else</span> x) <span style="color:#75715e"># &#34;CZE&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">.</span>apply(<span style="color:#66d9ef">lambda</span> x: <span style="color:#e6db74">&#34;United States&#34;</span> <span style="color:#66d9ef">if</span> (str(x) <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;USA&#34;</span>) <span style="color:#66d9ef">else</span> x) <span style="color:#75715e"># &#34;CZE&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">.</span>apply(<span style="color:#66d9ef">lambda</span> x: <span style="color:#e6db74">&#34;United Kingdom&#34;</span> <span style="color:#66d9ef">if</span> (str(x) <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;UK&#34;</span>) <span style="color:#66d9ef">else</span> x) <span style="color:#75715e"># &#34;GBR&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># and so on</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>gapminder <span style="color:#f92672">=</span> px<span style="color:#f92672">.</span>data<span style="color:#f92672">.</span>gapminder()<span style="color:#f92672">.</span>query(<span style="color:#e6db74">&#34;year==2007&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#75715e"># here you can view the full list of country names used by choropleth locations</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#display(gapminder)</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#gapminder[&#34;count&#34;] = numpy.nan</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#print(gapminder.query(&#34;country.str.contains(&#39;ingapo&#39;)&#34;))</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>countriesData <span style="color:#f92672">=</span> tblISOcountries<span style="color:#f92672">.</span>value_counts(subset<span style="color:#f92672">=</span>[<span style="color:#e6db74">&#34;country&#34;</span>])<span style="color:#f92672">.</span>reset_index()
</span></span><span style="display:flex;"><span>countriesData<span style="color:#f92672">.</span>columns<span style="color:#f92672">=</span>[<span style="color:#e6db74">&#34;country&#34;</span>, <span style="color:#e6db74">&#34;Visitors&#34;</span>]
</span></span><span style="display:flex;"><span><span style="color:#75715e">#display(countriesData)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>fig <span style="color:#f92672">=</span> px<span style="color:#f92672">.</span>choropleth(
</span></span><span style="display:flex;"><span>    pandas<span style="color:#f92672">.</span>merge(gapminder, countriesData, how<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;left&#34;</span>, on<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;country&#34;</span>),
</span></span><span style="display:flex;"><span>    locations<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;iso_alpha&#34;</span>,
</span></span><span style="display:flex;"><span>    color<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;Visitors&#34;</span>, 
</span></span><span style="display:flex;"><span>    hover_name<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;country&#34;</span>,
</span></span><span style="display:flex;"><span>    width<span style="color:#f92672">=</span><span style="color:#ae81ff">1920</span>,
</span></span><span style="display:flex;"><span>    height<span style="color:#f92672">=</span><span style="color:#ae81ff">720</span>,
</span></span><span style="display:flex;"><span>    color_continuous_scale<span style="color:#f92672">=</span>px<span style="color:#f92672">.</span>colors<span style="color:#f92672">.</span>sequential<span style="color:#f92672">.</span>Emrld
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>fig<span style="color:#f92672">.</span>update_layout(
</span></span><span style="display:flex;"><span>    margin<span style="color:#f92672">=</span>dict(l<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>,r<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>,b<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>,t<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>),
</span></span><span style="display:flex;"><span>    geo<span style="color:#f92672">=</span>dict(
</span></span><span style="display:flex;"><span>        resolution<span style="color:#f92672">=</span><span style="color:#ae81ff">50</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">#showocean=True,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">#showland=True,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">#lonaxis=dict(showgrid=True),</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">#projection=dict(scale=1)</span>
</span></span><span style="display:flex;"><span>        showcountries<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>
</span></span><span style="display:flex;"><span>    )
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span><span style="color:#75715e">#fig.show()</span>
</span></span><span style="display:flex;"><span>fig<span style="color:#f92672">.</span>write_image(<span style="color:#e6db74">&#34;./countries-heatmap.png&#34;</span>)</span></span></code></pre></div>
<p>Here we are using <a href="https://plotly.com/python/">Plotly</a> library, and its documentation for <a href="https://plotly.com/python/choropleth-maps/#using-builtin-country-and-state-geometries">choropleth</a> states that <code>iso_alpha</code> value for <code>locations</code> means that it is <a href="https://en.wikipedia.org/wiki/ISO_3166-1_alpha-3">three-letter ISO country codes</a>. But in reality, as you can see in the code above, it&rsquo;s fucking not three-letter codes but full country names, and not just any names but exactly those contained in <code>px.data.gapminder().query(&quot;year==2007&quot;)</code>. Just how is one supposed to discover that?</p>
<p>Anyway, here&rsquo;s the result:</p>


    <img class="image-post" loading="lazy" src="/blog/2022/08/15/visitors-analytics-with-microsoft-graph/images/countries-heatmap.png" alt="Countries heatmap">

<p>&hellip;But actually that is not the result that you&rsquo;ll get - you&rsquo;ll get something uglier because of the uncontrollable margins/paddings, which I&rsquo;ve never managed to set right in code and so I&rsquo;ve just edited the resulting picture to my liking.</p>
<p>So yeah, I did not enjoy working with Plotly.</p>
<h3 id="users-count-by-companies">Users count by companies</h3>
<p>The script:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-py" data-lang="py"><span style="display:flex;"><span><span style="color:#f92672">import</span> numpy
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> pandas
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> matplotlib.pyplot <span style="color:#66d9ef">as</span> plt
</span></span><span style="display:flex;"><span>plt<span style="color:#f92672">.</span>rcParams[<span style="color:#e6db74">&#34;figure.facecolor&#34;</span>] <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;white&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>tblNormalized <span style="color:#f92672">=</span> pandas<span style="color:#f92672">.</span>read_pickle(<span style="color:#e6db74">&#34;./users-table-normalized.pkl&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>companiesCounts <span style="color:#f92672">=</span> tblNormalized<span style="color:#f92672">.</span>value_counts(subset<span style="color:#f92672">=</span>[<span style="color:#e6db74">&#34;companyName&#34;</span>])
</span></span><span style="display:flex;"><span><span style="color:#75715e"># print([c[0] for c in companiesCounts.index.to_numpy()])</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># print(companiesCounts.values)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>fig, ax <span style="color:#f92672">=</span> plt<span style="color:#f92672">.</span>subplots(
</span></span><span style="display:flex;"><span>    <span style="color:#ae81ff">1</span>,
</span></span><span style="display:flex;"><span>    figsize<span style="color:#f92672">=</span>(<span style="color:#ae81ff">12</span>, <span style="color:#ae81ff">8</span>),
</span></span><span style="display:flex;"><span>    dpi<span style="color:#f92672">=</span><span style="color:#ae81ff">120</span>,
</span></span><span style="display:flex;"><span>    tight_layout<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>ax<span style="color:#f92672">.</span>bar(
</span></span><span style="display:flex;"><span>    [c[<span style="color:#ae81ff">0</span>] <span style="color:#66d9ef">for</span> c <span style="color:#f92672">in</span> companiesCounts<span style="color:#f92672">.</span>index<span style="color:#f92672">.</span>to_numpy()],
</span></span><span style="display:flex;"><span>    companiesCounts<span style="color:#f92672">.</span>values,
</span></span><span style="display:flex;"><span>    label<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;Number of visitors&#34;</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> i, v <span style="color:#f92672">in</span> enumerate(companiesCounts<span style="color:#f92672">.</span>values):
</span></span><span style="display:flex;"><span>    ax<span style="color:#f92672">.</span>annotate(str(v), xy<span style="color:#f92672">=</span>(i,v), xytext<span style="color:#f92672">=</span>(<span style="color:#f92672">-</span><span style="color:#ae81ff">6</span>,<span style="color:#ae81ff">6</span>), textcoords<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;offset points&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#locs, labels = plt.xticks()</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#plt.setp(labels, rotation=90)</span>
</span></span><span style="display:flex;"><span>plt<span style="color:#f92672">.</span>setp(
</span></span><span style="display:flex;"><span>    ax<span style="color:#f92672">.</span>get_xticklabels(),
</span></span><span style="display:flex;"><span>    rotation<span style="color:#f92672">=</span><span style="color:#ae81ff">45</span>,
</span></span><span style="display:flex;"><span>    ha<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;right&#34;</span>,
</span></span><span style="display:flex;"><span>    rotation_mode<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;anchor&#34;</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>ax<span style="color:#f92672">.</span>grid(<span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>ax<span style="color:#f92672">.</span>legend()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#plt.show()</span>
</span></span><span style="display:flex;"><span>plt<span style="color:#f92672">.</span>savefig(<span style="color:#e6db74">&#34;./companies-counts.png&#34;</span>)
</span></span><span style="display:flex;"><span>plt<span style="color:#f92672">.</span>close(fig)</span></span></code></pre></div>
<p>Result:</p>


    <img class="image-post" loading="lazy" src="/blog/2022/08/15/visitors-analytics-with-microsoft-graph/images/companies-counts.png" alt="Companies count">

<p>The companies names/teams/departments are blurred, so it&rsquo;s not very useful to you, but still let it be.</p>
<h3 id="joint-countries-and-companies-heatmap">Joint countries and companies heatmap</h3>
<p>Now that we have both countries and companies users numbers, we can visualize them as an <a href="https://matplotlib.org/stable/gallery/images_contours_and_fields/image_annotated_heatmap.html">annotated heatmap</a>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-py" data-lang="py"><span style="display:flex;"><span><span style="color:#f92672">import</span> numpy
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> pandas
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> matplotlib.pyplot <span style="color:#66d9ef">as</span> plt
</span></span><span style="display:flex;"><span>plt<span style="color:#f92672">.</span>rcParams[<span style="color:#e6db74">&#34;figure.facecolor&#34;</span>] <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;white&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>tblNormalized <span style="color:#f92672">=</span> pandas<span style="color:#f92672">.</span>read_pickle(<span style="color:#e6db74">&#34;./users-table-normalized.pkl&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>teamsAndCountries <span style="color:#f92672">=</span> tblNormalized[[<span style="color:#e6db74">&#34;companyName&#34;</span>, <span style="color:#e6db74">&#34;country&#34;</span>]]
</span></span><span style="display:flex;"><span><span style="color:#75715e"># display(teamsByCountries)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>teams <span style="color:#f92672">=</span> tblNormalized[<span style="color:#e6db74">&#34;companyName&#34;</span>]<span style="color:#f92672">.</span>unique()
</span></span><span style="display:flex;"><span><span style="color:#75715e">#print(teams)</span>
</span></span><span style="display:flex;"><span>countries <span style="color:#f92672">=</span> tblNormalized[<span style="color:#e6db74">&#34;country&#34;</span>]<span style="color:#f92672">.</span>unique()
</span></span><span style="display:flex;"><span><span style="color:#75715e">#print(countries)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#print(f&#34;teams: {len(teams)}, countries: {len(countries)}&#34;)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>teamsByCountries <span style="color:#f92672">=</span> numpy<span style="color:#f92672">.</span>zeros(
</span></span><span style="display:flex;"><span>    shape<span style="color:#f92672">=</span>(len(countries), len(teams)),
</span></span><span style="display:flex;"><span>    dtype<span style="color:#f92672">=</span>int
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>x <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> c <span style="color:#f92672">in</span> countries:
</span></span><span style="display:flex;"><span>    y <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> t <span style="color:#f92672">in</span> teams:
</span></span><span style="display:flex;"><span>        teamsByCountries[x,y] <span style="color:#f92672">=</span> teamsAndCountries<span style="color:#f92672">.</span>query(<span style="color:#e6db74">&#34;country == @c and companyName == @t&#34;</span>)<span style="color:#f92672">.</span>shape[<span style="color:#ae81ff">0</span>]
</span></span><span style="display:flex;"><span>        y <span style="color:#f92672">+=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>    x <span style="color:#f92672">+=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#print(teamsByCountries)</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#teamsByCountries[teamsByCountries == 0] = numpy.nan</span>
</span></span><span style="display:flex;"><span>teamsByCountries <span style="color:#f92672">=</span> numpy<span style="color:#f92672">.</span>ma<span style="color:#f92672">.</span>masked_where(teamsByCountries <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>, teamsByCountries)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>fig, ax <span style="color:#f92672">=</span> plt<span style="color:#f92672">.</span>subplots(
</span></span><span style="display:flex;"><span>    <span style="color:#ae81ff">1</span>,
</span></span><span style="display:flex;"><span>    figsize<span style="color:#f92672">=</span>(<span style="color:#ae81ff">12</span>, <span style="color:#ae81ff">8</span>),
</span></span><span style="display:flex;"><span>    dpi<span style="color:#f92672">=</span><span style="color:#ae81ff">120</span>,
</span></span><span style="display:flex;"><span>    tight_layout<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>im <span style="color:#f92672">=</span> plt<span style="color:#f92672">.</span>imshow(
</span></span><span style="display:flex;"><span>    teamsByCountries,
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">#interpolation=&#34;nearest&#34;,</span>
</span></span><span style="display:flex;"><span>    cmap<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;Spectral_r&#34;</span><span style="color:#75715e">#&#34;Dark2_r&#34;#&#34;tab20b&#34;#&#34;tab20c_r&#34;</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>cbar <span style="color:#f92672">=</span> ax<span style="color:#f92672">.</span>figure<span style="color:#f92672">.</span>colorbar(im, ax<span style="color:#f92672">=</span>ax)
</span></span><span style="display:flex;"><span>cbar<span style="color:#f92672">.</span>ax<span style="color:#f92672">.</span>set_ylabel(<span style="color:#e6db74">&#34;Number of visitors&#34;</span>, rotation<span style="color:#f92672">=-</span><span style="color:#ae81ff">90</span>, va<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;bottom&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>ax<span style="color:#f92672">.</span>set_xticks(numpy<span style="color:#f92672">.</span>arange(len(teams)), labels<span style="color:#f92672">=</span>teams)
</span></span><span style="display:flex;"><span>ax<span style="color:#f92672">.</span>set_yticks(numpy<span style="color:#f92672">.</span>arange(len(countries)), labels<span style="color:#f92672">=</span>countries)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>plt<span style="color:#f92672">.</span>setp(
</span></span><span style="display:flex;"><span>    ax<span style="color:#f92672">.</span>get_xticklabels(),
</span></span><span style="display:flex;"><span>    rotation<span style="color:#f92672">=</span><span style="color:#ae81ff">45</span>,
</span></span><span style="display:flex;"><span>    ha<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;right&#34;</span>,
</span></span><span style="display:flex;"><span>    rotation_mode<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;anchor&#34;</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(len(countries)):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> j <span style="color:#f92672">in</span> range(len(teams)):
</span></span><span style="display:flex;"><span>        text <span style="color:#f92672">=</span> ax<span style="color:#f92672">.</span>text(
</span></span><span style="display:flex;"><span>            j,
</span></span><span style="display:flex;"><span>            i,
</span></span><span style="display:flex;"><span>            teamsByCountries[i, j],
</span></span><span style="display:flex;"><span>            ha<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;center&#34;</span>,
</span></span><span style="display:flex;"><span>            va<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;center&#34;</span>,
</span></span><span style="display:flex;"><span>            color<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;w&#34;</span>
</span></span><span style="display:flex;"><span>        )
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#ax.spines[:].set_visible(True)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>ax<span style="color:#f92672">.</span>set_xticks(numpy<span style="color:#f92672">.</span>arange(teamsByCountries<span style="color:#f92672">.</span>shape[<span style="color:#ae81ff">1</span>]<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>)<span style="color:#f92672">-</span><span style="color:#ae81ff">0.5</span>, minor<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>ax<span style="color:#f92672">.</span>set_yticks(numpy<span style="color:#f92672">.</span>arange(teamsByCountries<span style="color:#f92672">.</span>shape[<span style="color:#ae81ff">0</span>]<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>)<span style="color:#f92672">-</span><span style="color:#ae81ff">0.5</span>, minor<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>ax<span style="color:#f92672">.</span>grid(which<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;minor&#34;</span>, color<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;whitesmoke&#34;</span>, linestyle<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;-&#34;</span>, linewidth<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>ax<span style="color:#f92672">.</span>tick_params(which<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;minor&#34;</span>, bottom<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>, left<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#plt.show()</span>
</span></span><span style="display:flex;"><span>plt<span style="color:#f92672">.</span>savefig(<span style="color:#e6db74">&#34;./teams-and-countries.png&#34;</span>)
</span></span><span style="display:flex;"><span>plt<span style="color:#f92672">.</span>close(fig)</span></span></code></pre></div>
<p>Result (<em>yet again with blurred companies/teams/departments names</em>):</p>


    <img class="image-post" loading="lazy" src="/blog/2022/08/15/visitors-analytics-with-microsoft-graph/images/teams-and-countries.png" alt="Teams and countries heatmap">

<h3 id="users-by-job-titles">Users by job titles</h3>
<p>The script:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-py" data-lang="py"><span style="display:flex;"><span><span style="color:#f92672">import</span> numpy
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> pandas
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> matplotlib.pyplot <span style="color:#66d9ef">as</span> plt
</span></span><span style="display:flex;"><span>plt<span style="color:#f92672">.</span>rcParams[<span style="color:#e6db74">&#34;figure.facecolor&#34;</span>] <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;white&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>tblNormalized <span style="color:#f92672">=</span> pandas<span style="color:#f92672">.</span>read_pickle(<span style="color:#e6db74">&#34;./users-table-normalized.pkl&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>jobTitlesCounts <span style="color:#f92672">=</span> tblNormalized<span style="color:#f92672">.</span>value_counts(subset<span style="color:#f92672">=</span>[<span style="color:#e6db74">&#34;jobTitle&#34;</span>])
</span></span><span style="display:flex;"><span><span style="color:#75715e"># print([c[0] for c in jobTitlesCounts.index.to_numpy()])</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># print(jobTitlesCounts.values)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>fig, ax <span style="color:#f92672">=</span> plt<span style="color:#f92672">.</span>subplots(
</span></span><span style="display:flex;"><span>    <span style="color:#ae81ff">1</span>,
</span></span><span style="display:flex;"><span>    figsize<span style="color:#f92672">=</span>(<span style="color:#ae81ff">12</span>, <span style="color:#ae81ff">8</span>),
</span></span><span style="display:flex;"><span>    dpi<span style="color:#f92672">=</span><span style="color:#ae81ff">120</span>,
</span></span><span style="display:flex;"><span>    tight_layout<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>makePie <span style="color:#f92672">=</span> <span style="color:#66d9ef">True</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> makePie:
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">prcnts</span>(pct, allvals):
</span></span><span style="display:flex;"><span>        absolute <span style="color:#f92672">=</span> int(numpy<span style="color:#f92672">.</span>round(pct <span style="color:#f92672">/</span> <span style="color:#ae81ff">100.0</span> <span style="color:#f92672">*</span> numpy<span style="color:#f92672">.</span>sum(allvals)))
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">{:.1f}</span><span style="color:#e6db74">% (</span><span style="color:#e6db74">{:d}</span><span style="color:#e6db74">)&#34;</span><span style="color:#f92672">.</span>format(pct, absolute)
</span></span><span style="display:flex;"><span>    wedges, texts, autotexts <span style="color:#f92672">=</span> ax<span style="color:#f92672">.</span>pie(
</span></span><span style="display:flex;"><span>        jobTitlesCounts<span style="color:#f92672">.</span>values,
</span></span><span style="display:flex;"><span>        autopct<span style="color:#f92672">=</span><span style="color:#66d9ef">lambda</span> pct: prcnts(pct, jobTitlesCounts<span style="color:#f92672">.</span>values),
</span></span><span style="display:flex;"><span>        wedgeprops<span style="color:#f92672">=</span>{<span style="color:#e6db74">&#34;linewidth&#34;</span>: <span style="color:#ae81ff">1</span>, <span style="color:#e6db74">&#34;edgecolor&#34;</span>: <span style="color:#e6db74">&#34;white&#34;</span>},
</span></span><span style="display:flex;"><span>        frame<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>
</span></span><span style="display:flex;"><span>    )
</span></span><span style="display:flex;"><span>    plt<span style="color:#f92672">.</span>setp(autotexts, size<span style="color:#f92672">=</span><span style="color:#ae81ff">9</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>    wedges, texts <span style="color:#f92672">=</span> ax<span style="color:#f92672">.</span>pie(
</span></span><span style="display:flex;"><span>        jobTitlesCounts<span style="color:#f92672">.</span>values,
</span></span><span style="display:flex;"><span>        wedgeprops<span style="color:#f92672">=</span>dict(width<span style="color:#f92672">=</span><span style="color:#ae81ff">0.5</span>),
</span></span><span style="display:flex;"><span>        startangle<span style="color:#f92672">=-</span><span style="color:#ae81ff">40</span>,
</span></span><span style="display:flex;"><span>        frame<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>
</span></span><span style="display:flex;"><span>    )
</span></span><span style="display:flex;"><span>    bbox_props <span style="color:#f92672">=</span> dict(boxstyle<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;square,pad=0.4&#34;</span>, fc<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;w&#34;</span>, ec<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;k&#34;</span>, lw<span style="color:#f92672">=</span><span style="color:#ae81ff">0.72</span>)
</span></span><span style="display:flex;"><span>    kw <span style="color:#f92672">=</span> dict(
</span></span><span style="display:flex;"><span>        arrowprops<span style="color:#f92672">=</span>dict(arrowstyle<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;-&#34;</span>),
</span></span><span style="display:flex;"><span>        bbox<span style="color:#f92672">=</span>bbox_props,
</span></span><span style="display:flex;"><span>        zorder<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>,
</span></span><span style="display:flex;"><span>        va<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;center&#34;</span>
</span></span><span style="display:flex;"><span>    )
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> i, p <span style="color:#f92672">in</span> enumerate(wedges):
</span></span><span style="display:flex;"><span>        percentage <span style="color:#f92672">=</span> numpy<span style="color:#f92672">.</span>round(
</span></span><span style="display:flex;"><span>            jobTitlesCounts<span style="color:#f92672">.</span>values[i] <span style="color:#f92672">/</span> numpy<span style="color:#f92672">.</span>sum(jobTitlesCounts<span style="color:#f92672">.</span>values) <span style="color:#f92672">*</span> <span style="color:#ae81ff">100.0</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>        )
</span></span><span style="display:flex;"><span>        ang <span style="color:#f92672">=</span> (p<span style="color:#f92672">.</span>theta2 <span style="color:#f92672">-</span> p<span style="color:#f92672">.</span>theta1) <span style="color:#f92672">/</span> <span style="color:#ae81ff">2.</span> <span style="color:#f92672">+</span> p<span style="color:#f92672">.</span>theta1
</span></span><span style="display:flex;"><span>        y <span style="color:#f92672">=</span> numpy<span style="color:#f92672">.</span>sin(numpy<span style="color:#f92672">.</span>deg2rad(ang))
</span></span><span style="display:flex;"><span>        x <span style="color:#f92672">=</span> numpy<span style="color:#f92672">.</span>cos(numpy<span style="color:#f92672">.</span>deg2rad(ang))
</span></span><span style="display:flex;"><span>        horizontalalignment <span style="color:#f92672">=</span> {<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>: <span style="color:#e6db74">&#34;right&#34;</span>, <span style="color:#ae81ff">1</span>: <span style="color:#e6db74">&#34;left&#34;</span>}[int(numpy<span style="color:#f92672">.</span>sign(x))]
</span></span><span style="display:flex;"><span>        connectionstyle <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;angle,angleA=0,angleB=</span><span style="color:#e6db74">{}</span><span style="color:#e6db74">&#34;</span><span style="color:#f92672">.</span>format(ang)
</span></span><span style="display:flex;"><span>        kw[<span style="color:#e6db74">&#34;arrowprops&#34;</span>]<span style="color:#f92672">.</span>update({<span style="color:#e6db74">&#34;connectionstyle&#34;</span>: connectionstyle})
</span></span><span style="display:flex;"><span>        ax<span style="color:#f92672">.</span>annotate(
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">{</span>jobTitlesCounts<span style="color:#f92672">.</span>index[i][<span style="color:#ae81ff">0</span>]<span style="color:#e6db74">}</span><span style="color:#e6db74">: </span><span style="color:#e6db74">{</span>jobTitlesCounts<span style="color:#f92672">.</span>values[i]<span style="color:#e6db74">}</span><span style="color:#e6db74"> (</span><span style="color:#e6db74">{</span>percentage<span style="color:#e6db74">}</span><span style="color:#e6db74">%)&#34;</span>,
</span></span><span style="display:flex;"><span>            xy<span style="color:#f92672">=</span>(x, y),
</span></span><span style="display:flex;"><span>            xytext<span style="color:#f92672">=</span>(<span style="color:#ae81ff">1.35</span> <span style="color:#f92672">*</span> numpy<span style="color:#f92672">.</span>sign(x), <span style="color:#ae81ff">1.4</span> <span style="color:#f92672">*</span> y),
</span></span><span style="display:flex;"><span>            horizontalalignment<span style="color:#f92672">=</span>horizontalalignment,
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">**</span>kw
</span></span><span style="display:flex;"><span>        )
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ax.legend(</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#     wedges,</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#     [c[0] for c in jobTitlesCounts.index.to_numpy()],</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#     title=&#34;Job titles&#34;,</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#     loc=&#34;center left&#34;,</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#     bbox_to_anchor=(1, 0, 0.5, 1)</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># )</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#ax.set_title(&#34;Visitors by their job titles&#34;)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#plt.show()</span>
</span></span><span style="display:flex;"><span>plt<span style="color:#f92672">.</span>savefig(<span style="color:#e6db74">&#34;./job-titles-counts.png&#34;</span>)
</span></span><span style="display:flex;"><span>plt<span style="color:#f92672">.</span>close(fig)</span></span></code></pre></div>
<p>Result:</p>


    <img class="image-post" loading="lazy" src="/blog/2022/08/15/visitors-analytics-with-microsoft-graph/images/job-titles-counts.png" alt="Job titles counts">

<h3 id="visualizing-the-managers-tree">Visualizing the managers tree</h3>
<p>Now, this one is not trivial. Firstly you need to create a tree/graph structure, and secondly you need to visualize it. There are several possible options for that:</p>
<ul>
<li><a href="https://stackoverflow.com/a/7673423/1688203">one way</a> is to use <a href="https://en.wikipedia.org/wiki/DOT_(graph_description_language)">DOT language</a> and visualize resulting graph with <a href="https://graphviz.org">Graphviz</a>. I haven&rsquo;t tried that;</li>
<li><a href="https://stackoverflow.com/a/29443925/1688203">another way</a> is to use <a href="https://en.wikipedia.org/wiki/Newick_format">Newick format</a> and visualize resulting structure with <a href="http://etetoolkit.org">ETE</a>. I decided to go with this one.</li>
</ul>
<p>It is worth to mention here that we are only interested in users and their managers that are present in the <a href="#fetching-information-about-users">data frame</a> that we&rsquo;ve gathered, and so we won&rsquo;t be fetching the full managers chain for every user (<em>although <a href="#get-users-full-managers-chain">we could</a></em>).</p>
<h4 id="composing-a-newick-tree">Composing a Newick tree</h4>
<p>Right away I would like to state that the code below is most definitely not the most optimal one, and most likely it&rsquo;s rather bad, inefficient and perhaps even dumb. I&rsquo;m really &ldquo;challenged&rdquo; when it comes to trees, graphs, algorithms and so on, so for me it&rsquo;s already a great achievement that I&rsquo;ve managed to come up with at least something that actually works.</p>
<p>And here it comes:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-py" data-lang="py"><span style="display:flex;"><span><span style="color:#f92672">import</span> numpy
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> pandas
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>tblNormalized <span style="color:#f92672">=</span> pandas<span style="color:#f92672">.</span>read_pickle(<span style="color:#e6db74">&#34;./users-table-normalized.pkl&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>managersCounts <span style="color:#f92672">=</span> tblNormalized<span style="color:#f92672">.</span>value_counts(subset<span style="color:#f92672">=</span>[<span style="color:#e6db74">&#34;managerMail&#34;</span>])
</span></span><span style="display:flex;"><span>managers <span style="color:#f92672">=</span> [c[<span style="color:#ae81ff">0</span>] <span style="color:#66d9ef">for</span> c <span style="color:#f92672">in</span> managersCounts<span style="color:#f92672">.</span>index<span style="color:#f92672">.</span>to_numpy()]
</span></span><span style="display:flex;"><span><span style="color:#75715e">#print(len(managers))</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>usersAndManagers <span style="color:#f92672">=</span> tblNormalized[[<span style="color:#e6db74">&#34;mail&#34;</span>, <span style="color:#e6db74">&#34;managerMail&#34;</span>]]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">getHigherManager</span>(manager, depth):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">global</span> managersLevels
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">global</span> managersTree
</span></span><span style="display:flex;"><span>    higherManager <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>    managerOfManager <span style="color:#f92672">=</span> usersAndManagers<span style="color:#f92672">.</span>query(<span style="color:#e6db74">&#34;mail == @manager&#34;</span>)[<span style="color:#e6db74">&#34;managerMail&#34;</span>]
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> len(managerOfManager):
</span></span><span style="display:flex;"><span>        higherManager <span style="color:#f92672">=</span> managerOfManager<span style="color:#f92672">.</span>values[<span style="color:#ae81ff">0</span>]
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># tree</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> manager <span style="color:#f92672">in</span> managersTree:
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># if not higherManager in managersTree[manager]:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">#     managersTree[manager] += [{higherManager: depth}]</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">pass</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>            managersTree[manager] <span style="color:#f92672">=</span> {higherManager: depth}
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># levels</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> depth <span style="color:#f92672">in</span> managersLevels:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> higherManager <span style="color:#f92672">in</span> managersLevels[depth]:
</span></span><span style="display:flex;"><span>                managersLevels[depth] <span style="color:#f92672">+=</span> [higherManager]
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>            managersLevels[depth] <span style="color:#f92672">=</span> [higherManager]
</span></span><span style="display:flex;"><span>        print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">{</span><span style="color:#e6db74">&#39;-&#39;</span> <span style="color:#f92672">*</span> depth<span style="color:#e6db74">}</span><span style="color:#e6db74"> manager of </span><span style="color:#e6db74">{</span>manager<span style="color:#e6db74">}</span><span style="color:#e6db74"> is </span><span style="color:#e6db74">{</span>higherManager<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>        depth, higherManager <span style="color:#f92672">=</span> getHigherManager(higherManager, depth <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">#return higherManager</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>        higherManager <span style="color:#f92672">=</span> manager
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> depth, higherManager
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">getSlaves</span>(manager, depth):
</span></span><span style="display:flex;"><span>    treeNode <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span>    dpth1 <span style="color:#f92672">=</span> depth
</span></span><span style="display:flex;"><span>    dpth2 <span style="color:#f92672">=</span> dpth1
</span></span><span style="display:flex;"><span>    slaves <span style="color:#f92672">=</span> usersAndManagers<span style="color:#f92672">.</span>query(<span style="color:#e6db74">&#34;managerMail == @manager&#34;</span>)[<span style="color:#e6db74">&#34;mail&#34;</span>]
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> len(slaves):
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> slave <span style="color:#f92672">in</span> slaves:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> slave <span style="color:#f92672">not</span> <span style="color:#f92672">in</span> usersAndManagers[<span style="color:#e6db74">&#34;managerMail&#34;</span>]<span style="color:#f92672">.</span>values:
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">continue</span>
</span></span><span style="display:flex;"><span>            tn, dpth1 <span style="color:#f92672">=</span> getSlaves(slave, depth <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> dpth1 <span style="color:#f92672">&gt;</span> dpth2:
</span></span><span style="display:flex;"><span>                dpth2 <span style="color:#f92672">=</span> dpth1
</span></span><span style="display:flex;"><span>            treeNode<span style="color:#f92672">.</span>append({slave: tn})
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">#print(depth)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> treeNode, dpth2
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>managersLevels <span style="color:#f92672">=</span> {}
</span></span><span style="display:flex;"><span>managersTree <span style="color:#f92672">=</span> {}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># for manager in managers:</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#     depth, higherManager = getHigherManager(manager, 1)</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#     # if depth == 3:</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#     #     print(depth, higherManager)</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#print(managersLevels)</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#print(managersTree)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>maxLevels <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> manager <span style="color:#f92672">in</span> managers:
</span></span><span style="display:flex;"><span>    slaves, depth <span style="color:#f92672">=</span> getSlaves(manager, <span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> depth <span style="color:#f92672">&gt;</span> maxLevels:
</span></span><span style="display:flex;"><span>        maxLevels <span style="color:#f92672">=</span> depth
</span></span><span style="display:flex;"><span>    managersTree[manager] <span style="color:#f92672">=</span> {<span style="color:#e6db74">&#34;max-levels&#34;</span>: depth <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>, <span style="color:#e6db74">&#34;slaves&#34;</span>: slaves}
</span></span><span style="display:flex;"><span><span style="color:#75715e">#print(managersTree)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>maxLevels <span style="color:#f92672">-=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>managersTreeReduced <span style="color:#f92672">=</span> dict(sorted(managersTree<span style="color:#f92672">.</span>copy()<span style="color:#f92672">.</span>items(), key<span style="color:#f92672">=</span><span style="color:#66d9ef">lambda</span> i: i[<span style="color:#ae81ff">0</span>]<span style="color:#f92672">.</span>lower()))
</span></span><span style="display:flex;"><span><span style="color:#75715e">#print(f&#34;Maximum levels: {maxLevels}&#34;)</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> level <span style="color:#f92672">in</span> range(maxLevels, <span style="color:#ae81ff">0</span>, <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>):
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># if level &lt; 4:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">#     continue</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">#print(level)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> node <span style="color:#f92672">in</span> managersTree:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> managersTree[node][<span style="color:#e6db74">&#34;max-levels&#34;</span>] <span style="color:#f92672">!=</span> level:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">continue</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> slave <span style="color:#f92672">in</span> managersTree[node][<span style="color:#e6db74">&#34;slaves&#34;</span>]:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">for</span> email <span style="color:#f92672">in</span> slave<span style="color:#f92672">.</span>keys():
</span></span><span style="display:flex;"><span>                managersTreeReduced<span style="color:#f92672">.</span>pop(email, <span style="color:#66d9ef">None</span>)
</span></span><span style="display:flex;"><span><span style="color:#75715e">#print(managersTreeReduced)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># for index, row in usersAndManagers.iterrows():</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#     slavesCount = usersAndManagers.query(&#34;managerMail == @row[&#39;mail&#39;]&#34;).shape[0]</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#     if slavesCount &gt; 0:</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#         print(row[&#34;mail&#34;], slavesCount)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>jsonTree <span style="color:#f92672">=</span> managersTreeReduced</span></span></code></pre></div>
<p>As a result we will have a <code>jsonTree</code> string that looks like this:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;some@our-company.com&#34;</span>:
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&#34;max-levels&#34;</span>: <span style="color:#ae81ff">3</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&#34;slaves&#34;</span>:
</span></span><span style="display:flex;"><span>        [
</span></span><span style="display:flex;"><span>            {
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">&#34;another@our-company.com&#34;</span>:
</span></span><span style="display:flex;"><span>                [
</span></span><span style="display:flex;"><span>                    {
</span></span><span style="display:flex;"><span>                        <span style="color:#f92672">&#34;yet.another@our-company.com&#34;</span>:
</span></span><span style="display:flex;"><span>                        [
</span></span><span style="display:flex;"><span>                            {
</span></span><span style="display:flex;"><span>                                <span style="color:#f92672">&#34;another.again@our-company.com&#34;</span>:
</span></span><span style="display:flex;"><span>                                []
</span></span><span style="display:flex;"><span>                            },
</span></span><span style="display:flex;"><span>                            {
</span></span><span style="display:flex;"><span>                                <span style="color:#f92672">&#34;some.one@our-company.com&#34;</span>:
</span></span><span style="display:flex;"><span>                                []
</span></span><span style="display:flex;"><span>                            }
</span></span><span style="display:flex;"><span>                        ]
</span></span><span style="display:flex;"><span>                    }
</span></span><span style="display:flex;"><span>                ]
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        ]
</span></span><span style="display:flex;"><span>    },
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;yet.some@our-company.com&#34;</span>:
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&#34;max-levels&#34;</span>: <span style="color:#ae81ff">0</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&#34;slaves&#34;</span>:
</span></span><span style="display:flex;"><span>        []
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div>
<p>To turn such a JSON into a Newick string I&rsquo;ve come up with the following functions:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-py" data-lang="py"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">getLevelValues</span>(jsonDict, depth, withLengths <span style="color:#f92672">=</span> <span style="color:#66d9ef">False</span>):
</span></span><span style="display:flex;"><span>    newickString <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> k <span style="color:#f92672">in</span> jsonDict:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> len(jsonDict[k]) <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">#print(f&#34;{k}: {jsonDict[k]}\n---&#34;)</span>
</span></span><span style="display:flex;"><span>            leaf <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">for</span> v <span style="color:#f92672">in</span> jsonDict[k]:
</span></span><span style="display:flex;"><span>                leaf<span style="color:#f92672">.</span>append(getLevelValues(v, depth <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>, withLengths))
</span></span><span style="display:flex;"><span>                <span style="color:#75715e">#newickString += f&#34;({some})&#34;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">#print(leaf)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> withLengths:
</span></span><span style="display:flex;"><span>                lngth <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">-</span> round(float(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;0.</span><span style="color:#e6db74">{</span>depth<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span><span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>), <span style="color:#ae81ff">2</span>)
</span></span><span style="display:flex;"><span>                newickString <span style="color:#f92672">+=</span> <span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;(</span><span style="color:#e6db74">{</span><span style="color:#e6db74">&#39;,&#39;</span><span style="color:#f92672">.</span>join(leaf)<span style="color:#e6db74">}</span><span style="color:#e6db74">)</span><span style="color:#e6db74">{</span>k<span style="color:#e6db74">}</span><span style="color:#e6db74">:</span><span style="color:#e6db74">{</span>lngth<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>                newickString <span style="color:#f92672">+=</span> <span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;(</span><span style="color:#e6db74">{</span><span style="color:#e6db74">&#39;,&#39;</span><span style="color:#f92672">.</span>join(leaf)<span style="color:#e6db74">}</span><span style="color:#e6db74">)</span><span style="color:#e6db74">{</span>k<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> withLengths:
</span></span><span style="display:flex;"><span>                lngth <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">-</span> round(float(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;0.</span><span style="color:#e6db74">{</span>depth<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span><span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>), <span style="color:#ae81ff">2</span>)
</span></span><span style="display:flex;"><span>                newickString <span style="color:#f92672">+=</span> k <span style="color:#f92672">+</span> <span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;:</span><span style="color:#e6db74">{</span>lngth<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>                newickString <span style="color:#f92672">+=</span> k
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> newickString
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># this one gets one Newick string with one &#34;artificial&#34; top manager</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># to join all disconnected highest managers</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">json2newick1</span>(jsonDict, withLengths <span style="color:#f92672">=</span> <span style="color:#66d9ef">False</span>):
</span></span><span style="display:flex;"><span>    newickString <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    managersCnt <span style="color:#f92672">=</span> len(jsonDict<span style="color:#f92672">.</span>keys())
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> key <span style="color:#f92672">in</span> jsonDict<span style="color:#f92672">.</span>keys():
</span></span><span style="display:flex;"><span>        newickItems <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">#print(key)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">#print(key, jsonDict[key])</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> k <span style="color:#f92672">in</span> jsonDict[key][<span style="color:#e6db74">&#34;slaves&#34;</span>]:
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">#print(k.keys())</span>
</span></span><span style="display:flex;"><span>            newickItems<span style="color:#f92672">.</span>append(getLevelValues(k, <span style="color:#ae81ff">1</span>, withLengths))
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># for kk in k.keys():</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">#     print(f&#34;{kk}: {k[kk]}&#34;)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> newickItems:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> withLengths:
</span></span><span style="display:flex;"><span>                newickString <span style="color:#f92672">+=</span> <span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;(</span><span style="color:#e6db74">{</span><span style="color:#e6db74">&#39;,&#39;</span><span style="color:#f92672">.</span>join(newickItems)<span style="color:#e6db74">}</span><span style="color:#e6db74">)</span><span style="color:#e6db74">{</span>key<span style="color:#e6db74">}</span><span style="color:#e6db74">:0.9,&#34;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>                newickString <span style="color:#f92672">+=</span> <span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;(</span><span style="color:#e6db74">{</span><span style="color:#e6db74">&#39;,&#39;</span><span style="color:#f92672">.</span>join(newickItems)<span style="color:#e6db74">}</span><span style="color:#e6db74">)</span><span style="color:#e6db74">{</span>key<span style="color:#e6db74">}</span><span style="color:#e6db74">,&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> withLengths:
</span></span><span style="display:flex;"><span>                newickString <span style="color:#f92672">+=</span> <span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">{</span>key<span style="color:#e6db74">}</span><span style="color:#e6db74">:0.9,&#34;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>                newickString <span style="color:#f92672">+=</span> <span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">{</span>key<span style="color:#e6db74">}</span><span style="color:#e6db74">,&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> newickString[<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>] <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;,&#39;</span>:
</span></span><span style="display:flex;"><span>       newickString <span style="color:#f92672">=</span> newickString[:<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>]
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> managersCnt <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">1</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> withLengths:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;(</span><span style="color:#e6db74">{</span>newickString<span style="color:#e6db74">}</span><span style="color:#e6db74">)OurCompany:0.9;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;(</span><span style="color:#e6db74">{</span>newickString<span style="color:#e6db74">}</span><span style="color:#e6db74">)OurCompany;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">{</span>newickString<span style="color:#e6db74">}</span><span style="color:#e6db74">;&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># this one gets a list of Newick strings</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">json2newick2</span>(jsonDict, withLengths <span style="color:#f92672">=</span> <span style="color:#66d9ef">False</span>):
</span></span><span style="display:flex;"><span>    newicks <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">#managersCnt = len(jsonDict.keys())</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> key <span style="color:#f92672">in</span> jsonDict<span style="color:#f92672">.</span>keys():
</span></span><span style="display:flex;"><span>        newickString <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        newickItems <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">#print(key)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">#print(key, jsonDict[key])</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> k <span style="color:#f92672">in</span> jsonDict[key][<span style="color:#e6db74">&#34;slaves&#34;</span>]:
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">#print(k.keys())</span>
</span></span><span style="display:flex;"><span>            newickItems<span style="color:#f92672">.</span>append(getLevelValues(k, <span style="color:#ae81ff">1</span>, withLengths))
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># for kk in k.keys():</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">#     print(f&#34;{kk}: {k[kk]}&#34;)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> newickItems:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> withLengths:
</span></span><span style="display:flex;"><span>                newickString <span style="color:#f92672">+=</span> <span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;(</span><span style="color:#e6db74">{</span><span style="color:#e6db74">&#39;,&#39;</span><span style="color:#f92672">.</span>join(newickItems)<span style="color:#e6db74">}</span><span style="color:#e6db74">)</span><span style="color:#e6db74">{</span>key<span style="color:#e6db74">}</span><span style="color:#e6db74">:0.9;&#34;</span><span style="color:#75715e">#,</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>                newickString <span style="color:#f92672">+=</span> <span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;(</span><span style="color:#e6db74">{</span><span style="color:#e6db74">&#39;,&#39;</span><span style="color:#f92672">.</span>join(newickItems)<span style="color:#e6db74">}</span><span style="color:#e6db74">)</span><span style="color:#e6db74">{</span>key<span style="color:#e6db74">}</span><span style="color:#e6db74">;&#34;</span><span style="color:#75715e">#,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> withLengths:
</span></span><span style="display:flex;"><span>                newickString <span style="color:#f92672">+=</span> <span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">{</span>key<span style="color:#e6db74">}</span><span style="color:#e6db74">:0.9;&#34;</span><span style="color:#75715e">#,</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>                newickString <span style="color:#f92672">+=</span> <span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">{</span>key<span style="color:#e6db74">}</span><span style="color:#e6db74">;&#34;</span><span style="color:#75715e">#,</span>
</span></span><span style="display:flex;"><span>        newicks<span style="color:#f92672">.</span>append(newickString)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> newicks
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># if newickString[-1] == &#39;,&#39;:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">#    newickString = newickString[:-1]</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># if managersCnt &gt; 1:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">#     if withLengths:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">#         return f&#34;({newickString})OurCompany:0.9;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">#     else:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">#         return f&#34;({newickString})OurCompany;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># else:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">#     return f&#34;{newickString};&#34;</span></span></span></code></pre></div>
<p>Depending on the number of managers in your organization, you may choose between <code>json2newick1()</code> and <code>json2newick2()</code> functions. The first one joins all the managers chains under one common &ldquo;artificial&rdquo; manager, and the second one makes a list of chains, meaning that you&rsquo;ll get not just one tree graph but several graphs (<em>each in its own file</em>).</p>
<p>In our case we don&rsquo;t have that many managers, so we are using <code>json2newick1()</code> function. The resulting Newick string for our example will look like this:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#f92672">((((</span>another.again@our-company.com,some.one@our-company.com<span style="color:#f92672">)</span>yet.another@our-company.com<span style="color:#f92672">)</span>another@our-company.com<span style="color:#f92672">)</span>some@our-company.com,yet.some@our-company.com<span style="color:#f92672">)</span>OurCompany;</span></span></code></pre></div>
<p>or, for better readability:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#f92672">(</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">(</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">(</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">(</span>
</span></span><span style="display:flex;"><span>                another.again@our-company.com,
</span></span><span style="display:flex;"><span>                some.one@our-company.com
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>            yet.another@our-company.com
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>        another@our-company.com
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    some@our-company.com,
</span></span><span style="display:flex;"><span>    yet.some@our-company.com
</span></span><span style="display:flex;"><span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>OurCompany;</span></span></code></pre></div>
<p>It is now ready to be visualized with ETE.</p>
<h4 id="ete-graphs">ETE graphs</h4>
<p>First you need to install the <a href="https://pypi.org/project/ete3/">package</a>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ pip install ete3</span></span></code></pre></div>
<p>And even though it depends on <a href="https://pypi.org/project/PyQt5/">PyQt5</a>, weirdly enough it doesn&rsquo;t install it on its own (<em>package not configured properly?</em>), so you&rsquo;ll need to install it explicitly:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ pip install PyQt5</span></span></code></pre></div>
<h5 id="a-simple-tree-graph">A simple tree graph</h5>
<p>To get familiar with ETE, let&rsquo;s first visualize a simple tree:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-py" data-lang="py"><span style="display:flex;"><span><span style="color:#f92672">import</span> ete3
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#t = ete3.Tree(&#34;(A,B,(C,D)E)F;&#34;, format=8)</span>
</span></span><span style="display:flex;"><span>t <span style="color:#f92672">=</span> ete3<span style="color:#f92672">.</span>Tree(<span style="color:#e6db74">&#34;(A:0.1,B:0.2,(C:0.3,D:0.4)E:0.5)F;&#34;</span>, format<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>ts <span style="color:#f92672">=</span> ete3<span style="color:#f92672">.</span>TreeStyle()
</span></span><span style="display:flex;"><span>ts<span style="color:#f92672">.</span>show_leaf_name <span style="color:#f92672">=</span> <span style="color:#66d9ef">False</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># http://etetoolkit.org/docs/latest/reference/reference_treeview.html#nodestyle</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>lstyle <span style="color:#f92672">=</span> ete3<span style="color:#f92672">.</span>NodeStyle()
</span></span><span style="display:flex;"><span>lstyle[<span style="color:#e6db74">&#34;fgcolor&#34;</span>] <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;blue&#34;</span>
</span></span><span style="display:flex;"><span>lstyle[<span style="color:#e6db74">&#34;size&#34;</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">1.5</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>nstyle <span style="color:#f92672">=</span> ete3<span style="color:#f92672">.</span>NodeStyle()
</span></span><span style="display:flex;"><span>nstyle[<span style="color:#e6db74">&#34;fgcolor&#34;</span>] <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;red&#34;</span>
</span></span><span style="display:flex;"><span>nstyle[<span style="color:#e6db74">&#34;size&#34;</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">3</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> n <span style="color:#f92672">in</span> t<span style="color:#f92672">.</span>traverse():
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">#print(n.name, n.is_leaf())</span>
</span></span><span style="display:flex;"><span>    nodeName <span style="color:#f92672">=</span> ete3<span style="color:#f92672">.</span>TextFace(n<span style="color:#f92672">.</span>name)
</span></span><span style="display:flex;"><span>    nodeName<span style="color:#f92672">.</span>margin_left <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span>    nodeName<span style="color:#f92672">.</span>margin_right <span style="color:#f92672">=</span> <span style="color:#ae81ff">3</span>
</span></span><span style="display:flex;"><span>    n<span style="color:#f92672">.</span>add_face(nodeName, column<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> n<span style="color:#f92672">.</span>is_leaf():
</span></span><span style="display:flex;"><span>        n<span style="color:#f92672">.</span>set_style(lstyle)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>        n<span style="color:#f92672">.</span>set_style(nstyle)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>newickCircle <span style="color:#f92672">=</span> <span style="color:#66d9ef">True</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> newickCircle:
</span></span><span style="display:flex;"><span>    ts<span style="color:#f92672">.</span>scale <span style="color:#f92672">=</span> <span style="color:#ae81ff">50</span>
</span></span><span style="display:flex;"><span>    ts<span style="color:#f92672">.</span>mode <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;c&#34;</span>
</span></span><span style="display:flex;"><span>    ts<span style="color:#f92672">.</span>arc_start <span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">85</span> <span style="color:#75715e"># 0 degrees is 3:00 o&#39;clock</span>
</span></span><span style="display:flex;"><span>    ts<span style="color:#f92672">.</span>arc_span <span style="color:#f92672">=</span> <span style="color:#ae81ff">175</span>
</span></span><span style="display:flex;"><span>    ts<span style="color:#f92672">.</span>branch_vertical_margin <span style="color:#f92672">=</span> <span style="color:#ae81ff">10</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>    ts<span style="color:#f92672">.</span>branch_vertical_margin <span style="color:#f92672">=</span> <span style="color:#ae81ff">20</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#t.render(&#34;./tree.pdf&#34;, tree_style=ts)</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># DPI doesn&#39;t seem to affect anything, quality is managed by width/height,</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># so to increase quality for bigger images you might want to set w=7680</span>
</span></span><span style="display:flex;"><span>t<span style="color:#f92672">.</span>render(<span style="color:#e6db74">&#34;./tree.png&#34;</span>, w<span style="color:#f92672">=</span><span style="color:#ae81ff">1920</span>, units<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;px&#34;</span>, tree_style<span style="color:#f92672">=</span>ts) <span style="color:#75715e">#dpi=300</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#t.show()</span></span></span></code></pre></div>
<p>Depending on <code>newickCircle</code> value you can get a circular graph:</p>


    <img class="image-post" loading="lazy" src="/blog/2022/08/15/visitors-analytics-with-microsoft-graph/images/ete-graph-circle.png" alt="ETE circle graph" style="border:1px solid black;">

<p>or a &ldquo;straight&rdquo; one:</p>


    <img class="image-post" loading="lazy" src="/blog/2022/08/15/visitors-analytics-with-microsoft-graph/images/ete-graph-straight.png" alt="ETE straight graph" style="border:1px solid black;">

<p>The circular variant certainly looks fancier, but if you have a lot of nodes in your tree, the result will be very difficult to read, so I&rsquo;d recommend to go with the &ldquo;straight&rdquo; variant.</p>
<p>You might also have noticed that graph branches have different distances/lengths between nodes/leafs. That is a capability/feature of Newick/ETE, as there are several Newick formats that you can use. If you don&rsquo;t need distances, use the <code>format=8</code> instead, and then here&rsquo;s the result you&rsquo;ll get:</p>


    <img class="image-post" loading="lazy" src="/blog/2022/08/15/visitors-analytics-with-microsoft-graph/images/ete-graph-straight-no-distances.png" alt="ETE straight graph without distances">

<h5 id="rendering-problems-on-different-platforms">Rendering problems on different platforms</h5>
<p>ETE renders fine to PDF (<em>on all platforms?</em>), but rendering to raster formats such as PNG has some problems. For instance, on Windows 10 with Python 3.10.5 the <code>t.render()</code> and <code>t.show()</code> commands fail for me <a href="https://github.com/etetoolkit/ete/issues/616">like this</a>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-py" data-lang="py"><span style="display:flex;"><span>t<span style="color:#f92672">.</span>render(<span style="color:#e6db74">&#34;./tree.png&#34;</span>, w<span style="color:#f92672">=</span><span style="color:#ae81ff">1920</span>, units<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;px&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#75715e">#t.show()</span></span></span></code></pre></div>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>TypeError: arguments did not match any overloaded call:
</span></span><span style="display:flex;"><span>  QImage<span style="color:#f92672">()</span>: too many arguments
</span></span><span style="display:flex;"><span>  QImage<span style="color:#f92672">(</span>QSize, QImage.Format<span style="color:#f92672">)</span>: argument <span style="color:#ae81ff">1</span> has unexpected type <span style="color:#e6db74">&#39;int&#39;</span>
</span></span><span style="display:flex;"><span>  QImage<span style="color:#f92672">(</span>int, int, QImage.Format<span style="color:#f92672">)</span>: argument <span style="color:#ae81ff">2</span> has unexpected type <span style="color:#e6db74">&#39;float&#39;</span>
</span></span><span style="display:flex;"><span>  QImage<span style="color:#f92672">(</span>bytes, int, int, QImage.Format<span style="color:#f92672">)</span>: argument <span style="color:#ae81ff">1</span> has unexpected type <span style="color:#e6db74">&#39;int&#39;</span>
</span></span><span style="display:flex;"><span>  QImage<span style="color:#f92672">(</span>sip.voidptr, int, int, QImage.Format<span style="color:#f92672">)</span>: argument <span style="color:#ae81ff">2</span> has unexpected type <span style="color:#e6db74">&#39;float&#39;</span>
</span></span><span style="display:flex;"><span>  QImage<span style="color:#f92672">(</span>bytes, int, int, int, QImage.Format<span style="color:#f92672">)</span>: argument <span style="color:#ae81ff">1</span> has unexpected type <span style="color:#e6db74">&#39;int&#39;</span>
</span></span><span style="display:flex;"><span>  QImage<span style="color:#f92672">(</span>sip.voidptr, int, int, int, QImage.Format<span style="color:#f92672">)</span>: argument <span style="color:#ae81ff">2</span> has unexpected type <span style="color:#e6db74">&#39;float&#39;</span>
</span></span><span style="display:flex;"><span>  QImage<span style="color:#f92672">(</span>List<span style="color:#f92672">[</span>str<span style="color:#f92672">])</span>: argument <span style="color:#ae81ff">1</span> has unexpected type <span style="color:#e6db74">&#39;int&#39;</span>
</span></span><span style="display:flex;"><span>  QImage<span style="color:#f92672">(</span>str, format: str <span style="color:#f92672">=</span> None<span style="color:#f92672">)</span>: argument <span style="color:#ae81ff">1</span> has unexpected type <span style="color:#e6db74">&#39;int&#39;</span>
</span></span><span style="display:flex;"><span>  QImage<span style="color:#f92672">(</span>QImage<span style="color:#f92672">)</span>: argument <span style="color:#ae81ff">1</span> has unexpected type <span style="color:#e6db74">&#39;int&#39;</span>
</span></span><span style="display:flex;"><span>  QImage<span style="color:#f92672">(</span>Any<span style="color:#f92672">)</span>: too many arguments</span></span></code></pre></div>
<p>If I explicitly provide the height value too, then it fails differently:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-py" data-lang="py"><span style="display:flex;"><span>t<span style="color:#f92672">.</span>render(<span style="color:#e6db74">&#34;./tree.png&#34;</span>, w<span style="color:#f92672">=</span><span style="color:#ae81ff">1920</span>, h<span style="color:#f92672">=</span><span style="color:#ae81ff">1080</span>, units<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;px&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#75715e">#t.show()</span></span></span></code></pre></div>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>    <span style="color:#ae81ff">752</span> ii<span style="color:#f92672">=</span> QImage<span style="color:#f92672">(</span>w, h, QImage.Format_ARGB32<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ae81ff">753</span> ii.fill<span style="color:#f92672">(</span>QColor<span style="color:#f92672">(</span>Qt.white<span style="color:#f92672">)</span>.rgb<span style="color:#f92672">())</span>
</span></span><span style="display:flex;"><span>--&gt; <span style="color:#ae81ff">754</span> ii.setDotsPerMeterX<span style="color:#f92672">(</span>dpi / 0.0254<span style="color:#f92672">)</span> <span style="color:#75715e"># Convert inches to meters</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ae81ff">755</span> ii.setDotsPerMeterY<span style="color:#f92672">(</span>dpi / 0.0254<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ae81ff">756</span> pp <span style="color:#f92672">=</span> QPainter<span style="color:#f92672">(</span>ii<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>TypeError: setDotsPerMeterX<span style="color:#f92672">(</span>self, int<span style="color:#f92672">)</span>: argument <span style="color:#ae81ff">1</span> has unexpected type <span style="color:#e6db74">&#39;float&#39;</span></span></span></code></pre></div>
<p>And that seems to be a <a href="https://github.com/etetoolkit/ete/issues/635">bug in PyQt</a>. It might help to install an older version of Python (<em>and probably PyQt</em>), but I haven&rsquo;t checked that myself.</p>
<p>On Mac OS all the same works fine with Python 3.9.13.</p>
<h5 id="managers-tree-graph">Managers tree graph</h5>
<p>Finally, here&rsquo;s how our Newick string with managers can be visualized as an ETE graph:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-py" data-lang="py"><span style="display:flex;"><span>newickWithLehgths <span style="color:#f92672">=</span> <span style="color:#66d9ef">False</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>newickString <span style="color:#f92672">=</span> json2newick1(jsonTree, newickWithLehgths)
</span></span><span style="display:flex;"><span>print(newickString)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#newicks = json2newick2(jsonTree, newickWithLehgths)</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#print(newicks)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>newickFormat <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span> <span style="color:#66d9ef">if</span> newickWithLehgths <span style="color:#66d9ef">else</span> <span style="color:#ae81ff">8</span>
</span></span><span style="display:flex;"><span>newickCircle <span style="color:#f92672">=</span> <span style="color:#66d9ef">False</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>ts <span style="color:#f92672">=</span> ete3<span style="color:#f92672">.</span>TreeStyle()
</span></span><span style="display:flex;"><span>ts<span style="color:#f92672">.</span>show_leaf_name <span style="color:#f92672">=</span> <span style="color:#66d9ef">False</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#ts.show_branch_support = True</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> newickCircle:
</span></span><span style="display:flex;"><span>    ts<span style="color:#f92672">.</span>scale <span style="color:#f92672">=</span> <span style="color:#ae81ff">50</span>
</span></span><span style="display:flex;"><span>    ts<span style="color:#f92672">.</span>mode <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;c&#34;</span>
</span></span><span style="display:flex;"><span>    ts<span style="color:#f92672">.</span>arc_start <span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">85</span> <span style="color:#75715e"># 0 degrees is 3:00 o&#39;clock</span>
</span></span><span style="display:flex;"><span>    ts<span style="color:#f92672">.</span>arc_span <span style="color:#f92672">=</span> <span style="color:#ae81ff">175</span>
</span></span><span style="display:flex;"><span>    ts<span style="color:#f92672">.</span>branch_vertical_margin <span style="color:#f92672">=</span> <span style="color:#ae81ff">10</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>    ts<span style="color:#f92672">.</span>branch_vertical_margin <span style="color:#f92672">=</span> <span style="color:#ae81ff">20</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ---</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>styleLeafManagerVisited_size <span style="color:#f92672">=</span> <span style="color:#ae81ff">10</span>
</span></span><span style="display:flex;"><span>styleLeafManagerVisited_bgcolor <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Ivory&#34;</span><span style="color:#75715e">#&#34;#FDFDFD&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>styleLeafManagerVisited <span style="color:#f92672">=</span> ete3<span style="color:#f92672">.</span>NodeStyle()
</span></span><span style="display:flex;"><span>styleLeafManagerVisited[<span style="color:#e6db74">&#34;fgcolor&#34;</span>] <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;blue&#34;</span>
</span></span><span style="display:flex;"><span>styleLeafManagerVisited[<span style="color:#e6db74">&#34;size&#34;</span>] <span style="color:#f92672">=</span> styleLeafManagerVisited_size
</span></span><span style="display:flex;"><span>styleLeafManagerVisited[<span style="color:#e6db74">&#34;bgcolor&#34;</span>] <span style="color:#f92672">=</span> styleLeafManagerVisited_bgcolor
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>styleLeafManagerNotVisited <span style="color:#f92672">=</span> ete3<span style="color:#f92672">.</span>NodeStyle()
</span></span><span style="display:flex;"><span>styleLeafManagerNotVisited[<span style="color:#e6db74">&#34;fgcolor&#34;</span>] <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;red&#34;</span>
</span></span><span style="display:flex;"><span>styleLeafManagerNotVisited[<span style="color:#e6db74">&#34;size&#34;</span>] <span style="color:#f92672">=</span> styleLeafManagerVisited_size
</span></span><span style="display:flex;"><span>styleLeafManagerNotVisited[<span style="color:#e6db74">&#34;bgcolor&#34;</span>] <span style="color:#f92672">=</span> styleLeafManagerVisited_bgcolor
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ---</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>styleLeafManagerNotVisited_size <span style="color:#f92672">=</span> <span style="color:#ae81ff">10</span>
</span></span><span style="display:flex;"><span>styleLeafManagerNotVisited_shape <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;square&#34;</span>
</span></span><span style="display:flex;"><span>styleLeafManagerNotVisited_bgcolor <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;PowderBlue&#34;</span><span style="color:#75715e">#&#34;#FAFAFA&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>styleNodeManagerVisited <span style="color:#f92672">=</span> ete3<span style="color:#f92672">.</span>NodeStyle()
</span></span><span style="display:flex;"><span>styleNodeManagerVisited[<span style="color:#e6db74">&#34;fgcolor&#34;</span>] <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;blue&#34;</span>
</span></span><span style="display:flex;"><span>styleNodeManagerVisited[<span style="color:#e6db74">&#34;shape&#34;</span>] <span style="color:#f92672">=</span> styleLeafManagerNotVisited_shape
</span></span><span style="display:flex;"><span>styleNodeManagerVisited[<span style="color:#e6db74">&#34;size&#34;</span>] <span style="color:#f92672">=</span> styleLeafManagerNotVisited_size
</span></span><span style="display:flex;"><span>styleNodeManagerVisited[<span style="color:#e6db74">&#34;bgcolor&#34;</span>] <span style="color:#f92672">=</span> styleLeafManagerNotVisited_bgcolor
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>styleNodeManagerNotVisited <span style="color:#f92672">=</span> ete3<span style="color:#f92672">.</span>NodeStyle()
</span></span><span style="display:flex;"><span>styleNodeManagerNotVisited[<span style="color:#e6db74">&#34;fgcolor&#34;</span>] <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;red&#34;</span>
</span></span><span style="display:flex;"><span>styleNodeManagerNotVisited[<span style="color:#e6db74">&#34;shape&#34;</span>] <span style="color:#f92672">=</span> styleLeafManagerNotVisited_shape
</span></span><span style="display:flex;"><span>styleNodeManagerNotVisited[<span style="color:#e6db74">&#34;size&#34;</span>] <span style="color:#f92672">=</span> styleLeafManagerNotVisited_size
</span></span><span style="display:flex;"><span>styleNodeManagerNotVisited[<span style="color:#e6db74">&#34;bgcolor&#34;</span>] <span style="color:#f92672">=</span> styleLeafManagerNotVisited_bgcolor
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ---</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>t <span style="color:#f92672">=</span> ete3<span style="color:#f92672">.</span>Tree(newickString, format<span style="color:#f92672">=</span>newickFormat)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> n <span style="color:#f92672">in</span> t<span style="color:#f92672">.</span>traverse():
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">#n.dist = 0</span>
</span></span><span style="display:flex;"><span>    nodeName <span style="color:#f92672">=</span> ete3<span style="color:#f92672">.</span>TextFace(n<span style="color:#f92672">.</span>name)
</span></span><span style="display:flex;"><span>    nodeName<span style="color:#f92672">.</span>margin_left <span style="color:#f92672">=</span> <span style="color:#ae81ff">5</span>
</span></span><span style="display:flex;"><span>    nodeName<span style="color:#f92672">.</span>margin_right <span style="color:#f92672">=</span> <span style="color:#ae81ff">5</span>
</span></span><span style="display:flex;"><span>    n<span style="color:#f92672">.</span>add_face(nodeName, column<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">#print(n.name, n.is_leaf())</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">#print(n.name, n.name in usersAndManagers[&#34;mail&#34;].values)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> n<span style="color:#f92672">.</span>is_leaf():
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> n<span style="color:#f92672">.</span>name <span style="color:#f92672">in</span> usersAndManagers[<span style="color:#e6db74">&#34;mail&#34;</span>]<span style="color:#f92672">.</span>values:
</span></span><span style="display:flex;"><span>            n<span style="color:#f92672">.</span>set_style(styleLeafManagerVisited)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>            n<span style="color:#f92672">.</span>set_style(styleLeafManagerNotVisited)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> n<span style="color:#f92672">.</span>name <span style="color:#f92672">in</span> usersAndManagers[<span style="color:#e6db74">&#34;mail&#34;</span>]<span style="color:#f92672">.</span>values:
</span></span><span style="display:flex;"><span>            n<span style="color:#f92672">.</span>set_style(styleNodeManagerVisited)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>            n<span style="color:#f92672">.</span>set_style(styleNodeManagerNotVisited)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#print(t.write(format=8))</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#print(f&#34;root_opening_factor: {ts.root_opening_factor}&#34;)</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#ts.root_opening_factor = 1</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>folderWithRenders <span style="color:#f92672">=</span> pathlib<span style="color:#f92672">.</span>Path(<span style="color:#e6db74">&#34;./trees&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> folderWithRenders<span style="color:#f92672">.</span>exists():
</span></span><span style="display:flex;"><span>    folderWithRenders<span style="color:#f92672">.</span>mkdir()
</span></span><span style="display:flex;"><span>t<span style="color:#f92672">.</span>render((folderWithRenders <span style="color:#f92672">/</span> <span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">{</span>t<span style="color:#f92672">.</span>name<span style="color:#e6db74">}</span><span style="color:#e6db74">.pdf&#34;</span>)<span style="color:#f92672">.</span>as_posix(), tree_style<span style="color:#f92672">=</span>ts)
</span></span><span style="display:flex;"><span>t<span style="color:#f92672">.</span>render(
</span></span><span style="display:flex;"><span>    (folderWithRenders <span style="color:#f92672">/</span> <span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">{</span>t<span style="color:#f92672">.</span>name<span style="color:#e6db74">}</span><span style="color:#e6db74">.png&#34;</span>)<span style="color:#f92672">.</span>as_posix(),
</span></span><span style="display:flex;"><span>    w<span style="color:#f92672">=</span>(<span style="color:#ae81ff">1080</span> <span style="color:#66d9ef">if</span> newickCircle <span style="color:#66d9ef">else</span> <span style="color:#ae81ff">640</span>),
</span></span><span style="display:flex;"><span>    units<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;px&#34;</span>,
</span></span><span style="display:flex;"><span>    tree_style<span style="color:#f92672">=</span>ts
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># that is for visualizing json2newick2() results</span>
</span></span><span style="display:flex;"><span>commentedOut <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">for ni in newicks:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    #print(ni)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    #t = ete3.Tree(&#34;(A:0.1,B:0.2,(C:0.3,D:0.4)E:0.5)F;&#34;, format=1)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    #t = ete3.Tree(&#34;(A,B,(C,D)E)F;&#34;, format=8)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    t = ete3.Tree(ni, format=newickFormat)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    for n in t.traverse():
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        #n.dist = 0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        nodeName = ete3.TextFace(n.name)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        nodeName.margin_left = 5
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        nodeName.margin_right = 5
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        n.add_face(nodeName, column=0)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        #print(n.name, n.is_leaf())
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        if n.is_leaf():
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            n.set_style(styleLeafManager)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        else:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            n.set_style(styleNodeManager)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    #print(t.write(format=8))
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    #print(f&#34;root_opening_factor: </span><span style="color:#e6db74">{ts.root_opening_factor}</span><span style="color:#e6db74">&#34;)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    #ts.root_opening_factor = 1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    folderWithRenders = pathlib.Path(&#34;./trees&#34;)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    if not folderWithRenders.exists():
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        folderWithRenders.mkdir()
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    t.render((folderWithRenders / f&#34;</span><span style="color:#e6db74">{t.name}</span><span style="color:#e6db74">.pdf&#34;).as_posix(), tree_style=ts)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    t.render(
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        (folderWithRenders / f&#34;</span><span style="color:#e6db74">{t.name}</span><span style="color:#e6db74">.png&#34;).as_posix(),
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        w=(1080 if newickCircle else 640),
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        units=&#34;px&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        tree_style=ts
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    )
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;&#34;&#34;</span></span></span></code></pre></div>
<p>The resulting graph for our example managers tree <a href="#composing-a-newick-tree">from above</a> will look like this:</p>


    <img class="image-post" loading="lazy" src="/blog/2022/08/15/visitors-analytics-with-microsoft-graph/images/managers-graph.png" alt="ETE graph" style="border:1px solid black;">

<p>The graph legend:</p>
<ul>
<li>icon shape:
<ul>
<li>circle means lowest level manager with only non-manager subordinates;</li>
<li>square (<em>and teal-ish background</em>) means manager who has other managers as his subordinates;</li>
</ul>
</li>
<li>icon color:
<ul>
<li>blue means that this user has visited at least one of our resources himself;</li>
<li>red means that this user has not visited any of our resources (<em>so it&rsquo;s only his subordinates who have</em>) and he is present on the graph only as a part of the managers tree.</li>
</ul>
</li>
</ul>
<p>It&rsquo;s only managers (<em>users with at least one subordinate</em>) who are present on this chart, because visualizing the entire tree with all the subordinates would (<em>dramatically</em>) overload the resulting graph.</p>
<p>If your graph is big enough, then to have it readable in a raster output you&rsquo;ll need to (<em>considerably</em>) increase the width/height parameters of the <code>render()</code> method, but that will also result in a very big file (<em>several megabytes</em>). So what I did instead is I render it twice: to a proper readable PDF and also to a small low-resolution PNG. The PNG is then used as a preview with a link to the PDF variant underneath.</p>
<p>By the way, here&rsquo;s an example of a circular graph variant, just to demonstrate that it is harder to read when it has a lot of nodes:</p>
<p><a href="./images/managers-graph-circle.pdf">

    <img class="image-post" loading="lazy" src="/blog/2022/08/15/visitors-analytics-with-microsoft-graph/images/managers-graph-circle.png" alt="ETE circle graph">
</a></p>
<p>&ldquo;Limiting&rdquo; the circle with <code>arc_start</code>/<code>arc_span</code> properties makes it more readable, but still not good enough. Which is why I recommended to go with a non-circular variant.</p>
<h2 id="conclusion">Conclusion</h2>
<p>Almost all the charts turned out to be quite useful, and in general it&rsquo;s nice to have data not as dull tables but as fancy-ish visualizations.</p>
<p>The managers graph ended up being kind of useless, in my opinion. It is certainly cool to be able to visualize tree structures like this, which is why I did it in the first place, but I can&rsquo;t think of a way how this particular managers graph could be useful for the purpose of the visitors analytics. Moreover, if one is interested to see the managers tree of some employee, he can just as well look it up in that user&rsquo;s Outlook/Teams profile card.</p>
<p>If you have other ideas (<em>and examples</em>) of what kind of charts one could make for the purpose of visitors analytics, it would be great if you shared those in comments. And if you can suggest a better code for generating a tree structure for composing a Newick string, that would be awesome too.</p>
      </div>
    </article>
    <div><div id="tags">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tag">
  <path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path><line x1="7" y1="7" x2="7" y2="7"></line>
</svg>
          <a class="tag" href="https://retifrav.github.io/tags/azure/">azure</a><a class="tag" href="https://retifrav.github.io/tags/web/">web</a><a class="tag" href="https://retifrav.github.io/tags/python/">python</a></div><hr class="comments-divider"/>
      <div id="comments">
      
          <div style="border:2px orange solid; background-color: floralwhite; border-radius:0.5rem; padding: 10px 14px; font-style:italic; font-size:0.9em;">
              If you'd like to comment the article, you can do it on the
              <a href="https://decovar.dev/blog/2022/08/15/visitors-analytics-with-microsoft-graph/#remark42" style="font-weight:bold;">
                  original website</a>. This one is just a mirror without comments.
          </div>
      
      </div>
    </div>
  </div>

        <div id="footer">
          <div>
              2014 - 2023,
              <a href="/about/">retif</a>
          </div>
          <div><a href="/about/#licenses">CC BY-SA 4.0 / GPLv3</a></div>
        </div>
      </main>
      <div class="app-header">
        <div style="margin:0 0 20px;">
            <input id="search-query" placeholder="Search in titles and summaries" />
        </div>
        <div id="search-results" style="display:none;"></div>
        <div id="sidebars">
            <a id="avatar" href="/about"><img class="app-header-avatar" src="/images/avatar.png" /></a>
            <iframe src="https://github.com/sponsors/retifrav/button"
                height="35" style="border:0;"
                title="You can sponsor me">
            </iframe>
            
            <div class="sidebar-section">
              <h3>Feeds</h3>
              <a href="/index.xml" title="Subscribe to RSS"><img src="/images/rss.png" width="50px"></a>
              <a style="margin-left: 5px;" href="https://t.me/decovar" title="Telegram channel"><img src="/images/telegram.png" width="50px"></a>
            </div>
            <div id="telegramWidgetBlock" class="sidebar-section"></div>
            <div class="sidebar-section">
                <h3>Stuff</h3>
                <ul class="sidebar-list">
                    <li><a href="/stuff/kakoi-jvotne-vi-kysaiti/index.html">КАКОИ ЖВОТНЕ ВЫ КУСАИТИ?</a></li>
                </ul>
            </div>
            <div id="social-networks" class="sidebar-section">
              <h3>Social networks</h3>
              <div style="font-family:Courier New;">
                  Zuck: <i>Yeah so if you ever need info about anyone at Harvard</i><br/>
                  Zuck: <i>Just ask</i><br/>
                  Zuck: <i>I have over 4,000 emails, pictures, addresses, SNS</i><br/>
                  smb: <i>What? How'd you manage that one?</i><br/>
                  Zuck: <i>People just submitted it.</i><br/>
                  Zuck: <i>I don't know why.</i><br/>
                  Zuck: <i>They "trust me"</i><br/>
                  Zuck: <i>Dumb fucks</i>
              </div>
            </div>
            <div class="sidebar-section">
              <h3>Tags</h3>
              <ul style="list-style-type:none; padding:0; margin:0;">
                  
                  <li><a href="/tags/web">web (65)</a></li>
                  
                  <li><a href="/tags/fail">fail (39)</a></li>
                  
                  <li><a href="/tags/dotnet">dotnet (36)</a></li>
                  
                  <li><a href="/tags/qt">qt (35)</a></li>
                  
                  <li><a href="/tags/review">review (28)</a></li>
                  
                  <li><a href="/tags/linux">linux (27)</a></li>
                  
                  <li><a href="/tags/devops">devops (23)</a></li>
                  
                  <li><a href="/tags/macos">macos (23)</a></li>
                  
                  <li><a href="/tags/windows">windows (19)</a></li>
                  
                  <li><a href="/tags/mestuff">mestuff (17)</a></li>
                  
                  <li><a href="/tags/movies">movies (15)</a></li>
                  
                  <li><a href="/tags/tractor">tractor (15)</a></li>
                  
                  <li><a href="/tags/norway">norway (14)</a></li>
                  
                  <li><a href="/tags/irl">irl (12)</a></li>
                  
                  <li><a href="/tags/python">python (12)</a></li>
                  
                  <li><a href="/tags/telegram">telegram (12)</a></li>
                  
                  <li><a href="/tags/embedded">embedded (11)</a></li>
                  
                  <li><a href="/tags/cpp">cpp (10)</a></li>
                  
                  <li><a href="/tags/soft">soft (10)</a></li>
                  
                  <li><a href="/tags/travel">travel (10)</a></li>
                  
                  <li><a href="/tags/applescript">applescript (9)</a></li>
                  
                  <li><a href="/tags/cmake">cmake (9)</a></li>
                  
                  <li><a href="/tags/piracy">piracy (9)</a></li>
                  
                  <li><a href="/tags/octopress">octopress (8)</a></li>
                  
                  <li><a href="/tags/banks">banks (7)</a></li>
                  
                  <li><a href="/tags/games">games (7)</a></li>
                  
                  <li><a href="/tags/ios">ios (7)</a></li>
                  
                  <li><a href="/tags/apple">apple (6)</a></li>
                  
                  <li><a href="/tags/javascript">javascript (6)</a></li>
                  
                  <li><a href="/tags/photo">photo (6)</a></li>
                  
                  <li><a href="/tags/sql">sql (6)</a></li>
                  
                  <li><a href="/tags/russia">russia (5)</a></li>
                  
                  <li><a href="/tags/hugo">hugo (4)</a></li>
                  
                  <li><a href="/tags/usa">usa (4)</a></li>
                  
                  <li><a href="/tags/wordpress">wordpress (4)</a></li>
                  
                  <li><a href="/tags/android">android (3)</a></li>
                  
                  <li><a href="/tags/azure">azure (3)</a></li>
                  
                  <li><a href="/tags/tv">tv (3)</a></li>
                  
                  <li><a href="/tags/privacy">privacy (2)</a></li>
                  
                  <li><a href="/tags/steam-deck">steam-deck (2)</a></li>
                  
                  <li><a href="/tags/tvos">tvos (2)</a></li>
                  
                  <li><a href="/tags/unsolved">unsolved (2)</a></li>
                  
                  <li><a href="/tags/books">books (1)</a></li>
                  
                  <li><a href="/tags/ffmpeg">ffmpeg (1)</a></li>
                  
                  <li><a href="/tags/ldap">ldap (1)</a></li>
                  
                  <li><a href="/tags/music">music (1)</a></li>
                  
                  <li><a href="/tags/science">science (1)</a></li>
                  
                  <li><a href="/tags/vr">vr (1)</a></li>
                  
              </ul>
            </div>
        </div>
      </header>
    </div>

    <script src="/js/search.js"></script>

    
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-53340325-1"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag() { dataLayer.push(arguments); }
      gtag("js", new Date());
      gtag("config", "UA-53340325-1");
    </script>

    <script>
        const telegramBlock = document.getElementById("telegramWidgetBlock");
        window.onload = () =>
        {
            const pinnedTelegramPosts = [277,279,306,312,319]
            const randomedPostID = pinnedTelegramPosts[
                Math.floor(Math.random() * pinnedTelegramPosts.length)
            ];
            const telegramWidgetScript = document.createElement("script");
            telegramWidgetScript.src = "https://telegram.org/js/telegram-widget.js?21";
            telegramWidgetScript.dataset["telegramPost"] = `decovar/${randomedPostID}`;
            telegramWidgetScript.dataset["color"] = "1E8448";
            telegramWidgetScript.dataset["width"] = "100%";
            telegramWidgetScript.dataset["userpic"] = "false";
            telegramBlock.appendChild(telegramWidgetScript);
        }
    </script>

    
    
  </body>
</html>
