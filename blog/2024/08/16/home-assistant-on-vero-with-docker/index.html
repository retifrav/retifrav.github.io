<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Home Assistant on Vero V with Docker | Declaration of VAR</title>
    <link rel="canonical" href="https://decovar.dev/blog/2024/08/16/home-assistant-on-vero-with-docker/" />

    <meta name="generator" content="Hugo" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <link href="/favicon.png" rel="icon">

    <meta name="author" content="retif" />
    <meta name="description" content="Being quite a powerful device, Vero V has a lot of room for running other things than just Kodi, so I decided to make it my home automation hub and install Home Assistant on it. And I chose to run it in a Docker container, which worked out pretty well." />

    <link rel="alternate" type="application/rss+xml" href="/index.xml" title="Declaration of VAR" />

    <meta property="og:url" content="https://retifrav.github.io/blog/2024/08/16/home-assistant-on-vero-with-docker/">
  <meta property="og:site_name" content="Declaration of VAR">
  <meta property="og:title" content="Home Assistant on Vero V with Docker">
  <meta property="og:description" content="Being quite a powerful device, Vero V has a lot of room for running other things than just Kodi, so I decided to make it my home automation hub and install Home Assistant on it. And I chose to run it in a Docker container, which worked out pretty well.">
  <meta property="og:locale" content="en_us">
  <meta property="og:type" content="article">
    <meta property="article:section" content="blog">
    <meta property="article:published_time" content="2024-08-16T16:49:19+02:00">
    <meta property="article:modified_time" content="2024-08-16T16:49:19+02:00">
    <meta property="article:tag" content="Home-Automation">
    <meta property="article:tag" content="Linux">
    <meta property="article:tag" content="Norway">


    <link rel="stylesheet" href="https://retifrav.github.io/css/main.min.2a28493e0b91076cde9fb52cb7fec81f63f685a6965e6a9df1179ec846b9141f.css" />
    <link rel="stylesheet" href="/css/default.css" />
    <link rel="stylesheet" href="/css/post.css" />
    <link rel="stylesheet" href="/css/page.css" />
    <link rel="stylesheet" href="/css/comments.css" />

    <script src="/js/mark.js"></script>

    
    
  </head>
  <body>
    <div id="body-hat">
      <div id="title-block">
        <h1 id="blog-title"><a href="/">Declaration of VAR</a></h1>
        <p>and some other stuff</p>
      </div>
    </div>
    <div style="background-color:orange; padding:4px 16px; font-size:0.8em; text-align:center; font-style:italic;">
        On 19.05.2021 the website was moved to
        <a href="https://decovar.dev/blog/2024/08/16/home-assistant-on-vero-with-docker/" style="color:black; font-weight:bold;">
            https://decovar.dev/</a>. This is just a mirror now.
    </div>
    <div id="body-flex">
      <main class="app-container">
        
  <div id="main-container">
    <article class="post">
      <header class="post-header">
        <h1 class ="post-title">Home Assistant on Vero V with Docker</h1>
        <div class="post-meta">
          <div><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-calendar">
  <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line>
</svg> 2024-08-16 16:49:19 &#43;0200</div>
          <div><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-clock">
  <circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline>
</svg> 48 min read</div>
        </div>
      </header>
      <div class="post-content">
        <p>Eventually I got tired of constantly <a href="/blog/2019/12/26/appletv-kodi-network-share/#install-kodi">re-signing and re-uploading</a> Kodi to my Apple TV (<em>and <a href="/blog/2019/12/26/appletv-kodi-network-share/#updates">being stuck</a> with an old version</em>). So I got a <a href="https://osmc.tv/vero/">Vero V</a> instead, and immediately it became clear that I should have done so from the beginning, buying Apple TV was a mistake. Like I said before, if not for running Kodi, Apple TV is a <a href="/blog/2019/12/26/appletv-kodi-network-share/#whats-wrong-with-apple-tv">pretty useless</a> device (<em>especially now that I have a TV that supports <a href="https://apple.com/airplay/">AirPlay</a></em>).</p>


    <img class="image-post" loading="lazy" src="/blog/2024/08/16/home-assistant-on-vero-with-docker/images/vero-v-sonoff-zigbee.jpg" alt="Vero V with connected SONOFF Zigbee 3.0 USB Dongle Plus-E">

<p>Around the same time I entered the domain of home automation. At first it was just <a href="https://homely.no">Homely</a> (<em>a norwegian home security system</em>), which comes with their own hub and a (<em>not very large</em>) set of supported devices/sensors. But soon enough I discovered that it&rsquo;s all just a <a href="https://en.wikipedia.org/wiki/Zigbee">Zigbee</a> network wrapped into a user-friendly package, so I could do more with my own hub and a much wider (<em>and cheaper</em>) collection of devices and sensors. Shortly after that realization I stumbled upon <a href="https://home-assistant.io">Home Assistant</a>, as all roads lead to it, and, you guessed it right, I decided to run it on that same Vero V.</p>
<nav id="TableOfContents">
  <ul>
    <li><a href="#is-something-wrong-with-homely">Is something wrong with Homely</a></li>
    <li><a href="#why-not-a-dedicated-device">Why not a dedicated device</a></li>
    <li><a href="#environment-and-versions">Environment and versions</a></li>
    <li><a href="#installation">Installation</a>
      <ul>
        <li><a href="#docker">Docker</a></li>
        <li><a href="#home-assistant">Home Assistant</a>
          <ul>
            <li><a href="#ip-address-of-the-running-container">IP address of the running container</a></li>
          </ul>
        </li>
        <li><a href="#nginx">NGINX</a>
          <ul>
            <li><a href="#what-if-container-ip-address-will-change">What if container IP address will change</a></li>
            <li><a href="#https">HTTPS</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#zigbee">Zigbee</a>
      <ul>
        <li><a href="#eclipse-mosquitto">Eclipse Mosquitto</a></li>
        <li><a href="#zigbee2mqtt">Zigbee2MQTT</a>
          <ul>
            <li><a href="#philips-hue-smart-plug">Philips Hue Smart Plug</a></li>
            <li><a href="#frient-smart-plug-mini-2">Frient Smart Plug Mini 2</a></li>
            <li><a href="#ikea-tradfri-e27">IKEA Tradfri E27</a></li>
            <li><a href="#nimly-connect-module">nimly Connect Module</a></li>
            <li><a href="#aqara-cube-t1-pro">Aqara Cube T1 Pro</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#home-assistant-community-store">Home Assistant Community Store</a>
      <ul>
        <li><a href="#dyson-hp09">Dyson HP09</a>
          <ul>
            <li><a href="#controlling-dyson-with-aqara-cube">Controlling Dyson with Aqara Cube</a></li>
          </ul>
        </li>
        <li><a href="#zaptec">Zaptec</a></li>
        <li><a href="#nord-pool-electricity-prices">Nord Pool electricity prices</a></li>
      </ul>
    </li>
    <li><a href="#organizing-dashboards">Organizing dashboards</a></li>
    <li><a href="#backups">Backups</a></li>
    <li><a href="#performance-monitoring-with-btop">Performance monitoring with btop</a></li>
  </ul>
</nav>
<h1 id="is-something-wrong-with-homely">Is something wrong with Homely</h1>
<p>I said that I started with Homely before getting into Home Assistant, and that might have given you an impression that I switched from one to another. But no, I still use Homely, it just serves a different purpose, so it is not that I have replaced it with Home Assistant.</p>
<p>Homely isn&rsquo;t a yet another automation hub with some devices. Its main purpose is to connect your home to their 24/7 monitoring system, and if something happens - smoke sensor detects fire, or alarm is triggered by door/window/motion sensors - monitoring will get notified, and they will call firefighters/police/whoever for you. As a bonus to that, you also get some basic home automation.</p>
<p>As you can imagine, such a system cannot depend on a random 1 USD sensor from uncle Lao, as it all needs to be certified/approved, which I guess is why their set of supported devices is not very long. Mostly it&rsquo;s <a href="https://frient.com">Frient</a>/<a href="https://develcoproducts.com">Develco</a>/<a href="https://onestiproducts.io/">Onesti</a> devices (<em>they all seem to be the same thing, just re-branded</em>), but there are also <a href="https://ikea.com/no/no/cat/tradlose-led-paerer-36813/">IKEA bulbs</a> and other vendors there too, although some of them also seem to be just re-branded variants of the same things, so the &ldquo;actual&rdquo; list might be shorter:</p>
<div class="vertical-image-centered-scaled">


    <img class="image-post" loading="lazy" src="/blog/2024/08/16/home-assistant-on-vero-with-docker/images/homely-supported-vendors.png" alt="Homely, supported vendors" style="border:1px solid black;">

</div>
<p>I cannot say how good (<em>or bad</em>) their monitoring is, as I never had any accidents that would trigger an alarm, and hopefully I will never know how good (<em>or bad</em>) their monitoring is. I can only say that out of all the security systems available in Norway, Homely&rsquo;s monthly subscription fee is the lowest (<em>in 2024 it was plain and simple 199 NOK per month, without cheeky offers like a &ldquo;free&rdquo; smart lock installation</em>), and they are recognized by insurance companies, so you can get a discount on your house insurance too. They do overprice the devices/sensors though, so you can most likely find several of those cheaper in other places.</p>
<p>The mobile application is okay, although looks like it&rsquo;s not their own but a customized (<em>re-styled</em>) variant of <a href="https://keyfree.no">Keyfree</a>. The <a href="https://nimly.io/product/connect-app-en/">nimly application</a> seems to be using the same. Or maybe there is some other common &ldquo;parent&rdquo; for all of them, but either way they definitely look the same.</p>
<p>Surprisingly, there is no web-version, so you are limited to controlling it from the mobile application only. And by the way, there is no proper iPad version, it just uses the same iPhone application, which isn&rsquo;t optimized for non-iPhone screens.</p>
<p>Coming back to home automation, it&rsquo;s actually not the small number of supported devices that made me look elsewhere, but the very limited set of automation rules/triggers. For example, you cannot create a rule to turn on the lights when movement sensor detects you entering the room, which seems to be a very common routine to have. That&rsquo;s how I got to Home Assistant, where automation capabilities are practically limitless, and I left Homely to handle just the security/safety stuff.</p>
<h1 id="why-not-a-dedicated-device">Why not a dedicated device</h1>
<p>Yes, I could&rsquo;ve gotten a dedicated device to run Home Assistant - Raspberry Pi or maybe their own <a href="https://home-assistant.io/green/">Green</a>/<a href="https://home-assistant.io/yellow/">Yellow</a> boxes - and they are rather inexpensive, but that&rsquo;s yet another box cluttering my shelves.</p>
<p>I already have Vero V, and it is quite a powerful device - 2 GHz ARM CPU (<em>4 cores</em>), 4 GB RAM, 32GB eMMC. Kodi is barely taking 10% of resources even while playing 4K movies, so there is a lot of room for doing something else, such as running Home Assistant, and it would be wasteful not to do so.</p>
<h1 id="environment-and-versions">Environment and versions</h1>
<p>Just in case, here&rsquo;s my environment and versions of the software/firmware that I have:</p>
<ul>
<li>Vero V:
<ul>
<li>Debian: <code>11.10</code></li>
<li>OSMC: <code>2024.05-1</code></li>
</ul>
</li>
<li>Home Assistant: <code>2024.7.3</code></li>
<li>Zigbee adapter/coordinator: <code>SONOFF Zigbee 3.0 USB Dongle Plus-E</code>
<ul>
<li>type: <code>EZSP v8</code></li>
<li>revision: <code>6.10.3.0 build 297</code></li>
</ul>
</li>
<li>Zigbee2MQTT: <code>1.39.0</code>, commit <code>0326926</code></li>
</ul>
<h1 id="installation">Installation</h1>
<p>On the first <a href="https://osmc.tv/wiki/general/accessing-the-command-line/">connect</a>, before anything else, change the default <code>osmc</code> password to a proper one with <code>passwd</code>, <a href="https://github.com/retifrav/scraps/blob/master/_linux/ssh.md#generate-a-new-ssh-key">deploy an SSH key</a> and <a href="https://github.com/retifrav/scraps/blob/master/_linux/ssh.md#disable-ssh-passwords">disable passwords authentication</a>.</p>
<h2 id="docker">Docker</h2>
<p>Out of all the <a href="https://home-assistant.io/installation/#advanced-installation-methods">possible ways</a> of installing Home Assistant I chose <a href="https://docker.com">Docker</a>. Mainly because I have never used Docker for anything (<em>aside from doing some tutorials</em>), so this seemed like a good opportunity to finally try it out for something actually useful. Secondly, from the little I knew about Docker, one of its distinguishing features is the ability to run stuff in an isolated environment, which was just the thing I needed, as I didn&rsquo;t want to disrupt the default Vero/OSMC environment too much, especially given that some of the Home Assistant components are run with godawful things like <a href="https://nodejs.org/">Node.js</a>.</p>
<p>One thing you should be aware of is that going with Docker way of installing Home Assistant you will lose certain features such as <a href="https://home-assistant.io/addons">addons</a> out of the box. That would be a major disadvantage or even a show-stopper, but actually it&rsquo;s no worries, because addons turned out to be&hellip; Docker containers too, which in other types of Home Assistant installation are just managed by the Home Assistant itself, so you absolutely can do the same on your own (<em>and probably better too</em>).</p>
<p>First you will need to install Docker, as it isn&rsquo;t preinstalled in OSMC by default. Following the trend of running random Bash scripts from the internet, Docker installation is supposed to be carried out that way too:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ mkdir ~/downloads <span style="color:#f92672">&amp;&amp;</span> cd $_
</span></span><span style="display:flex;"><span>$ curl -fsSL https://get.docker.com -o get-docker.sh
</span></span><span style="display:flex;"><span>$ less ./get-docker.sh
</span></span></code></pre></div><p>I scrolled the script contents and didn&rsquo;t see anything concerning enough, so I gave up and just ran it, but I certainly condemn this retarded practice. The &ldquo;installation&rdquo;:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ sudo sh ./get-docker.sh --dry-run
</span></span><span style="display:flex;"><span>$ sudo sh ./get-docker.sh
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ sudo systemctl enable docker.service
</span></span><span style="display:flex;"><span>$ sudo systemctl enable containerd.service
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ sudo docker run hello-world
</span></span></code></pre></div><p>After the installation it is probably a good idea to limit Docker logs size right away. The following should limit logs to the maximum of 5 files, each being 10 MB of size:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ sudo nano /etc/docker/daemon.json
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;log-driver&#34;</span>: <span style="color:#e6db74">&#34;json-file&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;log-opts&#34;</span>: {
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&#34;max-size&#34;</span>: <span style="color:#e6db74">&#34;10m&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&#34;max-file&#34;</span>: <span style="color:#e6db74">&#34;5&#34;</span>
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ dockerd --validate --config-file<span style="color:#f92672">=</span>/etc/docker/daemon.json
</span></span><span style="display:flex;"><span>configuration OK
</span></span></code></pre></div><p>Also, you might want to run Docker from a <a href="https://docs.docker.com/engine/install/linux-postinstall/#manage-docker-as-a-non-root-user">non-root user</a>, but for simplicity I decided to go with root, at least in the beginning, and I will probably make it non-root later.</p>
<h2 id="home-assistant">Home Assistant</h2>
<p>The installation or rather deployment procedure for anything Docker-based is to create a <a href="https://docs.docker.com/guides/docker-concepts/the-basics/what-is-a-container/">container</a> from a specified <a href="https://docs.docker.com/guides/docker-concepts/the-basics/what-is-an-image/">image</a>. If you don&rsquo;t have the image available locally already, it will get fetched from <a href="https://hub.docker.com">Docker Hub</a>. Which begs the question whether one can get images and host them somewhere locally and independently from Docker Hub, and fortunately that seems to be <a href="https://docker.com/blog/how-to-use-your-own-registry-2/">supported</a> too.</p>
<p>The process of creating/running a Home Assistant container is the following:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ sudo docker run -d <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    --name homeassistant <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    --restart<span style="color:#f92672">=</span>unless-stopped <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    -e TZ<span style="color:#f92672">=</span>Europe/Amsterdam <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    -v /root/homeassistant:/config <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    ghcr.io/home-assistant/home-assistant:stable
</span></span></code></pre></div><p>The <code>-v</code> argument here tells the container that host paths (<em>what&rsquo;s on the left from <code>:</code></em>) will be mapped to container paths (<em>what&rsquo;s on the right from <code>:</code></em>). Here Home Assistant settings (<em><code>/config/</code> path inside container</em>) will be stored in <code>/root/homeassistant/</code> path in the host filesystem. So when container will be deleted/re-created, the data will be preserved between container reincarnations. In addition to that, we can edit the configs in the host filesystem without logging-in to the container.</p>
<p>In <a href="https://home-assistant.io/installation/linux#platform-installation">their manual</a> they also set <code>--privileged</code> and <code>--network=host</code>, but there is no need for that, as well as there is probably no need for <code>-v /run/dbus:/run/dbus:ro</code> (<em>if you don&rsquo;t intend to use Bluetooth</em>). The Home Assistant team probably added those options to reduce the number of users complaining that &ldquo;<em>nothing works</em>&rdquo;, but in general these parameters certainly aren&rsquo;t great for something that is supposed to be running isolated from the main/host environment.</p>
<h3 id="ip-address-of-the-running-container">IP address of the running container</h3>
<p>In order to interact with Home Assistant, you will need to know the local IP address of its container. One of the ways to get it is to inspect the container:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ sudo docker inspect -f <span style="color:#e6db74">&#39;{{range.NetworkSettings.Networks}}{{.IPAddress}}{{end}}&#39;</span> homeassistant
</span></span><span style="display:flex;"><span>172.17.0.2
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ ping 172.17.0.2
</span></span><span style="display:flex;"><span>PING 172.17.0.2 <span style="color:#f92672">(</span>172.17.0.2<span style="color:#f92672">)</span>: <span style="color:#ae81ff">56</span> data bytes
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">64</span> bytes from 172.17.0.2: seq<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span> ttl<span style="color:#f92672">=</span><span style="color:#ae81ff">64</span> time<span style="color:#f92672">=</span>0.294 ms
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">64</span> bytes from 172.17.0.2: seq<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span> ttl<span style="color:#f92672">=</span><span style="color:#ae81ff">64</span> time<span style="color:#f92672">=</span>0.263 ms
</span></span><span style="display:flex;"><span>^C
</span></span></code></pre></div><p>You can also try to query it with cURL by sending a <code>HEAD</code> request to the default Home Assistant port <code>8123</code>, and it should reply that <code>HEAD</code> method is not allowed (<em>if you haven&rsquo;t performed the initial configuration/onboarding already</em>):</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ curl -I 172.17.0.2:8123
</span></span><span style="display:flex;"><span>HTTP/1.1 <span style="color:#ae81ff">405</span> Method Not Allowed
</span></span><span style="display:flex;"><span>Content-Type: text/plain; charset<span style="color:#f92672">=</span>utf-8
</span></span><span style="display:flex;"><span>Allow: GET
</span></span><span style="display:flex;"><span>Referrer-Policy: no-referrer
</span></span><span style="display:flex;"><span>X-Content-Type-Options: nosniff
</span></span><span style="display:flex;"><span>Server:
</span></span><span style="display:flex;"><span>X-Frame-Options: SAMEORIGIN
</span></span><span style="display:flex;"><span>Content-Length: <span style="color:#ae81ff">23</span>
</span></span><span style="display:flex;"><span>Date: Mon, <span style="color:#ae81ff">22</span> Jul <span style="color:#ae81ff">2024</span> 19:42:29 GMT
</span></span></code></pre></div><p>The <code>GET</code> request should return something like this:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ curl -v 172.17.0.2:8123
</span></span><span style="display:flex;"><span>*   Trying 172.17.0.2:8123...
</span></span><span style="display:flex;"><span>* Connected to 172.17.0.2 <span style="color:#f92672">(</span>172.17.0.2<span style="color:#f92672">)</span> port <span style="color:#ae81ff">8123</span> <span style="color:#f92672">(</span><span style="color:#75715e">#0)</span>
</span></span><span style="display:flex;"><span>&gt; GET / HTTP/1.1
</span></span><span style="display:flex;"><span>&gt; Host: 172.17.0.2:8123
</span></span><span style="display:flex;"><span>&gt; User-Agent: curl/7.74.0
</span></span><span style="display:flex;"><span>&gt; Accept: */*
</span></span><span style="display:flex;"><span>&gt;
</span></span><span style="display:flex;"><span>* Mark bundle as not supporting multiuse
</span></span><span style="display:flex;"><span>&lt; HTTP/1.1 <span style="color:#ae81ff">302</span> Found
</span></span><span style="display:flex;"><span>&lt; location: /onboarding.html
</span></span><span style="display:flex;"><span>&lt; Referrer-Policy: no-referrer
</span></span><span style="display:flex;"><span>&lt; X-Content-Type-Options: nosniff
</span></span><span style="display:flex;"><span>&lt; Server:
</span></span><span style="display:flex;"><span>&lt; X-Frame-Options: SAMEORIGIN
</span></span><span style="display:flex;"><span>&lt; Content-Length: <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>&lt; Content-Type: application/octet-stream
</span></span><span style="display:flex;"><span>&lt; Date: Mon, <span style="color:#ae81ff">22</span> Jul <span style="color:#ae81ff">2024</span> 19:42:45 GMT
</span></span><span style="display:flex;"><span>&lt;
</span></span><span style="display:flex;"><span>* Connection <span style="color:#75715e">#0 to host 172.17.0.2 left intact</span>
</span></span></code></pre></div><p>So yes, this IP address is definitely from the running Home Assistant container.</p>
<p>However, on the next restart/reboot the container might get a different IP address, but we need it to persist. Better yet, it would be great if there was some &ldquo;internal&rdquo; DNS - to be able to address containers by their names instead of IP addresses, especially when it comes to other containers &ldquo;talking&rdquo; to each other within their network. Sadly, by default the name resolution is disabled, and you can test it right now by spawning a new container:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cmd" data-lang="cmd"><span style="display:flex;"><span>$ sudo docker run -it --rm alpine /bin/ash
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>/ # ip route get 1 | awk &#39;{print $NF;exit}&#39;
</span></span><span style="display:flex;"><span>172.17.0.3
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>/ # apk --no-cache add curl
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>/ # curl -I http://172.17.0.2:8123 -v
</span></span><span style="display:flex;"><span>*   Trying 172.17.0.2:8123...
</span></span><span style="display:flex;"><span>* Connected to 172.17.0.2 (172.17.0.2) port 8123
</span></span><span style="display:flex;"><span>&gt; HEAD / HTTP/1.1
</span></span><span style="display:flex;"><span>&gt; Host: 172.17.0.2:8123
</span></span><span style="display:flex;"><span>&gt; User-Agent: curl/8.8.0
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>/ # curl -I http://homeassistant:8123 -v
</span></span><span style="display:flex;"><span>* Could not resolve host: homeassistant
</span></span><span style="display:flex;"><span>* Closing connection
</span></span><span style="display:flex;"><span>curl: (6) Could not resolve host: homeassistant
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>/ # exit
</span></span></code></pre></div><p>As you can see, this new temporary (<em>because of <code>--rm</code></em>) container got an IP address in the same network (<em><code>172.17.0.3</code></em>) and it could reach the <code>homeassistant</code> container by IP address, but could not reach it by hostname.</p>
<p>Fortunately, the name resolution can be enabled after all, it just isn&rsquo;t enabled in the default network. Check what networks you already have:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ sudo docker network list
</span></span><span style="display:flex;"><span>NETWORK ID     NAME      DRIVER    SCOPE
</span></span><span style="display:flex;"><span>f7dc4c461ccb   bridge    bridge    local
</span></span><span style="display:flex;"><span>e6e7d7a437b4   host      host      local
</span></span><span style="display:flex;"><span>ecc68fac9a4b   none      null      local
</span></span></code></pre></div><p>The one with <code>bridge</code> driver is the default network (<em><code>172.17.x.x</code></em>) where new containers are created, and that is where <code>homeassistant</code> container is running now too.</p>
<p>But if you <a href="https://docs.docker.com/network/network-tutorial-standalone/#use-user-defined-bridge-networks">create a new network</a> with the same <code>bridge</code> driver:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ sudo docker network create --driver bridge hub
</span></span><span style="display:flex;"><span>5dfbe1989378e089d5548ae21e4b48b055108b570be7ac717a0d9ad034b79817
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ sudo docker network list
</span></span><span style="display:flex;"><span>NETWORK ID     NAME      DRIVER    SCOPE
</span></span><span style="display:flex;"><span>f7dc4c461ccb   bridge    bridge    local
</span></span><span style="display:flex;"><span>e6e7d7a437b4   host      host      local
</span></span><span style="display:flex;"><span>5dfbe1989378   hub       bridge    local
</span></span><span style="display:flex;"><span>ecc68fac9a4b   none      null      local
</span></span></code></pre></div><p>then it will be a &ldquo;<em>user-created network</em>&rdquo;, and these have &ldquo;<em>automatic service discovery</em>&rdquo; - that very same DNS that we need. Now you can re-create your container in that new network (<em><code>--network hub</code></em>) or you can just move it from the default network (<em><code>172.17.x.x</code></em>) to this new one (<em><code>172.18.x.x</code></em>):</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ sudo docker network inspect bridge
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;Name&#34;</span>: <span style="color:#e6db74">&#34;bridge&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;Id&#34;</span>: <span style="color:#e6db74">&#34;f7dc4c461ccb9d518abcdec62207554d809bc973d874c21f55b1d92427223d0d&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;Created&#34;</span>: <span style="color:#e6db74">&#34;2024-07-22T21:16:52.221175914+02:00&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;Scope&#34;</span>: <span style="color:#e6db74">&#34;local&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;Driver&#34;</span>: <span style="color:#e6db74">&#34;bridge&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;EnableIPv6&#34;</span>: false,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;IPAM&#34;</span>: <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;Driver&#34;</span>: <span style="color:#e6db74">&#34;default&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;Options&#34;</span>: null,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;Config&#34;</span>: <span style="color:#f92672">[</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#e6db74">&#34;Subnet&#34;</span>: <span style="color:#e6db74">&#34;172.17.0.0/16&#34;</span>,
</span></span><span style="display:flex;"><span>                    <span style="color:#e6db74">&#34;Gateway&#34;</span>: <span style="color:#e6db74">&#34;172.17.0.1&#34;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;Internal&#34;</span>: false,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;Attachable&#34;</span>: false,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;Ingress&#34;</span>: false,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;ConfigFrom&#34;</span>: <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;Network&#34;</span>: <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;ConfigOnly&#34;</span>: false,
</span></span><span style="display:flex; background-color:#3c3d38"><span>        <span style="color:#e6db74">&#34;Containers&#34;</span>: <span style="color:#f92672">{</span>
</span></span><span style="display:flex; background-color:#3c3d38"><span>            <span style="color:#e6db74">&#34;7e9bc60ef0f894eec68eaf784b06c0d4605ee5dc52d5733c9f0394de67a3943c&#34;</span>: <span style="color:#f92672">{</span>
</span></span><span style="display:flex; background-color:#3c3d38"><span>                <span style="color:#e6db74">&#34;Name&#34;</span>: <span style="color:#e6db74">&#34;homeassistant&#34;</span>,
</span></span><span style="display:flex; background-color:#3c3d38"><span>                <span style="color:#e6db74">&#34;EndpointID&#34;</span>: <span style="color:#e6db74">&#34;922f23693b311435906df168af5c669c606b9c41e8bca061d01f44056573922f&#34;</span>,
</span></span><span style="display:flex; background-color:#3c3d38"><span>                <span style="color:#e6db74">&#34;MacAddress&#34;</span>: <span style="color:#e6db74">&#34;02:42:ac:11:00:02&#34;</span>,
</span></span><span style="display:flex; background-color:#3c3d38"><span>                <span style="color:#e6db74">&#34;IPv4Address&#34;</span>: <span style="color:#e6db74">&#34;172.17.0.2/16&#34;</span>,
</span></span><span style="display:flex; background-color:#3c3d38"><span>                <span style="color:#e6db74">&#34;IPv6Address&#34;</span>: <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex; background-color:#3c3d38"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex; background-color:#3c3d38"><span>        <span style="color:#f92672">}</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;Options&#34;</span>: <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;com.docker.network.bridge.default_bridge&#34;</span>: <span style="color:#e6db74">&#34;true&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;com.docker.network.bridge.enable_icc&#34;</span>: <span style="color:#e6db74">&#34;true&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;com.docker.network.bridge.enable_ip_masquerade&#34;</span>: <span style="color:#e6db74">&#34;true&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;com.docker.network.bridge.host_binding_ipv4&#34;</span>: <span style="color:#e6db74">&#34;0.0.0.0&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;com.docker.network.bridge.name&#34;</span>: <span style="color:#e6db74">&#34;docker0&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;com.docker.network.driver.mtu&#34;</span>: <span style="color:#e6db74">&#34;1500&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;Labels&#34;</span>: <span style="color:#f92672">{}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ sudo docker network inspect hub
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;Name&#34;</span>: <span style="color:#e6db74">&#34;hub&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;Id&#34;</span>: <span style="color:#e6db74">&#34;5dfbe1989378e089d5548ae21e4b48b055108b570be7ac717a0d9ad034b79817&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;Created&#34;</span>: <span style="color:#e6db74">&#34;2024-07-23T09:44:48.167021383+02:00&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;Scope&#34;</span>: <span style="color:#e6db74">&#34;local&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;Driver&#34;</span>: <span style="color:#e6db74">&#34;bridge&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;EnableIPv6&#34;</span>: false,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;IPAM&#34;</span>: <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;Driver&#34;</span>: <span style="color:#e6db74">&#34;default&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;Options&#34;</span>: <span style="color:#f92672">{}</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;Config&#34;</span>: <span style="color:#f92672">[</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#e6db74">&#34;Subnet&#34;</span>: <span style="color:#e6db74">&#34;172.18.0.0/16&#34;</span>,
</span></span><span style="display:flex;"><span>                    <span style="color:#e6db74">&#34;Gateway&#34;</span>: <span style="color:#e6db74">&#34;172.18.0.1&#34;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;Internal&#34;</span>: false,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;Attachable&#34;</span>: false,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;Ingress&#34;</span>: false,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;ConfigFrom&#34;</span>: <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;Network&#34;</span>: <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;ConfigOnly&#34;</span>: false,
</span></span><span style="display:flex; background-color:#3c3d38"><span>        <span style="color:#e6db74">&#34;Containers&#34;</span>: <span style="color:#f92672">{}</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;Options&#34;</span>: <span style="color:#f92672">{}</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;Labels&#34;</span>: <span style="color:#f92672">{}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ sudo docker network disconnect bridge homeassistant
</span></span><span style="display:flex;"><span>$ sudo docker network connect hub homeassistant
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ sudo docker network inspect bridge
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;Name&#34;</span>: <span style="color:#e6db74">&#34;bridge&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;...&#34;</span>: <span style="color:#e6db74">&#34;...&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;Containers&#34;</span>: <span style="color:#f92672">{}</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;...&#34;</span>: <span style="color:#f92672">{}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ sudo docker network inspect hub
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;Name&#34;</span>: <span style="color:#e6db74">&#34;hub&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;...&#34;</span>: <span style="color:#e6db74">&#34;...&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;Containers&#34;</span>: <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;7e9bc60ef0f894eec68eaf784b06c0d4605ee5dc52d5733c9f0394de67a3943c&#34;</span>: <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;Name&#34;</span>: <span style="color:#e6db74">&#34;homeassistant&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;EndpointID&#34;</span>: <span style="color:#e6db74">&#34;db73973bfdc5d9b8e1807252da52cbfd6fda9c17899918377f28d9a21d54dfb2&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;MacAddress&#34;</span>: <span style="color:#e6db74">&#34;02:42:ac:12:00:02&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;IPv4Address&#34;</span>: <span style="color:#e6db74">&#34;172.18.0.2/16&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;IPv6Address&#34;</span>: <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;...&#34;</span>: <span style="color:#f92672">{}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">]</span>
</span></span></code></pre></div><p>If you now create a new temporary container in the <code>hub</code> network, then you should be able to reach the <code>homeassistant</code> container from it by both IP and hostname:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cmd" data-lang="cmd"><span style="display:flex;"><span>$ sudo docker run -it --rm --network hub alpine /bin/ash
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>/ # ip route get 1 | awk &#39;{print $NF;exit}&#39;
</span></span><span style="display:flex;"><span>172.18.0.3
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>/ # apk --no-cache add curl
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>/ # curl -I http://172.18.0.2:8123 -v
</span></span><span style="display:flex;"><span>*   Trying 172.18.0.2:8123...
</span></span><span style="display:flex;"><span>* Connected to 172.18.0.2 (172.18.0.2) port 8123
</span></span><span style="display:flex;"><span>&gt; HEAD / HTTP/1.1
</span></span><span style="display:flex;"><span>&gt; Host: 172.18.0.2:8123
</span></span><span style="display:flex;"><span>&gt; User-Agent: curl/8.8.0
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>/ # curl -I http://homeassistant:8123 -v
</span></span><span style="display:flex;"><span>* Host homeassistant:8123 was resolved.
</span></span><span style="display:flex;"><span>* IPv6: (none)
</span></span><span style="display:flex;"><span>* IPv4: 172.18.0.2
</span></span><span style="display:flex;"><span>*   Trying 172.18.0.2:8123...
</span></span><span style="display:flex;"><span>* Connected to homeassistant (172.18.0.2) port 8123
</span></span><span style="display:flex;"><span>&gt; HEAD / HTTP/1.1
</span></span><span style="display:flex;"><span>&gt; Host: homeassistant:8123
</span></span><span style="display:flex;"><span>&gt; User-Agent: curl/8.8.0
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>/ # exit
</span></span></code></pre></div><p>While that works, it doesn&rsquo;t mean that you will also be able to reach that container by hostname from your host environment too, because you won&rsquo;t:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ curl -I http://homeassistant:8123 -v
</span></span><span style="display:flex;"><span>* Could not resolve host: homeassistant
</span></span><span style="display:flex;"><span>* Closing connection <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>curl: <span style="color:#f92672">(</span>6<span style="color:#f92672">)</span> Could not resolve host: homeassistant
</span></span></code></pre></div><p>as containers name resolution can work only within their networks.</p>
<h2 id="nginx">NGINX</h2>
<p>Alright, Home Assistant is running and other containers can reach it. But you as a user are not able to reach it yet, because its port <code>8123</code> isn&rsquo;t exposed from the host.</p>
<p>There are several ways of exposing a container port from the host, and I prefer the one with NGINX being a <a href="https://en.wikipedia.org/wiki/Reverse_proxy">reverse proxy</a>. So let&rsquo;s <a href="http://nginx.org/en/linux_packages.html#Debian">install NGINX</a>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ sudo apt install curl gnupg2 ca-certificates lsb-release debian-archive-keyring
</span></span><span style="display:flex;"><span>$ curl https://nginx.org/keys/nginx_signing.key | gpg --dearmor | sudo tee /usr/share/keyrings/nginx-archive-keyring.gpg &gt;/dev/null
</span></span><span style="display:flex;"><span>$ gpg --dry-run --quiet --no-keyring --import --import-options import-show /usr/share/keyrings/nginx-archive-keyring.gpg
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ echo <span style="color:#e6db74">&#34;deb [signed-by=/usr/share/keyrings/nginx-archive-keyring.gpg] http://nginx.org/packages/debian `lsb_release -cs` nginx&#34;</span> | sudo tee /etc/apt/sources.list.d/nginx.list
</span></span><span style="display:flex;"><span>$ echo -e <span style="color:#e6db74">&#34;Package: *\nPin: origin nginx.org\nPin: release o=nginx\nPin-Priority: 900\n&#34;</span> | sudo tee /etc/apt/preferences.d/99nginx
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ sudo apt update
</span></span><span style="display:flex;"><span>$ sudo apt install nginx
</span></span><span style="display:flex;"><span>$ sudo systemctl status nginx.service
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ sudo chown -R www-data:www-data /var/www
</span></span></code></pre></div><p>The site config for Home Assistant would be the following:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ sudo nano /etc/nginx/sites-available/homeassistant
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nginx" data-lang="nginx"><span style="display:flex;"><span><span style="color:#75715e"># this is supposed to be used for WebSocket connections,
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"># although it might require a separate `location` block
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">map</span> $http_upgrade $connection_upgrade {
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">default</span> <span style="color:#e6db74">upgrade</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#39;&#39;</span> <span style="color:#e6db74">close</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">server</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># doesn&#39;t have to be exactly `8123`, you can set it to the &#34;usual&#34; `80`
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#f92672">listen</span> <span style="color:#ae81ff">8123</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">location</span> <span style="color:#e6db74">/</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># `172.18.0.2` is the IP address of the Home Assistant container
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#f92672">proxy_pass</span> <span style="color:#e6db74">http://172.18.0.2:8123</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">proxy_http_version</span> <span style="color:#ae81ff">1</span><span style="color:#e6db74">.1</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">proxy_set_header</span> <span style="color:#e6db74">Upgrade</span> $http_upgrade;
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">proxy_set_header</span> <span style="color:#e6db74">Connection</span> $connection_upgrade;
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">proxy_set_header</span> <span style="color:#e6db74">Host</span> $host;
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">proxy_cache_bypass</span> $http_upgrade;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ sudo ln -s /etc/nginx/sites-<span style="color:#f92672">{</span>available,enabled<span style="color:#f92672">}</span>/homeassistant
</span></span><span style="display:flex;"><span>$ sudo systemctl restart nginx.service
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ ip route get <span style="color:#ae81ff">1</span> | sed -n <span style="color:#e6db74">&#39;s/^.*src \([0-9.]*\) .*$/\1/p&#39;</span>
</span></span><span style="display:flex;"><span>192.168.1.35
</span></span></code></pre></div><p>Now you should be able to open <a href="http://192.168.1.35:8123/">http://192.168.1.35:8123/</a> (<em>or whichever IP address you have for your device/server</em>) from a web-browser on your computer/tablet/phone (<em>as long as they are in the same network</em>). Obviously, this IP address needs to be statically assigned to the device/server (<em>Vero V in my case</em>) in your home network DHCP server (<em>a router, usually</em>).</p>
<h3 id="what-if-container-ip-address-will-change">What if container IP address will change</h3>
<p>But what to do if container IP will change on the next restart/reboot? Since the container&rsquo;s hostname isn&rsquo;t resolving in the host environment (<em>as we know, it resolves only within a user-defined Docker network</em>), we&rsquo;ll have to rely in the &ldquo;bare&rdquo; IP address. But we at least can make it &ldquo;static&rdquo;, so container doesn&rsquo;t get a different address on the next restart/reboot:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ sudo docker network disconnect hub homeassistant
</span></span><span style="display:flex;"><span>$ sudo docker network connect --ip 172.18.0.100 hub homeassistant
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ sudo docker inspect -f <span style="color:#e6db74">&#39;{{range.NetworkSettings.Networks}}{{.IPAddress}}{{end}}&#39;</span> homeassistant
</span></span><span style="display:flex;"><span>172.18.0.100
</span></span></code></pre></div><p>Here it is assumed that you have already <a href="#ip-address-of-the-running-container">moved</a> the container from the default <code>bridge</code> network to the new user-defined <code>hub</code> network.</p>
<p>Don&rsquo;t forget to edit NGINX config and change the IP address from <code>172.18.0.2</code> to <code>172.18.0.100</code>.</p>
<h3 id="https">HTTPS</h3>
<p>I don&rsquo;t plan to expose my Home Assistant instance to the internet, at least not without a VPN, so I intend to use it from the local home network only, but even there it is still worth to encrypt the traffic, so credentials aren&rsquo;t sent in plain text.</p>
<p>A self-signed certificate should be enough for this purpose:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ sudo mkdir /opt/certificates
</span></span><span style="display:flex;"><span>$ mkdir /tmp/crts <span style="color:#f92672">&amp;&amp;</span> cd $_
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ openssl req -x509 -newkey rsa:2048 -nodes -sha256 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    -subj <span style="color:#e6db74">&#39;/CN=Home Assistant&#39;</span> -extensions EXT -config &lt;<span style="color:#f92672">(</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    printf <span style="color:#e6db74">&#34;[dn]\nCN=Home Assistant\n[req]\ndistinguished_name=dn\n[EXT]\nsubjectAltName=IP:192.168.1.35,DNS:vero.local\nkeyUsage=digitalSignature\nextendedKeyUsage=serverAuth&#34;</span><span style="color:#f92672">)</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    -days <span style="color:#ae81ff">1111</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    -out fullchain.pem -keyout key.pem
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ ls -l
</span></span><span style="display:flex;"><span>-rw-r--r-- <span style="color:#ae81ff">1</span> osmc osmc <span style="color:#ae81ff">1115</span> Jul <span style="color:#ae81ff">30</span> 11:11 fullchain.pem
</span></span><span style="display:flex;"><span>-rw------- <span style="color:#ae81ff">1</span> osmc osmc <span style="color:#ae81ff">1704</span> Jul <span style="color:#ae81ff">30</span> 11:11 key.pem
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ sudo mv ./*.pem /opt/certificates/
</span></span><span style="display:flex;"><span>$ sudo chown -R www-data:www-data /opt/certificates
</span></span></code></pre></div><p>Again, the <code>192.168.1.35</code> is the (<em>static</em>) IP address of your hub/device, which in my case is Vero V. The <code>subjectAltName=IP:192.168.1.35,DNS:homeassistant.local</code> might be just the IP, if you don&rsquo;t have a DNS record for it in your home network. I actually don&rsquo;t have it, and as a matter of fact, you can probably just drop the entire line altogether, so the command becomes:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ openssl req -x509 -newkey rsa:2048 -nodes -sha256 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    -subj <span style="color:#e6db74">&#39;/CN=Home Assistant&#39;</span> -extensions EXT -config &lt;<span style="color:#f92672">(</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    printf <span style="color:#e6db74">&#34;[dn]\nCN=Home Assistant\n[req]\ndistinguished_name=dn\n[EXT]\nkeyUsage=digitalSignature\nextendedKeyUsage=serverAuth&#34;</span><span style="color:#f92672">)</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    -days <span style="color:#ae81ff">1111</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    -out fullchain.pem -keyout key.pem
</span></span></code></pre></div><p>Then to enable HTTPS in NGINX site config:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ sudo nano /etc/nginx/sites-available/homeassistant
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nginx" data-lang="nginx"><span style="display:flex;"><span><span style="color:#66d9ef">server</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">listen</span> <span style="color:#ae81ff">8123</span> <span style="color:#e6db74">ssl</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">ssl_certificate</span> <span style="color:#e6db74">/opt/certificates/fullchain.pem</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">ssl_certificate_key</span> <span style="color:#e6db74">/opt/certificates/key.pem</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># ...
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>}
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ sudo systemctl restart nginx.service
</span></span></code></pre></div><p>Check the certificate expiration date from some other machine:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ echo | openssl s_client -connect 192.168.1.35:8123 2&gt;&amp;<span style="color:#ae81ff">1</span> | openssl x509 -noout -dates
</span></span><span style="display:flex;"><span>notBefore<span style="color:#f92672">=</span>Jul <span style="color:#ae81ff">30</span> 09:40:32 <span style="color:#ae81ff">2024</span> GMT
</span></span><span style="display:flex;"><span>notAfter<span style="color:#f92672">=</span>Aug <span style="color:#ae81ff">15</span> 09:40:32 <span style="color:#ae81ff">2027</span> GMT
</span></span></code></pre></div><p>Open <a href="https://YOUR-VERO-IP:8123/">https://YOUR-VERO-IP:8123/</a> (<em>note that it&rsquo;s <code>https://</code> now, as <code>http://</code> won&rsquo;t work anymore</em>). Since it&rsquo;s a self-signed certificate, web-browsers will give you warnings, and mobile applications will do so too:</p>
<div class="vertical-image-centered-scaled">


    <img class="image-post" loading="lazy" src="/blog/2024/08/16/home-assistant-on-vero-with-docker/images/application-untrusted-certificate.png" alt="Home Assistant application, untrusted certificate">

</div>
<p>Here it also says that the validity period is too long. But who cares, it is you who issued the certificate, and you certainly trust yourself, don&rsquo;t you. For the purpose of encrypting your local network connections that should be totally fine. One can even say that this whole ordeal with HTTPS in a local home network might be redundant.</p>
<p>If/when at some point later you will re-issue the certificate, for example to renew it, then Home Assistant UI might fail load in browser:</p>
<div class="vertical-image-centered-scaled">


    <img class="image-post" loading="lazy" src="/blog/2024/08/16/home-assistant-on-vero-with-docker/images/not-loading-because-certificate-invalid-browser.png" alt="Home Assistant not loading in browser because certificate is invalid">

</div>
<p>printing this useless error message to the console:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span><span style="color:#a6e22e">Firefox</span> can&#39;t establish a connection to the server at wss<span style="color:#66d9ef">:</span><span style="color:#75715e">//192.168.1.35:8123/api/websocket. core.7weG3TqZ_G4.js:1:65105
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">Uncaught</span> <span style="color:#f92672">(</span>in promise<span style="color:#f92672">)</span> <span style="color:#ae81ff">1</span> 
</span></span></code></pre></div><p>Mobile applications will fail to connect to, but you&rsquo;ll get a more informative error message there:</p>
<div class="vertical-image-centered-scaled">


    <img class="image-post" loading="lazy" src="/blog/2024/08/16/home-assistant-on-vero-with-docker/images/not-loading-because-certificate-invalid-application.png" alt="Home Assistant application not loading because certificate is invalid">

</div>
<p>which simply means that you need to refresh the page with clearing cache, so clients would get the new certificate.</p>
<h1 id="zigbee">Zigbee</h1>
<p>To communicate with Zigbee devices you need to have a Zigbee radio adapter/module with a <a href="https://zigbee2mqtt.io/advanced/zigbee/01_zigbee_network.html#coordinator">coordinator</a> firmware. Many adapters are supposed to be connected via USB, so they are plugged into the hub/server where Home Assistant is running, and preferably not into USB 3.0 port (<em>fortunately, Vero V has both USB 3.0 and USB 2.0 ports</em>) because of the interference. Some adapters (<em>here&rsquo;s <a href="https://tubeszb.com">one example</a></em>) connect via RJ45 port, which might be a better option.</p>
<p>There are <a href="https://home-assistant.io/integrations/zha/#recommended-zigbee-radio-adapters-and-modules">several</a> such adaptors/modules available, and I chose <a href="https://sonoff.tech/product/gateway-and-sensors/sonoff-zigbee-3-0-usb-dongle-plus-e/">SONOFF Zigbee 3.0 USB Dongle Plus-E</a>. I didn&rsquo;t know how to compare them, I just took the one that is mentioned the most.</p>
<p>You will also need an appropriate software, which will use this adaptor to communicate with your Zigbee devices and organize the network. The most popular options seem to be these two:</p>
<ul>
<li><a href="https://home-assistant.io/integrations/zha/">Zigbee Home Automation</a> (ZHA) - probably the easiest one to configure and use. It is also an officially supported one;</li>
<li><a href="https://zigbee2mqtt.io">Zigbee2MQTT</a> - an &ldquo;unofficial&rdquo; integration, which is not that easy to set-up, especially when Home Assistant is installed in a Docker container, because you&rsquo;ll need to run some more Docker containers with various required components and make them all talk to each other. On the bright side though, it has a wider range of supported devices/sensors.</li>
</ul>
<p>ZHA looks like the way to go, but where is the fun in that, if it just works out of the box, so of course I went the Zigbee2MQTT way.</p>
<h2 id="eclipse-mosquitto">Eclipse Mosquitto</h2>
<p>Zigbee coordinator manages Zigbee traffic from/to devices, but it also needs to be able to talk to Home Assistant and the other way around. For that type of communication it uses <a href="https://en.wikipedia.org/wiki/MQTT">MQTT</a> protocol, so we will need an MQTT broker.</p>
<p>One such broker is <a href="https://mosquitto.org">Eclipse Mosquitto</a>. It can be installed as a Docker container too, and the image is <a href="https://hub.docker.com/_/eclipse-mosquitto/">here</a>. Setting up a container:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ sudo docker run -d <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    --name mosquitto <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    --restart<span style="color:#f92672">=</span>unless-stopped <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    -v /root/mosquitto/config:/mosquitto/config <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    -v /root/mosquitto/data:/mosquitto/data <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    -v /root/mosquitto/log:/mosquitto/log <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    eclipse-mosquitto
</span></span></code></pre></div><p>Again, the <code>-v</code> arguments here tell the container which host paths will be mapped to which container paths, so when Mosquitto binary inside container will need to read its &ldquo;local&rdquo; <code>/mosquitto/config/mosquitto.conf</code> file, it will actually read the <code>/root/mosquitto/config/mosquitto.conf</code> file in the host filesystem.</p>
<p>Speaking about the config, it needs to be <a href="https://mosquitto.org/man/mosquitto-conf-5.html">created</a>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ sudo nano /root/mosquitto/config/mosquitto.conf
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ini" data-lang="ini"><span style="display:flex;"><span><span style="color:#a6e22e">persistence true</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">persistence_location /mosquitto/data</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">log_dest file /mosquitto/log/mosquitto.log</span>
</span></span></code></pre></div><p>Now start the container (<em>not sure why it hasn&rsquo;t started on <code>docker run</code>, but probably because of the missing config</em>):</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ sudo docker ps
</span></span><span style="display:flex;"><span>CONTAINER ID   IMAGE                                          COMMAND   CREATED        STATUS       PORTS     NAMES
</span></span><span style="display:flex;"><span>7e9bc60ef0f8   ghcr.io/home-assistant/home-assistant:stable   <span style="color:#e6db74">&#34;/init&#34;</span>   <span style="color:#ae81ff">19</span> hours ago   Up <span style="color:#ae81ff">4</span> hours             homeassistant
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ sudo docker start mosquitto
</span></span><span style="display:flex;"><span>mosquitto
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ sudo docker ps
</span></span><span style="display:flex;"><span>CONTAINER ID   IMAGE                                          COMMAND                  CREATED         STATUS         PORTS      NAMES
</span></span><span style="display:flex;"><span>5c0503542640   eclipse-mosquitto                              <span style="color:#e6db74">&#34;/docker-entrypoint.…&#34;</span>   <span style="color:#ae81ff">4</span> minutes ago   Up <span style="color:#ae81ff">5</span> seconds   1883/tcp   mosquitto
</span></span><span style="display:flex;"><span>7e9bc60ef0f8   ghcr.io/home-assistant/home-assistant:stable   <span style="color:#e6db74">&#34;/init&#34;</span>                  <span style="color:#ae81ff">19</span> hours ago    Up <span style="color:#ae81ff">4</span> hours                homeassistant
</span></span><span style="display:flex;"><span>osmc@vero:~$ mc
</span></span></code></pre></div><p>Move it to the same network where <code>homeassistant</code> container is:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ sudo docker inspect -f <span style="color:#e6db74">&#39;{{range.NetworkSettings.Networks}}{{.IPAddress}}{{end}}&#39;</span> mosquitto
</span></span><span style="display:flex;"><span>172.17.0.2
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ sudo docker network inspect hub
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;Name&#34;</span>: <span style="color:#e6db74">&#34;hub&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;...&#34;</span>: <span style="color:#e6db74">&#34;...&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;Containers&#34;</span>: <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;7e9bc60ef0f894eec68eaf784b06c0d4605ee5dc52d5733c9f0394de67a3943c&#34;</span>: <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;Name&#34;</span>: <span style="color:#e6db74">&#34;homeassistant&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;EndpointID&#34;</span>: <span style="color:#e6db74">&#34;5a8ddd308055e189ec9a4a37705b150b00aea88e042c2e4d085ec585c35779c8&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;MacAddress&#34;</span>: <span style="color:#e6db74">&#34;02:42:ac:12:00:64&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;IPv4Address&#34;</span>: <span style="color:#e6db74">&#34;172.18.0.100/16&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;IPv6Address&#34;</span>: <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;...&#34;</span>: <span style="color:#f92672">{}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ sudo docker network disconnect bridge mosquitto
</span></span><span style="display:flex;"><span>$ sudo docker network connect hub mosquitto
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ sudo docker network inspect hub
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;Name&#34;</span>: <span style="color:#e6db74">&#34;hub&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;...&#34;</span>: <span style="color:#e6db74">&#34;...&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;Containers&#34;</span>: <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;5c0503542640bfc3f8413deb6e1b5c785476783ddbaa385aad4993be28315484&#34;</span>: <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;Name&#34;</span>: <span style="color:#e6db74">&#34;mosquitto&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;EndpointID&#34;</span>: <span style="color:#e6db74">&#34;267141eaccc22d8c3f5e97f38069ca83187f8747b9022079eb03eb7140178df4&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;MacAddress&#34;</span>: <span style="color:#e6db74">&#34;02:42:ac:12:00:02&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;IPv4Address&#34;</span>: <span style="color:#e6db74">&#34;172.18.0.2/16&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;IPv6Address&#34;</span>: <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;7e9bc60ef0f894eec68eaf784b06c0d4605ee5dc52d5733c9f0394de67a3943c&#34;</span>: <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;Name&#34;</span>: <span style="color:#e6db74">&#34;homeassistant&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;EndpointID&#34;</span>: <span style="color:#e6db74">&#34;5a8ddd308055e189ec9a4a37705b150b00aea88e042c2e4d085ec585c35779c8&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;MacAddress&#34;</span>: <span style="color:#e6db74">&#34;02:42:ac:12:00:64&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;IPv4Address&#34;</span>: <span style="color:#e6db74">&#34;172.18.0.100/16&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;IPv6Address&#34;</span>: <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;...&#34;</span>: <span style="color:#f92672">{}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ sudo docker inspect -f <span style="color:#e6db74">&#39;{{range.NetworkSettings.Networks}}{{.IPAddress}}{{end}}&#39;</span> mosquitto
</span></span><span style="display:flex;"><span>172.18.0.2
</span></span></code></pre></div><p>&hellip;Or you could&rsquo;ve just provided <code>--network hub</code> to <code>docker run</code> on setting up the container.</p>
<p>There is no need to assign a static IP address to it, because <code>homeassistant</code> container will be addressing it by <a href="#ip-address-of-the-running-container">hostname</a>. And actually, let&rsquo;s check that it is in fact reachable that way:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ sudo docker exec -it homeassistant bash
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>7e9bc60ef0f8:/config# ping -c <span style="color:#ae81ff">2</span> 172.18.0.2
</span></span><span style="display:flex;"><span>PING 172.18.0.2 <span style="color:#f92672">(</span>172.18.0.2<span style="color:#f92672">)</span>: <span style="color:#ae81ff">56</span> data bytes
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">64</span> bytes from 172.18.0.2: seq<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span> ttl<span style="color:#f92672">=</span><span style="color:#ae81ff">64</span> time<span style="color:#f92672">=</span>0.349 ms
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">64</span> bytes from 172.18.0.2: seq<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span> ttl<span style="color:#f92672">=</span><span style="color:#ae81ff">64</span> time<span style="color:#f92672">=</span>0.327 ms
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>7e9bc60ef0f8:/config# ping -c <span style="color:#ae81ff">2</span> mosquitto
</span></span><span style="display:flex;"><span>PING mosquitto <span style="color:#f92672">(</span>172.18.0.2<span style="color:#f92672">)</span>: <span style="color:#ae81ff">56</span> data bytes
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">64</span> bytes from 172.18.0.2: seq<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span> ttl<span style="color:#f92672">=</span><span style="color:#ae81ff">64</span> time<span style="color:#f92672">=</span>0.293 ms
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">64</span> bytes from 172.18.0.2: seq<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span> ttl<span style="color:#f92672">=</span><span style="color:#ae81ff">64</span> time<span style="color:#f92672">=</span>0.297 ms
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>7e9bc60ef0f8:/config# nc mosquitto <span style="color:#ae81ff">1883</span> &lt; /dev/null
</span></span><span style="display:flex;"><span>7e9bc60ef0f8:/config# echo $?
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>7e9bc60ef0f8:/config# exit
</span></span></code></pre></div><p>So it is reachable, however the port <code>1883</code> (<em>default MQTT port</em>) isn&rsquo;t open (<em>as <a href="https://en.wikipedia.org/wiki/Netcat">netcat</a> returns non-zero exit code</em>). At first I didn&rsquo;t understand, why is that, because that port is listed here:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ sudo docker container ls --format <span style="color:#e6db74">&#34;table {{.ID}}\t{{.Names}}\t{{.Ports}}&#34;</span> -a
</span></span><span style="display:flex;"><span>CONTAINER ID   NAMES           PORTS
</span></span><span style="display:flex;"><span>8941202da971   mosquitto       1883/tcp
</span></span><span style="display:flex;"><span>7e9bc60ef0f8   homeassistant
</span></span></code></pre></div><p>At the same time, checking for <code>8123</code> port on <code>homeassistant</code> from <code>mosquitto</code> container succeeds, even though this port is not listed in the table above:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cmd" data-lang="cmd"><span style="display:flex;"><span>$ sudo docker exec -it mosquitto sh
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>/ # nc homeassistant 8123 &lt; /dev/null
</span></span><span style="display:flex;"><span>/ # echo $?
</span></span><span style="display:flex;"><span>0
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>/ # exit
</span></span></code></pre></div><p>I&rsquo;m guessing that the ports listed in the table above are just what is specified in the Docker image, which doesn&rsquo;t necessarily mean that they will be actually open.</p>
<p>Anyway, by default Mosquitto doesn&rsquo;t seem to be listening on any ports, so you need to explicitly set them in the config:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ sudo nano /root/mosquitto/config/mosquitto.conf
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid;"><code class="language-ini" data-lang="ini"><span style="display:flex;"><span><span style="color:#a6e22e">persistence true</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">persistence_location /mosquitto/data</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">log_dest file /mosquitto/log/mosquitto.log</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex; background-color:#3c3d38"><span><span style="color:#a6e22e">listener 1883 0.0.0.0</span>
</span></span><span style="display:flex; background-color:#3c3d38"><span>
</span></span><span style="display:flex; background-color:#3c3d38"><span><span style="color:#a6e22e">listener 9001 0.0.0.0</span>
</span></span><span style="display:flex; background-color:#3c3d38"><span><span style="color:#a6e22e">protocol websockets</span>
</span></span></code></pre></div><p>and restart the Mosquitto container:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ sudo docker restart mosquitto
</span></span></code></pre></div><p>Check the ports again:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cmd" data-lang="cmd"><span style="display:flex;"><span>$ sudo docker exec -it homeassistant sh
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>/config # nc mosquitto 1883 &lt; /dev/null
</span></span><span style="display:flex;"><span>/config # echo $?
</span></span><span style="display:flex;"><span>0
</span></span><span style="display:flex;"><span>/config # nc mosquitto 9001 &lt; /dev/null
</span></span><span style="display:flex;"><span>/config # echo $?
</span></span><span style="display:flex;"><span>0
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>/config # exit
</span></span></code></pre></div><p>Now netcat returns zero for both <code>1883</code> and <code>9001</code>, so the ports are open.</p>
<p>If you had a question about why the <code>listener</code> is set to <code>0.0.0.0</code> in the config, as you probably thought that this will make the ports exposed from the host, then worry not, you just got confused like I did, and <code>0.0.0.0</code> here is this particular container within the <code>hub</code> network, so it is not the ports of the actual host. You can check for yourself what will happen if you set the <code>listener</code> to <code>127.0.0.1</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ sudo nano /root/mosquitto/config/mosquitto.conf
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ini" data-lang="ini"><span style="display:flex;"><span><span style="color:#75715e"># ...</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">listener 9001 127.0.0.1</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">protocol websockets</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cmd" data-lang="cmd"><span style="display:flex;"><span>$ sudo docker restart mosquitto
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ sudo docker exec -it homeassistant sh
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>/config # nc mosquitto 9001 &lt; /dev/null
</span></span><span style="display:flex;"><span>/config # echo $?
</span></span><span style="display:flex;"><span>1
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>/config # exit
</span></span></code></pre></div><p>As you can see, binding <code>listener</code> to <code>127.0.0.1</code> made that port <code>9001</code> to be open only on localhost of the container itself, so now that port is not available for other containers and it isn&rsquo;t available for the host either (<em>let alone being exposed from the host</em>). And when <code>listener</code> is bound to <code>0.0.0.0</code>, then this port becomes available for other containers (<em>in that Docker network</em>) and for the host too, but it still isn&rsquo;t exposed <em>from</em> the host (<em>which you can verify by running <code>ss -lntup</code></em>). Perfectly splendid, isn&rsquo;t it. By the way, don&rsquo;t forget to revert that <code>listener</code> back to <code>0.0.0.0</code>.</p>
<p>Finally, Mosquitto instance should have authentication:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cmd" data-lang="cmd"><span style="display:flex;"><span>$ sudo docker exec -it mosquitto sh
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>/ # mosquitto_passwd -c /mosquitto/config/pswds SOME-USERNAME
</span></span><span style="display:flex;"><span>Password:
</span></span><span style="display:flex;"><span>Reenter password:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>/ # exit
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ sudo nano /root/mosquitto/config/mosquitto.conf
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid;"><code class="language-ini" data-lang="ini"><span style="display:flex;"><span><span style="color:#75715e"># ...</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">listener 9001 0.0.0.0</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">protocol websockets</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex; background-color:#3c3d38"><span><span style="color:#a6e22e">allow_anonymous false</span>
</span></span><span style="display:flex; background-color:#3c3d38"><span><span style="color:#a6e22e">password_file /mosquitto/config/pswds</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ sudo docker restart mosquitto
</span></span></code></pre></div><p>Now it is ready to be added to Home Assistant. Open <strong>Settings</strong> → <strong>Devices &amp; Services</strong> → <strong>Integrations</strong> and click on <strong>Add Integration</strong>. Search for <code>mqtt</code>:</p>
<div class="vertical-image-centered-scaled">


    <img class="image-post" loading="lazy" src="/blog/2024/08/16/home-assistant-on-vero-with-docker/images/mqtt-integration.png" alt="Home Assistant, searching for MQTT integration" style="border:1px solid black;">

</div>
<p>select <code>MQTT</code>:</p>
<div class="vertical-image-centered-scaled">


    <img class="image-post" loading="lazy" src="/blog/2024/08/16/home-assistant-on-vero-with-docker/images/mqtt-integration-list.png" alt="Home Assistant, searching for MQTT integration">

</div>
<p>and configure it:</p>
<div class="vertical-image-centered-scaled">


    <img class="image-post" loading="lazy" src="/blog/2024/08/16/home-assistant-on-vero-with-docker/images/mqtt-configuration.png" alt="Home Assistant, MQTT configuration" style="border:1px solid black;">

</div>
<p>As you can see, since containers are reachable by their hostnames in our network, instead of specifying the <code>mosquitto</code>&rsquo;s container IP address we can just use its hostname.</p>
<p>On successful configuration the Mosquitto logs (<em><code>/root/mosquitto/log/mosquitto.log</code></em>) should get something like:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>1721766257: New connection from 172.18.0.100:33859 on port 1883.
</span></span><span style="display:flex;"><span>1721766257: New client connected from 172.18.0.100:33859 as SOME-ID-HERE <span style="color:#f92672">(</span>p2, c1, k60, u<span style="color:#e6db74">&#39;SOME-USERNAME&#39;</span><span style="color:#f92672">)</span>.
</span></span><span style="display:flex;"><span>1721766347: Saving in-memory database to /mosquitto/data/mosquitto.db
</span></span></code></pre></div><p>To <a href="https://home-assistant.io/integrations/mqtt/#testing-your-setup">test</a> that it actually works, go to MQTT settings in your Home Assistant and subscribe to everything by setting a special <code>#</code> topic. Then open <code>mosquitto</code> container shell and publish a message with <a href="https://mosquitto.org/man/mosquitto_pub-1.html">mosquitto_pub</a>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cmd" data-lang="cmd"><span style="display:flex;"><span>$ sudo docker exec -it mosquitto sh
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>/ # mosquitto_pub -h 127.0.0.1 -t homeassistant/switch/1/on -m <span style="color:#e6db74">&#34;Switch is ON&#34;</span>
</span></span><span style="display:flex;"><span>Connection error: Connection Refused: not authorised.
</span></span><span style="display:flex;"><span>Error: The connection was refused.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>/ # mosquitto_pub -h 127.0.0.1 -t homeassistant/switch/1/on -m <span style="color:#e6db74">&#34;Switch is ON&#34;</span> -u SOME-USERNAME -P SOME-PASSWORD
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>/ # exit
</span></span></code></pre></div><p>You should then see that message in the Home Assistant interface:</p>


    <img class="image-post" loading="lazy" src="/blog/2024/08/16/home-assistant-on-vero-with-docker/images/mqtt-testing.png" alt="Home Assistant, testing MQTT">

<h2 id="zigbee2mqtt">Zigbee2MQTT</h2>
<p>Now when <a href="#eclipse-mosquitto">MQTT broker</a> is running, it&rsquo;s time to launch Zigbee2MQTT. Create a config:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ sudo mkdir -p /root/zigbee2mqtt/<span style="color:#f92672">{</span>data,logs<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>$ sudo nano /root/zigbee2mqtt/data/configuration.yaml
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#75715e"># Home Assistant integration (MQTT discovery)</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">homeassistant</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># https://zigbee2mqtt.io/guide/configuration/frontend.html</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">frontend</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">port</span>: <span style="color:#ae81ff">8080</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># the frontend webpage opens without authentication, but it will be &#34;empty&#34; until you enter</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># this authentication token in the browser prompt</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">auth_token</span>: <span style="color:#ae81ff">YOUR-AUTH-TOKEN</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># allow new devices to join (don&#39;t forget to set to `false` after you add all your devices)</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">permit_join</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">mqtt</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># MQTT base topic for zigbee2mqtt MQTT messages</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">base_topic</span>: <span style="color:#ae81ff">zigbee2mqtt</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># MQTT server URL (can use the hostname here too)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">server</span>: <span style="color:#e6db74">&#39;mqtt://mosquitto&#39;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># MQTT server authentication</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">user</span>: <span style="color:#ae81ff">SOME-USERNAME</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">password</span>: <span style="color:#ae81ff">SOME-PASSWORD</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">serial</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># where Zigbee adapter is connected to</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">port</span>: <span style="color:#ae81ff">/dev/ttyACM0</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">advanced</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># that way it will generate a random key on the first launch and will put it here</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">network_key</span>: <span style="color:#ae81ff">GENERATE</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># debug / info / warning / error</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">log_level</span>: <span style="color:#ae81ff">info</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># log levels for certain namespaces to reduce the traffic</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">log_namespaced_levels</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">z2m:mqtt</span>: <span style="color:#ae81ff">warning</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">log_directory</span>: <span style="color:#ae81ff">/app/logs</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">log_file</span>: <span style="color:#ae81ff">zigbee2mqtt.log</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># rotate log every 10 MB around 3 files</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">log_rotation</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">log_output</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">console</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">file</span>
</span></span></code></pre></div><p>Configure and run a Docker container:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ sudo docker run -d <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    --name zigbee2mqtt <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    --network hub <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    --restart<span style="color:#f92672">=</span>unless-stopped <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    --device<span style="color:#f92672">=</span>/dev/serial/by-id/YOUR-ZIGBEE-ADAPTER:/dev/ttyACM0 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    -v /root/zigbee2mqtt/data:/app/data <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    -v /root/zigbee2mqtt/logs:/app/logs <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    -e TZ<span style="color:#f92672">=</span>Europe/Amsterdam <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    koenkk/zigbee2mqtt
</span></span></code></pre></div><p>If you specified incorrect <code>--device</code> path, or if the device (<em>Zigbee adapter/coordinator</em>) is not connected, then you&rsquo;ll see errors like these in the log:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ sudo docker container logs zigbee2mqtt
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>info:     z2m: Starting Zigbee2MQTT version 1.39.0 <span style="color:#f92672">(</span>commit <span style="color:#75715e">#0326926)</span>
</span></span><span style="display:flex;"><span>info:     z2m: Starting zigbee-herdsman <span style="color:#f92672">(</span>0.50.1<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>error:    zh:zstack:znp: Failed to determine <span style="color:#66d9ef">if</span> path is valid: <span style="color:#e6db74">&#39;Error: ENOENT: no such file or directory, lstat &#39;</span>/dev/ttyACM0<span style="color:#e6db74">&#39;&#39;</span>
</span></span><span style="display:flex;"><span>info:     zh:zstack:znp: Opening SerialPort with <span style="color:#f92672">{</span><span style="color:#e6db74">&#34;path&#34;</span>:<span style="color:#e6db74">&#34;/dev/ttyACM0&#34;</span>,<span style="color:#e6db74">&#34;baudRate&#34;</span>:115200,<span style="color:#e6db74">&#34;rtscts&#34;</span>:false,<span style="color:#e6db74">&#34;autoOpen&#34;</span>:false<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>error:    z2m: Error <span style="color:#66d9ef">while</span> starting zigbee-herdsman
</span></span><span style="display:flex;"><span>error:    z2m: Failed to start zigbee
</span></span><span style="display:flex;"><span>error:    z2m: Check https://www.zigbee2mqtt.io/guide/installation/20_zigbee2mqtt-fails-to-start.html <span style="color:#66d9ef">for</span> possible solutions
</span></span><span style="display:flex;"><span>error:    z2m: Exiting...
</span></span><span style="display:flex;"><span>error:    z2m: Error: Error: No such file or directory, cannot open /dev/ttyACM0
</span></span></code></pre></div><p>If you are sure that you specified everything correctly and your device is connected, then check that you have <code>/dev/serial/</code> at all:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ ls -lah /dev/serial
</span></span></code></pre></div><p>If you don&rsquo;t, then you <a href="https://reddit.com/r/debian/comments/1331wlr/devserialbyid_suddenly_missing/ji8ah9b/">might</a> need to edit <code>/usr/lib/udev/rules.d/60-serial.rules</code> and apply <a href="https://github.com/systemd/systemd/pull/25246/files">this fix</a>.</p>
<p>For me that wasn&rsquo;t the case - I just haven&rsquo;t connected the adaptor yet. After I did, here&rsquo;s what <code>dmesg</code> printed out:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ sudo dmesg -w
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>usb 1-2: new full-speed USB device number <span style="color:#ae81ff">5</span> using xhci-hcd
</span></span><span style="display:flex;"><span>usb 1-2: New USB device found, idVendor<span style="color:#f92672">=</span>1a86, idProduct<span style="color:#f92672">=</span>55d4
</span></span><span style="display:flex;"><span>usb 1-2: New USB device strings: Mfr<span style="color:#f92672">=</span>1, Product<span style="color:#f92672">=</span>2, SerialNumber<span style="color:#f92672">=</span><span style="color:#ae81ff">3</span>
</span></span><span style="display:flex;"><span>usb 1-2: Product: SONOFF Zigbee 3.0 USB Dongle Plus V2
</span></span><span style="display:flex;"><span>usb 1-2: Manufacturer: ITEAD
</span></span><span style="display:flex;"><span>usb 1-2: SerialNumber: SERIAL-NUMBER-HERE
</span></span><span style="display:flex;"><span>cdc_acm 1-2:1.0: ttyACM0: USB ACM device
</span></span></code></pre></div><p>and I got it in <code>/dev/serial/</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ ls -lah /dev/serial/by-id/
</span></span><span style="display:flex;"><span>drwxr-xr-x <span style="color:#ae81ff">2</span> root root <span style="color:#ae81ff">60</span> Aug  <span style="color:#ae81ff">5</span> 10:17 .
</span></span><span style="display:flex;"><span>drwxr-xr-x <span style="color:#ae81ff">4</span> root root <span style="color:#ae81ff">80</span> Aug  <span style="color:#ae81ff">5</span> 10:17 ..
</span></span><span style="display:flex;"><span>lrwxrwxrwx <span style="color:#ae81ff">1</span> root root <span style="color:#ae81ff">13</span> Aug  <span style="color:#ae81ff">5</span> 10:17 usb-ITEAD_SONOFF_Zigbee_3.0_USB_Dongle_Plus_V2_SERIAL-NUMBER-HERE-if00 -&gt; ../../ttyACM0
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ ls -lah /dev/serial/by-path/
</span></span><span style="display:flex;"><span>drwxr-xr-x <span style="color:#ae81ff">2</span> root root <span style="color:#ae81ff">60</span> Aug  <span style="color:#ae81ff">5</span> 10:17 .
</span></span><span style="display:flex;"><span>drwxr-xr-x <span style="color:#ae81ff">4</span> root root <span style="color:#ae81ff">80</span> Aug  <span style="color:#ae81ff">5</span> 10:17 ..
</span></span><span style="display:flex;"><span>lrwxrwxrwx <span style="color:#ae81ff">1</span> root root <span style="color:#ae81ff">13</span> Aug  <span style="color:#ae81ff">5</span> 10:17 platform-xhci-hcd.0.auto-usb-0:2:1.0 -&gt; ../../ttyACM0
</span></span></code></pre></div><p>That <code>usb-ITEAD_SONOFF_Zigbee_3.0_USB_Dongle_Plus_V2_SERIAL-NUMBER-HERE-if00</code> value is what you need to put into <code>--device</code> mapping on creating/running the container. Since I have already created a container without providing a correct value and I don&rsquo;t know how to update an already existing container with a correct mapping, I just re-created it:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ sudo docker stop zigbee2mqtt
</span></span><span style="display:flex;"><span>$ sudo docker rm zigbee2mqtt
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ sudo docker run -d <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    --name zigbee2mqtt <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    --network hub <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    --restart<span style="color:#f92672">=</span>unless-stopped <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    --device<span style="color:#f92672">=</span>/dev/serial/by-id/usb-ITEAD_SONOFF_Zigbee_3.0_USB_Dongle_Plus_V2_SERIAL-NUMBER-HERE-if00:/dev/ttyACM0 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    -v /root/zigbee2mqtt/data:/app/data <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    -v /root/zigbee2mqtt/logs:/app/logs <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    -e TZ<span style="color:#f92672">=</span>Europe/Amsterdam <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    koenkk/zigbee2mqtt
</span></span></code></pre></div><p>Successful launch will manifest itself in the log like this:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>info:     z2m: Starting Zigbee2MQTT version 1.39.0 <span style="color:#f92672">(</span>commit <span style="color:#75715e">#0326926)</span>
</span></span><span style="display:flex;"><span>info:     z2m: Starting zigbee-herdsman <span style="color:#f92672">(</span>0.50.1<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>info:     zh:zstack:znp: Opening SerialPort with <span style="color:#f92672">{</span><span style="color:#e6db74">&#34;path&#34;</span>:<span style="color:#e6db74">&#34;/dev/ttyACM0&#34;</span>,<span style="color:#e6db74">&#34;baudRate&#34;</span>:115200,<span style="color:#e6db74">&#34;rtscts&#34;</span>:false,<span style="color:#e6db74">&#34;autoOpen&#34;</span>:false<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>info:     zh:zstack:znp: Serialport opened
</span></span><span style="display:flex;"><span>info:     zh:zstack:znp: Writing CC2530/CC2531 skip bootloader payload
</span></span><span style="display:flex;"><span>info:     zh:zstack:znp: Skip bootloader <span style="color:#66d9ef">for</span> CC2652/CC1352
</span></span></code></pre></div><p>&hellip;however, after that I got a different error:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>error:    z2m: Error <span style="color:#66d9ef">while</span> starting zigbee-herdsman
</span></span><span style="display:flex;"><span>error:    z2m: Failed to start zigbee
</span></span><span style="display:flex;"><span>error:    z2m: Check https://www.zigbee2mqtt.io/guide/installation/20_zigbee2mqtt-fails-to-start.html <span style="color:#66d9ef">for</span> possible solutions
</span></span><span style="display:flex;"><span>error:    z2m: Exiting...
</span></span><span style="display:flex;"><span>error:    z2m: Error: Failed to connect to the adapter <span style="color:#f92672">(</span>Error: SRSP - SYS - ping after 6000ms<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    at ZStackAdapter.start <span style="color:#f92672">(</span>/app/node_modules/zigbee-herdsman/src/adapter/z-stack/adapter/zStackAdapter.ts:101:27<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    at Controller.start <span style="color:#f92672">(</span>/app/node_modules/zigbee-herdsman/src/controller/controller.ts:129:29<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    at Zigbee.start <span style="color:#f92672">(</span>/app/lib/zigbee.ts:63:27<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    at Controller.start <span style="color:#f92672">(</span>/app/lib/controller.ts:139:27<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    at start <span style="color:#f92672">(</span>/app/index.js:154:5<span style="color:#f92672">)</span>
</span></span></code></pre></div><p>Possible reasons are listed <a href="https://zigbee2mqtt.io/guide/installation/20_zigbee2mqtt-fails-to-start.html#error-srsp-sys-ping-after-6000ms">here</a>, and I suspected that in my case it was an obsolete firmware, but then I saw <a href="https://youtu.be/4y_dDgo0i2g?feature=shared&amp;t=277">this video</a>, which is exactly about SONOFF Zigbee 3.0 USB Dongle Plus-E, and there I noticed the <code>adapter: ezsp</code> setting, which I did not have in my config. So I added it:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#75715e"># ...</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">serial</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># where Zigbee adapter is connected to</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">port</span>: <span style="color:#ae81ff">/dev/ttyACM0</span>
</span></span><span style="display:flex; background-color:#3c3d38"><span>  <span style="color:#75715e"># if you have SONOFF Zigbee 3.0 USB Dongle Plus-E</span>
</span></span><span style="display:flex; background-color:#3c3d38"><span>  <span style="color:#f92672">adapter</span>: <span style="color:#ae81ff">ezsp</span>
</span></span></code></pre></div><p>And then it finally launched (<em>almost</em>) fine:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>info:     z2m: Starting Zigbee2MQTT version 1.39.0 <span style="color:#f92672">(</span>commit <span style="color:#75715e">#0326926)</span>
</span></span><span style="display:flex;"><span>info:     z2m: Starting zigbee-herdsman <span style="color:#f92672">(</span>0.50.1<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>warning:     zh:ezsp: Deprecated driver <span style="color:#e6db74">&#39;ezsp&#39;</span> currently in use, <span style="color:#e6db74">&#39;ember&#39;</span> will become the officially supported EmberZNet driver in next release. If using Zigbee2MQTT see https://github.com/Koenkk/zigbee2mqtt/discussions/21462
</span></span><span style="display:flex;"><span>error:     zh:ezsp:ezsp: Failure to init network
</span></span><span style="display:flex;"><span>info:     zh:ezsp:driv: Form network
</span></span><span style="display:flex;"><span>info:     zh:controller: Wrote coordinator backup to <span style="color:#e6db74">&#39;/app/data/coordinator_backup.json&#39;</span>
</span></span><span style="display:flex;"><span>info:     z2m: zigbee-herdsman started <span style="color:#f92672">(</span>reset<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>info:     z2m: Coordinator firmware version: <span style="color:#e6db74">&#39;{&#34;meta&#34;:{&#34;maintrel&#34;:&#34;3 &#34;,&#34;majorrel&#34;:&#34;6&#34;,&#34;minorrel&#34;:&#34;10&#34;,&#34;product&#34;:8,&#34;revision&#34;:&#34;6.10.3.0 build 297&#34;},&#34;type&#34;:&#34;EZSP v8&#34;}&#39;</span>
</span></span><span style="display:flex;"><span>info:     z2m: Currently <span style="color:#ae81ff">0</span> devices are joined:
</span></span><span style="display:flex;"><span>warning:     z2m: <span style="color:#e6db74">`</span>permit_join<span style="color:#e6db74">`</span> set to  <span style="color:#e6db74">`</span>true<span style="color:#e6db74">`</span> in configuration.yaml.
</span></span><span style="display:flex;"><span>warning:     z2m: Allowing new devices to join.
</span></span><span style="display:flex;"><span>warning:     z2m: Set <span style="color:#e6db74">`</span>permit_join<span style="color:#e6db74">`</span> to <span style="color:#e6db74">`</span>false<span style="color:#e6db74">`</span> once you joined all devices.
</span></span><span style="display:flex;"><span>info:     z2m: Zigbee: allowing new devices to join.
</span></span><span style="display:flex;"><span>info:     z2m: Connecting to MQTT server at mqtt://mosquitto
</span></span><span style="display:flex;"><span>info:     z2m: Connected to MQTT server
</span></span><span style="display:flex;"><span>info:     z2m: Zigbee2MQTT started!
</span></span></code></pre></div><p>One of the warnings says that <code>ezsp</code> is a deprecated driver, and instead it should be <code>ember</code>. So I tried that:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#75715e"># ...</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">serial</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># where Zigbee adapter is connected to</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">port</span>: <span style="color:#ae81ff">/dev/ttyACM0</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># if you have SONOFF Zigbee 3.0 USB Dongle Plus-E</span>
</span></span><span style="display:flex; background-color:#3c3d38"><span>  <span style="color:#f92672">adapter</span>: <span style="color:#ae81ff">ember</span>
</span></span></code></pre></div><p>but it failed to launch:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>info:     z2m: Starting Zigbee2MQTT version 1.39.0 <span style="color:#f92672">(</span>commit <span style="color:#75715e">#0326926)</span>
</span></span><span style="display:flex;"><span>info:     z2m: Starting zigbee-herdsman <span style="color:#f92672">(</span>0.50.1<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>info:     zh:ember: Using default stack config.
</span></span><span style="display:flex;"><span>info:     zh:ember: <span style="color:#f92672">========</span> Ember Adapter Starting <span style="color:#f92672">========</span>
</span></span><span style="display:flex;"><span>info:     zh:ember:ezsp: <span style="color:#f92672">========</span> EZSP starting <span style="color:#f92672">========</span>
</span></span><span style="display:flex;"><span>info:     zh:ember:uart:ash: <span style="color:#f92672">========</span> ASH NCP reset <span style="color:#f92672">========</span>
</span></span><span style="display:flex;"><span>info:     zh:ember:uart:ash: RTS/CTS config is off, enabling software flow control.
</span></span><span style="display:flex;"><span>info:     zh:ember:uart:ash: Serial port opened
</span></span><span style="display:flex;"><span>info:     zh:ember:uart:ash: <span style="color:#f92672">========</span> ASH starting <span style="color:#f92672">========</span>
</span></span><span style="display:flex;"><span>error:     zh:ember:uart:ash: Received ERROR from NCP <span style="color:#66d9ef">while</span> connecting, with code<span style="color:#f92672">=</span>ERROR_EXCEEDED_MAXIMUM_ACK_TIMEOUT_COUNT.
</span></span><span style="display:flex;"><span>error:     zh:ember:uart:ash: ASH disconnected | NCP status: ASH_NCP_FATAL_ERROR
</span></span><span style="display:flex;"><span>error:     zh:ember:uart:ash: Error <span style="color:#66d9ef">while</span> parsing received frame, status<span style="color:#f92672">=</span>ASH_NCP_FATAL_ERROR.
</span></span><span style="display:flex;"><span>info:     zh:ember:uart:ash: <span style="color:#f92672">========</span> ASH NCP reset <span style="color:#f92672">========</span>
</span></span><span style="display:flex;"><span>info:     zh:ember:uart:ash: <span style="color:#f92672">========</span> ASH starting <span style="color:#f92672">========</span>
</span></span><span style="display:flex;"><span>info:     zh:ember:uart:ash: <span style="color:#f92672">========</span> ASH connected <span style="color:#f92672">========</span>
</span></span><span style="display:flex;"><span>info:     zh:ember:uart:ash: <span style="color:#f92672">========</span> ASH started <span style="color:#f92672">========</span>
</span></span><span style="display:flex;"><span>info:     zh:ember:ezsp: <span style="color:#f92672">========</span> EZSP started <span style="color:#f92672">========</span>
</span></span><span style="display:flex;"><span>error:     z2m: Error <span style="color:#66d9ef">while</span> starting zigbee-herdsman
</span></span><span style="display:flex;"><span>error:     z2m: Failed to start zigbee
</span></span><span style="display:flex;"><span>error:     z2m: Check https://www.zigbee2mqtt.io/guide/installation/20_zigbee2mqtt-fails-to-start.html <span style="color:#66d9ef">for</span> possible solutions
</span></span><span style="display:flex;"><span>error:     z2m: Exiting...
</span></span><span style="display:flex;"><span>error:     z2m: Error: NCP EZSP protocol version of <span style="color:#ae81ff">8</span> does not match Host version <span style="color:#ae81ff">13</span>
</span></span><span style="display:flex;"><span>    at EmberAdapter.emberVersion <span style="color:#f92672">(</span>/app/node_modules/zigbee-herdsman/src/adapter/ember/adapter/emberAdapter.ts:1714:19<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    at EmberAdapter.initEzsp <span style="color:#f92672">(</span>/app/node_modules/zigbee-herdsman/src/adapter/ember/adapter/emberAdapter.ts:893:9<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    at EmberAdapter.start <span style="color:#f92672">(</span>/app/node_modules/zigbee-herdsman/src/adapter/ember/adapter/emberAdapter.ts:2722:24<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    at Controller.start <span style="color:#f92672">(</span>/app/node_modules/zigbee-herdsman/src/controller/controller.ts:129:29<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    at Zigbee.start <span style="color:#f92672">(</span>/app/lib/zigbee.ts:63:27<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    at Controller.start <span style="color:#f92672">(</span>/app/lib/controller.ts:139:27<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    at start <span style="color:#f92672">(</span>/app/index.js:154:5<span style="color:#f92672">)</span>
</span></span></code></pre></div><p>From what I see here, to make it work with <code>ember</code>, apparently I need flash my Zigbee adapter with a different/newer firmware. However, for now I decided not to, and I just reverted the config back to <code>ezsp</code>, as that one seemed to be already working as it is.</p>
<p>To access the frontend I exposed its port (<em><code>8080</code> by default</em>) from the host the <a href="#nginx">same way</a> I did it with Home Assistant container (<em>static IP and reverse proxy</em>):</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ sudo docker network disconnect hub zigbee2mqtt
</span></span><span style="display:flex;"><span>$ sudo docker network connect --ip 172.18.0.101 hub zigbee2mqtt
</span></span><span style="display:flex;"><span>$ sudo docker inspect -f <span style="color:#e6db74">&#39;{{range.NetworkSettings.Networks}}{{.IPAddress}}{{end}}&#39;</span> zigbee2mqtt
</span></span><span style="display:flex;"><span>172.18.0.101
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ sudo cp /etc/nginx/sites-available/<span style="color:#f92672">{</span>homeassistant,zigbee2mqtt<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>$ sudo nano /etc/nginx/sites-available/zigbee2mqtt
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nginx" data-lang="nginx"><span style="display:flex;"><span><span style="color:#66d9ef">map</span> $http_upgrade $connection_upgrade {
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">default</span> <span style="color:#e6db74">upgrade</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#39;&#39;</span> <span style="color:#e6db74">close</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">server</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># again, doesn&#39;t have to be exactly 8080
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#f92672">listen</span> <span style="color:#ae81ff">8080</span> <span style="color:#e6db74">ssl</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">ssl_certificate</span> <span style="color:#e6db74">/opt/certificates/fullchain.pem</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">ssl_certificate_key</span> <span style="color:#e6db74">/opt/certificates/key.pem</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">location</span> <span style="color:#e6db74">/</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">proxy_pass</span> <span style="color:#e6db74">http://172.18.0.101:8080</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">proxy_http_version</span> <span style="color:#ae81ff">1</span><span style="color:#e6db74">.1</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">proxy_set_header</span> <span style="color:#e6db74">Upgrade</span> $http_upgrade;
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">proxy_set_header</span> <span style="color:#e6db74">Connection</span> $connection_upgrade;
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">proxy_set_header</span> <span style="color:#e6db74">Host</span> $host;
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">proxy_cache_bypass</span> $http_upgrade;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ sudo ln -s /etc/nginx/sites-<span style="color:#f92672">{</span>available,enabled<span style="color:#f92672">}</span>/zigbee2mqtt
</span></span><span style="display:flex;"><span>$ sudo systemctl restart nginx.service
</span></span></code></pre></div><p>Once I&rsquo;ve logged-in to my Zigbee2MQTT frontend, I could see that my Zigbee adapter/coordinator revision is <code>6.10.3.0 build 297</code>:</p>


    <img class="image-post" loading="lazy" src="/blog/2024/08/16/home-assistant-on-vero-with-docker/images/zigbee2mqtt-frontend.png" alt="Zigbee2MQTT frontend" style="border:1px solid black;">

<p>but I have no idea how to check if that is the latest available (<em>or how to update it to the latest</em>). I&rsquo;ve seen several GiHub repositories with some firmwares, but I can&rsquo;t tell which of them is the official one, and in general distributing firmware binaries via GitHib seems very bizarre to me. Either way, there is no pressure, as it seems to work fine with the current firmware.</p>
<p>Now you can start adding devices to grow your Zigbee network. To add a new device, put it (<em>the device</em>) into pairing mode and wait for it to appear on the <strong>Devices</strong> page of your Zigbee2MQTT frontend:</p>


    <img class="image-post" loading="lazy" src="/blog/2024/08/16/home-assistant-on-vero-with-docker/images/zigbee2mqtt-discovered-device.png" alt="Zigbee2MQTT, discovered device" style="border:1px solid black;">

<p>Once the device is paired, Zigbee adapter/coordinator hardware will be communicating with it over Zigbee and will be forwarding its data to Home Assistant via MQTT; and the other way around, commands from Home Assistant well be going through MQTT broker to Zigbee2MQTT, which will be transmitting them to devices over Zigbee by coordinator.</p>
<p>Below there will be examples for some of the devices that I have.</p>
<h3 id="philips-hue-smart-plug">Philips Hue Smart Plug</h3>
<p>Philips has a whole family of smart home devices, which is called <a href="https://philips-hue.com/">Philips Hue</a>, and out of those I only have a <a href="https://philips-hue.com/no-no/p/hue-smart-plug/8719514342309">Philips Hue Smart Plug</a> for now:</p>
<p>


    <img class="image-post" loading="lazy" src="/blog/2024/08/16/home-assistant-on-vero-with-docker/images/philips-hue-smart-plug-front.jpg" alt="Philips Hue Smart Plug">

</p>
<p>


    <img class="image-post" loading="lazy" src="/blog/2024/08/16/home-assistant-on-vero-with-docker/images/philips-hue-smart-plug-back.jpg" alt="Philips Hue Smart Plug">

</p>
<p>To put it into pairing mode, plug it into a power socket, wait for the front indicator to turn off, press and hold the button on the side and wait for the indicator to blink with orange for 5 or more times. Shortly after that it should appear in the list of devices in Zigbee2MQTT frontend.</p>
<p>The pairing happens automatically, you don&rsquo;t need to do anything, just watch the pop-ups. Once the device is paired, here&rsquo;s how its page will look like (<em>here I have already renamed it</em>):</p>


    <img class="image-post" loading="lazy" src="/blog/2024/08/16/home-assistant-on-vero-with-docker/images/zigbee2mqtt-philips-hue-smart-plug.png" alt="Zigbee2MQTT, Philips Hue Smart plug" style="border:1px solid black;">

<p>To easily find it in Home Assistant, rename it from the default name to something meaningful and update the Home Assistant entity ID too:</p>


    <img class="image-post" loading="lazy" src="/blog/2024/08/16/home-assistant-on-vero-with-docker/images/zigbee2mqtt-renaming-device.png" alt="Zigbee2MQTT, renaming a device" style="border:1px solid black;">

<p>Then it should appear in Home Assistant list of devices under that exact name:</p>


    <img class="image-post" loading="lazy" src="/blog/2024/08/16/home-assistant-on-vero-with-docker/images/philips-hue-smart-plug-in-home-assistant-devices.png" alt="Philips Hue Smart plug in Home Assistant devices" style="border:1px solid black;">

<p>At this point you can already turn it on and off from Home Assistant and use it in your automation routines.</p>
<p>Sadly, this particular &ldquo;smart&rdquo; plug is rather &ldquo;dumb&rdquo;, as it only has on/off capabilities with no energy meter/counter:</p>


    <img class="image-post" loading="lazy" src="/blog/2024/08/16/home-assistant-on-vero-with-docker/images/philips-hue-smart-plug-device.png" alt="Philips Hue Smart Plug as a Home Assistant device" style="border:1px solid black;">

<p>But that is actually fine, because it costs less than the alternatives with energy meter - 300 NOK versus 400+ NOK - which builds up to a significant difference if you need to buy several of those.</p>
<h3 id="frient-smart-plug-mini-2">Frient Smart Plug Mini 2</h3>
<p>There is another smart plug - <a href="https://frient.com/products/smart-plug-mini-2/">Frient Smart Plug Mini 2</a>:</p>
<p>


    <img class="image-post" loading="lazy" src="/blog/2024/08/16/home-assistant-on-vero-with-docker/images/frient-smart-plug-mini-2-front.jpg" alt="Frient Smart Plug Mini 2">

</p>
<p>


    <img class="image-post" loading="lazy" src="/blog/2024/08/16/home-assistant-on-vero-with-docker/images/frient-smart-plug-mini-2-back.jpg" alt="Frient Smart Plug Mini 2">

</p>
<p>And this one is equiped with an energy meter/counter, so it is &ldquo;smarter&rdquo; than the one from <a href="#philips-hue-smart-plug">Philips</a>, but it is also more expensive (<em>about 500 NOK</em>) and unglier too, so I don&rsquo;t think I&rsquo;ll buy more of these.</p>
<p>The pairing should be trivial: when it is not part of any network, it enters the pairing mode automatically. If not, try pressing the button on the side for 5 or more seconds, or/and re-plug it to a power socket.</p>
<p>Once Zigbee2MQTT pairs with it, here are the metrics it will expose:</p>


    <img class="image-post" loading="lazy" src="/blog/2024/08/16/home-assistant-on-vero-with-docker/images/frient-smart-plug-sensors.png" alt="Home Assistant, Frient Smart Plug Mini 2 sensors" style="border:1px solid black;">

<p>So it is immediate power consumption, total amount of power already consumed, voltage, frequency and others. As with any other value in Home Assistant, you can get a historical chart of changes, for example here&rsquo;s one for voltage:</p>


    <img class="image-post" loading="lazy" src="/blog/2024/08/16/home-assistant-on-vero-with-docker/images/frient-smart-plug-voltage-chart.png" alt="Home Assistant, Frient Smart Plug Mini 2 voltage chart" style="border:1px solid black;">

<p>So that&rsquo;s already quite a lot to play with, as you can create scripts and automations to perform various actions based on any of those metrics.</p>
<h3 id="ikea-tradfri-e27">IKEA Tradfri E27</h3>
<p>As it turned out, <a href="https://ikea.com/no/no/p/tradfri-startsett-smart-kan-dimmes-tradlost-varmhvit-til-kaldhvit-80547567/">IKEA bulbs</a> with a remote control, which I have already been using for a couple of years, are also Zigbee-enabled, so they can be connected to a Zigbee network without their remote control:</p>


    <img class="image-post" loading="lazy" src="/blog/2024/08/16/home-assistant-on-vero-with-docker/images/ikea-tradfri-e27.jpg" alt="IKEA Tradfri E27">

<p>To put a bulb into pairing mode, turn it off and on for 5 times, and on the 6th time keep it on. It should start doing a certain lighting pattern, meaning that it is now discoverable by a Zigbee coordinator.</p>
<p>Once added, here&rsquo;s how it looks in Home Assistant:</p>


    <img class="image-post" loading="lazy" src="/blog/2024/08/16/home-assistant-on-vero-with-docker/images/ikea-e27-sensors.png" alt="IKEA TRADFRI E27 sensors in Home Assistant" style="border:1px solid black;">

<p>The controls are great, you can set not only brightness but the color temperature too, plus there are several effects available:</p>
<div class="vertical-image-centered-scaled">


    <img class="image-post" loading="lazy" src="/blog/2024/08/16/home-assistant-on-vero-with-docker/images/ikea-e27-controls.png" alt="IKEA TRADFRI E27 controls in Home Assistant" style="border:1px solid black;">

</div>
<p>As a very nice surprise, these bulbs also act as Zigbee signal repeaters/extenders, so they allow you to place other devices farther away from the coordinator/hub. And I forgot to mention that smart power plugs (<em><a href="#philips-hue-smart-plug">Philips</a> and <a href="#frient-smart-plug-mini-2">Frient</a></em>) also act as network extenders, so that is probably the case for many power-connected devices.</p>
<p>Having smart bulbs (<em>and/or dumb lamps connected to smart plugs</em>), one can create the following basic automation for turning on the (<em>appropriately labeled</em>) lights in one of the rooms on schedule:</p>


    <img class="image-post" loading="lazy" src="/blog/2024/08/16/home-assistant-on-vero-with-docker/images/automation-lights-on-time.png" alt="Home Assistant, automation for turning on the lights on time" style="border:1px solid black;">

<p>It will work with bulbs and plugs, despite them being different types of devices, because they all support <a href="https://home-assistant.io/integrations/switch/">switch</a> actions.</p>
<p>Here&rsquo;s also this automation as code:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">alias</span>: <span style="color:#ae81ff">Turn ON lights on 2nd floor</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">description</span>: <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">trigger</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">platform</span>: <span style="color:#ae81ff">time</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">at</span>: <span style="color:#e6db74">&#34;20:12:00&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">condition</span>: []
</span></span><span style="display:flex;"><span><span style="color:#f92672">action</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">service</span>: <span style="color:#ae81ff">switch.turn_on</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">metadata</span>: {}
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">data</span>: {}
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">target</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">area_id</span>: <span style="color:#ae81ff">living_room</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">label_id</span>: <span style="color:#ae81ff">lights</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">mode</span>: <span style="color:#ae81ff">single</span>
</span></span></code></pre></div><p>And it will be trivial to create a similar automation for turning the lights off.</p>
<h3 id="nimly-connect-module">nimly Connect Module</h3>
<p>I&rsquo;ve got a <a href="https://nimly.io/product/touch-pro-en/">nimly Touch</a> Pro lock with a <a href="https://nimly.io/product/connect-module-2/">nimly Connect Module</a>. The module allows you to control the lock remotely, so you can lock/unlock it, change some settings, get information about what method was last used to unlock it (<em>fingerprint, token, pin-code</em>) and which user did it.</p>
<p>The lock itself is great, but I&rsquo;ve had some problems with the module. It is actually my 3rd module already, as the first two had certain defects (<em>first one was loosing connection and second one was draining the batteries</em>), and nimly people are graciously sending me replacements. The current module that I got has firmware build date <code>20240625</code> with version <code>4.7.79</code>, and finally everything seems to be good with this one.</p>
<p>Initially I&rsquo;ve been using the modules with Homely, but I wasn&rsquo;t entirely satisfied with the functionality exposed in Homely application, so I decided to connect it to Home Assistant instead. The pairing with Zigbee2MQTT went fine, the module got interviewed and marked as supported:</p>


    <img class="image-post" loading="lazy" src="/blog/2024/08/16/home-assistant-on-vero-with-docker/images/nimly-zigbee2mqtt.png" alt="nimly Touch Pro in Zigbee2MQTT" style="border:1px solid black;">

<p>I also got it in Home Assistant, but nothing seemed to actually work. The commands that I tried to send to it (<em>such as lock/unlock</em>) were failing, as there was no reaction on the lock itself, and the logs had errors like:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>zh:ezsp:ezsp: Frame changeSourceRouteHandler parsing error: RangeError: Attempt to access memory outside buffer bounds at new NodeError <span style="color:#f92672">(</span>node:internal/errors:405:5<span style="color:#f92672">)</span> at boundsError <span style="color:#f92672">(</span>node:internal/buffer:86:11<span style="color:#f92672">)</span> at Buffer.readUInt16LE <span style="color:#f92672">(</span>node:internal/buffer:245:5<span style="color:#f92672">)</span> at Buffer.readUIntLE <span style="color:#f92672">(</span>node:internal/buffer:182:17<span style="color:#f92672">)</span> at Function.deserialize <span style="color:#f92672">(</span>/app/node_modules/zigbee-herdsman/src/adapter/ezsp/driver/types/basic.ts:19:67<span style="color:#f92672">)</span> at new EZSPFrameData <span style="color:#f92672">(</span>/app/node_modules/zigbee-herdsman/src/adapter/ezsp/driver/ezsp.ts:180:54<span style="color:#f92672">)</span> at /app/node_modules/zigbee-herdsman/src/adapter/ezsp/driver/ezsp.ts:154:23 at Array.every <span style="color:#f92672">(</span>&lt;anonymous&gt;<span style="color:#f92672">)</span> at Function.createFrame <span style="color:#f92672">(</span>/app/node_modules/zigbee-herdsman/src/adapter/ezsp/driver/ezsp.ts:148:15<span style="color:#f92672">)</span> at Ezsp.onFrameReceived <span style="color:#f92672">(</span>/app/node_modules/zigbee-herdsman/src/adapter/ezsp/driver/ezsp.ts:439:35<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>zh:ezsp:ezsp: Unparsed frame 0xc4. Skipped
</span></span><span style="display:flex;"><span>z2m: Publish <span style="color:#e6db74">&#39;set&#39;</span> <span style="color:#e6db74">&#39;state&#39;</span> to <span style="color:#e6db74">&#39;nimly Touch Pro&#39;</span> failed: <span style="color:#e6db74">&#39;Error: ZCL command IEEE-ADDRESS-HERE/11 closuresDoorLock.lockDoor({&#34;pincodevalue&#34;:&#34;&#34;}, {&#34;timeout&#34;:10000,&#34;disableResponse&#34;:false,&#34;disableRecovery&#34;:false,&#34;disableDefaultResponse&#34;:true,&#34;direction&#34;:0,&#34;srcEndpoint&#34;:null,&#34;reservedBits&#34;:0,&#34;manufacturerCode&#34;:null,&#34;transactionSequenceNumber&#34;:null,&#34;writeUndiv&#34;:false}) failed (Timeout - 57813 - 11 - 52 - 257 - 0 after 10000ms)&#39;</span>
</span></span></code></pre></div><p>Also its sensors were reporting <code>None</code> in Home Assistant:</p>


    <img class="image-post" loading="lazy" src="/blog/2024/08/16/home-assistant-on-vero-with-docker/images/nimly-sensors-no-data.png" alt="nimly Touch Pro in Home Assistant, no data">

<p>Before trying anything else I tried to simply re-pair it (<em>force-remove, re-insert the batteries and add it back again</em>), and this time it got successfully added with everything working (<em>even though there were still the same errors in the logs</em>):</p>
<div class="vertical-image-centered-scaled">


    <img class="image-post" loading="lazy" src="/blog/2024/08/16/home-assistant-on-vero-with-docker/images/nimly-sensors.png" alt="nimly Touch Pro in Home Assistant">

</div>
<p>Now that there is a possibility to remotely control such a critical piece of hardware as main door lock, you can quite literally be hacked - just like in the movies. How exciting is that!</p>
<h3 id="aqara-cube-t1-pro">Aqara Cube T1 Pro</h3>
<p>That <a href="https://aqara.com/eu/product/cube-t1-pro/">little thing</a> is fantastic:</p>


    <img class="image-post" loading="lazy" src="/blog/2024/08/16/home-assistant-on-vero-with-docker/images/aqara-cube-t1-pro.jpg" alt="Aqara Cube T1 Pro">

<p>Say you&rsquo;d like to have a physical button, which would control the lights, so you could just press it instead of reaching to your phone/computer with Home Assistant client application/browser. And then maybe you&rsquo;d also like to have a dimmer for the lights, and maybe yet another button for controlling a power plug, and so on and so on. Every such Zigbee-capable button/dimmer would cost you some noticable amount of money, plus they would be piling up on your table, so that doesn&rsquo;t scale very well, does it.</p>
<p>But what if instead of having several such buttons/dimmers you could have just one device that could somehow act as several &ldquo;buttons&rdquo;. And Aqara Cube is exactly that: it can trigger at the very least 18 actions (<em>3 for each side: tapping, rotating clockwise and rotating counterclockwise</em>) - but actually more, because there are also actions for pushing, resting, holding, throwing, shaking, flipping 90/180 degrees and more. And <a href="https://prisjakt.no/product.php?p=7266341">all that</a> for the price of less than one <a href="https://prisjakt.no/product.php?p=5829868">physical button</a>.</p>
<p>To state the obvious, you do not need the Aqara hub or anything else to interface with it, as Zigbee2MQTT can pair with it directly just fine. Take off the top side cover/plate and hold the link button for 5 seconds. Once it is paired, don&rsquo;t put the plate back just yet - I would recommend you to switch the cube to Action mode. That is done by sending the &ldquo;operation&rdquo; command to it, either from Zigbee2MQTT device page or from Home Assistant device page. For this to take effect immediately (<em>otherwise it &ldquo;syncs&rdquo; once per hour?</em>), press the link button once, and then you can put the plate back.</p>
<p>Here&rsquo;s a very basic automation that you can make with the cube:</p>


    <img class="image-post" loading="lazy" src="/blog/2024/08/16/home-assistant-on-vero-with-docker/images/aqara-cube-automation-lights.png" alt="Aqara Cude automation for toggling lights" style="border:1px solid black;">

<p>So whenever I double-tap the cube on the table (<em>or wherever it is</em>), while its top side is <code>1</code>, all the devices labeled with <code>lights</code> in the <code>Living room</code> area will be toggled on/off.</p>
<p>Here it is a code too:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">alias</span>: <span style="color:#ae81ff">💡 1 | Toggle lights on 2nd floor</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">description</span>: <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">trigger</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">platform</span>: <span style="color:#ae81ff">device</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">domain</span>: <span style="color:#ae81ff">mqtt</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">device_id</span>: <span style="color:#ae81ff">AQARA-CUBE-DEVICE-ID-HERE</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">type</span>: <span style="color:#ae81ff">action</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">subtype</span>: <span style="color:#ae81ff">tap</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">condition</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">condition</span>: <span style="color:#ae81ff">state</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">entity_id</span>: <span style="color:#ae81ff">sensor.aqara_cube_t1_pro_side</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">state</span>: <span style="color:#e6db74">&#34;1&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">action</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">service</span>: <span style="color:#ae81ff">switch.toggle</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">metadata</span>: {}
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">data</span>: {}
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">target</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">area_id</span>: <span style="color:#ae81ff">living_room</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">label_id</span>: <span style="color:#ae81ff">lights</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">mode</span>: <span style="color:#ae81ff">single</span>
</span></span></code></pre></div><p>There will be some more automation examples <a href="#controlling-dyson-with-aqara-cube">later</a>.</p>
<h1 id="home-assistant-community-store">Home Assistant Community Store</h1>
<p>To further extend Home Assistant capabilities, you can add <a href="https://hacs.xyz">Home Assistant Community Store</a> (<em>HACS</em>) to it.</p>
<p>The HACS is supposed to be installed into <code>/path/to/home-assistant/config/custom_components/</code>, which in case of Docker container would mean creating this folder inside the container, but fortunately we have already mounted/mapped this path on <a href="#home-assistant">container creation</a>, and it points to <code>/root/homeassistant/</code> in the host filesystem.</p>
<p>As for the installation itself, yet again it is expected that you will download and run <a href="https://get.hacs.xyz">their script</a>, but this time I couldn&rsquo;t tolerate that, so I just picked out the relevant commads from it. Essentially, it just downloads a ZIP archive and extracts it to <code>/path/to/home-assistant/config/custom_components/hacs/</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ cd /tmp
</span></span><span style="display:flex;"><span>$ wget <span style="color:#e6db74">&#34;https://github.com/hacs/integration/releases/latest/download/hacs.zip&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ export HOMEASSISTANT_PATH<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;/root/homeassistant&#34;</span>
</span></span><span style="display:flex;"><span>$ sudo ls -L1a $HOMEASSISTANT_PATH
</span></span><span style="display:flex;"><span>automations.yaml
</span></span><span style="display:flex;"><span>blueprints
</span></span><span style="display:flex;"><span>.cloud
</span></span><span style="display:flex;"><span>configuration.yaml
</span></span><span style="display:flex;"><span>deps
</span></span><span style="display:flex;"><span>.HA_VERSION
</span></span><span style="display:flex;"><span>home-assistant.log
</span></span><span style="display:flex;"><span>home-assistant.log.1
</span></span><span style="display:flex;"><span>home-assistant.log.fault
</span></span><span style="display:flex;"><span>home-assistant_v2.db
</span></span><span style="display:flex;"><span>home-assistant_v2.db-shm
</span></span><span style="display:flex;"><span>home-assistant_v2.db-wal
</span></span><span style="display:flex;"><span>scenes.yaml
</span></span><span style="display:flex;"><span>scripts.yaml
</span></span><span style="display:flex;"><span>secrets.yaml
</span></span><span style="display:flex;"><span>.storage
</span></span><span style="display:flex;"><span>tts
</span></span><span style="display:flex;"><span>$ sudo cat $HOMEASSISTANT_PATH/.HA_VERSION <span style="color:#f92672">&amp;&amp;</span> echo
</span></span><span style="display:flex;"><span>2024.7.3
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ sudo mkdir -p <span style="color:#e6db74">&#34;</span>$HOMEASSISTANT_PATH<span style="color:#e6db74">/custom_components/hacs&#34;</span>
</span></span><span style="display:flex;"><span>$ sudo unzip /tmp/hacs.zip -d $HOMEASSISTANT_PATH/custom_components/hacs
</span></span></code></pre></div><p>Restart the container:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ sudo docker restart homeassistant
</span></span></code></pre></div><p>And then you should get HACS <a href="https://hacs.xyz/docs/configuration/basic">available</a> in the integrations list:</p>
<div class="vertical-image-centered-scaled">


    <img class="image-post" loading="lazy" src="/blog/2024/08/16/home-assistant-on-vero-with-docker/images/hacs-integration.png" alt="HACS integration" style="border:1px solid black;">

</div>
<p>I did not enable experimental features, just in case:</p>
<div class="vertical-image-centered-scaled">


    <img class="image-post" loading="lazy" src="/blog/2024/08/16/home-assistant-on-vero-with-docker/images/hacs-integration-acknowledgements.png" alt="HACS integration acknowledgements" style="border:1px solid black;">

</div>
<p>The next step was concerning, as it required to authorize with GitHub. I have no idea why does it need that, but at least it seems to only request &ldquo;<em>limited access to your public data</em>&rdquo;, which is probably fine, so I authorized it:</p>
<div class="vertical-image-centered-scaled">


    <img class="image-post" loading="lazy" src="/blog/2024/08/16/home-assistant-on-vero-with-docker/images/hacs-integration-github-authorization.png" alt="HACS integration, GitHub authorization" style="border:1px solid black;">

</div>
<p>After configuration was done, the HACS entry was added to the side panel:</p>
<div class="vertical-image-centered-scaled">


    <img class="image-post" loading="lazy" src="/blog/2024/08/16/home-assistant-on-vero-with-docker/images/hacs-side-panel.png" alt="HACS on side panel in Home Assistant">

</div>
<p>&hellip;although without icon at first, but after reloading the page with clearing cache it did appear. This &ldquo;<em>reloading with clearing the cache</em>&rdquo; you will very often see being mentioned in Home Assistant documentation and forum.</p>
<p>With HACS being integrated in your Home Assistant, you can add even more devices and sensors to it.</p>
<h2 id="dyson-hp09">Dyson HP09</h2>
<p>I have a <a href="https://dyson.com/air-treatment/air-purifier-heaters/purifier-hot-cool-formaldehyde-hp09">Dyson HP09</a> purifier/fan/heater:</p>
<div class="vertical-image-centered-scaled">


    <img class="image-post" loading="lazy" src="/blog/2024/08/16/home-assistant-on-vero-with-docker/images/dyson-hp09.jpg" alt="Description">

</div>
<p>And I wanted to check if it is possible to get its sensors data and maybe control the device too. Turns out, someone already <a href="https://github.com/libdyson-wg/ha-dyson">did that</a>.</p>
<p>To install it, search for &ldquo;dyson&rdquo; in <a href="#home-assistant-community-store">HACS</a>. After the installation:</p>
<div class="vertical-image-centered-scaled">


    <img class="image-post" loading="lazy" src="/blog/2024/08/16/home-assistant-on-vero-with-docker/images/dyson-installation.png" alt="HACS, installing Dyson" style="border:1px solid black;">

</div>
<p>and Home Assistant restart, Dyson became available in the integrations/devices.</p>
<p>To configure it you will need to provide its IP address, which means that you&rsquo;ll need to assign a static one in your home network DHCP, and also Vero V (<em>or whatever you are using as your Home Assistant hub</em>) and Dyson both need to be in the same network (<em>which is a bummer, because I prefer to keep such devices in a separate isolated network</em>). If it keeps failing to connect to the Dyson, that could be because of the old DHCP lease, so try to power off the Dyson completely, unplug the power cable, wait a bit and power it back on.</p>
<p>In connection methods I chose the Dyson account:</p>
<div class="vertical-image-centered-scaled">


    <img class="image-post" loading="lazy" src="/blog/2024/08/16/home-assistant-on-vero-with-docker/images/dyson-configuration-account.png" alt="HACS, configuring Dyson with an account" style="border:1px solid black;">

</div>
<p>Once the device is added, you can remove your Dyson account credentials from the integration entries and restart Home Assistant. From what I understood, Dyson runs its own MQTT server, which this integration uses to communicate with the device over the local network (<em>no Zigbee involved, obviously</em>), so without the internet, which is great.</p>
<p>At first Home Assistant was showing just some basic controls, like the fan speed, direction and oscillation:</p>
<div class="vertical-image-centered-scaled">


    <img class="image-post" loading="lazy" src="/blog/2024/08/16/home-assistant-on-vero-with-docker/images/dyson-basic-controls.png" alt="Home Assistant, Dyson basic controls" style="border:1px solid black;">

</div>
<p>which was quite good already, but still pretty underwhelming, as I was expecting to get all of its marvelous data such as temperature, humidity, air quality metrics and the rest. But then a couple of minutes later I got everything, so it probably just doesn&rsquo;t arrive all at once:</p>


    <img class="image-post" loading="lazy" src="/blog/2024/08/16/home-assistant-on-vero-with-docker/images/dyson-sensors.png" alt="Home Assistant, Dyson sensors">

<p>At this point you should once again think about securing your Home Assistant instance, because a malicious person may be able to remotely switch your fan into the heating mode, and that can be up to 2.5 kWh of energy consumption alone (<em>and with great power comes great electricity bill</em>), not to mention your room being overheated, which might in turn cause some other damage.</p>
<h3 id="controlling-dyson-with-aqara-cube">Controlling Dyson with Aqara Cube</h3>
<p>Here is another example of how great the Aqara Cube is. So I want to toggle Auto/Normal mode of the fan by tapping the cube when the side <code>6</code> is up:</p>


    <img class="image-post" loading="lazy" src="/blog/2024/08/16/home-assistant-on-vero-with-docker/images/aqara-cube-automation-dyson-mode.png" alt="Aqara Cube automation, toggling Dyson mode" style="border:1px solid black;">

<p>Here&rsquo;s the same as code:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">alias</span>: <span style="color:#ae81ff">🪭 6 | Toggle Auto/Normal mode</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">description</span>: <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">trigger</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">platform</span>: <span style="color:#ae81ff">device</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">domain</span>: <span style="color:#ae81ff">mqtt</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">device_id</span>: <span style="color:#ae81ff">AQARA-CUBE-DEVICE-ID-HERE</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">type</span>: <span style="color:#ae81ff">action</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">subtype</span>: <span style="color:#ae81ff">tap</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">condition</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">condition</span>: <span style="color:#ae81ff">state</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">entity_id</span>: <span style="color:#ae81ff">sensor.aqara_cube_t1_pro_side</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">state</span>: <span style="color:#e6db74">&#34;6&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">action</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">if</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">condition</span>: <span style="color:#ae81ff">state</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">entity_id</span>: <span style="color:#ae81ff">fan.dyson_hp09</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">attribute</span>: <span style="color:#ae81ff">preset_mode</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">state</span>: <span style="color:#ae81ff">Auto</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">then</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">service</span>: <span style="color:#ae81ff">fan.set_preset_mode</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">metadata</span>: {}
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">data</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">preset_mode</span>: <span style="color:#ae81ff">Normal</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">target</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">device_id</span>: <span style="color:#ae81ff">DYSON_DEVICE_ID_HERE</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">else</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">service</span>: <span style="color:#ae81ff">fan.set_preset_mode</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">metadata</span>: {}
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">data</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">preset_mode</span>: <span style="color:#ae81ff">Auto</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">target</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">device_id</span>: <span style="color:#ae81ff">DYSON_DEVICE_ID_HERE</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">mode</span>: <span style="color:#ae81ff">single</span>
</span></span></code></pre></div><p>And it works, it bloody works, what sorcery is this.</p>
<p>I have also created automations for setting certain fan speeds on rotating the cube with the <code>6</code> side up, but those are too trivial to be shown here, you can easily create those yourself.</p>
<h2 id="zaptec">Zaptec</h2>
<p>I also have a <a href="https://zaptec.com/charging-solutions/zaptec-go">Zaptec Go</a> charger for my <a href="/blog/2021/12/16/electric-car-norway-leasing-bmw-i3/">electric car</a>:</p>
<div class="vertical-image-centered-scaled">


    <img class="image-post" loading="lazy" src="/blog/2024/08/16/home-assistant-on-vero-with-docker/images/zaptec-go.jpg" alt="Zaptec Go">

</div>
<p>along with <a href="https://zaptec.com/charging-solutions/zaptec-sense">Zaptec Sense</a> (<em><a href="https://elbilgrossisten.no/en/pages/hva-er-en-han-port-tilkobling">HAN-port</a> module</em>):</p>
<div class="vertical-image-centered-scaled">


    <img class="image-post" loading="lazy" src="/blog/2024/08/16/home-assistant-on-vero-with-docker/images/zaptec-sense.jpg" alt="Zaptec Sense">

</div>
<p>And since Zaptec has a <a href="https://api.zaptec.com/help/">REST API</a>, I was hoping that it would be possible to get some of the charging/power metrics in Home Assistant. And what would you know, someone has already <a href="https://github.com/custom-components/zaptec">done that</a> too.</p>
<p>This integration is also installed via <a href="#home-assistant-community-store">HACS</a> by searching for &ldquo;zaptec&rdquo;, and as usual you will need to restart Home Assistant after the installation. After that it will become available in the list of integrations.</p>
<p>Since neither(?) of Zaptec devices expose a local API, all the REST API HTTP requests are sent to Zaptec server over the internet, so there is no Zigbee involved here either. For the integration to work you need to provide it with your <a href="https://portal.zaptec.com/">Zaptec Portal</a> credentials:</p>
<div class="vertical-image-centered-scaled">


    <img class="image-post" loading="lazy" src="/blog/2024/08/16/home-assistant-on-vero-with-docker/images/zaptec-configuration.png" alt="Home Assistant, Zaptec integration configuration" style="border:1px solid black;">

</div>
<p>I created a separate user for this, hoping that it will be a non-owner type of user, but unfortunately no, with the current set of roles you&rsquo;ll have to grant that user the <code>owner</code> role too:</p>
<div class="vertical-image-centered-scaled">


    <img class="image-post" loading="lazy" src="/blog/2024/08/16/home-assistant-on-vero-with-docker/images/zaptec-roles.png" alt="Zaptec user roles" style="border:1px solid black;">

</div>
<p>After the successful configuration you will get a lot of metrics:</p>


    <img class="image-post" loading="lazy" src="/blog/2024/08/16/home-assistant-on-vero-with-docker/images/zaptec-sensors.png" alt="Home Assistant, Zaptec sensors">

<p>&hellip;But unfortunately there is no data from Zaptec Sense. Among other things it provides a total household power consumption, which you can view at your Zaptec Portal:</p>


    <img class="image-post" loading="lazy" src="/blog/2024/08/16/home-assistant-on-vero-with-docker/images/zaptec-sense-data.png" alt="Zaptec Sense power consumption data">

<p>And it would be very useful to have that data in Home Assistant too.</p>
<p>I&rsquo;ve submitted a <a href="https://github.com/custom-components/zaptec/issues/108">feature request</a> for this, but it isn&rsquo;t really within the scope of this particular integration, so I will probably have to implement it myself.</p>
<h2 id="nord-pool-electricity-prices">Nord Pool electricity prices</h2>
<p>In some countries it is possible to get per-hour electricity prices for today an tomorrow, which is a nice metric to have in Home Assistant. Surely enough, someone has <a href="https://github.com/custom-components/nordpool">already done</a> that too.</p>
<p>Installation procedure is the same, just search for &ldquo;nordpool&rdquo; in <a href="#home-assistant-community-store">HACS</a>. For configuration you will need to provide your zone/region (<em>here are the <a href="https://str%C3%B8m.no/str%C3%B8mregioner-norge">norwegian zones</a>, and you should have yours stated in the electricity invoices that you receive from your power supplier</em>):</p>
<div class="vertical-image-centered-scaled">


    <img class="image-post" loading="lazy" src="/blog/2024/08/16/home-assistant-on-vero-with-docker/images/nord-pool-configuration.png" alt="Home Assistant, Nord Pool integration configuration" style="border:1px solid black;">

</div>
<p>But getting plain price values is no fun, we want a chart, and for that there is a yet another HACS repository - <a href="https://github.com/RomRider/apexcharts-card">ApexCharts Card</a>. Having installed that, you will be able to create a chart like this one:</p>


    <img class="image-post" loading="lazy" src="/blog/2024/08/16/home-assistant-on-vero-with-docker/images/nord-pool-chart.png" alt="Home Assistant, Nord Pool data with ApexCharts">

<p>The code for it:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">type</span>: <span style="color:#ae81ff">custom:apexcharts-card</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">graph_span</span>: <span style="color:#ae81ff">46h</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">header</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">title</span>: <span style="color:#ae81ff">Цены на электричество по часам</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">show</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">show_states</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">colorize_states</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">span</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">start</span>: <span style="color:#ae81ff">day</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">now</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">show</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">label</span>: <span style="color:#ae81ff">Сейчас</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">color</span>: <span style="color:#e6db74">&#39;#0074D9&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">experimental</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">color_threshold</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">series</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">entity</span>: <span style="color:#ae81ff">sensor.nordpool_kwh_oslo_nok_2_10_025</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">name</span>: <span style="color:#ae81ff">Цена</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">type</span>: <span style="color:#ae81ff">column</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">float_precision</span>: <span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">color_threshold</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">value</span>: <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">color</span>: <span style="color:#e6db74">&#39;#2ECC40&#39;</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">value</span>: <span style="color:#ae81ff">0.4</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">color</span>: <span style="color:#e6db74">&#39;#FFDC00&#39;</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">value</span>: <span style="color:#ae81ff">0.6</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">color</span>: <span style="color:#e6db74">&#39;#FF4136&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">show</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">extremas</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">header_color_threshold</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">name_in_header</span>: <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">in_header</span>: <span style="color:#ae81ff">raw</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">data_generator</span>: &gt;<span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      return [...entity.attributes.raw_today,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      ...entity.attributes.raw_tomorrow].map((item) =&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        [Date.parse(item.start), item.value]);</span>      
</span></span><span style="display:flex;"><span><span style="color:#f92672">apex_config</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">chart</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">height</span>: <span style="color:#ae81ff">400px</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">tooltip</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">x</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">show</span>: <span style="color:#66d9ef">false</span>
</span></span></code></pre></div><p>And not just that, you can also add some Markdown cards to print out the prices highlights, for example:</p>


    <img class="image-post" loading="lazy" src="/blog/2024/08/16/home-assistant-on-vero-with-docker/images/nord-pool-markdown.png" alt="Home Assistant, Nord Pool data with Markdown">

<p>The code for it (<em>based on someone else&rsquo;s code that I found in <a href="https://community.home-assistant.io/t/any-good-ideas-are-welcome-nordpool-energy-price-per-hour/34646">this thread</a></em>):</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">type</span>: <span style="color:#ae81ff">vertical-stack</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">cards</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">type</span>: <span style="color:#ae81ff">markdown</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">alignment</span>: <span style="color:#ae81ff">justify</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">content</span>: &gt;-<span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      {% set priceListToday =
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      state_attr(&#39;sensor.nordpool_kwh_oslo_nok_2_10_025&#39;, &#39;today&#39;)[00:23] %} {%
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      set dateListToday = state_attr(&#39;sensor.nordpool_kwh_oslo_nok_2_10_025&#39;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      &#39;raw_today&#39;)[00:23] %} {% set minPriceToday = min(priceListToday) %} {%
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      set minIndexToday = priceListToday.index(minPriceToday) %} {% set
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      minDateTimeStrToday = dateListToday[minIndexToday].start | string %} {%
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      set minDateTimeToday= strptime(minDateTimeStrToday[0:19], &#39;%Y-%m-%d
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      %H:%M:%S&#39;) %}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      Самая низкая цена сегодня: **{{ minPriceToday }}**
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      NOK/kWh в **{{ minDateTimeToday.hour }}:00**.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      {% if state_attr(&#39;sensor.nordpool_kwh_oslo_nok_2_10_025&#39;,&#39;tomorrow&#39;) |
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      length &gt; 1 %} {% set priceListTomorrow =
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      state_attr(&#39;sensor.nordpool_kwh_oslo_nok_2_10_025&#39;, &#39;tomorrow&#39;)[00:23] %}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      {% set dateListTomorrow =
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      state_attr(&#39;sensor.nordpool_kwh_oslo_nok_2_10_025&#39;, &#39;raw_tomorrow&#39;)[00:23]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      %} {% set minPriceTomorrow = min(priceListTomorrow) %} {% set
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      minIndexTomorrow = priceListTomorrow.index(minPriceTomorrow) %} {% set
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      minDateTimeStrTomorrow = dateListTomorrow[minIndexTomorrow].start | string
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      %} {% set minDateTimeTomorrow = strptime(minDateTimeStrTomorrow[0:19],
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      &#39;%Y-%m-%d %H:%M:%S&#39;) %}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      Самая низкая цена завтра: **{{ minPriceTomorrow
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      }}** NOK/kWh в **{{ minDateTimeTomorrow.hour }}:00**. {% else %} *На
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      завтра цен пока нет.* {% endif %}</span>      
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">type</span>: <span style="color:#ae81ff">markdown</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">alignment</span>: <span style="color:#ae81ff">justify</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">content</span>: &gt;-<span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      {% set iterativesum = namespace(iter=[]) %} {% set lowestiter =
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      namespace(kr=2) %} {% set timelowest = namespace(hr=2) %} {% set
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      highestiter = namespace(kr=0) %} {% set timehighest = namespace(hr=0) %}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      {% set num_hours = 4 | int %} {% set nordpoolentity =
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      &#39;sensor.nordpool_kwh_oslo_nok_2_10_025&#39; %} {% set timemapper = { 0:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      &#39;00:00&#39;, 1 : &#39;01:00&#39;, 2 : &#39;02:00&#39;, 3 : &#39;03:00&#39;, 4 : &#39;04:00&#39;, 5 : &#39;05:00&#39;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      6 : &#39;06:00&#39;, 7 : &#39;07:00&#39;, 8 : &#39;08:00&#39;, 9 : &#39;09:00&#39;, 10 : &#39;10:00&#39;, 11 :
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      &#39;11:00&#39;, 12 : &#39;12:00&#39;, 13 : &#39;13:00&#39;, 14 : &#39;14:00&#39;, 15 : &#39;15:00&#39;, 16 :
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      &#39;16:00&#39;, 17 : &#39;17:00&#39;, 18 : &#39;18:00&#39;, 19 : &#39;19:00&#39;, 20 : &#39;20:00&#39;, 21 :
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      &#39;21:00&#39;, 22 : &#39;22:00&#39;, 23 : &#39;23:00&#39;, 24 : &#39;00:00&#39;, 25 : &#39;01:00&#39;, 26 :
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      &#39;02:00&#39;, 27 : &#39;03:00&#39;, 28 : &#39;04:00&#39;, 29 : &#39;05:00&#39;, 30 : &#39;06:00&#39;, 31 :
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      &#39;07:00&#39;, 32 : &#39;08:00&#39;, 33 : &#39;09:00&#39;, 34 : &#39;10:00&#39;, 35 : &#39;11:00&#39;, 36 :
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      &#39;12:00&#39;, 37 : &#39;13:00&#39;, 38 : &#39;14:00&#39;, 39 : &#39;15:00&#39;, 40 : &#39;16:00&#39;, 41 :
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      &#39;17:00&#39;, 42 : &#39;18:00&#39;, 43 : &#39;19:00&#39;, 44 : &#39;20:00&#39;, 45 : &#39;21:00&#39;, 46 :
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      &#39;22:00&#39;, 47 : &#39;23:00&#39;, 48 : &#39;0:00&#39;, } %} {% set prices =
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      namespace(price=[]) %} {% set prices.price = prices.price +
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      state_attr(nordpoolentity, &#39;today&#39;) %} {%- if
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      state_attr(nordpoolentity,&#39;tomorrow&#39;) | length == 1 -%} *На завтра цен
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      пока нет.* {% else %} {% set prices.price = prices.price +
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      state_attr(nordpoolentity, &#39;tomorrow&#39;) %} {% endif %} {%- for n in
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      range(prices.price|length -num_hours +1) -%} {%- set tempsum=
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      namespace(temp=0) -%} {%- for i in range(num_hours) -%} {%- set
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      tempsum.temp = tempsum.temp + prices.price[n+i] -%} {% endfor -%} {% set
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      iterativesum.iter = iterativesum.iter + [tempsum.temp] -%} {% endfor -%}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      {% for iter in iterativesum.iter -%} {%- if loop.index &gt; now().hour -%}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      {%- if iter &lt; lowestiter.kr | float -%} {%- set lowestiter.kr = iter |
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      float -%} {%- set timelowest.hr = loop.index -1 -%} {%- endif -%} {%- if
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      iter &gt; highestiter.kr | float -%} {%- set highestiter.kr = iter | float
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      -%} {%- set timehighest.hr = loop.index -1 -%} {%- endif -%} {%- endif -%}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      {% endfor -%}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      Самые дешёвые **{{num_hours}}** часа {% if (timelowest.hr &lt;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      24) %}сегодня{% else %}будут завтра{% endif %}: с
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      **{{timemapper[timelowest.hr]}}** (*в среднем по
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      **{{&#34;%.2f&#34;|format(lowestiter.kr/num_hours)}}** NOK/kWh*).
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      Самые дорогие **{{num_hours}}** часа {% if (timehighest.hr &lt; 24)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      %}сегодня{% else %}будут завтра{% endif %}: с
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      **{{timemapper[timehighest.hr]}}** (*в среднем по
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      **{{&#34;%.2f&#34;|format(highestiter.kr/num_hours)}}** NOK/kWh*).</span>      
</span></span></code></pre></div><p>Sorry for the russian parts (<em>if it is of any comfort, the original code was in finnish language</em>) and especially for the ugly formatting, but Home Assistant keeps reformatting the code on saving the card, so there is no point in trying to make it look nice.</p>
<h1 id="organizing-dashboards">Organizing dashboards</h1>
<p>Eventually you&rsquo;ll probably want to change the dashboards layout, in particular almost immediately I wanted to have a 2-column layout with the second column being wider. And surprisingly, that isn&rsquo;t possible/trivial to do out of the box.</p>
<p>Fortunately, there is a <a href="https://github.com/thomasloven/lovelace-layout-card">layout-card</a> frontend plugin, which can be installed via <a href="#home-assistant-community-store">HACS</a>. It probably offers more than what I am using it for, but for me the <a href="https://github.com/thomasloven/lovelace-layout-card?tab=readme-ov-file#grid-layout">grid layout</a> was enough, so now I can organize my cards like this:</p>


    <img class="image-post" loading="lazy" src="/blog/2024/08/16/home-assistant-on-vero-with-docker/images/layout-card-grid.png" alt="Home Assistant, dashboard with grid layout">

<p>The code for this:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">views</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">title</span>: <span style="color:#ae81ff">Home</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">cards</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">...</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">...</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">type</span>: <span style="color:#ae81ff">custom:grid-layout</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">layout</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">grid-template-columns</span>: <span style="color:#ae81ff">35</span><span style="color:#ae81ff">% auto</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">grid-template-rows</span>: <span style="color:#ae81ff">auto</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">mediaquery</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&#39;(max-width</span>: <span style="color:#f92672">800px)&#39;</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">grid-template-columns</span>: <span style="color:#ae81ff">100</span><span style="color:#ae81ff">%</span>
</span></span></code></pre></div><h1 id="backups">Backups</h1>
<p>Having configured so many things, you should definitely think about backups.</p>
<p>I&rsquo;ve come up with the following script:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ mkdir /root/_backups
</span></span><span style="display:flex;"><span>$ sudo nano /root/_backups/backup.sh
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#75715e">#!/bin/bash
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>dt<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;</span><span style="color:#66d9ef">$(</span>date +%Y.%m.%d-%H%M%S<span style="color:#66d9ef">)</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>backupname<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;vero-backup_</span>$dt<span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>workingdir<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;/root/_backups/</span>$backupname<span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>mkdir -p $workingdir
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Home Assistant and friends</span>
</span></span><span style="display:flex;"><span>tar -czf $workingdir/home-assistant.tar.gz <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    /root/homeassistant <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    /root/mosquitto <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    /root/zigbee2mqtt
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># NGINX</span>
</span></span><span style="display:flex;"><span>tar -czf $workingdir/nginx.tar.gz <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    /etc/nginx/sites-available/* <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    /etc/nginx/mime.types <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    /etc/nginx/nginx.conf
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># OSMC (given that it makes backups in this folder)</span>
</span></span><span style="display:flex;"><span>cp /home/osmc/backups/* $workingdir/
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># cron</span>
</span></span><span style="display:flex;"><span>cp /var/spool/cron/crontabs/* $workingdir/
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># the script itself</span>
</span></span><span style="display:flex;"><span>cp /root/_backups/backup.sh $workingdir/
</span></span></code></pre></div><p>and made it run on schedule:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ sudo crontab -e
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#ae81ff">1</span> <span style="color:#ae81ff">1</span> */20 * * /root/_backups/backup.sh
</span></span><span style="display:flex;"><span><span style="color:#75715e"># or with Healthchecks reporting: https://github.com/retifrav/scraps/blob/master/_linux/installing-healthchecks/index.md</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#1 1 */20 * * /root/_backups/backup.sh &gt; /dev/null 2&gt;&amp;1 &amp;&amp; /usr/bin/curl -X POST -fsS -m 10 --retry 5 -o /dev/null https://healthchecks.YOUR.DOMAIN/ping/ID/vero-backup</span>
</span></span></code></pre></div><p>It would also be a good idea to upload/download the backups from the device to some reliable external storage.</p>
<h1 id="performance-monitoring-with-btop">Performance monitoring with btop</h1>
<p>As a bonus part, I wanted to install <a href="https://github.com/aristocratos/btop">btop</a> tool for watching the system CPU load.</p>
<p>There is no(?) pre-built package for btop on Debian, so I had to build it from sources, and for that it needs some tools and dependencies to be installed first, out of which CMake I also had to build from sources, because packaged version <code>3.18.4</code> is a bit old, and btop requires at least <code>3.24</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ sudo apt install build-essential libssl-dev ninja-build
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ cd ~/downloads
</span></span><span style="display:flex;"><span>$ wget https://github.com/Kitware/CMake/releases/download/v3.30.2/cmake-3.30.2.tar.gz
</span></span><span style="display:flex;"><span>$ tar -xvf ./cmake-3.30.2.tar.gz
</span></span><span style="display:flex;"><span>$ rm ./cmake-3.30.2.tar.gz
</span></span><span style="display:flex;"><span>$ mv ./cmake-3.30.2 ~/programs/cmake
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ cd ~/programs/cmake
</span></span><span style="display:flex;"><span>$ ./bootstrap
</span></span><span style="display:flex;"><span>$ make -j<span style="color:#66d9ef">$(</span>nproc<span style="color:#66d9ef">)</span>
</span></span><span style="display:flex;"><span>$ sudo make install
</span></span></code></pre></div><p>Then building <code>btop</code> itself:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ cd ~/programs
</span></span><span style="display:flex;"><span>$ git clone https://github.com/aristocratos/btop
</span></span><span style="display:flex;"><span>$ cd ./btop
</span></span><span style="display:flex;"><span>$ git checkout v1.3.2
</span></span><span style="display:flex;"><span>$ mkdir build <span style="color:#f92672">&amp;&amp;</span> cd $_
</span></span><span style="display:flex;"><span>$ cmake -G Ninja -DCMAKE_BUILD_TYPE<span style="color:#f92672">=</span>Release -DBTOP_GPU<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span> ..
</span></span><span style="display:flex;"><span>$ cmake --build .
</span></span><span style="display:flex;"><span>$ sudo cmake --install .
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ cd ~
</span></span><span style="display:flex;"><span>$ btop --version
</span></span><span style="display:flex;"><span>btop version: 1.3.2
</span></span></code></pre></div><p>To measure the CPU load, I kept it monitoring the system performance for several minutes while playing a 4K movie and running Docker containers with Home Assistant and its components:</p>


    <img class="image-post" loading="lazy" src="/blog/2024/08/16/home-assistant-on-vero-with-docker/images/btop-metrics.png" alt="Home Assistant on Vero V, CPU load in btop">

<p>And it barely broke any sweat.</p>
      </div>
    </article>
    <div><div id="tags">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tag">
  <path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path><line x1="7" y1="7" x2="7" y2="7"></line>
</svg>
          <a class="tag" href="https://retifrav.github.io/tags/home-automation/">home-automation</a><a class="tag" href="https://retifrav.github.io/tags/linux/">linux</a><a class="tag" href="https://retifrav.github.io/tags/norway/">norway</a></div><hr class="comments-divider"/>
      <div id="comments">
      
          <div style="border:2px orange solid; background-color: floralwhite; border-radius:0.5rem; padding: 10px 14px; font-style:italic; font-size:0.9em;">
              If you'd like to comment the article, you can do it on the
              <a href="https://decovar.dev/blog/2024/08/16/home-assistant-on-vero-with-docker/#remark42" style="font-weight:bold;">
                  original website</a>. This one is just a mirror without comments.
          </div>
      
      </div>
    </div>
  </div>

        <div id="footer">
          <div>
              2014 - 2024,
              <a href="/about/">retif</a>
          </div>
          <div><a href="/about/#licenses">CC BY-SA 4.0 / GPLv3</a></div>
        </div>
      </main>
      <div class="app-header">
        <div style="margin:0 0 20px;">
            <input id="search-query" placeholder="Search in titles and summaries" />
        </div>
        <div id="search-results" style="display:none;"></div>
        <div id="sidebars">
            <a id="avatar" href="/about"><img class="app-header-avatar" src="/images/avatar.png" /></a>
            <iframe src="https://github.com/sponsors/retifrav/button"
                height="35" style="border:0;"
                title="You can sponsor me">
            </iframe>
            
            <div class="sidebar-section">
              <h3>Feeds</h3>
              <a href="/index.xml" title="Subscribe to RSS"><img src="/images/rss.png" width="50px"></a>
              <a style="margin-left: 5px;" href="https://t.me/decovar" title="Telegram channel"><img src="/images/telegram.png" width="50px"></a>
            </div>
            <div id="telegramWidgetBlock" class="sidebar-section"></div>
            <div class="sidebar-section">
                <h3>Stuff</h3>
                <ul class="sidebar-list">
                    <li><a href="/stuff/kakoi-jvotne-vi-kysaiti/index.html">КАКОИ ЖВОТНЕ ВЫ КУСАИТИ?</a></li>
                </ul>
            </div>
            <div id="social-networks" class="sidebar-section">
              <h3>Social networks</h3>
              <div style="font-family:Courier New;">
                  Zuck: <i>Yeah so if you ever need info about anyone at Harvard</i><br/>
                  Zuck: <i>Just ask</i><br/>
                  Zuck: <i>I have over 4,000 emails, pictures, addresses, SNS</i><br/>
                  smb: <i>What? How'd you manage that one?</i><br/>
                  Zuck: <i>People just submitted it.</i><br/>
                  Zuck: <i>I don't know why.</i><br/>
                  Zuck: <i>They "trust me"</i><br/>
                  Zuck: <i>Dumb fucks</i>
              </div>
            </div>
            <div class="sidebar-section">
              <h3>Tags</h3>
              <ul style="list-style-type:none; padding:0; margin:0;">
                  
                  <li><a href="/tags/web">web (67)</a></li>
                  
                  <li><a href="/tags/fail">fail (40)</a></li>
                  
                  <li><a href="/tags/dotnet">dotnet (36)</a></li>
                  
                  <li><a href="/tags/qt">qt (35)</a></li>
                  
                  <li><a href="/tags/linux">linux (28)</a></li>
                  
                  <li><a href="/tags/review">review (28)</a></li>
                  
                  <li><a href="/tags/devops">devops (23)</a></li>
                  
                  <li><a href="/tags/macos">macos (23)</a></li>
                  
                  <li><a href="/tags/windows">windows (19)</a></li>
                  
                  <li><a href="/tags/mestuff">mestuff (17)</a></li>
                  
                  <li><a href="/tags/movies">movies (15)</a></li>
                  
                  <li><a href="/tags/norway">norway (15)</a></li>
                  
                  <li><a href="/tags/tractor">tractor (15)</a></li>
                  
                  <li><a href="/tags/cpp">cpp (12)</a></li>
                  
                  <li><a href="/tags/irl">irl (12)</a></li>
                  
                  <li><a href="/tags/python">python (12)</a></li>
                  
                  <li><a href="/tags/telegram">telegram (12)</a></li>
                  
                  <li><a href="/tags/cmake">cmake (11)</a></li>
                  
                  <li><a href="/tags/embedded">embedded (11)</a></li>
                  
                  <li><a href="/tags/soft">soft (10)</a></li>
                  
                  <li><a href="/tags/travel">travel (10)</a></li>
                  
                  <li><a href="/tags/applescript">applescript (9)</a></li>
                  
                  <li><a href="/tags/piracy">piracy (9)</a></li>
                  
                  <li><a href="/tags/octopress">octopress (8)</a></li>
                  
                  <li><a href="/tags/banks">banks (7)</a></li>
                  
                  <li><a href="/tags/games">games (7)</a></li>
                  
                  <li><a href="/tags/ios">ios (7)</a></li>
                  
                  <li><a href="/tags/apple">apple (6)</a></li>
                  
                  <li><a href="/tags/javascript">javascript (6)</a></li>
                  
                  <li><a href="/tags/photo">photo (6)</a></li>
                  
                  <li><a href="/tags/sql">sql (6)</a></li>
                  
                  <li><a href="/tags/russia">russia (5)</a></li>
                  
                  <li><a href="/tags/android">android (4)</a></li>
                  
                  <li><a href="/tags/hugo">hugo (4)</a></li>
                  
                  <li><a href="/tags/usa">usa (4)</a></li>
                  
                  <li><a href="/tags/wordpress">wordpress (4)</a></li>
                  
                  <li><a href="/tags/azure">azure (3)</a></li>
                  
                  <li><a href="/tags/tv">tv (3)</a></li>
                  
                  <li><a href="/tags/privacy">privacy (2)</a></li>
                  
                  <li><a href="/tags/steam-deck">steam-deck (2)</a></li>
                  
                  <li><a href="/tags/tvos">tvos (2)</a></li>
                  
                  <li><a href="/tags/unsolved">unsolved (2)</a></li>
                  
                  <li><a href="/tags/books">books (1)</a></li>
                  
                  <li><a href="/tags/ffmpeg">ffmpeg (1)</a></li>
                  
                  <li><a href="/tags/home-automation">home-automation (1)</a></li>
                  
                  <li><a href="/tags/ldap">ldap (1)</a></li>
                  
                  <li><a href="/tags/music">music (1)</a></li>
                  
                  <li><a href="/tags/science">science (1)</a></li>
                  
                  <li><a href="/tags/vr">vr (1)</a></li>
                  
              </ul>
            </div>
        </div>
      </header>
    </div>

    <script src="/js/search.js"></script>

    
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-53340325-1"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag() { dataLayer.push(arguments); }
      gtag("js", new Date());
      gtag("config", "UA-53340325-1");
    </script>

    <script>
        const telegramBlock = document.getElementById("telegramWidgetBlock");
        window.onload = () =>
        {
            const pinnedTelegramPosts = [328]
            const randomedPostID = pinnedTelegramPosts[
                Math.floor(Math.random() * pinnedTelegramPosts.length)
            ];
            const telegramWidgetScript = document.createElement("script");
            telegramWidgetScript.src = "https://telegram.org/js/telegram-widget.js?21";
            telegramWidgetScript.dataset["telegramPost"] = `decovar/${randomedPostID}`;
            telegramWidgetScript.dataset["color"] = "1E8448";
            telegramWidgetScript.dataset["width"] = "100%";
            telegramWidgetScript.dataset["userpic"] = "false";
            telegramBlock.appendChild(telegramWidgetScript);
        }
    </script>

    
    
  </body>
</html>
