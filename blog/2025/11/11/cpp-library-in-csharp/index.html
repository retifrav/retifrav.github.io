<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>C&#43;&#43; library in a .NET/C# project with CMake | Declaration of VAR</title>
    <link rel="canonical" href="https://decovar.dev/blog/2025/11/11/cpp-library-in-csharp/" />

    <meta name="generator" content="Hugo" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <link href="/favicon.png" rel="icon">

    <meta name="author" content="retif" />
    <meta name="description" content="A C&#43;&#43; library can be used in a .NET/C# project, which shouldn&#39;t be any news, but it isn&#39;t very common to see how both C&#43;&#43; and C# targets can be handled in the same project with CMake, so I wanted to try that out. And it does work, although some things are only supported on Windows (including the CMake part, unfortunately)." />

    <link rel="alternate" type="application/rss+xml" href="/index.xml" title="Declaration of VAR" />

    <meta property="og:url" content="https://retifrav.github.io/blog/2025/11/11/cpp-library-in-csharp/">
  <meta property="og:site_name" content="Declaration of VAR">
  <meta property="og:title" content="C&#43;&#43; library in a .NET/C# project with CMake">
  <meta property="og:description" content="A C&#43;&#43; library can be used in a .NET/C# project, which shouldn&#39;t be any news, but it isn&#39;t very common to see how both C&#43;&#43; and C# targets can be handled in the same project with CMake, so I wanted to try that out. And it does work, although some things are only supported on Windows (including the CMake part, unfortunately).">
  <meta property="og:locale" content="en_us">
  <meta property="og:type" content="article">
    <meta property="article:section" content="blog">
    <meta property="article:published_time" content="2025-11-11T21:13:47+01:00">
    <meta property="article:modified_time" content="2025-11-11T21:13:47+01:00">
    <meta property="article:tag" content="Cpp">
    <meta property="article:tag" content="Dotnet">
    <meta property="article:tag" content="Cmake">


    <link rel="stylesheet" href="https://retifrav.github.io/css/main.min.2a28493e0b91076cde9fb52cb7fec81f63f685a6965e6a9df1179ec846b9141f.css" />
    <link rel="stylesheet" href="/css/default.css" />
    <link rel="stylesheet" href="/css/post.css" />
    <link rel="stylesheet" href="/css/page.css" />
    <link rel="stylesheet" href="/css/comments.css" />

    <script src="/js/mark.js"></script>

    
    
  </head>
  <body>
    <div id="body-hat">
      <div id="title-block">
        <h1 id="blog-title"><a href="/">Declaration of VAR</a></h1>
        <p>and some other stuff</p>
      </div>
    </div>
    <div style="background-color:orange; padding:4px 16px; font-size:0.8em; text-align:center; font-style:italic;">
        On 19.05.2021 the website was moved to
        <a href="https://decovar.dev/blog/2025/11/11/cpp-library-in-csharp/" style="color:black; font-weight:bold;">
            https://decovar.dev/</a>. This is just a mirror now.
    </div>
    <div id="body-flex">
      <main class="app-container">
        
  <div id="main-container">
    <article class="post">
      <header class="post-header">
        <h1 class ="post-title">C&#43;&#43; library in a .NET/C# project with CMake</h1>
        <div class="post-meta">
          <div><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-calendar">
  <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line>
</svg> 2025-11-11 21:13:47 &#43;0100</div>
          <div><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-clock">
  <circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline>
</svg> 42 min read</div>
        </div>
      </header>
      <div class="post-content">
        <p><a href="/blog/2024/02/12/cpp-library-in-android-application/">Last time</a> I needed to use a C++ library in an Android project, and now came a request for the very same C++ library to be used in a .NET/C# project.</p>


    <img class="image-post" loading="lazy" src="/blog/2025/11/11/cpp-library-in-csharp/images/cmake-cpp-csharp.jpg" alt="CMake, C&#43;&#43; and C#">

<p>Good news is that it is possible to handle both C++ and C# targets in a single CMake project, which makes the maintenance much easier: no need to involve a yet another build system, not need to use an IDE - everything can be done with CMake and bare CLI. Bad news is that some things will work only on Windows.</p>
<nav id="TableOfContents">
  <ul>
    <li><a href="#base-project">Base project</a>
      <ul>
        <li><a href="#native-c-library">Native C++ library</a></li>
        <li><a href="#c-library">C# library</a>
          <ul>
            <li><a href="#setting-net-sdk-and-language-version">Setting .NET SDK and language version</a></li>
            <li><a href="#cmake-generator-platform">CMake generator platform</a></li>
          </ul>
        </li>
        <li><a href="#c-application">C# application</a>
          <ul>
            <li><a href="#referencing-nuget-packages">Referencing NuGet packages</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#calling-c-from-c">Calling C++ from C#</a>
      <ul>
        <li><a href="#pinvoke">P/Invoke</a>
          <ul>
            <li><a href="#c-api-wrapper">C API wrapper</a></li>
            <li><a href="#importing-c-api-wrapper-dll">Importing C API wrapper DLL</a></li>
          </ul>
        </li>
        <li><a href="#ccli-clr">C++/CLI CLR</a>
          <ul>
            <li><a href="#c-wrapper">C++ wrapper</a></li>
            <li><a href="#linking-c-wrapper-dll">Linking C++ wrapper DLL</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#putting-it-all-together">Putting it all together</a>
      <ul>
        <li><a href="#fighting-with-encoding">Fighting with encoding</a>
          <ul>
            <li><a href="#marshalling-utf-8-strings-via-c-api">Marshalling UTF-8 strings via C API</a></li>
            <li><a href="#marshalling-utf-8-strings-via-ccli">Marshalling UTF-8 strings via C++/CLI</a></li>
          </ul>
        </li>
        <li><a href="#installation">Installation</a>
          <ul>
            <li><a href="#installing-c-library">Installing C# library</a></li>
            <li><a href="#installing-c-application">Installing C# application</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#platforms-other-than-windows">Platforms other than Windows</a>
      <ul>
        <li><a href="#adapting-cmake-project-files">Adapting CMake project files</a></li>
        <li><a href="#creating-msbuild-project-files">Creating MSBuild project files</a>
          <ul>
            <li><a href="#runtime-paths">Runtime paths</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#maui">MAUI</a></li>
  </ul>
</nav>
<h1 id="base-project">Base project</h1>
<p>The idea is the same as it was with Android: native C++ library is integrated/wrapped into a .NET/C# library, which then can be used in a .NET/C# project to call the that native C++ library functions.</p>
<p>If anything, this is my .NET environment on Windows:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ dotnet --info
</span></span><span style="display:flex;"><span>.NET SDK:
</span></span><span style="display:flex;"><span> Version:           9.0.304
</span></span><span style="display:flex;"><span> Commit:            f12f5f689e
</span></span><span style="display:flex;"><span> Workload version:  9.0.300-manifests.ad61bb1c
</span></span><span style="display:flex;"><span> MSBuild version:   17.14.16+5d8159c5f
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Runtime Environment:
</span></span><span style="display:flex;"><span> OS Name:     Windows
</span></span><span style="display:flex;"><span> OS Version:  10.0.22000
</span></span><span style="display:flex;"><span> OS Platform: Windows
</span></span><span style="display:flex;"><span> RID:         win-x64
</span></span><span style="display:flex;"><span> Base Path:   C:<span style="color:#ae81ff">\P</span>rogram Files<span style="color:#ae81ff">\d</span>otnet<span style="color:#ae81ff">\s</span>dk<span style="color:#ae81ff">\9</span>.0.304<span style="color:#ae81ff">\
</span></span></span></code></pre></div><h2 id="native-c-library">Native C++ library</h2>
<p>Let&rsquo;s take the same <a href="https://github.com/retifrav/csharp-cpp-example/tree/eafc7860c50ed6def894b00e26e84b35673eba87/cpp/library">C++ library</a> as the last time:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>./cpp/library/
</span></span><span style="display:flex;"><span>├── include
</span></span><span style="display:flex;"><span>│   └── Thingy
</span></span><span style="display:flex;"><span>│       └── thingy.h
</span></span><span style="display:flex;"><span>├── src
</span></span><span style="display:flex;"><span>│   ├── stuff.h
</span></span><span style="display:flex;"><span>│   └── thingy.cpp
</span></span><span style="display:flex;"><span>├── CMakeLists.txt
</span></span><span style="display:flex;"><span>└── Config.cmake.in
</span></span></code></pre></div><p>The library type does not have to be <a href="https://github.com/retifrav/csharp-cpp-example/blob/eafc7860c50ed6def894b00e26e84b35673eba87/cpp/library/CMakeLists.txt#L4">hardcoded</a> to <code>SHARED</code>, and there will be some more details about this <a href="#c-api-wrapper">later</a>.</p>
<p>Also, library has a <a href="https://github.com/retifrav/csharp-cpp-example/blob/eafc7860c50ed6def894b00e26e84b35673eba87/cpp/library/CMakeLists.txt#L28-L32">dependency</a> of its own - just for the sake of demonstrating how to deal with 3rd-party dependencies and also to give the library some meaningful functionality aside from simply printing to <code>stdout</code>. Like the <a href="/blog/2024/02/12/cpp-library-in-android-application/#transitive-dependencies">last time</a>, the dependency is <a href="https://github.com/open-source-parsers/jsoncpp">JsonCpp</a>, and of course it is resolved with <a href="/blog/2022/10/30/cpp-dependencies-with-vcpkg/">vcpkg</a>.</p>
<p>Having built it as usual:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ cd /path/to/csharp-cpp-example/
</span></span><span style="display:flex;"><span>$ mkdir build <span style="color:#f92672">&amp;&amp;</span> cd $_
</span></span><span style="display:flex;"><span>$ cmake -G <span style="color:#e6db74">&#34;Visual Studio 17 2022&#34;</span> -DCMAKE_INSTALL_PREFIX<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;../install&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span>    -DCMAKE_TOOLCHAIN_FILE<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;</span>$VCPKG_ROOT<span style="color:#e6db74">/scripts/buildsystems/vcpkg.cmake&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span>    ..
</span></span><span style="display:flex;"><span>$ cmake --build . --config Release
</span></span></code></pre></div><p>you&rsquo;ll get the following <code>thingy.dll</code> binary, as expected:</p>


    <img class="image-post" loading="lazy" src="/blog/2025/11/11/cpp-library-in-csharp/images/die-thingy-dll.png" alt="Detect It Easy, thingy.dll">

<p>Using Visual Studio generator isn&rsquo;t required at this stage, but later the project will have to be configured with exactly a Visual Studio generator (<em>as long as this is for building on Windows</em>), so you might just as well start using it already now.</p>
<p>As I already said, this library does not have to be a DLL, it will &ldquo;work&rdquo; as a static <code>.lib</code> archive too, but for starters let&rsquo;s proceed with everything being a DLL.</p>
<p>Later in the article we&rsquo;ll be referring to this library as the &ldquo;native&rdquo; one.</p>
<h2 id="c-library">C# library</h2>
<p>The base <a href="https://github.com/retifrav/csharp-cpp-example/tree/0cbd29405a93e803fdf67945034c2c32e0cdaef6/csharp/library">C# library</a> is dead simple:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>./csharp/library/
</span></span><span style="display:flex;"><span>├── src
</span></span><span style="display:flex;"><span>│   └── Some.cs
</span></span><span style="display:flex;"><span>└── CMakeLists.txt
</span></span></code></pre></div><p>where the only source file <code>Some.cs</code> contains the following:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cs" data-lang="cs"><span style="display:flex;"><span><span style="color:#66d9ef">using</span> System;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">namespace</span> Lbr;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Some</span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">string</span> getSome()
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#34;a string from C#&#34;</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>And the CMake project file is what you would expect to see in a regular C++ library project:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cmake" data-lang="cmake"><span style="display:flex;"><span>add_library(<span style="color:#e6db74">some</span> <span style="color:#e6db74">SHARED</span>) <span style="color:#75715e"># here it has to be hardcoded to `SHARED`, since this is for .NET
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span>target_sources(<span style="color:#e6db74">some</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">PRIVATE</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">src/Some.cs</span>
</span></span><span style="display:flex;"><span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div><p>But an important specific here is that the library type has to be <code>SHARED</code>, because it is expected to produce a <a href="https://learn.microsoft.com/en-us/dotnet/standard/assembly/">.NET assembly</a>, which should be a DLL. If you try to configure the project with the library type hardcoded to <code>STATIC</code> or without <code>BUILD_SHARED_LIBS</code> being set, then it will fail:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>CMake Deprecation Warning in library-csharp/CMakeLists.txt:
</span></span><span style="display:flex;"><span>  The C# target <span style="color:#e6db74">&#34;some&#34;</span> is of type STATIC_LIBRARY.  This is discouraged <span style="color:#f92672">(</span>and
</span></span><span style="display:flex;"><span>  may be disabled in future<span style="color:#f92672">)</span>.  Make it a SHARED library instead.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>CMake Error in library-csharp/CMakeLists.txt:
</span></span><span style="display:flex;"><span>  Target <span style="color:#e6db74">&#34;some&#34;</span> is of a type not supported <span style="color:#66d9ef">for</span> managed binaries.
</span></span></code></pre></div><h3 id="setting-net-sdk-and-language-version">Setting .NET SDK and language version</h3>
<p>While the library project is very trivial, making it actually build with CMake isn&rsquo;t so trivial. First you need to enable <code>CSharp</code> language: either with <code>project(some LANGUAGES CSharp)</code> or with <code>enable_language(CSharp)</code> (<em>I went with <a href="https://github.com/retifrav/csharp-cpp-example/blob/eafc7860c50ed6def894b00e26e84b35673eba87/csharp/CMakeLists.txt#L1">that</a></em>).</p>
<p>Then I took the wrong way and tried to specify the .NET SDK version with <a href="https://cmake.org/cmake/help/latest/variable/CMAKE_DOTNET_TARGET_FRAMEWORK_VERSION.html">CMAKE_DOTNET_TARGET_FRAMEWORK_VERSION</a> variable:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cmake" data-lang="cmake"><span style="display:flex;"><span>set(<span style="color:#e6db74">CMAKE_DOTNET_TARGET_FRAMEWORK_VERSION</span> <span style="color:#e6db74">&#34;net9.0&#34;</span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div><p>I mean, can you really blame a girl for expecting this varaible to be the right one, given that it contains words &ldquo;<em>target</em>&rdquo; and &ldquo;<em>version</em>&rdquo;? But no, this is not the right one, because even though the project will configure and <code>.sln</code>/<code>.csproj</code> files will be generated, the build will then fail like this:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>error MSB4184: The expression <span style="color:#e6db74">&#34;[MSBuild]::VersionGreaterThanOrEquals(net9.0, 4.0)&#34;</span> can not be evaluated. Version string was not in a correct format.
</span></span></code></pre></div><p>You might think that this is because instead of <code>net9.0</code> there should be <code>9.0</code>, but if you&rsquo;ll try again with a corrected value, then you&rsquo;ll get this warning:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>warning MSB3971: The reference assemblies <span style="color:#66d9ef">for</span> <span style="color:#e6db74">&#34;.NETFramework,Version=v9.0&#34;</span> were not found. You might be using an older .NET SDK to target .NET 5.0 or higher
</span></span></code></pre></div><p>which means that something is still wrong with the .NET SDK version, and also you might get errors like this one:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>error CS8370: Feature <span style="color:#e6db74">&#39;file-scoped namespace&#39;</span> is not available in C# 7.3. Please use language version 10.0 or greater.
</span></span></code></pre></div><p>which also indicates a wrong version of the .NET SDK. If you are curious which language version is actually used in your current .NET SDK, you can list then all like this (<em>from <a href="https://learn.microsoft.com/en-us/visualstudio/ide/reference/command-prompt-powershell">Visual Studio Developer Command Prompt</a></em>):</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ps" data-lang="ps"><span style="display:flex;"><span>&gt; <span style="color:#a6e22e">csc.exe</span> /langversion:?
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">Supported</span> <span style="color:#a6e22e">language</span> <span style="color:#a6e22e">versions:</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">default</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">3</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">4</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">5</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">6</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">7.0</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">7.1</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">7.2</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">7.3</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">8.0</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">9.0</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">10.0</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">11.0</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">12.0</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">13.0</span> <span style="color:#e6db74">(default)</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">latestmajor</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">preview</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">latest</span>
</span></span></code></pre></div><p>and then you could set it in CMake:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cmake" data-lang="cmake"><span style="display:flex;"><span><span style="color:#75715e"># might be tempting to set `latest` instead of `13`, but this isn&#39;t recommended
</span></span></span><span style="display:flex;"><span>string(<span style="color:#e6db74">APPEND</span> <span style="color:#e6db74">CMAKE_CSharp_FLAGS</span> <span style="color:#e6db74">&#34; /langversion:13&#34;</span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div><p>but that would only help with this particular language-related error, as the warnings about missing assemblies will remain, plus you&rsquo;ll get some new ones:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>warning MSB3270: There was a mismatch between the processor architecture of the project being built <span style="color:#e6db74">&#34;AMD64&#34;</span> and the processor architecture of the reference C:<span style="color:#ae81ff">\W</span>INDOWS<span style="color:#ae81ff">\M</span>icrosoft.NET<span style="color:#ae81ff">\F</span>ramework<span style="color:#ae81ff">\v</span>4.0.30319<span style="color:#ae81ff">\\</span>mscorlib.dll<span style="color:#e6db74">&#34;, &#34;</span>x86<span style="color:#e6db74">&#34;. This mismatch may cause runtime failures. Please consider changing the targeted processor architecture of your project through the Configuration Manager so as to align the processor architectures between your project and references, or take a dependency on references with a processor architecture that matches the targeted processor architecture of your project. 
</span></span></span></code></pre></div><p>and moreover (<em>spoiler alert</em>), the build will fail further with a different error like:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>error CS0117: <span style="color:#e6db74">&#39;Marshal&#39;</span> does not contain a definition <span style="color:#66d9ef">for</span> <span style="color:#e6db74">&#39;PtrToStringUTF8&#39;</span>
</span></span></code></pre></div><p>&hellip;So yes, setting <code>CMAKE_DOTNET_TARGET_FRAMEWORK_VERSION</code> is not how this is supposed to be done. Instead one should explicitly set the <a href="https://cmake.org/cmake/help/latest/variable/CMAKE_DOTNET_SDK.html#variable:CMAKE_DOTNET_SDK">CMAKE_DOTNET_SDK</a> variable, because CMake <a href="https://cmake.org/cmake/help/latest/prop_tgt/DOTNET_SDK.html#prop_tgt:DOTNET_SDK">does not</a> default it to anything (<em>and isn&rsquo;t validating the value either</em>):</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cmake" data-lang="cmake"><span style="display:flex;"><span>set(<span style="color:#e6db74">CMAKE_DOTNET_SDK</span> <span style="color:#e6db74">&#34;Microsoft.NET.Sdk&#34;</span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div><p>One other problem of not setting this variable might be that if there are some NuGet packages involved (<em>there will be one <a href="#referencing-nuget-packages">later</a></em>), then the build may fail like this:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>error NU1202: Package System.CommandLine 2.0.0-rc.1.25451.107 is not compatible with net40
</span></span></code></pre></div><p>But that&rsquo;s not all, aside from <code>CMAKE_DOTNET_SDK</code> you also need to set <a href="https://cmake.org/cmake/help/latest/variable/CMAKE_DOTNET_TARGET_FRAMEWORK.html">CMAKE_DOTNET_TARGET_FRAMEWORK</a> version:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cmake" data-lang="cmake"><span style="display:flex;"><span>set(<span style="color:#e6db74">CMAKE_DOTNET_TARGET_FRAMEWORK</span> <span style="color:#e6db74">&#34;net9.0&#34;</span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div><p>Without it you&rsquo;ll get warnings like this:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>warning NETSDK1138: The target framework <span style="color:#e6db74">&#39;net5.0&#39;</span> is out of support and will not receive security updates in the future.
</span></span></code></pre></div><p>and, again, language-related errors:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>error CS8370: Feature <span style="color:#e6db74">&#39;file-scoped namespace&#39;</span> is not available in C# 7.3. Please use language version 10.0 or greater.
</span></span></code></pre></div><p>Also, you might mistakenly set it to <code>9.0</code> instead if <code>net9.0</code>, in which case you&rsquo;ll get this error:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>error NU1105: Invalid target framework <span style="color:#e6db74">&#39;9.0&#39;</span>
</span></span></code></pre></div><p>But enough with the problems, here are the <a href="https://github.com/retifrav/csharp-cpp-example/blob/0cbd29405a93e803fdf67945034c2c32e0cdaef6/csharp/CMakeLists.txt#L8-L12">final statements</a> for setting the .NET SDK and language version:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cmake" data-lang="cmake"><span style="display:flex;"><span>set(<span style="color:#e6db74">CMAKE_DOTNET_SDK</span> <span style="color:#e6db74">&#34;Microsoft.NET.Sdk&#34;</span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span>set(<span style="color:#e6db74">CMAKE_DOTNET_TARGET_FRAMEWORK</span> <span style="color:#e6db74">&#34;net9.0&#34;</span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"># no need to set either of these, all of that should be taken care of by the preceding statements
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#set(CMAKE_DOTNET_TARGET_FRAMEWORK_VERSION &#34;9.0&#34;)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#string(APPEND CMAKE_CSharp_FLAGS &#34; /langversion:13&#34;)
</span></span></span></code></pre></div><p>This is it, if you&rsquo;ll now try to build the project, you&rsquo;ll get the library (<em>assembly</em>) built as <code>some.dll</code>:</p>


    <img class="image-post" loading="lazy" src="/blog/2025/11/11/cpp-library-in-csharp/images/die-some-dll.png" alt="Detect It Easy, some.dll">

<p>Note that from now on you&rsquo;ll have to use exactly a Visual Studio generator for configuring the project, as CMake supports C# only with those. Which automatically means that you won&rsquo;t be able to use CMake to handle .NET projects on <a href="#platforms-other-than-windows">platforms other than Windows</a>, since Visual Studio generators are only(?) available on Windows.</p>
<h3 id="cmake-generator-platform">CMake generator platform</h3>
<p>Some guides tell you to perform the following ritual for setting the <a href="https://cmake.org/cmake/help/latest/variable/CMAKE_GENERATOR_PLATFORM.html">CMAKE_GENERATOR_PLATFORM</a>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cmake" data-lang="cmake"><span style="display:flex;"><span>if(<span style="color:#e6db74">NOT</span> <span style="color:#e6db74">DEFINED</span> <span style="color:#e6db74">CMAKE_GENERATOR_PLATFORM</span> <span style="color:#e6db74">OR</span> <span style="color:#e6db74">CMAKE_GENERATOR_PLATFORM</span> <span style="color:#e6db74">STREQUAL</span> <span style="color:#e6db74">&#34;&#34;</span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span>    message(<span style="color:#e6db74">WARNING</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;CMAKE_GENERATOR_PLATFORM isn&#39;t set, defaulting it to AnyCPU&#34;</span>
</span></span><span style="display:flex;"><span>    )<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span>    string(<span style="color:#e6db74">APPEND</span> <span style="color:#e6db74">CMAKE_CSharp_FLAGS</span> <span style="color:#e6db74">&#34; /platform:AnyCPU&#34;</span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span>    set(<span style="color:#e6db74">CMAKE_GENERATOR_PLATFORM</span> <span style="color:#e6db74">&#34;AnyCPU&#34;</span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span>elseif(<span style="color:#e6db74">CMAKE_GENERATOR_PLATFORM</span> <span style="color:#e6db74">STREQUAL</span> <span style="color:#e6db74">&#34;x64&#34;</span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span>    string(<span style="color:#e6db74">APPEND</span> <span style="color:#e6db74">CMAKE_CSharp_FLAGS</span> <span style="color:#e6db74">&#34; /platform:x64&#34;</span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span>elseif(<span style="color:#e6db74">CMAKE_GENERATOR_PLATFORM</span> <span style="color:#e6db74">STREQUAL</span> <span style="color:#e6db74">&#34;Win32&#34;</span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span>    string(<span style="color:#e6db74">APPEND</span> <span style="color:#e6db74">CMAKE_CSharp_FLAGS</span> <span style="color:#e6db74">&#34; /platform:x86&#34;</span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span>else()<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span>    message(<span style="color:#e6db74">WARNING</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;Generator platform is set to ${CMAKE_GENERATOR_PLATFORM}, &#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;which is not supported by managed projects, defaulting to AnyCPU&#34;</span>
</span></span><span style="display:flex;"><span>    )<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span>    string(<span style="color:#e6db74">APPEND</span> <span style="color:#e6db74">CMAKE_CSharp_FLAGS</span> <span style="color:#e6db74">&#34; /platform:AnyCPU&#34;</span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span>    set(<span style="color:#e6db74">CMAKE_GENERATOR_PLATFORM</span> <span style="color:#e6db74">&#34;AnyCPU&#34;</span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span>endif()<span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div><p>but CMake seems to figure out these things on its own just fine, so I did not use that in my project. Moreover, if you try to provide some unexpected value like <code>-DCMAKE_GENERATOR_PLATFORM=ololo</code> on running CMake configuration, then it will fail on <code>project()</code> line with:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-perl" data-lang="perl"><span style="display:flex;"><span>CMake Error at CMakeLists<span style="color:#f92672">.</span>txt:3 (project):
</span></span><span style="display:flex;"><span>  Failed to run MSBuild command:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    D:<span style="color:#e6db74">/programs/</span>vs<span style="color:#e6db74">/vs2022/</span>MSBuild<span style="color:#e6db74">/Current/</span>Bin<span style="color:#e6db74">/amd64/</span>MSBuild<span style="color:#f92672">.</span>exe
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  to get the value of VCTargetsPath:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    MSBuild version <span style="color:#ae81ff">17.14.18</span><span style="color:#f92672">+</span>a338add32 <span style="color:#66d9ef">for</span> <span style="color:#f92672">.</span>NET Framework
</span></span><span style="display:flex;"><span>    Build started <span style="color:#ae81ff">27.10.2025</span> <span style="color:#ae81ff">11</span>:<span style="color:#ae81ff">34</span>:<span style="color:#ae81ff">47</span><span style="color:#f92672">.</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    Project <span style="color:#e6db74">&#34;E:\code\dotnet\csharp-cpp-example\application-csharp\build\CMakeFiles\4.1.0\VCTargetsPath.vcxproj&#34;</span> on node <span style="color:#ae81ff">1</span> (default targets)<span style="color:#f92672">.</span>
</span></span><span style="display:flex;"><span>    D:<span style="color:#f92672">\</span>programs<span style="color:#f92672">\</span>vs<span style="color:#f92672">\</span>vs2022<span style="color:#f92672">\</span>MSBuild<span style="color:#f92672">\</span>Current<span style="color:#f92672">\</span>Bin<span style="color:#f92672">\</span>amd64<span style="color:#f92672">\</span>Microsoft<span style="color:#f92672">.</span>Common<span style="color:#f92672">.</span>CurrentVersion<span style="color:#f92672">.</span>targets(<span style="color:#ae81ff">843</span>,<span style="color:#ae81ff">5</span>): error : The BaseOutputPath<span style="color:#f92672">/</span>OutputPath property is <span style="color:#f92672">not</span> set <span style="color:#66d9ef">for</span> project <span style="color:#e6db74">&#39;VCTargetsPath.vcxproj&#39;</span><span style="color:#f92672">.</span>  Please check to make sure that you have specified a valid combination of Configuration <span style="color:#f92672">and</span> Platform <span style="color:#66d9ef">for</span> this project<span style="color:#f92672">.</span>  Configuration<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;Debug&#39;</span>  Platform<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;ololo&#39;</span><span style="color:#f92672">.</span> You may be seeing this message because you are trying to build a project without a solution file, <span style="color:#f92672">and</span> have specified a non<span style="color:#f92672">-</span>default Configuration <span style="color:#f92672">or</span> Platform that doesn<span style="color:#960050;background-color:#1e0010">&#39;</span>t exist <span style="color:#66d9ef">for</span> this project<span style="color:#f92672">.</span> [E:<span style="color:#f92672">\</span>code<span style="color:#f92672">\</span>dotnet<span style="color:#f92672">\</span>csharp<span style="color:#f92672">-</span>cpp<span style="color:#f92672">-</span>example<span style="color:#f92672">\</span>application<span style="color:#f92672">-</span>csharp<span style="color:#f92672">\</span>build<span style="color:#f92672">\</span>CMakeFiles<span style="color:#f92672">\</span><span style="color:#ae81ff">4.1.0</span><span style="color:#f92672">\</span>VCTargetsPath<span style="color:#f92672">.</span>vcxproj]
</span></span><span style="display:flex;"><span>    Done Building Project <span style="color:#e6db74">&#34;E:\code\dotnet\csharp-cpp-example\application-csharp\build\CMakeFiles\4.1.0\VCTargetsPath.vcxproj&#34;</span> (default targets) <span style="color:#f92672">--</span> FAILED<span style="color:#f92672">.</span>
</span></span></code></pre></div><p>So apparently those lines with <code>CMAKE_GENERATOR_PLATFORM</code> checks should be placed before the <code>project()</code>, and I tried that, but then it just failed in a different way:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-perl" data-lang="perl"><span style="display:flex;"><span>CMake Error at CMakeLists<span style="color:#f92672">.</span>txt:22 (project):
</span></span><span style="display:flex;"><span>  Failed to run MSBuild command:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    D:<span style="color:#e6db74">/programs/</span>vs<span style="color:#e6db74">/vs2022/</span>MSBuild<span style="color:#e6db74">/Current/</span>Bin<span style="color:#e6db74">/amd64/</span>MSBuild<span style="color:#f92672">.</span>exe
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  to get the value of VCTargetsPath:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    MSBuild version <span style="color:#ae81ff">17.14.18</span><span style="color:#f92672">+</span>a338add32 <span style="color:#66d9ef">for</span> <span style="color:#f92672">.</span>NET Framework
</span></span><span style="display:flex;"><span>    Build started <span style="color:#ae81ff">27.10.2025</span> <span style="color:#ae81ff">11</span>:<span style="color:#ae81ff">36</span>:<span style="color:#ae81ff">05</span><span style="color:#f92672">.</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    Project <span style="color:#e6db74">&#34;E:\code\dotnet\csharp-cpp-example\application-csharp\build\CMakeFiles\4.1.0\VCTargetsPath.vcxproj&#34;</span> on node <span style="color:#ae81ff">1</span> (default targets)<span style="color:#f92672">.</span>
</span></span><span style="display:flex;"><span>    D:<span style="color:#f92672">\</span>programs<span style="color:#f92672">\</span>vs<span style="color:#f92672">\</span>vs2022<span style="color:#f92672">\</span>MSBuild<span style="color:#f92672">\</span>Microsoft<span style="color:#f92672">\</span>VC<span style="color:#f92672">\</span>v170<span style="color:#f92672">\</span>Microsoft<span style="color:#f92672">.</span>CppBuild<span style="color:#f92672">.</span>targets(<span style="color:#ae81ff">459</span>,<span style="color:#ae81ff">5</span>): error MSB8013: This project doesn<span style="color:#960050;background-color:#1e0010">&#39;</span>t contain the Configuration <span style="color:#f92672">and</span> Platform combination of Debug<span style="color:#f92672">|</span>Win32<span style="color:#f92672">.</span> [E:<span style="color:#f92672">\</span>code<span style="color:#f92672">\</span>dotnet<span style="color:#f92672">\</span>csharp<span style="color:#f92672">-</span>cpp<span style="color:#f92672">-</span>example<span style="color:#f92672">\</span>application<span style="color:#f92672">-</span>csharp<span style="color:#f92672">\</span>build<span style="color:#f92672">\</span>CMakeFiles<span style="color:#f92672">\</span><span style="color:#ae81ff">4.1.0</span><span style="color:#f92672">\</span>VCTargetsPath<span style="color:#f92672">.</span>vcxproj]
</span></span><span style="display:flex;"><span>    Done Building Project <span style="color:#e6db74">&#34;E:\code\dotnet\csharp-cpp-example\application-csharp\build\CMakeFiles\4.1.0\VCTargetsPath.vcxproj&#34;</span> (default targets) <span style="color:#f92672">--</span> FAILED<span style="color:#f92672">.</span>
</span></span></code></pre></div><p>So <code>AnyCPU</code> is apparently no good either, and hardcoding it to <code>x64</code> doesn&rsquo;t feel too good, especially given that, like I said, CMake already sets all these things just fine on its own. So I really see no point in doing <a href="https://github.com/retifrav/csharp-cpp-example/blob/0cbd29405a93e803fdf67945034c2c32e0cdaef6/CMakeLists.txt#L3-L25">this ritual dance</a>.</p>
<h2 id="c-application">C# application</h2>
<p>Last part of the base project is <a href="https://github.com/retifrav/csharp-cpp-example/tree/0cbd29405a93e803fdf67945034c2c32e0cdaef6/csharp/application">C# application</a>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>./csharp/application/
</span></span><span style="display:flex;"><span>├── src
</span></span><span style="display:flex;"><span>│   └── Program.cs
</span></span><span style="display:flex;"><span>└── CMakeLists.txt
</span></span></code></pre></div><p>Later in the article this application will be used as an example of an actual user project - something that would be using our intermediate C# library, which in turn would be bringing-in our main C++ library functionality. But for now the only thing this application does is calling our C# library&rsquo;s only function, which merely returns a string of text.</p>
<p>The <code>Program.cs</code> source file:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cs" data-lang="cs"><span style="display:flex;"><span><span style="color:#66d9ef">using</span> System;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">using</span> System.CommandLine;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">using</span> System.Text;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">using</span> System.IO;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">using</span> Lbr;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">namespace</span> Applctn;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Program</span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">int</span> Main(<span style="color:#66d9ef">string</span>[] args)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        Console.WriteLine(<span style="color:#e6db74">$&#34;Something from C# library | {Some.getSome()}&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>And the CMake project file is just this:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cmake" data-lang="cmake"><span style="display:flex;"><span>add_executable(<span style="color:#e6db74">applctn</span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span>target_sources(<span style="color:#e6db74">applctn</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">PRIVATE</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">src/Program.cs</span>
</span></span><span style="display:flex;"><span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span>target_link_libraries(<span style="color:#e6db74">applctn</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">PRIVATE</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">some</span> <span style="color:#75715e"># that&#39;s the C# library
</span></span></span><span style="display:flex;"><span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div><p>Almost boring, right? All the same things you would&rsquo;ve done for a regular C++ application. But don&rsquo;t forget that it&rsquo;s the upper-level <code>CMakeLists.txt</code> who enables <code>CSharp</code> language and sets the required variables for .NET SDK and language versions.</p>
<p>If you won&rsquo;t do <code>target_link_libraries()</code> to link the <code>some</code> library target, then you&rsquo;ll get the following build error:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>error CS0246: The type or namespace name <span style="color:#e6db74">&#39;Lbr&#39;</span> could not be found <span style="color:#f92672">(</span>are you missing a using directive or an assembly reference?<span style="color:#f92672">)</span>
</span></span></code></pre></div><p>Speaking about the namespaces, if both the application and the library source files were using:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cs" data-lang="cs"><span style="display:flex;"><span><span style="color:#66d9ef">namespace</span> Applctn;
</span></span></code></pre></div><p>then calling <code>Some.getSome()</code> would have just worked, as it would be in the same namespace, but since the library has its own namespace:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cs" data-lang="cs"><span style="display:flex;"><span><span style="color:#66d9ef">namespace</span> Lbr;
</span></span></code></pre></div><p>the application needs to declare the use of it:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cs" data-lang="cs"><span style="display:flex;"><span><span style="color:#66d9ef">using</span> Lbr;
</span></span></code></pre></div><p>Building the application will result in the following <code>applctn.exe</code> binary:</p>


    <img class="image-post" loading="lazy" src="/blog/2025/11/11/cpp-library-in-csharp/images/die-applctn-exe.png" alt="Detect It Easy, applctn.exe">

<p>Seeing C++ here might be surprising, but actually it only means that it&rsquo;s this particular executable who is a C++ program, or rather it is more correct to call it it a &ldquo;launcher&rdquo;, and the actual &ldquo;application&rdquo; is in the <code>applctn.dll</code>:</p>


    <img class="image-post" loading="lazy" src="/blog/2025/11/11/cpp-library-in-csharp/images/die-applctn-dll.png" alt="Detect It Easy, applctn.dll">

<p>which is a C# assembly, as expected.</p>
<p>If you did not know this before, the <code>.exe</code> launcher isn&rsquo;t even needed, you can just as well simply run <code>applctn.dll</code> directly with <code>dotnet</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ dotnet ./applctn.dll
</span></span></code></pre></div><h3 id="referencing-nuget-packages">Referencing NuGet packages</h3>
<p>To make the application project a little bit more interesting, let&rsquo;s add a dependency on some NuGet package, for example let&rsquo;s use CLI arguments parsing from <a href="https://www.nuget.org/packages/System.CommandLine/">System.CommandLine</a> assembly:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cmake" data-lang="cmake"><span style="display:flex;"><span>set_target_properties(<span style="color:#e6db74">applctn</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">PROPERTIES</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">VS_PACKAGE_REFERENCES</span> <span style="color:#e6db74">&#34;System.CommandLine_2.0.0-rc.1.25451.107&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">DEBUG_POSTFIX</span> <span style="color:#e6db74">&#34;${CMAKE_DEBUG_POSTFIX}&#34;</span>
</span></span><span style="display:flex;"><span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div><p>It didn&rsquo;t work for me with a bare <code>System.CommandLine</code> value, so I had to specify the exact package version (<em>separated with <code>_</code> after the package name</em>). I also tried to use a wildcard like <code>System.CommandLine_2.0.0-*</code>, but that didn&rsquo;t work either (<em>although it should have?</em>).</p>
<p>Having added this package, we can now make the application accept <code>--something</code>/<code>-s</code> CLI argument like this:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cs" data-lang="cs"><span style="display:flex;"><span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">int</span> Main(<span style="color:#66d9ef">string</span>[] args)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    Option&lt;<span style="color:#66d9ef">string</span>&gt; someOption = <span style="color:#66d9ef">new</span>(<span style="color:#e6db74">&#34;--something&#34;</span>, <span style="color:#e6db74">&#34;-s&#34;</span>)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        Description = <span style="color:#e6db74">&#34;Some thing to pass to the application&#34;</span>
</span></span><span style="display:flex;"><span>    };
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    RootCommand rootCommand = <span style="color:#66d9ef">new</span>(<span style="color:#e6db74">&#34;applctn&#34;</span>)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        Description = <span style="color:#e6db74">&#34;Just some application&#34;</span>
</span></span><span style="display:flex;"><span>    };
</span></span><span style="display:flex;"><span>    rootCommand.Options.Add(someOption);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">var</span> parseResult = rootCommand.Parse(args);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (parseResult.Errors.Count != <span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">foreach</span> (<span style="color:#66d9ef">var</span> parseError <span style="color:#66d9ef">in</span> parseResult.Errors)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            Console.Error.WriteLine(parseError.Message);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">var</span> smOpt = parseResult.GetValue(someOption);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (!<span style="color:#66d9ef">string</span>.IsNullOrEmpty(smOpt))
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        Console.WriteLine(<span style="color:#e6db74">$&#34;Something that was passed as CLI argument: {smOpt}&#34;</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    Console.WriteLine(<span style="color:#e6db74">$&#34;Something from C# library | {Some.getSome()}&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span></code></pre></div><h1 id="calling-c-from-c">Calling C++ from C#</h1>
<p>Okay, all that was just some light foreplay with a bit of fingering, and now we are getting to the real action.</p>
<p>The main problem with trying to use a <a href="#native-c-library">native C++ library</a> in a .NET/C# project is that it simply isn&rsquo;t possible: you cannot call a native (<em>unmanaged</em>) code from a <a href="https://learn.microsoft.com/en-us/dotnet/standard/managed-code">managed</a> code, or at least you cannot do that directly.</p>
<p>But there are two ways of how it can be done indirectly:</p>
<ol>
<li>Via <a href="https://learn.microsoft.com/en-us/dotnet/standard/native-interop/pinvoke">Platform Invoke</a> (<em>P/Invoke</em>), where it loads an intermediate C API library, which is a wrapper library for the original native C++ library;</li>
<li>Via <a href="https://learn.microsoft.com/en-us/cpp/dotnet/dotnet-programming-with-cpp-cli-visual-cpp">C++/CLI</a>, where it involves a yet another C++ library, but that one is a managed library, which, again, is a wrapper for the original native C++ library.</li>
</ol>
<p>It probably sounds rather confusing, so here&rsquo;s a schematic visualization:</p>


    <img class="image-post" loading="lazy" src="/blog/2025/11/11/cpp-library-in-csharp/images/calling-cpp-from-csharp.png" alt="Two ways of calling unmanaged C&#43;&#43; from managed C# on Windows">

<p>So, one way or another, there is going to be a wrapper involved (<em>not to mention that our C# library is actually a kind of intermediary/wrapper itself</em>). Moreover, you can even combine both ways in the same project/library (<em>should you ever have a need to do something like that</em>).</p>
<h2 id="pinvoke">P/Invoke</h2>
<h3 id="c-api-wrapper">C API wrapper</h3>
<p>First thing you will need to do is create a <a href="https://en.wikipedia.org/wiki/C_(programming_language)">C</a> API wrapper. Why C - because (<em>unlike C++?</em>) it <a href="https://caiorss.github.io/C-Cpp-Notes/CwrapperToQtLibrary.html#orgdcc388a">allows</a> calling its functions from other languages (<em>via <a href="https://en.wikipedia.org/wiki/Foreign_function_interface">FFI</a>?</em>), such as C# in our case.</p>
<p>The wrapper files are <a href="https://github.com/retifrav/csharp-cpp-example/tree/0cbd29405a93e803fdf67945034c2c32e0cdaef6/cpp/library-c-api">here</a>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>./cpp/library-c-api/
</span></span><span style="display:flex;"><span>├── src
</span></span><span style="display:flex;"><span>│   └── thingy-c-api.cpp
</span></span><span style="display:flex;"><span>└── CMakeLists.txt
</span></span></code></pre></div><p>The <code>CMakeLists.txt</code> project file is quite simple, the only noteworthy part is linking to the original C++ library:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cmake" data-lang="cmake"><span style="display:flex;"><span>add_library(<span style="color:#e6db74">thingy-c-api</span> <span style="color:#e6db74">SHARED</span>) <span style="color:#75715e"># has to be `SHARED`, since this is for .NET (and in general for FFI?)
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span>target_sources(<span style="color:#e6db74">thingy-c-api</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">PRIVATE</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">src/thingy-c-api.cpp</span>
</span></span><span style="display:flex;"><span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span>target_link_libraries(<span style="color:#e6db74">thingy-c-api</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">PRIVATE</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">thingy</span>
</span></span><span style="display:flex;"><span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div><p>And the <code>thingy-c-api.cpp</code> source file is this:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;Thingy/thingy.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">extern</span> <span style="color:#e6db74">&#34;C&#34;</span> <span style="color:#66d9ef">__declspec</span>(dllexport) <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">do_thingy</span>()
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// to keep the string in memory it needs to be `static`, otherwise it will be destroyed
</span></span></span><span style="display:flex;"><span>    <span style="color:#75715e">// after `do_thingy()` does the return, so in C# that would be a pointer to invalid memory
</span></span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">static</span> std<span style="color:#f92672">::</span>string thng <span style="color:#f92672">=</span> dpndnc<span style="color:#f92672">::</span><span style="color:#a6e22e">doThingy</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// return C-style string
</span></span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> thng.<span style="color:#a6e22e">c_str</span>();
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Here it sets <code>__declspec(dllexport)</code> for the function right away, because this library is meant to be dynamically linked. But be aware that this is only for Windows/MSVC, as you&rsquo;ll see <a href="#adapting-cmake-project-files">later</a>.</p>
<p>And then comes the C++/C types juggling, because original <code>doThingy()</code> function returns <code>std::string</code>, which in case of C has to be &ldquo;converted&rdquo; to a C string. So essentially this is what makes it a wrapper - original C++ functions are quite literally wrapped into new functions, whose only purpose is to convert the types to make the functions callable/usable from C#.</p>
<p>Next thing of note is that if we leave <code>thingy.h</code> as it is, then in case when <code>thingy</code> target will be configured as a <code>STATIC</code> library, the <code>thingy_EXPORTS</code> compile definition won&rsquo;t be set, so <code>DLLEXPORT</code> will get defined as <code>__declspec(dllimport)</code> instead of <code>__declspec(dllexport)</code>, which will cause the following linker error:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>thingy-c-api.obj : error LNK2019: unresolved external symbol <span style="color:#e6db74">&#34;__declspec(dllimport) class std::basic_string&lt;char,struct std::char_traits&lt;char&gt;,class std::allocator&lt;char&gt; &gt; __cdecl dpndnc::doThingy(void)&#34;</span> <span style="color:#f92672">(</span>__imp_?doThingy@dpndnc@@YA?AV?$basic_string@DU?$char_traits@D@std@@V?$allocator@D@2@@std@@XZ<span style="color:#f92672">)</span> referenced in <span style="color:#66d9ef">function</span> do_thingy_c <span style="color:#f92672">[</span>E:<span style="color:#ae81ff">\c</span>ode<span style="color:#ae81ff">\c</span>sharp-cpp-example<span style="color:#ae81ff">\b</span>uild<span style="color:#ae81ff">\c</span>pp<span style="color:#ae81ff">\l</span>ibrary-c-api<span style="color:#ae81ff">\t</span>hingy-c-api.vcxproj<span style="color:#f92672">]</span>
</span></span></code></pre></div><p>and also this warning on building the library itself:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>warning C4273: <span style="color:#e6db74">&#39;dpndnc::doThingy&#39;</span>: inconsistent dll linkage <span style="color:#f92672">[</span>E:<span style="color:#ae81ff">\c</span>ode<span style="color:#ae81ff">\c</span>sharp-cpp-example<span style="color:#ae81ff">\b</span>uild<span style="color:#ae81ff">\c</span>pp<span style="color:#ae81ff">\l</span>ibrary<span style="color:#ae81ff">\t</span>hingy.vcxproj<span style="color:#f92672">]</span> E:<span style="color:#ae81ff">\c</span>ode<span style="color:#ae81ff">\c</span>sharp-cpp-example<span style="color:#ae81ff">\c</span>pp<span style="color:#ae81ff">\l</span>ibrary<span style="color:#ae81ff">\i</span>nclude<span style="color:#ae81ff">\T</span>hingy<span style="color:#ae81ff">\t</span>hingy.h<span style="color:#f92672">(</span>22,27<span style="color:#f92672">)</span>:
</span></span><span style="display:flex;"><span>      see previous definition of <span style="color:#e6db74">&#39;dpndnc::doThingy&#39;</span>
</span></span></code></pre></div><p>So you&rsquo;ll either need to hardcode <code>thingy</code> library type to <code>SHARED</code>, or <a href="https://github.com/retifrav/csharp-cpp-example/commit/e6ac5e64fea11d3802a400203fdf89ffddd6eae0#diff-9dd69351362b1119fcf792d627736e033b21447d5eb808ed94209d62c1619b24L6-R14">remove</a> the <code>__declspec(dllimport)</code> definition:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-diff" data-lang="diff"><span style="display:flex;"><span><span style="color:#f92672">-#else
</span></span></span><span style="display:flex;"><span><span style="color:#f92672">-    // import on using the created DLL (when using in projects)
</span></span></span><span style="display:flex;"><span><span style="color:#f92672">-    #define DLLEXPORT __declspec(dllimport)
</span></span></span><span style="display:flex;"><span><span style="color:#a6e22e">+// that does nothing good when this header is included in other libraries within the project
</span></span></span><span style="display:flex;"><span><span style="color:#a6e22e">+//#else
</span></span></span><span style="display:flex;"><span><span style="color:#a6e22e">+//    // import on using the created DLL (when using in projects)
</span></span></span><span style="display:flex;"><span><span style="color:#a6e22e">+//    #define DLLEXPORT __declspec(dllimport)
</span></span></span></code></pre></div><p>or maybe there could have been a separate public header, something like <code>thingy-for-wrappers.h</code>? Not sure what&rsquo;s best, but since this <a href="#native-c-library">native C++ library</a> isn&rsquo;t really meant to be installed and used standalone outside of this project, I decided to go with the single &ldquo;crippled&rdquo; public header.</p>
<p>After the build resulting <code>thingy-c-api.dll</code> will be this:</p>


    <img class="image-post" loading="lazy" src="/blog/2025/11/11/cpp-library-in-csharp/images/die-thingy-c-api-dll.png" alt="Detect It Easy, thingy-c-api.dll">

<h3 id="importing-c-api-wrapper-dll">Importing C API wrapper DLL</h3>
<p>Once you make the C API wrapper, in order to use P/Invoke for calling its functions, you will need to declare C# functions with the same name and signature and add <code>DllImport</code> attribute to those declarations. That attribute will contain the file name of the wrapper library:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cs" data-lang="cs"><span style="display:flex;"><span><span style="color:#a6e22e">[DllImport(&#34;thingy.dll&#34;)]</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">extern</span> IntPtr do_thingy();
</span></span></code></pre></div><p>The hardcoded <code>thingy.dll</code> file name value got me some Vietnam flashbacks from the <a href="/blog/2024/02/12/cpp-library-in-android-application/#via-wrapper">Android wrapper</a>, where it was also expecting to find the library under a certain hardcoded file name, which means that you cannot apply <a href="https://github.com/retifrav/csharp-cpp-example/blob/0cbd29405a93e803fdf67945034c2c32e0cdaef6/cpp/library-c-api/CMakeLists.txt#L13-L18">Debug postfix</a> to it. However, I decided to keep the postfix and instead used a <a href="https://learn.microsoft.com/en-us/dotnet/csharp/language-reference/preprocessor-directives#conditional-compilation">conditional compilation</a> directive, <a href="https://github.com/retifrav/csharp-cpp-example/blob/0cbd29405a93e803fdf67945034c2c32e0cdaef6/csharp/library/src/Some.cs#L15-L20">like this</a>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cs" data-lang="cs"><span style="display:flex;"><span><span style="color:#75715e">#if</span> DEBUG
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">    [DllImport(&#34;thingy-c-apid.dll&#34;)]</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#else</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">    [DllImport(&#34;thingy-c-api.dll&#34;)]</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#endif</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">extern</span> IntPtr do_thingy();
</span></span></code></pre></div><p>One other place where the Debug postfix would cause troubles is if you&rsquo;d try to add a <a href="https://github.com/retifrav/csharp-cpp-example/blob/bd684b0ba1d33812098e3dd516d024fb2924c973/csharp/library/CMakeLists.txt#L8-L12">reference</a> to the wrapper with <a href="https://cmake.org/cmake/help/latest/prop_tgt/VS_DOTNET_REFERENCE_refname.html">VS_DOTNET_REFERENCE_*</a>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cmake" data-lang="cmake"><span style="display:flex;"><span>set_target_properties(<span style="color:#e6db74">some</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">PROPERTIES</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">VS_DOTNET_REFERENCE_thingycapi</span> <span style="color:#e6db74">&#34;/path/to/thingy-c-api.dll&#34;</span> <span style="color:#75715e"># can&#39;t use `$&lt;TARGET_FILE:thingy-c-api&gt;`
</span></span></span><span style="display:flex;"><span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div><p>Since this target property <a href="https://discourse.cmake.org/t/generator-expressions-in-vs-dotnet-reference-refname/15271">does not</a> support generator expressions (<em>and also because you can&rsquo;t really do <code>if (CMAKE_BUILD_TYPE STREQUAL &quot;Debug&quot;)</code> with Visual Studio generator</em>), you&rsquo;d have to unset the Debug postfix for the <code>thingy-c-api</code> target. But even then, adding a reference to <code>thingy-c-api.dll</code> doesn&rsquo;t seem to do anything useful, so I just didn&rsquo;t do it and kept the postfix.</p>
<p>Also, surprisingly, there is no(?) need to link to the wrapper:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cmake" data-lang="cmake"><span style="display:flex;"><span><span style="color:#75715e"># doesn&#39;t seem to do anything useful, and everything seems to work fine without this
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"># (unless you are going to use `$&lt;TARGET_RUNTIME_DLLS:some&gt;` to copy DLLs)
</span></span></span><span style="display:flex;"><span>target_link_libraries(<span style="color:#e6db74">some</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">PRIVATE</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">thingy-c-api</span>
</span></span><span style="display:flex;"><span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div><p>Anyway, that was about how the function is imported from C API wrapper into C# library, and now we can call it in C#:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cs" data-lang="cs"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">string</span> DoThingy()
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> Marshal.PtrToStringAnsi(do_thingy());
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>The <code>Marshal.PtrToStringAnsi()</code> converts (<em><a href="https://learn.microsoft.com/en-us/dotnet/standard/native-interop/type-marshalling">marshals</a></em>) the return value of the wrapper function from a C string pointer to a &ldquo;normal&rdquo; string in C#. On Windows(?) that works only for &ldquo;simple&rdquo; ASCII strings, but more on that <a href="#fighting-with-encoding">later</a>.</p>
<p>If you were wondering whether the <code>static</code> keyword was really needed inside the <code>do_thingy()</code> in the wrapper sources, then if you did it differently back there:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">extern</span> <span style="color:#e6db74">&#34;C&#34;</span> <span style="color:#66d9ef">__declspec</span>(dllexport) <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">do_thingy</span>()
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> dpndnc<span style="color:#f92672">::</span><span style="color:#a6e22e">doThingy</span>().<span style="color:#a6e22e">c_str</span>();
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>then the return value would get fucked, and this is what you&rsquo;d see <a href="https://github.com/retifrav/csharp-cpp-example/blob/2b28e2e0cd6739bc204fe272ff8ff16ed3800921/csharp/application/src/Program.cs#L33">trying to call</a> this function in C#:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>Something from C++ library through C# library | YYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYO
</span></span></code></pre></div><p>That is because without <code>static</code> keyword the imported function return value will point (<em><code>IntPtr</code></em>) to an address in memory which almost most certainly will contain some garbage at that point. And marking the variable with <code>static</code> will preserve the string value in memory.</p>
<h2 id="ccli-clr">C++/CLI CLR</h2>
<p>An alternative to <a href="#pinvoke">P/Invoke</a> is to create a, yet again, wrapper, but this time it will be a C++ wrapper library, not C. The point of adding a yet another C++ library and how it is different from the original <a href="#native-c-library">native C++ library</a> is that this one will be a managed library/assembly, because it will be compiled with <a href="https://learn.microsoft.com/en-us/cpp/build/reference/clr-common-language-runtime-compilation">CLR</a>, which will enable using it from C#.</p>
<p>At first I thought that this approach is better than P/Invoke, but then I read the following statement in the Microsoft&rsquo;s own <a href="https://learn.microsoft.com/en-us/cpp/dotnet/dotnet-programming-with-cpp-cli-visual-cpp">documentation</a>:</p>
<blockquote>For new projects, we recommend exploring modern third-party alternatives such as <a href="https://github.com/dotnet/ClangSharp">https://github.com/dotnet/ClangSharp</a> or <a href="https://www.swig.org/">https://www.swig.org/</a>, which offer more flexibility and better alignment with current language and runtime capabilities.</blockquote>
<p>Having briefly looked at both of those alternatives, I saw that both of them are&hellip; based on P/Invoke? So if you ask me, which way of calling C++ from C# is better after all, I really cannot say. Or at least I can say that when it comes to <a href="#platforms-other-than-windows">platforms other than Windows</a>, then C++/CLI is simply not available on those, leaving P/Invoke the only available option.</p>
<h3 id="c-wrapper">C++ wrapper</h3>
<p>The <a href="https://github.com/retifrav/csharp-cpp-example/tree/bd684b0ba1d33812098e3dd516d024fb2924c973/cpp/library-clr">project files</a> are these:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>./cpp/library-clr/
</span></span><span style="display:flex;"><span>├── src
</span></span><span style="display:flex;"><span>│   └── thingy-clr.cpp
</span></span><span style="display:flex;"><span>└── CMakeLists.txt
</span></span></code></pre></div><p>where the <code>CMakeLists.txt</code> is this:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cmake" data-lang="cmake"><span style="display:flex;"><span>add_library(<span style="color:#e6db74">thingy-clr</span> <span style="color:#e6db74">SHARED</span>) <span style="color:#75715e"># has to be `SHARED`, since this is for .NET
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span>target_sources(<span style="color:#e6db74">thingy-clr</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">PRIVATE</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">src/thingy-clr.cpp</span>
</span></span><span style="display:flex;"><span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span>target_link_libraries(<span style="color:#e6db74">thingy-clr</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">PRIVATE</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">thingy</span>
</span></span><span style="display:flex;"><span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span>set_target_properties(<span style="color:#e6db74">thingy-clr</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">PROPERTIES</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">COMMON_LANGUAGE_RUNTIME</span> <span style="color:#e6db74">&#34;&#34;</span> <span style="color:#75715e"># or `netcore`?
</span></span></span><span style="display:flex;"><span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div><p>The most important part here is setting <a href="https://cmake.org/cmake/help/latest/prop_tgt/COMMON_LANGUAGE_RUNTIME.html">COMMON_LANGUAGE_RUNTIME</a> target property.</p>
<p>It probably should be set to <code>netcore</code> value instead, but Microsoft&rsquo;s documentation <a href="https://learn.microsoft.com/en-us/cpp/build/reference/clr-common-language-runtime-compilation#arguments">isn&rsquo;t very clear</a> about that. It does say that with <code>netcore</code> the latest .NET Core will be used, so apparently this is to distinguish from the &ldquo;classic&rdquo; .NET Framework (<em>whose latest version was <code>4.x</code></em>), but it doesn&rsquo;t say what variant of .NET will be used when <code>/clr</code> is provided with an empty string, so I can only guess that it will be &ldquo;classic&rdquo; .NET Framework.</p>
<p>At the same time, CMake documentation does say that with an empty string it will be &ldquo;<em>&hellip;using .NET Framework</em>&rdquo;, while with <code>netcore</code> it will be &ldquo;<em>&hellip;using .NET Core</em>&rdquo;, so then one should probably prefer <code>netcore</code>? I wasn&rsquo;t sure, so I tried it with an empty string first.</p>
<p>The <code>thingy-clr.cpp</code> source code contains the following:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;msclr/marshal_cppstd.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;Thingy/thingy.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">using</span> <span style="color:#66d9ef">namespace</span> System;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// it probably doesn&#39;t have to be a class, but I was following a guide
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// https://learn.microsoft.com/en-us/archive/blogs/borisj/interop-101-part-4
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// and I didn&#39;t mind terribly
</span></span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> ref <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ThingyWrapperCLR</span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">static</span> String<span style="color:#f92672">^</span> DoThingy()
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        std<span style="color:#f92672">::</span>string thng <span style="color:#f92672">=</span> dpndnc<span style="color:#f92672">::</span>doThingy();
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// using msclr
</span></span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> msclr<span style="color:#f92672">::</span>interop<span style="color:#f92672">::</span>marshal_as<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">^&gt;</span>(thng);
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// or
</span></span></span><span style="display:flex;"><span>        <span style="color:#75715e">//return gcnew String(thng.c_str());
</span></span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>};
</span></span></code></pre></div><p>As you can see, types converting/marshalling is involved here too.</p>
<p>In case you don&rsquo;t have it yet, to build the library you will need to install the C++/CLI component in Visual Studio installer:</p>


    <img class="image-post" loading="lazy" src="/blog/2025/11/11/cpp-library-in-csharp/images/visual-studio-installer-cpp-cli.png" alt="Visual Studio installer, C&#43;&#43;/CLI" style="border:1px solid black;">

<p>Resulting <code>thingy-clr.dll</code> will be this:</p>


    <img class="image-post" loading="lazy" src="/blog/2025/11/11/cpp-library-in-csharp/images/die-thingy-clr-net-framework.png" alt="Detect It Easy, thingy-clr.dll as .NET Framework assembly">

<p>Interesting that it says &ldquo;<em>.NET Framework, Legacy</em>&rdquo;. Assuming that this is because of the <code>COMMON_LANGUAGE_RUNTIME</code> being set to an empty string, I then tried with <code>netcore</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cmake" data-lang="cmake"><span style="display:flex;"><span>set_target_properties(<span style="color:#e6db74">thingy-clr</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">PROPERTIES</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">COMMON_LANGUAGE_RUNTIME</span> <span style="color:#e6db74">&#34;netcore&#34;</span>
</span></span><span style="display:flex;"><span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div><p>And the build had failed right after that:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>thingy-c-api.vcxproj -&gt; E:<span style="color:#ae81ff">\c</span>ode<span style="color:#ae81ff">\d</span>otnet<span style="color:#ae81ff">\c</span>sharp-cpp-example<span style="color:#ae81ff">\b</span>uild<span style="color:#ae81ff">\c</span>pp<span style="color:#ae81ff">\l</span>ibrary-c-api<span style="color:#ae81ff">\R</span>elease<span style="color:#ae81ff">\t</span>hingy-c-apid.dll
</span></span><span style="display:flex;"><span>C:<span style="color:#ae81ff">\P</span>rogram Files<span style="color:#ae81ff">\d</span>otnet<span style="color:#ae81ff">\s</span>dk<span style="color:#ae81ff">\9</span>.0.304<span style="color:#ae81ff">\S</span>dks<span style="color:#ae81ff">\M</span>icrosoft.NET.Sdk<span style="color:#ae81ff">\t</span>argets<span style="color:#ae81ff">\M</span>icrosoft.NET.TargetFrameworkInference.targets<span style="color:#f92672">(</span>96,5<span style="color:#f92672">)</span>: error NETSDK1013: The TargetFramework value <span style="color:#e6db74">&#39;&#39;</span> was not recognized. It may be misspelled. If not, <span style="color:#66d9ef">then</span> the TargetFrameworkIdentifier and/or TargetFrameworkVersion properties must be specified explicitly.
</span></span></code></pre></div><p>but that was simply because it was expecting <code>CMAKE_DOTNET_TARGET_FRAMEWORK</code> to be set:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cmake" data-lang="cmake"><span style="display:flex;"><span>set(<span style="color:#e6db74">CMAKE_DOTNET_TARGET_FRAMEWORK</span> <span style="color:#e6db74">&#34;net9.0&#34;</span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div><p>which back at the moment was happening in the C# part of the project, so I just <a href="https://github.com/retifrav/csharp-cpp-example/commit/6f1a9c059b761bd5cffc75220b90371eb23e278e">moved</a> it (<em>and the rest of the .NET-related variables</em>) to the top-level <code>CMakeLists.txt</code>. Then the build succeeded, and this time the resulting <code>thingy-clr.dll</code> was reporting modern .NET assembly (<em>although with VB.NET as compiler, he-he</em>):</p>


    <img class="image-post" loading="lazy" src="/blog/2025/11/11/cpp-library-in-csharp/images/die-thingy-clr-dotnet.png" alt="Detect It Easy, thingy-clr.dll as .NET assembly">

<p>It is worth to mention that the final application works fine with <code>thingy-clr.dll</code> being built either as modern .NET assembly or as classic .NET Framework assembly - doesn&rsquo;t seem to make any difference (<em>aside from the 36 KB binary size increase in the modern one</em>), but that&rsquo;s probably because so far I&rsquo;ve only implemented some simple functionality which works equally fine in both SDKs.</p>
<h3 id="linking-c-wrapper-dll">Linking C++ wrapper DLL</h3>
<p>Or perhaps a more correct term would be &ldquo;<em>referencing the C++ wrapper assembly</em>&rdquo;, but in CMake it is done exactly as linking:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cmake" data-lang="cmake"><span style="display:flex;"><span>target_link_libraries(<span style="color:#e6db74">some</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">PRIVATE</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">thingy-clr</span>
</span></span><span style="display:flex;"><span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div><p>That&rsquo;s it, nothing else needs to be done with CMake here (<em>aside from copying DLLs, but more on that <a href="#installation">later</a></em>). The wrapper is ready to be used in C#:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cs" data-lang="cs"><span style="display:flex;"><span><span style="color:#75715e">// new function in C# library</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">string</span> DoThingyCLR()
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// to call a function from C++ wrapper</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> ThingyWrapperCLR.DoThingy();
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h1 id="putting-it-all-together">Putting it all together</h1>
<p>The <a href="#c-application">application</a>&rsquo;s project file does not need any modifications, as it already contains linking/referencing to our <a href="#c-library">C# library</a>.</p>
<p>Calling both wrappers through the C# library in the application&rsquo;s <code>Program.cs</code> looks like this:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cs" data-lang="cs"><span style="display:flex;"><span><span style="color:#75715e">// simple C# function from our C# library</span>
</span></span><span style="display:flex;"><span>Console.WriteLine(
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">$&#34;Something from C# library | {Some.getSome()}&#34;</span>
</span></span><span style="display:flex;"><span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// P/Invoke with C API wrapper</span>
</span></span><span style="display:flex;"><span>Console.WriteLine(
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">$&#34;Something from C++ library through C# library via P/Invoke | {Some.DoThingyC()}&#34;</span>
</span></span><span style="display:flex;"><span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// C++/CLI CLR wrapper</span>
</span></span><span style="display:flex;"><span>Console.WriteLine(
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">$&#34;Something from C++ library through C# library via C++/CLI CLR | {Some.DoThingyCLR()}&#34;</span>
</span></span><span style="display:flex;"><span>);
</span></span></code></pre></div><p>As I promised - both ways of using a native C++ library combined in the same C# project.</p>
<h2 id="fighting-with-encoding">Fighting with encoding</h2>
<p>It&rsquo;s all nice and dandy until you put some <a href="https://github.com/retifrav/csharp-cpp-example/blob/ac3a9d234e30a927581566e3955e458bb66b033a/cpp/library/src/stuff.h#L3">non-ASCII characters</a> into the strings inside <a href="#native-c-library">C++ library</a>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#75715e">// adding a bit of Cyrillic text and some emojis to spice things up
</span></span></span><span style="display:flex;"><span><span style="color:#66d9ef">const</span> std<span style="color:#f92672">::</span>string thingyString <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;some кабы не было зимы ❄️ в городах 🏢 и сёлах 🏠 text&#34;</span>;
</span></span></code></pre></div><p>Trying to use the library now, you will get the following bizarre console output in your application (<em>at the very least, that was the case for me on Windows</em>):</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>some ÐºÐ°Ð±Ñ‹ Ð½Ðµ Ð±Ñ‹Ð»Ð¾ Ð·Ð¸Ð¼Ñ‹ â„ï¸ Ð² Ð³Ð¾Ñ€Ð¾Ð´Ð°Ñ… ðŸ¢ Ð¸ ÑÑ‘Ð»Ð°Ñ… ðŸ  text
</span></span></code></pre></div><p>or something like:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>some ╨║╨░╨▒╤ï ╨╜╨╡ ╨▒╤ï╨╗╨╛ ╨╖╨╕╨╝╤ï Γ¥ä∩╕Å ╨▓ ╨│╨╛╤Ç╨╛╨┤╨░╤à ≡ƒÅó ╨╕ ╤ü╤æ╨╗╨░╤à ≡ƒÅá text
</span></span></code></pre></div><p>Resolving this issue requires a different set of changes for each wrapper.</p>
<h3 id="marshalling-utf-8-strings-via-c-api">Marshalling UTF-8 strings via C API</h3>
<p>In case of the C API wrapper I used the wrong marshalling function - instead of <a href="https://learn.microsoft.com/en-us/dotnet/api/system.runtime.interopservices.marshal.ptrtostringansi">Marshal.PtrToStringAnsi()</a> it should be <a href="https://learn.microsoft.com/en-us/dotnet/api/system.runtime.interopservices.marshal.ptrtostringutf8">Marshal.PtrToStringUTF8()</a>.</p>
<p>For a bit more complex <a href="https://github.com/retifrav/csharp-cpp-example/blob/9e915651256b615cd49df6554e81d5e2b2daeca1/csharp/library/src/Some.cs#L37-L44">scenario</a>, when, say, you need to read a JSON file in C#, pass it to native C++ library for processing (<em>that&rsquo;s what JsonCpp dependency was for</em>) and return the result back to C#, the appropriate marshalling function for passing the JSON string from C# to C++ will be <a href="https://learn.microsoft.com/en-us/dotnet/api/system.runtime.interopservices.marshal.stringtocotaskmemutf8">Marshal.StringToCoTaskMemUTF8</a>, and to get the result back it will be <code>Marshal.PtrToStringUTF8()</code> again.</p>
<p>But even after making those changes you will likely get this even less readable output in the console (<em>mostly(?) occurs on Windows</em>):</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>some ???? ?? ???? ???? ?? ? ??????? ?? ? ????? ?? text
</span></span></code></pre></div><p>Now that has to do with the console code page / encoding, and for <code>Console.WriteLine()</code> output this is controlled with <a href="https://github.com/retifrav/csharp-cpp-example/commit/cbd0cf1184d8898322789db3ca7ea227b0bdc14c">Console.OutputEncoding</a>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cs" data-lang="cs"><span style="display:flex;"><span>Console.OutputEncoding = Encoding.UTF8;
</span></span></code></pre></div><p>What&rsquo;s peculiar though is that for Git BASH this will persist in the current console/terminal session even if you remove this line and rebuild the project from a complete scratch - it will still print the UTF-8 strings with no encoding issues, as if <code>Console.OutputEncoding</code> was still set to UTF-8. But if you launch the same re-built executable from a new Git BASH session, then it will again print the <code>???????</code> things. At the same time, PowerShell does not have this behaviour: in there it will reflect the changes related to <code>Console.OutputEncoding</code> after every build, as expected.</p>
<p>Finally, to make sure that this is really just about the console output, you can try <a href="https://github.com/retifrav/csharp-cpp-example/blob/2c781885b6e2d135e49551e50b35480b34f3cfc2/csharp/application/src/Program.cs#L80-L87">saving returned strings</a> to a text file and see for yourself that UTF-8 is preserved just fine, no matter what is set for <code>Console.OutputEncoding</code>.</p>
<h3 id="marshalling-utf-8-strings-via-ccli">Marshalling UTF-8 strings via C++/CLI</h3>
<p>In this wrapper the problem is that <a href="https://learn.microsoft.com/en-us/dotnet/fundamentals/runtime-libraries/system-string">System::String</a> in .NET is UTF-16, so instead of returning <code>std::string</code> it should be returning <code>std::wstring</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>std<span style="color:#f92672">::</span>string thng <span style="color:#f92672">=</span> dpndnc<span style="color:#f92672">::</span>doThingy();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// convert from UTF-8 to UTF-16 (System::String)
</span></span></span><span style="display:flex;"><span>std<span style="color:#f92672">::</span>wstring_convert<span style="color:#f92672">&lt;</span>std<span style="color:#f92672">::</span>codecvt_utf8_utf16<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">wchar_t</span><span style="color:#f92672">&gt;&gt;</span> converter;
</span></span><span style="display:flex;"><span>std<span style="color:#f92672">::</span>wstring thngWstring <span style="color:#f92672">=</span> converter.from_bytes(thng);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">return</span> msclr<span style="color:#f92672">::</span>interop<span style="color:#f92672">::</span>marshal_as<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">^&gt;</span>(thngWstring);
</span></span></code></pre></div><p>In that other more complex scenario of passing JSON string from C# to C++ and getting the processed result back, we first need to marshal <code>String^</code> into <code>std::wstring</code>, otherwise UTF-8 strings will get fucked, which is exactly what is happening <a href="https://github.com/retifrav/csharp-cpp-example/blob/4a99333514c2e540fc2f9ccf074ec0bae8d9e46d/cpp/library-clr/src/thingy-clr.cpp#L22">here</a>. So instead of getting fucked it should first go through the UTF-16/UTF-8 <a href="https://github.com/retifrav/csharp-cpp-example/blob/2c781885b6e2d135e49551e50b35480b34f3cfc2/cpp/library-clr/src/thingy-clr.cpp#L34-L38">conversion</a>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#75715e">// convert from System::String (UTF-16) to UTF-8
</span></span></span><span style="display:flex;"><span>std<span style="color:#f92672">::</span>wstring_convert<span style="color:#f92672">&lt;</span>std<span style="color:#f92672">::</span>codecvt_utf8_utf16<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">wchar_t</span><span style="color:#f92672">&gt;&gt;</span> converter;
</span></span><span style="display:flex;"><span>std<span style="color:#f92672">::</span>wstring jsnWstring <span style="color:#f92672">=</span> msclr<span style="color:#f92672">::</span>interop<span style="color:#f92672">::</span>marshal_as<span style="color:#f92672">&lt;</span>std<span style="color:#f92672">::</span>wstring<span style="color:#f92672">&gt;</span>(jsn);
</span></span><span style="display:flex;"><span>std<span style="color:#f92672">::</span>string jsnString <span style="color:#f92672">=</span> converter.to_bytes(jsnWstring);
</span></span></code></pre></div><p>and then converted <code>std::string</code> will get passed to the native C++ library for processing, and the processed string will be converted back to UTF-16 and marshalled to C#.</p>
<p>While trying this out on different Windows hosts, I noticed that in x64-based Windows environment (<em>running on an actual &ldquo;physical&rdquo; machine with x64-based CPU</em>) there was no need to do the UTF conversion, so I could just keep this:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>std<span style="color:#f92672">::</span>string bestBoobs <span style="color:#f92672">=</span> dpndnc<span style="color:#f92672">::</span>whoHasTheBestBoobs(
</span></span><span style="display:flex;"><span>    msclr<span style="color:#f92672">::</span>interop<span style="color:#f92672">::</span>marshal_as<span style="color:#f92672">&lt;</span>std<span style="color:#f92672">::</span>string<span style="color:#f92672">&gt;</span>(jsn)
</span></span><span style="display:flex;"><span>);
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">return</span> msclr<span style="color:#f92672">::</span>interop<span style="color:#f92672">::</span>marshal_as<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">^&gt;</span>(bestBoobs);
</span></span></code></pre></div><p>However, in ARM-based Windows environment (<em>running in a Parallels virtual machine on an ARM-based Mac</em>) the string was getting fucked, and there I had to convert it with <code>std::wstring_convert</code> to make it work.</p>
<h2 id="installation">Installation</h2>
<h3 id="installing-c-library">Installing C# library</h3>
<p>There is little to none point in doing a <a href="https://github.com/retifrav/csharp-cpp-example/blob/master/cpp/library/CMakeLists.txt#L35-L66">proper CMake installation</a> for the <a href="#c-library">C# library</a>, because chances that your customers/users will be using CMake to handle their C# projects are very slim. So then the entire installation would be just this:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cmake" data-lang="cmake"><span style="display:flex;"><span><span style="color:#75715e"># (if you haven&#39;t included it already)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"># definitions of CMAKE_INSTALL_LIBDIR, CMAKE_INSTALL_INCLUDEDIR and others
</span></span></span><span style="display:flex;"><span>include(<span style="color:#e6db74">GNUInstallDirs</span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span>install(<span style="color:#e6db74">TARGETS</span> <span style="color:#e6db74">some</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># should be no need to set these, they get default values from GNUInstallDirs
</span></span></span><span style="display:flex;"><span>    <span style="color:#75715e">#RUNTIME DESTINATION ${CMAKE_INSTALL_BINDIR} # bin
</span></span></span><span style="display:flex;"><span>    <span style="color:#75715e">#LIBRARY DESTINATION ${CMAKE_INSTALL_LIBDIR} # lib
</span></span></span><span style="display:flex;"><span>    <span style="color:#75715e">#ARCHIVE DESTINATION ${CMAKE_INSTALL_LIBDIR} # lib
</span></span></span><span style="display:flex;"><span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div><p>But trying to build the usual <code>install</code> target will fail:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-perl" data-lang="perl"><span style="display:flex;"><span>$ cmake <span style="color:#f92672">--</span>build <span style="color:#f92672">.</span> <span style="color:#f92672">--</span>config Release <span style="color:#f92672">--</span>target install
</span></span><span style="display:flex;"><span><span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>C:<span style="color:#f92672">\</span>Program Files<span style="color:#f92672">\</span>dotnet<span style="color:#f92672">\</span>sdk<span style="color:#f92672">\</span><span style="color:#ae81ff">9.0.304</span><span style="color:#f92672">\</span>Sdks<span style="color:#f92672">\</span>Microsoft<span style="color:#f92672">.</span>NET<span style="color:#f92672">.</span>Sdk<span style="color:#f92672">\</span>targets<span style="color:#f92672">\</span>Microsoft<span style="color:#f92672">.</span>PackageDependencyResolution<span style="color:#f92672">.</span>targets(<span style="color:#ae81ff">266</span>,<span style="color:#ae81ff">5</span>): error NETSDK1004: Assets file <span style="color:#e6db74">&#39;E:\code\dotnet\csharp-cpp-example\build\csharp\application\obj\project.assets.json&#39;</span> <span style="color:#f92672">not</span> found<span style="color:#f92672">.</span> Run a NuGet <span style="color:#66d9ef">package</span> restore to generate this file<span style="color:#f92672">.</span> [E:<span style="color:#f92672">\</span>code<span style="color:#f92672">\</span>dotnet<span style="color:#f92672">\</span>csharp<span style="color:#f92672">-</span>cpp<span style="color:#f92672">-</span>example<span style="color:#f92672">\</span>build<span style="color:#f92672">\</span>csharp<span style="color:#f92672">\</span>application<span style="color:#f92672">\</span>applctn<span style="color:#f92672">.</span>csproj]
</span></span><span style="display:flex;"><span>C:<span style="color:#f92672">\</span>Program Files<span style="color:#f92672">\</span>dotnet<span style="color:#f92672">\</span>sdk<span style="color:#f92672">\</span><span style="color:#ae81ff">9.0.304</span><span style="color:#f92672">\</span>Sdks<span style="color:#f92672">\</span>Microsoft<span style="color:#f92672">.</span>NET<span style="color:#f92672">.</span>Sdk<span style="color:#f92672">\</span>targets<span style="color:#f92672">\</span>Microsoft<span style="color:#f92672">.</span>PackageDependencyResolution<span style="color:#f92672">.</span>targets(<span style="color:#ae81ff">266</span>,<span style="color:#ae81ff">5</span>): error NETSDK1004: Assets file <span style="color:#e6db74">&#39;E:\code\dotnet\csharp-cpp-example\build\csharp\library\obj\project.assets.json&#39;</span> <span style="color:#f92672">not</span> found<span style="color:#f92672">.</span> Run a NuGet <span style="color:#66d9ef">package</span> restore to generate this file<span style="color:#f92672">.</span> [E:<span style="color:#f92672">\</span>code<span style="color:#f92672">\</span>dotnet<span style="color:#f92672">\</span>csharp<span style="color:#f92672">-</span>cpp<span style="color:#f92672">-</span>example<span style="color:#f92672">\</span>build<span style="color:#f92672">\</span>csharp<span style="color:#f92672">\</span>library<span style="color:#f92672">\</span>some<span style="color:#f92672">.</span>csproj]
</span></span></code></pre></div><p>By the looks of it, the <code>dotnet restore</code> command isn&rsquo;t run in this case, so you would need to first run the &ldquo;default&rdquo; build and only then <code>--target install</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ cmake --build . --config Release
</span></span><span style="display:flex;"><span>$ cmake --build . --config Release --target install
</span></span></code></pre></div><p>The result, however, won&rsquo;t be exactly satisfactory:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>../install/
</span></span><span style="display:flex;"><span>├── bin
</span></span><span style="display:flex;"><span>│   └── some.dll
</span></span><span style="display:flex;"><span>└── lib
</span></span><span style="display:flex;"><span>    ├── some.deps.json
</span></span><span style="display:flex;"><span>    ├── some.dll
</span></span><span style="display:flex;"><span>    └── thingy-clr.dll
</span></span></code></pre></div><p>Why the hell <code>some.dll</code> is duplicated in <code>lib</code>? Why <code>thingy-clr.dll</code> isn&rsquo;t in <code>bin</code>? What this <code>.deps.json</code> file is for? And where is <code>thingy-c-api.dll</code>? <del>Who the fuck knows</del> Actually, I know - the <code>RUNTIME DESTINATION</code> does need to be explicitly set, as it turns out:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cmake" data-lang="cmake"><span style="display:flex;"><span>install(<span style="color:#e6db74">TARGETS</span> <span style="color:#e6db74">some</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">RUNTIME</span> <span style="color:#e6db74">DESTINATION</span> <span style="color:#f92672">${</span>CMAKE_INSTALL_BINDIR<span style="color:#f92672">}</span> <span style="color:#75715e"># bin
</span></span></span><span style="display:flex;"><span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div><p>That will get rid of the redundant <code>lib</code> folder contents (<em>why - who the fuck knows</em>). And then adding the explicit installation of runtime dependencies:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cmake" data-lang="cmake"><span style="display:flex;"><span>install(
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">FILES</span> <span style="color:#f92672">$&lt;</span>TARGET_RUNTIME_DLLS:some<span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">DESTINATION</span> <span style="color:#f92672">${</span>CMAKE_INSTALL_BINDIR<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div><p>will get the missing DLLs into <code>bin</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>../install/
</span></span><span style="display:flex;"><span>└── bin
</span></span><span style="display:flex;"><span>    ├── some.dll
</span></span><span style="display:flex;"><span>    ├── thingy-c-api.dll
</span></span><span style="display:flex;"><span>    └── thingy-clr.dll
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ du -hs ../install/bin
</span></span><span style="display:flex;"><span>212K
</span></span></code></pre></div><p>or, if <code>thingy</code> was built as a <code>SHARED</code> library:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>../install/
</span></span><span style="display:flex;"><span>└── bin
</span></span><span style="display:flex;"><span>    ├── some.dll
</span></span><span style="display:flex;"><span>    ├── thingy-c-api.dll
</span></span><span style="display:flex;"><span>    ├── thingy-clr.dll
</span></span><span style="display:flex;"><span>    └── thingy.dll
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ du -hs ../install/bin
</span></span><span style="display:flex;"><span>168K
</span></span></code></pre></div><p>If anything, the full building/installing commands are these:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ cd /path/to/csharp-cpp-example/
</span></span><span style="display:flex;"><span>$ mkdir build <span style="color:#f92672">&amp;&amp;</span> cd $_
</span></span><span style="display:flex;"><span>$ cmake -G <span style="color:#e6db74">&#34;Visual Studio 17 2022&#34;</span> -DCMAKE_INSTALL_PREFIX<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;../install&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span>    -DCMAKE_TOOLCHAIN_FILE<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;</span>$VCPKG_ROOT<span style="color:#e6db74">/scripts/buildsystems/vcpkg.cmake&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span>    -DVCPKG_APPLOCAL_DEPS<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span>    ..
</span></span><span style="display:flex;"><span>$ cmake --build . --config Release
</span></span><span style="display:flex;"><span>$ cmake --build . --config Release --target install
</span></span></code></pre></div><p>And then you can pack the installation prefix (<em><code>../install/</code></em>) for distribution. And while at it, maybe consider doing that in a form of a NuGet package - your customers will be happy.</p>
<h3 id="installing-c-application">Installing C# application</h3>
<p>There is even less than zero reasons to do a CMake-based installation for a C# application, because while here in this particular example that application is a part of the project, in the real world it will likely be your customers/users own C# project, which almost most definitely won&rsquo;t be handled with CMake.</p>
<p>However, since we are such curious young men, let still take a look at how one would approach the process of installing a C# application with CMake.</p>
<p>The problem with this task is that default CMake installation facilities are quite useless for this purpose. Just take a look at the minimum set of what is required for the resulting application to be able to run (<em>you can see the full list inside your <code>/path/to/csharp-cpp-example/build/csharp/application/Release/</code></em>):</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>./build/csharp/application/Release/
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>├── applctn.dll
</span></span><span style="display:flex;"><span>├── applctn.exe
</span></span><span style="display:flex;"><span>├── applctn.runtimeconfig.json
</span></span><span style="display:flex;"><span>├── some.dll
</span></span><span style="display:flex;"><span>├── System.CommandLine.dll
</span></span><span style="display:flex;"><span>├── thingy-c-api.dll <span style="color:#75715e"># if you did `add_custom_command()` to copy runtime dependencies</span>
</span></span><span style="display:flex;"><span>├── thingy-clr.dll
</span></span><span style="display:flex;"><span>└── thingy.dll <span style="color:#75715e"># if `thingy` library was build as SHARED</span>
</span></span></code></pre></div><p>Naively trying to do the <a href="https://github.com/retifrav/csharp-cpp-example/blob/f7c725328178f8cdaf3334663216586ff6483122/csharp/application/CMakeLists.txt#L51-L54">standard installation</a>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cmake" data-lang="cmake"><span style="display:flex;"><span>install(<span style="color:#e6db74">TARGETS</span> <span style="color:#e6db74">applctn</span>
</span></span><span style="display:flex;"><span>   <span style="color:#e6db74">RUNTIME</span> <span style="color:#e6db74">DESTINATION</span> <span style="color:#f92672">${</span>CMAKE_INSTALL_BINDIR<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div><p>will only give you this:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>../install/
</span></span><span style="display:flex;"><span>└── bin
</span></span><span style="display:flex;"><span>    └── applctn.exe
</span></span></code></pre></div><p>Adding the <a href="https://github.com/retifrav/csharp-cpp-example/blob/f7c725328178f8cdaf3334663216586ff6483122/csharp/application/CMakeLists.txt#L55-L59">installation</a> of runtime dependencies:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cmake" data-lang="cmake"><span style="display:flex;"><span>install(
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">FILES</span> <span style="color:#f92672">$&lt;</span>TARGET_RUNTIME_DLLS:applctn<span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">DESTINATION</span> <span style="color:#f92672">${</span>CMAKE_INSTALL_BINDIR<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div><p>will improve the situation to some degree:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>../install/
</span></span><span style="display:flex;"><span>└── bin
</span></span><span style="display:flex;"><span>    ├── applctn.exe
</span></span><span style="display:flex;"><span>    ├── some.dll
</span></span><span style="display:flex;"><span>    ├── thingy-c-api.dll
</span></span><span style="display:flex;"><span>    ├── thingy-clr.dll
</span></span><span style="display:flex;"><span>    └── thingy.dll <span style="color:#75715e"># if is was build as SHARED</span>
</span></span></code></pre></div><p>but the resulting &ldquo;bundle&rdquo; will still be missing several dependencies and files, the important of which being the actual &ldquo;application&rdquo; - <code>applctn.dll</code>.</p>
<p>Certainly, all of the missing files can be hardcoded to be installed one by one, but this is not the way. So I would say, this is the end: CMake just isn&rsquo;t meant for installing of a C# application.</p>
<p>What I would do instead is simply pack the <code>/path/to/csharp-cpp-example/build/csharp/application/Release/</code> contents, and that would make a good enough distribution-ready package. Well, not yet, because right now it is missing some runtime dependencies, namely <code>thingy-c-api.dll</code> and <code>thingy.dll</code> (<em>if it was built as <code>SHARED</code></em>), so you&rsquo;ll need to do <a href="https://github.com/retifrav/csharp-cpp-example/blob/f7c725328178f8cdaf3334663216586ff6483122/csharp/application/CMakeLists.txt#L35-L43">this crutch</a>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cmake" data-lang="cmake"><span style="display:flex;"><span><span style="color:#75715e"># by some mysterious logic `thingy-clr.dll` gets copied on its own,
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"># but the rest of DLLs are not, hence this crutch
</span></span></span><span style="display:flex;"><span>add_custom_command(
</span></span><span style="display:flex;"><span>   <span style="color:#e6db74">TARGET</span> <span style="color:#e6db74">applctn</span>
</span></span><span style="display:flex;"><span>   <span style="color:#e6db74">POST_BUILD</span>
</span></span><span style="display:flex;"><span>   <span style="color:#e6db74">COMMAND</span> <span style="color:#f92672">${</span>CMAKE_COMMAND<span style="color:#f92672">}</span> <span style="color:#e6db74">-E</span> <span style="color:#e6db74">copy_if_different</span>
</span></span><span style="display:flex;"><span>       <span style="color:#f92672">$&lt;</span>TARGET_RUNTIME_DLLS:applctn<span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>       <span style="color:#f92672">$&lt;</span>TARGET_FILE_DIR:applctn<span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>   <span style="color:#e6db74">COMMAND_EXPAND_LISTS</span>
</span></span><span style="display:flex;"><span>   <span style="color:#e6db74">COMMENT</span> <span style="color:#e6db74">&#34;Copying the application dependencies DLLs&#34;</span>
</span></span><span style="display:flex;"><span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div><p>This could have been done in the C# library project file instead, but I think it better belongs with the application.</p>
<p>To summarize, here are the commands to build and run the example application:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ cd /path/to/csharp-cpp-example/
</span></span><span style="display:flex;"><span>$ mkdir build <span style="color:#f92672">&amp;&amp;</span> cd $_
</span></span><span style="display:flex;"><span>$ cmake -G <span style="color:#e6db74">&#34;Visual Studio 17 2022&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span>    -DCMAKE_TOOLCHAIN_FILE<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;</span>$VCPKG_ROOT<span style="color:#e6db74">/scripts/buildsystems/vcpkg.cmake&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span>    -DVCPKG_APPLOCAL_DEPS<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span>    ..
</span></span><span style="display:flex;"><span>$ cmake --build . --config Release
</span></span><span style="display:flex;"><span>$ ./csharp/application/Release/applctn.exe -j ./csharp/application/Release/grils.json
</span></span></code></pre></div><h1 id="platforms-other-than-windows">Platforms other than Windows</h1>
<p>As you might have noticed, so far it has all been somewhat implicitly just about Windows. But what about other platforms? Our native C++ library is cross-platform, and .NET is no longer a Windows-only framework either, so it should be possible to make them work together on outside of Windows environment too.</p>
<p>And it is possible (<em>I&rsquo;ve successfully built and run the project on Mac OS and GNU/Linux</em>), but unfortunately not everything will work.</p>
<p>First thing, as it was already mentioned, C# is supported in CMake only on Windows, because it needs a Visual Studio generator. For instance, if you try to configure this project on Mac OS or GNU/Linux, it will fail:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>CMake Error at /path/to/share/cmake/Modules/CMakeDetermineCSharpCompiler.cmake:5 <span style="color:#f92672">(</span>message<span style="color:#f92672">)</span>:
</span></span><span style="display:flex;"><span>  C# is currently only supported by Visual Studio generators.
</span></span></code></pre></div><p>So the C#/.NET parts will have to be handled with <code>dotnet</code> tool and <code>.csproj</code> files for both the <a href="#c-library">library</a> and the <a href="#c-application">application</a>. The C++ parts can still be done with CMake, no worries here.</p>
<p>Second thing that will remain Windows-only is the <a href="#ccli-clr">C++/CLI CLR</a> wrapper:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>/path/to/csharp-cpp-example/cpp/library-clr/src/thingy-clr.cpp:2:10: fatal error: <span style="color:#e6db74">&#39;msclr/marshal_cppstd.h&#39;</span> file not found
</span></span><span style="display:flex;"><span>    <span style="color:#ae81ff">2</span> | <span style="color:#75715e">#include &lt;msclr/marshal_cppstd.h&gt;</span>
</span></span><span style="display:flex;"><span>      |          ^~~~~~~~~~~~~~~~~~~~~~~~
</span></span></code></pre></div><p>because <code>msclr</code> is specific to MSVC on Windows. Which leaves <a href="#pinvoke">P/Invoke</a> the only available option for calling native C++ from C# on platforms other than Windows:</p>


    <img class="image-post" loading="lazy" src="/blog/2025/11/11/cpp-library-in-csharp/images/calling-cpp-from-csharp-without-cppcli.png" alt="One way of calling unmanaged C&#43;&#43; from managed C# on platforms other than Windows">

<p>But there is a bright side too, although a tiny one: there doesn&rsquo;t seem to be any issues with the text encoding neither on Mac OS nor on GNU/Linux, because not only I didn&rsquo;t need to do anything with <code>Console.OutputEncoding</code> to get the UTF-8 strings printed correctly, but also all the marshalling functions seem to be fine with their ANSI variants, so I could use <code>Marshal.StringToHGlobalAnsi()</code> (<em>instead of <code>Marshal.StringToCoTaskMemUTF8()</code></em>) and <code>Marshal.PtrToStringAnsi()</code> (<em>instead of <code>Marshal.PtrToStringUTF8()</code></em>).</p>
<h2 id="adapting-cmake-project-files">Adapting CMake project files</h2>
<p>Naturally, the C# part needs to be excluded on platforms that are not Windows:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-diff" data-lang="diff"><span style="display:flex;"><span><span style="color:#f92672">-add_subdirectory(csharp)
</span></span></span><span style="display:flex;"><span><span style="color:#a6e22e">+if(CMAKE_SYSTEM_NAME STREQUAL &#34;Windows&#34;)
</span></span></span><span style="display:flex;"><span><span style="color:#a6e22e">+    add_subdirectory(csharp)
</span></span></span><span style="display:flex;"><span><span style="color:#a6e22e">+endif()
</span></span></span></code></pre></div><p>The same goes for C++/CLI wrapper, since it is only available on Windows:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-diff" data-lang="diff"><span style="display:flex;"><span><span style="color:#f92672">-add_subdirectory(library-clr)
</span></span></span><span style="display:flex;"><span><span style="color:#a6e22e">+if(CMAKE_SYSTEM_NAME STREQUAL &#34;Windows&#34;)
</span></span></span><span style="display:flex;"><span><span style="color:#a6e22e">+    add_subdirectory(library-clr)
</span></span></span><span style="display:flex;"><span><span style="color:#a6e22e">+endif()
</span></span></span></code></pre></div><p>One last thing that needs changing is <code>__declspec(dllexport)</code>, because it also does not exist outside of Windows/MSVC:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>error: <span style="color:#e6db74">&#39;__declspec&#39;</span> attributes are not enabled; use <span style="color:#e6db74">&#39;-fdeclspec&#39;</span> or <span style="color:#e6db74">&#39;-fms-extensions&#39;</span> to enable support <span style="color:#66d9ef">for</span> __declspec attributes
</span></span></code></pre></div><p>For GCC it would instead be <code>__attribute__ ((visibility(&quot;default&quot;)))</code> and probably something else for Clang, but simply conditioning <code>__declspec</code> behind <code>_MSC_VER</code> definition <a href="https://github.com/retifrav/csharp-cpp-example/blob/f7c725328178f8cdaf3334663216586ff6483122/cpp/library/include/Thingy/thingy.h#L8-L13">would do fine</a> too:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid;"><code class="language-diff" data-lang="diff"><span style="display:flex;"><span> #if defined(thingy_EXPORTS)
</span></span><span style="display:flex;"><span><span style="color:#f92672">-    // export on compiling the DLL (when building)
</span></span></span><span style="display:flex;"><span><span style="color:#f92672">-    #define DLLEXPORT __declspec(dllexport)
</span></span></span><span style="display:flex; background-color:#3c3d38"><span><span style="color:#a6e22e">+    #ifdef _MSC_VER // for Windows/MSVC only
</span></span></span><span style="display:flex; background-color:#3c3d38"><span><span style="color:#a6e22e">+        // export on compiling the DLL (when building)
</span></span></span><span style="display:flex; background-color:#3c3d38"><span><span style="color:#a6e22e">+        #define DLLEXPORT __declspec(dllexport)
</span></span></span><span style="display:flex; background-color:#3c3d38"><span><span style="color:#a6e22e">+    //#elif __GNUC__ &gt;= 4 // for GCC
</span></span></span><span style="display:flex; background-color:#3c3d38"><span><span style="color:#a6e22e">+    //    #define DLLEXPORT __attribute__ ((visibility(&#34;default&#34;)))
</span></span></span><span style="display:flex; background-color:#3c3d38"><span><span style="color:#a6e22e">+    #endif // any other compilers require anything like that?
</span></span></span><span style="display:flex;"><span> // that does nothing good when this header is included in other libraries within the project
</span></span><span style="display:flex;"><span> //#else
</span></span><span style="display:flex;"><span><span style="color:#f92672">-//    // import on using the created DLL (when using in projects)
</span></span></span><span style="display:flex;"><span><span style="color:#f92672">-//    #define DLLEXPORT __declspec(dllimport)
</span></span></span><span style="display:flex;"><span><span style="color:#a6e22e">+//    #ifdef _MSC_VER // for Windows/MSVC only
</span></span></span><span style="display:flex;"><span><span style="color:#a6e22e">+//        // import on using the created DLL (when using in projects)
</span></span></span><span style="display:flex;"><span><span style="color:#a6e22e">+//        #define DLLEXPORT __declspec(dllimport)
</span></span></span><span style="display:flex;"><span><span style="color:#a6e22e">+//    #elif __GNUC__ &gt;= 4 // for GCC
</span></span></span><span style="display:flex;"><span><span style="color:#a6e22e">+//        // something here for GCC?
</span></span></span><span style="display:flex;"><span><span style="color:#a6e22e">+//    #endif // any other compilers require anything like that?
</span></span></span><span style="display:flex;"><span> #endif
</span></span></code></pre></div><p>and a similar change in <a href="https://github.com/retifrav/csharp-cpp-example/blob/f7c725328178f8cdaf3334663216586ff6483122/cpp/library-c-api/src/thingy-c-api.cpp#L3-L8">thingy-c-api.cpp</a> (<em>don&rsquo;t re-use the <code>DLLEXPORT</code> definition</em>).</p>
<h2 id="creating-msbuild-project-files">Creating MSBuild project files</h2>
<p>Since C# cannot be handled with CMake outside of Windows, we have to create <a href="https://learn.microsoft.com/en-us/dotnet/core/project-sdk/overview#project-files">MSBuild project files</a> for C# targets (<em>library and application</em>).</p>
<p>I&rsquo;ll be using Mac OS environment as an example, but it will be all the same on GNU/Linux too (<em>except for the file name extensions</em>). Just in case, here&rsquo;s my .NET environment on Mac OS:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ dotnet --info
</span></span><span style="display:flex;"><span>.NET SDK:
</span></span><span style="display:flex;"><span> Version:           9.0.305
</span></span><span style="display:flex;"><span> Commit:            3fc74f3529
</span></span><span style="display:flex;"><span> Workload version:  9.0.300-manifests.c2634b04
</span></span><span style="display:flex;"><span> MSBuild version:   17.14.21+8929ca9e3
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Runtime Environment:
</span></span><span style="display:flex;"><span> OS Name:     Mac OS X
</span></span><span style="display:flex;"><span> OS Version:  15.7
</span></span><span style="display:flex;"><span> OS Platform: Darwin
</span></span><span style="display:flex;"><span> RID:         osx-arm64
</span></span><span style="display:flex;"><span> Base Path:   /usr/local/share/dotnet/sdk/9.0.305/
</span></span></code></pre></div><p>A minimal project file for the library is rather short:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="color:#f92672">&lt;Project</span> <span style="color:#a6e22e">Sdk=</span><span style="color:#e6db74">&#34;Microsoft.NET.Sdk&#34;</span><span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&lt;PropertyGroup&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;TargetFramework&gt;</span>net9.0<span style="color:#f92672">&lt;/TargetFramework&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;ImplicitUsings&gt;</span>enable<span style="color:#f92672">&lt;/ImplicitUsings&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;Nullable&gt;</span>enable<span style="color:#f92672">&lt;/Nullable&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&lt;/PropertyGroup&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;/Project&gt;</span>
</span></span></code></pre></div><p>and it is almost the same for the application, just need to add the <code>OutputType</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="color:#f92672">&lt;Project</span> <span style="color:#a6e22e">Sdk=</span><span style="color:#e6db74">&#34;Microsoft.NET.Sdk&#34;</span><span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&lt;PropertyGroup&gt;</span>
</span></span><span style="display:flex; background-color:#3c3d38"><span>    <span style="color:#f92672">&lt;OutputType&gt;</span>Exe<span style="color:#f92672">&lt;/OutputType&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;TargetFramework&gt;</span>net9.0<span style="color:#f92672">&lt;/TargetFramework&gt;</span>
</span></span><span style="display:flex;"><span>    ...
</span></span></code></pre></div><p>Yes, it is <code>Exe</code> even though we are not on Windows. Without specifying it, you will get this error trying to launch the resulting <code>applctn.dll</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>A fatal error was encountered. The library <span style="color:#e6db74">&#39;libhostpolicy.dylib&#39;</span> required to execute the application was not found
</span></span></code></pre></div><p>Also, surprisingly, there is no need to list the source files for compilation. <a href="https://learn.microsoft.com/en-us/visualstudio/msbuild/how-to-select-the-files-to-build#default-behavior-by-project-type">Apparently</a>, it just takes all the <code>.cs</code> files that it finds in the project folder (<em>including subfolders</em>).</p>
<p>As an optional convenience step you can add copying the C API wrapper binary to the application output folder:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="color:#f92672">&lt;PropertyGroup&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&lt;MainProjectBuildFolder&gt;</span>../../build<span style="color:#f92672">&lt;/MainProjectBuildFolder&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&lt;DebugPostfix</span> <span style="color:#a6e22e">Condition=</span><span style="color:#e6db74">&#34;&#39;$(Configuration)&#39;==&#39;Debug&#39;&#34;</span><span style="color:#f92672">&gt;</span>d<span style="color:#f92672">&lt;/DebugPostfix&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;/PropertyGroup&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;ItemGroup&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&lt;ContentWithTargetPath</span> <span style="color:#a6e22e">Include=</span><span style="color:#e6db74">&#34;$(MainProjectBuildFolder)/cpp/library-c-api/libthingy-c-api$(DebugPostfix).$(LibraryExtension)&#34;</span><span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;TargetPath&gt;</span>libthingy-c-api$(DebugPostfix).dylib<span style="color:#f92672">&lt;/TargetPath&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;CopyToOutputDirectory&gt;</span>PreserveNewest<span style="color:#f92672">&lt;/CopyToOutputDirectory&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&lt;/ContentWithTargetPath&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;/ItemGroup&gt;</span>
</span></span></code></pre></div><p>or you can copy it manually yourself after the build. Related to that, if the original <a href="#native-c-library">native C++ library</a> is built as <code>SHARED</code>, you might think that the same would need to be done for its binary too, but in this case it will be <a href="#runtime-paths">somewhat different</a>.</p>
<p>Next, the C# source files need to be able to conditionally compile the C++/CLR parts, or rather to exclude them from compilation if the target platform is not Windows. According to the <a href="https://learn.microsoft.com/en-us/dotnet/csharp/language-reference/preprocessor-directives#conditional-compilation">documentation</a>, it should work with preprocessor directives like this:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cs" data-lang="cs"><span style="display:flex;"><span><span style="color:#75715e">#if</span> WINDOWS
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">string</span> DoThingyCLR()
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        / ...
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span><span style="color:#75715e">#endif</span>
</span></span></code></pre></div><p>but when I tried to test other definitions, such as <code>#if MACOS</code>, to explicitly fail the build, it still went fine in my Mac OS environment, as if <code>MACOS</code> was not defined. Besides, there doesn&rsquo;t seem to be a definition for Linux at all, so it really looks like these are broken/incomplete (<em>I should probably file a bugreport</em>). For now I went with <a href="https://stackoverflow.com/a/74437276/1688203">this workaround</a>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="color:#f92672">&lt;PropertyGroup</span> <span style="color:#a6e22e">Condition=</span><span style="color:#e6db74">&#34;$([MSBuild]::IsOSPlatform(&#39;Windows&#39;))&#34;</span><span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&lt;DefineConstants&gt;</span>OS_WINDOWS<span style="color:#f92672">&lt;/DefineConstants&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;/PropertyGroup&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;PropertyGroup</span> <span style="color:#a6e22e">Condition=</span><span style="color:#e6db74">&#34;$([MSBuild]::IsOSPlatform(&#39;Linux&#39;))&#34;</span><span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&lt;DefineConstants&gt;</span>OS_LINUX<span style="color:#f92672">&lt;/DefineConstants&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;/PropertyGroup&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;PropertyGroup</span> <span style="color:#a6e22e">Condition=</span><span style="color:#e6db74">&#34;$([MSBuild]::IsOSPlatform(&#39;OSX&#39;))&#34;</span><span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&lt;DefineConstants&gt;</span>OS_MAC<span style="color:#f92672">&lt;/DefineConstants&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;/PropertyGroup&gt;</span>
</span></span></code></pre></div><p>and then the preprocessor directive will be this:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cs" data-lang="cs"><span style="display:flex;"><span><span style="color:#75715e">#if</span> OS_WINDOWS
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">string</span> DoThingyCLR()
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        / ...
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span><span style="color:#75715e">#endif</span>
</span></span></code></pre></div><p>These directives are also needed to compose the correct C API wrapper binary file name, as it will be different between platforms:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cs" data-lang="cs"><span style="display:flex;"><span><span style="color:#75715e">#if</span> OS_LINUX
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">string</span> libraryPrefix = <span style="color:#e6db74">&#34;&#34;</span>; <span style="color:#75715e">// &#34;lib&#34; // looks like DllImport is smart enough to add `lib` suffix on its own</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">string</span> libraryExtension = <span style="color:#e6db74">&#34;so&#34;</span>;
</span></span><span style="display:flex;"><span><span style="color:#75715e">#elif</span> OS_MAC
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">string</span> libraryPrefix = <span style="color:#e6db74">&#34;&#34;</span>; <span style="color:#75715e">// &#34;lib&#34; // looks like DllImport is smart enough to add `lib` suffix on its own</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">string</span> libraryExtension = <span style="color:#e6db74">&#34;dylib&#34;</span>;
</span></span><span style="display:flex;"><span><span style="color:#75715e">#else</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">string</span> libraryPrefix = <span style="color:#e6db74">&#34;&#34;</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">string</span> libraryExtension = <span style="color:#e6db74">&#34;dll&#34;</span>;
</span></span><span style="display:flex;"><span><span style="color:#75715e">#endif</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">string</span> thingyDLLfileName = <span style="color:#e6db74">$&#34;{libraryPrefix}thingy-c-api{debugPostfix}.{libraryExtension}&#34;</span>;
</span></span></code></pre></div><p>And then these definitions also need to be <a href="https://github.com/retifrav/csharp-cpp-example/blob/e2379a39f49a1a4541b124724f01ece307848d0e/csharp/library/CMakeLists.txt#L24-L42">added</a> to the CMake project file for the library:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cmake" data-lang="cmake"><span style="display:flex;"><span><span style="color:#75715e"># the scope is `PUBLIC` so these definitions would also propagate to the application
</span></span></span><span style="display:flex;"><span>if(<span style="color:#e6db74">CMAKE_SYSTEM_NAME</span> <span style="color:#e6db74">STREQUAL</span> <span style="color:#e6db74">&#34;Windows&#34;</span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span>    target_compile_definitions(<span style="color:#e6db74">some</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">PUBLIC</span>
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">OS_WINDOWS</span>
</span></span><span style="display:flex;"><span>    )<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span>elseif(<span style="color:#e6db74">CMAKE_SYSTEM_NAME</span> <span style="color:#e6db74">STREQUAL</span> <span style="color:#e6db74">&#34;Linux&#34;</span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span>    target_compile_definitions(<span style="color:#e6db74">some</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">PUBLIC</span>
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">OS_LINUX</span>
</span></span><span style="display:flex;"><span>    )<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span>elseif(<span style="color:#e6db74">CMAKE_SYSTEM_NAME</span> <span style="color:#e6db74">STREQUAL</span> <span style="color:#e6db74">&#34;Darwin&#34;</span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span>    target_compile_definitions(<span style="color:#e6db74">some</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">PUBLIC</span>
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">OS_MAC</span>
</span></span><span style="display:flex;"><span>    )<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span>else()<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span>    <span style="color:#75715e"># although it might actually work on other platforms
</span></span></span><span style="display:flex;"><span>    message(<span style="color:#e6db74">FATAL_ERROR</span> <span style="color:#e6db74">&#34;Unknown/unsupported platform&#34;</span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span>endif()<span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div><p>otherwise building the project on Windows will no longer be correct</p>
<p>Now the only thing left to do is to include the library project in the application project and also add a reference to that NuGet package for CLI arguments parsing:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="color:#f92672">&lt;ItemGroup&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&lt;ProjectReference</span> <span style="color:#a6e22e">Include=</span><span style="color:#e6db74">&#34;../library/some.csproj&#34;</span> <span style="color:#f92672">/&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;/ItemGroup&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;ItemGroup&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&lt;PackageReference</span> <span style="color:#a6e22e">Include=</span><span style="color:#e6db74">&#34;System.CommandLine&#34;</span> <span style="color:#a6e22e">Version=</span><span style="color:#e6db74">&#34;2.0.0-rc.1.25451.107&#34;</span> <span style="color:#f92672">/&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;/ItemGroup&gt;</span>
</span></span></code></pre></div><p>Conveniently, including the library project bring the OS preprocessor definitions (<em>those in <code>DefineConstants</code></em>), so they will be available in the applications sources too.</p>
<p>The building commands will now consist of two parts:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ cd /path/to/csharp-cpp-example
</span></span><span style="display:flex;"><span>$ mkdir build <span style="color:#f92672">&amp;&amp;</span> cd $_
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ echo <span style="color:#e6db74">&#39;1. Building the C++ libraries with CMake&#39;</span>
</span></span><span style="display:flex;"><span>$ echo <span style="color:#e6db74">&#39;(can use Ninja now)&#39;</span>
</span></span><span style="display:flex;"><span>$ cmake -G Ninja -DCMAKE_BUILD_TYPE<span style="color:#f92672">=</span>Release <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span>    -DCMAKE_TOOLCHAIN_FILE<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;</span>$VCPKG_ROOT<span style="color:#e6db74">/scripts/buildsystems/vcpkg.cmake&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span>    ..
</span></span><span style="display:flex;"><span>$ cmake --build .
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ echo <span style="color:#e6db74">&#39;2. Building C# library and application with dotnet&#39;</span>
</span></span><span style="display:flex;"><span>$ mkdir ./csharp <span style="color:#f92672">&amp;&amp;</span> cd $_
</span></span><span style="display:flex;"><span>$ dotnet build ../../csharp/application/applctn.csproj <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span>    --artifacts-path . <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span>    --configuration Release
</span></span></code></pre></div><p>That build will produce the following artifacts for C# application and library:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ tree ./bin/ -L <span style="color:#ae81ff">3</span> --dirsfirst
</span></span><span style="display:flex;"><span>./bin/
</span></span><span style="display:flex;"><span>├── applctn
</span></span><span style="display:flex;"><span>│   └── release
</span></span><span style="display:flex;"><span>│       ├── cs
</span></span><span style="display:flex;"><span>│       ├── de
</span></span><span style="display:flex;"><span>│       ├── es
</span></span><span style="display:flex;"><span>│       ├── fr
</span></span><span style="display:flex;"><span>│       ├── it
</span></span><span style="display:flex;"><span>│       ├── ja
</span></span><span style="display:flex;"><span>│       ├── ko
</span></span><span style="display:flex;"><span>│       ├── pl
</span></span><span style="display:flex;"><span>│       ├── pt-BR
</span></span><span style="display:flex;"><span>│       ├── ru
</span></span><span style="display:flex;"><span>│       ├── tr
</span></span><span style="display:flex;"><span>│       ├── zh-Hans
</span></span><span style="display:flex;"><span>│       ├── zh-Hant
</span></span><span style="display:flex;"><span>│       ├── applctn
</span></span><span style="display:flex;"><span>│       ├── applctn.deps.json
</span></span><span style="display:flex;"><span>│       ├── applctn.dll
</span></span><span style="display:flex;"><span>│       ├── applctn.pdb
</span></span><span style="display:flex;"><span>│       ├── applctn.runtimeconfig.json
</span></span><span style="display:flex;"><span>│       ├── grils.json
</span></span><span style="display:flex;"><span>│       ├── libthingy-c-api.dylib
</span></span><span style="display:flex;"><span>│       ├── some.dll
</span></span><span style="display:flex;"><span>│       ├── some.pdb
</span></span><span style="display:flex;"><span>│       └── System.CommandLine.dll
</span></span><span style="display:flex;"><span>└── some
</span></span><span style="display:flex;"><span>    └── release
</span></span><span style="display:flex;"><span>        ├── libthingy-c-api.dylib
</span></span><span style="display:flex;"><span>        ├── some.deps.json
</span></span><span style="display:flex;"><span>        ├── some.dll
</span></span><span style="display:flex;"><span>        └── some.pdb
</span></span></code></pre></div><p>Out of these the <code>./bin/some/release/</code> folder contents is what you can pack for distribution for your customers/users (<em>probably as a NuGet package</em>). And <code>./bin/applctn/release/</code> folder is the example application &ldquo;bundle&rdquo;, which you can run directly via its &ldquo;launcher&rdquo;:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ ./bin/applctn/release/applctn -j ./bin/applctn/release/grils.json
</span></span></code></pre></div><p>or just the assembly via <code>dotnet</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ dotnet ./bin/applctn/release/applctn.dll -j ./bin/applctn/release/grils.json
</span></span></code></pre></div><h3 id="runtime-paths">Runtime paths</h3>
<p>You probably already know <a href="/blog/2021/03/08/cmake-cpp-library/#static-vs-shared">all this</a>, but I thought that it wouldn&rsquo;t hurt to repeat it one more time, so here goes.</p>
<p>While the <a href="#c-api-wrapper">C API wrapper</a> binary (<em><code>libthingy-c-api.dylib</code></em>) can be simply placed alongside <code>some.dll</code> to be discovered with <code>DLLImport</code>, it is a different story with the <a href="#native-c-library">native C++ library</a> when it is built as <code>SHARED</code>.</p>
<p>It will work fine right after you build the application, but if you try to launch it on a different host or if you move <code>/path/to/csharp-cpp-example/build/cpp/library/libthingy.dylib</code> to some other location, then the application will still launch but it will fail at runtime trying to do <code>DLLImport</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>Unhandled exception. System.DllNotFoundException: Unable to load shared library <span style="color:#e6db74">&#39;thingy-c-api.dylib&#39;</span> or one of its dependencies
</span></span></code></pre></div><p>And that is because <a href="https://blog.krzyzanowskim.com/2018/12/05/rpath-what/">@rpath</a> inside the binary is &ldquo;hardcoded&rdquo; to <code>/path/to/csharp-cpp-example/build/cpp/library/</code>, and that is where it will be looking for <code>libthingy.dylib</code>. To remedy that, on Mac OS you&rsquo;ll need to set the <code>DYLD_LIBRARY_PATH</code> (<em><code>LD_LIBRARY_PATH</code> on GNU/Linux</em>) environment variable pointing to the new location:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ DYLD_LIBRARY_PATH<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;/path/to/some/other/location/where/libthingy/is/now&#39;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span>    ./applctn -j /path/to/grils.json
</span></span></code></pre></div><p>or copy the <code>thingy</code> shared library to the current application folder and use that one:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ cp /path/to/some/other/location/where/it/is/now/libthingy.dylib ./
</span></span><span style="display:flex;"><span>$ ls -L1 ./*.dylib
</span></span><span style="display:flex;"><span>./libthingy-c-api.dylib*
</span></span><span style="display:flex;"><span>./libthingy.dylib*
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ DYLD_LIBRARY_PATH<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;.&#39;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span>    ./applctn -j /path/to/grils.json
</span></span></code></pre></div><p>Or, which perhaps should be a preferred solution, you can control <code>RPATH</code> in CMake with either <a href="https://cmake.org/cmake/help/latest/prop_tgt/INSTALL_RPATH.html">INSTALL_RPATH</a> or <a href="https://cmake.org/cmake/help/latest/prop_tgt/BUILD_RPATH.html">BUILD_RPATH</a>, depending on whether you plan to do a CMake-based installation or not.</p>
<h1 id="maui">MAUI</h1>
<p><a href="https://dotnet.microsoft.com/en-us/apps/maui">MAUI</a> (<em>former <a href="https://dotnet.microsoft.com/en-us/apps/xamarin">Xamarin</a></em>) is also .NET, innit, so let&rsquo;s try to use our <a href="#native-c-library">C++ library</a> in a MAUI application too, for example on iOS (<em>simulator</em>).</p>
<p>To install MAUI on Mac OS, assuming that your current user is not an admin (<em>so no <code>sudo</code></em>), you can follow the official Microsoft <a href="https://learn.microsoft.com/en-us/dotnet/maui/ios/cli">documentation</a>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ whoami
</span></span><span style="display:flex;"><span>vasya
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ cd /tmp
</span></span><span style="display:flex;"><span>$ su ADMIN-USER-ON-YOUR-MAC
</span></span><span style="display:flex;"><span>$ whoami
</span></span><span style="display:flex;"><span>ADMIN-USER-ON-YOUR-MAC
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ sudo dotnet workload install maui --source https://api.nuget.org/v3/index.json
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ exit
</span></span><span style="display:flex;"><span>$ whoami
</span></span><span style="display:flex;"><span>vasya
</span></span></code></pre></div><p>Then generate and build a default sample project from the MAUI template:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ cd /path/to/csharp-cpp-example/csharp/
</span></span><span style="display:flex;"><span>$ mkdir maui <span style="color:#f92672">&amp;&amp;</span> cd $_
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ dotnet new maui
</span></span><span style="display:flex;"><span>The template <span style="color:#e6db74">&#34;.NET MAUI App&#34;</span> was created successfully.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Processing post-creation actions...
</span></span><span style="display:flex;"><span>Restoring /Users/vasya/code/dotnet/csharp-cpp-example/csharp/maui/maui.csproj:
</span></span><span style="display:flex;"><span>Restore succeeded. 
</span></span></code></pre></div><p>So far so good, but trying to build it did not succeed in my case:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ cd /path/to/csharp-cpp-example/
</span></span><span style="display:flex;"><span>$ mkdir -p ./build/maui <span style="color:#f92672">&amp;&amp;</span> cd $_
</span></span><span style="display:flex;"><span>$ dotnet build ../../csharp/maui/maui.csproj <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span>    --artifacts-path . <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span>    --configuration Debug <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span>    -f net9.0-ios <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span>    -t:Run
</span></span><span style="display:flex;"><span>  maui net9.0-ios failed with <span style="color:#ae81ff">1</span> error<span style="color:#f92672">(</span>s<span style="color:#f92672">)</span> <span style="color:#f92672">(</span>0.3s<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    /usr/local/share/dotnet/packs/Microsoft.iOS.Sdk.net9.0_26.0/26.0.9766/targets/Xamarin.Shared.Sdk.targets<span style="color:#f92672">(</span>2346,3<span style="color:#f92672">)</span>: error : This version of .NET <span style="color:#66d9ef">for</span> iOS <span style="color:#f92672">(</span>26.0.9766<span style="color:#f92672">)</span> requires Xcode 26.0. The current version of Xcode is 26.1. Either install Xcode 26.0, or use a different version of .NET <span style="color:#66d9ef">for</span> iOS. See https://aka.ms/xcode-requirement <span style="color:#66d9ef">for</span> more information.
</span></span></code></pre></div><p>Here it complains that my Xcode is of a wrong version, and indeed, I&rsquo;ve just recently updated it to version <code>26.1</code>, but (<em>god knows why</em>) it needs exactly <code>26.0</code>. They <a href="https://github.com/dotnet/maui/discussions/31662#discussioncomment-14879582">say</a> that support for Xcode <code>26.1</code> will be added only in .NET 10, so I cannot proceed until this one is released (<em>I fukken lold, they actually <a href="https://devblogs.microsoft.com/dotnet/announcing-dotnet-10/">released</a> it on the same day as I was publishing this article, but I noticed that only afterwards</em>).</p>
<p>Well, not all the hope has been lost yet, let&rsquo;s try to install a separate Xcode with version <code>26.0</code> using <a href="https://github.com/XcodesOrg/xcodes">xcodes</a> tool:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ brew install xcodesorg/made/xcodes
</span></span><span style="display:flex;"><span>$ xcodes install 26.0 --directory ~/Applications --no-superuser
</span></span></code></pre></div><p>It will ask for your Apple ID credentials, which is rich, coming from a random tool downloaded from the internet (<em>I guess it is Apple who we we should thank for that</em>), but fortunately I have a spare Apple ID account that can be used for things like that.</p>
<p>Be aware that after downloading and unpacking to the specified folder (<em><code>~/Applications/</code></em>) it will also keep the files here:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ du -hs /Users/vasya/Library/Application<span style="color:#ae81ff">\ </span>Support/com.robotsandpencils.xcodes
</span></span><span style="display:flex;"><span>4.6G
</span></span></code></pre></div><p>which you might want to delete to save some space (<em>unless this is used for symlinking or something</em>).</p>
<p>Having installed the precious Xcode <code>26.0</code>, you need to <a href="https://learn.microsoft.com/en-us/dotnet/maui/ios/cli#build-with-a-specific-version-of-xcode">specify it</a> for the MAUI build (<em>I wonder why do they have a documentation section for exactly that</em>):</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ MD_APPLE_SDK_ROOT<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;/Users/vasya/Applications/Xcode-26.0.0.app&#39;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span>    dotnet build ../../csharp/maui/maui.csproj <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span>    --artifacts-path . <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span>    --configuration Debug <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span>    -f net9.0-ios <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span>    -t:Run
</span></span></code></pre></div><p>Too bad it still failed for me, but at least with a different error:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>maui net9.0-ios failed with <span style="color:#ae81ff">1</span> error<span style="color:#f92672">(</span>s<span style="color:#f92672">)</span> <span style="color:#f92672">(</span>72.8s<span style="color:#f92672">)</span> → bin/Debug/net9.0-ios/iossimulator-arm64/maui.dll
</span></span><span style="display:flex;"><span>  /usr/local/share/dotnet/packs/Microsoft.iOS.Sdk.net9.0_26.0/26.0.9766/tools/msbuild/Xamarin.Shared.targets<span style="color:#f92672">(</span>3082,3<span style="color:#f92672">)</span>: error :
</span></span><span style="display:flex;"><span>    mdimport exited with code 72:
</span></span><span style="display:flex;"><span>    xcrun: error: sh -c <span style="color:#e6db74">&#39;/Applications/Xcode.app/Contents/Developer/usr/bin/xcodebuild -sdk /Applications/Xcode.app/Contents/Developer/Platforms/MacOSX.platform/Developer/SDKs/MacOSX.sdk -find mdimport 2&gt; /dev/null&#39;</span> failed with exit code 16384: <span style="color:#f92672">(</span>null<span style="color:#f92672">)</span> <span style="color:#f92672">(</span>errno<span style="color:#f92672">=</span>Invalid argument<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    xcrun: error: unable to find utility <span style="color:#e6db74">&#34;mdimport&#34;</span>, not a developer tool or in PATH
</span></span></code></pre></div><p>What the fuck is this shit. The <code>mdimport</code> is something from Spotlight, so what does it have to do with anything? Anyway, I have it available in the system:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ which mdimport
</span></span><span style="display:flex;"><span>/usr/bin/mdimport
</span></span></code></pre></div><p>but apparently something is fucked in the way <code>MD_APPLE_SDK_ROOT</code> is processed or something of the sort. The <code>/Applications/Xcode.app/</code> path also points to that, because it shouldn&rsquo;t be using my main Xcode, should it? I have no idea how to resolve this, so I just edited that <code>/path/to/Xamarin.Shared.targets</code> and commented out this block:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="color:#75715e">&lt;!-- make sure spotlight indexes everything we&#39;ve built --&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">&lt;!--Target
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">    Name=&#34;_NotifySpotlight&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">    Condition=&#34;&#39;$(_PostProcess)&#39; == &#39;true&#39;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">    &gt;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">    &lt;SpotlightIndexer
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">        SessionId=&#34;$(BuildSessionId)&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">        Condition=&#34;&#39;$(IsMacEnabled)&#39; == &#39;true&#39;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">        Input=&#34;$(_AppContainerDir)&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">        MdimportPath=&#34;$(MdimportPath)&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">    /&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">&lt;/Target--&gt;</span>
</span></span></code></pre></div><p>and this line:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="color:#f92672">&lt;PropertyGroup&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;_PostProcessAppBundleDependsOn&gt;</span>
</span></span><span style="display:flex;"><span>        $(_PostProcessAppBundleDependsOn);
</span></span><span style="display:flex;"><span>        $(GenerateDebugSymbolsDependsOn);
</span></span><span style="display:flex;"><span>        _CollectItemsForPostProcessing;
</span></span><span style="display:flex;"><span>        _StoreCollectedItemsForPostProcessing;
</span></span><span style="display:flex;"><span>        _PreparePostProcessing;
</span></span><span style="display:flex;"><span>        _GenerateDSym;
</span></span><span style="display:flex;"><span>        _NativeStripFiles;
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">&lt;!-- _NotifySpotlight; --&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;/_PostProcessAppBundleDependsOn&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;/PropertyGroup&gt;</span>
</span></span></code></pre></div><p>and then the build proceeded further, but still failed with a different error:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>maui net9.0-ios failed with <span style="color:#ae81ff">4</span> error<span style="color:#f92672">(</span>s<span style="color:#f92672">)</span> <span style="color:#f92672">(</span>8.6s<span style="color:#f92672">)</span> → bin/Debug/net9.0-ios/iossimulator-arm64/maui.dll
</span></span><span style="display:flex;"><span>  xcrun : error : sh -c <span style="color:#e6db74">&#39;/Applications/Xcode.app/Contents/Developer/usr/bin/xcodebuild -sdk /Applications/Xcode.app/Contents/Developer/Platforms/MacOSX.platform/Developer/SDKs/MacOSX.sdk -find simctl 2&gt; /dev/null&#39;</span> failed with exit code 16384: <span style="color:#f92672">(</span>null<span style="color:#f92672">)</span> <span style="color:#f92672">(</span>errno<span style="color:#f92672">=</span>Invalid argument<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>  xcrun : error : unable to find utility <span style="color:#e6db74">&#34;simctl&#34;</span>, not a developer tool or in PATH
</span></span><span style="display:flex;"><span>  EXEC : error MT1008: Failed to launch the simulator: One or more errors occurred. <span style="color:#f92672">(</span>Failed to execute <span style="color:#e6db74">&#39;simctl&#39;</span>: <span style="color:#e6db74">&#39;simctl list --json --json-output /var/folders/wd/4c2hx441481fymd61hdcqvpw0000gn/T/tmpDD0zKG.tmp&#39;</span> returned the exit code 72.<span style="color:#f92672">)</span> <span style="color:#f92672">(</span>Additional output: xcrun simctl list --json --json-output /var/folders/wd/4c2hx441481fymd61hdcqvpw0000gn/T/tmpDD0zKG.tmp<span style="color:#f92672">)</span> <span style="color:#f92672">(</span>Additional output: xcrun: error: sh -c <span style="color:#e6db74">&#39;/Applications/Xcode.app/Contents/Developer/usr/bin/xcodebuild -sdk /Applications/Xcode.app/Contents/Developer/Platforms/MacOSX.platform/Developer/SDKs/MacOSX.sdk -find simctl 2&gt; /dev/null&#39;</span> failed with exit code 16384: <span style="color:#f92672">(</span>null<span style="color:#f92672">)</span> <span style="color:#f92672">(</span>errno<span style="color:#f92672">=</span>Invalid argument<span style="color:#f92672">))</span> <span style="color:#f92672">(</span>Additional output: xcrun: error: unable to find utility <span style="color:#e6db74">&#34;simctl&#34;</span>, not a developer tool or in PATH<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>  /usr/local/share/dotnet/sdk/9.0.305/Sdks/Microsoft.NET.Sdk/targets/Microsoft.NET.Sdk.targets<span style="color:#f92672">(</span>1175,5<span style="color:#f92672">)</span>: error MSB3073: The command <span style="color:#e6db74">&#34;&#39;/usr/local/share/dotnet/packs/Microsoft.iOS.Sdk.net9.0_26.0/26.0.9766/tools/bin/mlaunch&#39; --launchsim bin/Debug/net9.0-ios/iossimulator-arm64/maui.app/ --device :v2:runtime=com.apple.CoreSimulator.SimRuntime.iOS-26-0,devicetype=com.apple.CoreSimulator.SimDeviceType.iPhone-11 --stdout /dev/ttys007 --stderr /dev/ttys007 --wait-for-exit:true&#34;</span> exited with code 1.
</span></span></code></pre></div><p>Motherfucker. This shit looks similar to the previous one, so this one too is likely related to something being screwed about the <code>MD_APPLE_SDK_ROOT</code>, but now I don&rsquo;t even know what other file I could eviscerate to work around that problem. Fortunately, this seems to be the last step of the building process, because I suddenly noticed that <code>maui.app</code> was already in the build folder, so it just failed to launch the simulator and install the application there. But that is no worries: just drop the <code>-t:Run</code> option and install the application manually after the build (<em>there will be a video later</em>).</p>
<p>Now let&rsquo;s try to use our <a href="#c-library">library</a> in the MAUI application. The <a href="https://github.com/retifrav/csharp-cpp-example/blob/4ddb462a5357d56febf707cc9ad9b0950ad5b720/csharp/maui/maui.csproj">MSBuild project file</a> has already been generated from the template, and so have been the application sources, which makes things easier.</p>
<p>There are still some challenges to overcome, though. The first one is to build our <a href="#native-c-library">native C++ library</a> (<em>and its dependency JsonCpp</em>) for iOS. The vcpkg part is easy - you just use the appropriate triplet - but for the love of god I couldn&rsquo;t figure out how to generate and build for iOS using Ninja, so I had to resort to Xcode generator:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ cd /path/to/csharp-cpp-example
</span></span><span style="display:flex;"><span>$ mkdir build <span style="color:#f92672">&amp;&amp;</span> cd $_
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ cmake -G Xcode <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span>    -DCMAKE_TOOLCHAIN_FILE<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;</span>$VCPKG_ROOT<span style="color:#e6db74">/scripts/buildsystems/vcpkg.cmake&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span>    -DVCPKG_TARGET_TRIPLET<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;arm64-ios-simulator&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span>    -DCMAKE_SYSTEM_NAME<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;iOS&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span>    -DCMAKE_OSX_SYSROOT<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;iphonesimulator&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span>    -DCMAKE_OSX_ARCHITECTURES<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;arm64&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span>    ..
</span></span><span style="display:flex;"><span>$ cmake --build . --config Debug
</span></span></code></pre></div><p>Specifying <code>-DCMAKE_OSX_ARCHITECTURES=&quot;arm64&quot;</code> is important, because even though my Mac is ARM-based M2 model, so there should be no <code>x86_64</code> architecture involved, the build would still fail with:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>Undefined symbols <span style="color:#66d9ef">for</span> architecture x86_64:
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;Json::Value::Value(Json::ValueType)&#34;</span>, referenced from:
</span></span><span style="display:flex;"><span>      dpndnc::whoHasTheBestBoobs<span style="color:#f92672">(</span>std::__1::basic_string&lt;char, std::__1::char_traits&lt;char&gt;, std::__1::allocator&lt;char&gt;&gt;, int<span style="color:#f92672">)</span> in libthingyd.a<span style="color:#f92672">[</span>x86_64<span style="color:#f92672">][</span>2<span style="color:#f92672">](</span>thingy.o<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>warning: ONLY_ACTIVE_ARCH<span style="color:#f92672">=</span>YES requested with multiple ARCHS and no active architecture could be computed; building <span style="color:#66d9ef">for</span> all applicable architectures <span style="color:#f92672">(</span>in target <span style="color:#e6db74">&#39;ZERO_CHECK&#39;</span> from project <span style="color:#e6db74">&#39;csharp-cpp-example&#39;</span><span style="color:#f92672">)</span>
</span></span></code></pre></div><p>While I still had energy to be curious, I also tried building with <code>-DBUILD_SHARED_LIBS=1</code> - just to try things out, but then I realized that I don&rsquo;t know how to set <code>DYLD_LIBRARY_PATH</code> inside the MAUI application bundle deployed on the device (<em>and I just wanted all that to be over</em>), so the native C++ library is built as <code>STATIC</code> in this example.</p>
<p>The only change in the MAUI application project file is the C# library project reference:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="color:#f92672">&lt;ItemGroup&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;ProjectReference</span> <span style="color:#a6e22e">Include=</span><span style="color:#e6db74">&#34;../library/some.csproj&#34;</span> <span style="color:#f92672">/&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;/ItemGroup&gt;</span>
</span></span></code></pre></div><p>But there was also a change in the library&rsquo;s own project file, because that convenience step of copying the <code>libthingy-c-api.dylib</code> into the build folder needed to be adjusted to the Xcode build folder structure, as it is yet again different (<em>from both Visual Studio and Ninja</em>). And here I could not find the right MSBuild conditions for detecting iOS simulator target, so instead I made a <a href="https://github.com/retifrav/csharp-cpp-example/blob/6b58e7fb3680da5f9f02200174a96a2f5ae854e6/csharp/library/some.csproj#L11-L13">dumb property</a> that can be set with a CLI argument <code>/p:ApplicationTargetPlatform</code>.</p>
<p>Bringing it all together, here is the full build procedure:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ cd /path/to/csharp-cpp-example
</span></span><span style="display:flex;"><span>$ mkdir build <span style="color:#f92672">&amp;&amp;</span> cd $_
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ cmake -G Xcode <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span>    -DCMAKE_TOOLCHAIN_FILE<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;</span>$VCPKG_ROOT<span style="color:#e6db74">/scripts/buildsystems/vcpkg.cmake&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span>    -DVCPKG_TARGET_TRIPLET<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;arm64-ios-simulator&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span>    -DCMAKE_SYSTEM_NAME<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;iOS&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span>    -DCMAKE_OSX_SYSROOT<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;iphonesimulator&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span>    -DCMAKE_OSX_ARCHITECTURES<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;arm64&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span>    ..
</span></span><span style="display:flex;"><span>$ cmake --build . --config Debug
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ mkdir ./maui <span style="color:#f92672">&amp;&amp;</span> cd $_
</span></span><span style="display:flex;"><span>$ MD_APPLE_SDK_ROOT<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;/Users/vasya/Applications/Xcode-26.0.0.app&#39;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span>    dotnet build ../../csharp/maui/maui.csproj <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span>    --artifacts-path . <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span>    --configuration Debug <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span>    -f net9.0-ios <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span>    /p:ApplicationTargetPlatform<span style="color:#f92672">=</span>ios-simulator
</span></span></code></pre></div><p>As you can see, it is building <code>Debug</code> configuration, and the reason is that trying to build with <code>--configuration Release</code> starts some never-ending <code>_AOTCompile</code> nonsense - I was literally sitting and waiting for several minutes for the build to end, but it never did. During that time the build folder size was growing indefinitely too, and it was over a gigabyte when I stopped the build. Oh and actually there was no stopping it, I had to kill the process(es) several times.</p>
<p>So yeah, since this is merely an example project, <code>--configuration Debug</code> will do fine. And it did - the build was done in about 20 seconds, and the output folder size was &ldquo;just&rdquo; 315 MB of some tremendous amount of crap (<em>you can see a glimpse of it on the video below</em>).</p>
<p>Once you have the application bundle, installing it in iOS simulator is simply a matter of dragging it there:</p>







    <video  controls="yes"   class="video">
        <source src="/blog/2025/11/11/cpp-library-in-csharp/video/cpp-via-csharp-in-maui-on-ios.mp4" type="video/mp4">
    </video>
    
    <p class="video-fallback">If video doesn’t play in your browser, you can download it <a href="/blog/2025/11/11/cpp-library-in-csharp/video/cpp-via-csharp-in-maui-on-ios.mp4">here</a>.</p>
    


<p>I imagine, it will work more or less the same way with MAUI on Android too, but I have no willpower left to actually check this.</p>
<p>The full project source code repository is <a href="https://github.com/retifrav/csharp-cpp-example">here</a>.</p>
      </div>
    </article>
    <div><div id="tags">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tag">
  <path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path><line x1="7" y1="7" x2="7" y2="7"></line>
</svg>
          <a class="tag" href="https://retifrav.github.io/tags/cpp/">cpp</a><a class="tag" href="https://retifrav.github.io/tags/dotnet/">dotnet</a><a class="tag" href="https://retifrav.github.io/tags/cmake/">cmake</a></div><hr class="comments-divider"/>
      <div id="comments">
      
          <div style="border:2px orange solid; background-color: floralwhite; border-radius:0.5rem; padding: 10px 14px; font-style:italic; font-size:0.9em;">
              If you'd like to comment the article, you can do it on the
              <a href="https://decovar.dev/blog/2025/11/11/cpp-library-in-csharp/#remark42" style="font-weight:bold;">
                  original website</a>. This one is just a mirror without comments.
          </div>
      
      </div>
    </div>
  </div>

  
        <div id="footer">
          <div>
              2014 - 2025,
              <a href="/about/">retif</a>
          </div>
          <div><a href="/about/#licenses">CC BY-SA 4.0 / GPLv3</a></div>
        </div>
      </main>
      <div class="app-header">
        <div style="margin:0 0 20px;">
            <input id="search-query" placeholder="Search in titles and summaries" />
        </div>
        <div id="search-results" style="display:none;"></div>
        <div id="sidebars">
            <a id="avatar" href="/about"><img class="app-header-avatar" src="/images/avatar.png" /></a>
            <iframe src="https://github.com/sponsors/retifrav/button"
                height="35" style="border:0;"
                title="You can sponsor me">
            </iframe>
            
            <div class="sidebar-section">
              <h3>Feeds</h3>
              <div class="sidebar-row">
                <a href="/index.xml" title="Subscribe to RSS">
                  <img src="/images/rss.png" class="sidebar-row-icon">
                </a>
                
                <a href="https://t.me/decovar" title="Telegram channel">
                  <img src="/images/telegram.png" class="sidebar-row-icon">
                </a>
              </div>
            </div>
            
            
            
            <div class="sidebar-section">
              <h3>Tags</h3>
              <ul style="list-style-type:none; padding:0; margin:0;">
                  
                  <li><a href="/tags/web">web (68)</a></li>
                  
                  <li><a href="/tags/fail">fail (40)</a></li>
                  
                  <li><a href="/tags/dotnet">dotnet (38)</a></li>
                  
                  <li><a href="/tags/qt">qt (35)</a></li>
                  
                  <li><a href="/tags/linux">linux (28)</a></li>
                  
                  <li><a href="/tags/review">review (28)</a></li>
                  
                  <li><a href="/tags/devops">devops (23)</a></li>
                  
                  <li><a href="/tags/macos">macos (23)</a></li>
                  
                  <li><a href="/tags/windows">windows (19)</a></li>
                  
                  <li><a href="/tags/mestuff">mestuff (17)</a></li>
                  
                  <li><a href="/tags/movies">movies (15)</a></li>
                  
                  <li><a href="/tags/norway">norway (15)</a></li>
                  
                  <li><a href="/tags/tractor">tractor (15)</a></li>
                  
                  <li><a href="/tags/cpp">cpp (13)</a></li>
                  
                  <li><a href="/tags/cmake">cmake (12)</a></li>
                  
                  <li><a href="/tags/irl">irl (12)</a></li>
                  
                  <li><a href="/tags/python">python (12)</a></li>
                  
                  <li><a href="/tags/telegram">telegram (12)</a></li>
                  
                  <li><a href="/tags/embedded">embedded (11)</a></li>
                  
                  <li><a href="/tags/soft">soft (10)</a></li>
                  
                  <li><a href="/tags/travel">travel (10)</a></li>
                  
                  <li><a href="/tags/applescript">applescript (9)</a></li>
                  
                  <li><a href="/tags/piracy">piracy (9)</a></li>
                  
                  <li><a href="/tags/ios">ios (8)</a></li>
                  
                  <li><a href="/tags/octopress">octopress (8)</a></li>
                  
                  <li><a href="/tags/apple">apple (7)</a></li>
                  
                  <li><a href="/tags/banks">banks (7)</a></li>
                  
                  <li><a href="/tags/games">games (7)</a></li>
                  
                  <li><a href="/tags/javascript">javascript (6)</a></li>
                  
                  <li><a href="/tags/photo">photo (6)</a></li>
                  
                  <li><a href="/tags/sql">sql (6)</a></li>
                  
                  <li><a href="/tags/russia">russia (5)</a></li>
                  
                  <li><a href="/tags/android">android (4)</a></li>
                  
                  <li><a href="/tags/hugo">hugo (4)</a></li>
                  
                  <li><a href="/tags/usa">usa (4)</a></li>
                  
                  <li><a href="/tags/wordpress">wordpress (4)</a></li>
                  
                  <li><a href="/tags/azure">azure (3)</a></li>
                  
                  <li><a href="/tags/tv">tv (3)</a></li>
                  
                  <li><a href="/tags/privacy">privacy (2)</a></li>
                  
                  <li><a href="/tags/steam-deck">steam-deck (2)</a></li>
                  
                  <li><a href="/tags/tvos">tvos (2)</a></li>
                  
                  <li><a href="/tags/unsolved">unsolved (2)</a></li>
                  
                  <li><a href="/tags/books">books (1)</a></li>
                  
                  <li><a href="/tags/ffmpeg">ffmpeg (1)</a></li>
                  
                  <li><a href="/tags/home-automation">home-automation (1)</a></li>
                  
                  <li><a href="/tags/ldap">ldap (1)</a></li>
                  
                  <li><a href="/tags/music">music (1)</a></li>
                  
                  <li><a href="/tags/science">science (1)</a></li>
                  
                  <li><a href="/tags/vr">vr (1)</a></li>
                  
              </ul>
            </div>
        </div>
      </header>
    </div>

    <script src="/js/search.js"></script>

    
    

    <script>
        
        window.onload = () =>
        {
            
            
            
            
            
            
            
            
            
            
            
        }
    </script>

    
    
  </body>
</html>
