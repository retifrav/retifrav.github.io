<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Amazon, MXNet and Qt - The Great Robot Arm challenge | Declaration of VAR</title>
    <link rel="canonical" href="https://decovar.dev/blog/2019/11/10/amazon-mxnet-qt-demo/" />

    <meta name="generator" content="Hugo 0.95.0" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <link href="/favicon.png" rel="icon">

    <meta name="author" content="retif" />
    <meta name="description" content="" />

    <link rel="alternate" type="application/rss+xml" href="/index.xml" title="Declaration of VAR" />

    <meta property="og:title" content="Amazon, MXNet and Qt - The Great Robot Arm challenge" />
<meta property="og:description" content="This February on the Embedded World 2019 event in Nuremberg The Qt Company had a joint demo together with Amazon - &ldquo;The Great Robot Arm Challenge&rdquo;.

Amazon guys wrote a good article covering the deep-learning part. In turn, I wanted to tell about the Qt part." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://retifrav.github.io/blog/2019/11/10/amazon-mxnet-qt-demo/" /><meta property="article:section" content="blog" />
<meta property="article:published_time" content="2019-11-10T18:27:31+01:00" />
<meta property="article:modified_time" content="2019-11-10T18:27:31+01:00" />



    <link rel="stylesheet" href="https://retifrav.github.io/css/main.min.c1a9d5434fbba746ef09ebde219b0064b5d4318930fc8463f51550f13a0e1b54.css" />
    <link rel="stylesheet" href="/css/default.css" />
    <link rel="stylesheet" href="/css/post.css" />
    <link rel="stylesheet" href="/css/page.css" />
    <link rel="stylesheet" href="/css/comments.css" />

    <script src="/js/mark.js"></script>

    
    
  </head>
  <body>
    <div id="body-hat">
      <div id="title-block">
        <h1 id="blog-title"><a href="/">Declaration of VAR</a></h1>
        <p>and some other stuff</p>
      </div>
    </div>
    <div style="background-color:orange; padding:4px 16px; font-size:0.8em; text-align:center; font-style:italic;">
        On 19.05.2021 the website was moved to
        <a href="https://decovar.dev/blog/2019/11/10/amazon-mxnet-qt-demo/" style="color:black; font-weight:bold;">
            https://decovar.dev/</a>. This is just a mirror now.
    </div>
    <div id="body-flex">
      <main class="app-container">
        
  <div id="main-container">
    <article class="post">
      <header class="post-header">
        <h1 class ="post-title">Amazon, MXNet and Qt - The Great Robot Arm challenge</h1>
        <div class="post-meta">
          <div><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-calendar">
  <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line>
</svg> 2019-11-10 18:27:31 &#43;0100</div>
          <div><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-clock">
  <circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline>
</svg> 16 min read</div>
        </div>
      </header>
      <div class="post-content">
        <p>This February on the <a href="https://www.embedded-world.de/en">Embedded World 2019</a> event in Nuremberg The Qt Company had a joint demo together with Amazon - &ldquo;The Great Robot Arm Challenge&rdquo;.</p>
<iframe width="100%" height="600" src="https://www.youtube.com/embed/UwJxLztoI1o" frameborder="0" allow="encrypted-media; picture-in-picture" allowfullscreen></iframe>
<p>Amazon guys wrote a <a href="https://medium.com/apache-mxnet/the-learning-robot-1c2deab8f375">good article</a> covering the deep-learning part. In turn, I wanted to tell about the Qt part.</p>
<p>This article should have been published about 10 months ago, but every time there was something else going on, so I kept postponing and postponing it. But better later than never.</p>
<nav id="TableOfContents">
  <ul>
    <li><a href="#how-did-it-all-begin">How did it all begin</a></li>
    <li><a href="#overview">Overview</a></li>
    <li><a href="#implementation">Implementation</a>
      <ul>
        <li><a href="#qt-build">Qt build</a></li>
        <li><a href="#gui">GUI</a>
          <ul>
            <li><a href="#layouts">Layouts</a></li>
            <li><a href="#pixels-ratio">Pixels ratio</a></li>
            <li><a href="#multiple-views">Multiple views</a></li>
            <li><a href="#virtual-keyboard">Virtual Keyboard</a></li>
          </ul>
        </li>
        <li><a href="#camera">Camera</a>
          <ul>
            <li><a href="#video-wrapper-trick">Video wrapper trick</a></li>
            <li><a href="#grabbing-video-frames-on-the-fly">Grabbing video frames on the fly</a></li>
          </ul>
        </li>
        <li><a href="#sending-frames-to-mxnet">Sending frames to MXNet</a></li>
        <li><a href="#controlling-the-robotic-arms">Controlling the robotic arms</a></li>
        <li><a href="#database">Database</a>
          <ul>
            <li><a href="#sqlite-behind-qthttpserver">SQLite behind QtHttpServer</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#results">Results</a>
      <ul>
        <li><a href="#unreleased-stuff">Unreleased stuff</a></li>
        <li><a href="#sources">Sources</a></li>
      </ul>
    </li>
  </ul>
</nav>
<p>I would especially highlight <a href="#video-wrapper-trick">video wrapper trick</a> and <a href="#sqlite-behind-qthttpserver">QtHttpServer use-case</a>.</p>
<h1 id="how-did-it-all-begin">How did it all begin</h1>
<p>At some point, as a result of a spontaneous meeting with Amazon guys at <a href="https://cppcon.org/">CppCon</a>, it was decided to make an Amazon/Qt joint demo.</p>
<p>What Amazon guys had in mind was to showcase the <a href="http://mxnet.incubator.apache.org">MXNet</a> deep learning library running on <a href="https://www.nvidia.com/en-us/autonomous-machines/embedded-systems/jetson-tx2">NVIDIA Jetson TX2</a> device. What they were missing was the GUI part, which Qt could definitely help with.</p>
<p>As it turned out later, Qt had more things to offer other than just GUI, for instance:</p>
<ul>
<li>interfacing with the camera</li>
<li>network communication between devices</li>
<li>database access</li>
<li>and other small but handy features</li>
</ul>
<h1 id="overview">Overview</h1>
<p>The demo setup can be visualized like this:</p>


    <img class="image-post" loading="lazy" src="/blog/2019/11/10/amazon-mxnet-qt-demo/images/architecture.png" alt="MXNet demo, architecture">

<p>Here:</p>
<ol>
<li>NVIDIA Jetson TX2 - the core of the setup. Runs the Challenge application, processes the frames with MXNet and controls robotic arms</li>
<li>Two <a href="https://niryo.com/niryo-one/">Niryo One</a> robotic arms</li>
<li>Raspberry Pi 3 - runs the Leaderboard application for displaying the challenge results and hosts the database</li>
</ol>
<p>The demo in action:</p>






    <video  controls="yes" loop="yes"  class="video">
        <source src="/blog/2019/11/10/amazon-mxnet-qt-demo/video/challenge-live.mp4" type="video/mp4">
    </video>
    
    <p class="video-fallback">If video doesn’t play in your browser, you can download it <a href="/blog/2019/11/10/amazon-mxnet-qt-demo/video/challenge-live.mp4">here</a></p>
    


<p>So, a person stands in front of the camera and by moving his arms he moves the robotic arms and controls their grip. Everything is organized in a form of challenge: how many books can a participant move from one side to another within a given period of time.</p>
<p>Person&rsquo;s hands/palms analysis/prediction is done by MXNet instance running on Jetson device, which also runs the Challenge application and sends signals to robotic arms.</p>
<p>Additional device (Raspberry Pi) hosts the database and runs the Leaderboard application (<em>you can&rsquo;t see it on the video</em>).</p>
<h1 id="implementation">Implementation</h1>
<h2 id="qt-build">Qt build</h2>
<p>We started with Qt 5.11.1 and <a href="https://blog.qt.io/blog/2018/12/06/qt-5-12-lts-released">then</a> switched to Qt 5.12.0.</p>
<p>Development and prototyping was done mostly on Mac OS. Thanks to Qt&rsquo;s cross-platform nature, deploying applications to the actual targets (<i>Jetson and Raspberry</i>) was only a matter of recompiling the same source code.</p>
<p>However, when it comes to embedded targets, there are no pre-build Qt binaries for those (<i>unless you have a commercial license</i>). Also while we could&rsquo;ve used Qt version provided by the system packages, quite often that one is far from being the latest, so we just built Qt from sources both for Ubuntu on Jetson and for Raspbian on Raspberry right on devices:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ cd ~
</span></span><span style="display:flex;"><span>$ git clone git://code.qt.io/qt/qt5.git <span style="color:#f92672">&amp;&amp;</span> cd qt5
</span></span><span style="display:flex;"><span>$ ./init-repository
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ cd ..
</span></span><span style="display:flex;"><span>$ mkdir build <span style="color:#f92672">&amp;&amp;</span> cd <span style="color:#e6db74">&#34;</span>$_<span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>$ ../qt5/configure -release -no-pch -prefix <span style="color:#e6db74">&#34;/opt/qt512/&#34;</span> -skip webengine -nomake tools -nomake tests -nomake examples
</span></span><span style="display:flex;"><span>$ make -j4
</span></span><span style="display:flex;"><span>$ make -j4 install</span></span></code></pre></div>
<p>Keep in mind that building Qt directly on Raspberry Pi can easily take several hours. On top of that you are likely to run out of RAM, so think about preparing your swap accordingly.</p>
<p>Of course it would be faster to cross-compile Qt sources from desktop, but none of us has done it before and we really had no time to deal with it, so building right on devices actually turned out to be a better option.</p>
<h2 id="gui">GUI</h2>
<p>There are two GUI applications in the demo:</p>
<ol>
<li>Challenge - the main application, runs on Jetson</li>
<li>Leaderboard - stores and displays the challenge results</li>
</ol>
<p>We chose <a href="https://doc.qt.io/qt-5/qtquick-index.html">Qt Quick</a> / <a href="https://doc.qt.io/qt-5/qtqml-index.html">QML</a> for implementing the GUI. There is nothing wrong with <a href="https://doc.qt.io/qt-5/qtwidgets-index.html">Qt Widgets</a>, but since we weren&rsquo;t after native look and feel - on the contrary, we wanted to create a very custom GUI - it was simply easier to do so with Qt Quick.</p>
<p>Challenge application screenshot:</p>


    <img class="image-post" loading="lazy" src="/blog/2019/11/10/amazon-mxnet-qt-demo/images/app-challenge.png" alt="MXNet demo, Challenge application">

<p>Leaderboard application screenshot:</p>


    <img class="image-post" loading="lazy" src="/blog/2019/11/10/amazon-mxnet-qt-demo/images/app-leaderboard.png" alt="MXNet demo, Leaderboard application">

<p>The GUI looks nice by no accident - we had proper designers in the team. They designed GUI for both applications in Photoshop and then exported it to a QML project using <a href="https://doc.qt.io/qtdesignstudio/psqtbridge.html">Qt Bridge</a> from the <a href="https://doc.qt.io/qtdesignstudio/index.html">Qt Design Studio</a> package.</p>
<p>However, we did not use Qt Design Studio itself as the projects exported from Photoshop heavily rely on hardcoded x/y coordinates and width/height values. But we wanted to have a responsive QML GUI, with <a href="https://doc.qt.io/qt-5/qtquicklayouts-index.html">layouts</a> and <a href="https://doc.qt.io/qt-5/qtqml-syntax-propertybinding.html">property bindings</a>, so it could adapt to different screen sizes and geometry.</p>
<p>At the same time it was definitely useful to get all the design assets in a form of a QML project rather than a <code>.psd</code> file, so it was easier to recreate the design in QML.</p>
<p>Next time we will try to create design directly in Qt Design Studio without using Photoshop at all, especially that designers actually don&rsquo;t mind such approach themselves. There is however a challenge of teaching/explaining the concept of layouts and bindings to them, but I think it will pay off in the end.</p>
<h3 id="layouts">Layouts</h3>
<p>Since we touched the layouts subject, here&rsquo;s a simplified example of using layouts in Challenge application GUI:</p>


    <img class="image-post" loading="lazy" src="/blog/2019/11/10/amazon-mxnet-qt-demo/images/layouts.png" alt="Qt Quick layouts">

<p>In QML it looks like this:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#a6e22e">RowLayout</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">anchors</span>.<span style="color:#a6e22e">fill</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">parent</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">Item</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">Layout</span>.<span style="color:#a6e22e">preferredWidth</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">parent</span>.<span style="color:#a6e22e">width</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">0.3</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">Layout</span>.<span style="color:#a6e22e">fillHeight</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">ColumnLayout</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">anchors</span>.<span style="color:#a6e22e">fill</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">parent</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// ...
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">Item</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">Layout</span>.<span style="color:#a6e22e">fillWidth</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">Layout</span>.<span style="color:#a6e22e">fillHeight</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// ...
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">Item</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">Layout</span>.<span style="color:#a6e22e">preferredWidth</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">parent</span>.<span style="color:#a6e22e">width</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">0.3</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">Layout</span>.<span style="color:#a6e22e">fillHeight</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">ColumnLayout</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">anchors</span>.<span style="color:#a6e22e">fill</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">parent</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// ...
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div>
<p>Which gives the following more or less responsive result:</p>






    <video  controls="yes" loop="yes"  class="video">
        <source src="/blog/2019/11/10/amazon-mxnet-qt-demo/video/layouts.mp4" type="video/mp4">
    </video>
    
    <p class="video-fallback">If video doesn’t play in your browser, you can download it <a href="/blog/2019/11/10/amazon-mxnet-qt-demo/video/layouts.mp4">here</a></p>
    


<p>Yes, it is pretty basic stuff, but you&rsquo;d be surprised how many people still &ldquo;hardcode&rdquo; the geometry of their applications GUI because they don&rsquo;t know about layouts.</p>
<h3 id="pixels-ratio">Pixels ratio</h3>
<p>Speaking about developing on Macs - when we deployed applications to Jetson and Raspberry Pi devices the first time, GUI proportions went to hell, along with the text labels font size.</p>
<p>That happened because we forgot about <a href="https://doc.qt.io/qt-5/qml-qtquick-window-screen.html#devicePixelRatio-attached-prop">devicePixelRatio</a> which has a different value on &ldquo;Retina&rdquo; and &ldquo;normal&rdquo; displays. To fix that we added a scale factor based on this value.</p>
<h3 id="multiple-views">Multiple views</h3>
<p>Switching between screens/views in applications is implemented with <a href="https://doc.qt.io/qt-5/qml-qtquick-loader.html">QML Loader</a>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#75715e">// main.qml
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// ...
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">Loader</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">id</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">loader</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">anchors</span>.<span style="color:#a6e22e">fill</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">parent</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">source</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;qrc:/welcome.qml&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">Connections</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">target</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">loader</span>.<span style="color:#a6e22e">item</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">onNextWindow</span><span style="color:#f92672">:</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">loader</span>.<span style="color:#a6e22e">source</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;qrc:/&#34;</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">windowName</span>
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// ...
</span></span></span></code></pre></div>
<p>Loading the next view:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#75715e">// welcome.qml
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// ...
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">Item</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">signal</span> <span style="color:#a6e22e">nextWindow</span>(<span style="color:#a6e22e">string</span> <span style="color:#a6e22e">windowName</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// ...
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">Button</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// ...
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">onClicked</span><span style="color:#f92672">:</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">registrationComplete</span>();
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// ...
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">registrationComplete</span>()
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">nextWindow</span>(<span style="color:#e6db74">&#34;challenge.qml&#34;</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div>
<h3 id="virtual-keyboard">Virtual Keyboard</h3>
<p>The Challenge application has a text input, so participants could enter their names. And since the demo setup had a touchscreen with no physical keyboard, we added a <a href="https://doc.qt.io/qt-5/qtvirtualkeyboard-index.html">Virtual Keyboard</a> support.</p>
<p>We also enabled the <a href="https://doc.qt.io/qt-5/qml-qtquick-virtualkeyboard-settings-virtualkeyboardsettings.html#fullScreenMode-prop">fullscreen mode</a> for it - when user touches the input field, the rest of the GUI &ldquo;disappears&rdquo;: the top half of the screen is taken by the input field and the bottom half is taken by the Virtual Keyboard:</p>


    <img class="image-post" loading="lazy" src="/blog/2019/11/10/amazon-mxnet-qt-demo/images/virtual-keyboard-fullscreen.png" alt="Qt Virtual Keyboard in fullscreen mode">

<h2 id="camera">Camera</h2>
<p><a href="https://doc.qt.io/qt-5/qtmultimedia-index.html">Qt Multimedia</a> makes working with camera pretty easy.</p>
<p>However, at first we couldn&rsquo;t even discover the Jetson camera from Qt. Eventually we found out that the following environment variable is required in the particular case of NVIDIA Jetson TX2:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span><span style="color:#a6e22e">QT_GSTREAMER_CAMERABIN_VIDEOSRC</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;nvcamerasrc ! nvvidconv&#34;</span></span></span></code></pre></div>
<p>So we got out video feed.</p>
<h3 id="video-wrapper-trick">Video wrapper trick</h3>
<p>We needed to capture frames from video stream and send those to MXNet for analysis. The first and easiest idea was to use <a href="https://doc.qt.io/qt-5/qml-qtmultimedia-cameracapture.html#captureToLocation-method">captureToLocation()</a> and then send saved files, but on the second thought we realized that it will be a very expensive operation, given that we need to process at least 15 frames per second. So we needed to find a way to grab frames from the video stream on the fly and process those without saving them on disk.</p>
<p>And indeed, there is such a way. With a great help of <a href="https://codereview.qt-project.org/q/owner:valentyn.doroshchuk">Val Doroshchuk</a> (Qt Multimedia maintainer), we added a video wrapper - a special class that allows to intercept the frames even before they get to video output.</p>
<p>For that to work the wrapper class should inherit <a href="https://doc.qt.io/qt-5/qabstractvideosurface.html">QAbstractVideoSurface</a>. Details can be found in the <a href="https://github.com/retifrav/amazon-mxnet-qt/blob/master/qml-camera-mxnet/videowrapper.cpp">source code</a>, and as a result we were able to inject it as the source for <code>VideoOutput</code> instead of <code>Camera</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#a6e22e">Camera</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">id</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">camera</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// ...
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">Binding</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">target</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">backend</span>.<span style="color:#a6e22e">videoWrapper</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">property</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;source&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">value</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">camera</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">VideoOutput</span> {
</span></span><span style="display:flex; background-color:#3c3d38"><span>    <span style="color:#a6e22e">source</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">backend</span>.<span style="color:#a6e22e">videoWrapper</span><span style="color:#75715e">//camera
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">// ...
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>}</span></span></code></pre></div>
<h3 id="grabbing-video-frames-on-the-fly">Grabbing video frames on the fly</h3>
<p>The most interesting part of the video wrapper for us was the <a href="https://doc.qt.io/qt-5/qabstractvideosurface.html#present">present()</a> method as that&rsquo;s where you can grab the frames:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#66d9ef">bool</span> VideoWrapper<span style="color:#f92672">::</span>present(<span style="color:#66d9ef">const</span> QVideoFrame <span style="color:#f92672">&amp;</span>frame)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// ...
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>    QVideoFrame frameCopy <span style="color:#f92672">=</span> frame;
</span></span><span style="display:flex;"><span>    frameCopy.map(QAbstractVideoBuffer<span style="color:#f92672">::</span>ReadOnly);
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">//qDebug() &lt;&lt; &#34;got frame:&#34; &lt;&lt; frameCopy.mappedBytes() &lt;&lt; frameCopy.size();
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    QImage shot <span style="color:#f92672">=</span> QImage(qt_imageFromVideoFrame(frameCopy));
</span></span><span style="display:flex;"><span>    frameCopy.unmap();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    emit <span style="color:#a6e22e">gotNewFrameImage</span>(shot);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// ...
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>}</span></span></code></pre></div>
<p>So we grab a copy of a frame (<a href="https://doc.qt.io/qt-5/qvideoframe.html">QVideoFrame</a>) and convert it to <a href="https://doc.qt.io/qt-5/qimage.html">QImage</a>.</p>
<p>It&rsquo;s worth to mention that <code>qt_imageFromVideoFrame()</code> function is not available in the public API (<em><a href="https://bugreports.qt.io/browse/QTBUG-58292">here</a> you can vote for it</em>), so the private header needs to be included:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span><span style="color:#66d9ef">#</span>include <span style="color:#e6db74">&#34;private/qvideoframe_p.h&#34;</span></span></span></code></pre></div>
<p>And the following module needs to be added in the project file:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid;"><code class="language-pro" data-lang="pro"><span style="display:flex;"><span>QT <span style="color:#e6db74">+=</span> <span style="color:#e6db74">\</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">quick</span> <span style="color:#e6db74">\</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">multimedia</span> <span style="color:#e6db74">\</span>
</span></span><span style="display:flex; background-color:#3c3d38"><span>    <span style="color:#e6db74">multimedia</span><span style="color:#f92672">-</span><span style="color:#e6db74">private</span></span></span></code></pre></div>
<h2 id="sending-frames-to-mxnet">Sending frames to MXNet</h2>
<p>Next we connect to the <code>gotNewFrameImage()</code> signal and send frames to MXNet via HTTP requests:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>Backend<span style="color:#f92672">::</span>Backend(QObject <span style="color:#f92672">*</span>parent) <span style="color:#f92672">:</span> QObject(parent)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// ...
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>    connect(
</span></span><span style="display:flex;"><span>        videoWrapper, <span style="color:#f92672">&amp;</span>VideoWrapper<span style="color:#f92672">::</span>gotNewFrameImage,
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span>, <span style="color:#f92672">&amp;</span>Backend<span style="color:#f92672">::</span>processFrame
</span></span><span style="display:flex;"><span>        );
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// ...
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>    connect(
</span></span><span style="display:flex;"><span>        managerFrames, <span style="color:#f92672">&amp;</span>QNetworkAccessManager<span style="color:#f92672">::</span>finished,
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span>, <span style="color:#f92672">&amp;</span>Backend<span style="color:#f92672">::</span>processFrameFinished
</span></span><span style="display:flex;"><span>        );
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> Backend<span style="color:#f92672">::</span>processFrame(QImage img)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 384x288 is enough for MXNet
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    QImage shotScaled <span style="color:#f92672">=</span> img.scaled(<span style="color:#ae81ff">384</span>, <span style="color:#ae81ff">288</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// MXNet should get unmirrored frame
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    shotScaled <span style="color:#f92672">=</span> shotScaled.mirrored(true, false);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    QBuffer <span style="color:#f92672">*</span>imgBuffer <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> QBuffer();
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">bool</span> shotSaved <span style="color:#f92672">=</span> shotScaled.save(imgBuffer, <span style="color:#e6db74">&#34;JPG&#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>shotSaved) { qCritical() <span style="color:#f92672">&lt;&lt;</span> <span style="color:#e6db74">&#34;[error] Couldn&#39;t save the original shot]&#34;</span> <span style="color:#f92672">&lt;&lt;</span> imgBuffer<span style="color:#f92672">-&gt;</span>errorString(); }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">const</span> QByteArray reqID <span style="color:#f92672">=</span> QUuid<span style="color:#f92672">::</span>createUuid().toByteArray();
</span></span><span style="display:flex;"><span>        _frames.insert(reqID, img);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">//qDebug() &lt;&lt; &#34;uploading&#34; &lt;&lt; imgBuffer-&gt;size() &lt;&lt; &#34;bytes&#34;;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        QNetworkRequest request <span style="color:#f92672">=</span> QNetworkRequest(QUrl(_mxnetEndpointPose));
</span></span><span style="display:flex;"><span>        request.setRawHeader(<span style="color:#e6db74">&#34;Content-Type&#34;</span>, <span style="color:#e6db74">&#34;multipart/form-data&#34;</span>);
</span></span><span style="display:flex;"><span>        request.setRawHeader(<span style="color:#e6db74">&#34;reqID&#34;</span>, reqID);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        imgBuffer<span style="color:#f92672">-&gt;</span>open(QIODevice<span style="color:#f92672">::</span>ReadOnly);
</span></span><span style="display:flex;"><span>        QNetworkReply <span style="color:#f92672">*</span>reply <span style="color:#f92672">=</span> managerFrames<span style="color:#f92672">-&gt;</span>post(request, imgBuffer);
</span></span><span style="display:flex;"><span>        connect(reply, <span style="color:#f92672">&amp;</span>QNetworkReply<span style="color:#f92672">::</span>finished, imgBuffer, <span style="color:#f92672">&amp;</span>QBuffer<span style="color:#f92672">::</span>deleteLater);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> Backend<span style="color:#f92672">::</span>processFrameFinished(QNetworkReply <span style="color:#f92672">*</span>reply)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> status <span style="color:#f92672">=</span> reply<span style="color:#f92672">-&gt;</span>attribute(QNetworkRequest<span style="color:#f92672">::</span>HttpStatusCodeAttribute).toInt();
</span></span><span style="display:flex;"><span>    QByteArray data <span style="color:#f92672">=</span> reply<span style="color:#f92672">-&gt;</span>readAll();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (status <span style="color:#f92672">!=</span> <span style="color:#ae81ff">200</span>)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        QString errorMessage <span style="color:#f92672">=</span> data;
</span></span><span style="display:flex;"><span>        QNetworkReply<span style="color:#f92672">::</span>NetworkError err <span style="color:#f92672">=</span> reply<span style="color:#f92672">-&gt;</span>error();
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (status <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// dictionary: http://doc.qt.io/qt-5/qnetworkreply.html#NetworkError-enum
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            errorMessage <span style="color:#f92672">=</span> QString(<span style="color:#e6db74">&#34;QNetworkReply::NetworkError code: %1&#34;</span>).arg(QString<span style="color:#f92672">::</span>number(err));
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        emit <span style="color:#a6e22e">requestFailed</span>(QString(<span style="color:#e6db74">&#34;Code %1 | %2&#34;</span>).arg(status).arg(errorMessage));
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// get the original frame to crop palms regions
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    QByteArray reqID <span style="color:#f92672">=</span> reply<span style="color:#f92672">-&gt;</span>request().rawHeader(<span style="color:#e6db74">&#34;reqID&#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// ...
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">// cropping palms regions, sending those to MXNet
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">// ...
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">// original frame is no longer needed
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    _frames.remove(reqID);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    emit <span style="color:#a6e22e">requestDone</span>(data);
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div>
<p>The full source is available <a href="https://github.com/retifrav/amazon-mxnet-qt/blob/master/qml-camera-mxnet/backend.cpp">here</a>. However, it doesn&rsquo;t have everything as I had to remove quite a lot of code from the actual implementation - more on that in the <a href="#sources">results</a> section.</p>
<p>As you can see, aside from sending frames we also save them in memory (<em>the <code>_frames</code> object</em>) for further processing. The reason for that is this: after MXNet replies back with coordinates of the person pose (<em>head, shoulders, palms, etc</em>), we need to crop the palms regions from the original frame and send those (<em>two requests - one per palm</em>) again to MXNet but this time to a different endpoint - to the one that analyses if the palm is closed or open.</p>
<p>Admittedly, that is a very unfortunate design as we lose a lot resources because of that. Everything should happen within a single round trip: MXNet receives the frame, finds the pose coordinates and predicts the palms states. But sadly we didn&rsquo;t think about it at the beginning of the project and had absolutely no time to re-do that later.</p>
<p>However, even with such a flaw we were able to process 20 frames per second without degrading the UX. Here&rsquo;s one of the first FPS benchmarks we did:</p>






    <video  controls="yes" loop="yes"  class="video">
        <source src="/blog/2019/11/10/amazon-mxnet-qt-demo/video/silly-fps-benchmark.mp4" type="video/mp4">
    </video>
    
    <p class="video-fallback">If video doesn’t play in your browser, you can download it <a href="/blog/2019/11/10/amazon-mxnet-qt-demo/video/silly-fps-benchmark.mp4">here</a></p>
    


<p>The MXNet instance in this benchmark wasn&rsquo;t properly trained, but we did not care about that - we only wanted to estimate the performance. The <span style="color:yellow; background:lightgray; font-weight:bold;">yellow</span> counter here shows the video-stream FPS, and the <span style="color:blue; background:lightgray; font-weight:bold;">blue</span> counter shows the number of frames MXNet is able to process per second. We would have been happy with anything above 15 FPS, so <span style="color:blue; background:lightgray; font-weight:bold;">20</span> FPS is a very good result.</p>
<h2 id="controlling-the-robotic-arms">Controlling the robotic arms</h2>
<p>Here&rsquo;s what MXNet does with the frames we send to it:</p>


    <img class="image-post" loading="lazy" src="/blog/2019/11/10/amazon-mxnet-qt-demo/images/body-lines.jpg" alt="MXNet demo, architecture">

<p>So it looks for parts of human body and sends back a set of coordinates for points of interest. From those coordinates we only need palms regions, to which we bind trackers on <code>VideoOutput</code> surface.</p>
<p>Palms regions coordinates map to <code>VideoOutput</code> surface like this:</p>


    <img class="image-post" loading="lazy" src="/blog/2019/11/10/amazon-mxnet-qt-demo/images/mxnet-coordinates.png" alt="Mapping trackers coordinates">

<p>Here&rsquo;s one of the first tests where we were trying to track the palms correctly:</p>






    <video  controls="yes" loop="yes"  class="video">
        <source src="/blog/2019/11/10/amazon-mxnet-qt-demo/video/tracking-palms.mp4" type="video/mp4">
    </video>
    
    <p class="video-fallback">If video doesn’t play in your browser, you can download it <a href="/blog/2019/11/10/amazon-mxnet-qt-demo/video/tracking-palms.mp4">here</a></p>
    


<p>These trackers are used to move the robotic arms, and palms regions are further analyzed by MXNet to control the grip of robotic arms:</p>


    <img class="image-post" loading="lazy" src="/blog/2019/11/10/amazon-mxnet-qt-demo/images/palm-prediction.png" alt="Palm prediction">

<p>Here&rsquo;s a video of first attempts to make the whole thing work:</p>






    <video  controls="yes"   class="video">
        <source src="/blog/2019/11/10/amazon-mxnet-qt-demo/video/early-grip-tests.mp4" type="video/mp4">
    </video>
    
    <p class="video-fallback">If video doesn’t play in your browser, you can download it <a href="/blog/2019/11/10/amazon-mxnet-qt-demo/video/early-grip-tests.mp4">here</a></p>
    


<p>As almost everything related to robotic arms was done by Amazon guys, I won&rsquo;t cover it here. I can only tell that sending commands to robotic arms was done via combination of <code>XmlHttpRequest</code>/<code>WebSocket</code> requests sent right from QML.</p>
<p>By the way, to make robotic arms move smoothly without jerking and with constantly changing trajectory was a <a href="https://niryo.com/forums/topic/queuing-move-goals/">hell of a task</a> itself.</p>
<h2 id="database">Database</h2>
<p>We needed to store the challenge results somewhere, so we decided to use an SQL database.</p>
<p>We could take a MySQL database, but a full-blown MySQL database seemed to be an overkill for such purpose, so we chose SQLite instead.</p>
<p>Working with SQLite (<em>or, rather, any SQL database</em>) from Qt is pretty easy:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>Backend<span style="color:#f92672">::</span>Backend(QObject <span style="color:#f92672">*</span>parent) <span style="color:#f92672">:</span> QObject(parent)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// ...
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>    _dbFile <span style="color:#f92672">=</span> QDir(qApp<span style="color:#f92672">-&gt;</span>applicationDirPath()).filePath(<span style="color:#e6db74">&#34;leaderboard.db&#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (QFileInfo<span style="color:#f92672">::</span>exists(_dbFile))
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        _db <span style="color:#f92672">=</span> QSqlDatabase<span style="color:#f92672">::</span>addDatabase(<span style="color:#e6db74">&#34;QSQLITE&#34;</span>);
</span></span><span style="display:flex;"><span>        _db.setDatabaseName(_dbFile);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>_db.open())
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            qCritical() <span style="color:#f92672">&lt;&lt;</span> QString(<span style="color:#e6db74">&#34;Error: couldn&#39;t open the database. %1&#34;</span>)
</span></span><span style="display:flex;"><span>                           .arg(_db.lastError().databaseText());
</span></span><span style="display:flex;"><span>            exit(EXIT_FAILURE);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        qCritical() <span style="color:#f92672">&lt;&lt;</span> <span style="color:#e6db74">&#34;Error: couldn&#39;t find the database file&#34;</span>;
</span></span><span style="display:flex;"><span>        exit(EXIT_FAILURE);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// ...
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>}</span></span></code></pre></div>
<p>Here&rsquo;s how we can check if a user with given username already exists in the database:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#66d9ef">bool</span> Backend<span style="color:#f92672">::</span>checkUserName(QString username)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    QSqlQuery query;
</span></span><span style="display:flex;"><span>    query.prepare(<span style="color:#e6db74">&#34;SELECT COUNT (*) AS cnt FROM users WHERE users.name == :username;&#34;</span>);
</span></span><span style="display:flex;"><span>    query.bindValue(<span style="color:#e6db74">&#34;:username&#34;</span>, username);
</span></span><span style="display:flex;"><span>    query.exec();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    query.first();
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (query.value(<span style="color:#ae81ff">0</span>).toBool()) { <span style="color:#66d9ef">return</span> true; }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span> { <span style="color:#66d9ef">return</span> false; }
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div>
<p>And here&rsquo;s how we fetch the list of scores to show on the leaderboard:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#66d9ef">void</span> Backend<span style="color:#f92672">::</span>fetchDataFromDB()
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    _challengeScores<span style="color:#f92672">-&gt;</span>clear();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    QSqlQueryModel _queryModel;
</span></span><span style="display:flex;"><span>    _queryModel.setQuery(
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;SELECT u.name AS player, MAX(s.score) AS score &#34;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;FROM scores AS s JOIN users AS u &#34;</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#e6db74">&#34;ON s.user_id = u.id &#34;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;GROUP BY u.name &#34;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;ORDER BY s.score DESC;&#34;</span>
</span></span><span style="display:flex;"><span>                );
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;</span> _queryModel.rowCount(); i<span style="color:#f92672">++</span>)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        Score <span style="color:#a6e22e">score</span>(
</span></span><span style="display:flex;"><span>                i <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>,
</span></span><span style="display:flex;"><span>                _queryModel.record(i).value(<span style="color:#e6db74">&#34;player&#34;</span>).toString(),
</span></span><span style="display:flex;"><span>                _queryModel.record(i).value(<span style="color:#e6db74">&#34;score&#34;</span>).toInt()
</span></span><span style="display:flex;"><span>                );
</span></span><span style="display:flex;"><span>        _challengeScores<span style="color:#f92672">-&gt;</span>addScore(score);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    emit <span style="color:#a6e22e">countChanged</span>(_challengeScores<span style="color:#f92672">-&gt;</span>rowCount());
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div>
<p>To show the data in QML view, we used a <a href="https://doc.qt.io/qt-5/qml-qtquick-listview.html">ListView</a> binded to a <a href="https://github.com/retifrav/amazon-mxnet-qt/blob/master/leaderboard/scores.h">backend model</a>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#a6e22e">ListView</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">id</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">scoresList</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">clip</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">model</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">backend</span>.<span style="color:#a6e22e">scores</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">delegate</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">ItemDelegate</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">width</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">parent</span>.<span style="color:#a6e22e">width</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">RowLayout</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">anchors</span>.<span style="color:#a6e22e">fill</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">parent</span>
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">spacing</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">Image</span>
</span></span><span style="display:flex;"><span>            {
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">Layout</span>.<span style="color:#a6e22e">preferredWidth</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">parent</span>.<span style="color:#a6e22e">width</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">0.1</span>
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">source</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">position</span> <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">4</span> <span style="color:#f92672">?</span> <span style="color:#e6db74">&#34;qrc:/img/&#34;</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">position</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;.png&#34;</span> <span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">fillMode</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">Image</span>.<span style="color:#a6e22e">PreserveAspectFit</span>
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">visible</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">position</span> <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">4</span>
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">Text</span> {
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">Layout</span>.<span style="color:#a6e22e">preferredWidth</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">parent</span>.<span style="color:#a6e22e">width</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">0.1</span>
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">horizontalAlignment</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">Text</span>.<span style="color:#a6e22e">AlignRight</span>
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">visible</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">position</span> <span style="color:#f92672">&gt;=</span> <span style="color:#ae81ff">4</span>
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">text</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">position</span>
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">Text</span> {
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">Layout</span>.<span style="color:#a6e22e">fillWidth</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">Layout</span>.<span style="color:#a6e22e">leftMargin</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">30</span>
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">horizontalAlignment</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">Text</span>.<span style="color:#a6e22e">AlignLeft</span>
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">text</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">player</span>
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">elide</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">Text</span>.<span style="color:#a6e22e">ElideRight</span>
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">Text</span> {
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">Layout</span>.<span style="color:#a6e22e">preferredWidth</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">parent</span>.<span style="color:#a6e22e">width</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">0.1</span>
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">Layout</span>.<span style="color:#a6e22e">leftMargin</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">5</span>
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">horizontalAlignment</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">Text</span>.<span style="color:#a6e22e">AlignHCenter</span>
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">font</span>.<span style="color:#a6e22e">bold</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">position</span> <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">4</span> <span style="color:#f92672">?</span> <span style="color:#66d9ef">true</span> <span style="color:#f92672">:</span> <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">text</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">score</span>
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">highlighted</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">hovered</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div>
<h3 id="sqlite-behind-qthttpserver">SQLite behind QtHttpServer</h3>
<p>As the Challenge application alone occupied the entire display, we needed another display for the Leaderboard application, which also meant another host to run it - a Raspberry Pi device. But since Challenge and Leaderboard applications are on different hosts, we also needed a network communication between them - to save and read the challenge results.</p>
<p>In case of MySQL we would have a server component out-of-the-box, but how to expose an SQLite database over the network?</p>
<p>Right about that time the QtHttpServer <a href="https://blog.qt.io/blog/2019/01/25/introducing-qt-http-server/">was announced</a> (<em>a <a href="https://www.qt.io/blog/2019/02/01/qhttpserver-routing-api">more useful article</a> was published later</em>). And we immediately decided to interface with SQLite database through it.</p>
<p>QtHttpServer turned out to be very easy to use. For example, here&rsquo;s how we set-up routes for getting the top score and for saving new results:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>Backend<span style="color:#f92672">::</span>Backend(QObject <span style="color:#f92672">*</span>parent) <span style="color:#f92672">:</span> QObject(parent)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// ...
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>    _httpServer<span style="color:#f92672">-&gt;</span>route(
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;/top&#34;</span>,
</span></span><span style="display:flex;"><span>        QHttpServerRequest<span style="color:#f92672">::</span>Method<span style="color:#f92672">::</span>Get,
</span></span><span style="display:flex;"><span>        []()
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        QString userName <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;unknown&#34;</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">int</span> score <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        QSqlQuery query;
</span></span><span style="display:flex;"><span>        query.prepare(<span style="color:#e6db74">&#34;SELECT u.name, s.score &#34;</span>
</span></span><span style="display:flex;"><span>                      <span style="color:#e6db74">&#34;FROM scores AS s JOIN users as U on s.user_id = u.id &#34;</span>
</span></span><span style="display:flex;"><span>                      <span style="color:#e6db74">&#34;ORDER BY score DESC, s.id ASC &#34;</span>
</span></span><span style="display:flex;"><span>                      <span style="color:#e6db74">&#34;LIMIT 1;&#34;</span>);
</span></span><span style="display:flex;"><span>        query.exec();
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (query.first())
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            userName <span style="color:#f92672">=</span> query.value(<span style="color:#ae81ff">0</span>).toString();
</span></span><span style="display:flex;"><span>            score <span style="color:#f92672">=</span> query.value(<span style="color:#ae81ff">1</span>).toInt();
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        QJsonObject rez;
</span></span><span style="display:flex;"><span>        rez.insert(<span style="color:#e6db74">&#34;userName&#34;</span>, userName);
</span></span><span style="display:flex;"><span>        rez.insert(<span style="color:#e6db74">&#34;score&#34;</span>, score);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> rez;
</span></span><span style="display:flex;"><span>    });
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    _httpServer<span style="color:#f92672">-&gt;</span>route(
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;/user/saveScore/&lt;arg&gt;/&lt;arg&gt;&#34;</span>,
</span></span><span style="display:flex;"><span>        QHttpServerRequest<span style="color:#f92672">::</span>Method<span style="color:#f92672">::</span>Post,
</span></span><span style="display:flex;"><span>        [](<span style="color:#66d9ef">int</span> userID, <span style="color:#66d9ef">int</span> score)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        QSqlQuery query;
</span></span><span style="display:flex;"><span>        query.prepare(<span style="color:#e6db74">&#34;INSERT INTO scores(user_id, score, dt) VALUES(:userID, :score, DATETIME(&#39;now&#39;, &#39;localtime&#39;));&#34;</span>);
</span></span><span style="display:flex;"><span>        query.bindValue(<span style="color:#e6db74">&#34;:userID&#34;</span>, userID);
</span></span><span style="display:flex;"><span>        query.bindValue(<span style="color:#e6db74">&#34;:score&#34;</span>, score);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>query.exec())
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            QString err <span style="color:#f92672">=</span> QString(<span style="color:#e6db74">&#34;Couldn&#39;t save the score. %1&#34;</span>).arg(query.lastError().text());
</span></span><span style="display:flex;"><span>            qWarning() <span style="color:#f92672">&lt;&lt;</span> <span style="color:#e6db74">&#34;[error]&#34;</span> <span style="color:#f92672">&lt;&lt;</span> err;
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#34;0&#34;</span>;<span style="color:#75715e">//err;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#34;1&#34;</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    });
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// ...
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>}</span></span></code></pre></div>
<p>It works like a proper REST API, so we called it right from QML using <code>XmlHttpRequest</code>.</p>
<p>Overall, QtHttpServer has proved to be such nice and useful component, so I&rsquo;ll write a separate article about it: how to build it from sources, how to add it to project and so on.</p>
<p>Thanks a lot to <a href="https://codereview.qt-project.org/q/owner:mikhail.svetkin">Mikhail Svetkin</a> for creating QtHttpServer in the first place and for helping us to use it in our project.</p>
<h1 id="results">Results</h1>
<p>We shown the demo at Embedded World along with other demos at The Qt Company&rsquo;s booth, and looks like it was a success.</p>
<p>The demo setup turned out to be a bit unfortunate though, because the touchscreen was mounted rather low, and it was not convenient to enter the text and press buttons on the screen at that height.</p>
<p>Other than that, nothing crashed, which is always good, and also visitors seemed to like it.</p>
<p>As a bonus, I will now be able to tell Skynet that I helped it a bit on its way to the world domination.</p>
<h2 id="unreleased-stuff">Unreleased stuff</h2>
<p>We had about 3 months to create the demo in time for the event. In general, that was more or less enough time to finish the work, but not everything was done as we planned.</p>
<p>For instance, we wanted to do the majority of things in C++, and use QML only for GUI/frontend, but sadly that plan failed, and we ended up processing some rather big parts of logic in QML/JS just because it was faster that way than in C++. Although, it didn&rsquo;t have any sufficient impact on the performance.</p>
<p>Also because of the lack of time we didn&rsquo;t implement the drawing of human body lines - something like on <a href="images/body-lines.jpg">this picture</a>. We had the full set of coordinates from MXNet, and the only thing we needed to do is to connect them using, perhaps, <a href="https://doc.qt.io/qt-5/qml-qtquick-shapes-shape.html">Shapes</a>. We did not prioritize that as we didn&rsquo;t think it&rsquo;s important, but surprisingly many other companies made this functionality to be the key feature in demos at their booths.</p>
<h2 id="sources">Sources</h2>
<p>The sources of all the applications are open, but we&rsquo;re a bit ashamed to share it. I mean, at first everything was nice and clean, but at the end, when we started running out of time, quality of the code went to shit, as we started spawning various quick and dirty hacks and crutches, so right now the code doesn&rsquo;t look too good to be shown to people.</p>
<p>So I will only share the full source code for the Leaderboard application, and for the Challenge application I&rsquo;ll keep only the basic skeleton. Here&rsquo;s the <a href="https://github.com/retifrav/amazon-mxnet-qt/">repository</a> for both.</p>
<p>It would be also nice for us to share the MXNet instance with the trained model, so everyone could recreate our demo, but I&rsquo;ll need to discuss it with Amazon guys first.</p>
      </div>
    </article>
    <div><div id="tags">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tag">
  <path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path><line x1="7" y1="7" x2="7" y2="7"></line>
</svg>
          <a class="tag" href="https://retifrav.github.io/tags/qt/">qt</a><a class="tag" href="https://retifrav.github.io/tags/embedded/">embedded</a></div><hr class="comments-divider"/>
      <div id="comments">
      
          <script>
  var id =  38 ;

  if (id)
  {
    let url = "https://github.com/retifrav/retifrav.github.io/issues/".concat(id);
    let api_url = "https://api.github.com/repos/retifrav/retifrav.github.io/issues/".concat(id, "/comments");
    
    var commentsDiv = document.getElementById("comments");

    let xhr = new XMLHttpRequest();
    xhr.responseType = "json";
    xhr.open("GET", api_url);
    xhr.setRequestHeader("Accept", "application/vnd.github.v3.html+json");
    xhr.send();

    xhr.onload = function()
    {
      if (xhr.status != 200)
      {
        let errorText = document.createElement("p");
        errorText.innerHTML = "<i>Comments for this post yet are not opened yet (or you have GitHub scripts disabled).</i>";
        commentsDiv.appendChild(errorText);
      }
      else
      {
        let comments = xhr.response;

        let mainHeader = document.createElement("h2");
        mainHeader.innerHTML = "Comments: ".concat(comments.length);
        commentsDiv.appendChild(mainHeader);

        let issueLink = document.createElement("p");
        issueLink.innerHTML = "<i>You can leave a comment using this <a href='".concat(url, "'>GitHub issue</a>.</i>");
        commentsDiv.appendChild(issueLink);
        
        comments.forEach(function(comment)
        {
            let commentContent = document.createElement("div");
            commentContent.setAttribute('class', 'gh-comment')
            commentContent.innerHTML = "".concat(
                "<div class='gh-header'>",
                  "<img src='", comment.user.avatar_url, "' />",
                  "<div style='margin:auto 0;'>",
                    "<b><a class='gh-username' href='", comment.user.html_url, "'>", comment.user.login, "</a></b>",
                    " commented at <em>", new Date(comment.created_at), "</em>",
                  "</div>",
                "</div>",
                "<div class='gh-body'>",
                  comment.body_html,
                "</div>"
            );
            commentsDiv.appendChild(commentContent);
        });
      }
    };

    xhr.onerror = function()
    {
      let errorText = document.createElement("p");
      errorText.innerHTML = "<i>Some error loading comments.</i>";
      commentsDiv.appendChild(errorText);
    };
  }
</script>

      
      </div>
    </div>
  </div>

        <div id="footer">
          <div>
              2014-2022,
              <a href="/about/">retif</a>
          </div>
          <div><a href="/about/#licenses">CC BY-SA 4.0 / GPLv3</a></div>
        </div>
      </main>
      <div class="app-header">
        <a id="avatar" href="/about"><img class="app-header-avatar" src="/images/avatar.png" /></a>
        <iframe src="https://github.com/sponsors/retifrav/button"
            height="35" style="border:0;"
            title="You can sponsor me">
        </iframe>
        
        <div class="sidebar-section">
            <input id="search-query" placeholder="Search in titles and summaries" />
        </div>
        <div id="search-results" style="display:none;"></div>
        <div id="sidebars">
            <div id="telegram" class="sidebar-section">
              <script async src="https://telegram.org/js/telegram-widget.js?5"
                  data-telegram-post="decovar/306" data-width="100%" data-userpic="false">
              </script>
            </div>
            <div class="sidebar-section">
              <h3>Feeds</h3>
              <a href="/index.xml" title="Subscribe to RSS"><img src="/images/rss.png" width="50px"></a>
              <a style="margin-left: 5px;" href="https://t.me/decovar" title="Telegram channel"><img src="/images/telegram.png" width="50px"></a>
            </div>
            <div class="sidebar-section">
                <h3>Stuff</h3>
                <ul class="sidebar-list">
                    <li><a href="/stuff/kakoi-jvotne-vi-kysaiti/index.html">КАКОИ ЖВОТНЕ ВЫ КУСАИТИ?</a></li>
                </ul>
            </div>
            <div class="sidebar-section">
                <h3>Top</h3>
                <ul class="sidebar-list">
                    <li><a href="/top/cider">Cider</a></li>
                </ul>
            </div>
            <div id="social-networks" class="sidebar-section">
              <h3>Social networks</h3>
              <div style="font-family:Courier New;">
                  Zuck: <i>Yeah so if you ever need info about anyone at Harvard</i><br/>
                  Zuck: <i>Just ask</i><br/>
                  Zuck: <i>I have over 4,000 emails, pictures, addresses, SNS</i><br/>
                  smb: <i>What? How'd you manage that one?</i><br/>
                  Zuck: <i>People just submitted it.</i><br/>
                  Zuck: <i>I don't know why.</i><br/>
                  Zuck: <i>They "trust me"</i><br/>
                  Zuck: <i>Dumb fucks</i>
              </div>
            </div>
            <div class="sidebar-section">
              <h3>Tags</h3>
              <ul style="list-style-type:none; padding:0; margin:0;">
                  
                  <li><a href="/tags/web">web (63)</a></li>
                  
                  <li><a href="/tags/fail">fail (39)</a></li>
                  
                  <li><a href="/tags/dotnet">dotnet (35)</a></li>
                  
                  <li><a href="/tags/qt">qt (32)</a></li>
                  
                  <li><a href="/tags/review">review (27)</a></li>
                  
                  <li><a href="/tags/devops">devops (24)</a></li>
                  
                  <li><a href="/tags/linux">linux (24)</a></li>
                  
                  <li><a href="/tags/macos">macos (23)</a></li>
                  
                  <li><a href="/tags/windows">windows (18)</a></li>
                  
                  <li><a href="/tags/mestuff">mestuff (16)</a></li>
                  
                  <li><a href="/tags/movies">movies (15)</a></li>
                  
                  <li><a href="/tags/tractor">tractor (14)</a></li>
                  
                  <li><a href="/tags/norway">norway (13)</a></li>
                  
                  <li><a href="/tags/irl">irl (12)</a></li>
                  
                  <li><a href="/tags/telegram">telegram (12)</a></li>
                  
                  <li><a href="/tags/python">python (11)</a></li>
                  
                  <li><a href="/tags/soft">soft (10)</a></li>
                  
                  <li><a href="/tags/travel">travel (10)</a></li>
                  
                  <li><a href="/tags/applescript">applescript (9)</a></li>
                  
                  <li><a href="/tags/embedded">embedded (9)</a></li>
                  
                  <li><a href="/tags/piracy">piracy (9)</a></li>
                  
                  <li><a href="/tags/octopress">octopress (8)</a></li>
                  
                  <li><a href="/tags/banks">banks (7)</a></li>
                  
                  <li><a href="/tags/cmake">cmake (7)</a></li>
                  
                  <li><a href="/tags/cpp">cpp (7)</a></li>
                  
                  <li><a href="/tags/ios">ios (7)</a></li>
                  
                  <li><a href="/tags/apple">apple (6)</a></li>
                  
                  <li><a href="/tags/games">games (6)</a></li>
                  
                  <li><a href="/tags/javascript">javascript (6)</a></li>
                  
                  <li><a href="/tags/photo">photo (6)</a></li>
                  
                  <li><a href="/tags/sql">sql (6)</a></li>
                  
                  <li><a href="/tags/hugo">hugo (4)</a></li>
                  
                  <li><a href="/tags/russia">russia (4)</a></li>
                  
                  <li><a href="/tags/wordpress">wordpress (4)</a></li>
                  
                  <li><a href="/tags/android">android (3)</a></li>
                  
                  <li><a href="/tags/tv">tv (3)</a></li>
                  
                  <li><a href="/tags/usa">usa (3)</a></li>
                  
                  <li><a href="/tags/azure">azure (2)</a></li>
                  
                  <li><a href="/tags/tvos">tvos (2)</a></li>
                  
                  <li><a href="/tags/unsolved">unsolved (2)</a></li>
                  
                  <li><a href="/tags/books">books (1)</a></li>
                  
                  <li><a href="/tags/ffmpeg">ffmpeg (1)</a></li>
                  
                  <li><a href="/tags/music">music (1)</a></li>
                  
                  <li><a href="/tags/privacy">privacy (1)</a></li>
                  
                  <li><a href="/tags/science">science (1)</a></li>
                  
                  <li><a href="/tags/vr">vr (1)</a></li>
                  
              </ul>
            </div>
        </div>
      </header>
    </div>

    <script src="/js/search.js"></script>

    
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-53340325-1"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag() { dataLayer.push(arguments); }
      gtag("js", new Date());
      gtag("config", "UA-53340325-1");
    </script>

    
    
  </body>
</html>
