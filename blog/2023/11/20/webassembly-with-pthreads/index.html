<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Compiling C&#43;&#43; into WebAssembly with pthreads | Declaration of VAR</title>
    <link rel="canonical" href="https://decovar.dev/blog/2023/11/20/webassembly-with-pthreads/" />

    <meta name="generator" content="Hugo 0.123.3" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <link href="/favicon.png" rel="icon">

    <meta name="author" content="retif" />
    <meta name="description" content="If a C&#43;&#43; program utilizes multithreading via pthreads, then compiling it with Emscripten into WebAssembly requires setting certain flags for both compiler and linker. In addition to that, web-server that will be hosting the resulting web-application also requires some configuration." />

    <link rel="alternate" type="application/rss+xml" href="/index.xml" title="Declaration of VAR" />

    <meta property="og:title" content="Compiling C&#43;&#43; into WebAssembly with pthreads" />
<meta property="og:description" content="If a C&#43;&#43; program utilizes multithreading via pthreads, then compiling it with Emscripten into WebAssembly requires setting certain flags for both compiler and linker. In addition to that, web-server that will be hosting the resulting web-application also requires some configuration." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://retifrav.github.io/blog/2023/11/20/webassembly-with-pthreads/" /><meta property="article:section" content="blog" />
<meta property="article:published_time" content="2023-11-20T14:40:47+01:00" />
<meta property="article:modified_time" content="2023-11-20T14:40:47+01:00" />



    <link rel="stylesheet" href="https://retifrav.github.io/css/main.min.2a28493e0b91076cde9fb52cb7fec81f63f685a6965e6a9df1179ec846b9141f.css" />
    <link rel="stylesheet" href="/css/default.css" />
    <link rel="stylesheet" href="/css/post.css" />
    <link rel="stylesheet" href="/css/page.css" />
    <link rel="stylesheet" href="/css/comments.css" />

    <script src="/js/mark.js"></script>

    
    
  </head>
  <body>
    <div id="body-hat">
      <div id="title-block">
        <h1 id="blog-title"><a href="/">Declaration of VAR</a></h1>
        <p>and some other stuff</p>
      </div>
    </div>
    <div style="background-color:orange; padding:4px 16px; font-size:0.8em; text-align:center; font-style:italic;">
        On 19.05.2021 the website was moved to
        <a href="https://decovar.dev/blog/2023/11/20/webassembly-with-pthreads/" style="color:black; font-weight:bold;">
            https://decovar.dev/</a>. This is just a mirror now.
    </div>
    <div id="body-flex">
      <main class="app-container">
        
  <div id="main-container">
    <article class="post">
      <header class="post-header">
        <h1 class ="post-title">Compiling C&#43;&#43; into WebAssembly with pthreads</h1>
        <div class="post-meta">
          <div><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-calendar">
  <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line>
</svg> 2023-11-20 14:40:47 &#43;0100</div>
          <div><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-clock">
  <circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline>
</svg> 14 min read</div>
        </div>
      </header>
      <div class="post-content">
        <p>If a C++ program utilizes multithreading via <a href="https://en.wikipedia.org/wiki/Pthreads">pthreads</a>, then compiling it with <a href="https://emscripten.org/docs/porting/pthreads.html">Emscripten</a> into <a href="https://webassembly.org">WebAssembly</a> requires setting certain flags for both compiler and linker. In addition to that, web-server that will be hosting the resulting web-application also requires some configuration.</p>




<figure class="with-original">
    <img class="image-post" loading="lazy" src="/blog/2023/11/20/webassembly-with-pthreads/images/webassembly-with-pthreads.png" alt="Meepo clones dancing on top of the WebAssembly logo with pthreads">
    <footer>
        <small>
            <i><a href="https://deviantart.com/kyurikitg/art/Meepo-the-Geomancer-401539735">original Meepo picture</a></i>
        </small>
    </footer>
</figure>

<p>A couple of years ago I <a href="/blog/2021/08/29/qt-webassembly-custom-opengl/">compiled</a> a Qt-based application into WebAssembly using Emscripten, and I did mention pthreads there too, but it was very briefly and without any details. And as it turned out, there are some interesting moments in there which are worth being documented.</p>
<nav id="TableOfContents">
  <ul>
    <li><a href="#an-example-c-program">An example C++ program</a></li>
    <li><a href="#compiling-into-webassembly">Compiling into WebAssembly</a>
      <ul>
        <li><a href="#with-cmake">With CMake</a></li>
      </ul>
    </li>
    <li><a href="#running-the-results">Running the results</a>
      <ul>
        <li><a href="#mime-types-and-http-headers">MIME types and HTTP headers</a></li>
        <li><a href="#secure-context-with-https">Secure context with HTTPS</a>
          <ul>
            <li><a href="#struggling-with-openssl-on-windows">Struggling with OpenSSL on Windows</a></li>
          </ul>
        </li>
        <li><a href="#web-browsers-support">Web-browsers support</a></li>
      </ul>
    </li>
  </ul>
</nav>
<h1 id="an-example-c-program">An example C++ program</h1>
<p>To demonstrate multithreading I needed a C++ program that executes some tasks in parallel. As I am still not a real developer, especially when it comes to parallel programming, especially in C++, the example I&rsquo;ve managed to come up with is probably isn&rsquo;t the best example in the world. My only hope is that it is at least a correct one.</p>
<p>The sources of the program are <a href="https://github.com/retifrav/webassembly-pthreads-example/tree/master/src">here</a>.</p>
<p>The idea is that there are two executables and one common function. All that function does is it sleeps for 2 seconds and performs some meaningless calculation:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">doShit</span>(<span style="color:#66d9ef">int</span> someID, <span style="color:#66d9ef">bool</span> isAThread)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    sleep(<span style="color:#ae81ff">2</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span>(isAThread)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        printf(<span style="color:#e6db74">&#34;ololo, inside a thread, batch ID: %d</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, someID);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        std<span style="color:#f92672">::</span>cout <span style="color:#f92672">&lt;&lt;</span> <span style="color:#e6db74">&#34;ololo, inside the task #&#34;</span> <span style="color:#f92672">&lt;&lt;</span> someID <span style="color:#f92672">&lt;&lt;</span> std<span style="color:#f92672">::</span>endl;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">double</span> result <span style="color:#f92672">=</span> <span style="color:#ae81ff">0.0</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">11111</span>; i<span style="color:#f92672">++</span>)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        result <span style="color:#f92672">=</span> result <span style="color:#f92672">+</span> sin(i) <span style="color:#f92672">*</span> tan(i);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div>
<p>One executable sequently calls this function 10 times, while another executable spawns 10 threads to call that same function in parallel. Naturally, the latter one is supposed to finish the work faster.</p>
<p>Let&rsquo;s check that. First the variant without threads:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ cd /path/to/webassembly-pthreads-example
</span></span><span style="display:flex;"><span>$ mkdir build <span style="color:#f92672">&amp;&amp;</span> cd $_
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ clang++ ../src/without-pthreads.cpp ../src/some-shit.cpp -o some-without-threads
</span></span><span style="display:flex;"><span>$ time ./some-without-threads
</span></span><span style="display:flex;"><span>A program WITHOUT threads
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>ololo, inside the task <span style="color:#75715e">#0</span>
</span></span><span style="display:flex;"><span>ololo, inside the task <span style="color:#75715e">#1</span>
</span></span><span style="display:flex;"><span>ololo, inside the task <span style="color:#75715e">#2</span>
</span></span><span style="display:flex;"><span>ololo, inside the task <span style="color:#75715e">#3</span>
</span></span><span style="display:flex;"><span>ololo, inside the task <span style="color:#75715e">#4</span>
</span></span><span style="display:flex;"><span>ololo, inside the task <span style="color:#75715e">#5</span>
</span></span><span style="display:flex;"><span>ololo, inside the task <span style="color:#75715e">#6</span>
</span></span><span style="display:flex;"><span>ololo, inside the task <span style="color:#75715e">#7</span>
</span></span><span style="display:flex;"><span>ololo, inside the task <span style="color:#75715e">#8</span>
</span></span><span style="display:flex;"><span>ololo, inside the task <span style="color:#75715e">#9</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>real    0m20.306s</span></span></code></pre></div>
<p>and then the variant with threads:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ pwd
</span></span><span style="display:flex;"><span>/path/to/webassembly-pthreads-example/build
</span></span><span style="display:flex;"><span>$ rm -r ./*; ls -lah
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ clang++ ../src/with-pthreads.cpp ../src/some-shit.cpp -o some-with-threads
</span></span><span style="display:flex;"><span>$ time ./some-with-threads
</span></span><span style="display:flex;"><span>A program WITH threads
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Spawned thread <span style="color:#75715e">#0</span>
</span></span><span style="display:flex;"><span>Spawned thread <span style="color:#75715e">#1</span>
</span></span><span style="display:flex;"><span>Spawned thread <span style="color:#75715e">#2</span>
</span></span><span style="display:flex;"><span>Spawned thread <span style="color:#75715e">#3</span>
</span></span><span style="display:flex;"><span>Spawned thread <span style="color:#75715e">#4</span>
</span></span><span style="display:flex;"><span>Spawned thread <span style="color:#75715e">#5</span>
</span></span><span style="display:flex;"><span>Spawned thread <span style="color:#75715e">#6</span>
</span></span><span style="display:flex;"><span>Spawned thread <span style="color:#75715e">#7</span>
</span></span><span style="display:flex;"><span>Spawned thread <span style="color:#75715e">#8</span>
</span></span><span style="display:flex;"><span>Spawned thread <span style="color:#75715e">#9</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>ololo, inside a thread, batch ID: <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>ololo, inside a thread, batch ID: <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>ololo, inside a thread, batch ID: <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>ololo, inside a thread, batch ID: <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>ololo, inside a thread, batch ID: <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>ololo, inside a thread, batch ID: <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>ololo, inside a thread, batch ID: <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>ololo, inside a thread, batch ID: <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>ololo, inside a thread, batch ID: <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>ololo, inside a thread, batch ID: <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>real    0m2.218s</span></span></code></pre></div>
<p>As expected, ~20 seconds of sequential execution without threads versus ~2 seconds of parallel computing with threads.</p>
<h1 id="compiling-into-webassembly">Compiling into WebAssembly</h1>
<p>I have <a href="/blog/2021/08/29/qt-webassembly-custom-opengl/#installing-emscripten">already described</a> installing Emscripten, and the only addition here is that instead of getting exactly the version <code>1.39.8</code> (<em>which is rather old by now, after all it&rsquo;s web we are talking about</em>) you can just set the <code>latest</code> value, and it well get you whichever is the latest one available (<em>I got <code>3.1.48</code></em>).</p>
<p>Also don&rsquo;t forget to <code>source</code> the <code>emsdk_env.sh</code> environment before trying to build the project.</p>
<p>Without pthreads the compilation is the same as before:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ cd /path/to/webassembly-pthreads-example
</span></span><span style="display:flex;"><span>$ mkdir build <span style="color:#f92672">&amp;&amp;</span> cd $_
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ emcc ../src/without-pthreads.cpp ../src/some-shit.cpp <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    -o ./some-without-pthreads.html</span></span></code></pre></div>
<p>I didn&rsquo;t like how it bundles styles and scripts into one <code>.html</code>, so I&rsquo;ve split it and used <code>-o</code> to bare <code>*.js</code> afterwards. The resulting files are:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ emcc ../src/without-pthreads.cpp ../src/some-shit.cpp <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    -o ./some-without-pthreads.js
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ du -h ./*
</span></span><span style="display:flex;"><span>176K    ./some-without-pthreads.js
</span></span><span style="display:flex;"><span>168K    ./some-without-pthreads.wasm</span></span></code></pre></div>
<p>To compile into WebAssembly with enabled pthreads support, you need to set <code>-pthread</code> <em>compiler</em> flag. Documentation <a href="https://emscripten.org/docs/porting/pthreads.html#compiling-with-pthreads-enabled">says</a> that you also need to set <code>-pthread</code> <em>linker</em> flag, although I haven&rsquo;t noticed any problems if it isn&rsquo;t set. Anyway, the compilation command then becomes the following:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ pwd
</span></span><span style="display:flex;"><span>/path/to/webassembly-pthreads-example/build
</span></span><span style="display:flex;"><span>$ rm -r ./*; ls -lah
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ emcc ../src/with-pthreads.cpp ../src/some-shit.cpp <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    -o ./some-with-pthreads.js <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    -pthread
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ du -h ./*
</span></span><span style="display:flex;"><span>212K    ./some-with-pthreads.js
</span></span><span style="display:flex;"><span>184K    ./some-with-pthreads.wasm
</span></span><span style="display:flex;"><span>8.0K    ./some-with-pthreads.worker.js</span></span></code></pre></div>
<p>So in addition to <code>*.js</code> and <code>*.wasm</code> files now there is also <code>*.worker.js</code>.</p>
<p>If you&rsquo;ll try to build it without providing <code>-pthread</code> flag, then it will still compile, but there will no <code>*.worker.js</code> file produced, and the program will fail to run in web-browser like this:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>some-with-pthreads.js:1 <span style="color:#f92672">[</span>ERROR<span style="color:#f92672">]</span> <span style="color:#66d9ef">return</span> code from pthread_create<span style="color:#f92672">()</span> is <span style="color:#ae81ff">6</span> | Resource temporarily unavailable</span></span></code></pre></div>
<p>thanks to this check in the program sources:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#66d9ef">int</span> rez <span style="color:#f92672">=</span> pthread_create(<span style="color:#f92672">&amp;</span>thread_ids[i], NULL, threadCallback, <span style="color:#f92672">&amp;</span>batchID);
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> (rez)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    std<span style="color:#f92672">::</span>cerr <span style="color:#f92672">&lt;&lt;</span> <span style="color:#e6db74">&#34;[ERROR] return code from pthread_create() is &#34;</span> <span style="color:#f92672">&lt;&lt;</span> rez
</span></span><span style="display:flex;"><span>              <span style="color:#f92672">&lt;&lt;</span> <span style="color:#e6db74">&#34; | &#34;</span> <span style="color:#f92672">&lt;&lt;</span> strerror(rez)
</span></span><span style="display:flex;"><span>              <span style="color:#f92672">&lt;&lt;</span> std<span style="color:#f92672">::</span>endl;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> EXIT_FAILURE;
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div>
<p>There is one more linker flag which you most probably will need to add too: <code>-sPROXY_TO_PTHREAD</code>. There will be some details about it <a href="#running-without-proxy-to-pthread">later</a>, but for now let&rsquo;s continue without it.</p>
<h2 id="with-cmake">With CMake</h2>
<p>Of course, there is the fun in compiling everything in just one line, so I made a <a href="https://github.com/retifrav/webassembly-pthreads-example/blob/master/CMakeLists.txt">CMake project</a> for this. Jokes aside, even though it looks more complicated, managing a project with CMake will inevitably pay off going forward, especially when you&rsquo;ll start bringing in dependencies.</p>
<p>Adding compiler and linker flags can be done like this:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cmake" data-lang="cmake"><span style="display:flex;"><span>set(<span style="color:#e6db74">EMSCRIPTEN_PTHREADS_COMPILER_FLAGS</span> <span style="color:#e6db74">&#34;-pthread&#34;</span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>set(<span style="color:#e6db74">EMSCRIPTEN_PTHREADS_LINKER_FLAGS</span> <span style="color:#e6db74">&#34;${EMSCRIPTEN_PTHREADS_COMPILER_FLAGS}&#34;</span>) <span style="color:#75715e"># -sPROXY_TO_PTHREAD
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>if(<span style="color:#e6db74">EMSCRIPTEN</span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>    string(<span style="color:#e6db74">APPEND</span> <span style="color:#e6db74">CMAKE_C_FLAGS</span> <span style="color:#e6db74">&#34; ${EMSCRIPTEN_PTHREADS_COMPILER_FLAGS}&#34;</span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>    string(<span style="color:#e6db74">APPEND</span> <span style="color:#e6db74">CMAKE_CXX_FLAGS</span> <span style="color:#e6db74">&#34; ${EMSCRIPTEN_PTHREADS_COMPILER_FLAGS}&#34;</span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>    string(<span style="color:#e6db74">APPEND</span> <span style="color:#e6db74">CMAKE_EXE_LINKER_FLAGS</span> <span style="color:#e6db74">&#34; ${EMSCRIPTEN_PTHREADS_LINKER_FLAGS}&#34;</span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>endif()</span></span></code></pre></div>
<p>Alternatively, linker flags can be set via target properties:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span><span style="color:#66d9ef">if</span><span style="color:#f92672">(</span><span style="color:#a6e22e">EMSCRIPTEN</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    set_target_properties<span style="color:#f92672">(</span>$<span style="color:#f92672">{</span><span style="color:#a6e22e">CMAKE_PROJECT_NAME</span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">PROPERTIES</span>
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">LINK_FLAGS</span> <span style="color:#e6db74">&#34;${EMSCRIPTEN_PTHREADS_LINKER_FLAGS}&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>endif<span style="color:#f92672">()</span></span></span></code></pre></div>
<p>Either way, building the project now becomes the following. First, regular CLI program without pthreads:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ cd /path/to/webassembly-pthreads-example/build
</span></span><span style="display:flex;"><span>$ rm -r ./*; rm .ninja_*; ls -lah
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ cmake -G Ninja -DCMAKE_BUILD_TYPE<span style="color:#f92672">=</span>Release -DWITH_PTHREADS<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span> ..
</span></span><span style="display:flex;"><span>$ cmake --build . --target install
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>3/4<span style="color:#f92672">]</span> Install the project...
</span></span><span style="display:flex;"><span>-- Install configuration: <span style="color:#e6db74">&#34;Release&#34;</span>
</span></span><span style="display:flex;"><span>-- Installing: /path/to/webassembly-pthreads-example/install/some-without-pthreads</span></span></code></pre></div>
<p>and with pthreads:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ pwd
</span></span><span style="display:flex;"><span>/path/to/webassembly-pthreads-example/build
</span></span><span style="display:flex;"><span>$ rm -r ./*; rm .ninja_*; ls -lah
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ cmake -G Ninja -DCMAKE_BUILD_TYPE<span style="color:#f92672">=</span>Release -DWITH_PTHREADS<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span> ..
</span></span><span style="display:flex;"><span>$ cmake --build . --target install
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>3/4<span style="color:#f92672">]</span> Install the project...
</span></span><span style="display:flex;"><span>-- Install configuration: <span style="color:#e6db74">&#34;Release&#34;</span>
</span></span><span style="display:flex;"><span>-- Installing: /path/to/webassembly-pthreads-example/install/some-with-pthreads</span></span></code></pre></div>
<p>Note that I didn&rsquo;t provide <code>-DCMAKE_INSTALL_PREFIX=&quot;../install&quot;</code> for the installation, as one would expect me to. This is because that path is <a href="https://github.com/retifrav/webassembly-pthreads-example/blob/9dc33d88bc97cc1e4ae0db167a8e0c526cc2345d/CMakeLists.txt#L77">already managed</a> inside the project.</p>
<p>Then WebAssembly variant without pthreads:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ pwd
</span></span><span style="display:flex;"><span>/path/to/webassembly-pthreads-example/build
</span></span><span style="display:flex;"><span>$ rm -r ./*; rm .ninja_*; ls -lah
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ cmake -G Ninja -DCMAKE_BUILD_TYPE<span style="color:#f92672">=</span>Release -DWITH_PTHREADS<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    -DCMAKE_TOOLCHAIN_FILE<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;</span>$EMSDK<span style="color:#e6db74">/upstream/emscripten/cmake/Modules/Platform/Emscripten.cmake&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    ..
</span></span><span style="display:flex;"><span>$ cmake --build . --target install
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>3/4<span style="color:#f92672">]</span> Linking CXX executable some-without-pthreads.js
</span></span><span style="display:flex;"><span>em++: warning: ignoring unsupported linker flag: <span style="color:#e6db74">`</span>-rpath<span style="color:#e6db74">`</span> <span style="color:#f92672">[</span>-Wlinkflags<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>3/4<span style="color:#f92672">]</span> Install the project...
</span></span><span style="display:flex;"><span>-- Install configuration: <span style="color:#e6db74">&#34;Release&#34;</span>
</span></span><span style="display:flex;"><span>-- Installing: /path/to/webassembly-pthreads-example/web/some-without-pthreads.js
</span></span><span style="display:flex;"><span>-- Installing: /path/to/webassembly-pthreads-example/web/some-without-pthreads.wasm
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ du -h ../web/some-without*
</span></span><span style="display:flex;"><span> 68K    ../web/some-without-pthreads.js
</span></span><span style="display:flex;"><span>140K    ../web/some-without-pthreads.wasm</span></span></code></pre></div>
<p>and with pthreads:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ pwd
</span></span><span style="display:flex;"><span>/path/to/webassembly-pthreads-example/build
</span></span><span style="display:flex;"><span>$ rm -r ./*; rm .ninja_*; ls -lah
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ cmake -G Ninja -DCMAKE_BUILD_TYPE<span style="color:#f92672">=</span>Release -DWITH_PTHREADS<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    -DCMAKE_TOOLCHAIN_FILE<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;</span>$EMSDK<span style="color:#e6db74">/upstream/emscripten/cmake/Modules/Platform/Emscripten.cmake&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    ..
</span></span><span style="display:flex;"><span>$ cmake --build . --target install
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>3/4<span style="color:#f92672">]</span> Linking CXX executable some-with-pthreads.js
</span></span><span style="display:flex;"><span>em++: warning: ignoring unsupported linker flag: <span style="color:#e6db74">`</span>-rpath<span style="color:#e6db74">`</span> <span style="color:#f92672">[</span>-Wlinkflags<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>3/4<span style="color:#f92672">]</span> Install the project...
</span></span><span style="display:flex;"><span>-- Install configuration: <span style="color:#e6db74">&#34;Release&#34;</span>
</span></span><span style="display:flex;"><span>-- Installing: /path/to/webassembly-pthreads-example/web/some-with-pthreads.js
</span></span><span style="display:flex;"><span>-- Installing: /path/to/webassembly-pthreads-example/web/some-with-pthreads.wasm
</span></span><span style="display:flex;"><span>-- Installing: /path/to/webassembly-pthreads-example/web/some-with-pthreads.worker.js
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ du -h ../web/some-with-*
</span></span><span style="display:flex;"><span> 84K    ../web/some-with-pthreads.js
</span></span><span style="display:flex;"><span>156K    ../web/some-with-pthreads.wasm
</span></span><span style="display:flex;"><span>4.0K    ../web/some-with-pthreads.worker.js</span></span></code></pre></div>
<p>No idea why does it warn about <code>-rpath</code> flag and what I can do about it.</p>
<p>Also, it is interesting how the sizes are different between the same files that were built directly with <code>emcc</code> and those built through CMake (<em>the latter ones are smaller</em>). It is probably because <code>Emscripten.cmake</code> toolchain sets some optimization flags, although I didn&rsquo;t see any at first glance.</p>
<h1 id="running-the-results">Running the results</h1>
<p>Most of the information I got from <a href="https://web.dev/articles/webassembly-threads">this article</a>. In short, to be able to run a pthreads-enabled WebAssembly binary in a web-browser, you need to fulfil several requirements:</p>
<ol>
<li>Web-server:
<ul>
<li>MIME types for <code>.wasm</code> and <code>.js</code>;</li>
<li>cross-origin isolation HTTP headers (<em><a href="https://web.dev/articles/coop-coep">COEP/COOP</a></em>);</li>
<li><a href="https://w3c.github.io/webappsec-secure-contexts/">secure context</a> (<em>HTTPS</em>);</li>
</ul>
</li>
<li>Web-browser:
<ul>
<li><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/SharedArrayBuffer">SharedArrayBuffer</a> support.</li>
</ul>
</li>
</ol>
<h2 id="mime-types-and-http-headers">MIME types and HTTP headers</h2>
<p>With a basic <a href="https://docs.python.org/3/library/http.server.html">Python HTTP server</a> as an example:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-py" data-lang="py"><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">HttpRequestHandler</span>(http<span style="color:#f92672">.</span>server<span style="color:#f92672">.</span>SimpleHTTPRequestHandler):
</span></span><span style="display:flex;"><span>    extensions_map <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;.js&#34;</span>: <span style="color:#e6db74">&#34;application/javascript&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;.wasm&#34;</span>: <span style="color:#e6db74">&#34;application/wasm&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># ...</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;</span>: <span style="color:#e6db74">&#34;application/octet-stream&#34;</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">send_response</span>(self, <span style="color:#f92672">*</span>args, <span style="color:#f92672">**</span>kwargs):
</span></span><span style="display:flex;"><span>        http<span style="color:#f92672">.</span>server<span style="color:#f92672">.</span>SimpleHTTPRequestHandler<span style="color:#f92672">.</span>send_response(self, <span style="color:#f92672">*</span>args, <span style="color:#f92672">**</span>kwargs)
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>send_header(<span style="color:#e6db74">&#34;Cross-Origin-Embedder-Policy&#34;</span>, <span style="color:#e6db74">&#34;require-corp&#34;</span>)
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>send_header(<span style="color:#e6db74">&#34;Cross-Origin-Opener-Policy&#34;</span>, <span style="color:#e6db74">&#34;same-origin&#34;</span>)</span></span></code></pre></div>
<p>Of course, this particular web-server implementation isn&rsquo;t recommended for actual production use. Basically, it&rsquo;s only good for localhost development environment, and so just in case here&rsquo;s an example of configuring the same stuff for NGINX:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nginx" data-lang="nginx"><span style="display:flex;"><span><span style="color:#66d9ef">http</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># ...
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">types</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># ...
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#f92672">application/javascript</span> <span style="color:#e6db74">js</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">application/wasm</span> <span style="color:#e6db74">wasm</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">server</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># ...
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">add_header</span> <span style="color:#e6db74">Cross-Origin-Embedder-Policy</span> <span style="color:#e6db74">&#34;require-corp&#34;</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">add_header</span> <span style="color:#e6db74">Cross-Origin-Opener-Policy</span> <span style="color:#e6db74">&#34;same-origin&#34;</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div>
<p>Other web-servers have similar configuration options too.</p>
<h2 id="secure-context-with-https">Secure context with HTTPS</h2>
<p>This basically means that you need to have an SSL/TLS certificate to serve your web-application via HTTPS. For production environment you most probably already <a href="/blog/2021/04/05/acme-sh-instead-of-certbot/">have a certificate</a> for your domain, but how does one get a certificate for localhost?</p>
<p>Turns out, it&rsquo;s just <a href="https://letsencrypt.org/docs/certificates-for-localhost/">one command</a> (<em>with a set of arguments you&rsquo;d never figure out on your own</em>):</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ cd /path/to/webassembly-pthreads-example/certificates
</span></span><span style="display:flex;"><span>$ openssl req -x509 -newkey rsa:2048 -nodes -sha256 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    -subj <span style="color:#e6db74">&#39;/CN=localhost&#39;</span> -extensions EXT -config &lt;<span style="color:#f92672">(</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    printf <span style="color:#e6db74">&#34;[dn]\nCN=localhost\n[req]\ndistinguished_name=dn\n[EXT]\nsubjectAltName=DNS:localhost\nkeyUsage=digitalSignature\nextendedKeyUsage=serverAuth&#34;</span><span style="color:#f92672">)</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    -out localhost.crt -keyout localhost.key</span></span></code></pre></div>
<p>Resulting certificate (<em><code>localhost.crt</code></em>) and key (<em><code>localhost.key</code></em>) files can be provided to a web-server, as you would normally do that. Here&rsquo;s an example for Python HTTP server:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-py" data-lang="py"><span style="display:flex;"><span><span style="color:#75715e"># ...</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>context <span style="color:#f92672">=</span> ssl<span style="color:#f92672">.</span>SSLContext(ssl<span style="color:#f92672">.</span>PROTOCOL_TLS_SERVER)
</span></span><span style="display:flex;"><span>context<span style="color:#f92672">.</span>load_cert_chain(
</span></span><span style="display:flex;"><span>    certfile<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;/path/to/webassembly-pthreads-example/certificates/localhost.crt&#34;</span>,
</span></span><span style="display:flex;"><span>    keyfile<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;/path/to/webassembly-pthreads-example/certificates/localhost.key&#34;</span>
</span></span><span style="display:flex;"><span>)</span></span></code></pre></div>
<p>and here&rsquo;s an example for <a href="/blog/2021/04/05/acme-sh-instead-of-certbot/#how-to-use-certificate-with-nginx">NGINX</a>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nginx" data-lang="nginx"><span style="display:flex;"><span><span style="color:#66d9ef">server</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># ...
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">ssl_certificate</span> <span style="color:#e6db74">/path/to/webassembly-pthreads-example/certificates/localhost.crt</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">ssl_certificate_key</span> <span style="color:#e6db74">/path/to/webassembly-pthreads-example/certificates/localhost.key</span>;
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div>
<p>Web-browsers will still show a warning when you&rsquo;ll try to open the page for the first time, as the certificate is self-signed and isn&rsquo;t verified by anyone. Here&rsquo;s a warning you&rsquo;ll get in Firefox:</p>


    <img class="image-post" loading="lazy" src="/blog/2023/11/20/webassembly-with-pthreads/images/self-signed-certificate-firefox.png" alt="Self-signed certificate for localhost, Firefox warning" style="border:1px solid black;">

<p>and here&rsquo;s a warning from the certificate preview in Safari:</p>


    <img class="image-post" loading="lazy" src="/blog/2023/11/20/webassembly-with-pthreads/images/self-signed-certificate-safari.png" alt="Self-signed certificate for localhost, Safari warning">

<p>Anyway, it&rsquo;s no problem to just ignore these warnings and still open the page, you don&rsquo;t even need to add this certificate to the trusted ones on system level.</p>
<h3 id="struggling-with-openssl-on-windows">Struggling with OpenSSL on Windows</h3>
<p>That OpenSSL command for creating a certificate should succeed on Mac OS and GNU/Linux, but it most likely will fail on Windows.</p>
<p>In regular cmd it will fail with:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cmd" data-lang="cmd"><span style="display:flex;"><span>The system cannot find the file specified.</span></span></code></pre></div>
<p>If trying to check OpenSSL version fails too, then it might be because OpenSSL executable isn&rsquo;t in the PATH:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cmd" data-lang="cmd"><span style="display:flex;"><span>&gt; openssl version
</span></span><span style="display:flex;"><span>&#39;openssl&#39; is not recognized as an internal or external command,
</span></span><span style="display:flex;"><span>operable program or batch file.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>&gt; c:\programs\git\usr\bin\openssl.exe version
</span></span><span style="display:flex;"><span>OpenSSL 3.1.2 1 Aug 2023 (Library: OpenSSL 3.1.2 1 Aug 2023)</span></span></code></pre></div>
<p>But still, even with the full path to <code>openssl.exe</code> the command to create a certificate will fail with the same error, and that is apparently because cmd can&rsquo;t process input redirection (<em>and there is no <code>printf</code> in cmd</em>).</p>
<p>However, trying to execute the command in Git BASH fails too:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cmd" data-lang="cmd"><span style="display:flex;"><span>Can&#39;t open <span style="color:#e6db74">&#34;/proc/1677/fd/63&#34;</span> for reading, No such file or directory
</span></span><span style="display:flex;"><span>341B0000:error:80000003:system library:BIO_new_file:No such process:../openssl-3.1.2/crypto/bio/bss_file.c:67:calling fopen(/proc/1677/fd/63, r)
</span></span><span style="display:flex;"><span>341B0000:error:10000080:BIO routines:BIO_new_file:no such file:../openssl-3.1.2/crypto/bio/bss_file.c:75:</span></span></code></pre></div>
<p>And surprisingly <a href="https://stackoverflow.com/questions/39160884/cannot-generate-a-new-csr-in-git-bash">that</a> is also because of the issues with input redirection. So instead of providing parameters inline with <code>printf</code>, create a file <code>params.conf</code> and put them there:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ini" data-lang="ini"><span style="display:flex;"><span><span style="color:#66d9ef">[dn]</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">CN</span><span style="color:#f92672">=</span><span style="color:#e6db74">localhost</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">[req]</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">distinguished_name</span><span style="color:#f92672">=</span><span style="color:#e6db74">dn</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">[EXT]</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">subjectAltName</span><span style="color:#f92672">=</span><span style="color:#e6db74">DNS:localhost</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">keyUsage</span><span style="color:#f92672">=</span><span style="color:#e6db74">digitalSignature</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">extendedKeyUsage</span><span style="color:#f92672">=</span><span style="color:#e6db74">serverAuth</span></span></span></code></pre></div>
<p>Then the command becomes this:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ openssl req -x509 -newkey rsa:2048 -nodes -sha256 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    -subj <span style="color:#e6db74">&#39;/CN=localhost&#39;</span> -extensions EXT -config params.conf <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    -out localhost.crt -keyout localhost.key</span></span></code></pre></div>
<p>But it will still fail in Git BASH, although with a different error:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>req: subject name is expected to be in the format /type0<span style="color:#f92672">=</span>value0/type1<span style="color:#f92672">=</span>value1/type2<span style="color:#f92672">=</span>... where characters may be escaped by <span style="color:#ae81ff">\.</span> This name is not in that format: <span style="color:#e6db74">&#39;C:/programs/git/CN=localhost&#39;</span></span></span></code></pre></div>
<p>A <a href="https://stackoverflow.com/a/31990313/1688203">workaround</a> for that one is to add one more <code>/</code> to the <code>-subj</code> argument, so it becomes <code>-subj '//CN=localhost'</code>.</p>
<p>At the same time, it succeeds in regular cmd even without adding this <code>/</code>, so at least you should be able to use that:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cmd" data-lang="cmd"><span style="display:flex;"><span>&gt; c:\programs\git\usr\bin\openssl.exe req -x509 -newkey rsa:2048 -nodes -sha256 -subj &#39;/CN=localhost&#39; -extensions EXT -config params.conf -out localhost.crt -keyout localhost.key</span></span></code></pre></div>
<p>If nothing helps, then you&rsquo;ll have to use proper environment on Mac OS or GNU/Linux to create certificate there and copy its files to your Windows machine.</p>
<h2 id="web-browsers-support">Web-browsers support</h2>
<p>Not that long ago you could count only on Chromium-based browsers, because while there was a good chance that simple web-applications would run in any browser, more complex applications were often stumbling upon various issues in non-Chromium browsers.</p>
<p>For example, Firefox (<em>at least in version <code>99</code> but probably later too</em>) did not support dynamic loading of modules in <a href="https://html.spec.whatwg.org/multipage/workers.html">workers</a> (<em>here&rsquo;s a <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1247687">bugreport</a> about that</em>) and was failing with the following error:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>Dynamic module import is disabled or not supported in this context</span></span></code></pre></div>
<p>And WebKit-based browsers, such as Safari (<em>at least around version <code>15.4</code></em>), were simply crashing, trying to reload the page several times before finally giving up for good.</p>
<p>Fortunately, nowadays all(?) modern web-browsers do support pthreads-enabled WebAssembly. Nevertheless, it is still a good idea to ship your web-application in two variants: with and without pthreads enabled, and load this or that variant based on certain checks.</p>
<p>In particular, to detect whether current web-browser has support for <code>SharedArrayBuffer</code> or not, you can do <a href="https://github.com/retifrav/webassembly-pthreads-example/blob/838c82acafea35edd85417f1e1b9feb9779a6df2/web/index.html#L23">the following</a>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#66d9ef">let</span> <span style="color:#a6e22e">pthreadsSupported</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">sharedArrayBufferSupported</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">typeof</span> <span style="color:#a6e22e">SharedArrayBuffer</span> <span style="color:#f92672">!==</span> <span style="color:#e6db74">&#34;undefined&#34;</span>;
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">debug</span>(<span style="color:#e6db74">`SharedArrayBuffer supported: </span><span style="color:#e6db74">${</span><span style="color:#a6e22e">sharedArrayBufferSupported</span><span style="color:#e6db74">}</span><span style="color:#e6db74">`</span>);
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">try</span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span>(<span style="color:#a6e22e">sharedArrayBufferSupported</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#66d9ef">typeof</span> <span style="color:#a6e22e">MessageChannel</span> <span style="color:#f92672">!==</span> <span style="color:#e6db74">&#34;undefined&#34;</span>)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">debug</span>(<span style="color:#e6db74">&#34;Testing for MessageChannel/postMessage in case of Firefox...&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// test for transferability of SharedArrayBuffer
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#75715e">// https://groups.google.com/forum/#!msg/mozilla.dev.platform/IHkBZlHETpA/dwsMNchWEQAJ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">MessageChannel</span>().<span style="color:#a6e22e">port1</span>.<span style="color:#a6e22e">postMessage</span>(<span style="color:#66d9ef">new</span> <span style="color:#a6e22e">SharedArrayBuffer</span>(<span style="color:#ae81ff">1</span>));
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">pthreadsSupported</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">pthreadsSupported</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">catch</span>(<span style="color:#a6e22e">ex</span>)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">debug</span>(<span style="color:#e6db74">`postMessage failed: </span><span style="color:#e6db74">${</span><span style="color:#a6e22e">ex</span><span style="color:#e6db74">}</span><span style="color:#e6db74">`</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">pthreadsSupported</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">debug</span>(<span style="color:#e6db74">`WASMT (WebAssembly with pthreads) supported: </span><span style="color:#e6db74">${</span><span style="color:#a6e22e">pthreadsSupported</span><span style="color:#e6db74">}</span><span style="color:#e6db74">`</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// fallback to the variant without pthreads
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">wasmURL</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">pthreadsSupported</span> <span style="color:#f92672">===</span> <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">?</span> <span style="color:#e6db74">&#34;./some-with-pthreads.js&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;./some-without-pthreads.js&#34;</span>;
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">debug</span>(<span style="color:#e6db74">`Variant to load: </span><span style="color:#e6db74">${</span><span style="color:#a6e22e">wasmURL</span><span style="color:#e6db74">}</span><span style="color:#e6db74">`</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">let</span> <span style="color:#a6e22e">scrpt</span> <span style="color:#f92672">=</span> document.<span style="color:#a6e22e">createElement</span>(<span style="color:#e6db74">&#34;script&#34;</span>);
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">scrpt</span>.<span style="color:#a6e22e">src</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">wasmURL</span>;
</span></span><span style="display:flex;"><span>document.<span style="color:#a6e22e">body</span>.<span style="color:#a6e22e">appendChild</span>(<span style="color:#a6e22e">scrpt</span>);</span></span></code></pre></div>
<p>Speaking about checking for available WebAssembly features in general, here are some more <a href="https://github.com/GoogleChromeLabs/wasm-feature-detect/tree/main/src/detectors">detectors</a> which you might want to use.</p>
<p>Now, to serve your application on localhost you can run <a href="https://github.com/retifrav/webassembly-pthreads-example/blob/master/server.py">this crude Python script</a> (<em>note that it expects to find certificate files in <code>./certificates/</code> and your web-application content in <code>./web/</code></em>):</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span>$ cd <span style="color:#f92672">/</span>path<span style="color:#f92672">/</span>to<span style="color:#f92672">/</span>webassembly<span style="color:#f92672">-</span>pthreads<span style="color:#f92672">-</span>example<span style="color:#f92672">/</span>
</span></span><span style="display:flex;"><span>$ python <span style="color:#f92672">./</span>server<span style="color:#f92672">.</span>py</span></span></code></pre></div>
<p>and open <a href="https://localhost:8000/">https://localhost:8000/</a> in your web-browser.</p>
<p>Here&rsquo;s how the program without pthreads will run:</p>







    <video  controls="yes"   class="video">
        <source src="/blog/2023/11/20/webassembly-with-pthreads/video/wasm-without-pthreads.mp4" type="video/mp4">
    </video>
    
    <p class="video-fallback">If video doesn’t play in your browser, you can download it <a href="/blog/2023/11/20/webassembly-with-pthreads/video/wasm-without-pthreads.mp4">here</a>.</p>
    


<p>So it prints to browser console as soon as there is new output, but it doesn&rsquo;t render to the page untill the very end. Not sure why is that, but there is a remedy for this in the pthreads-enabled variant.</p>
<p><span id="running-without-proxy-to-pthread">Running the program with pthreads will be like this at first</span>:</p>







    <video  controls="yes"   class="video">
        <source src="/blog/2023/11/20/webassembly-with-pthreads/video/wasm-with-pthreads-no-proxy-to-thread.mp4" type="video/mp4">
    </video>
    
    <p class="video-fallback">If video doesn’t play in your browser, you can download it <a href="/blog/2023/11/20/webassembly-with-pthreads/video/wasm-with-pthreads-no-proxy-to-thread.mp4">here</a>.</p>
    


<p>so it does render the initial output on the page, but then the output from the threads never shows up neither rendered on the page nor in the browser console. And that is what the <code>-sPROXY_TO_PTHREAD</code> linker flag <a href="https://emscripten.org/docs/porting/pthreads.html#additional-flags">is for</a>. After you add it and re-build the project, the output will show up:</p>







    <video  controls="yes"   class="video">
        <source src="/blog/2023/11/20/webassembly-with-pthreads/video/wasm-with-pthreads.mp4" type="video/mp4">
    </video>
    
    <p class="video-fallback">If video doesn’t play in your browser, you can download it <a href="/blog/2023/11/20/webassembly-with-pthreads/video/wasm-with-pthreads.mp4">here</a>.</p>
    


<p>So, as you can see, it runs just fine on Mac OS in Chromium. It runs in Firefox too, but Firefox being Firefox gets hysterical about fuck knows what:</p>


    <img class="image-post" loading="lazy" src="/blog/2023/11/20/webassembly-with-pthreads/images/firefox-hysterical-worker-csp.png" alt="Firefox being hysterical about worker-src">

<p>It also runs fine in desktop Safari and even in mobile Safari on iPhone:</p>







    <video  controls="yes"   class="video">
        <source src="/blog/2023/11/20/webassembly-with-pthreads/video/wasm-with-pthreads-safari-ios.mp4" type="video/mp4">
    </video>
    
    <p class="video-fallback">If video doesn’t play in your browser, you can download it <a href="/blog/2023/11/20/webassembly-with-pthreads/video/wasm-with-pthreads-safari-ios.mp4">here</a>.</p>
    


<p>On Windows in Microsoft Edge browser the parallelization looks strange:</p>







    <video  controls="yes"   class="video">
        <source src="/blog/2023/11/20/webassembly-with-pthreads/video/wasm-with-pthreads-edge.mp4" type="video/mp4">
    </video>
    
    <p class="video-fallback">If video doesn’t play in your browser, you can download it <a href="/blog/2023/11/20/webassembly-with-pthreads/video/wasm-with-pthreads-edge.mp4">here</a>.</p>
    


<p>You can see how the output from threads arrives not at the same time but with some delays. And it is like that in regular Edge and also in Edge Dev, and I tested them both in Windows ARM virtual machine and on actual Windows x64 desktop. At the same time, Firefox runs just fine in the same virtual and real Windows environments. So I don&rsquo;t know what&rsquo;s wrong with Edge.</p>
<p>Here are all the tested platforms and web-browsers:</p>
<ul>
<li>Mac OS 13.6.1 (<em>ARM / Apple silicon</em>):
<ul>
<li>Chromium: 117.0.5938.62;</li>
<li>Firefox Developer Edition: 120.0b9;</li>
<li>Safari: 17.1;</li>
</ul>
</li>
<li>iOS 17.1.1:
<ul>
<li>Safari 17.1;</li>
</ul>
</li>
<li>Ubuntu 22.04.3 (<em>ARM / Apple silicon, virtual machine</em>):
<ul>
<li>Firefox: 120.0;</li>
</ul>
</li>
<li>Windows 11 22H2 (<em>ARM / Apple silicon, virtual machine</em>):
<ul>
<li>Microsoft Edge 119.0.2151.58 (<em>runs in a strange way</em>);</li>
<li>Microsoft Edge Dev 121.0.2220.3 (<em>runs in a strange way</em>);</li>
<li>Firefox 119.0.1;</li>
</ul>
</li>
<li>Windows 11 21H2 (<em>x64</em>):
<ul>
<li>Microsoft Edge 119.0.2151.72 (<em>runs in a strange way</em>);</li>
<li>Microsoft Edge Dev 121.0.2220.3 (<em>runs in a strange way</em>);</li>
<li>Firefox Developer Edition 120.0b9.</li>
</ul>
</li>
</ul>
<p>The project was compiled into WebAssembly on each of those platforms (<em>except for iOS, of course</em>) prior to running it, although there was not real point in doing that, as the resulting binary is the same(?) across all the platforms. Still, it was interesting to check if all of those could be used as development hosts for compiling stuff into WebAssembly with Emscripten.</p>
      </div>
    </article>
    <div><div id="tags">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tag">
  <path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path><line x1="7" y1="7" x2="7" y2="7"></line>
</svg>
          <a class="tag" href="https://retifrav.github.io/tags/cpp/">Cpp</a><a class="tag" href="https://retifrav.github.io/tags/web/">Web</a><a class="tag" href="https://retifrav.github.io/tags/cmake/">Cmake</a></div><hr class="comments-divider"/>
      <div id="comments">
      
          <div style="border:2px orange solid; background-color: floralwhite; border-radius:0.5rem; padding: 10px 14px; font-style:italic; font-size:0.9em;">
              If you'd like to comment the article, you can do it on the
              <a href="https://decovar.dev/blog/2023/11/20/webassembly-with-pthreads/#remark42" style="font-weight:bold;">
                  original website</a>. This one is just a mirror without comments.
          </div>
      
      </div>
    </div>
  </div>

        <div id="footer">
          <div>
              2014 - 2024,
              <a href="/about/">retif</a>
          </div>
          <div><a href="/about/#licenses">CC BY-SA 4.0 / GPLv3</a></div>
        </div>
      </main>
      <div class="app-header">
        <div style="margin:0 0 20px;">
            <input id="search-query" placeholder="Search in titles and summaries" />
        </div>
        <div id="search-results" style="display:none;"></div>
        <div id="sidebars">
            <a id="avatar" href="/about"><img class="app-header-avatar" src="/images/avatar.png" /></a>
            <iframe src="https://github.com/sponsors/retifrav/button"
                height="35" style="border:0;"
                title="You can sponsor me">
            </iframe>
            
            <div class="sidebar-section">
              <h3>Feeds</h3>
              <a href="/index.xml" title="Subscribe to RSS"><img src="/images/rss.png" width="50px"></a>
              <a style="margin-left: 5px;" href="https://t.me/decovar" title="Telegram channel"><img src="/images/telegram.png" width="50px"></a>
            </div>
            <div id="telegramWidgetBlock" class="sidebar-section"></div>
            <div class="sidebar-section">
                <h3>Stuff</h3>
                <ul class="sidebar-list">
                    <li><a href="/stuff/kakoi-jvotne-vi-kysaiti/index.html">КАКОИ ЖВОТНЕ ВЫ КУСАИТИ?</a></li>
                </ul>
            </div>
            <div id="social-networks" class="sidebar-section">
              <h3>Social networks</h3>
              <div style="font-family:Courier New;">
                  Zuck: <i>Yeah so if you ever need info about anyone at Harvard</i><br/>
                  Zuck: <i>Just ask</i><br/>
                  Zuck: <i>I have over 4,000 emails, pictures, addresses, SNS</i><br/>
                  smb: <i>What? How'd you manage that one?</i><br/>
                  Zuck: <i>People just submitted it.</i><br/>
                  Zuck: <i>I don't know why.</i><br/>
                  Zuck: <i>They "trust me"</i><br/>
                  Zuck: <i>Dumb fucks</i>
              </div>
            </div>
            <div class="sidebar-section">
              <h3>Tags</h3>
              <ul style="list-style-type:none; padding:0; margin:0;">
                  
                  <li><a href="/tags/web">web (67)</a></li>
                  
                  <li><a href="/tags/fail">fail (40)</a></li>
                  
                  <li><a href="/tags/dotnet">dotnet (36)</a></li>
                  
                  <li><a href="/tags/qt">qt (35)</a></li>
                  
                  <li><a href="/tags/review">review (28)</a></li>
                  
                  <li><a href="/tags/linux">linux (27)</a></li>
                  
                  <li><a href="/tags/devops">devops (23)</a></li>
                  
                  <li><a href="/tags/macos">macos (23)</a></li>
                  
                  <li><a href="/tags/windows">windows (19)</a></li>
                  
                  <li><a href="/tags/mestuff">mestuff (17)</a></li>
                  
                  <li><a href="/tags/movies">movies (15)</a></li>
                  
                  <li><a href="/tags/tractor">tractor (15)</a></li>
                  
                  <li><a href="/tags/norway">norway (14)</a></li>
                  
                  <li><a href="/tags/cpp">cpp (12)</a></li>
                  
                  <li><a href="/tags/irl">irl (12)</a></li>
                  
                  <li><a href="/tags/python">python (12)</a></li>
                  
                  <li><a href="/tags/telegram">telegram (12)</a></li>
                  
                  <li><a href="/tags/cmake">cmake (11)</a></li>
                  
                  <li><a href="/tags/embedded">embedded (11)</a></li>
                  
                  <li><a href="/tags/soft">soft (10)</a></li>
                  
                  <li><a href="/tags/travel">travel (10)</a></li>
                  
                  <li><a href="/tags/applescript">applescript (9)</a></li>
                  
                  <li><a href="/tags/piracy">piracy (9)</a></li>
                  
                  <li><a href="/tags/octopress">octopress (8)</a></li>
                  
                  <li><a href="/tags/banks">banks (7)</a></li>
                  
                  <li><a href="/tags/games">games (7)</a></li>
                  
                  <li><a href="/tags/ios">ios (7)</a></li>
                  
                  <li><a href="/tags/apple">apple (6)</a></li>
                  
                  <li><a href="/tags/javascript">javascript (6)</a></li>
                  
                  <li><a href="/tags/photo">photo (6)</a></li>
                  
                  <li><a href="/tags/sql">sql (6)</a></li>
                  
                  <li><a href="/tags/russia">russia (5)</a></li>
                  
                  <li><a href="/tags/android">android (4)</a></li>
                  
                  <li><a href="/tags/hugo">hugo (4)</a></li>
                  
                  <li><a href="/tags/usa">usa (4)</a></li>
                  
                  <li><a href="/tags/wordpress">wordpress (4)</a></li>
                  
                  <li><a href="/tags/azure">azure (3)</a></li>
                  
                  <li><a href="/tags/tv">tv (3)</a></li>
                  
                  <li><a href="/tags/privacy">privacy (2)</a></li>
                  
                  <li><a href="/tags/steam-deck">steam-deck (2)</a></li>
                  
                  <li><a href="/tags/tvos">tvos (2)</a></li>
                  
                  <li><a href="/tags/unsolved">unsolved (2)</a></li>
                  
                  <li><a href="/tags/books">books (1)</a></li>
                  
                  <li><a href="/tags/ffmpeg">ffmpeg (1)</a></li>
                  
                  <li><a href="/tags/ldap">ldap (1)</a></li>
                  
                  <li><a href="/tags/music">music (1)</a></li>
                  
                  <li><a href="/tags/science">science (1)</a></li>
                  
                  <li><a href="/tags/vr">vr (1)</a></li>
                  
              </ul>
            </div>
        </div>
      </header>
    </div>

    <script src="/js/search.js"></script>

    
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-53340325-1"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag() { dataLayer.push(arguments); }
      gtag("js", new Date());
      gtag("config", "UA-53340325-1");
    </script>

    <script>
        const telegramBlock = document.getElementById("telegramWidgetBlock");
        window.onload = () =>
        {
            const pinnedTelegramPosts = [306,319,323]
            const randomedPostID = pinnedTelegramPosts[
                Math.floor(Math.random() * pinnedTelegramPosts.length)
            ];
            const telegramWidgetScript = document.createElement("script");
            telegramWidgetScript.src = "https://telegram.org/js/telegram-widget.js?21";
            telegramWidgetScript.dataset["telegramPost"] = `decovar/${randomedPostID}`;
            telegramWidgetScript.dataset["color"] = "1E8448";
            telegramWidgetScript.dataset["width"] = "100%";
            telegramWidgetScript.dataset["userpic"] = "false";
            telegramBlock.appendChild(telegramWidgetScript);
        }
    </script>

    
    
  </body>
</html>
