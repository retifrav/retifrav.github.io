<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>NuGet and npm packages in Azure DevOps Artifacts for a C&#43;&#43; library | Declaration of VAR</title>
    <link rel="canonical" href="https://decovar.dev/blog/2020/03/05/azure-devops-nuget-npm-cpp/" />

    <meta name="generator" content="Hugo 0.107.0" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <link href="/favicon.png" rel="icon">

    <meta name="author" content="retif" />
    <meta name="description" content="" />

    <link rel="alternate" type="application/rss+xml" href="/index.xml" title="Declaration of VAR" />

    <meta property="og:title" content="NuGet and npm packages in Azure DevOps Artifacts for a C&#43;&#43; library" />
<meta property="og:description" content="These days more and more developers are incapable of working with anything else but packages, as manually unpacking a ZIP archive and copying libraries with headers to the right places seems to them an impossible task.
But apart from said developers, using packages can indeed improve the development experience.


    

We distribute our C&#43;&#43; based SDK to many other teams, and for quite a some time they were asking us to do it exactly in packages (in particular, with NuGet and npm)." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://retifrav.github.io/blog/2020/03/05/azure-devops-nuget-npm-cpp/" /><meta property="article:section" content="blog" />
<meta property="article:published_time" content="2020-03-05T15:37:50+01:00" />
<meta property="article:modified_time" content="2020-03-05T15:37:50+01:00" />



    <link rel="stylesheet" href="https://retifrav.github.io/css/main.min.c1a9d5434fbba746ef09ebde219b0064b5d4318930fc8463f51550f13a0e1b54.css" />
    <link rel="stylesheet" href="/css/default.css" />
    <link rel="stylesheet" href="/css/post.css" />
    <link rel="stylesheet" href="/css/page.css" />
    <link rel="stylesheet" href="/css/comments.css" />

    <script src="/js/mark.js"></script>

    
    
  </head>
  <body>
    <div id="body-hat">
      <div id="title-block">
        <h1 id="blog-title"><a href="/">Declaration of VAR</a></h1>
        <p>and some other stuff</p>
      </div>
    </div>
    <div style="background-color:orange; padding:4px 16px; font-size:0.8em; text-align:center; font-style:italic;">
        On 19.05.2021 the website was moved to
        <a href="https://decovar.dev/blog/2020/03/05/azure-devops-nuget-npm-cpp/" style="color:black; font-weight:bold;">
            https://decovar.dev/</a>. This is just a mirror now.
    </div>
    <div id="body-flex">
      <main class="app-container">
        
  <div id="main-container">
    <article class="post">
      <header class="post-header">
        <h1 class ="post-title">NuGet and npm packages in Azure DevOps Artifacts for a C&#43;&#43; library</h1>
        <div class="post-meta">
          <div><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-calendar">
  <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line>
</svg> 2020-03-05 15:37:50 &#43;0100</div>
          <div><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-clock">
  <circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline>
</svg> 19 min read</div>
        </div>
      </header>
      <div class="post-content">
        <p>These days more and more developers are incapable of working with anything else but packages, as manually unpacking a ZIP archive and copying libraries with headers to the right places seems to them an impossible task.</p>
<p>But apart from said developers, using packages can indeed improve the development experience.</p>


    <img class="image-post" loading="lazy" src="/blog/2020/03/05/azure-devops-nuget-npm-cpp/images/azure-devops-packages.png" alt="Azure DevOps packages">

<p>We distribute our C++ based SDK to many other teams, and for quite a some time they were asking us to do it exactly in packages (<em>in particular, with <a href="https://www.nuget.org">NuGet</a> and <a href="https://www.npmjs.com">npm</a></em>).</p>
<p>At first we were reluctant to that, as, for example, using NuGet packages is certainly a far less universal way of distributing a library comparing to simple ZIP archives (<em>it might be shocking, but not everybody uses Visual Studio and MSBuild</em>). But finally we decided that it will be just better/easier to make everyone happy and to ship our stuff in whatever form they want, especially that it actually wouldn&rsquo;t be that much of an additional effort anyway.</p>
<p>Since we already have an <a href="https://azure.microsoft.com/en-us/services/devops/">Azure DevOps</a> subscription, it seemed like a good idea to host those packages in <a href="https://azure.microsoft.com/en-us/services/devops/artifacts/">Azure DevOps Artifacts</a>. That way we don&rsquo;t need to set-up internal hosting infrastructure and to take care of authorization. So the only thing we need to do is to start creating and publishing the actual packages.</p>
<p>I&rsquo;ll describe the process for Windows, but it shouldn&rsquo;t make much of a difference on other platforms (<em>especially for .NET Core and npm</em>).</p>
<nav id="TableOfContents">
  <ul>
    <li><a href="#c-library-project">C++ library project</a></li>
    <li><a href="#packages">Packages</a>
      <ul>
        <li><a href="#nuget">NuGet</a>
          <ul>
            <li><a href="#how-to-create-nuget-package">How to create NuGet package</a>
              <ul>
                <li><a href="#packing-nuget-package">Packing NuGet package</a></li>
                <li><a href="#azure-devops-feed">Azure DevOps feed</a></li>
                <li><a href="#publishing-nuget-package">Publishing NuGet package</a>
                  <ul>
                    <li><a href="#getting-pat-from-azure-artifacts-credential-provider">Getting PAT from Azure Artifacts Credential Provider</a></li>
                    <li><a href="#issuing-a-new-pat-in-azure-devops">Issuing a new PAT in Azure DevOps</a></li>
                  </ul>
                </li>
              </ul>
            </li>
            <li><a href="#how-to-use-nuget-package">How to use NuGet package</a></li>
          </ul>
        </li>
        <li><a href="#npm">npm</a>
          <ul>
            <li><a href="#how-to-create-npm-package">How to create npm package</a>
              <ul>
                <li><a href="#npm-cli-tool">npm CLI tool</a></li>
                <li><a href="#packing-npm-package">Packing npm package</a></li>
                <li><a href="#azure-devops-feed-1">Azure DevOps feed</a></li>
                <li><a href="#publishing-npm-package">Publishing npm package</a>
                  <ul>
                    <li><a href="#automatic-pat">Automatic PAT</a></li>
                    <li><a href="#manual-pat">Manual PAT</a></li>
                  </ul>
                </li>
              </ul>
            </li>
            <li><a href="#how-to-use-npm-package">How to use npm package</a></li>
          </ul>
        </li>
        <li><a href="#possible-issues">Possible issues</a>
          <ul>
            <li><a href="#npm---javascript-heap-out-of-memory">npm - JavaScript heap out of memory</a></li>
            <li><a href="#npm---the-request-must-contain-a-body">npm - The request must contain a body</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#resulting-feed">Resulting feed</a></li>
  </ul>
</nav>
<h1 id="c-library-project">C++ library project</h1>
<p>Let&rsquo;s create some simple C++ library, which we will then pack into packages.</p>
<p>With Visual Studio project as an example:</p>


    <img class="image-post" loading="lazy" src="/blog/2020/03/05/azure-devops-nuget-npm-cpp/images/vs-new-project-static-library.png" alt="Visual Studio, new project, static library">

<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#75715e">// somelib.h
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#pragma once
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">namespace</span> Some {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">doSomething</span>();
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#75715e">// somelib.cpp
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&#34;pch.h&#34;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&#34;framework.h&#34;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;iostream&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&#34;somelib.h&#34;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">namespace</span> Some {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">doSomething</span>()
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        std<span style="color:#f92672">::</span>cout <span style="color:#f92672">&lt;&lt;</span> <span style="color:#e6db74">&#34;Something from the library&#34;</span> <span style="color:#f92672">&lt;&lt;</span> std<span style="color:#f92672">::</span>endl;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div>
<p>Build it with both <code>Debug</code> and <code>Release</code> configurations for <code>x64</code> platform. You should get the following output:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span>somelib<span style="color:#f92672">/</span>build<span style="color:#f92672">/</span>x64<span style="color:#f92672">/</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">├──</span> <span style="color:#a6e22e">Debug</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">│</span>   <span style="color:#f92672">├──</span> pch<span style="color:#f92672">.</span>obj
</span></span><span style="display:flex;"><span><span style="color:#f92672">│</span>   <span style="color:#f92672">├──</span> somelib<span style="color:#f92672">.</span>idb
</span></span><span style="display:flex;"><span><span style="color:#f92672">│</span>   <span style="color:#f92672">├──</span> somelib<span style="color:#f92672">.</span>lib
</span></span><span style="display:flex;"><span><span style="color:#f92672">│</span>   <span style="color:#f92672">├──</span> somelib<span style="color:#f92672">.</span>obj
</span></span><span style="display:flex;"><span><span style="color:#f92672">│</span>   <span style="color:#f92672">├──</span> somelib<span style="color:#f92672">.</span>pch
</span></span><span style="display:flex;"><span><span style="color:#f92672">│</span>   <span style="color:#f92672">├──</span> somelib<span style="color:#f92672">.</span>pdb
</span></span><span style="display:flex;"><span><span style="color:#f92672">│</span>   <span style="color:#f92672">└──</span> <span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">└──</span> <span style="color:#a6e22e">Release</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">├──</span> pch<span style="color:#f92672">.</span>obj
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">├──</span> somelib<span style="color:#f92672">.</span>lib
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">├──</span> somelib<span style="color:#f92672">.</span>obj
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">├──</span> somelib<span style="color:#f92672">.</span>pch
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">├──</span> somelib<span style="color:#f92672">.</span>pdb
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">└──</span> <span style="color:#f92672">...</span></span></span></code></pre></div>
<h1 id="packages">Packages</h1>
<h2 id="nuget">NuGet</h2>
<p>NuGet package is pretty much the same thing as a ZIP archive, but with more strict internal structure and some additional meta-information for build systems (<em>MSBuild</em>).</p>
<h3 id="how-to-create-nuget-package">How to create NuGet package</h3>
<p>You&rsquo;ll need either <a href="https://www.nuget.org/downloads">NuGet</a> or <code>dotnet</code> from <a href="https://dotnet.microsoft.com/download">.NET Core</a>. Here I&rsquo;ll be using just NuGet.</p>
<h4 id="packing-nuget-package">Packing NuGet package</h4>
<p>Official documentation for creating NuGet packages in general can be found <a href="https://docs.microsoft.com/en-us/nuget/create-packages/creating-a-package">here</a>. And <a href="https://docs.microsoft.com/en-us/nuget/guides/native-packages">here</a> is the article for creating C++ (<code>native</code>) packages, although not a very detailed one, and actually I didn&rsquo;t exactly follow its instructions.</p>
<p>One great thing about having a NuGet package instead of a regular ZIP archive is that user (<em>developer</em>) can just install it and start using the library seamlessly. For that to work the project build system should know where the headers and corresponding library binaries are. And as I understood, for that you need to create a <code>.targets</code> file (<em><code>somename.somelib.targets</code> - must match the package ID from <code>.nuspec</code></em>):</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="color:#75715e">&lt;?xml version=&#34;1.0&#34; encoding=&#34;utf-8&#34;?&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;Project</span> <span style="color:#a6e22e">ToolsVersion=</span><span style="color:#e6db74">&#34;15.0&#34;</span> <span style="color:#a6e22e">xmlns=</span><span style="color:#e6db74">&#34;http://schemas.microsoft.com/developer/msbuild/2003&#34;</span><span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&lt;ItemDefinitionGroup</span> <span style="color:#a6e22e">Label=</span><span style="color:#e6db74">&#34;x64, debug&#34;</span> <span style="color:#a6e22e">Condition=</span><span style="color:#e6db74">&#34;&#39;$(Platform)&#39; == &#39;x64&#39; And $(Configuration.ToLower().IndexOf(&#39;debug&#39;)) &amp;gt; -1&#34;</span><span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;Link&gt;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">&lt;AdditionalDependencies</span> <span style="color:#a6e22e">Condition=</span><span style="color:#e6db74">&#34;&#39;$(Platform)&#39; == &#39;x64&#39;&#34;</span><span style="color:#f92672">&gt;</span>$(MSBuildThisFileDirectory)..\..\lib\native\x64\debug\*.lib;%(AdditionalDependencies)<span style="color:#f92672">&lt;/AdditionalDependencies&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;/Link&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;ClCompile&gt;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">&lt;AdditionalIncludeDirectories&gt;</span>$(MSBuildThisFileDirectory)include;%(AdditionalIncludeDirectories)<span style="color:#f92672">&lt;/AdditionalIncludeDirectories&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;/ClCompile&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&lt;/ItemDefinitionGroup&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&lt;ItemDefinitionGroup</span> <span style="color:#a6e22e">Label=</span><span style="color:#e6db74">&#34;x64, release&#34;</span> <span style="color:#a6e22e">Condition=</span><span style="color:#e6db74">&#34;&#39;$(Platform)&#39; == &#39;x64&#39; And $(Configuration.ToLower().IndexOf(&#39;debug&#39;)) == -1&#34;</span><span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;Link&gt;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">&lt;AdditionalDependencies</span> <span style="color:#a6e22e">Condition=</span><span style="color:#e6db74">&#34;&#39;$(Platform)&#39; == &#39;x64&#39;&#34;</span><span style="color:#f92672">&gt;</span>$(MSBuildThisFileDirectory)..\..\lib\native\x64\release\*.lib;%(AdditionalDependencies)<span style="color:#f92672">&lt;/AdditionalDependencies&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;/Link&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;ClCompile&gt;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">&lt;AdditionalIncludeDirectories&gt;</span>$(MSBuildThisFileDirectory)include;%(AdditionalIncludeDirectories)<span style="color:#f92672">&lt;/AdditionalIncludeDirectories&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;/ClCompile&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&lt;/ItemDefinitionGroup&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&lt;ItemGroup</span> <span style="color:#a6e22e">Condition=</span><span style="color:#e6db74">&#34;&#39;$(Platform)&#39; == &#39;x64&#39;&#34;</span><span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;ReferenceCopyLocalPaths</span> <span style="color:#a6e22e">Include=</span><span style="color:#e6db74">&#34;$(MSBuildThisFileDirectory)..\..\lib\native\x64\debug\*.lib&#34;</span> <span style="color:#f92672">/&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;ReferenceCopyLocalPaths</span> <span style="color:#a6e22e">Include=</span><span style="color:#e6db74">&#34;$(MSBuildThisFileDirectory)..\..\lib\native\x64\release\*.lib&#34;</span> <span style="color:#f92672">/&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&lt;/ItemGroup&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;/Project&gt;</span></span></span></code></pre></div>
<p>So here you are literally telling MSBuild where is what and for which configuration. This likely can be shortened/optimized, but it worked for me as it is. There are also more options like checking for the toolchain version and the way of linking, but I just don&rsquo;t have time (<em>and/or real need</em>) to investigate all of them. If you are feeling curious, I would recommend to inspect the <a href="https://www.nuget.org/packages/freeglut/">freeglut package</a> as its <code>freeglut.targets</code> has a very detailed collection of conditions.</p>
<p>Create a <a href="https://docs.microsoft.com/en-us/nuget/reference/nuspec">.nuspec</a> file (<code>somelib.nuspec</code>):</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="color:#75715e">&lt;?xml version=&#34;1.0&#34;?&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;package&gt;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">&lt;metadata&gt;</span>
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">&lt;id&gt;</span>somename.somelib<span style="color:#f92672">&lt;/id&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;title&gt;</span>Some library<span style="color:#f92672">&lt;/title&gt;</span>
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">&lt;version&gt;</span>2019.10.50826<span style="color:#f92672">&lt;/version&gt;</span>
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">&lt;description&gt;</span>Some simple library to test NuGet packages<span style="color:#f92672">&lt;/description&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;authors&gt;</span>YOUR NAME<span style="color:#f92672">&lt;/authors&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;projectUrl&gt;</span>http://your.website<span style="color:#f92672">&lt;/projectUrl&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;copyright&gt;</span>YOUR NAME<span style="color:#f92672">&lt;/copyright&gt;</span>
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">&lt;tags&gt;</span>native<span style="color:#f92672">&lt;/tags&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;dependencies&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&lt;group</span> <span style="color:#a6e22e">targetFramework=</span><span style="color:#e6db74">&#34;native&#34;</span><span style="color:#f92672">&gt;&lt;/group&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;/dependencies&gt;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">&lt;/metadata&gt;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">&lt;files&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;file</span> <span style="color:#a6e22e">src=</span><span style="color:#e6db74">&#34;lib\**&#34;</span> <span style="color:#a6e22e">target=</span><span style="color:#e6db74">&#34;lib&#34;</span> <span style="color:#f92672">/&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;file</span> <span style="color:#a6e22e">src=</span><span style="color:#e6db74">&#34;build\**&#34;</span> <span style="color:#a6e22e">target=</span><span style="color:#e6db74">&#34;build&#34;</span> <span style="color:#f92672">/&gt;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">&lt;/files&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;/package&gt;</span></span></span></code></pre></div>
<p>Without providing <code>&lt;dependencies&gt;</code> block with a group for <code>native</code> you&rsquo;ll get the following warning at packing step:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span><span style="color:#a6e22e">WARNING</span><span style="color:#66d9ef">:</span> <span style="color:#66d9ef">NU5128:</span> <span style="color:#66d9ef">Some</span> <span style="color:#66d9ef">target</span> <span style="color:#66d9ef">frameworks</span> <span style="color:#66d9ef">declared</span> <span style="color:#66d9ef">in</span> <span style="color:#66d9ef">the</span> <span style="color:#66d9ef">dependencies</span> <span style="color:#66d9ef">group</span> <span style="color:#66d9ef">of</span> <span style="color:#66d9ef">the</span> <span style="color:#66d9ef">nuspec</span> <span style="color:#66d9ef">and</span> <span style="color:#66d9ef">the</span> <span style="color:#66d9ef">lib/ref</span> <span style="color:#66d9ef">folder</span> <span style="color:#66d9ef">do</span> <span style="color:#66d9ef">not</span> <span style="color:#66d9ef">have</span> <span style="color:#66d9ef">exact</span> <span style="color:#66d9ef">matches</span> <span style="color:#66d9ef">in</span> <span style="color:#66d9ef">the</span> <span style="color:#66d9ef">other</span> <span style="color:#66d9ef">location.</span> <span style="color:#66d9ef">Consult</span> <span style="color:#66d9ef">the</span> <span style="color:#66d9ef">list</span> <span style="color:#66d9ef">of</span> <span style="color:#66d9ef">actions</span> <span style="color:#66d9ef">below:</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">-</span> <span style="color:#a6e22e">Add</span> a dependency group <span style="color:#66d9ef">for</span> native0<span style="color:#f92672">.</span><span style="color:#ae81ff">0</span> to the nuspec</span></span></code></pre></div>
<p>I don&rsquo;t know if it is important, but it&rsquo;s better not to have warnings, innit.</p>
<p>So now you have the following files:</p>
<ul>
<li><code>somename.somelib.targets</code></li>
<li><code>somelib.nuspec</code></li>
<li><a href="#c-library-project">your library</a> binaries and headers</li>
</ul>
<p>Take all that and put it into a new <code>package</code> folder like this:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span>package<span style="color:#f92672">/</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">├──</span> build
</span></span><span style="display:flex;"><span><span style="color:#f92672">│</span>   <span style="color:#f92672">└──</span> native
</span></span><span style="display:flex;"><span><span style="color:#f92672">│</span>       <span style="color:#f92672">├──</span> include
</span></span><span style="display:flex;"><span><span style="color:#f92672">│</span>       <span style="color:#f92672">│</span>   <span style="color:#f92672">└──</span> somelib<span style="color:#f92672">.</span>h
</span></span><span style="display:flex;"><span><span style="color:#f92672">│</span>       <span style="color:#f92672">└──</span> somename<span style="color:#f92672">.</span>somelib<span style="color:#f92672">.</span>targets
</span></span><span style="display:flex;"><span><span style="color:#f92672">├──</span> lib
</span></span><span style="display:flex;"><span><span style="color:#f92672">│</span>   <span style="color:#f92672">└──</span> native
</span></span><span style="display:flex;"><span><span style="color:#f92672">│</span>       <span style="color:#f92672">└──</span> x64
</span></span><span style="display:flex;"><span><span style="color:#f92672">│</span>           <span style="color:#f92672">├──</span> debug
</span></span><span style="display:flex;"><span><span style="color:#f92672">│</span>           <span style="color:#f92672">│</span>   <span style="color:#f92672">├──</span> pch<span style="color:#f92672">.</span>obj
</span></span><span style="display:flex;"><span><span style="color:#f92672">│</span>           <span style="color:#f92672">│</span>   <span style="color:#f92672">├──</span> somelib<span style="color:#f92672">.</span>idb
</span></span><span style="display:flex;"><span><span style="color:#f92672">│</span>           <span style="color:#f92672">│</span>   <span style="color:#f92672">├──</span> somelib<span style="color:#f92672">.</span>lib
</span></span><span style="display:flex;"><span><span style="color:#f92672">│</span>           <span style="color:#f92672">│</span>   <span style="color:#f92672">├──</span> somelib<span style="color:#f92672">.</span>obj
</span></span><span style="display:flex;"><span><span style="color:#f92672">│</span>           <span style="color:#f92672">│</span>   <span style="color:#f92672">├──</span> somelib<span style="color:#f92672">.</span>pch
</span></span><span style="display:flex;"><span><span style="color:#f92672">│</span>           <span style="color:#f92672">│</span>   <span style="color:#f92672">└──</span> somelib<span style="color:#f92672">.</span>pdb
</span></span><span style="display:flex;"><span><span style="color:#f92672">│</span>           <span style="color:#f92672">└──</span> release
</span></span><span style="display:flex;"><span><span style="color:#f92672">│</span>               <span style="color:#f92672">├──</span> pch<span style="color:#f92672">.</span>obj
</span></span><span style="display:flex;"><span><span style="color:#f92672">│</span>               <span style="color:#f92672">├──</span> somelib<span style="color:#f92672">.</span>lib
</span></span><span style="display:flex;"><span><span style="color:#f92672">│</span>               <span style="color:#f92672">├──</span> somelib<span style="color:#f92672">.</span>obj
</span></span><span style="display:flex;"><span><span style="color:#f92672">│</span>               <span style="color:#f92672">├──</span> somelib<span style="color:#f92672">.</span>pch
</span></span><span style="display:flex;"><span><span style="color:#f92672">│</span>               <span style="color:#f92672">└──</span> somelib<span style="color:#f92672">.</span>pdb
</span></span><span style="display:flex;"><span><span style="color:#f92672">└──</span> somelib<span style="color:#f92672">.</span>nuspec</span></span></code></pre></div>
<p>Apparently, folders structure and names are important and should follow certain convention. And for .NET targets you can find some <a href="https://docs.microsoft.com/en-us/nuget/create-packages/supporting-multiple-target-frameworks">documentation</a> on the matter. But I failed to find anything useful for C++ (<code>native</code>) targets, so I had to guess and check how other packages do it. By the way, that has proven to be quite useful - just go to NuGet, look for C++ packages using <a href="https://www.nuget.org/packages?q=tag%3Anative">tag:native</a> query and inspect their internals.</p>
<p>If you won&rsquo;t include some of these files: <code>.obj</code>, <code>.idb</code>, <code>.pdb</code> or <code>.pch</code> - you might get this error later:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>Error LNK1112 module machine type <span style="color:#e6db74">&#39;x86&#39;</span> conflicts with target machine type <span style="color:#e6db74">&#39;x64&#39;</span></span></span></code></pre></div>
<p>&hellip;even though both library and target applications are build for x64.</p>
<p>Or you can get an error about unresolved external symbol:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>Error LNK2019 unresolved external symbol <span style="color:#e6db74">&#34;void __cdecl Some::doSomething(void)&#34;</span> <span style="color:#f92672">(</span>?doSomething@Some@@YAXXZ<span style="color:#f92672">)</span> referenced in <span style="color:#66d9ef">function</span> main SomeApp</span></span></code></pre></div>
<p>Including those files resolved both errors for me, but what&rsquo;s weird is that after the error was resolved, I repacked the package without them, and the project built fine. So what was different the first time I added this package without them?</p>
<p>Anyway, pack the package:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ nuget pack somelib.nuspec -OutputDirectory /d/temp/out/
</span></span><span style="display:flex;"><span>Attempting to build package from <span style="color:#e6db74">&#39;somelib.nuspec&#39;</span>.
</span></span><span style="display:flex;"><span>Successfully created package <span style="color:#e6db74">&#39;D:/temp/out/somename.somelib.2019.10.50826.nupkg&#39;</span>.</span></span></code></pre></div>
<h4 id="azure-devops-feed">Azure DevOps feed</h4>
<p>Now you have your NuGet package. It is ready to be distributed and used, so you can send it to someone for them to test it in their project, or you can just as well do it yourself.</p>
<p>But it is better to publish it to some proper NuGet feed, and in our case it is Azure DevOps Artifacts (<em>although, of course any other compatible feed is fine too, including self-hosted ones</em>). Here&rsquo;s how a feed can be created there:</p>


    <img class="image-post" loading="lazy" src="/blog/2020/03/05/azure-devops-nuget-npm-cpp/images/azure-devops-create-feed.png" alt="Azure DevOps, creating feed">

<p>Connect to the feed using NuGet:</p>


    <img class="image-post" loading="lazy" src="/blog/2020/03/05/azure-devops-nuget-npm-cpp/images/azure-devops-connect-to-feed-nuget.png" alt="Azure DevOps, connecting to feed using NuGet">

<p>The <code>value</code> for <code>key</code> from <code>packageSources</code> is your feed URL.</p>
<h4 id="publishing-nuget-package">Publishing NuGet package</h4>
<p>Now you can publish the package to your feed. Microsoft has the following <a href="https://docs.microsoft.com/en-us/azure/devops/artifacts/nuget/publish?view=azure-devops">documentation</a> about that, from which you&rsquo;ll notice that you might need some mysterious-nowhere-to-find API key, but don&rsquo;t start spewing curses, as actually it is not really needed - just provide any value for the <code>-ApiKey</code> parameter (<em>for instance, just <code>key</code> is fine</em>).</p>
<p>For the actual publishing you&rsquo;ll need to provide an access token. Microsoft calls it <a href="https://docs.microsoft.com/en-us/azure/devops/organizations/accounts/use-personal-access-tokens-to-authenticate?view=azure-devops">personal access token</a> (<strong>PAT</strong>), and you can obtain it in 2 ways:</p>
<ul>
<li>by using Azure Artifacts Credential Provider</li>
<li>by issuing one manually</li>
</ul>
<h5 id="getting-pat-from-azure-artifacts-credential-provider">Getting PAT from Azure Artifacts Credential Provider</h5>
<p>Install <a href="https://github.com/microsoft/artifacts-credprovider#azure-artifacts-credential-provider">Azure Artifacts Credential Provider</a> (<em>follow &ldquo;Manual installation on Windows&rdquo; steps, for example</em>). Having installed it, you should have the following in your <code>~/.nuget</code> folder:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span><span style="color:#f92672">/</span>c<span style="color:#f92672">/</span><span style="color:#a6e22e">Users</span><span style="color:#f92672">/</span><span style="color:#a6e22e">YOUR</span><span style="color:#f92672">-</span><span style="color:#a6e22e">NAME</span><span style="color:#f92672">/.</span>nuget<span style="color:#f92672">/</span>plugins<span style="color:#f92672">/</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">├──</span> netcore
</span></span><span style="display:flex;"><span><span style="color:#f92672">│</span>   <span style="color:#f92672">└──</span> <span style="color:#a6e22e">CredentialProvider</span><span style="color:#f92672">.</span><span style="color:#a6e22e">Microsoft</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">└──</span> netfx
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">└──</span> <span style="color:#a6e22e">CredentialProvider</span><span style="color:#f92672">.</span><span style="color:#a6e22e">Microsoft</span></span></span></code></pre></div>
<p>When you&rsquo;ll run <code>nuget push</code>, you will get an authentication window:</p>


    <img class="image-post" loading="lazy" src="/blog/2020/03/05/azure-devops-nuget-npm-cpp/images/nuget-push-auth-window.png" alt="NuGet auth window">

<p>Enter your credentials (<em>from the Microsoft Azure DevOps account</em>), and a new PAT will be generated, and then the package will be published.</p>
<p>Here&rsquo;s the whole output:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ /e/tools/nuget/nuget.exe push -Source https://pkgs.dev.azure.com/ORGANIZATION-NAME/PROJECT-NAME/_packaging/FEED-NAME/nuget/v3/index.json -ApiKey <span style="color:#e6db74">&#34;key&#34;</span> somename.somelib.2019.10.50826.nupkg
</span></span><span style="display:flex;"><span>MSBuild auto-detection: using msbuild version <span style="color:#e6db74">&#39;16.4.0.56107&#39;</span> from <span style="color:#e6db74">&#39;E:\tools\vs\vs2019\MSBuild\Current\bin&#39;</span>.
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">[</span>CredentialProvider<span style="color:#f92672">]</span>VstsCredentialProvider - Acquired bearer token using <span style="color:#e6db74">&#39;ADAL UI&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">[</span>CredentialProvider<span style="color:#f92672">]</span>VstsCredentialProvider - Attempting to exchange the bearer token <span style="color:#66d9ef">for</span> an Azure DevOps session token.
</span></span><span style="display:flex;"><span>Pushing somename.somelib.2019.10.50826.nupkg to <span style="color:#e6db74">&#39;https://pkgs.dev.azure.com/ORGANIZATION-NAME/SOME-ID/_packaging/ANOTHER-ID/nuget/v2/&#39;</span>...
</span></span><span style="display:flex;"><span>  PUT https://pkgs.dev.azure.com/ORGANIZATION-NAME/SOME-ID/_packaging/ANOTHER-ID/nuget/v2/
</span></span><span style="display:flex;"><span>  Accepted https://pkgs.dev.azure.com/ORGANIZATION-NAME/SOME-ID/_packaging/ANOTHER-ID/nuget/v2/ 5178ms
</span></span><span style="display:flex;"><span>Your package was pushed.</span></span></code></pre></div>
<p>From now on all the new <code>nuget push</code> commands will work without showing this authentication dialog, as the new PAT is now saved locally on the machine.</p>
<p>You will also get the following e-mail:</p>


    <img class="image-post" loading="lazy" src="/blog/2020/03/05/azure-devops-nuget-npm-cpp/images/azure-devops-token-email.png" alt="Azure DevOps, package publish e-mail">

<p>Having opened the link, you&rsquo;ll be able to see the token&rsquo;s expiration date and the list of its scopes:</p>


    <img class="image-post" loading="lazy" src="/blog/2020/03/05/azure-devops-nuget-npm-cpp/images/azure-devops-token-scopes.png" alt="Azure DevOps, API token scopes">

<p>Sadly, you can&rsquo;t get the token value, so if you&rsquo;ll need to authorize NuGet on a different machine, you&rsquo;ll need to repeat the authorization procedure to generate a new PAT there.</p>
<h5 id="issuing-a-new-pat-in-azure-devops">Issuing a new PAT in Azure DevOps</h5>
<p>After I discovered this option, I can say that I like it much more than using Azure Artifacts Credential Provider.</p>
<p>Open <a href="https://docs.microsoft.com/en-us/azure/devops/organizations/accounts/use-personal-access-tokens-to-authenticate?view=azure-devops#create-a-pat">Personal Access Tokens</a> page and issue a new token. Select <code>Packaging</code> scope for it, <code>Read, write, &amp; manage</code>. The expiration is up to you, but you can&rsquo;t set it for longer than 1 year.</p>
<p>After clicking <code>Create</code> you&rsquo;ll get the token value - save it somewhere, as it&rsquo;s the last time you see it.</p>
<p>Okay, back to the publishing. If you run <code>nuget push</code> now (<em>without having Azure Artifacts Credential Provider installed</em>), it will ask you for inline credentials:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span>$ nuget push <span style="color:#f92672">-</span><span style="color:#a6e22e">Source</span> <span style="color:#e6db74">&#34;https://pkgs.dev.azure.com/ORGANIZATION-NAME/PROJECT-NAME/_packaging/FEED-NAME/nuget/v3/index.json&#34;</span> <span style="color:#f92672">-</span><span style="color:#a6e22e">ApiKey</span> <span style="color:#e6db74">&#34;key&#34;</span> myVR<span style="color:#f92672">.</span>mWriter2<span style="color:#f92672">.</span><span style="color:#ae81ff">0.0</span><span style="color:#f92672">.</span><span style="color:#ae81ff">53001.</span>nupkg
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">MSBuild</span> auto<span style="color:#f92672">-</span>detection<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">using</span> <span style="color:#66d9ef">msbuild</span> <span style="color:#66d9ef">version</span> <span style="color:#960050;background-color:#1e0010">&#39;14</span><span style="color:#66d9ef">.</span><span style="color:#960050;background-color:#1e0010">0</span><span style="color:#66d9ef">.</span><span style="color:#960050;background-color:#1e0010">25420</span><span style="color:#66d9ef">.</span><span style="color:#960050;background-color:#1e0010">1</span> <span style="color:#66d9ef">built</span> <span style="color:#66d9ef">by:</span> <span style="color:#66d9ef">D14REL</span><span style="color:#960050;background-color:#1e0010">&#39;</span> <span style="color:#66d9ef">from</span> <span style="color:#960050;background-color:#1e0010">&#39;</span><span style="color:#66d9ef">C:\Program</span> <span style="color:#66d9ef">Files</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">x86</span><span style="color:#f92672">)</span><span style="color:#66d9ef">\MSBuild\14.</span><span style="color:#960050;background-color:#1e0010">0</span><span style="color:#66d9ef">\Bin</span><span style="color:#960050;background-color:#1e0010">&#39;</span><span style="color:#66d9ef">.</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">Please</span> <span style="color:#66d9ef">provide</span> <span style="color:#66d9ef">credentials</span> <span style="color:#66d9ef">for:</span> <span style="color:#66d9ef">https://pkgs.dev.azure.com/ORGANIZATION-NAME/PROJECT-NAME/</span><span style="color:#66d9ef">_</span><span style="color:#66d9ef">packaging/FEED-NAME/nuget/v3/index.json</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">UserName</span><span style="color:#66d9ef">:</span></span></span></code></pre></div>
<p>And here I provided my Azure DevOps e-mail (<em>Office 365 account</em>) and used PAT as the password. But! Actually, it doesn&rsquo;t seem to care about <code>UserName</code>, so you can set any crazy value there, as it&rsquo;s only PAT what matters.</p>
<p>You can save your NuGet source and PAT locally, so you wound&rsquo;t need to enter them every time you push a new package:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span>$ nuget sources add <span style="color:#f92672">-</span><span style="color:#a6e22e">Name</span> <span style="color:#e6db74">&#34;SOME-NAME-FOR-YOUR-SOURCE&#34;</span> <span style="color:#f92672">-</span><span style="color:#a6e22e">Source</span> <span style="color:#e6db74">&#34;https://pkgs.dev.azure.com/ORGANIZATION-NAME/PROJECT-NAME/_packaging/FEED-NAME/nuget/v3/index.json&#34;</span> <span style="color:#f92672">-</span><span style="color:#a6e22e">Username</span> <span style="color:#e6db74">&#34;DOESNTMATTER&#34;</span> <span style="color:#f92672">-</span><span style="color:#a6e22e">Password</span> <span style="color:#e6db74">&#34;HERE-GOES-YOUR-PAT&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">Package</span> source <span style="color:#66d9ef">with</span> <span style="color:#a6e22e">Name</span><span style="color:#66d9ef">:</span> <span style="color:#66d9ef">SOME-NAME-FOR-YOUR-SOURCE</span> <span style="color:#66d9ef">added</span> <span style="color:#66d9ef">successfully.</span></span></span></code></pre></div>
<p>It will be saved to <code>C:\Users\YOUR-NAME\AppData\Roaming\NuGet\NuGet.Config</code>. That&rsquo;s important to note, as if you&rsquo;ll be using build agents from some CI/CD system such as TeamCity, they might not be able to find it, or rather they will use their own config: for example, my TeamCity agent runs as a <code>Local System</code>, and the config it uses is stored here: <code>C:\Windows\System32\config\systemprofile\AppData\Roaming\NuGet\NuGet.Config</code>.</p>
<p>You can check available NuGet sources:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-py" data-lang="py"><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">$</span> nuget sources list
</span></span><span style="display:flex;"><span>Registered Sources:
</span></span><span style="display:flex;"><span>    <span style="color:#ae81ff">1.</span>  nuget<span style="color:#f92672">.</span>org [Enabled]
</span></span><span style="display:flex;"><span>        https:<span style="color:#f92672">//</span>api<span style="color:#f92672">.</span>nuget<span style="color:#f92672">.</span>org<span style="color:#f92672">/</span>v3<span style="color:#f92672">/</span>index<span style="color:#f92672">.</span>json
</span></span><span style="display:flex;"><span>    <span style="color:#ae81ff">2.</span>  SOME<span style="color:#f92672">-</span>NAME<span style="color:#f92672">-</span>FOR<span style="color:#f92672">-</span>YOUR<span style="color:#f92672">-</span>SOURCE [Enabled]
</span></span><span style="display:flex;"><span>        https:<span style="color:#f92672">//</span>pkgs<span style="color:#f92672">.</span>dev<span style="color:#f92672">.</span>azure<span style="color:#f92672">.</span>com<span style="color:#f92672">/</span>ORGANIZATION<span style="color:#f92672">-</span>NAME<span style="color:#f92672">/</span>PROJECT<span style="color:#f92672">-</span>NAME<span style="color:#f92672">/</span>_packaging<span style="color:#f92672">/</span>FEED<span style="color:#f92672">-</span>NAME<span style="color:#f92672">/</span>nuget<span style="color:#f92672">/</span>v3<span style="color:#f92672">/</span>index<span style="color:#f92672">.</span>json
</span></span><span style="display:flex;"><span>    <span style="color:#ae81ff">3.</span>  Microsoft Visual Studio Offline Packages [Enabled]
</span></span><span style="display:flex;"><span>        C:\Program Files (x86)\Microsoft SDKs\NuGetPackages\</span></span></code></pre></div>
<p>Now you can publish like this:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span>$ nuget push <span style="color:#f92672">-</span><span style="color:#a6e22e">Source</span> <span style="color:#e6db74">&#34;SOME-NAME-FOR-YOUR-SOURCE&#34;</span> <span style="color:#f92672">-</span><span style="color:#a6e22e">ApiKey</span> <span style="color:#e6db74">&#34;key&#34;</span> somename<span style="color:#f92672">.</span>somelib<span style="color:#f92672">.</span><span style="color:#ae81ff">2019.10</span><span style="color:#f92672">.</span><span style="color:#ae81ff">50826.</span>nupkg</span></span></code></pre></div>
<p>Why do you still need to provide this meaningless <code>ApiKey</code>? Who the fuck knows, but without it you&rsquo;ll get the following error:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span><span style="color:#a6e22e">Response</span> status code does not indicate success<span style="color:#66d9ef">:</span> <span style="color:#960050;background-color:#1e0010">400</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">Bad</span> <span style="color:#66d9ef">Request</span> <span style="color:#66d9ef">-</span> <span style="color:#66d9ef">The</span> <span style="color:#66d9ef">request</span> <span style="color:#66d9ef">to</span> <span style="color:#66d9ef">the</span> <span style="color:#66d9ef">server</span> <span style="color:#66d9ef">did</span> <span style="color:#66d9ef">not</span> <span style="color:#66d9ef">include</span> <span style="color:#66d9ef">the</span> <span style="color:#66d9ef">header</span> <span style="color:#66d9ef">X-NuGet-ApiKey</span><span style="color:#f92672">,</span> <span style="color:#66d9ef">but</span> <span style="color:#66d9ef">it</span> <span style="color:#66d9ef">is</span> <span style="color:#66d9ef">required</span> <span style="color:#66d9ef">even</span> <span style="color:#66d9ef">though</span> <span style="color:#66d9ef">credentials</span> <span style="color:#66d9ef">were</span> <span style="color:#66d9ef">provided.</span> <span style="color:#66d9ef">If</span> <span style="color:#66d9ef">using</span> <span style="color:#66d9ef">NuGet.exe</span><span style="color:#f92672">,</span> use the <span style="color:#f92672">-</span><span style="color:#a6e22e">ApiKey</span> option to set <span style="color:#66d9ef">this</span> to an arbitrary value<span style="color:#f92672">,</span> <span style="color:#66d9ef">for</span> example <span style="color:#e6db74">&#34;-ApiKey AzureDevOps&#34;</span> <span style="color:#f92672">(</span><span style="color:#a6e22e">DevOps</span> <span style="color:#a6e22e">Activity</span> <span style="color:#a6e22e">ID</span><span style="color:#66d9ef">:</span> <span style="color:#66d9ef">L5DVGEDC-</span><span style="color:#960050;background-color:#1e0010">0</span><span style="color:#66d9ef">F5D-</span><span style="color:#960050;background-color:#1e0010">4</span><span style="color:#66d9ef">LD7-</span><span style="color:#960050;background-color:#1e0010">993</span><span style="color:#66d9ef">D-</span><span style="color:#960050;background-color:#1e0010">82355</span><span style="color:#66d9ef">D7B3DFB</span><span style="color:#f92672">)).</span></span></span></code></pre></div>
<p>What&rsquo;s more hilarious is that there is even a command for storing <code>ApiKey</code> in the NuGet config too:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span>$ nuget setapikey <span style="color:#e6db74">&#34;key&#34;</span> <span style="color:#f92672">-</span><span style="color:#a6e22e">Source</span> https<span style="color:#66d9ef">:</span><span style="color:#66d9ef">//pkgs.dev.azure.com/ORGANIZATION-NAME/PROJECT-NAME/</span><span style="color:#66d9ef">_</span><span style="color:#66d9ef">packaging/FEED-NAME/nuget/v3/index.json</span></span></span></code></pre></div>
<p>You might think, &ldquo;<em>here&rsquo;s where you can save the PAT and drop the Username and Password values, dumbo!</em>&rdquo;, but I can assure you that it&rsquo;s still not for PAT, as <code>nuget push</code> will still fail and will ask for credentials, so the <code>ApiKey</code> value really is meaningless.</p>
<p>Here&rsquo;s the full NuGet config now (<code>~/AppData/Roaming/NuGet/NuGet.Config</code>):</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="color:#75715e">&lt;?xml version=&#34;1.0&#34; encoding=&#34;utf-8&#34;?&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;configuration&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&lt;packageSources&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;add</span> <span style="color:#a6e22e">key=</span><span style="color:#e6db74">&#34;nuget.org&#34;</span> <span style="color:#a6e22e">value=</span><span style="color:#e6db74">&#34;https://api.nuget.org/v3/index.json&#34;</span> <span style="color:#a6e22e">protocolVersion=</span><span style="color:#e6db74">&#34;3&#34;</span> <span style="color:#f92672">/&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;add</span> <span style="color:#a6e22e">key=</span><span style="color:#e6db74">&#34;SOME-NAME-FOR-YOUR-SOURCE&#34;</span> <span style="color:#a6e22e">value=</span><span style="color:#e6db74">&#34;https://pkgs.dev.azure.com/ORGANIZATION-NAME/PROJECT-NAME/_packaging/FEED-NAME/nuget/v3/index.json&#34;</span> <span style="color:#f92672">/&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&lt;/packageSources&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&lt;disabledPackageSources&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;add</span> <span style="color:#a6e22e">key=</span><span style="color:#e6db74">&#34;Microsoft and .NET&#34;</span> <span style="color:#a6e22e">value=</span><span style="color:#e6db74">&#34;true&#34;</span> <span style="color:#f92672">/&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&lt;/disabledPackageSources&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&lt;packageSourceCredentials&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;SOME-NAME-FOR-YOUR-SOURCE&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;add</span> <span style="color:#a6e22e">key=</span><span style="color:#e6db74">&#34;Username&#34;</span> <span style="color:#a6e22e">value=</span><span style="color:#e6db74">&#34;DOESNTMATTER&#34;</span> <span style="color:#f92672">/&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;add</span> <span style="color:#a6e22e">key=</span><span style="color:#e6db74">&#34;Password&#34;</span> <span style="color:#a6e22e">value=</span><span style="color:#e6db74">&#34;ENCODED-VALUE-OF-YOUR-PAT&#34;</span> <span style="color:#f92672">/&gt;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">&lt;/SOME-NAME-FOR-YOUR-SOURCE&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&lt;/packageSourceCredentials&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&lt;apikeys&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;add</span> <span style="color:#a6e22e">key=</span><span style="color:#e6db74">&#34;https://pkgs.dev.azure.com/ORGANIZATION-NAME/PROJECT-NAME/_packaging/FEED-NAME/nuget/v3/index.json&#34;</span> <span style="color:#a6e22e">value=</span><span style="color:#e6db74">&#34;ENCODED-VALUE-FOR-JUST-THIS-SILLY-KEY&#34;</span> <span style="color:#f92672">/&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&lt;/apikeys&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;/configuration&gt;</span></span></span></code></pre></div>
<p>And now you can publish without providing <code>ApiKey</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span>$ nuget push <span style="color:#f92672">-</span><span style="color:#a6e22e">Source</span> <span style="color:#e6db74">&#34;SOME-NAME-FOR-YOUR-SOURCE&#34;</span> somename<span style="color:#f92672">.</span>somelib<span style="color:#f92672">.</span><span style="color:#ae81ff">2019.10</span><span style="color:#f92672">.</span><span style="color:#ae81ff">50826.</span>nupkg</span></span></code></pre></div>
<p>When you&rsquo;ll need to update the PAT, there is a command for that too:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span>$ nuget sources update <span style="color:#f92672">-</span><span style="color:#a6e22e">Name</span> <span style="color:#e6db74">&#34;SOME-NAME-FOR-YOUR-SOURCE&#34;</span> <span style="color:#f92672">-</span><span style="color:#a6e22e">Username</span> <span style="color:#e6db74">&#34;DOESNTMATTER&#34;</span> <span style="color:#f92672">-</span><span style="color:#a6e22e">Password</span> <span style="color:#e6db74">&#34;HERE-GOES-YOUR-NEW-PAT&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">Package</span> source <span style="color:#e6db74">&#34;SOME-NAME-FOR-YOUR-SOURCE&#34;</span> was successfully updated<span style="color:#f92672">.</span></span></span></code></pre></div>
<h3 id="how-to-use-nuget-package">How to use NuGet package</h3>
<p>In case of NuGet packages for C++ development, the main consumers are those using Visual Studio and MSBuild. So let&rsquo;s see how it works for a Visual Studio C++ project.</p>
<p>Create a simple C++ console application (<em>let&rsquo;s call it <code>TestApp</code></em>) and add a new NuGet source using your feed URL:</p>


    <img class="image-post" loading="lazy" src="/blog/2020/03/05/azure-devops-nuget-npm-cpp/images/vs-nuget-sources.png" alt="Visual Studio, NuGet source">

<p>Now you will be able to discover and install <code>somename.somelib</code> package from your Azure DevOps packages feed:</p>


    <img class="image-post" loading="lazy" src="/blog/2020/03/05/azure-devops-nuget-npm-cpp/images/vs-nuget-packages.png" alt="Visual Studio, installing NuGet package">

<p>Awesome, right?</p>
<p>Having installed the package, you should get the following structure in your project directory:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span><span style="color:#a6e22e">TestApp</span><span style="color:#f92672">/</span>packages
</span></span><span style="display:flex;"><span><span style="color:#f92672">└──</span> somename<span style="color:#f92672">.</span>somelib<span style="color:#f92672">.</span><span style="color:#ae81ff">2019.10</span><span style="color:#f92672">.</span><span style="color:#ae81ff">50826</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">├──</span> build
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">│</span>   <span style="color:#f92672">└──</span> native
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">│</span>       <span style="color:#f92672">├──</span> include
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">│</span>       <span style="color:#f92672">│</span>   <span style="color:#f92672">└──</span> somelib<span style="color:#f92672">.</span>h
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">│</span>       <span style="color:#f92672">└──</span> somename<span style="color:#f92672">.</span>somelib<span style="color:#f92672">.</span>targets
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">├──</span> lib
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">│</span>   <span style="color:#f92672">└──</span> native
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">│</span>       <span style="color:#f92672">└──</span> x64
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">│</span>           <span style="color:#f92672">├──</span> debug
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">│</span>           <span style="color:#f92672">│</span>   <span style="color:#f92672">├──</span> pch<span style="color:#f92672">.</span>obj
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">│</span>           <span style="color:#f92672">│</span>   <span style="color:#f92672">├──</span> somelib<span style="color:#f92672">.</span>idb
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">│</span>           <span style="color:#f92672">│</span>   <span style="color:#f92672">├──</span> somelib<span style="color:#f92672">.</span>lib
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">│</span>           <span style="color:#f92672">│</span>   <span style="color:#f92672">├──</span> somelib<span style="color:#f92672">.</span>obj
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">│</span>           <span style="color:#f92672">│</span>   <span style="color:#f92672">├──</span> somelib<span style="color:#f92672">.</span>pch
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">│</span>           <span style="color:#f92672">│</span>   <span style="color:#f92672">└──</span> somelib<span style="color:#f92672">.</span>pdb
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">│</span>           <span style="color:#f92672">└──</span> release
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">│</span>               <span style="color:#f92672">├──</span> pch<span style="color:#f92672">.</span>obj
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">│</span>               <span style="color:#f92672">├──</span> somelib<span style="color:#f92672">.</span>lib
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">│</span>               <span style="color:#f92672">├──</span> somelib<span style="color:#f92672">.</span>obj
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">│</span>               <span style="color:#f92672">├──</span> somelib<span style="color:#f92672">.</span>pch
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">│</span>               <span style="color:#f92672">└──</span> somelib<span style="color:#f92672">.</span>pdb
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">└──</span> somename<span style="color:#f92672">.</span>somelib<span style="color:#f92672">.</span><span style="color:#ae81ff">2019.10</span><span style="color:#f92672">.</span><span style="color:#ae81ff">50826.</span>nupkg</span></span></code></pre></div>
<p>If it was packed correctly, you should be able to include the header file without providing the full path to it and to call a method from the library:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;iostream&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// no need to do that
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//#include &#34;packages/somename.somelib.2019.10.50826/include/somelib.h&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// just include the file
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#75715e">#include</span> <span style="color:#75715e">&#34;somelib.h&#34;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>()
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    std<span style="color:#f92672">::</span>cout <span style="color:#f92672">&lt;&lt;</span> <span style="color:#e6db74">&#34;ololo&#34;</span> <span style="color:#f92672">&lt;&lt;</span> std<span style="color:#f92672">::</span>endl;
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// here we call a method from the library
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    Some<span style="color:#f92672">::</span>doSomething();
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div>
<p>Building and running the project outputs the following:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span>$ <span style="color:#a6e22e">TestApp</span><span style="color:#f92672">/</span>x64<span style="color:#f92672">/</span><span style="color:#a6e22e">Debug</span><span style="color:#f92672">/</span><span style="color:#a6e22e">TestApp</span><span style="color:#f92672">.</span>exe
</span></span><span style="display:flex;"><span>ololo
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">Something</span> from the library</span></span></code></pre></div>
<p>So the library has been successfully discovered and linked from the package.</p>
<h2 id="npm">npm</h2>
<p>Like <a href="#nuget">NuGet</a> packages, npm packages are basically just archives. But unlike NuGet packages, they don&rsquo;t require strict folder structure, specific file names and also they don&rsquo;t seem to have any meta information for build systems. Shortly saying, they are considerably easier to create.</p>
<p>The obvious downside here is that in case of C++ projects your build system is unlikely to know anything about libraries installed via npm, so I personally see very little to none point in using npm for C++ projects.</p>
<h3 id="how-to-create-npm-package">How to create npm package</h3>
<h4 id="npm-cli-tool">npm CLI tool</h4>
<p>Install <a href="https://nodejs.org/en/download/">Node.js</a> (<em>omg, I can&rsquo;t believe I actually said that</em>). From that installation you will only need <code>npm</code> tool.</p>
<p>Install authentication tools:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ npm install -g vsts-npm-auth --registry https://registry.npmjs.com --always-auth false</span></span></code></pre></div>
<h4 id="packing-npm-package">Packing npm package</h4>
<p>The only thing you need is a <code>package.json</code> file - that&rsquo;s where you describe the package, so the package feed/registry (<em>Azure DevOps in our case</em>) would know something about it.</p>
<p>Copy <a href="#c-library-project">your library</a> headers and binaries to some new <code>package</code> folder. Like I said, folder structure doesn&rsquo;t matter, but still it would be nice towards your users to follow some common practice, for example:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span>package<span style="color:#f92672">/</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">├──</span> include
</span></span><span style="display:flex;"><span><span style="color:#f92672">│</span>   <span style="color:#f92672">└──</span> somelib<span style="color:#f92672">.</span>h
</span></span><span style="display:flex;"><span><span style="color:#f92672">└──</span> lib
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">└──</span> msvc141
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">└──</span> x64
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">├──</span> debug
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">│</span>   <span style="color:#f92672">├──</span> pch<span style="color:#f92672">.</span>obj
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">│</span>   <span style="color:#f92672">├──</span> somelib<span style="color:#f92672">.</span>idb
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">│</span>   <span style="color:#f92672">├──</span> somelib<span style="color:#f92672">.</span>lib
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">│</span>   <span style="color:#f92672">├──</span> somelib<span style="color:#f92672">.</span>obj
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">│</span>   <span style="color:#f92672">├──</span> somelib<span style="color:#f92672">.</span>pch
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">│</span>   <span style="color:#f92672">└──</span> somelib<span style="color:#f92672">.</span>pdb
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">└──</span> release
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">├──</span> pch<span style="color:#f92672">.</span>obj
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">├──</span> somelib<span style="color:#f92672">.</span>lib
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">├──</span> somelib<span style="color:#f92672">.</span>obj
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">├──</span> somelib<span style="color:#f92672">.</span>pch
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">└──</span> somelib<span style="color:#f92672">.</span>pdb</span></span></code></pre></div>
<p>Go to this folder and initialize the package:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span>$ npm init <span style="color:#f92672">--</span>scope<span style="color:#f92672">=@</span><span style="color:#a6e22e">YOUR</span><span style="color:#f92672">-</span><span style="color:#a6e22e">ORGANIZATION</span></span></span></code></pre></div>
<p>The <code>--scope</code> parameter makes your package to be part of a specific namespace. Using it for all your other packages will keep them in a separate <code>@YOUR-ORGANIZATION</code> folder in your users projects.</p>
<p>The initialization command will ask you for various things like name, version, license and others, out of which only name and version really matter. Based on all that information provided, it will generate a <code>package.json</code> file.</p>
<p>Having inspected it, I didn&rsquo;t get the point of certain items there, like <code>main</code>, <code>directories</code>, <code>scripts</code> and <code>license</code> (<em>because we will have a custom license</em>), so I just removed them. Here&rsquo;s my <code>package.json</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;name&#34;</span>: <span style="color:#e6db74">&#34;@YOUR-ORGANIZATION/somelib&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;version&#34;</span>: <span style="color:#e6db74">&#34;2020.3.50904&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;description&#34;</span>: <span style="color:#e6db74">&#34;Some library to test npm packages&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;author&#34;</span>: <span style="color:#e6db74">&#34;YOUR-ORGANIZATION&#34;</span>
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div>
<p>Note that here you can&rsquo;t provide <code>2020.03.50904</code> as the package version, because it has to be <code>2020.3.50904</code> - without leading <code>0</code>.</p>
<p>That&rsquo;s it, no other actions are required, this folder with <code>package.json</code> is already a package. It will be packed into an archive later, on <a href="#publishing-npm-package">publishing step</a>.</p>
<p>I would, however, recommend adding a <a href="https://docs.npmjs.com/about-package-readme-files">README.md</a> file too, because it will be used by the Azure DevOps feed to display information about your package.</p>
<h4 id="azure-devops-feed-1">Azure DevOps feed</h4>
<p>The Azure DevOps feed creation is <a href="#azure-devops-feed">the same</a> as for NuGet packages. Moreover, you can use the same feed for publishing both NuGet and npm packages.</p>
<p>The only difference here is the connecting procedure:</p>


    <img class="image-post" loading="lazy" src="/blog/2020/03/05/azure-devops-nuget-npm-cpp/images/azure-devops-connect-to-feed-npm.png" alt="Azure DevOps, connecting to feed using npm">

<p>Add a <code>.npmrc</code> to <a href="#packing-npm-package">your package</a> (<em>in the same directory with <code>package.json</code></em>):</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ini" data-lang="ini"><span style="display:flex;"><span><span style="color:#a6e22e">registry</span><span style="color:#f92672">=</span><span style="color:#e6db74">https://pkgs.dev.azure.com/ORGANIZATION-NAME/PROJECT-NAME/_packaging/FEED-NAME/npm/registry/</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">always-auth</span><span style="color:#f92672">=</span><span style="color:#e6db74">true</span></span></span></code></pre></div>
<p>So now your package directory looks like this:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span>package<span style="color:#f92672">/</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">├──</span> <span style="color:#f92672">.</span>npmrc
</span></span><span style="display:flex;"><span><span style="color:#f92672">├──</span> include
</span></span><span style="display:flex;"><span><span style="color:#f92672">│</span>   <span style="color:#f92672">└──</span> somelib<span style="color:#f92672">.</span>h
</span></span><span style="display:flex;"><span><span style="color:#f92672">├──</span> lib
</span></span><span style="display:flex;"><span><span style="color:#f92672">│</span>   <span style="color:#f92672">└──</span> msvc141
</span></span><span style="display:flex;"><span><span style="color:#f92672">│</span>       <span style="color:#f92672">└──</span> x64
</span></span><span style="display:flex;"><span><span style="color:#f92672">│</span>           <span style="color:#f92672">├──</span> debug
</span></span><span style="display:flex;"><span><span style="color:#f92672">│</span>           <span style="color:#f92672">│</span>   <span style="color:#f92672">├──</span> pch<span style="color:#f92672">.</span>obj
</span></span><span style="display:flex;"><span><span style="color:#f92672">│</span>           <span style="color:#f92672">│</span>   <span style="color:#f92672">├──</span> somelib<span style="color:#f92672">.</span>idb
</span></span><span style="display:flex;"><span><span style="color:#f92672">│</span>           <span style="color:#f92672">│</span>   <span style="color:#f92672">├──</span> somelib<span style="color:#f92672">.</span>lib
</span></span><span style="display:flex;"><span><span style="color:#f92672">│</span>           <span style="color:#f92672">│</span>   <span style="color:#f92672">├──</span> somelib<span style="color:#f92672">.</span>obj
</span></span><span style="display:flex;"><span><span style="color:#f92672">│</span>           <span style="color:#f92672">│</span>   <span style="color:#f92672">├──</span> somelib<span style="color:#f92672">.</span>pch
</span></span><span style="display:flex;"><span><span style="color:#f92672">│</span>           <span style="color:#f92672">│</span>   <span style="color:#f92672">└──</span> somelib<span style="color:#f92672">.</span>pdb
</span></span><span style="display:flex;"><span><span style="color:#f92672">│</span>           <span style="color:#f92672">└──</span> release
</span></span><span style="display:flex;"><span><span style="color:#f92672">│</span>               <span style="color:#f92672">├──</span> pch<span style="color:#f92672">.</span>obj
</span></span><span style="display:flex;"><span><span style="color:#f92672">│</span>               <span style="color:#f92672">├──</span> somelib<span style="color:#f92672">.</span>lib
</span></span><span style="display:flex;"><span><span style="color:#f92672">│</span>               <span style="color:#f92672">├──</span> somelib<span style="color:#f92672">.</span>obj
</span></span><span style="display:flex;"><span><span style="color:#f92672">│</span>               <span style="color:#f92672">├──</span> somelib<span style="color:#f92672">.</span>pch
</span></span><span style="display:flex;"><span><span style="color:#f92672">│</span>               <span style="color:#f92672">└──</span> somelib<span style="color:#f92672">.</span>pdb
</span></span><span style="display:flex;"><span><span style="color:#f92672">└──</span> package<span style="color:#f92672">.</span>json</span></span></code></pre></div>
<h4 id="publishing-npm-package">Publishing npm package</h4>
<p>Almost like with <a href="#publishing-nuget-package">NuGet package</a>, you can get a PAT issued for you or you can issue one yourself.</p>
<h5 id="automatic-pat">Automatic PAT</h5>
<p>Run <code>vsts-npm-auth</code> in the package folder to get an Azure Artifacts access token:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ vsts-npm-auth -config .npmrc</span></span></code></pre></div>
<p>That will show an authentication dialog, where you&rsquo;ll need to login with your Azure DevOps account. It will generate an access token and will put it into <code>C:\Users\YOUR-NAME\.npmrc</code>, so it will be global for all the projects and you won&rsquo;t need to run this command every time.</p>
<h5 id="manual-pat">Manual PAT</h5>
<p><a href="#issuing-a-new-pat-in-azure-devops">Issue a new PAT</a> or just reuse the one you already have. Encode it to Base64, for example using the very same Node (<em>or <a href="https://github.com/retifrav/scraps/blob/master/_Linux/linux.md#encode">some other way</a></em>):</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span>$ node <span style="color:#f92672">-</span>e <span style="color:#e6db74">&#34;require(&#39;readline&#39;) .createInterface({input:process.stdin,output:process.stdout,historySize:0}) .question(&#39;PAT&gt; &#39;,p =&gt; { b64=Buffer.from(p.trim()).toString(&#39;base64&#39;);console.log(b64);process.exit(); })&#34;</span></span></span></code></pre></div>
<p>Create an <code>.npmrc</code> in your home folder with the following contents:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ini" data-lang="ini"><span style="display:flex;"><span><span style="color:#75715e">; begin auth token</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">//pkgs.dev.azure.com/YOUR-ORGANIZATION/SOME-ID/_packaging/PROJECT-NAME/npm/registry/:username</span><span style="color:#f92672">=</span><span style="color:#e6db74">YOUR-ORGANIZATION-OR-DOESNTMATTER</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">//pkgs.dev.azure.com/YOUR-ORGANIZATION/SOME-ID/_packaging/PROJECT-NAME/npm/registry/:_password</span><span style="color:#f92672">=</span><span style="color:#e6db74">YOUR-BASE64-PAT</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">//pkgs.dev.azure.com/YOUR-ORGANIZATION/SOME-ID/_packaging/PROJECT-NAME/npm/registry/:email</span><span style="color:#f92672">=</span><span style="color:#e6db74">npm requires email to be set but doesn&#39;t use the value</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">//pkgs.dev.azure.com/YOUR-ORGANIZATION/SOME-ID/_packaging/PROJECT-NAME/npm/:username</span><span style="color:#f92672">=</span><span style="color:#e6db74">YOUR-ORGANIZATION-OR-DOESNTMATTER</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">//pkgs.dev.azure.com/YOUR-ORGANIZATION/SOME-ID/_packaging/PROJECT-NAME/npm/:_password</span><span style="color:#f92672">=</span><span style="color:#e6db74">YOUR-BASE64-PAT</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">//pkgs.dev.azure.com/YOUR-ORGANIZATION/SOME-ID/_packaging/PROJECT-NAME/npm/:email</span><span style="color:#f92672">=</span><span style="color:#e6db74">npm requires email to be set but doesn&#39;t use the value</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">; end auth token</span></span></span></code></pre></div>
<p>In case of a buildbot you might want to put this <code>.npmrc</code> file not to your user home folder but to some shared path in the system.</p>
<p>Finally, publish the package:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ npm --userconfig<span style="color:#f92672">=</span>/path/to/where/you/have/the/pat/.npmrc publish
</span></span><span style="display:flex;"><span>npm notice
</span></span><span style="display:flex;"><span>npm notice package: @YOUR-ORGANIZATION/somelib@2020.3.50904
</span></span><span style="display:flex;"><span>npm notice <span style="color:#f92672">===</span> Tarball Contents <span style="color:#f92672">===</span>
</span></span><span style="display:flex;"><span>npm notice 60B     include/somelib.h
</span></span><span style="display:flex;"><span>npm notice 142.3kB lib/msvc141/x64/debug/somelib.idb
</span></span><span style="display:flex;"><span>npm notice 146B    package.json
</span></span><span style="display:flex;"><span>npm notice 61.4kB  lib/msvc141/x64/debug/somelib.lib
</span></span><span style="display:flex;"><span>npm notice 928.2kB lib/msvc141/x64/release/somelib.lib
</span></span><span style="display:flex;"><span>npm notice 2.2kB   lib/msvc141/x64/debug/pch.obj
</span></span><span style="display:flex;"><span>npm notice 2.9kB   lib/msvc141/x64/release/pch.obj
</span></span><span style="display:flex;"><span>npm notice 57.0kB  lib/msvc141/x64/debug/somelib.obj
</span></span><span style="display:flex;"><span>npm notice 923.2kB lib/msvc141/x64/release/somelib.obj
</span></span><span style="display:flex;"><span>npm notice 2.0MB   lib/msvc141/x64/debug/somelib.pch
</span></span><span style="display:flex;"><span>npm notice 2.0MB   lib/msvc141/x64/release/somelib.pch
</span></span><span style="display:flex;"><span>npm notice 389.1kB lib/msvc141/x64/debug/somelib.pdb
</span></span><span style="display:flex;"><span>npm notice 380.9kB lib/msvc141/x64/release/somelib.pdb
</span></span><span style="display:flex;"><span>npm notice <span style="color:#f92672">===</span> Tarball Details <span style="color:#f92672">===</span>
</span></span><span style="display:flex;"><span>npm notice name:          @YOUR-ORGANIZATION/somelib
</span></span><span style="display:flex;"><span>npm notice version:       2020.3.50904
</span></span><span style="display:flex;"><span>npm notice package size:  825.2 kB
</span></span><span style="display:flex;"><span>npm notice unpacked size: 7.0 MB
</span></span><span style="display:flex;"><span>npm notice shasum:        SOME-HASH
</span></span><span style="display:flex;"><span>npm notice integrity:     sha512-VALUE<span style="color:#f92672">==</span>
</span></span><span style="display:flex;"><span>npm notice total files:   <span style="color:#ae81ff">13</span>
</span></span><span style="display:flex;"><span>npm notice
</span></span><span style="display:flex;"><span>+ @YOUR-ORGANIZATION/somelib@2020.3.50904</span></span></code></pre></div>
<h3 id="how-to-use-npm-package">How to use npm package</h3>
<p>Since there is no build system involved, installing an npm package simply downloads and unpacks the archive.</p>
<p>Connect to the feed by adding almost <a href="#azure-devops-feed-1">the same</a> <code>.npmrc</code> in the project directory. Here&rsquo;s how it should look like:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ini" data-lang="ini"><span style="display:flex;"><span><span style="color:#a6e22e">@YOUR-ORGANIZATION:registry</span><span style="color:#f92672">=</span><span style="color:#e6db74">https://pkgs.dev.azure.com/ORGANIZATION-NAME/PROJECT-NAME/_packaging/FEED-NAME/npm/registry/</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">always-auth</span><span style="color:#f92672">=</span><span style="color:#e6db74">true</span></span></span></code></pre></div>
<p>Note this <code>@YOUR-ORGANIZATION:</code> (<em>your scope</em>) thing prepending the feed. Without it npm will look for <strong>all the packages</strong> in this feed, while most likely you&rsquo;d want npm to use it only for your packages. So basically without specifying the scope you are overriding npm&rsquo;s default feed - which is what happened to me, and while npm documentation doesn&rsquo;t seem to mention this explicitly, I found it in a casual example of <a href="https://docs.npmjs.com/cli/v6/configuring-npm/npmrc#comments">adding comments</a>.</p>
<p>Now run:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span>npm install <span style="color:#a6e22e">@YOUR</span><span style="color:#f92672">-</span><span style="color:#a6e22e">ORGANIZATION</span><span style="color:#f92672">/</span>somelib<span style="color:#66d9ef">@</span><span style="color:#ae81ff">2020.3</span><span style="color:#f92672">.</span><span style="color:#ae81ff">50904</span></span></span></code></pre></div>
<p>After that your project directory will look like this:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span>test<span style="color:#f92672">-</span>proj<span style="color:#f92672">/</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">├──</span> <span style="color:#f92672">.</span>npmrc
</span></span><span style="display:flex;"><span><span style="color:#f92672">├──</span> node_modules
</span></span><span style="display:flex;"><span><span style="color:#f92672">│</span>   <span style="color:#f92672">└──</span> <span style="color:#a6e22e">@YOUR</span><span style="color:#f92672">-</span><span style="color:#a6e22e">ORGANIZATION</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">│</span>       <span style="color:#f92672">└──</span> somelib
</span></span><span style="display:flex;"><span><span style="color:#f92672">│</span>           <span style="color:#f92672">├──</span> include
</span></span><span style="display:flex;"><span><span style="color:#f92672">│</span>           <span style="color:#f92672">│</span>   <span style="color:#f92672">└──</span> somelib<span style="color:#f92672">.</span>h
</span></span><span style="display:flex;"><span><span style="color:#f92672">│</span>           <span style="color:#f92672">├──</span> lib
</span></span><span style="display:flex;"><span><span style="color:#f92672">│</span>           <span style="color:#f92672">│</span>   <span style="color:#f92672">└──</span> msvc141
</span></span><span style="display:flex;"><span><span style="color:#f92672">│</span>           <span style="color:#f92672">│</span>       <span style="color:#f92672">└──</span> x64
</span></span><span style="display:flex;"><span><span style="color:#f92672">│</span>           <span style="color:#f92672">│</span>           <span style="color:#f92672">├──</span> debug
</span></span><span style="display:flex;"><span><span style="color:#f92672">│</span>           <span style="color:#f92672">│</span>           <span style="color:#f92672">│</span>   <span style="color:#f92672">├──</span> pch<span style="color:#f92672">.</span>obj
</span></span><span style="display:flex;"><span><span style="color:#f92672">│</span>           <span style="color:#f92672">│</span>           <span style="color:#f92672">│</span>   <span style="color:#f92672">├──</span> somelib<span style="color:#f92672">.</span>idb
</span></span><span style="display:flex;"><span><span style="color:#f92672">│</span>           <span style="color:#f92672">│</span>           <span style="color:#f92672">│</span>   <span style="color:#f92672">├──</span> somelib<span style="color:#f92672">.</span>lib
</span></span><span style="display:flex;"><span><span style="color:#f92672">│</span>           <span style="color:#f92672">│</span>           <span style="color:#f92672">│</span>   <span style="color:#f92672">├──</span> somelib<span style="color:#f92672">.</span>obj
</span></span><span style="display:flex;"><span><span style="color:#f92672">│</span>           <span style="color:#f92672">│</span>           <span style="color:#f92672">│</span>   <span style="color:#f92672">├──</span> somelib<span style="color:#f92672">.</span>pch
</span></span><span style="display:flex;"><span><span style="color:#f92672">│</span>           <span style="color:#f92672">│</span>           <span style="color:#f92672">│</span>   <span style="color:#f92672">└──</span> somelib<span style="color:#f92672">.</span>pdb
</span></span><span style="display:flex;"><span><span style="color:#f92672">│</span>           <span style="color:#f92672">│</span>           <span style="color:#f92672">└──</span> release
</span></span><span style="display:flex;"><span><span style="color:#f92672">│</span>           <span style="color:#f92672">│</span>               <span style="color:#f92672">├──</span> pch<span style="color:#f92672">.</span>obj
</span></span><span style="display:flex;"><span><span style="color:#f92672">│</span>           <span style="color:#f92672">│</span>               <span style="color:#f92672">├──</span> somelib<span style="color:#f92672">.</span>lib
</span></span><span style="display:flex;"><span><span style="color:#f92672">│</span>           <span style="color:#f92672">│</span>               <span style="color:#f92672">├──</span> somelib<span style="color:#f92672">.</span>obj
</span></span><span style="display:flex;"><span><span style="color:#f92672">│</span>           <span style="color:#f92672">│</span>               <span style="color:#f92672">├──</span> somelib<span style="color:#f92672">.</span>pch
</span></span><span style="display:flex;"><span><span style="color:#f92672">│</span>           <span style="color:#f92672">│</span>               <span style="color:#f92672">└──</span> somelib<span style="color:#f92672">.</span>pdb
</span></span><span style="display:flex;"><span><span style="color:#f92672">│</span>           <span style="color:#f92672">└──</span> package<span style="color:#f92672">.</span>json
</span></span><span style="display:flex;"><span><span style="color:#f92672">├──</span> package<span style="color:#f92672">-</span>lock<span style="color:#f92672">.</span>json
</span></span><span style="display:flex;"><span><span style="color:#f92672">└──</span> package<span style="color:#f92672">.</span>json</span></span></code></pre></div>
<p>If you don&rsquo;t have <code>package.json</code>, it will complain about that, but the installation will still go fine.</p>
<p>Other than that - this is it, there will be nothing else. So you need to set-up your C++ project manually: where to find headers and where to find library.</p>
<h2 id="possible-issues">Possible issues</h2>
<p>At some point we started packing debug binaries too, and that considerably increased the packages size. As a result, <code>npm publish</code> started to fail with different kinds of errors.</p>
<h3 id="npm---javascript-heap-out-of-memory">npm - JavaScript heap out of memory</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span><span style="color:#a6e22e">FATAL</span> <span style="color:#a6e22e">ERROR</span><span style="color:#66d9ef">:</span> <span style="color:#66d9ef">CALL_AND_RETRY_LAST</span> <span style="color:#66d9ef">Allocation</span> <span style="color:#66d9ef">failed</span> <span style="color:#66d9ef">-</span> <span style="color:#66d9ef">JavaScript</span> <span style="color:#66d9ef">heap</span> <span style="color:#66d9ef">out</span> <span style="color:#66d9ef">of</span> <span style="color:#66d9ef">memory</span>
</span></span><span style="display:flex;"><span> <span style="color:#ae81ff">1</span><span style="color:#66d9ef">:</span> <span style="color:#66d9ef">node::DecodeWrite</span>
</span></span><span style="display:flex;"><span> <span style="color:#ae81ff">2</span><span style="color:#66d9ef">:</span> <span style="color:#66d9ef">node_module_register</span>
</span></span><span style="display:flex;"><span> <span style="color:#ae81ff">3</span><span style="color:#66d9ef">:</span> <span style="color:#66d9ef">v8::internal::FatalProcessOutOfMemory</span>
</span></span><span style="display:flex;"><span> <span style="color:#ae81ff">4</span><span style="color:#66d9ef">:</span> <span style="color:#66d9ef">v8::internal::FatalProcessOutOfMemory</span>
</span></span><span style="display:flex;"><span> <span style="color:#ae81ff">5</span><span style="color:#66d9ef">:</span> <span style="color:#66d9ef">v8::internal::Heap::MaxHeapGrowingFactor</span>
</span></span><span style="display:flex;"><span> <span style="color:#ae81ff">6</span><span style="color:#66d9ef">:</span> <span style="color:#66d9ef">v8::internal::Factory::NewRawTwoByteString</span>
</span></span><span style="display:flex;"><span> <span style="color:#ae81ff">7</span><span style="color:#66d9ef">:</span> <span style="color:#66d9ef">v8::internal::Smi::SmiPrint</span>
</span></span><span style="display:flex;"><span> <span style="color:#ae81ff">8</span><span style="color:#66d9ef">:</span> <span style="color:#66d9ef">unibrow::Utf8DecoderBase::WriteUtf16Slow</span>
</span></span><span style="display:flex;"><span> <span style="color:#ae81ff">9</span><span style="color:#66d9ef">:</span> <span style="color:#66d9ef">v8::String::WriteUtf8</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">10</span><span style="color:#66d9ef">:</span> <span style="color:#66d9ef">std::basic_ostream&lt;char</span><span style="color:#f92672">,</span>std<span style="color:#66d9ef">:</span><span style="color:#66d9ef">:char_traits&lt;char&gt;</span> <span style="color:#66d9ef">&gt;:</span><span style="color:#66d9ef">:basic_ostream&lt;char</span><span style="color:#f92672">,</span>std<span style="color:#66d9ef">:</span><span style="color:#66d9ef">:char_traits&lt;char&gt;</span> <span style="color:#66d9ef">&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">11</span><span style="color:#66d9ef">:</span> <span style="color:#66d9ef">std::basic_ostream&lt;char</span><span style="color:#f92672">,</span>std<span style="color:#66d9ef">:</span><span style="color:#66d9ef">:char_traits&lt;char&gt;</span> <span style="color:#66d9ef">&gt;:</span><span style="color:#66d9ef">:basic_ostream&lt;char</span><span style="color:#f92672">,</span>std<span style="color:#66d9ef">:</span><span style="color:#66d9ef">:char_traits&lt;char&gt;</span> <span style="color:#66d9ef">&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">12</span><span style="color:#66d9ef">:</span> <span style="color:#66d9ef">std::vector&lt;v8::CpuProfileDeoptFrame</span><span style="color:#f92672">,</span>std<span style="color:#66d9ef">:</span><span style="color:#66d9ef">:allocator&lt;v8::CpuProfileDeoptFrame&gt;</span> <span style="color:#66d9ef">&gt;:</span><span style="color:#66d9ef">:vector&lt;v8::CpuProfileDeoptFrame</span><span style="color:#f92672">,</span>std<span style="color:#66d9ef">:</span><span style="color:#66d9ef">:allocator&lt;v8::CpuProfileDeoptFrame&gt;</span> <span style="color:#66d9ef">&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">13</span><span style="color:#66d9ef">:</span> <span style="color:#66d9ef">v8::internal::interpreter::BytecodeDecoder::Decode</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">14</span><span style="color:#66d9ef">:</span> <span style="color:#66d9ef">v8::internal::RegExpImpl::Exec</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">15</span><span style="color:#66d9ef">:</span> <span style="color:#66d9ef">v8::internal::RegExpImpl::Exec</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">16</span><span style="color:#66d9ef">:</span> <span style="color:#66d9ef">v8::internal::RegExpImpl::Exec</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">17</span><span style="color:#66d9ef">:</span> <span style="color:#66d9ef">SOME-VALUE</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">Process</span> exited <span style="color:#66d9ef">with</span> code <span style="color:#ae81ff">134</span></span></span></code></pre></div>
<p>Internet is full of advices about passing <code>--max_old_space_size</code>, and also <code>--max-old-space-size</code> (<em>yes, look closely, that&rsquo;s a d_i-f-f_e-r_e_n-t option</em>) to increase the memory limit for Node. There is also a <a href="https://www.npmjs.com/package/increase-memory-limit">special package</a> that does it for you! I fucking lold.</p>
<p>There were also advices with a whole bunch of other options like <code>--optimize-for-size</code>, <code>--max-executable-size</code>, <code>--prod</code> and others (<em>also with <code>-</code> and <code>_</code> variations</em>), but none of those helped.</p>
<p>Then I noticed tnat we have Node 10.x installed, so I just updated to Node 12.x, and the problem got resolved. This fucking Node, mein gott. People are actually using it in production?</p>
<h3 id="npm---the-request-must-contain-a-body">npm - The request must contain a body</h3>
<p>Having resolved the out-of-memory issue, we got the next error:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span>npm <span style="color:#a6e22e">ERR</span><span style="color:#f92672">!</span> code E400
</span></span><span style="display:flex;"><span>npm <span style="color:#a6e22e">ERR</span><span style="color:#f92672">!</span> <span style="color:#ae81ff">400</span> <span style="color:#a6e22e">Bad</span> <span style="color:#a6e22e">Request</span> <span style="color:#f92672">-</span> <span style="color:#a6e22e">The</span> request must contain a body when publishing or updating a <span style="color:#66d9ef">package</span> <span style="color:#960050;background-color:#1e0010">(</span>DevOps <span style="color:#a6e22e">Activity</span> <span style="color:#a6e22e">ID</span><span style="color:#66d9ef">:</span> <span style="color:#66d9ef">ACTIVITY-ID</span><span style="color:#f92672">)</span> <span style="color:#f92672">-</span> <span style="color:#a6e22e">PUT</span> https<span style="color:#66d9ef">:</span><span style="color:#75715e">//pkgs.dev.azure.com/YOUR-ORGANIZATION/SOME-ID/_packaging/YOUR-PROJECT/npm/registry/@YOUR-NAME%2fPACKAGE-NAME - BadRequest
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">Process</span> exited <span style="color:#66d9ef">with</span> code <span style="color:#ae81ff">1</span></span></span></code></pre></div>
<p>Not very descriptive, is it? But since absolutely the same configuration was working fine before, it was clear that the only difference is the package size, so that had to be the reason. And indeed, turns out Microsoft has a limitation of <a href="https://docs.microsoft.com/en-us/azure/devops/artifacts/reference/limits?view=azure-devops">500 MB per package</a>, which we exceeded by staring packing debug binaries too.</p>
<p>So we reverted back to release binaries only, but if our users will demand us to ship debug builds too, then I guess unfortunately we&rsquo;ll have to migrate from Azure DevOps Artifacts to a self-hosted npm registry (<em>and deal with authorization and other things, which we have in Azure out-of-the-box</em>).</p>
<h1 id="resulting-feed">Resulting feed</h1>
<p>Here&rsquo;s what we have now in our Azure DevOps feed:</p>


    <img class="image-post" loading="lazy" src="/blog/2020/03/05/azure-devops-nuget-npm-cpp/images/azure-devops-packages-published.png" alt="Azure DevOps, published packages">

<p>So it&rsquo;s both NuGet and npm packages in one place.</p>



<hr class="updates-divider"/>
<div class="alert alert-info">
    <strong>[21.07.2021] Update:</strong> Package promotion
</div>

<p>Following up on the subject, here&rsquo;s how to <a href="/blog/2021/07/21/azure-devops-artifacts-promotion/">promote package versions</a> to certain views.</p>
      </div>
    </article>
    <div><div id="tags">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tag">
  <path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path><line x1="7" y1="7" x2="7" y2="7"></line>
</svg>
          <a class="tag" href="https://retifrav.github.io/tags/devops/">devops</a><a class="tag" href="https://retifrav.github.io/tags/azure/">azure</a><a class="tag" href="https://retifrav.github.io/tags/web/">web</a></div><hr class="comments-divider"/>
      <div id="comments">
      
          <script>
  var id =  46 ;

  if (id)
  {
    let url = "https://github.com/retifrav/retifrav.github.io/issues/".concat(id);
    let api_url = "https://api.github.com/repos/retifrav/retifrav.github.io/issues/".concat(id, "/comments");
    
    var commentsDiv = document.getElementById("comments");

    let xhr = new XMLHttpRequest();
    xhr.responseType = "json";
    xhr.open("GET", api_url);
    xhr.setRequestHeader("Accept", "application/vnd.github.v3.html+json");
    xhr.send();

    xhr.onload = function()
    {
      if (xhr.status != 200)
      {
        let errorText = document.createElement("p");
        errorText.innerHTML = "<i>Comments for this post yet are not opened yet (or you have GitHub scripts disabled).</i>";
        commentsDiv.appendChild(errorText);
      }
      else
      {
        let comments = xhr.response;

        let mainHeader = document.createElement("h2");
        mainHeader.innerHTML = "Comments: ".concat(comments.length);
        commentsDiv.appendChild(mainHeader);

        let issueLink = document.createElement("p");
        issueLink.innerHTML = "<i>You can leave a comment using this <a href='".concat(url, "'>GitHub issue</a>.</i>");
        commentsDiv.appendChild(issueLink);
        
        comments.forEach(function(comment)
        {
            let commentContent = document.createElement("div");
            commentContent.setAttribute('class', 'gh-comment')
            commentContent.innerHTML = "".concat(
                "<div class='gh-header'>",
                  "<img src='", comment.user.avatar_url, "' />",
                  "<div style='margin:auto 0;'>",
                    "<b><a class='gh-username' href='", comment.user.html_url, "'>", comment.user.login, "</a></b>",
                    " commented at <em>", new Date(comment.created_at), "</em>",
                  "</div>",
                "</div>",
                "<div class='gh-body'>",
                  comment.body_html,
                "</div>"
            );
            commentsDiv.appendChild(commentContent);
        });
      }
    };

    xhr.onerror = function()
    {
      let errorText = document.createElement("p");
      errorText.innerHTML = "<i>Some error loading comments.</i>";
      commentsDiv.appendChild(errorText);
    };
  }
</script>

      
      </div>
    </div>
  </div>

        <div id="footer">
          <div>
              2014 - 2023,
              <a href="/about/">retif</a>
          </div>
          <div><a href="/about/#licenses">CC BY-SA 4.0 / GPLv3</a></div>
        </div>
      </main>
      <div class="app-header">
        <div style="margin:0 0 20px;">
            <input id="search-query" placeholder="Search in titles and summaries" />
        </div>
        <div id="search-results" style="display:none;"></div>
        <div id="sidebars">
            <a id="avatar" href="/about"><img class="app-header-avatar" src="/images/avatar.png" /></a>
            <iframe src="https://github.com/sponsors/retifrav/button"
                height="35" style="border:0;"
                title="You can sponsor me">
            </iframe>
            
            <div class="sidebar-section">
              <h3>Feeds</h3>
              <a href="/index.xml" title="Subscribe to RSS"><img src="/images/rss.png" width="50px"></a>
              <a style="margin-left: 5px;" href="https://t.me/decovar" title="Telegram channel"><img src="/images/telegram.png" width="50px"></a>
            </div>
            <div id="telegramWidgetBlock" class="sidebar-section"></div>
            <div class="sidebar-section">
                <h3>Stuff</h3>
                <ul class="sidebar-list">
                    <li><a href="/stuff/kakoi-jvotne-vi-kysaiti/index.html">КАКОИ ЖВОТНЕ ВЫ КУСАИТИ?</a></li>
                </ul>
            </div>
            <div id="social-networks" class="sidebar-section">
              <h3>Social networks</h3>
              <div style="font-family:Courier New;">
                  Zuck: <i>Yeah so if you ever need info about anyone at Harvard</i><br/>
                  Zuck: <i>Just ask</i><br/>
                  Zuck: <i>I have over 4,000 emails, pictures, addresses, SNS</i><br/>
                  smb: <i>What? How'd you manage that one?</i><br/>
                  Zuck: <i>People just submitted it.</i><br/>
                  Zuck: <i>I don't know why.</i><br/>
                  Zuck: <i>They "trust me"</i><br/>
                  Zuck: <i>Dumb fucks</i>
              </div>
            </div>
            <div class="sidebar-section">
              <h3>Tags</h3>
              <ul style="list-style-type:none; padding:0; margin:0;">
                  
                  <li><a href="/tags/web">web (65)</a></li>
                  
                  <li><a href="/tags/fail">fail (39)</a></li>
                  
                  <li><a href="/tags/dotnet">dotnet (36)</a></li>
                  
                  <li><a href="/tags/qt">qt (34)</a></li>
                  
                  <li><a href="/tags/review">review (27)</a></li>
                  
                  <li><a href="/tags/devops">devops (24)</a></li>
                  
                  <li><a href="/tags/linux">linux (24)</a></li>
                  
                  <li><a href="/tags/macos">macos (22)</a></li>
                  
                  <li><a href="/tags/windows">windows (18)</a></li>
                  
                  <li><a href="/tags/mestuff">mestuff (17)</a></li>
                  
                  <li><a href="/tags/movies">movies (15)</a></li>
                  
                  <li><a href="/tags/tractor">tractor (14)</a></li>
                  
                  <li><a href="/tags/norway">norway (13)</a></li>
                  
                  <li><a href="/tags/irl">irl (12)</a></li>
                  
                  <li><a href="/tags/python">python (12)</a></li>
                  
                  <li><a href="/tags/telegram">telegram (12)</a></li>
                  
                  <li><a href="/tags/embedded">embedded (11)</a></li>
                  
                  <li><a href="/tags/soft">soft (10)</a></li>
                  
                  <li><a href="/tags/travel">travel (10)</a></li>
                  
                  <li><a href="/tags/applescript">applescript (9)</a></li>
                  
                  <li><a href="/tags/piracy">piracy (9)</a></li>
                  
                  <li><a href="/tags/cmake">cmake (8)</a></li>
                  
                  <li><a href="/tags/cpp">cpp (8)</a></li>
                  
                  <li><a href="/tags/octopress">octopress (8)</a></li>
                  
                  <li><a href="/tags/banks">banks (7)</a></li>
                  
                  <li><a href="/tags/ios">ios (7)</a></li>
                  
                  <li><a href="/tags/apple">apple (6)</a></li>
                  
                  <li><a href="/tags/games">games (6)</a></li>
                  
                  <li><a href="/tags/javascript">javascript (6)</a></li>
                  
                  <li><a href="/tags/photo">photo (6)</a></li>
                  
                  <li><a href="/tags/sql">sql (6)</a></li>
                  
                  <li><a href="/tags/hugo">hugo (4)</a></li>
                  
                  <li><a href="/tags/russia">russia (4)</a></li>
                  
                  <li><a href="/tags/wordpress">wordpress (4)</a></li>
                  
                  <li><a href="/tags/android">android (3)</a></li>
                  
                  <li><a href="/tags/azure">azure (3)</a></li>
                  
                  <li><a href="/tags/tv">tv (3)</a></li>
                  
                  <li><a href="/tags/usa">usa (3)</a></li>
                  
                  <li><a href="/tags/privacy">privacy (2)</a></li>
                  
                  <li><a href="/tags/tvos">tvos (2)</a></li>
                  
                  <li><a href="/tags/unsolved">unsolved (2)</a></li>
                  
                  <li><a href="/tags/books">books (1)</a></li>
                  
                  <li><a href="/tags/ffmpeg">ffmpeg (1)</a></li>
                  
                  <li><a href="/tags/ldap">ldap (1)</a></li>
                  
                  <li><a href="/tags/music">music (1)</a></li>
                  
                  <li><a href="/tags/science">science (1)</a></li>
                  
                  <li><a href="/tags/vr">vr (1)</a></li>
                  
              </ul>
            </div>
        </div>
      </header>
    </div>

    <script src="/js/search.js"></script>

    
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-53340325-1"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag() { dataLayer.push(arguments); }
      gtag("js", new Date());
      gtag("config", "UA-53340325-1");
    </script>

    <script>
        const telegramBlock = document.getElementById("telegramWidgetBlock");
        window.onload = () =>
        {
            const pinnedTelegramPosts = [316]
            const randomedPostID = pinnedTelegramPosts[
                Math.floor(Math.random() * pinnedTelegramPosts.length)
            ];
            const telegramWidgetScript = document.createElement("script");
            telegramWidgetScript.src = "https://telegram.org/js/telegram-widget.js?21";
            telegramWidgetScript.dataset["telegramPost"] = `decovar/${randomedPostID}`;
            telegramWidgetScript.dataset["color"] = "1E8448";
            telegramWidgetScript.dataset["width"] = "100%";
            telegramWidgetScript.dataset["userpic"] = "false";
            telegramBlock.appendChild(telegramWidgetScript);
        }
    </script>

    
    
  </body>
</html>
