<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Qt for WebAssembly and custom OpenGL via QQuickFramebufferObject | Declaration of VAR</title>
    <link rel="canonical" href="https://decovar.dev/blog/2021/08/29/qt-webassembly-custom-opengl/" />

    <meta name="generator" content="Hugo 0.111.3" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <link href="/favicon.png" rel="icon">

    <meta name="author" content="retif" />
    <meta name="description" content="Qt for WebAssembly actually works, and one can run a Qt Quick application in a web-browser. Moreover, one can even render custom OpenGL content inside such an application via QQuickFramebufferObject" />

    <link rel="alternate" type="application/rss+xml" href="/index.xml" title="Declaration of VAR" />

    <meta property="og:title" content="Qt for WebAssembly and custom OpenGL via QQuickFramebufferObject" />
<meta property="og:description" content="Qt for WebAssembly actually works, and one can run a Qt Quick application in a web-browser. Moreover, one can even render custom OpenGL content inside such an application via QQuickFramebufferObject" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://retifrav.github.io/blog/2021/08/29/qt-webassembly-custom-opengl/" /><meta property="article:section" content="blog" />
<meta property="article:published_time" content="2021-08-29T13:30:33+02:00" />
<meta property="article:modified_time" content="2021-08-29T13:30:33+02:00" />


    <link rel="stylesheet" href="https://retifrav.github.io/css/main.min.c1a9d5434fbba746ef09ebde219b0064b5d4318930fc8463f51550f13a0e1b54.css" />
    <link rel="stylesheet" href="/css/default.css" />
    <link rel="stylesheet" href="/css/post.css" />
    <link rel="stylesheet" href="/css/page.css" />
    <link rel="stylesheet" href="/css/comments.css" />

    <script src="/js/mark.js"></script>

    
    
  </head>
  <body>
    <div id="body-hat">
      <div id="title-block">
        <h1 id="blog-title"><a href="/">Declaration of VAR</a></h1>
        <p>and some other stuff</p>
      </div>
    </div>
    <div style="background-color:orange; padding:4px 16px; font-size:0.8em; text-align:center; font-style:italic;">
        On 19.05.2021 the website was moved to
        <a href="https://decovar.dev/blog/2021/08/29/qt-webassembly-custom-opengl/" style="color:black; font-weight:bold;">
            https://decovar.dev/</a>. This is just a mirror now.
    </div>
    <div id="body-flex">
      <main class="app-container">
        
  <div id="main-container">
    <article class="post">
      <header class="post-header">
        <h1 class ="post-title">Qt for WebAssembly and custom OpenGL via QQuickFramebufferObject</h1>
        <div class="post-meta">
          <div><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-calendar">
  <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line>
</svg> 2021-08-29 13:30:33 &#43;0200</div>
          <div><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-clock">
  <circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline>
</svg> 12 min read</div>
        </div>
      </header>
      <div class="post-content">
        <p>It is amazing what kind of crazy ideas people might come up with. One of our users decided that they want to use our visualization engine inside their Qt application on Windows and Linux (<em>so far so good</em>) and also to build a version for <a href="https://webassembly.org/">WebAssembly</a> to target web-browsers (<em>fucking hell</em>).</p>


    <img class="image-post" loading="lazy" src="/blog/2021/08/29/qt-webassembly-custom-opengl/images/qt-wasm-qquickframebufferobject.png" alt="Qt, WebAssembly, QQuickFramebufferObject">

<p>Very surprisingly to me, this actually works!</p>
<nav id="TableOfContents">
  <ul>
    <li><a href="#environment">Environment</a></li>
    <li><a href="#about-qt-for-webassembly">About Qt for WebAssembly</a></li>
    <li><a href="#installing-emscripten">Installing Emscripten</a>
      <ul>
        <li><a href="#test-a-simple-c-program">Test a simple C++ program</a></li>
      </ul>
    </li>
    <li><a href="#building-qt-sdk-for-webassembly">Building Qt SDK for WebAssembly</a></li>
    <li><a href="#building-a-qt-application-for-webassembly">Building a Qt application for WebAssembly</a></li>
    <li><a href="#custom-opengl-via-qquickframebufferobject">Custom OpenGL via QQuickFramebufferObject</a>
      <ul>
        <li><a href="#drawbacks">Drawbacks</a></li>
      </ul>
    </li>
  </ul>
</nav>
<h1 id="environment">Environment</h1>
<p>I&rsquo;ve tried it on Mac OS, but quite possibly everything will build fine on other platforms too. My environment:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span>$ sw_vers <span style="color:#f92672">-</span>productVersion
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">11.5</span><span style="color:#f92672">.</span><span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ clang <span style="color:#f92672">--</span>version
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">Homebrew</span> clang version <span style="color:#ae81ff">12.0</span><span style="color:#f92672">.</span><span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">Target</span><span style="color:#66d9ef">:</span> <span style="color:#66d9ef">x86_64-apple-darwin20.</span><span style="color:#960050;background-color:#1e0010">6</span><span style="color:#66d9ef">.</span><span style="color:#960050;background-color:#1e0010">0</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">Thread</span> <span style="color:#66d9ef">model:</span> <span style="color:#66d9ef">posix</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">InstalledDir</span><span style="color:#66d9ef">:</span> <span style="color:#66d9ef">/usr/local/opt/llvm/bin</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ python <span style="color:#f92672">--</span>version
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">Python</span> <span style="color:#ae81ff">3.9</span><span style="color:#f92672">.</span><span style="color:#ae81ff">6</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ cmake <span style="color:#f92672">--</span>version
</span></span><span style="display:flex;"><span>cmake version <span style="color:#ae81ff">3.21</span><span style="color:#f92672">.</span><span style="color:#ae81ff">1</span></span></span></code></pre></div>
<h1 id="about-qt-for-webassembly">About Qt for WebAssembly</h1>
<p>What is <a href="https://en.wikipedia.org/wiki/WebAssembly">WebAssembly</a>? In my silly understanding, it&rsquo;s a format of executable programs for web-browsers, like <code>.exe</code> for Windows, kind of? In other words, you can compile your C++ (<em>or other</em>) sources using special compiler, such as <a href="https://emscripten.org/">Emscripten</a>, into <code>.wasm</code> file, and that file can be then executed by a web-browser.</p>
<p>WebAssembly is a <a href="https://www.w3.org/TR/2019/REC-wasm-core-1-20191205/">standard</a>, and almost all modern web-browsers support it. So basically browsers are turning into universal cross-platform launchers (<em>aw jeez</em>).</p>
<p>And yes, Qt has a (<em>limited</em>) support for WebAssembly, so you can (<em>probably</em>) compile your Qt-based application sources into WebAssembly - it all depends on what Qt modules you are using in your application.</p>
<p>Here is the current list of <a href="https://doc.qt.io/qt-5/wasm.html#supported-qt-modules">supported modules</a>. That documentation page also has other useful information and links, such as <a href="https://doc.qt.io/qt-5/qtwebassembly-platform-notes.html">platform notes</a>, blog posts (<em><a href="https://www.qt.io/blog/2018/05/22/qt-for-webassembly">this one</a> conveniently has a list of bugreports</em>), <a href="https://wiki.qt.io/Qt_for_WebAssembly">wiki</a> and <a href="https://www.qt.io/qt-examples-for-webassembly">live demos</a>.</p>
<p>In addition to the documentation I would also recommend to watch this <a href="https://www.youtube.com/watch?v=W3WC-VpKdGQ">video-recording</a> from Qt World Summit 2019.</p>
<p>It wouldn&rsquo;t hurt to mention that Qt for WebAssembly is licensed under either commercial license or GPLv3, so no LGPL option. I am not quite sure how would that affect users projects, as actual Qt libraries have LGPL option (<em>not all of them, but still</em>), however I&rsquo;ll leave that to legal specialists.</p>
<p>And as I understood, currently it only works with <code>qmake</code>.</p>
<h1 id="installing-emscripten">Installing Emscripten</h1>
<p>To compile something to WebAssembly, you need a compiler. <a href="https://github.com/emscripten-core/emsdk">Emscripten</a> is mentioned everywhere, and I don&rsquo;t know if there is actually any other.</p>
<p>It is important to use the right version of Emscripten (<em>so wow, much stability</em>). For Qt 5.15.x you need to use version <code>1.39.8</code>, and here&rsquo;s a <a href="https://doc.qt.io/qt-5/wasm.html#install-emscripten">list</a> of matches for other versions.</p>
<p><a href="https://emscripten.org/docs/getting_started/downloads.html">Install</a> Emscripten and activate it with the right version:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ cd /path/to/programs
</span></span><span style="display:flex;"><span>$ git clone --depth <span style="color:#ae81ff">1</span> git@github.com:emscripten-core/emsdk.git
</span></span><span style="display:flex;"><span>$ cd ./emsdk
</span></span><span style="display:flex;"><span>$ ./emsdk list
</span></span><span style="display:flex;"><span>$ ./emsdk install 1.39.8
</span></span><span style="display:flex;"><span>$ ./emsdk activate 1.39.8
</span></span><span style="display:flex;"><span>$ ./emsdk construct_env</span></span></code></pre></div>
<p>As a result, among other things, you should get <code>emsdk_env.sh</code> script. It will set-up the build environment:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ source ./emsdk_env.sh
</span></span><span style="display:flex;"><span>$ em++ --version</span></span></code></pre></div>
<p>Don&rsquo;t forget that this environment will apply only to the current shell session, so even if you just open a new tab in your terminal, this script needs to be sourced again.</p>
<h2 id="test-a-simple-c-program">Test a simple C++ program</h2>
<p>To check that Emscripten works, make a simple C++ program (<code>some.cpp</code>):</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;iostream&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>(<span style="color:#66d9ef">int</span> argc, <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>argv[])
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    std<span style="color:#f92672">::</span>cout <span style="color:#f92672">&lt;&lt;</span> <span style="color:#e6db74">&#34;ololo&#34;</span> <span style="color:#f92672">&lt;&lt;</span> std<span style="color:#f92672">::</span>endl;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> EXIT_SUCCESS;
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div>
<p>Test that it at least compiles with a C++ compiler:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ clang++ ./some.cpp -o some
</span></span><span style="display:flex;"><span>$ ./some
</span></span><span style="display:flex;"><span>ololo
</span></span></code></pre></div><p>And then try to compile it with Emscripten:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ em++ ./some.cpp -o some.html</span></span></code></pre></div>
<p>That will build your program and generate the following:</p>
<ul>
<li><code>some.wasm</code></li>
<li><code>some.html</code></li>
<li><code>some.js</code></li>
</ul>
<p>If you are curious enough, you can take a look at the code in <code>some.js</code>, to get an idea about how all that is supposed to work, but it has over 5000 lines of JS code, so you probably won&rsquo;t.</p>
<p>If you now open <code>some.html</code> in a web-browser, you&rsquo;ll get a web-page with a canvas, a textarea and an error in browser console about loading <code>some.wasm</code>. In Chromium it will be this:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-py" data-lang="py"><span style="display:flex;"><span>Fetch API cannot load file:<span style="color:#f92672">///</span>path<span style="color:#f92672">/</span>to<span style="color:#f92672">/</span>project<span style="color:#f92672">/</span>some<span style="color:#f92672">.</span>wasm<span style="color:#f92672">.</span> URL scheme <span style="color:#e6db74">&#34;file&#34;</span> <span style="color:#f92672">is</span> <span style="color:#f92672">not</span> supported<span style="color:#f92672">.</span></span></span></code></pre></div>
<p>In Firefox it will be slightly different, but essentially the same error:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-py" data-lang="py"><span style="display:flex;"><span>Cross<span style="color:#f92672">-</span>Origin Request Blocked: The Same Origin Policy disallows reading the remote resource at file:<span style="color:#f92672">///</span>path<span style="color:#f92672">/</span>to<span style="color:#f92672">/</span>project<span style="color:#f92672">/</span>some<span style="color:#f92672">.</span>wasm<span style="color:#f92672">.</span> (Reason: CORS request <span style="color:#f92672">not</span> http)<span style="color:#f92672">.</span></span></span></code></pre></div>
<p>Modern browser don&rsquo;t like when you try to read files from disk. To get pass this restriction, you can launch your browser via <a href="https://emscripten.org/docs/compiling/Running-html-files-with-emrun.html">emrun</a>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span>$ emrun <span style="color:#f92672">--</span>browser <span style="color:#f92672">~/</span><span style="color:#a6e22e">Applications</span><span style="color:#f92672">/</span><span style="color:#a6e22e">Firefox</span>\ <span style="color:#a6e22e">Developer</span>\ <span style="color:#a6e22e">Edition</span><span style="color:#f92672">.</span>app<span style="color:#f92672">/</span><span style="color:#a6e22e">Contents</span><span style="color:#f92672">/</span><span style="color:#a6e22e">MacOS</span><span style="color:#f92672">/</span>firefox <span style="color:#f92672">./</span>some<span style="color:#f92672">.</span>html</span></span></code></pre></div>
<p>It seems to be trying to bind to <code>0.0.0.0</code>, so if you don&rsquo;t want to create yet another firewall rule for yet another thing in your system, you can host <code>some.html</code> with a proper web-server instead. For testing I usually prefer a simple Python script like this one:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-py" data-lang="py"><span style="display:flex;"><span><span style="color:#f92672">import</span> http.server
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> socketserver
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">HttpRequestHandler</span>(http<span style="color:#f92672">.</span>server<span style="color:#f92672">.</span>SimpleHTTPRequestHandler):
</span></span><span style="display:flex;"><span>    extensions_map <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;.html&#34;</span> : <span style="color:#e6db74">&#34;text/html&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;.css&#34;</span>  : <span style="color:#e6db74">&#34;text/css&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;.js&#34;</span>   : <span style="color:#e6db74">&#34;application/javascript&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;.json&#34;</span> : <span style="color:#e6db74">&#34;application/json&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;.wasm&#34;</span> : <span style="color:#e6db74">&#34;application/wasm&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;.png&#34;</span>  : <span style="color:#e6db74">&#34;image/png&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;.jpg&#34;</span>  : <span style="color:#e6db74">&#34;image/jpg&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;.svg&#34;</span>  : <span style="color:#e6db74">&#34;image/svg+xml&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;.xml&#34;</span>  : <span style="color:#e6db74">&#34;application/xml&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;</span>      : <span style="color:#e6db74">&#34;application/octet-stream&#34;</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>host <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;localhost&#34;</span>
</span></span><span style="display:flex;"><span>port <span style="color:#f92672">=</span> <span style="color:#ae81ff">8000</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>httpd <span style="color:#f92672">=</span> socketserver<span style="color:#f92672">.</span>TCPServer((host, port), HttpRequestHandler)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;serving at http://</span><span style="color:#e6db74">{</span>host<span style="color:#e6db74">}</span><span style="color:#e6db74">:</span><span style="color:#e6db74">{</span>port<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>    httpd<span style="color:#f92672">.</span>serve_forever()
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">except</span> <span style="color:#a6e22e">KeyboardInterrupt</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">pass</span></span></span></code></pre></div>
<p>Note the MIME types for JS and WASM. You will probably need to set them in other web-servers too (<em>at least I needed to do so in NGINX</em>). Speaking about setting things, in production environment, if using pthreads, you most likely will also need to set <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/SharedArrayBuffer/Planned_changes">COOP and COEP</a> HTTP headers.</p>
<p>Also, one of the Qt developers/maintainers of Qt for WebAssembly provided his own, more advanced <a href="https://bugreports.qt.io/browse/QTBUG-79087">web-server implementation</a> (<em>also in Python</em>). This one even supports HTTPS.</p>
<p>Either way, you can run the script-server like this:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ python ./server.py</span></span></code></pre></div>
<p>Or, if not using any scripts:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ python -m http.server <span style="color:#ae81ff">8000</span></span></span></code></pre></div>
<p>And then open <code>/some.html</code>:</p>


    <img class="image-post" loading="lazy" src="/blog/2021/08/29/qt-webassembly-custom-opengl/images/wasm-simple-cpp.png" alt="Simple C&#43;&#43; program as WASM">

<p>What sorcery is this, a C++ programs runs inside a web-browser! <a href="https://youtu.be/Y7wY8vtPEMQ">How bizarre</a>!</p>
<h1 id="building-qt-sdk-for-webassembly">Building Qt SDK for WebAssembly</h1>
<p>If you can get pre-built Qt for WebAssembly binaries, probably that would be the easiest, otherwise you&rsquo;ll need to <a href="/blog/2020/12/04/qt-without-installer/">build it from sources</a>. I took version <a href="https://download.qt.io/archive/qt/5.15/5.15.2/single/">5.15.2</a>.</p>
<p>Unpack and configure the build:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ cd /path/to/qt/sources
</span></span><span style="display:flex;"><span>$ mkdir build <span style="color:#f92672">&amp;&amp;</span> cd $_
</span></span><span style="display:flex;"><span>$ ../configure -static -release -no-pch -xplatform wasm-emscripten -no-feature-thread -prefix <span style="color:#e6db74">&#34;/Users/vasya/programs/qt/5152-wasm&#34;</span> -skip qtwebengine -nomake tools -nomake tests -nomake examples</span></span></code></pre></div>
<p>That will configure Qt to build without thread/pthreads support (<code>-no-feature-thread</code>). It&rsquo;s better this way for finding possible problems in your application, and when it&rsquo;s all good, then you can re-build Qt with threads enabled. Also, not every browser might actually support pthreads, so that could be another reason for building Qt without it. Finally, should you decide to build with theads, note that Emscripten also needs to have <a href="https://emscripten.org/docs/porting/pthreads.html">support for pthreads</a> enabled.</p>
<p>Now you can build Qt:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ time make -j12 module-qtbase module-qtdeclarative</span></span></code></pre></div>
<p>This way it will build only the specified modules. I only needed these ones, but if you need everything, then you can just run <code>make</code> without listing modules.</p>
<p>Anyway, having started the build, I got this error after a while, so the build failed:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span><span style="color:#f92672">/</span>bin<span style="color:#f92672">/</span>sh<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">/Users/vasya/programs/emsdk/python:</span> <span style="color:#66d9ef">is</span> <span style="color:#66d9ef">a</span> <span style="color:#66d9ef">directory</span></span></span></code></pre></div>
<p>Can&rsquo;t say what it was trying to do, but I just simply ran <code>make</code> again, and the rest of the build went fine. It took about 20 minutes (<em>both attempts combined</em>).</p>
<p>Then you can ran the installation:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ time make -j12 install</span></span></code></pre></div>
<p>And that took unusually a lot of time - 15 minutes - comparing to a couple of minutes when building for &ldquo;regular&rdquo; platforms. The installed Qt build resulted in 198 MB.</p>
<h1 id="building-a-qt-application-for-webassembly">Building a Qt application for WebAssembly</h1>
<p>Check that you still have Emscripten environment set and that <code>qmake</code> is working:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span>$ em<span style="color:#f92672">++</span> <span style="color:#f92672">--</span>version
</span></span><span style="display:flex;"><span>emcc <span style="color:#f92672">(</span><span style="color:#a6e22e">Emscripten</span> gcc<span style="color:#f92672">/</span>clang<span style="color:#f92672">-</span>like replacement<span style="color:#f92672">)</span> <span style="color:#ae81ff">1.39</span><span style="color:#f92672">.</span><span style="color:#ae81ff">8</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ <span style="color:#f92672">~/</span>programs<span style="color:#f92672">/</span>qt<span style="color:#f92672">/</span><span style="color:#ae81ff">5152</span><span style="color:#f92672">-</span>wasm<span style="color:#f92672">/</span>bin<span style="color:#f92672">/</span>qmake <span style="color:#f92672">--</span>version
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">QMake</span> version <span style="color:#ae81ff">3.1</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">Using</span> <span style="color:#a6e22e">Qt</span> version <span style="color:#ae81ff">5.15</span><span style="color:#f92672">.</span><span style="color:#ae81ff">2</span> in <span style="color:#f92672">/</span><span style="color:#a6e22e">Users</span><span style="color:#f92672">/</span>vasya<span style="color:#f92672">/</span>programs<span style="color:#f92672">/</span>qt<span style="color:#f92672">/</span><span style="color:#ae81ff">5152</span><span style="color:#f92672">-</span>wasm<span style="color:#f92672">/</span>lib</span></span></code></pre></div>
<p>First, let&rsquo;s take something simple, for example the glorious Qt Quick application of mine - <a href="https://github.com/retifrav/color-corners/">Color Corners</a> - and try to build it with Qt for WebAssembly:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span>$ git clone git<span style="color:#a6e22e">@github</span><span style="color:#f92672">.</span>com<span style="color:#66d9ef">:</span><span style="color:#66d9ef">retifrav/color-corners.git</span>
</span></span><span style="display:flex;"><span>$ cd color<span style="color:#f92672">-</span>corners
</span></span><span style="display:flex;"><span>$ mkdir build <span style="color:#f92672">&amp;&amp;</span> cd <span style="color:#a6e22e">$_</span>
</span></span><span style="display:flex;"><span>$ <span style="color:#f92672">~/</span>programs<span style="color:#f92672">/</span>qt<span style="color:#f92672">/</span><span style="color:#ae81ff">5152</span><span style="color:#f92672">-</span>wasm<span style="color:#f92672">/</span>bin<span style="color:#f92672">/</span>qmake <span style="color:#e6db74">&#34;CONFIG+=release&#34;</span> <span style="color:#f92672">../</span>color<span style="color:#f92672">-</span>corners<span style="color:#f92672">.</span>pro</span></span></code></pre></div>
<p>If you did not set the Emscripten environment, then you&rsquo;ll get:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>Project ERROR: Cannot run target compiler <span style="color:#e6db74">&#39;em++&#39;</span>. Output:
</span></span><span style="display:flex;"><span><span style="color:#f92672">===================</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">===================</span>
</span></span><span style="display:flex;"><span>Maybe you forgot to setup the environment?</span></span></code></pre></div>
<p>Once <code>qmake</code> succeeds, try to build the project:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ make -j12</span></span></code></pre></div>
<p>Most likely that will fail with the following errors:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span><span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>error<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">undefined</span> <span style="color:#66d9ef">symbol:</span> <span style="color:#66d9ef">_</span><span style="color:#66d9ef">ZN3JSC4Yarr12digitsCreateEv</span>
</span></span><span style="display:flex;"><span>warning<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">Link</span> <span style="color:#66d9ef">with</span> <span style="color:#66d9ef">`-s LLD_REPORT_UNDEFINED`</span> <span style="color:#66d9ef">to</span> <span style="color:#66d9ef">get</span> <span style="color:#66d9ef">more</span> <span style="color:#66d9ef">information</span> <span style="color:#66d9ef">on</span> <span style="color:#66d9ef">undefined</span> <span style="color:#66d9ef">symbols</span>
</span></span><span style="display:flex;"><span>warning<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">To</span> <span style="color:#66d9ef">disable</span> <span style="color:#66d9ef">errors</span> <span style="color:#66d9ef">for</span> <span style="color:#66d9ef">undefined</span> <span style="color:#66d9ef">symbols</span> <span style="color:#66d9ef">use</span> <span style="color:#66d9ef">`-s ERROR_ON_UNDEFINED_SYMBOLS=0`</span>
</span></span><span style="display:flex;"><span>error<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">undefined</span> <span style="color:#66d9ef">symbol:</span> <span style="color:#66d9ef">_</span><span style="color:#66d9ef">ZN3JSC4Yarr12spacesCreateEv</span>
</span></span><span style="display:flex;"><span>error<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">undefined</span> <span style="color:#66d9ef">symbol:</span> <span style="color:#66d9ef">_</span><span style="color:#66d9ef">ZN3JSC4Yarr13newlineCreateEv</span>
</span></span><span style="display:flex;"><span>error<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">undefined</span> <span style="color:#66d9ef">symbol:</span> <span style="color:#66d9ef">_</span><span style="color:#66d9ef">ZN3JSC4Yarr14wordcharCreateEv</span>
</span></span><span style="display:flex;"><span>error<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">undefined</span> <span style="color:#66d9ef">symbol:</span> <span style="color:#66d9ef">_</span><span style="color:#66d9ef">ZN3JSC4Yarr15nondigitsCreateEv</span>
</span></span><span style="display:flex;"><span>error<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">undefined</span> <span style="color:#66d9ef">symbol:</span> <span style="color:#66d9ef">_</span><span style="color:#66d9ef">ZN3JSC4Yarr15nonspacesCreateEv</span>
</span></span><span style="display:flex;"><span>error<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">undefined</span> <span style="color:#66d9ef">symbol:</span> <span style="color:#66d9ef">_</span><span style="color:#66d9ef">ZN3JSC4Yarr17nonwordcharCreateEv</span>
</span></span><span style="display:flex;"><span>error<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">undefined</span> <span style="color:#66d9ef">symbol:</span> <span style="color:#66d9ef">_</span><span style="color:#66d9ef">ZN3JSC4Yarr31wordUnicodeIgnoreCaseCharCreateEv</span>
</span></span><span style="display:flex;"><span>error<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">undefined</span> <span style="color:#66d9ef">symbol:</span> <span style="color:#66d9ef">_</span><span style="color:#66d9ef">ZN3JSC4Yarr34nonwordUnicodeIgnoreCaseCharCreateEv</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">Error</span><span style="color:#66d9ef">:</span> <span style="color:#66d9ef">Aborting</span> <span style="color:#66d9ef">compilation</span> <span style="color:#66d9ef">due</span> <span style="color:#66d9ef">to</span> <span style="color:#66d9ef">previous</span> <span style="color:#66d9ef">errors</span>
</span></span><span style="display:flex;"><span>shared<span style="color:#66d9ef">:</span><span style="color:#66d9ef">ERROR:</span> <span style="color:#960050;background-color:#1e0010">&#39;</span><span style="color:#66d9ef">/Users/vasya/programs/emsdk/node/</span><span style="color:#960050;background-color:#1e0010">12</span><span style="color:#66d9ef">.</span><span style="color:#960050;background-color:#1e0010">18</span><span style="color:#66d9ef">.</span><span style="color:#960050;background-color:#1e0010">1</span><span style="color:#66d9ef">_</span><span style="color:#960050;background-color:#1e0010">64</span><span style="color:#66d9ef">bit/bin/node</span> <span style="color:#66d9ef">/Users/vasya/programs/emsdk/upstream/emscripten/src/compiler.js</span> <span style="color:#66d9ef">/var/folders/</span><span style="color:#960050;background-color:#1e0010">5</span><span style="color:#66d9ef">x/jyhk_09s1m53tt41l55xtgmw0000gn/T/tmp411g4ctz.txt</span><span style="color:#960050;background-color:#1e0010">&#39;</span> <span style="color:#66d9ef">failed</span> <span style="color:#f92672">(</span><span style="color:#960050;background-color:#1e0010">1</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">make:</span> <span style="color:#66d9ef">***</span> <span style="color:#f92672">[</span><span style="color:#66d9ef">color-corners.js</span><span style="color:#f92672">]</span> <span style="color:#a6e22e">Error</span> <span style="color:#ae81ff">1</span></span></span></code></pre></div>
<p>To set these mysterious flags you need to edit <code>LFLAGS</code> string in the <code>Makefile</code> (<em>produced by <code>qmake</code></em>). For instance, let&rsquo;s add <code>-s LLD_REPORT_UNDEFINED</code> to the end of the line:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span><span style="color:#a6e22e">LFLAGS</span> <span style="color:#66d9ef">=</span> <span style="color:#f92672">-</span>s <span style="color:#a6e22e">WASM</span><span style="color:#66d9ef">=</span><span style="color:#ae81ff">1</span> <span style="color:#f92672">-</span>s <span style="color:#a6e22e">FULL_ES2</span><span style="color:#66d9ef">=</span><span style="color:#ae81ff">1</span> <span style="color:#f92672">-</span>s <span style="color:#a6e22e">FULL_ES3</span><span style="color:#66d9ef">=</span><span style="color:#ae81ff">1</span> <span style="color:#f92672">-</span>s <span style="color:#a6e22e">USE_WEBGL2</span><span style="color:#66d9ef">=</span><span style="color:#ae81ff">1</span> <span style="color:#f92672">-</span>s <span style="color:#a6e22e">EXIT_RUNTIME</span><span style="color:#66d9ef">=</span><span style="color:#ae81ff">1</span> <span style="color:#f92672">-</span>s <span style="color:#a6e22e">ERROR_ON_UNDEFINED_SYMBOLS</span><span style="color:#66d9ef">=</span><span style="color:#ae81ff">1</span> <span style="color:#f92672">-</span>s <span style="color:#a6e22e">EXTRA_EXPORTED_RUNTIME_METHODS</span><span style="color:#f92672">=[</span><span style="color:#960050;background-color:#1e0010">&#34;</span><span style="color:#66d9ef">UTF16ToString</span><span style="color:#960050;background-color:#1e0010">&#34;</span>,<span style="color:#960050;background-color:#1e0010">&#34;</span><span style="color:#66d9ef">stringToUTF16</span><span style="color:#960050;background-color:#1e0010">&#34;</span><span style="color:#f92672">]</span> <span style="color:#f92672">--</span>bind <span style="color:#f92672">-</span>s <span style="color:#a6e22e">FETCH</span><span style="color:#66d9ef">=</span><span style="color:#ae81ff">1</span> <span style="color:#f92672">-</span>O2 <span style="color:#f92672">-</span>s <span style="color:#a6e22e">ALLOW_MEMORY_GROWTH</span><span style="color:#66d9ef">=</span><span style="color:#ae81ff">1</span> <span style="color:#f92672">-</span>s <span style="color:#a6e22e">LLD_REPORT_UNDEFINED</span></span></span></code></pre></div>
<p>Having run <code>make</code> again, I got a more detailed but still useless output:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span>wasm<span style="color:#f92672">-</span>ld<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">error:</span> <span style="color:#66d9ef">symbol</span> <span style="color:#66d9ef">exported</span> <span style="color:#66d9ef">via</span> <span style="color:#66d9ef">--export</span> <span style="color:#66d9ef">not</span> <span style="color:#66d9ef">found:</span> <span style="color:#66d9ef">_</span><span style="color:#66d9ef">get_environ</span>
</span></span><span style="display:flex;"><span>shared<span style="color:#66d9ef">:</span><span style="color:#66d9ef">ERROR:</span> <span style="color:#960050;background-color:#1e0010">&#39;</span><span style="color:#66d9ef">/Users/vasya/programs/emsdk/upstream/bin/wasm-ld</span> <span style="color:#66d9ef">-o</span> <span style="color:#66d9ef">/var/folders/</span><span style="color:#960050;background-color:#1e0010">5</span><span style="color:#66d9ef">x/jyhk_09s1m53tt41l55xtgmw0000gn/T/emscripten_temp_ixovwtae/color-corners.wasm</span> <span style="color:#66d9ef">--lto-O0</span> <span style="color:#66d9ef">main.o</span> <span style="color:#66d9ef">color-corners.js_plugin_import.o</span> <span style="color:#66d9ef">-L/Users/vasya/programs/emsdk/upstream/emscripten/system/local/lib</span> <span style="color:#66d9ef">color-corners.js_qml_plugin_import.o</span> <span style="color:#66d9ef">-L/Users/vasya/programs/emsdk/upstream/emscripten/system/lib</span> <span style="color:#66d9ef">qrc_qml.o</span> <span style="color:#66d9ef">-L/Users/vasya/programs/emsdk/upstream/emscripten/cache/wasm-obj</span> <span style="color:#66d9ef">/Users/vasya/programs/qt/</span><span style="color:#960050;background-color:#1e0010">5152</span><span style="color:#66d9ef">-wasm/plugins/platforms/libqwasm.a</span> <span style="color:#66d9ef">/Users/vasya/programs/qt/</span><span style="color:#960050;background-color:#1e0010">5152</span><span style="color:#66d9ef">-wasm/lib/libQt5EventDispatcherSupport.a</span> <span style="color:#66d9ef">/Users/vasya/programs/qt/</span><span style="color:#960050;background-color:#1e0010">5152</span><span style="color:#66d9ef">-wasm/lib/libQt5FontDatabaseSupport.a</span> <span style="color:#66d9ef">/Users/vasya/programs/qt/</span><span style="color:#960050;background-color:#1e0010">5152</span><span style="color:#66d9ef">-wasm/lib/libqtfreetype.a</span> <span style="color:#66d9ef">/Users/vasya/programs/qt/</span><span style="color:#960050;background-color:#1e0010">5152</span><span style="color:#66d9ef">-wasm/lib/libQt5EglSupport.a</span> <span style="color:#66d9ef">/Users/vasya/programs/qt/</span><span style="color:#960050;background-color:#1e0010">5152</span><span style="color:#66d9ef">-wasm/plugins/imageformats/libqgif.a</span> <span style="color:#66d9ef">/Users/vasya/programs/qt/</span><span style="color:#960050;background-color:#1e0010">5152</span><span style="color:#66d9ef">-wasm/plugins/imageformats/libqicns.a</span> <span style="color:#66d9ef">/Users/vasya/programs/qt/</span><span style="color:#960050;background-color:#1e0010">5152</span><span style="color:#66d9ef">-wasm/plugins/imageformats/libqico.a</span> <span style="color:#66d9ef">/Users/vasya/programs/qt/</span><span style="color:#960050;background-color:#1e0010">5152</span><span style="color:#66d9ef">-wasm/plugins/imageformats/libqjpeg.a</span> <span style="color:#66d9ef">/Users/vasya/programs/qt/</span><span style="color:#960050;background-color:#1e0010">5152</span><span style="color:#66d9ef">-wasm/plugins/imageformats/libqtga.a</span> <span style="color:#66d9ef">/Users/vasya/programs/qt/</span><span style="color:#960050;background-color:#1e0010">5152</span><span style="color:#66d9ef">-wasm/plugins/imageformats/libqtiff.a</span> <span style="color:#66d9ef">/Users/vasya/programs/qt/</span><span style="color:#960050;background-color:#1e0010">5152</span><span style="color:#66d9ef">-wasm/plugins/imageformats/libqwbmp.a</span> <span style="color:#66d9ef">/Users/vasya/programs/qt/</span><span style="color:#960050;background-color:#1e0010">5152</span><span style="color:#66d9ef">-wasm/plugins/imageformats/libqwebp.a</span> <span style="color:#66d9ef">/Users/vasya/programs/qt/</span><span style="color:#960050;background-color:#1e0010">5152</span><span style="color:#66d9ef">-wasm/qml/QtQuick.</span><span style="color:#960050;background-color:#1e0010">2</span><span style="color:#66d9ef">/libqtquick2plugin.a</span> <span style="color:#66d9ef">/Users/vasya/programs/qt/</span><span style="color:#960050;background-color:#1e0010">5152</span><span style="color:#66d9ef">-wasm/qml/QtQuick/Window.</span><span style="color:#960050;background-color:#1e0010">2</span><span style="color:#66d9ef">/libwindowplugin.a</span> <span style="color:#66d9ef">/Users/vasya/programs/qt/</span><span style="color:#960050;background-color:#1e0010">5152</span><span style="color:#66d9ef">-wasm/qml/QtQuick/Layouts/libqquicklayoutsplugin.a</span> <span style="color:#66d9ef">/Users/vasya/programs/qt/</span><span style="color:#960050;background-color:#1e0010">5152</span><span style="color:#66d9ef">-wasm/lib/libQt5Quick.a</span> <span style="color:#66d9ef">/Users/vasya/programs/qt/</span><span style="color:#960050;background-color:#1e0010">5152</span><span style="color:#66d9ef">-wasm/lib/libQt5Gui.a</span> <span style="color:#66d9ef">/Users/vasya/programs/qt/</span><span style="color:#960050;background-color:#1e0010">5152</span><span style="color:#66d9ef">-wasm/lib/libqtlibpng.a</span> <span style="color:#66d9ef">/Users/vasya/programs/qt/</span><span style="color:#960050;background-color:#1e0010">5152</span><span style="color:#66d9ef">-wasm/lib/libqtharfbuzz.a</span> <span style="color:#66d9ef">/Users/vasya/programs/qt/</span><span style="color:#960050;background-color:#1e0010">5152</span><span style="color:#66d9ef">-wasm/qml/QtQml/libqmlplugin.a</span> <span style="color:#66d9ef">/Users/vasya/programs/qt/</span><span style="color:#960050;background-color:#1e0010">5152</span><span style="color:#66d9ef">-wasm/qml/QtQml/Models.</span><span style="color:#960050;background-color:#1e0010">2</span><span style="color:#66d9ef">/libmodelsplugin.a</span> <span style="color:#66d9ef">/Users/vasya/programs/qt/</span><span style="color:#960050;background-color:#1e0010">5152</span><span style="color:#66d9ef">-wasm/lib/libQt5QmlModels.a</span> <span style="color:#66d9ef">/Users/vasya/programs/qt/</span><span style="color:#960050;background-color:#1e0010">5152</span><span style="color:#66d9ef">-wasm/lib/libQt5Qml.a</span> <span style="color:#66d9ef">/Users/vasya/programs/qt/</span><span style="color:#960050;background-color:#1e0010">5152</span><span style="color:#66d9ef">-wasm/lib/libQt5Network.a</span> <span style="color:#66d9ef">/Users/vasya/programs/qt/</span><span style="color:#960050;background-color:#1e0010">5152</span><span style="color:#66d9ef">-wasm/lib/libQt5Core.a</span> <span style="color:#66d9ef">/Users/vasya/programs/qt/</span><span style="color:#960050;background-color:#1e0010">5152</span><span style="color:#66d9ef">-wasm/lib/libqtpcre2.a</span> <span style="color:#66d9ef">/Users/vasya/programs/emsdk/upstream/emscripten/cache/wasm-obj/libc.a</span> <span style="color:#66d9ef">/Users/vasya/programs/emsdk/upstream/emscripten/cache/wasm-obj/libcompiler_rt.a</span> <span style="color:#66d9ef">/Users/vasya/programs/emsdk/upstream/emscripten/cache/wasm-obj/libc-wasm.a</span> <span style="color:#66d9ef">/Users/vasya/programs/emsdk/upstream/emscripten/cache/wasm-obj/libc++-noexcept.a</span> <span style="color:#66d9ef">/Users/vasya/programs/emsdk/upstream/emscripten/cache/wasm-obj/libc++abi-noexcept.a</span> <span style="color:#66d9ef">--whole-archive</span> <span style="color:#66d9ef">/Users/vasya/programs/emsdk/upstream/emscripten/cache/wasm-obj/libembind-rtti.a</span> <span style="color:#66d9ef">/Users/vasya/programs/emsdk/upstream/emscripten/cache/wasm-obj/libfetch.a</span> <span style="color:#66d9ef">--no-whole-archive</span> <span style="color:#66d9ef">/Users/vasya/programs/emsdk/upstream/emscripten/cache/wasm-obj/libgl-webgl2-full_es3.a</span> <span style="color:#66d9ef">/Users/vasya/programs/emsdk/upstream/emscripten/cache/wasm-obj/libdlmalloc.a</span> <span style="color:#66d9ef">/Users/vasya/programs/emsdk/upstream/emscripten/cache/wasm-obj/libpthread_stub.a</span> <span style="color:#66d9ef">/Users/vasya/programs/emsdk/upstream/emscripten/cache/wasm-obj/libc_rt_wasm.a</span> <span style="color:#66d9ef">/Users/vasya/programs/emsdk/upstream/emscripten/cache/wasm-obj/libsockets.a</span> <span style="color:#66d9ef">--allow-undefined-file</span><span style="color:#f92672">=/</span><span style="color:#66d9ef">var</span><span style="color:#f92672">/</span>folders<span style="color:#f92672">/</span><span style="color:#ae81ff">5</span>x<span style="color:#f92672">/</span>jyhk_09s1m53tt41l55xtgmw0000gn<span style="color:#f92672">/</span>T<span style="color:#f92672">/</span>tmpf1nlw_dn<span style="color:#f92672">.</span>undefined <span style="color:#f92672">--</span>import<span style="color:#f92672">-</span>memory <span style="color:#f92672">--</span>import<span style="color:#f92672">-</span>table <span style="color:#f92672">-</span>mllvm <span style="color:#f92672">-</span>combiner<span style="color:#f92672">-</span>global<span style="color:#f92672">-</span>alias<span style="color:#f92672">-</span>analysis<span style="color:#66d9ef">=</span><span style="color:#66d9ef">false</span> <span style="color:#f92672">-</span>mllvm <span style="color:#f92672">-</span>enable<span style="color:#f92672">-</span>emscripten<span style="color:#f92672">-</span>sjlj <span style="color:#f92672">-</span>mllvm <span style="color:#f92672">-</span>disable<span style="color:#f92672">-</span>lsr <span style="color:#f92672">--</span>strip<span style="color:#f92672">-</span>debug <span style="color:#f92672">--</span>export <span style="color:#a6e22e">__wasm_call_ctors</span> <span style="color:#f92672">--</span>export <span style="color:#a6e22e">__data_end</span> <span style="color:#f92672">--</span>export main <span style="color:#f92672">--</span>export <span style="color:#a6e22e">__errno_location</span> <span style="color:#f92672">--</span>export fflush <span style="color:#f92672">--</span>export strstr <span style="color:#f92672">--</span>export <span style="color:#a6e22e">_get_environ</span> <span style="color:#f92672">--</span>export <span style="color:#a6e22e">_get_tzname</span> <span style="color:#f92672">--</span>export <span style="color:#a6e22e">_get_daylight</span> <span style="color:#f92672">--</span>export <span style="color:#a6e22e">_get_timezone</span> <span style="color:#f92672">--</span>export htonl <span style="color:#f92672">--</span>export strlen <span style="color:#f92672">-</span>z stack<span style="color:#f92672">-</span>size<span style="color:#66d9ef">=</span><span style="color:#ae81ff">5242880</span> <span style="color:#f92672">--</span>initial<span style="color:#f92672">-</span>memory<span style="color:#66d9ef">=</span><span style="color:#ae81ff">16777216</span> <span style="color:#f92672">--</span>no<span style="color:#f92672">-</span>entry <span style="color:#f92672">--</span>global<span style="color:#f92672">-</span>base<span style="color:#66d9ef">=</span><span style="color:#ae81ff">1024</span><span style="color:#960050;background-color:#1e0010">&#39;</span> failed <span style="color:#f92672">(</span><span style="color:#ae81ff">1</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>make<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">***</span> <span style="color:#f92672">[</span><span style="color:#66d9ef">color-corners.js</span><span style="color:#f92672">]</span> <span style="color:#a6e22e">Error</span> <span style="color:#ae81ff">1</span></span></span></code></pre></div>
<p>What did help is to set <code>-s ERROR_ON_UNDEFINED_SYMBOLS=0</code> instead. Then the build went fine, as those errors became warnings (<em>and so these symbols aren&rsquo;t actually needed?</em>):</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span>$ make <span style="color:#f92672">-</span>j12
</span></span><span style="display:flex;"><span>sed <span style="color:#f92672">-</span>e s<span style="color:#f92672">/@</span><span style="color:#a6e22e">APPNAME</span><span style="color:#f92672">@/</span>color<span style="color:#f92672">-</span>corners<span style="color:#f92672">/</span>g <span style="color:#f92672">/</span><span style="color:#a6e22e">Users</span><span style="color:#f92672">/</span>vasya<span style="color:#f92672">/</span>programs<span style="color:#f92672">/</span>qt<span style="color:#f92672">/</span><span style="color:#ae81ff">5152</span><span style="color:#f92672">-</span>wasm<span style="color:#f92672">/</span>plugins<span style="color:#f92672">/</span>platforms<span style="color:#f92672">/</span>wasm_shell<span style="color:#f92672">.</span>html <span style="color:#f92672">&gt;</span> <span style="color:#f92672">/</span><span style="color:#a6e22e">Users</span><span style="color:#f92672">/</span>vasya<span style="color:#f92672">/</span>code<span style="color:#f92672">/</span>qt<span style="color:#f92672">/</span>color<span style="color:#f92672">-</span>corners<span style="color:#f92672">/</span>build<span style="color:#f92672">/</span>color<span style="color:#f92672">-</span>corners<span style="color:#f92672">.</span>html
</span></span><span style="display:flex;"><span>cp <span style="color:#f92672">-</span>f <span style="color:#f92672">/</span><span style="color:#a6e22e">Users</span><span style="color:#f92672">/</span>vasya<span style="color:#f92672">/</span>programs<span style="color:#f92672">/</span>qt<span style="color:#f92672">/</span><span style="color:#ae81ff">5152</span><span style="color:#f92672">-</span>wasm<span style="color:#f92672">/</span>plugins<span style="color:#f92672">/</span>platforms<span style="color:#f92672">/</span>qtloader<span style="color:#f92672">.</span>js <span style="color:#f92672">/</span><span style="color:#a6e22e">Users</span><span style="color:#f92672">/</span>vasya<span style="color:#f92672">/</span>code<span style="color:#f92672">/</span>qt<span style="color:#f92672">/</span>color<span style="color:#f92672">-</span>corners<span style="color:#f92672">/</span>build
</span></span><span style="display:flex;"><span>cp <span style="color:#f92672">-</span>f <span style="color:#f92672">/</span><span style="color:#a6e22e">Users</span><span style="color:#f92672">/</span>vasya<span style="color:#f92672">/</span>programs<span style="color:#f92672">/</span>qt<span style="color:#f92672">/</span><span style="color:#ae81ff">5152</span><span style="color:#f92672">-</span>wasm<span style="color:#f92672">/</span>plugins<span style="color:#f92672">/</span>platforms<span style="color:#f92672">/</span>qtlogo<span style="color:#f92672">.</span>svg <span style="color:#f92672">/</span><span style="color:#a6e22e">Users</span><span style="color:#f92672">/</span>vasya<span style="color:#f92672">/</span>code<span style="color:#f92672">/</span>qt<span style="color:#f92672">/</span>color<span style="color:#f92672">-</span>corners<span style="color:#f92672">/</span>build
</span></span><span style="display:flex;"><span>em<span style="color:#f92672">++</span> <span style="color:#f92672">-</span>s <span style="color:#a6e22e">WASM</span><span style="color:#66d9ef">=</span><span style="color:#ae81ff">1</span> <span style="color:#f92672">-</span>s <span style="color:#a6e22e">FULL_ES2</span><span style="color:#66d9ef">=</span><span style="color:#ae81ff">1</span> <span style="color:#f92672">-</span>s <span style="color:#a6e22e">FULL_ES3</span><span style="color:#66d9ef">=</span><span style="color:#ae81ff">1</span> <span style="color:#f92672">-</span>s <span style="color:#a6e22e">USE_WEBGL2</span><span style="color:#66d9ef">=</span><span style="color:#ae81ff">1</span> <span style="color:#f92672">-</span>s <span style="color:#a6e22e">EXIT_RUNTIME</span><span style="color:#66d9ef">=</span><span style="color:#ae81ff">1</span> <span style="color:#f92672">-</span>s <span style="color:#a6e22e">ERROR_ON_UNDEFINED_SYMBOLS</span><span style="color:#66d9ef">=</span><span style="color:#ae81ff">1</span> <span style="color:#f92672">-</span>s <span style="color:#a6e22e">EXTRA_EXPORTED_RUNTIME_METHODS</span><span style="color:#f92672">=[</span><span style="color:#960050;background-color:#1e0010">&#34;</span><span style="color:#66d9ef">UTF16ToString</span><span style="color:#960050;background-color:#1e0010">&#34;</span>,<span style="color:#960050;background-color:#1e0010">&#34;</span><span style="color:#66d9ef">stringToUTF16</span><span style="color:#960050;background-color:#1e0010">&#34;</span><span style="color:#f92672">]</span> <span style="color:#f92672">--</span>bind <span style="color:#f92672">-</span>s <span style="color:#a6e22e">FETCH</span><span style="color:#66d9ef">=</span><span style="color:#ae81ff">1</span> <span style="color:#f92672">-</span>O2 <span style="color:#f92672">-</span>s <span style="color:#a6e22e">ALLOW_MEMORY_GROWTH</span><span style="color:#66d9ef">=</span><span style="color:#ae81ff">1</span> <span style="color:#f92672">-</span>s <span style="color:#a6e22e">ERROR_ON_UNDEFINED_SYMBOLS</span><span style="color:#66d9ef">=</span><span style="color:#ae81ff">0</span> <span style="color:#f92672">-</span>o <span style="color:#f92672">./</span>color<span style="color:#f92672">-</span>corners<span style="color:#f92672">.</span>js main<span style="color:#f92672">.</span>o color<span style="color:#f92672">-</span>corners<span style="color:#f92672">.</span>js_plugin_import<span style="color:#f92672">.</span>o color<span style="color:#f92672">-</span>corners<span style="color:#f92672">.</span>js_qml_plugin_import<span style="color:#f92672">.</span>o qrc_qml<span style="color:#f92672">.</span>o   <span style="color:#f92672">/</span><span style="color:#a6e22e">Users</span><span style="color:#f92672">/</span>vasya<span style="color:#f92672">/</span>programs<span style="color:#f92672">/</span>qt<span style="color:#f92672">/</span><span style="color:#ae81ff">5152</span><span style="color:#f92672">-</span>wasm<span style="color:#f92672">/</span>plugins<span style="color:#f92672">/</span>platforms<span style="color:#f92672">/</span>libqwasm<span style="color:#f92672">.</span>a <span style="color:#f92672">/</span><span style="color:#a6e22e">Users</span><span style="color:#f92672">/</span>vasya<span style="color:#f92672">/</span>programs<span style="color:#f92672">/</span>qt<span style="color:#f92672">/</span><span style="color:#ae81ff">5152</span><span style="color:#f92672">-</span>wasm<span style="color:#f92672">/</span>lib<span style="color:#f92672">/</span>libQt5EventDispatcherSupport<span style="color:#f92672">.</span>a <span style="color:#f92672">/</span><span style="color:#a6e22e">Users</span><span style="color:#f92672">/</span>vasya<span style="color:#f92672">/</span>programs<span style="color:#f92672">/</span>qt<span style="color:#f92672">/</span><span style="color:#ae81ff">5152</span><span style="color:#f92672">-</span>wasm<span style="color:#f92672">/</span>lib<span style="color:#f92672">/</span>libQt5FontDatabaseSupport<span style="color:#f92672">.</span>a <span style="color:#f92672">/</span><span style="color:#a6e22e">Users</span><span style="color:#f92672">/</span>vasya<span style="color:#f92672">/</span>programs<span style="color:#f92672">/</span>qt<span style="color:#f92672">/</span><span style="color:#ae81ff">5152</span><span style="color:#f92672">-</span>wasm<span style="color:#f92672">/</span>lib<span style="color:#f92672">/</span>libqtfreetype<span style="color:#f92672">.</span>a <span style="color:#f92672">/</span><span style="color:#a6e22e">Users</span><span style="color:#f92672">/</span>vasya<span style="color:#f92672">/</span>programs<span style="color:#f92672">/</span>qt<span style="color:#f92672">/</span><span style="color:#ae81ff">5152</span><span style="color:#f92672">-</span>wasm<span style="color:#f92672">/</span>lib<span style="color:#f92672">/</span>libQt5EglSupport<span style="color:#f92672">.</span>a <span style="color:#f92672">/</span><span style="color:#a6e22e">Users</span><span style="color:#f92672">/</span>vasya<span style="color:#f92672">/</span>programs<span style="color:#f92672">/</span>qt<span style="color:#f92672">/</span><span style="color:#ae81ff">5152</span><span style="color:#f92672">-</span>wasm<span style="color:#f92672">/</span>plugins<span style="color:#f92672">/</span>imageformats<span style="color:#f92672">/</span>libqgif<span style="color:#f92672">.</span>a <span style="color:#f92672">/</span><span style="color:#a6e22e">Users</span><span style="color:#f92672">/</span>vasya<span style="color:#f92672">/</span>programs<span style="color:#f92672">/</span>qt<span style="color:#f92672">/</span><span style="color:#ae81ff">5152</span><span style="color:#f92672">-</span>wasm<span style="color:#f92672">/</span>plugins<span style="color:#f92672">/</span>imageformats<span style="color:#f92672">/</span>libqicns<span style="color:#f92672">.</span>a <span style="color:#f92672">/</span><span style="color:#a6e22e">Users</span><span style="color:#f92672">/</span>vasya<span style="color:#f92672">/</span>programs<span style="color:#f92672">/</span>qt<span style="color:#f92672">/</span><span style="color:#ae81ff">5152</span><span style="color:#f92672">-</span>wasm<span style="color:#f92672">/</span>plugins<span style="color:#f92672">/</span>imageformats<span style="color:#f92672">/</span>libqico<span style="color:#f92672">.</span>a <span style="color:#f92672">/</span><span style="color:#a6e22e">Users</span><span style="color:#f92672">/</span>vasya<span style="color:#f92672">/</span>programs<span style="color:#f92672">/</span>qt<span style="color:#f92672">/</span><span style="color:#ae81ff">5152</span><span style="color:#f92672">-</span>wasm<span style="color:#f92672">/</span>plugins<span style="color:#f92672">/</span>imageformats<span style="color:#f92672">/</span>libqjpeg<span style="color:#f92672">.</span>a <span style="color:#f92672">/</span><span style="color:#a6e22e">Users</span><span style="color:#f92672">/</span>vasya<span style="color:#f92672">/</span>programs<span style="color:#f92672">/</span>qt<span style="color:#f92672">/</span><span style="color:#ae81ff">5152</span><span style="color:#f92672">-</span>wasm<span style="color:#f92672">/</span>plugins<span style="color:#f92672">/</span>imageformats<span style="color:#f92672">/</span>libqtga<span style="color:#f92672">.</span>a <span style="color:#f92672">/</span><span style="color:#a6e22e">Users</span><span style="color:#f92672">/</span>vasya<span style="color:#f92672">/</span>programs<span style="color:#f92672">/</span>qt<span style="color:#f92672">/</span><span style="color:#ae81ff">5152</span><span style="color:#f92672">-</span>wasm<span style="color:#f92672">/</span>plugins<span style="color:#f92672">/</span>imageformats<span style="color:#f92672">/</span>libqtiff<span style="color:#f92672">.</span>a <span style="color:#f92672">/</span><span style="color:#a6e22e">Users</span><span style="color:#f92672">/</span>vasya<span style="color:#f92672">/</span>programs<span style="color:#f92672">/</span>qt<span style="color:#f92672">/</span><span style="color:#ae81ff">5152</span><span style="color:#f92672">-</span>wasm<span style="color:#f92672">/</span>plugins<span style="color:#f92672">/</span>imageformats<span style="color:#f92672">/</span>libqwbmp<span style="color:#f92672">.</span>a <span style="color:#f92672">/</span><span style="color:#a6e22e">Users</span><span style="color:#f92672">/</span>vasya<span style="color:#f92672">/</span>programs<span style="color:#f92672">/</span>qt<span style="color:#f92672">/</span><span style="color:#ae81ff">5152</span><span style="color:#f92672">-</span>wasm<span style="color:#f92672">/</span>plugins<span style="color:#f92672">/</span>imageformats<span style="color:#f92672">/</span>libqwebp<span style="color:#f92672">.</span>a <span style="color:#f92672">/</span><span style="color:#a6e22e">Users</span><span style="color:#f92672">/</span>vasya<span style="color:#f92672">/</span>programs<span style="color:#f92672">/</span>qt<span style="color:#f92672">/</span><span style="color:#ae81ff">5152</span><span style="color:#f92672">-</span>wasm<span style="color:#f92672">/</span>qml<span style="color:#f92672">/</span><span style="color:#a6e22e">QtQuick</span><span style="color:#f92672">.</span><span style="color:#ae81ff">2</span><span style="color:#f92672">/</span>libqtquick2plugin<span style="color:#f92672">.</span>a <span style="color:#f92672">/</span><span style="color:#a6e22e">Users</span><span style="color:#f92672">/</span>vasya<span style="color:#f92672">/</span>programs<span style="color:#f92672">/</span>qt<span style="color:#f92672">/</span><span style="color:#ae81ff">5152</span><span style="color:#f92672">-</span>wasm<span style="color:#f92672">/</span>qml<span style="color:#f92672">/</span><span style="color:#a6e22e">QtQuick</span><span style="color:#f92672">/</span><span style="color:#a6e22e">Window</span><span style="color:#f92672">.</span><span style="color:#ae81ff">2</span><span style="color:#f92672">/</span>libwindowplugin<span style="color:#f92672">.</span>a <span style="color:#f92672">/</span><span style="color:#a6e22e">Users</span><span style="color:#f92672">/</span>vasya<span style="color:#f92672">/</span>programs<span style="color:#f92672">/</span>qt<span style="color:#f92672">/</span><span style="color:#ae81ff">5152</span><span style="color:#f92672">-</span>wasm<span style="color:#f92672">/</span>qml<span style="color:#f92672">/</span><span style="color:#a6e22e">QtQuick</span><span style="color:#f92672">/</span><span style="color:#a6e22e">Layouts</span><span style="color:#f92672">/</span>libqquicklayoutsplugin<span style="color:#f92672">.</span>a <span style="color:#f92672">/</span><span style="color:#a6e22e">Users</span><span style="color:#f92672">/</span>vasya<span style="color:#f92672">/</span>programs<span style="color:#f92672">/</span>qt<span style="color:#f92672">/</span><span style="color:#ae81ff">5152</span><span style="color:#f92672">-</span>wasm<span style="color:#f92672">/</span>lib<span style="color:#f92672">/</span>libQt5Quick<span style="color:#f92672">.</span>a <span style="color:#f92672">/</span><span style="color:#a6e22e">Users</span><span style="color:#f92672">/</span>vasya<span style="color:#f92672">/</span>programs<span style="color:#f92672">/</span>qt<span style="color:#f92672">/</span><span style="color:#ae81ff">5152</span><span style="color:#f92672">-</span>wasm<span style="color:#f92672">/</span>lib<span style="color:#f92672">/</span>libQt5Gui<span style="color:#f92672">.</span>a <span style="color:#f92672">/</span><span style="color:#a6e22e">Users</span><span style="color:#f92672">/</span>vasya<span style="color:#f92672">/</span>programs<span style="color:#f92672">/</span>qt<span style="color:#f92672">/</span><span style="color:#ae81ff">5152</span><span style="color:#f92672">-</span>wasm<span style="color:#f92672">/</span>lib<span style="color:#f92672">/</span>libqtlibpng<span style="color:#f92672">.</span>a <span style="color:#f92672">/</span><span style="color:#a6e22e">Users</span><span style="color:#f92672">/</span>vasya<span style="color:#f92672">/</span>programs<span style="color:#f92672">/</span>qt<span style="color:#f92672">/</span><span style="color:#ae81ff">5152</span><span style="color:#f92672">-</span>wasm<span style="color:#f92672">/</span>lib<span style="color:#f92672">/</span>libqtharfbuzz<span style="color:#f92672">.</span>a <span style="color:#f92672">/</span><span style="color:#a6e22e">Users</span><span style="color:#f92672">/</span>vasya<span style="color:#f92672">/</span>programs<span style="color:#f92672">/</span>qt<span style="color:#f92672">/</span><span style="color:#ae81ff">5152</span><span style="color:#f92672">-</span>wasm<span style="color:#f92672">/</span>qml<span style="color:#f92672">/</span><span style="color:#a6e22e">QtQml</span><span style="color:#f92672">/</span>libqmlplugin<span style="color:#f92672">.</span>a <span style="color:#f92672">/</span><span style="color:#a6e22e">Users</span><span style="color:#f92672">/</span>vasya<span style="color:#f92672">/</span>programs<span style="color:#f92672">/</span>qt<span style="color:#f92672">/</span><span style="color:#ae81ff">5152</span><span style="color:#f92672">-</span>wasm<span style="color:#f92672">/</span>qml<span style="color:#f92672">/</span><span style="color:#a6e22e">QtQml</span><span style="color:#f92672">/</span><span style="color:#a6e22e">Models</span><span style="color:#f92672">.</span><span style="color:#ae81ff">2</span><span style="color:#f92672">/</span>libmodelsplugin<span style="color:#f92672">.</span>a <span style="color:#f92672">/</span><span style="color:#a6e22e">Users</span><span style="color:#f92672">/</span>vasya<span style="color:#f92672">/</span>programs<span style="color:#f92672">/</span>qt<span style="color:#f92672">/</span><span style="color:#ae81ff">5152</span><span style="color:#f92672">-</span>wasm<span style="color:#f92672">/</span>lib<span style="color:#f92672">/</span>libQt5QmlModels<span style="color:#f92672">.</span>a <span style="color:#f92672">/</span><span style="color:#a6e22e">Users</span><span style="color:#f92672">/</span>vasya<span style="color:#f92672">/</span>programs<span style="color:#f92672">/</span>qt<span style="color:#f92672">/</span><span style="color:#ae81ff">5152</span><span style="color:#f92672">-</span>wasm<span style="color:#f92672">/</span>lib<span style="color:#f92672">/</span>libQt5Qml<span style="color:#f92672">.</span>a <span style="color:#f92672">/</span><span style="color:#a6e22e">Users</span><span style="color:#f92672">/</span>vasya<span style="color:#f92672">/</span>programs<span style="color:#f92672">/</span>qt<span style="color:#f92672">/</span><span style="color:#ae81ff">5152</span><span style="color:#f92672">-</span>wasm<span style="color:#f92672">/</span>lib<span style="color:#f92672">/</span>libQt5Network<span style="color:#f92672">.</span>a <span style="color:#f92672">/</span><span style="color:#a6e22e">Users</span><span style="color:#f92672">/</span>vasya<span style="color:#f92672">/</span>programs<span style="color:#f92672">/</span>qt<span style="color:#f92672">/</span><span style="color:#ae81ff">5152</span><span style="color:#f92672">-</span>wasm<span style="color:#f92672">/</span>lib<span style="color:#f92672">/</span>libQt5Core<span style="color:#f92672">.</span>a <span style="color:#f92672">/</span><span style="color:#a6e22e">Users</span><span style="color:#f92672">/</span>vasya<span style="color:#f92672">/</span>programs<span style="color:#f92672">/</span>qt<span style="color:#f92672">/</span><span style="color:#ae81ff">5152</span><span style="color:#f92672">-</span>wasm<span style="color:#f92672">/</span>lib<span style="color:#f92672">/</span>libqtpcre2<span style="color:#f92672">.</span>a
</span></span><span style="display:flex;"><span>warning<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">undefined</span> <span style="color:#66d9ef">symbol:</span> <span style="color:#66d9ef">_</span><span style="color:#66d9ef">ZN3JSC4Yarr12digitsCreateEv</span>
</span></span><span style="display:flex;"><span>warning<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">undefined</span> <span style="color:#66d9ef">symbol:</span> <span style="color:#66d9ef">_</span><span style="color:#66d9ef">ZN3JSC4Yarr12spacesCreateEv</span>
</span></span><span style="display:flex;"><span>warning<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">undefined</span> <span style="color:#66d9ef">symbol:</span> <span style="color:#66d9ef">_</span><span style="color:#66d9ef">ZN3JSC4Yarr13newlineCreateEv</span>
</span></span><span style="display:flex;"><span>warning<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">undefined</span> <span style="color:#66d9ef">symbol:</span> <span style="color:#66d9ef">_</span><span style="color:#66d9ef">ZN3JSC4Yarr14wordcharCreateEv</span>
</span></span><span style="display:flex;"><span>warning<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">undefined</span> <span style="color:#66d9ef">symbol:</span> <span style="color:#66d9ef">_</span><span style="color:#66d9ef">ZN3JSC4Yarr15nondigitsCreateEv</span>
</span></span><span style="display:flex;"><span>warning<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">undefined</span> <span style="color:#66d9ef">symbol:</span> <span style="color:#66d9ef">_</span><span style="color:#66d9ef">ZN3JSC4Yarr15nonspacesCreateEv</span>
</span></span><span style="display:flex;"><span>warning<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">undefined</span> <span style="color:#66d9ef">symbol:</span> <span style="color:#66d9ef">_</span><span style="color:#66d9ef">ZN3JSC4Yarr17nonwordcharCreateEv</span>
</span></span><span style="display:flex;"><span>warning<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">undefined</span> <span style="color:#66d9ef">symbol:</span> <span style="color:#66d9ef">_</span><span style="color:#66d9ef">ZN3JSC4Yarr31wordUnicodeIgnoreCaseCharCreateEv</span>
</span></span><span style="display:flex;"><span>warning<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">undefined</span> <span style="color:#66d9ef">symbol:</span> <span style="color:#66d9ef">_</span><span style="color:#66d9ef">ZN3JSC4Yarr34nonwordUnicodeIgnoreCaseCharCreateEv</span></span></span></code></pre></div>
<p>So, what have we built:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span>$ ls <span style="color:#f92672">-</span>l <span style="color:#f92672">|</span> awk <span style="color:#960050;background-color:#1e0010">&#39;</span><span style="color:#f92672">{</span>print $9 <span style="color:#e6db74">&#34; | &#34;</span> $5<span style="color:#f92672">}</span><span style="color:#960050;background-color:#1e0010">&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">Makefile</span> <span style="color:#f92672">|</span> <span style="color:#ae81ff">56</span>K
</span></span><span style="display:flex;"><span>color<span style="color:#f92672">-</span>corners<span style="color:#f92672">.</span>html <span style="color:#f92672">|</span> <span style="color:#ae81ff">3.2</span>K
</span></span><span style="display:flex;"><span>color<span style="color:#f92672">-</span>corners<span style="color:#f92672">.</span>js <span style="color:#f92672">|</span> <span style="color:#ae81ff">327</span>K
</span></span><span style="display:flex;"><span>color<span style="color:#f92672">-</span>corners<span style="color:#f92672">.</span>js_plugin_import<span style="color:#f92672">.</span>cpp <span style="color:#f92672">|</span> <span style="color:#ae81ff">449</span>B
</span></span><span style="display:flex;"><span>color<span style="color:#f92672">-</span>corners<span style="color:#f92672">.</span>js_plugin_import<span style="color:#f92672">.</span>o <span style="color:#f92672">|</span> <span style="color:#ae81ff">1.2</span>K
</span></span><span style="display:flex;"><span>color<span style="color:#f92672">-</span>corners<span style="color:#f92672">.</span>js_qml_plugin_import<span style="color:#f92672">.</span>cpp <span style="color:#f92672">|</span> <span style="color:#ae81ff">308</span>B
</span></span><span style="display:flex;"><span>color<span style="color:#f92672">-</span>corners<span style="color:#f92672">.</span>js_qml_plugin_import<span style="color:#f92672">.</span>o <span style="color:#f92672">|</span> <span style="color:#ae81ff">943</span>B
</span></span><span style="display:flex;"><span>color<span style="color:#f92672">-</span>corners<span style="color:#f92672">.</span>wasm <span style="color:#f92672">|</span> <span style="color:#ae81ff">16</span>M
</span></span><span style="display:flex;"><span>main<span style="color:#f92672">.</span>o <span style="color:#f92672">|</span> <span style="color:#ae81ff">1.3</span>K
</span></span><span style="display:flex;"><span>qrc_qml<span style="color:#f92672">.</span>cpp <span style="color:#f92672">|</span> <span style="color:#ae81ff">5.3</span>K
</span></span><span style="display:flex;"><span>qrc_qml<span style="color:#f92672">.</span>o <span style="color:#f92672">|</span> <span style="color:#ae81ff">1.8</span>K
</span></span><span style="display:flex;"><span>qtloader<span style="color:#f92672">.</span>js <span style="color:#f92672">|</span> <span style="color:#ae81ff">21</span>K
</span></span><span style="display:flex;"><span>qtlogo<span style="color:#f92672">.</span>svg <span style="color:#f92672">|</span> <span style="color:#ae81ff">3.0</span>K</span></span></code></pre></div>
<p>Host that with a web-server and open <code>/color-corners.html</code>:</p>






    <video  controls="yes"   class="video">
        <source src="/blog/2021/08/29/qt-webassembly-custom-opengl/video/color-corners-wasm.mp4" type="video/mp4">
    </video>
    
    <p class="video-fallback">If video doesnt play in your browser, you can download it <a href="/blog/2021/08/29/qt-webassembly-custom-opengl/video/color-corners-wasm.mp4">here</a></p>
    


<p>Omg, it really works!</p>
<h1 id="custom-opengl-via-qquickframebufferobject">Custom OpenGL via QQuickFramebufferObject</h1>
<p>As I said in the beginning, it all started with a request from a user, who wanted to run our visualization engine in a Qt Quick application inside a browser as WebAssembly.</p>
<p>They would be okay with Qt Widgets too, but <a href="https://doc.qt.io/qt-5/qopenglwidget.html">QOpenGLWidget</a> does not work in WebAssembly <a href="https://bugreports.qt.io/browse/QTBUG-66944">yet</a> (<em>reported more than 3 years ago</em>), so the other alternative is <a href="https://doc.qt.io/qt-5/qquickframebufferobject.html">QQuickFramebufferObject</a>, which means a Qt Quick application.</p>
<p>Well, actually, looking at this <a href="https://www.qt.io/blog/2015/05/11/integrating-custom-opengl-rendering-with-qt-quick-via-qquickframebufferobject">blog post</a>, it <a href="https://code.qt.io/cgit/qt/qtdeclarative.git/tree/examples/quick/quickwidgets/qquickviewcomparison">might be</a> still possible to have a Qt Widgets application, which would have a <a href="https://doc.qt.io/qt-5/qquickwidget.html">QQuickWidget</a>, which would contain a QQuickFramebufferObject, which would be a host for your custom OpenGL, but I haven&rsquo;t researched that possibility yet. Although, looking at <a href="https://bugreports.qt.io/browse/QTBUG-88160">this bugreport</a>, it seems to be coming down to QOpenGLWidget again, so likely that approach won&rsquo;t work either.</p>
<p>But anyway, Qt Quick application will do just fine. I took one of the samples that we have for Qt Quick and built it in the same manner as Color Corners application <a href="#building-a-qt-application-for-webassembly">above</a>.</p>
<p>It built fine, but when I tried to run it in a browser, it had the Qt Quick UI controls, but the scene/canvas was empty (<em>although with a right clear color</em>), and there was this error in the browser console in Firefox:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>Loading Worker from http://localhost:8000/worker.js was blocked because of a disallowed MIME type <span style="color:#f92672">(</span>text/html<span style="color:#f92672">)</span>.</span></span></code></pre></div>
<p>or simply this one in Chromium:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>GET http://localhost:8000/worker.js <span style="color:#ae81ff">404</span> <span style="color:#f92672">(</span>File not found<span style="color:#f92672">)</span></span></span></code></pre></div>
<p>That&rsquo;s because I forgot to copy our engine&rsquo;s JS runtime (<code>worker.js</code>) to the build folder. After I did that, I got a different error in Firefox:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span><span style="color:#a6e22e">RuntimeError</span><span style="color:#66d9ef">:</span> <span style="color:#66d9ef">abort</span><span style="color:#f92672">(</span><span style="color:#66d9ef">CompileError:</span> <span style="color:#66d9ef">wasm</span> <span style="color:#66d9ef">validation</span> <span style="color:#66d9ef">error:</span> <span style="color:#66d9ef">at</span> <span style="color:#66d9ef">offset</span> <span style="color:#960050;background-color:#1e0010">4</span><span style="color:#66d9ef">:</span> <span style="color:#66d9ef">failed</span> <span style="color:#66d9ef">to</span> <span style="color:#66d9ef">match</span> <span style="color:#66d9ef">magic</span> <span style="color:#66d9ef">number</span><span style="color:#f92672">)</span> <span style="color:#66d9ef">at</span> <span style="color:#66d9ef">jsStackTrace@http://localhost:</span><span style="color:#960050;background-color:#1e0010">8000</span><span style="color:#66d9ef">/worker.js</span></span></span></code></pre></div>
<p>or this one in Chromium:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span><span style="color:#a6e22e">Uncaught</span> <span style="color:#f92672">(</span>in promise<span style="color:#f92672">)</span> <span style="color:#a6e22e">RuntimeError</span><span style="color:#66d9ef">:</span> <span style="color:#66d9ef">abort</span><span style="color:#f92672">(</span><span style="color:#66d9ef">CompileError:</span> <span style="color:#66d9ef">WebAssembly.instantiate</span><span style="color:#f92672">()</span><span style="color:#66d9ef">:</span> <span style="color:#66d9ef">expected</span> <span style="color:#66d9ef">magic</span> <span style="color:#66d9ef">word</span> <span style="color:#960050;background-color:#1e0010">00</span> <span style="color:#960050;background-color:#1e0010">61</span> <span style="color:#960050;background-color:#1e0010">73</span> <span style="color:#960050;background-color:#1e0010">6</span><span style="color:#66d9ef">d</span><span style="color:#f92672">,</span> <span style="color:#66d9ef">found</span> <span style="color:#960050;background-color:#1e0010">3</span><span style="color:#66d9ef">c</span> <span style="color:#960050;background-color:#1e0010">21</span> <span style="color:#960050;background-color:#1e0010">44</span> <span style="color:#960050;background-color:#1e0010">4</span><span style="color:#66d9ef">f</span> <span style="color:#66d9ef">@+</span><span style="color:#960050;background-color:#1e0010">0</span><span style="color:#f92672">)</span></span></span></code></pre></div>
<p>That, as I figured from a <a href="https://github.com/WebAssembly/spec/issues/1031">similar issue</a>, was because I also forgot to copy the actual WebAssembly build of our engine, and so application tried to fetch it and got 404 error from the web-server, which was an HTML document starting with <code>&lt;!DOCTYPE HTML...</code>, and so <code>3c21 444f</code> is exactly this sequence of symbols: <code>&lt;!DO</code>. And if you open any <code>.wasm</code> file in a HEX viewer, you&rsquo;ll see, that <a href="https://developer.mozilla.org/en-US/docs/WebAssembly/Understanding_the_text_format#the_simplest_module">it starts</a> with <code>0061 736d</code>. So I copied the missing WASM to the build folder too and reloaded the page:</p>






    <video  controls="yes"   class="video">
        <source src="/blog/2021/08/29/qt-webassembly-custom-opengl/video/qt-wasm-custom-opengl.mp4" type="video/mp4">
    </video>
    
    <p class="video-fallback">If video doesnt play in your browser, you can download it <a href="/blog/2021/08/29/qt-webassembly-custom-opengl/video/qt-wasm-custom-opengl.mp4">here</a></p>
    


<p>Holly shit, that works too! So it&rsquo;s our OpenGL-enabled visualization engine, written in C++, rendering in OpenGL context, which is created by QQuickFramebufferObject, part of a Qt Quick application, compiled to WebAssembly and running inside Mozilla Firefox web-browser. Fuck me.</p>
<h2 id="drawbacks">Drawbacks</h2>
<p>While the current state of things is quite exciting already, not everything is quite awesome yet.</p>
<p>Looking at the last video, you might&rsquo;ve noticed that VLC cones are all black. That is wrong, because actually they should have textures. Here&rsquo;s a screenshot of the same scene in a simpler application without Qt - bare HTML5 canvas and WebGL, also compiled to WebAssembly and running in the same browser:</p>


    <img class="image-post" loading="lazy" src="/blog/2021/08/29/qt-webassembly-custom-opengl/images/wasm-webgl-gltf-textures.jpg" alt="WASM WebGL glTF textures">

<p>Another problem I noticed is that applying certain visual effects, such as ambient occlusion, results in the scene simply being filled with solid black color, so apparently there are some issues with shaders or whatnot. And so it&rsquo;s quite likely that other issues like that will be discovered going forward. For the record, the very same Qt application built for desktop target doesn&rsquo;t have any of these problems.</p>
<p>So I can&rsquo;t say that I would recommend Qt for WebAssembly as a target platform to our users at the moment. But like I said, all the issues I&rsquo;ve stumbled upon so far were related to rendering in QQuickFramebufferObject, which definitely is not a very common use-case.</p>
<p>Overall, it&rsquo;s really fascinating that the whole thing works at all, and with a decent performance too. I honestly did not expect much, except for maybe lots of troubles building and setting things up, but even that worked just fine almost out of the box.</p>
<p>What I would recommend to everyone else is to try building your Qt-based application for WebAssembly and see for yourself how it works.</p>
      </div>
    </article>
    <div><div id="tags">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tag">
  <path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path><line x1="7" y1="7" x2="7" y2="7"></line>
</svg>
          <a class="tag" href="https://retifrav.github.io/tags/qt/">qt</a><a class="tag" href="https://retifrav.github.io/tags/web/">web</a></div><hr class="comments-divider"/>
      <div id="comments">
      
          <div style="border:2px orange solid; background-color: floralwhite; border-radius:0.5rem; padding: 10px 14px; font-style:italic; font-size:0.9em;">
              If you'd like to comment the article, you can do it on the
              <a href="https://decovar.dev/blog/2021/08/29/qt-webassembly-custom-opengl/#remark42" style="font-weight:bold;">
                  original website</a>. This one is just a mirror without comments.
          </div>
      
      </div>
    </div>
  </div>

        <div id="footer">
          <div>
              2014 - 2023,
              <a href="/about/">retif</a>
          </div>
          <div><a href="/about/#licenses">CC BY-SA 4.0 / GPLv3</a></div>
        </div>
      </main>
      <div class="app-header">
        <div style="margin:0 0 20px;">
            <input id="search-query" placeholder="Search in titles and summaries" />
        </div>
        <div id="search-results" style="display:none;"></div>
        <div id="sidebars">
            <a id="avatar" href="/about"><img class="app-header-avatar" src="/images/avatar.png" /></a>
            <iframe src="https://github.com/sponsors/retifrav/button"
                height="35" style="border:0;"
                title="You can sponsor me">
            </iframe>
            
            <div class="sidebar-section">
              <h3>Feeds</h3>
              <a href="/index.xml" title="Subscribe to RSS"><img src="/images/rss.png" width="50px"></a>
              <a style="margin-left: 5px;" href="https://t.me/decovar" title="Telegram channel"><img src="/images/telegram.png" width="50px"></a>
            </div>
            <div id="telegramWidgetBlock" class="sidebar-section"></div>
            <div class="sidebar-section">
                <h3>Stuff</h3>
                <ul class="sidebar-list">
                    <li><a href="/stuff/kakoi-jvotne-vi-kysaiti/index.html">   ?</a></li>
                </ul>
            </div>
            <div id="social-networks" class="sidebar-section">
              <h3>Social networks</h3>
              <div style="font-family:Courier New;">
                  Zuck: <i>Yeah so if you ever need info about anyone at Harvard</i><br/>
                  Zuck: <i>Just ask</i><br/>
                  Zuck: <i>I have over 4,000 emails, pictures, addresses, SNS</i><br/>
                  smb: <i>What? How'd you manage that one?</i><br/>
                  Zuck: <i>People just submitted it.</i><br/>
                  Zuck: <i>I don't know why.</i><br/>
                  Zuck: <i>They "trust me"</i><br/>
                  Zuck: <i>Dumb fucks</i>
              </div>
            </div>
            <div class="sidebar-section">
              <h3>Tags</h3>
              <ul style="list-style-type:none; padding:0; margin:0;">
                  
                  <li><a href="/tags/web">web (65)</a></li>
                  
                  <li><a href="/tags/fail">fail (39)</a></li>
                  
                  <li><a href="/tags/dotnet">dotnet (36)</a></li>
                  
                  <li><a href="/tags/qt">qt (34)</a></li>
                  
                  <li><a href="/tags/review">review (28)</a></li>
                  
                  <li><a href="/tags/linux">linux (26)</a></li>
                  
                  <li><a href="/tags/devops">devops (23)</a></li>
                  
                  <li><a href="/tags/macos">macos (23)</a></li>
                  
                  <li><a href="/tags/windows">windows (19)</a></li>
                  
                  <li><a href="/tags/mestuff">mestuff (17)</a></li>
                  
                  <li><a href="/tags/movies">movies (15)</a></li>
                  
                  <li><a href="/tags/tractor">tractor (15)</a></li>
                  
                  <li><a href="/tags/norway">norway (14)</a></li>
                  
                  <li><a href="/tags/irl">irl (12)</a></li>
                  
                  <li><a href="/tags/python">python (12)</a></li>
                  
                  <li><a href="/tags/telegram">telegram (12)</a></li>
                  
                  <li><a href="/tags/embedded">embedded (11)</a></li>
                  
                  <li><a href="/tags/soft">soft (10)</a></li>
                  
                  <li><a href="/tags/travel">travel (10)</a></li>
                  
                  <li><a href="/tags/applescript">applescript (9)</a></li>
                  
                  <li><a href="/tags/piracy">piracy (9)</a></li>
                  
                  <li><a href="/tags/cmake">cmake (8)</a></li>
                  
                  <li><a href="/tags/cpp">cpp (8)</a></li>
                  
                  <li><a href="/tags/octopress">octopress (8)</a></li>
                  
                  <li><a href="/tags/banks">banks (7)</a></li>
                  
                  <li><a href="/tags/games">games (7)</a></li>
                  
                  <li><a href="/tags/ios">ios (7)</a></li>
                  
                  <li><a href="/tags/apple">apple (6)</a></li>
                  
                  <li><a href="/tags/javascript">javascript (6)</a></li>
                  
                  <li><a href="/tags/photo">photo (6)</a></li>
                  
                  <li><a href="/tags/sql">sql (6)</a></li>
                  
                  <li><a href="/tags/russia">russia (5)</a></li>
                  
                  <li><a href="/tags/hugo">hugo (4)</a></li>
                  
                  <li><a href="/tags/usa">usa (4)</a></li>
                  
                  <li><a href="/tags/wordpress">wordpress (4)</a></li>
                  
                  <li><a href="/tags/android">android (3)</a></li>
                  
                  <li><a href="/tags/azure">azure (3)</a></li>
                  
                  <li><a href="/tags/tv">tv (3)</a></li>
                  
                  <li><a href="/tags/privacy">privacy (2)</a></li>
                  
                  <li><a href="/tags/tvos">tvos (2)</a></li>
                  
                  <li><a href="/tags/unsolved">unsolved (2)</a></li>
                  
                  <li><a href="/tags/books">books (1)</a></li>
                  
                  <li><a href="/tags/ffmpeg">ffmpeg (1)</a></li>
                  
                  <li><a href="/tags/ldap">ldap (1)</a></li>
                  
                  <li><a href="/tags/music">music (1)</a></li>
                  
                  <li><a href="/tags/science">science (1)</a></li>
                  
                  <li><a href="/tags/vr">vr (1)</a></li>
                  
              </ul>
            </div>
        </div>
      </header>
    </div>

    <script src="/js/search.js"></script>

    
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-53340325-1"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag() { dataLayer.push(arguments); }
      gtag("js", new Date());
      gtag("config", "UA-53340325-1");
    </script>

    <script>
        const telegramBlock = document.getElementById("telegramWidgetBlock");
        window.onload = () =>
        {
            const pinnedTelegramPosts = [319]
            const randomedPostID = pinnedTelegramPosts[
                Math.floor(Math.random() * pinnedTelegramPosts.length)
            ];
            const telegramWidgetScript = document.createElement("script");
            telegramWidgetScript.src = "https://telegram.org/js/telegram-widget.js?21";
            telegramWidgetScript.dataset["telegramPost"] = `decovar/${randomedPostID}`;
            telegramWidgetScript.dataset["color"] = "1E8448";
            telegramWidgetScript.dataset["width"] = "100%";
            telegramWidgetScript.dataset["userpic"] = "false";
            telegramBlock.appendChild(telegramWidgetScript);
        }
    </script>

    
    
  </body>
</html>
