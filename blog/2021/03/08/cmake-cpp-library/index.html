<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Creating a C&#43;&#43; library with CMake | Declaration of VAR</title>
    <link rel="canonical" href="https://decovar.dev/blog/2021/03/08/cmake-cpp-library/" />

    <meta name="generator" content="Hugo" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <link href="/favicon.png" rel="icon">

    <meta name="author" content="retif" />
    <meta name="description" content="" />

    <link rel="alternate" type="application/rss+xml" href="/index.xml" title="Declaration of VAR" />

    <meta property="og:url" content="https://retifrav.github.io/blog/2021/03/08/cmake-cpp-library/">
  <meta property="og:site_name" content="Declaration of VAR">
  <meta property="og:title" content="Creating a C&#43;&#43; library with CMake">
  <meta property="og:description" content="All of the sudden I found myself in a situation that I have been successfully avoiding so far - I needed to make a C&#43;&#43; library with CMake.
To clarify, this will be about so-called normal kind of library. And right away, the picture above shows a bad example of naming a library, because there should be no lib neither in the beginning nor in the end of the library name.">
  <meta property="og:locale" content="en_us">
  <meta property="og:type" content="article">
    <meta property="article:section" content="blog">
    <meta property="article:published_time" content="2021-03-08T20:41:56+01:00">
    <meta property="article:modified_time" content="2021-03-08T20:41:56+01:00">
    <meta property="article:tag" content="Cmake">
    <meta property="article:tag" content="Cpp">


    <link rel="stylesheet" href="https://retifrav.github.io/css/main.min.2a28493e0b91076cde9fb52cb7fec81f63f685a6965e6a9df1179ec846b9141f.css" />
    <link rel="stylesheet" href="/css/default.css" />
    <link rel="stylesheet" href="/css/post.css" />
    <link rel="stylesheet" href="/css/page.css" />
    <link rel="stylesheet" href="/css/comments.css" />

    <script src="/js/mark.js"></script>

    
    
  </head>
  <body>
    <div id="body-hat">
      <div id="title-block">
        <h1 id="blog-title"><a href="/">Declaration of VAR</a></h1>
        <p>and some other stuff</p>
      </div>
    </div>
    <div style="background-color:orange; padding:4px 16px; font-size:0.8em; text-align:center; font-style:italic;">
        On 19.05.2021 the website was moved to
        <a href="https://decovar.dev/blog/2021/03/08/cmake-cpp-library/" style="color:black; font-weight:bold;">
            https://decovar.dev/</a>. This is just a mirror now.
    </div>
    <div id="body-flex">
      <main class="app-container">
        
  <div id="main-container">
    <article class="post">
      <header class="post-header">
        <h1 class ="post-title">Creating a C&#43;&#43; library with CMake</h1>
        <div class="post-meta">
          <div><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-calendar">
  <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line>
</svg> 2021-03-08 20:41:56 &#43;0100</div>
          <div><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-clock">
  <circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline>
</svg> 26 min read</div>
        </div>
      </header>
      <div class="post-content">
        <p>All of the sudden I found myself in a situation that I have been successfully avoiding so far - I needed to make a C++ library with CMake.</p>


    <img class="image-post" loading="lazy" src="/blog/2021/03/08/cmake-cpp-library/images/cmake-library.png" alt="CMake and a library">

<p>To clarify, this will be about so-called <a href="https://cmake.org/cmake/help/latest/command/add_library.html#normal-libraries">normal</a> kind of library. And right away, the picture above shows a bad example of <a href="#name-without-lib-prefixpostfix">naming a library</a>, because there should be no <code>lib</code> neither in the beginning nor in the end of the library name.</p>
<nav id="TableOfContents">
  <ul>
    <li><a href="#the-library">The library</a>
      <ul>
        <li><a href="#folder-structure-and-sources">Folder structure and sources</a></li>
        <li><a href="#cmakelists">CMakeLists</a>
          <ul>
            <li><a href="#top-level-and-nested-projects">Top-level and nested projects</a></li>
            <li><a href="#target">Target</a>
              <ul>
                <li><a href="#name-without-lib-prefixpostfix">Name without lib prefix/postfix</a></li>
              </ul>
            </li>
            <li><a href="#include-directories">Include directories</a></li>
            <li><a href="#install-instructions">Install instructions</a>
              <ul>
                <li><a href="#installation-path">Installation path</a></li>
                <li><a href="#public-headers">Public headers</a></li>
                <li><a href="#debug-suffix">Debug suffix</a></li>
                <li><a href="#destinations">Destinations</a></li>
                <li><a href="#configs">Configs</a></li>
              </ul>
            </li>
          </ul>
        </li>
        <li><a href="#building-and-installing">Building and installing</a>
          <ul>
            <li><a href="#cmake-generators">CMake generators</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#linking-to-the-library">Linking to the library</a>
      <ul>
        <li><a href="#from-external-project">From external project</a>
          <ul>
            <li><a href="#no-need-to-set-include_directories-and-use-magic-variables">No need to set include_directories and use magic variables</a></li>
          </ul>
        </li>
        <li><a href="#from-internal-top-level-project">From internal top-level project</a>
          <ul>
            <li><a href="#adding-nested-library-to-the-main-project">Adding nested library to the main project</a></li>
            <li><a href="#about-include-paths">About include paths</a></li>
            <li><a href="#building">Building</a>
              <ul>
                <li><a href="#main-project">Main project</a></li>
                <li><a href="#library-as-a-target">Library as a target</a></li>
              </ul>
            </li>
          </ul>
        </li>
        <li><a href="#static-vs-shared">STATIC vs SHARED</a>
          <ul>
            <li><a href="#shared-dll-on-windows">SHARED DLL on Windows</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#final-words-and-repository">Final words and repository</a></li>
    <li><a href="#updates">Updates</a>
      <ul>
        <li><a href="#2022-07-05--updated-repository">2022-07-05 | Updated repository</a></li>
        <li><a href="#2022-09-17--dynamic-libraries-and-paths">2022-09-17 | Dynamic libraries and paths</a></li>
        <li><a href="#2023-07-22--about-target_link_libraries-scopes">2023-07-22 | About target_link_libraries() scopes</a></li>
      </ul>
    </li>
  </ul>
</nav>
<h1 id="the-library">The library</h1>
<h2 id="folder-structure-and-sources">Folder structure and sources</h2>
<p>For the sake of focusing on CMake side of things, the library itself is very trivial:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>├── CMakeLists.txt
</span></span><span style="display:flex;"><span>├── include
</span></span><span style="display:flex;"><span>│   └── some.h
</span></span><span style="display:flex;"><span>└── src
</span></span><span style="display:flex;"><span>    ├── some.cpp
</span></span><span style="display:flex;"><span>    └── things.h</span></span></code></pre></div>
<p>This particular folder structure is not enforced, but I&rsquo;ve seen it being used around and I think it serves nicely for the purpose of keeping library files organized. Following this structure, you put internal library sources and headers to <code>src</code> folder, and public headers go to <code>include</code> folder. <a href="http://www.open-std.org/jtc1/sc22/wg21/docs/papers/2018/p1204r0.html#src-dir">This article</a>, however, lists a few disadvantages of such approach.</p>
<p>Public headers is something other projects will use to interface with your library. That is how they will know what functions are available in it and what is their signature (<em>parameters names and types</em>). So, <code>include/some.h</code> is a public header, and here are its contents:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#75715e">#ifndef SOME_H
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define SOME_H
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">namespace</span> sm
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">namespace</span> lbr
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">printSomething</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#endif </span><span style="color:#75715e">// SOME_H
</span></span></span></code></pre></div>
<p>So our library has just one function. Its definition is in <code>src/some.cpp</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;iostream&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&#34;things.h&#34;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">namespace</span> sm
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">namespace</span> lbr
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">printSomething</span>()
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            std<span style="color:#f92672">::</span>cout <span style="color:#f92672">&lt;&lt;</span> <span style="color:#e6db74">&#34;ololo, &#34;</span> <span style="color:#f92672">&lt;&lt;</span> someString <span style="color:#f92672">&lt;&lt;</span> std<span style="color:#f92672">::</span>endl;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div>
<p>As you can see, this function just prints a message to standard output. The <code>someString</code> variable comes from internal header <code>src/things.h</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;string&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">const</span> std<span style="color:#f92672">::</span>string someString <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;some string&#34;</span>;</span></span></code></pre></div>
<h2 id="cmakelists">CMakeLists</h2>
<p>Making a library with CMake is not that different from making an application - instead of <a href="https://cmake.org/cmake/help/latest/command/add_executable.html">add_executable</a> you call <a href="https://cmake.org/cmake/help/latest/command/add_library.html">add_library</a>. But doing just that would be too easy, wouldn&rsquo;t it.</p>
<p>Here are some of the things you need to take care of:</p>
<ul>
<li>what artifacts should the library produce at install step</li>
<li>where install artifacts should be placed</li>
<li>how other applications can find the library
<ul>
<li>when they are using it pre-built as an external dependency</li>
<li>when its sources are nested in their source tree</li>
</ul>
</li>
<li>will it be static or shared library
<ul>
<li>will you need to have it as DLL on Windows</li>
</ul>
</li>
</ul>
<p>Everything from this list is handled by CMake. So let&rsquo;s gradually create a <code>CMakeLists.txt</code> for the library project.</p>
<h3 id="top-level-and-nested-projects">Top-level and nested projects</h3>
<p>In CMake projects there is a variable called <a href="https://cmake.org/cmake/help/latest/variable/CMAKE_PROJECT_NAME.html">CMAKE_PROJECT_NAME</a>. It stores the top-level project name that you set with <a href="https://cmake.org/cmake/help/latest/command/project.html">project</a> command. This variable persists across all the nested projects, and so calling <code>project</code> command from nested projects will not change <code>CMAKE_PROJECT_NAME</code>, but will set another variable called <a href="https://cmake.org/cmake/help/latest/variable/PROJECT_NAME.html">PROJECT_NAME</a>.</p>
<p>Knowing that, here&rsquo;s how you can check if you are in the top-level project or not:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cmake" data-lang="cmake"><span style="display:flex;"><span>project(<span style="color:#e6db74">&#34;SomeLibrary&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># ...
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>if (<span style="color:#e6db74">NOT</span> <span style="color:#e6db74">CMAKE_PROJECT_NAME</span> <span style="color:#e6db74">STREQUAL</span> <span style="color:#e6db74">PROJECT_NAME</span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>    message(<span style="color:#e6db74">STATUS</span> <span style="color:#e6db74">&#34;This project has a top-level one called [${CMAKE_PROJECT_NAME}]&#34;</span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>else()<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>    message(<span style="color:#e6db74">STATUS</span> <span style="color:#e6db74">&#34;This project is a top-level one&#34;</span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>endif()</span></span></code></pre></div>
<p>Later CMake versions added a <a href="https://cmake.org/cmake/help/latest/variable/PROJECT_IS_TOP_LEVEL.html">PROJECT_IS_TOP_LEVEL</a> variable, which might be more convenient.</p>
<p>Why even bother with this? Because later we will be setting certain properties for the <a href="#target">target</a> (<em>our library</em>). And I saw in lots of places how people copy-paste project name value to every command, which I believe is just a bad idea - it is much better to use already defined <code>PROJECT_NAME</code> variable instead, innit.</p>
<h3 id="target">Target</h3>
<p>Here goes the library <a href="https://cmake.org/cmake/help/latest/manual/cmake-buildsystem.7.html#introduction">target</a> and its sources:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cmake" data-lang="cmake"><span style="display:flex;"><span><span style="color:#75715e"># here you can see how instead of writing &#34;SomeLibrary&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"># we can just use the PROJECT_NAME variable
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>add_library(<span style="color:#f92672">${</span>PROJECT_NAME<span style="color:#f92672">}</span> <span style="color:#e6db74">STATIC</span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#75715e"># no need to add headers here, only sources are required
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>target_sources(<span style="color:#f92672">${</span>PROJECT_NAME<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">PRIVATE</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">src/some.cpp</span>
</span></span><span style="display:flex;"><span>)</span></span></code></pre></div>
<p>In this case the library is declared as <code>STATIC</code>, but actually it is not a good idea to hardcode libraries type like that in their project files, because CMake has a global flag for this exact purpose - <a href="https://cmake.org/cmake/help/latest/variable/BUILD_SHARED_LIBS.html">BUILD_SHARED_LIBS</a> - and in general it&rsquo;s better to rely on that flag instead of setting libraries type inline.</p>
<p>There will be also a section about shared libraries <a href="#static-vs-shared">later</a>, but in this particular case hardcoding the library type to <code>STATIC</code> somewhat makes sense, because I do not export its symbols for making a DLL, so on Windows it wouldn&rsquo;t build a proper library as <code>SHARED</code>.</p>
<h4 id="name-without-lib-prefixpostfix">Name without lib prefix/postfix</h4>
<p>Like I said in the beginning, the <code>someLib</code> name on the picture is a bad example of naming a library, as there should be no <code>lib</code> anywhere in the name (<code>/(^[lL][iI][bB])|([lL][iI][bB]$)/g</code>), so <code>libSome</code> would also be a bad name. The <code>SomeLibrary</code> name, on the other hand, is okay-ish, because it neither starts with <code>lib</code> nor ends with <code>lib</code> (<em>it only has <code>lib</code> in the middle</em>).</p>
<p>The reason why one should not have <code>lib</code> prefix/postfix in one&rsquo;s library name is because it will be set in an appropriate manner (<em>depending on the target platform</em>) by CMake automatically. So, if you have your library named <code>someLib</code>, then on Unix platforms it will become <code>libsomeLib.a</code> (<em>and <code>someLib.lib</code> on Windows</em>), which already doesn&rsquo;t look great, and if you have it named <code>libSome</code>, then the resulting binary will be <code>liblibSome.a</code>, which is even worse.</p>
<p>It is of course possible to manipulate the <a href="https://cmake.org/cmake/help/latest/prop_tgt/OUTPUT_NAME.html">output names</a> explicitly, but there is already enough things to worry about, so I would just leave this to CMake and rely on the default behaviour by simply not having <code>lib</code> in the library name.</p>
<h3 id="include-directories">Include directories</h3>
<p>Setting include directories correctly with <a href="https://cmake.org/cmake/help/latest/command/target_include_directories.html">target_include_directories</a> is very important:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cmake" data-lang="cmake"><span style="display:flex;"><span>target_include_directories(<span style="color:#f92672">${</span>PROJECT_NAME<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">PRIVATE</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># where the library itself will look for its internal headers
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#f92672">${</span>CMAKE_CURRENT_SOURCE_DIR<span style="color:#f92672">}</span><span style="color:#e6db74">/src</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">PUBLIC</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># where top-level project will look for the library&#39;s public headers
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#f92672">$&lt;</span>BUILD_INTERFACE:${CMAKE_CURRENT_SOURCE_DIR}/include<span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># where external projects will look for the library&#39;s public headers
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#f92672">$&lt;</span>INSTALL_INTERFACE:${CMAKE_INSTALL_INCLUDEDIR}<span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>)</span></span></code></pre></div>
<p>Paths in <code>PRIVATE</code> section are used by the library to find its own internal headers. So if you would place <code>things.h</code> to <code>./src/hdrs/things.h</code>, then you will need to set this path to <code>${CMAKE_CURRENT_SOURCE_DIR}/src/hdrs</code>.</p>
<p>Paths in <code>PUBLIC</code> section are used by projects that link to this library. That&rsquo;s where they will look for its public headers:</p>
<ul>
<li><code>BUILD_INTERFACE</code> path is meant for projects that will build the library from their source tree, and here you need to add <code>include</code>, because that&rsquo;s where public headers are in the library&rsquo;s source folder</li>
<li><code>INSTALL_INTERFACE</code> is meant for external projects, and here you don&rsquo;t need to add <code>include</code>, because CMake config will do that for you</li>
</ul>
<h3 id="install-instructions">Install instructions</h3>
<p>We need to declare what artifacts should be put to installation directory after building the library. You also need to specify the path of installation directory (<em>where you would like it to be</em>).</p>
<p>Certainly, just building the library is already enough to be able to link to it, but we want to do it in the most comfortable way: not by providing paths to its binaries and headers from both build and sources directories, but by <a href="https://cmake.org/cmake/help/latest/command/install.html">installing</a> just the artifacts we need and using <a href="https://cmake.org/cmake/help/latest/command/find_package.html">find_package</a> command.</p>
<p>With <code>find_package</code> you let CMake to worry about finding the library, its public headers and configuring all that. Here&rsquo;s a more detailed <a href="https://cmake.org/cmake/help/latest/manual/cmake-packages.7.html">documentation</a> about how <code>find_package</code> works, and here&rsquo;s how you can create a <a href="https://cmake.org/cmake/help/git-stage/guide/importing-exporting/index.html#exporting-targets">CMake config</a> of your own.</p>
<h4 id="installation-path">Installation path</h4>
<p>First thing to think about it is the installation path. If you will not set it during configuration step via <a href="https://cmake.org/cmake/help/latest/variable/CMAKE_INSTALL_PREFIX.html">CMAKE_INSTALL_PREFIX</a> (<em><code>-DCMAKE_INSTALL_PREFIX=&quot;/some/path&quot;</code></em>), then CMake will set it to some system libraries path, which you might not want to use, especially if you are building your library for distribution.</p>
<p>Here&rsquo;s how you can overwrite default installation path to install the artifacts into <code>install</code> folder in your source tree:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cmake" data-lang="cmake"><span style="display:flex;"><span><span style="color:#75715e"># note that it is not CMAKE_INSTALL_PREFIX we are checking here
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>if(<span style="color:#e6db74">DEFINED</span> <span style="color:#e6db74">CMAKE_INSTALL_PREFIX_INITIALIZED_TO_DEFAULT</span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>    message(
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">STATUS</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;CMAKE_INSTALL_PREFIX is not set\n&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;Default value: ${CMAKE_INSTALL_PREFIX}\n&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;Will set it to ${CMAKE_SOURCE_DIR}/install&#34;</span>
</span></span><span style="display:flex;"><span>    )<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>    set(<span style="color:#e6db74">CMAKE_INSTALL_PREFIX</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;${CMAKE_SOURCE_DIR}/install&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">CACHE</span> <span style="color:#e6db74">PATH</span> <span style="color:#e6db74">&#34;Where the library will be installed to&#34;</span> <span style="color:#e6db74">FORCE</span>
</span></span><span style="display:flex;"><span>    )<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>else()<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>    message(
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">STATUS</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;CMAKE_INSTALL_PREFIX was already set\n&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;Current value: ${CMAKE_INSTALL_PREFIX}&#34;</span>
</span></span><span style="display:flex;"><span>    )<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>endif()</span></span></code></pre></div>
<h4 id="public-headers">Public headers</h4>
<p>Next thing you need to do is to declare <a href="https://cmake.org/cmake/help/latest/prop_tgt/PUBLIC_HEADER.html">PUBLIC_HEADER</a> property:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cmake" data-lang="cmake"><span style="display:flex;"><span><span style="color:#75715e"># without it public headers won&#39;t get installed
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>set(<span style="color:#e6db74">public_headers</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">include/some.h</span>
</span></span><span style="display:flex;"><span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#75715e"># note that ${public_headers} has to be in quotes
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>set_target_properties(<span style="color:#f92672">${</span>PROJECT_NAME<span style="color:#f92672">}</span> <span style="color:#e6db74">PROPERTIES</span> <span style="color:#e6db74">PUBLIC_HEADER</span> <span style="color:#e6db74">&#34;${public_headers}&#34;</span>)</span></span></code></pre></div>
<p>Note, however, that this doesn&rsquo;t preserve the folder structure, and so for more complex projects that won&rsquo;t give the desired result. For instance, here are the public headers of the <a href="https://glad.dav1d.de/">glad</a> library:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span><span style="color:#f92672">├──</span> include
</span></span><span style="display:flex;"><span><span style="color:#f92672">│</span>     <span style="color:#f92672">├──</span> <span style="color:#a6e22e">KHR</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">│</span>     <span style="color:#f92672">│</span>     <span style="color:#f92672">└──</span> khrplatform<span style="color:#f92672">.</span>h
</span></span><span style="display:flex;"><span><span style="color:#f92672">│</span>     <span style="color:#f92672">└──</span> glad
</span></span><span style="display:flex;"><span><span style="color:#f92672">│</span>         <span style="color:#f92672">└──</span> glad<span style="color:#f92672">.</span>h
</span></span><span style="display:flex;"><span><span style="color:#f92672">└──</span> src
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">└──</span> glad<span style="color:#f92672">.</span>c</span></span></code></pre></div>
<p>Trying to install it, you&rsquo;ll get the following result in the installation path:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span><span style="color:#f92672">├──</span> cmake
</span></span><span style="display:flex;"><span><span style="color:#f92672">│</span>     <span style="color:#f92672">├──</span> gladConfig<span style="color:#f92672">-</span>release<span style="color:#f92672">.</span>cmake
</span></span><span style="display:flex;"><span><span style="color:#f92672">│</span>     <span style="color:#f92672">└──</span> gladConfig<span style="color:#f92672">.</span>cmake
</span></span><span style="display:flex;"><span><span style="color:#f92672">├──</span> include
</span></span><span style="display:flex;"><span><span style="color:#f92672">│</span>     <span style="color:#f92672">└──</span> glad
</span></span><span style="display:flex;"><span><span style="color:#f92672">│</span>         <span style="color:#f92672">├──</span> glad<span style="color:#f92672">.</span>h
</span></span><span style="display:flex;"><span><span style="color:#f92672">│</span>         <span style="color:#f92672">└──</span> khrplatform<span style="color:#f92672">.</span>h
</span></span><span style="display:flex;"><span><span style="color:#f92672">└──</span> lib
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">└──</span> libglad<span style="color:#f92672">.</span>a</span></span></code></pre></div>
<p>which won&rsquo;t work for <code>khrplatform.h</code> header, as it is expected to be included like this:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span><span style="color:#66d9ef">#</span>include <span style="color:#f92672">&lt;</span><span style="color:#a6e22e">KHR</span><span style="color:#f92672">/</span>khrplatform<span style="color:#f92672">.</span>h<span style="color:#f92672">&gt;</span></span></span></code></pre></div>
<p>In order to preserve the folder structure, you can use the following trickery:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cmake" data-lang="cmake"><span style="display:flex;"><span><span style="color:#75715e"># for CMAKE_INSTALL_INCLUDEDIR definition
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>include(<span style="color:#e6db74">GNUInstallDirs</span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#75715e"># the variant with PUBLIC_HEADER property unfortunately does not preserve the folder structure
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#set_target_properties(${PROJECT_NAME} PROPERTIES PUBLIC_HEADER &#34;${public_headers}&#34;)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"># so instead we iterate through public headers and install them &#34;manually&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>foreach(<span style="color:#e6db74">header</span> <span style="color:#f92672">${</span>public_headers<span style="color:#f92672">}</span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>    file(<span style="color:#e6db74">RELATIVE_PATH</span> <span style="color:#e6db74">header_file_path</span> <span style="color:#e6db74">&#34;${CMAKE_CURRENT_SOURCE_DIR}/${PROJECT_NAME}&#34;</span> <span style="color:#e6db74">&#34;${header}&#34;</span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>    get_filename_component(<span style="color:#e6db74">header_directory_path</span> <span style="color:#e6db74">&#34;${header_file_path}&#34;</span> <span style="color:#e6db74">DIRECTORY</span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>    install(
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">FILES</span> <span style="color:#f92672">${</span>header<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">DESTINATION</span> <span style="color:#e6db74">&#34;${CMAKE_INSTALL_INCLUDEDIR}/${header_directory_path}&#34;</span>
</span></span><span style="display:flex;"><span>    )<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>endforeach()</span></span></code></pre></div>
<h4 id="debug-suffix">Debug suffix</h4>
<p>It might be a good idea to add <code>d</code> suffix to debug binaries - that way you&rsquo;ll get <code>libSomeLibraryd.a</code> with Debug configuration and <code>libSomeLibrary.a</code> with Release. To do that you need to set the <a href="https://cmake.org/cmake/help/latest/prop_tgt/CONFIG_POSTFIX.html">DEBUG_POSTFIX</a> property:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cmake" data-lang="cmake"><span style="display:flex;"><span>set_target_properties(<span style="color:#f92672">${</span>PROJECT_NAME<span style="color:#f92672">}</span> <span style="color:#e6db74">PROPERTIES</span> <span style="color:#e6db74">DEBUG_POSTFIX</span> <span style="color:#e6db74">&#34;d&#34;</span>)</span></span></code></pre></div>
<p>Or you can set it globally for the entire project on configuration with <code>-DCMAKE_DEBUG_POSTFIX=&quot;d&quot;</code>.</p>
<h4 id="destinations">Destinations</h4>
<p>Here come the actual installation instructions:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cmake" data-lang="cmake"><span style="display:flex;"><span><span style="color:#75715e"># if you haven&#39;t included it already
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"># definitions of CMAKE_INSTALL_LIBDIR, CMAKE_INSTALL_INCLUDEDIR and others
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>include(<span style="color:#e6db74">GNUInstallDirs</span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#75715e"># install the target and create export-set
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>install(<span style="color:#e6db74">TARGETS</span> <span style="color:#f92672">${</span>PROJECT_NAME<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">EXPORT</span> <span style="color:#e6db74">&#34;${PROJECT_NAME}Targets&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># these get default values from GNUInstallDirs, no need to set them
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">#RUNTIME DESTINATION ${CMAKE_INSTALL_BINDIR} # bin
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">#LIBRARY DESTINATION ${CMAKE_INSTALL_LIBDIR} # lib
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">#ARCHIVE DESTINATION ${CMAKE_INSTALL_LIBDIR} # lib
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e"># except for public headers, as we want them to be inside a library folder
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#e6db74">PUBLIC_HEADER</span> <span style="color:#e6db74">DESTINATION</span> <span style="color:#f92672">${</span>CMAKE_INSTALL_INCLUDEDIR<span style="color:#f92672">}</span><span style="color:#e6db74">/</span><span style="color:#f92672">${</span>PROJECT_NAME<span style="color:#f92672">}</span> <span style="color:#75715e"># include/SomeLibrary
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#e6db74">INCLUDES</span> <span style="color:#e6db74">DESTINATION</span> <span style="color:#f92672">${</span>CMAKE_INSTALL_INCLUDEDIR<span style="color:#f92672">}</span> <span style="color:#75715e"># include
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>)</span></span></code></pre></div>
<p>Important to note here that <code>INCLUDES</code> is not part of the <code>RUNTIME</code>/<code>LIBRARY</code>/<code>ARCHIVE</code>/<code>PUBLIC_HEADER</code> group. See for yourself in the <a href="https://cmake.org/cmake/help/latest/command/install.html#installing-targets">install()</a> signature:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cmake" data-lang="cmake"><span style="display:flex;"><span>install(
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">TARGETS</span> <span style="color:#e6db74">targets...</span> <span style="color:#e6db74">[EXPORT</span> <span style="color:#e6db74">&lt;export-name&gt;]</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">[RUNTIME_DEPENDENCIES</span> <span style="color:#e6db74">args...|RUNTIME_DEPENDENCY_SET</span> <span style="color:#e6db74">&lt;set-name&gt;]</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">[</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">[</span>
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">ARCHIVE|LIBRARY|RUNTIME|OBJECTS|FRAMEWORK|BUNDLE|PRIVATE_HEADER|PUBLIC_HEADER|RESOURCE</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">]</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">[DESTINATION</span> <span style="color:#e6db74">&lt;dir&gt;]</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">[PERMISSIONS</span> <span style="color:#e6db74">permissions...]</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">[CONFIGURATIONS</span> <span style="color:#e6db74">[Debug|Release|...]]</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">[COMPONENT</span> <span style="color:#e6db74">&lt;component&gt;]</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">[NAMELINK_COMPONENT</span> <span style="color:#e6db74">&lt;component&gt;]</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">[OPTIONAL]</span> <span style="color:#e6db74">[EXCLUDE_FROM_ALL]</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">[NAMELINK_ONLY|NAMELINK_SKIP]</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">]</span> <span style="color:#e6db74">[...]</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">[INCLUDES</span> <span style="color:#e6db74">DESTINATION</span> <span style="color:#e6db74">[&lt;dir&gt;</span> <span style="color:#e6db74">...]]</span>
</span></span><span style="display:flex;"><span>)</span></span></code></pre></div>
<p>If you won&rsquo;t have <code>INCLUDES</code> in the <code>install()</code>, then <code>SomeLibraryTargets.cmake</code> won&rsquo;t have these lines:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cmake" data-lang="cmake"><span style="display:flex;"><span>set_target_properties(<span style="color:#e6db74">some::SomeLibrary</span> <span style="color:#e6db74">PROPERTIES</span>
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">INTERFACE_INCLUDE_DIRECTORIES</span> <span style="color:#e6db74">&#34;${_IMPORT_PREFIX}/include&#34;</span>
</span></span><span style="display:flex;"><span>)</span></span></code></pre></div>
<p>and when you&rsquo;ll try to use this (<em>installed</em>) library in an external project, it will configure fine, but it will fail to build:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ cmake --build .
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span> 50%<span style="color:#f92672">]</span> Building CXX object CMakeFiles/another-application.dir/main.cpp.o
</span></span><span style="display:flex;"><span>/path/to/cmake-library-example/external-project/main.cpp:2:10: fatal error: <span style="color:#e6db74">&#39;SomeLibrary/some.h&#39;</span> file not found
</span></span><span style="display:flex;"><span><span style="color:#75715e">#include &lt;SomeLibrary/some.h&gt;</span>
</span></span><span style="display:flex;"><span>         ^~~~~~~~~~~~~~~~~~~~
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">1</span> error generated.
</span></span><span style="display:flex;"><span>make<span style="color:#f92672">[</span>2<span style="color:#f92672">]</span>: *** <span style="color:#f92672">[</span>CMakeFiles/another-application.dir/main.cpp.o<span style="color:#f92672">]</span> Error <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>make<span style="color:#f92672">[</span>1<span style="color:#f92672">]</span>: *** <span style="color:#f92672">[</span>CMakeFiles/another-application.dir/all<span style="color:#f92672">]</span> Error <span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span>make: *** <span style="color:#f92672">[</span>all<span style="color:#f92672">]</span> Error <span style="color:#ae81ff">2</span></span></span></code></pre></div>
<h4 id="configs">Configs</h4>
<p>Create <code>Config.cmake.in</code> file:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>@PACKAGE_INIT@
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>include<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>CMAKE_CURRENT_LIST_DIR<span style="color:#e6db74">}</span><span style="color:#e6db74">/@PROJECT_NAME@Targets.cmake&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>check_required_components<span style="color:#f92672">(</span>@PROJECT_NAME@<span style="color:#f92672">)</span></span></span></code></pre></div>
<p><a href="https://cmake.org/cmake/help/git-stage/guide/importing-exporting/index.html#creating-a-package-configuration-file">CMake documentation</a> doesn&rsquo;t mention it in a clear way, but you can still use the <code>PROJECT_NAME</code> variable here too - just wrap it in <code>@@</code>.</p>
<p>And then in <code>CMakeLists.txt</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cmake" data-lang="cmake"><span style="display:flex;"><span><span style="color:#75715e"># generate and install export file
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>install(<span style="color:#e6db74">EXPORT</span> <span style="color:#e6db74">&#34;${PROJECT_NAME}Targets&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">FILE</span> <span style="color:#e6db74">&#34;${PROJECT_NAME}Targets.cmake&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">NAMESPACE</span> <span style="color:#f92672">${</span>namespace<span style="color:#f92672">}</span><span style="color:#e6db74">::</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">DESTINATION</span> <span style="color:#e6db74">cmake</span>
</span></span><span style="display:flex;"><span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>include(<span style="color:#e6db74">CMakePackageConfigHelpers</span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#75715e"># generate the version file for the config file
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>write_basic_package_version_file(
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;${CMAKE_CURRENT_BINARY_DIR}/${PROJECT_NAME}ConfigVersion.cmake&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">VERSION</span> <span style="color:#e6db74">&#34;${version}&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">COMPATIBILITY</span> <span style="color:#e6db74">AnyNewerVersion</span>
</span></span><span style="display:flex;"><span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#75715e"># create config file
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>configure_package_config_file(<span style="color:#f92672">${</span>CMAKE_CURRENT_SOURCE_DIR<span style="color:#f92672">}</span><span style="color:#e6db74">/Config.cmake.in</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;${CMAKE_CURRENT_BINARY_DIR}/${PROJECT_NAME}Config.cmake&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">INSTALL_DESTINATION</span> <span style="color:#e6db74">cmake</span>
</span></span><span style="display:flex;"><span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#75715e"># install config files
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>install(<span style="color:#e6db74">FILES</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;${CMAKE_CURRENT_BINARY_DIR}/${PROJECT_NAME}Config.cmake&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;${CMAKE_CURRENT_BINARY_DIR}/${PROJECT_NAME}ConfigVersion.cmake&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">DESTINATION</span> <span style="color:#e6db74">cmake</span>
</span></span><span style="display:flex;"><span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#75715e"># generate the export targets for the build tree
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"># (can&#39;t say what this one is for, but so far it has been only causing me problems,
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"># so I stopped adding it to projects)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"># export(EXPORT &#34;${PROJECT_NAME}Targets&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#     FILE &#34;${CMAKE_CURRENT_BINARY_DIR}/cmake/${PROJECT_NAME}Targets.cmake&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#     NAMESPACE ${namespace}::
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#960050;background-color:#1e0010">#)</span></span></span></code></pre></div>
<p>The <code>write_basic_package_version_file()</code> function from above will create <code>SomeLibraryConfigVersion.cmake</code> file in the <code>install</code> folder. Having it, if you now try to find your package in external project (<code>cmake-library-example/external-project/CMakeLists.txt</code>) like this:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cmake" data-lang="cmake"><span style="display:flex;"><span>find_package(<span style="color:#e6db74">SomeLibrary</span> <span style="color:#e6db74">0.9.2</span> <span style="color:#e6db74">CONFIG</span> <span style="color:#e6db74">REQUIRED</span>)</span></span></code></pre></div>
<p>then you will get the following error on configuration:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>CMake Error at CMakeLists.txt:9 <span style="color:#f92672">(</span>find_package<span style="color:#f92672">)</span>:
</span></span><span style="display:flex;"><span>  Could not find a configuration file <span style="color:#66d9ef">for</span> package <span style="color:#e6db74">&#34;SomeLibrary&#34;</span> that is
</span></span><span style="display:flex;"><span>  compatible with requested version <span style="color:#e6db74">&#34;0.9.2&#34;</span>.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  The following configuration files were considered but not accepted:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    /Users/YOURNAME/code/cpp/cmake-library-example/internal-project/install/cmake/SomeLibraryConfig.cmake, version: 0.9.1</span></span></code></pre></div>
<p>Finally, the <code>NAMESPACE</code> property is exactly what is looks like - a namespace of your library. I reckon, that will help to avoid names collision and also allow to group related stuff in one namespace, similar to <a href="https://doc.qt.io/qt-5/cmake-get-started.html#build-a-gui-executable">how Qt does it</a>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cmake" data-lang="cmake"><span style="display:flex;"><span>target_link_libraries(<span style="color:#e6db74">helloworld</span> <span style="color:#e6db74">Qt5::Widgets</span>)</span></span></code></pre></div>
<h2 id="building-and-installing">Building and installing</h2>
<p>Go to library source tree root and run the usual:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ mkdir build <span style="color:#f92672">&amp;&amp;</span> cd $_
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ cmake ..
</span></span><span style="display:flex;"><span>-- The C compiler identification is AppleClang 12.0.0.12000032
</span></span><span style="display:flex;"><span>-- The CXX compiler identification is AppleClang 12.0.0.12000032
</span></span><span style="display:flex;"><span>-- Detecting C compiler ABI info
</span></span><span style="display:flex;"><span>-- Detecting C compiler ABI info - <span style="color:#66d9ef">done</span>
</span></span><span style="display:flex;"><span>-- Check <span style="color:#66d9ef">for</span> working C compiler: /Applications/Xcode.app/Contents/Developer/Toolchains/XcodeDefault.xctoolchain/usr/bin/cc - skipped
</span></span><span style="display:flex;"><span>-- Detecting C compile features
</span></span><span style="display:flex;"><span>-- Detecting C compile features - <span style="color:#66d9ef">done</span>
</span></span><span style="display:flex;"><span>-- Detecting CXX compiler ABI info
</span></span><span style="display:flex;"><span>-- Detecting CXX compiler ABI info - <span style="color:#66d9ef">done</span>
</span></span><span style="display:flex;"><span>-- Check <span style="color:#66d9ef">for</span> working CXX compiler: /Applications/Xcode.app/Contents/Developer/Toolchains/XcodeDefault.xctoolchain/usr/bin/c++ - skipped
</span></span><span style="display:flex;"><span>-- Detecting CXX compile features
</span></span><span style="display:flex;"><span>-- Detecting CXX compile features - <span style="color:#66d9ef">done</span>
</span></span><span style="display:flex;"><span>-- This project is a top-level one
</span></span><span style="display:flex;"><span>-- CMAKE_INSTALL_PREFIX is not set
</span></span><span style="display:flex;"><span>Default value: /usr/local
</span></span><span style="display:flex;"><span>Will set it to /Users/YOURNAME/code/cpp/someLibrary/install
</span></span><span style="display:flex;"><span>-- Configuring <span style="color:#66d9ef">done</span>
</span></span><span style="display:flex;"><span>-- Generating <span style="color:#66d9ef">done</span>
</span></span><span style="display:flex;"><span>-- Build files have been written to: /Users/YOURNAME/code/cpp/someLibrary/build
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ cmake --build . --target install
</span></span><span style="display:flex;"><span>Scanning dependencies of target SomeLibrary
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span> 50%<span style="color:#f92672">]</span> Building CXX object CMakeFiles/SomeLibrary.dir/src/some.cpp.o
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>100%<span style="color:#f92672">]</span> Linking CXX static library libSomeLibrary.a
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>100%<span style="color:#f92672">]</span> Built target SomeLibrary
</span></span><span style="display:flex;"><span>Install the project...
</span></span><span style="display:flex;"><span>-- Install configuration: <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>-- Installing: /Users/YOURNAME/code/cpp/someLibrary/install/lib/libSomeLibrary.a
</span></span><span style="display:flex;"><span>-- Installing: /Users/YOURNAME/code/cpp/someLibrary/install/include/SomeLibrary/some.h
</span></span><span style="display:flex;"><span>-- Installing: /Users/YOURNAME/code/cpp/someLibrary/install/cmake/SomeLibraryConfig.cmake
</span></span><span style="display:flex;"><span>-- Installing: /Users/YOURNAME/code/cpp/someLibrary/install/cmake/SomeLibraryConfig-noconfig.cmake
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ tree ../install/
</span></span><span style="display:flex;"><span>├── cmake
</span></span><span style="display:flex;"><span>│   ├── SomeLibraryConfig-noconfig.cmake
</span></span><span style="display:flex;"><span>│   └── SomeLibraryConfig.cmake
</span></span><span style="display:flex;"><span>├── include
</span></span><span style="display:flex;"><span>│   └── SomeLibrary
</span></span><span style="display:flex;"><span>│       └── some.h
</span></span><span style="display:flex;"><span>└── lib
</span></span><span style="display:flex;"><span>    └── libSomeLibrary.a</span></span></code></pre></div>
<p>Note that <code>SomeLibraryConfig-noconfig.cmake</code> has this weird <code>noconfig</code> suffix. This is because we ran configuration without specifying the build type - better to explicitly set it then, both Debug and Release:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ rm -r ../install/* <span style="color:#f92672">&amp;&amp;</span> rm -r ./* <span style="color:#f92672">&amp;&amp;</span> cmake -DCMAKE_BUILD_TYPE<span style="color:#f92672">=</span>Debug ..
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ cmake --build . --target install
</span></span><span style="display:flex;"><span>Scanning dependencies of target SomeLibrary
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span> 50%<span style="color:#f92672">]</span> Building CXX object CMakeFiles/SomeLibrary.dir/src/some.cpp.o
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>100%<span style="color:#f92672">]</span> Linking CXX static library libSomeLibraryd.a
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>100%<span style="color:#f92672">]</span> Built target SomeLibrary
</span></span><span style="display:flex;"><span>Install the project...
</span></span><span style="display:flex;"><span>-- Install configuration: <span style="color:#e6db74">&#34;Debug&#34;</span>
</span></span><span style="display:flex;"><span>-- Installing: /Users/YOURNAME/code/cpp/someLibrary/install/lib/libSomeLibraryd.a
</span></span><span style="display:flex;"><span>-- Installing: /Users/YOURNAME/code/cpp/someLibrary/install/include/SomeLibrary/some.h
</span></span><span style="display:flex;"><span>-- Installing: /Users/YOURNAME/code/cpp/someLibrary/install/cmake/SomeLibraryConfig.cmake
</span></span><span style="display:flex;"><span>-- Installing: /Users/YOURNAME/code/cpp/someLibrary/install/cmake/SomeLibraryConfig-debug.cmake
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ rm -r ./* <span style="color:#f92672">&amp;&amp;</span> cmake -DCMAKE_BUILD_TYPE<span style="color:#f92672">=</span>Release ..
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ cmake --build . --target install
</span></span><span style="display:flex;"><span>Scanning dependencies of target SomeLibrary
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span> 50%<span style="color:#f92672">]</span> Building CXX object CMakeFiles/SomeLibrary.dir/src/some.cpp.o
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>100%<span style="color:#f92672">]</span> Linking CXX static library libSomeLibrary.a
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>100%<span style="color:#f92672">]</span> Built target SomeLibrary
</span></span><span style="display:flex;"><span>Install the project...
</span></span><span style="display:flex;"><span>-- Install configuration: <span style="color:#e6db74">&#34;Release&#34;</span>
</span></span><span style="display:flex;"><span>-- Installing: /Users/YOURNAME/code/cpp/someLibrary/install/lib/libSomeLibrary.a
</span></span><span style="display:flex;"><span>-- Up-to-date: /Users/YOURNAME/code/cpp/someLibrary/install/include/SomeLibrary/some.h
</span></span><span style="display:flex;"><span>-- Installing: /Users/YOURNAME/code/cpp/someLibrary/install/cmake/SomeLibraryConfig.cmake
</span></span><span style="display:flex;"><span>-- Installing: /Users/YOURNAME/code/cpp/someLibrary/install/cmake/SomeLibraryConfig-release.cmake
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ tree ../install/
</span></span><span style="display:flex;"><span>├── cmake
</span></span><span style="display:flex;"><span>│   ├── SomeLibraryConfig-debug.cmake
</span></span><span style="display:flex;"><span>│   ├── SomeLibraryConfig-release.cmake
</span></span><span style="display:flex;"><span>│   └── SomeLibraryConfig.cmake
</span></span><span style="display:flex;"><span>├── include
</span></span><span style="display:flex;"><span>│   └── SomeLibrary
</span></span><span style="display:flex;"><span>│       └── some.h
</span></span><span style="display:flex;"><span>└── lib
</span></span><span style="display:flex;"><span>    ├── libSomeLibrary.a
</span></span><span style="display:flex;"><span>    └── libSomeLibraryd.a</span></span></code></pre></div>
<p>So there you have it! The library has been successfully built and nicely installed, so now you can just pack the <code>install</code> folder contents (<em>you might want to <a href="/blog/2021/09/23/cmake-cpack-package-deb-apt/">use CPack</a> for that</em>) and distribute it to your users.</p>
<h3 id="cmake-generators">CMake generators</h3>
<p>While we are here, you should probably know about such thing as <a href="https://cmake.org/cmake/help/latest/manual/cmake-generators.7.html">CMake generators</a>. Trying to put it simply, I would say that generator is what transforms CMake project files/scripts into specific build instructions for a particular build tool.</p>
<p>As you hopefully are aware, there are several build tools available. We have <a href="https://www.gnu.org/software/make/">GNU make</a>, <a href="https://learn.microsoft.com/en-us/cpp/build/reference/nmake-reference?view=msvc-170">Microsoft NMAKE</a>, <a href="https://ninja-build.org">Ninja</a>, <a href="https://developer.apple.com/library/archive/technotes/tn2339/_index.html">xcodebuild</a> and so on. And depending on which one you would like to use, you need to choose a particular CMake generator for that.</p>
<p>To list all the available generators for the current platform you can run CMake with an &ldquo;empty&rdquo; <code>-G</code> argument, for example here&rsquo;s what I have on Mac OS:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span>$ cmake <span style="color:#f92672">-</span>G
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">CMake</span> <span style="color:#a6e22e">Error</span><span style="color:#66d9ef">:</span> <span style="color:#66d9ef">No</span> <span style="color:#66d9ef">generator</span> <span style="color:#66d9ef">specified</span> <span style="color:#66d9ef">for</span> <span style="color:#66d9ef">-G</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">Generators</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">*</span> <span style="color:#a6e22e">Unix</span> <span style="color:#a6e22e">Makefiles</span>               <span style="color:#66d9ef">=</span> <span style="color:#a6e22e">Generates</span> standard <span style="color:#a6e22e">UNIX</span> makefiles<span style="color:#f92672">.</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">Ninja</span>                        <span style="color:#66d9ef">=</span> <span style="color:#a6e22e">Generates</span> build<span style="color:#f92672">.</span>ninja files<span style="color:#f92672">.</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">Ninja</span> <span style="color:#a6e22e">Multi</span><span style="color:#f92672">-</span><span style="color:#a6e22e">Config</span>           <span style="color:#66d9ef">=</span> <span style="color:#a6e22e">Generates</span> build<span style="color:#f92672">-&lt;</span><span style="color:#a6e22e">Config</span><span style="color:#f92672">&gt;.</span>ninja files<span style="color:#f92672">.</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">Watcom</span> <span style="color:#a6e22e">WMake</span>                 <span style="color:#66d9ef">=</span> <span style="color:#a6e22e">Generates</span> <span style="color:#a6e22e">Watcom</span> <span style="color:#a6e22e">WMake</span> makefiles<span style="color:#f92672">.</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">Xcode</span>                        <span style="color:#66d9ef">=</span> <span style="color:#a6e22e">Generate</span> <span style="color:#a6e22e">Xcode</span> project files<span style="color:#f92672">.</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">CodeBlocks</span> <span style="color:#f92672">-</span> <span style="color:#a6e22e">Ninja</span>           <span style="color:#66d9ef">=</span> <span style="color:#a6e22e">Generates</span> <span style="color:#a6e22e">CodeBlocks</span> project files
</span></span><span style="display:flex;"><span>                                 <span style="color:#f92672">(</span>deprecated<span style="color:#f92672">).</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">CodeBlocks</span> <span style="color:#f92672">-</span> <span style="color:#a6e22e">Unix</span> <span style="color:#a6e22e">Makefiles</span>  <span style="color:#66d9ef">=</span> <span style="color:#a6e22e">Generates</span> <span style="color:#a6e22e">CodeBlocks</span> project files
</span></span><span style="display:flex;"><span>                                 <span style="color:#f92672">(</span>deprecated<span style="color:#f92672">).</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">CodeLite</span> <span style="color:#f92672">-</span> <span style="color:#a6e22e">Ninja</span>             <span style="color:#66d9ef">=</span> <span style="color:#a6e22e">Generates</span> <span style="color:#a6e22e">CodeLite</span> project files
</span></span><span style="display:flex;"><span>                                 <span style="color:#f92672">(</span>deprecated<span style="color:#f92672">).</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">CodeLite</span> <span style="color:#f92672">-</span> <span style="color:#a6e22e">Unix</span> <span style="color:#a6e22e">Makefiles</span>    <span style="color:#66d9ef">=</span> <span style="color:#a6e22e">Generates</span> <span style="color:#a6e22e">CodeLite</span> project files
</span></span><span style="display:flex;"><span>                                 <span style="color:#f92672">(</span>deprecated<span style="color:#f92672">).</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">Eclipse</span> <span style="color:#a6e22e">CDT4</span> <span style="color:#f92672">-</span> <span style="color:#a6e22e">Ninja</span>         <span style="color:#66d9ef">=</span> <span style="color:#a6e22e">Generates</span> <span style="color:#a6e22e">Eclipse</span> <span style="color:#a6e22e">CDT</span> <span style="color:#ae81ff">4.0</span> project files
</span></span><span style="display:flex;"><span>                                 <span style="color:#f92672">(</span>deprecated<span style="color:#f92672">).</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">Eclipse</span> <span style="color:#a6e22e">CDT4</span> <span style="color:#f92672">-</span> <span style="color:#a6e22e">Unix</span> <span style="color:#a6e22e">Makefiles</span><span style="color:#66d9ef">=</span> <span style="color:#a6e22e">Generates</span> <span style="color:#a6e22e">Eclipse</span> <span style="color:#a6e22e">CDT</span> <span style="color:#ae81ff">4.0</span> project files
</span></span><span style="display:flex;"><span>                                 <span style="color:#f92672">(</span>deprecated<span style="color:#f92672">).</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">Kate</span> <span style="color:#f92672">-</span> <span style="color:#a6e22e">Ninja</span>                 <span style="color:#66d9ef">=</span> <span style="color:#a6e22e">Generates</span> <span style="color:#a6e22e">Kate</span> project files <span style="color:#f92672">(</span>deprecated<span style="color:#f92672">).</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">Kate</span> <span style="color:#f92672">-</span> <span style="color:#a6e22e">Ninja</span> <span style="color:#a6e22e">Multi</span><span style="color:#f92672">-</span><span style="color:#a6e22e">Config</span>    <span style="color:#66d9ef">=</span> <span style="color:#a6e22e">Generates</span> <span style="color:#a6e22e">Kate</span> project files <span style="color:#f92672">(</span>deprecated<span style="color:#f92672">).</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">Kate</span> <span style="color:#f92672">-</span> <span style="color:#a6e22e">Unix</span> <span style="color:#a6e22e">Makefiles</span>        <span style="color:#66d9ef">=</span> <span style="color:#a6e22e">Generates</span> <span style="color:#a6e22e">Kate</span> project files <span style="color:#f92672">(</span>deprecated<span style="color:#f92672">).</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">Sublime</span> <span style="color:#a6e22e">Text</span> <span style="color:#ae81ff">2</span> <span style="color:#f92672">-</span> <span style="color:#a6e22e">Ninja</span>       <span style="color:#66d9ef">=</span> <span style="color:#a6e22e">Generates</span> <span style="color:#a6e22e">Sublime</span> <span style="color:#a6e22e">Text</span> <span style="color:#ae81ff">2</span> project files
</span></span><span style="display:flex;"><span>                                 <span style="color:#f92672">(</span>deprecated<span style="color:#f92672">).</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">Sublime</span> <span style="color:#a6e22e">Text</span> <span style="color:#ae81ff">2</span> <span style="color:#f92672">-</span> <span style="color:#a6e22e">Unix</span> <span style="color:#a6e22e">Makefiles</span>
</span></span><span style="display:flex;"><span>                               <span style="color:#66d9ef">=</span> <span style="color:#a6e22e">Generates</span> <span style="color:#a6e22e">Sublime</span> <span style="color:#a6e22e">Text</span> <span style="color:#ae81ff">2</span> project files
</span></span><span style="display:flex;"><span>                                 <span style="color:#f92672">(</span>deprecated<span style="color:#f92672">).</span>
</span></span></code></pre></div><p>All the builds in this article are done with <a href="https://cmake.org/cmake/help/latest/generator/Unix%20Makefiles.html">Unix Makefiles</a> generator, because that is the default one on Mac OS, and back then I simply didn&rsquo;t know anything about CMake generators, so I was just obliviously using what was set by default.</p>
<p>Now, when I know a little bit more, I would recommend to use <a href="https://cmake.org/cmake/help/latest/generator/Ninja.html">Ninja</a> any day of the week (<em>for it&rsquo;s the fastest of them all</em>). But if you need to generate a project for your IDE, then you&rsquo;d need to use an IDE-specific generator, such as <a href="https://cmake.org/cmake/help/latest/generator/Xcode.html">Xcode</a> or <a href="https://cmake.org/cmake/help/latest/generator/Visual%20Studio%2017%202022.html">Visual Studio 17 2022</a> (<em>there are several versions of that one</em>).</p>
<p>One other thing to mention here is that specifying Release or Debug build configuration is different between generators. In particular, for <code>Unix Makefiles</code> and <code>Ninja</code> you would do it with <code>CMAKE_BUILD_TYPE</code> on configuration:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span>$ cd <span style="color:#f92672">/</span>path<span style="color:#f92672">/</span>to<span style="color:#f92672">/</span>project
</span></span><span style="display:flex;"><span>$ mkdir build <span style="color:#f92672">&amp;&amp;</span> cd <span style="color:#a6e22e">$_</span>
</span></span><span style="display:flex;"><span>$ cmake <span style="color:#f92672">-</span>G <span style="color:#a6e22e">Ninja</span> <span style="color:#f92672">-</span><span style="color:#a6e22e">DCMAKE_BUILD_TYPE</span><span style="color:#66d9ef">=</span><span style="color:#a6e22e">Release</span> <span style="color:#f92672">..</span>
</span></span><span style="display:flex;"><span>$ cmake <span style="color:#f92672">--</span>build <span style="color:#f92672">.</span> <span style="color:#f92672">--</span>target install
</span></span></code></pre></div><p>while for <code>Xcode</code> and <code>Visual Studio 17 2022</code> that would be via <code>config</code> argument on build:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span>$ cd <span style="color:#f92672">/</span>path<span style="color:#f92672">/</span>to<span style="color:#f92672">/</span>project
</span></span><span style="display:flex;"><span>$ mkdir build <span style="color:#f92672">&amp;&amp;</span> cd <span style="color:#a6e22e">$_</span>
</span></span><span style="display:flex;"><span>$ cmake <span style="color:#f92672">-</span>G <span style="color:#e6db74">&#34;Visual Studio 17 2022&#34;</span> <span style="color:#f92672">..</span>
</span></span><span style="display:flex;"><span>$ cmake <span style="color:#f92672">--</span>build <span style="color:#f92672">.</span> <span style="color:#f92672">--</span>target install <span style="color:#f92672">--</span>config <span style="color:#a6e22e">Release</span>
</span></span></code></pre></div><h1 id="linking-to-the-library">Linking to the library</h1>
<p>Now let&rsquo;s see how your users or yourself can link to the <a href="#the-library">library</a>.</p>
<h2 id="from-external-project">From external project</h2>
<p>Let&rsquo;s take a simple project:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ cd ~/code/cpp/external-project
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ tree .
</span></span><span style="display:flex;"><span>├── CMakeLists.txt
</span></span><span style="display:flex;"><span>└── main.cpp</span></span></code></pre></div>
<p>The source:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;iostream&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#75715e">// note that you need to prepend some.h with the folder name,
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// because that is how it is in the installation folder:
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// install/include/SomeLibrary/some.h
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;SomeLibrary/some.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>(<span style="color:#66d9ef">int</span> argc, <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>argv[])
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    std<span style="color:#f92672">::</span>cout <span style="color:#f92672">&lt;&lt;</span> <span style="color:#e6db74">&#34;base application message&#34;</span> <span style="color:#f92672">&lt;&lt;</span> std<span style="color:#f92672">::</span>endl;
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// here we call a function from the library
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    sm<span style="color:#f92672">::</span>lbr<span style="color:#f92672">::</span>printSomething();
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div>
<p>The project file:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cmake" data-lang="cmake"><span style="display:flex;"><span>project(<span style="color:#e6db74">&#34;another-application&#34;</span> <span style="color:#e6db74">VERSION</span> <span style="color:#e6db74">0.9</span> <span style="color:#e6db74">DESCRIPTION</span> <span style="color:#e6db74">&#34;A project with external library&#34;</span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#75715e"># provide the path to library&#39;s installation folder, so CMake could find its config
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"># for simplicity it is set right here, but actually it is a bad idea
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"># to hardcode these paths in project files, as usually they are set via CLI,
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"># for example: -DCMAKE_PREFIX_PATH=&#34;/Users/YOURNAME/code/cpp/someLibrary/install&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>list(<span style="color:#e6db74">APPEND</span> <span style="color:#e6db74">CMAKE_PREFIX_PATH</span> <span style="color:#e6db74">&#34;/Users/YOURNAME/code/cpp/someLibrary/install&#34;</span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#75715e"># the rest will be taken care of by CMake
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>find_package(<span style="color:#e6db74">SomeLibrary</span> <span style="color:#e6db74">CONFIG</span> <span style="color:#e6db74">REQUIRED</span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#75715e"># it is an application
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>add_executable(<span style="color:#f92672">${</span>PROJECT_NAME<span style="color:#f92672">}</span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>target_sources(<span style="color:#f92672">${</span>PROJECT_NAME<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">PRIVATE</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">main.cpp</span>
</span></span><span style="display:flex;"><span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#75715e"># linking to the library, here you need to provide the namespace too
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>target_link_libraries(<span style="color:#f92672">${</span>PROJECT_NAME<span style="color:#f92672">}</span> <span style="color:#e6db74">PRIVATE</span> <span style="color:#e6db74">some::SomeLibrary</span>)</span></span></code></pre></div>
<p>The <code>PRIVATE</code> keyword <a href="https://cmake.org/cmake/help/latest/command/target_link_libraries.html#libraries-for-a-target-and-or-its-dependents">means</a> that the library will be used by this project, but it will not be available to other projects via this project&rsquo;s interface. For example, if this project is in turn a library itself, then yet another external/parent project linking to it won&rsquo;t be able to use <code>printSomething()</code> function from the underlying library (<em>this is not exactly true, here are <a href="/blog/2023/07/22/cmake-target-link-libraries-scopes/">some more details</a> about that</em>).</p>
<p>Let&rsquo;s now try to build and run the application:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ mkdir build <span style="color:#f92672">&amp;&amp;</span> cd $_
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ cmake -DCMAKE_BUILD_TYPE<span style="color:#f92672">=</span>Release ..
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ cmake --build .
</span></span><span style="display:flex;"><span>Scanning dependencies of target another-application
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span> 50%<span style="color:#f92672">]</span> Building CXX object CMakeFiles/another-application.dir/main.cpp.o
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>100%<span style="color:#f92672">]</span> Linking CXX executable another-application
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>100%<span style="color:#f92672">]</span> Built target another-application
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ ./another-application
</span></span><span style="display:flex;"><span>base application message
</span></span><span style="display:flex;"><span>ololo, some string</span></span></code></pre></div>
<p>It works!</p>
<h3 id="no-need-to-set-include_directories-and-use-magic-variables">No need to set include_directories and use magic variables</h3>
<p>You might have seen in other projects that they also set <code>include_directories</code> for external libraries, and probably you are now wondering why I didn&rsquo;t do it here, and how then it all works.</p>
<p>Indeed, if we take a look at one of such projects, for example SDL2 installed via Homebrew on Mac OS:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span>$ brew info sdl2
</span></span><span style="display:flex;"><span>sdl2<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">stable</span> <span style="color:#960050;background-color:#1e0010">2</span><span style="color:#66d9ef">.</span><span style="color:#960050;background-color:#1e0010">0</span><span style="color:#66d9ef">.</span><span style="color:#960050;background-color:#1e0010">16</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">bottled</span><span style="color:#f92672">),</span> <span style="color:#a6e22e">HEAD</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">Low</span><span style="color:#f92672">-</span>level access to audio<span style="color:#f92672">,</span> keyboard<span style="color:#f92672">,</span> mouse<span style="color:#f92672">,</span> joystick<span style="color:#f92672">,</span> and graphics
</span></span><span style="display:flex;"><span>https<span style="color:#66d9ef">:</span><span style="color:#75715e">//www.libsdl.org/
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#f92672">/</span>usr<span style="color:#f92672">/</span>local<span style="color:#f92672">/</span><span style="color:#a6e22e">Cellar</span><span style="color:#f92672">/</span>sdl2<span style="color:#f92672">/</span><span style="color:#ae81ff">2.0</span><span style="color:#f92672">.</span><span style="color:#ae81ff">16</span> <span style="color:#f92672">(</span><span style="color:#ae81ff">91</span> files<span style="color:#f92672">,</span> <span style="color:#ae81ff">5.4</span><span style="color:#a6e22e">MB</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ tree <span style="color:#f92672">/</span>usr<span style="color:#f92672">/</span>local<span style="color:#f92672">/</span><span style="color:#a6e22e">Cellar</span><span style="color:#f92672">/</span>sdl2<span style="color:#f92672">/</span><span style="color:#ae81ff">2.0</span><span style="color:#f92672">.</span><span style="color:#ae81ff">16</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">/</span>usr<span style="color:#f92672">/</span>local<span style="color:#f92672">/</span><span style="color:#a6e22e">Cellar</span><span style="color:#f92672">/</span>sdl2<span style="color:#f92672">/</span><span style="color:#ae81ff">2.0</span><span style="color:#f92672">.</span><span style="color:#ae81ff">16</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">├──</span> <span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">├──</span> bin
</span></span><span style="display:flex;"><span><span style="color:#f92672">│</span> <span style="color:#f92672">└──</span> sdl2<span style="color:#f92672">-</span>config
</span></span><span style="display:flex;"><span><span style="color:#f92672">├──</span> include
</span></span><span style="display:flex;"><span><span style="color:#f92672">│</span> <span style="color:#f92672">└──</span> <span style="color:#a6e22e">SDL2</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">│</span>     <span style="color:#f92672">├──</span> <span style="color:#a6e22e">SDL</span><span style="color:#f92672">.</span>h
</span></span><span style="display:flex;"><span><span style="color:#f92672">│</span>     <span style="color:#f92672">└──</span> <span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">├──</span> lib
</span></span><span style="display:flex;"><span><span style="color:#f92672">│</span> <span style="color:#f92672">├──</span> cmake
</span></span><span style="display:flex;"><span><span style="color:#f92672">│</span> <span style="color:#f92672">│</span> <span style="color:#f92672">└──</span> <span style="color:#a6e22e">SDL2</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">│</span> <span style="color:#f92672">│</span>     <span style="color:#f92672">├──</span> sdl2<span style="color:#f92672">-</span>config<span style="color:#f92672">-</span>version<span style="color:#f92672">.</span>cmake
</span></span><span style="display:flex;"><span><span style="color:#f92672">│</span> <span style="color:#f92672">│</span>     <span style="color:#f92672">└──</span> sdl2<span style="color:#f92672">-</span>config<span style="color:#f92672">.</span>cmake
</span></span><span style="display:flex;"><span><span style="color:#f92672">│</span> <span style="color:#f92672">├──</span> libSDL2<span style="color:#f92672">-</span><span style="color:#ae81ff">2.0</span><span style="color:#f92672">.</span><span style="color:#ae81ff">0.d</span>ylib
</span></span><span style="display:flex;"><span><span style="color:#f92672">│</span> <span style="color:#f92672">├──</span> libSDL2<span style="color:#f92672">.</span>a
</span></span><span style="display:flex;"><span><span style="color:#f92672">│</span> <span style="color:#f92672">├──</span> libSDL2<span style="color:#f92672">.</span>dylib <span style="color:#f92672">-&gt;</span> libSDL2<span style="color:#f92672">-</span><span style="color:#ae81ff">2.0</span><span style="color:#f92672">.</span><span style="color:#ae81ff">0.d</span>ylib
</span></span><span style="display:flex;"><span><span style="color:#f92672">│</span> <span style="color:#f92672">├──</span> libSDL2_test<span style="color:#f92672">.</span>a
</span></span><span style="display:flex;"><span><span style="color:#f92672">│</span> <span style="color:#f92672">├──</span> libSDL2main<span style="color:#f92672">.</span>a
</span></span><span style="display:flex;"><span><span style="color:#f92672">│</span> <span style="color:#f92672">└──</span> pkgconfig
</span></span><span style="display:flex;"><span><span style="color:#f92672">│</span>     <span style="color:#f92672">└──</span> sdl2<span style="color:#f92672">.</span>pc
</span></span><span style="display:flex;"><span><span style="color:#f92672">└──</span> share
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">└──</span> aclocal
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">└──</span> sdl2<span style="color:#f92672">.</span>m4</span></span></code></pre></div>
<p>Thanks to Homebrew, it is discoverable even without adding its path to <code>CMAKE_PREFIX_PATH</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cmake" data-lang="cmake"><span style="display:flex;"><span><span style="color:#75715e"># and once again, it&#39;s better to set that via CLI: -DCMAKE_PREFIX_PATH=&#34;/usr/local/Cellar/sdl2/2.0.16&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#list(APPEND CMAKE_PREFIX_PATH &#34;/usr/local/Cellar/sdl2/2.0.16&#34;)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>find_package(<span style="color:#e6db74">SDL2</span> <span style="color:#e6db74">REQUIRED</span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>if(<span style="color:#f92672">${</span>SDL2_FOUND<span style="color:#f92672">}</span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>    message(<span style="color:#e6db74">STATUS</span> <span style="color:#e6db74">&#34;Found SDL: ${SDL2_PREFIX}&#34;</span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>endif()<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#75715e"># ...
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>target_link_libraries(<span style="color:#f92672">${</span>CMAKE_PROJECT_NAME<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">PRIVATE</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">${</span>SDL2_LIBRARIES<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div><p>But trying to build your application you&rsquo;ll get this error:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>fatal error: <span style="color:#e6db74">&#39;SDL.h&#39;</span> file not found
</span></span><span style="display:flex;"><span><span style="color:#75715e">#include &lt;SDL.h&gt;</span>
</span></span><span style="display:flex;"><span>         ^~~~~~~
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">1</span> error generated.
</span></span></code></pre></div><p>To fix that you&rsquo;ll also need to add the following to the project file:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cmake" data-lang="cmake"><span style="display:flex;"><span>include_directories(
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">${</span>SDL2_INCLUDE_DIRS<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div><p>That is because SDL2 CMake package was created in a rather obsolete manner, so you have to manually set <code>include_directories</code> and also to use these magic variables such as <code>_INCLUDE_DIRS</code> and <code>_LIBRARIES</code>.</p>
<p>Our library package is written in a more modern way, so including directories is already taken care of, and also there is no need to use any magic variables, just the package name. Nice, innit.</p>
<h2 id="from-internal-top-level-project">From internal top-level project</h2>
<p>But what if we have our library as a part of some other top-level project, so the library lives in its source tree? Do we still need to build it first and add it to the main project via <code>find_package</code>? Not exactly - now there is no need to &ldquo;find&rdquo; it: the library will be built together with the parent project and then linked to.</p>
<h3 id="adding-nested-library-to-the-main-project">Adding nested library to the main project</h3>
<p>Here&rsquo;s the full project structure:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ cd /Users/YOURNAME/code/cpp/internal-project
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ tree .
</span></span><span style="display:flex;"><span>├── CMakeLists.txt
</span></span><span style="display:flex;"><span>├── libraries
</span></span><span style="display:flex;"><span>│   ├── CMakeLists.txt
</span></span><span style="display:flex;"><span>│   └── SomeLibrary
</span></span><span style="display:flex;"><span>│       ├── CMakeLists.txt
</span></span><span style="display:flex;"><span>│       ├── include
</span></span><span style="display:flex;"><span>│       │   └── some.h
</span></span><span style="display:flex;"><span>│       └── src
</span></span><span style="display:flex;"><span>│           ├── some.cpp
</span></span><span style="display:flex;"><span>│           └── things.h
</span></span><span style="display:flex;"><span>└── main.cpp</span></span></code></pre></div>
<p>The main <code>CMakeLists.txt</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cmake" data-lang="cmake"><span style="display:flex;"><span>project(<span style="color:#e6db74">&#34;some-application&#34;</span> <span style="color:#e6db74">VERSION</span> <span style="color:#e6db74">0.9</span> <span style="color:#e6db74">DESCRIPTION</span> <span style="color:#e6db74">&#34;A project with nested library&#34;</span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>add_subdirectory(<span style="color:#e6db74">libraries</span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>add_executable(<span style="color:#f92672">${</span>PROJECT_NAME<span style="color:#f92672">}</span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>target_sources(<span style="color:#f92672">${</span>PROJECT_NAME<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">PRIVATE</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">main.cpp</span>
</span></span><span style="display:flex;"><span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>target_link_libraries(<span style="color:#f92672">${</span>PROJECT_NAME<span style="color:#f92672">}</span> <span style="color:#e6db74">PRIVATE</span> <span style="color:#e6db74">SomeLibrary</span>)</span></span></code></pre></div>
<p>Yes, it is all the same as with <a href="#from-external-project">external project</a> - we just need to link to the library. No crazy relative paths, just the very same <code>target_link_libraries</code>.</p>
<p>But this time we don&rsquo;t need <code>find_package</code> and also we don&rsquo;t need to provide the namespace. That last part I don&rsquo;t entirely understand, but perhaps that is because everything in the project is supposed to be within the same namespace already?</p>
<p>Following <a href="https://cmake.org/cmake/help/latest/command/add_subdirectory.html">add_subdirectory</a> statement, we get to <code>libraries</code> folder, which also has a <code>CMakeLists.txt</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cmake" data-lang="cmake"><span style="display:flex;"><span>add_subdirectory(<span style="color:#e6db74">SomeLibrary</span>)</span></span></code></pre></div>
<p>And there we get to our <a href="#the-library">library project</a>.</p>
<h3 id="about-include-paths">About include paths</h3>
<p>Let&rsquo;s start with <code>main.cpp</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;iostream&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;some.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>(<span style="color:#66d9ef">int</span> argc, <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>argv[])
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    std<span style="color:#f92672">::</span>cout <span style="color:#f92672">&lt;&lt;</span> <span style="color:#e6db74">&#34;base application message&#34;</span> <span style="color:#f92672">&lt;&lt;</span> std<span style="color:#f92672">::</span>endl;
</span></span><span style="display:flex;"><span>    sm<span style="color:#f92672">::</span>lbr<span style="color:#f92672">::</span>printSomething();
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div>
<p>While the code here is the same as the one from external project, there is one notable difference - <code>some.h</code> is not prepended with <code>SomeLibrary/</code> in the <code>#include</code> statement.</p>
<p>Why is that, why is it different from the way in was included in external project? Well, it is because that is how this header is placed in the library&rsquo;s source <code>include</code> folder - there is no <code>SomeLibrary</code> folder nested there. But when you install the library, then there is <code>SomeLibrary</code> folder inside <code>include</code> in the installation folder, so in that case you need to add <code>SomeLibrary/</code> to <code>#include</code> statement.</p>
<p>I wasn&rsquo;t sure if that is really how things are, so I went and asked about this on <a href="https://stackoverflow.com/questions/66507441/library-name-to-prefix-headers-names-in-include-statements">StackOverflow</a>, hoping that there is perhaps some way to handle this in a unified way, but the answer was:</p>
<blockquote>You think too "magically" about what CMake can. CMake just calls a compiler/linker with proper parameters. A compiler requires for #include <SomeLibrary/some.h> that a header file will be in the SomeLibrary directory. CMake cannot overcome this requirement.</blockquote>
<p>So if you would like to unify the way you include the library&rsquo;s public headers both in external and internal projects, then you&rsquo;ll need to create <code>SomeLibrary</code> folder inside library&rsquo;s source <code>include</code> folder (<em>yeah, to get the ugly <code>SomeLibrary/include/SomeLibrary</code> path</em>) and adjust the library&rsquo;s <code>CMakeLists.txt</code> accordingly.</p>
<h3 id="building">Building</h3>
<h4 id="main-project">Main project</h4>
<p>Do the usual in the project source tree root:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ mkdir build <span style="color:#f92672">&amp;&amp;</span> cd $_
</span></span><span style="display:flex;"><span>$ cmake -DCMAKE_BUILD_TYPE<span style="color:#f92672">=</span>Debug ..
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ cmake --build .
</span></span><span style="display:flex;"><span>Scanning dependencies of target SomeLibrary
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span> 25%<span style="color:#f92672">]</span> Building CXX object libraries/SomeLibrary/CMakeFiles/SomeLibrary.dir/src/some.cpp.o
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span> 50%<span style="color:#f92672">]</span> Linking CXX static library libSomeLibraryd.a
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span> 50%<span style="color:#f92672">]</span> Built target SomeLibrary
</span></span><span style="display:flex;"><span>Scanning dependencies of target some-application
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span> 75%<span style="color:#f92672">]</span> Building CXX object CMakeFiles/some-application.dir/main.cpp.o
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>100%<span style="color:#f92672">]</span> Linking CXX executable some-application
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>100%<span style="color:#f92672">]</span> Built target some-application
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ ./some-application
</span></span><span style="display:flex;"><span>base application message
</span></span><span style="display:flex;"><span>ololo, some string</span></span></code></pre></div>
<p>Eeeeeeeasy!</p>
<h4 id="library-as-a-target">Library as a target</h4>
<p>We can also build and install just the library, without building the entire project. Aside from just going to the library folder and <a href="#building-and-installing">running CMake</a> from there, you can actually do it from the project root - by setting <code>--target</code> option on build:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ rm -r ./* <span style="color:#f92672">&amp;&amp;</span> cmake -DCMAKE_BUILD_TYPE<span style="color:#f92672">=</span>Debug ..
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ cmake --build . --target SomeLibrary
</span></span><span style="display:flex;"><span>Scanning dependencies of target SomeLibrary
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span> 50%<span style="color:#f92672">]</span> Building CXX object libraries/SomeLibrary/CMakeFiles/SomeLibrary.dir/src/some.cpp.o
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>100%<span style="color:#f92672">]</span> Linking CXX static library libSomeLibraryd.a
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>100%<span style="color:#f92672">]</span> Built target SomeLibrary
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ cmake --install ./libraries/SomeLibrary
</span></span><span style="display:flex;"><span>-- Install configuration: <span style="color:#e6db74">&#34;Debug&#34;</span>
</span></span><span style="display:flex;"><span>-- Installing: /Users/YOURNAME/code/cpp/cmake-library-example/internal-project/install/lib/libSomeLibraryd.a
</span></span><span style="display:flex;"><span>-- Installing: /Users/YOURNAME/code/cpp/cmake-library-example/internal-project/install/include/SomeLibrary/some.h
</span></span><span style="display:flex;"><span>-- Installing: /Users/YOURNAME/code/cpp/cmake-library-example/internal-project/install/cmake/SomeLibraryConfig.cmake
</span></span><span style="display:flex;"><span>-- Installing: /Users/YOURNAME/code/cpp/cmake-library-example/internal-project/install/cmake/SomeLibraryConfig-debug.cmake</span></span></code></pre></div>
<p>Here you can also see how you can install a single target with <code>--install</code> option - by pointing it to the target folder inside <code>build</code> folder. Also note that install folder is now on the project&rsquo;s source tree root level, not in the library&rsquo;s nested source folder.</p>
<h2 id="static-vs-shared">STATIC vs SHARED</h2>
<p>Hopefully, you already know the difference between static and shared libraries. If not, then, <a href="/blog/2018/02/17/build-qt-statically/#why-build-qt-statically">to put it simple</a>, static libraries are &ldquo;bundled&rdquo; into your binaries, and shared libraries are separate files which need to be discoverable by your binaries in order for the latter to work.</p>
<p>A little practical example: let&rsquo;s build our library as static, link to it from external project, then build it as shared and link to that one.</p>
<p>To make our library shared, we need to replace <code>STATIC</code> with <code>SHARED</code> in <code>add_library</code> statement in the library&rsquo;s <code>CMakeLists.txt</code>. And once again, like I <a href="#target">already said</a>, the library type should not be hardcoded like that, as it would be better to have <code>add_library()</code> without type and instead set <code>-DBUILD_SHARED_LIBS=1</code> on project configuration.</p>
<p>Anyway, first thing that will be different about resulting executable (<code>another-application</code>) is its size:</p>
<ul>
<li>statically linked with SomeLibrary: 51 920 bytes</li>
<li>dynamically linked with SomeLibrary: 51 616 bytes</li>
</ul>
<p>Not a very noticeable difference (<em>remember that our library just prints a line of text</em>), but it is there: statically linked executable is bigger, because the library is &ldquo;bundled&rdquo; into it.</p>
<p>Secondly, if you now rename or delete <code>libSomeLibrary.dylib</code> (<em><code>libSomeLibrary.so</code>, <code>SomeLibrary.dll</code></em>), then trying to run this dynamically linked application you&rsquo;ll get an error like this on Mac OS:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ ./another-application
</span></span><span style="display:flex;"><span>dyld: Library not loaded: @rpath/libSomeLibrary.dylib
</span></span><span style="display:flex;"><span>  Referenced from: /Users/YOURNAME/code/cpp/cmake-library-example/external-project/build/./another-application
</span></span><span style="display:flex;"><span>  Reason: image not found
</span></span><span style="display:flex;"><span>Abort trap: <span style="color:#ae81ff">6</span></span></span></code></pre></div>
<p>or like this on Linux:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ ./another-application
</span></span><span style="display:flex;"><span>./another-application: error <span style="color:#66d9ef">while</span> loading shared libraries: libSomeLibrary.so: cannot open shared object file: No such file or directory</span></span></code></pre></div>
<p>So in case of a shared library on Mac OS or Linux it has to either stay available in its installation path, or be placed into the one of the system libraries paths. Be aware that simply copying it to the same folder with executable won&rsquo;t work, unless you set the <code>LD_LIBRARY_PATH</code> variable on Linux (<em>or <code>DYLD_FALLBACK_LIBRARY_PATH</code>/<code>DYLD_LIBRARY_PATH</code> on Mac OS</em>) before running the application:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ LD_LIBRARY_PATH<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;.&#34;</span> ./another-application</span></span></code></pre></div>
<p>And on Windows it will fail even if you haven&rsquo;t touched the library in its install folder, however you can just copy it to the same folder where executable is, but more on that below.</p>
<h3 id="shared-dll-on-windows">SHARED DLL on Windows</h3>
<p>Shared libraries on Windows are a special thing. There it is not enough just to replace <code>STATIC</code> with <code>SHARED</code> in <code>add_library</code> statement (<em>or set <code>-DBUILD_SHARED_LIBS=1</code></em>).</p>
<p>If you build and install it having done nothing else, then you will get this error trying to configure a project that needs to link to it:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>CMake Error at C:/code/cmake-library-example/internal-project/libraries/SomeLibrary/install/cmake/SomeLibraryConfig.cmake:72 <span style="color:#f92672">(</span>message<span style="color:#f92672">)</span>:
</span></span><span style="display:flex;"><span>  The imported target <span style="color:#e6db74">&#34;some::SomeLibrary&#34;</span> references the file
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>     <span style="color:#e6db74">&#34;C:/code/cmake-library-example/internal-project/libraries/SomeLibrary/install/lib/SomeLibrary.lib&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  but this file does not exist.  Possible reasons include:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  * The file was deleted, renamed, or moved to another location.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  * An install or uninstall procedure did not complete successfully.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  * The installation package was faulty and contained
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>     <span style="color:#e6db74">&#34;C:/code/cmake-library-example/internal-project/libraries/SomeLibrary/install/cmake/SomeLibraryConfig.cmake&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  but not all the files it references.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Call Stack <span style="color:#f92672">(</span>most recent call first<span style="color:#f92672">)</span>:
</span></span><span style="display:flex;"><span>  CMakeLists.txt:9 <span style="color:#f92672">(</span>find_package<span style="color:#f92672">)</span></span></span></code></pre></div>
<p>And indeed, there is no <code>SomeLibrary.lib</code> in <code>install/lib/</code>, only <code>SomeLibrary.dll</code> in <code>install/bin/</code>. That is because a <a href="https://en.wikipedia.org/wiki/Dynamic-link_library">DLL on Windows</a> needs an explicit listing of all the symbols that it will export, and apparently this is what <code>SomeLibrary.lib</code> is supposed to be.</p>
<p>As I understood, in order to produce it, in past it was required to add <code>__declspec</code> compiler directives to every public single class or function declaration in your library sources, which is quite a bummer, especially if you have a lot of those. Here&rsquo;s <a href="https://cmake.org/pipermail/cmake/2008-August/023194.html">one example</a> of how this is done.</p>
<p>Fortunately, starting with CMake 3.4, this is <a href="https://blog.kitware.com/create-dlls-on-windows-without-declspec-using-new-cmake-export-all-feature/">no longer required</a>. Instead you can just set the <a href="https://cmake.org/cmake/help/latest/prop_tgt/WINDOWS_EXPORT_ALL_SYMBOLS.html">CMAKE_WINDOWS_EXPORT_ALL_SYMBOLS</a> option when configuring the library:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ cmake -DCMAKE_WINDOWS_EXPORT_ALL_SYMBOLS<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span> ..</span></span></code></pre></div>
<p>However, I saw somewhere that it is not recommended to export all the symbols like that. I didn&rsquo;t quite get why, but probably there is a reason, so just keep that in mind.</p>
<p>Either way, now you can build and install the library as usual. Note that if you are using Visual Studio generator, then <code>-DCMAKE_BUILD_TYPE</code> won&rsquo;t work, because with this generator the configuration type is specified on build:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ cmake --build . --target install --config Release</span></span></code></pre></div>
<p>After that configuring and building the external application will also succeed, because now it will get that missing <code>SomeLibrary.lib</code>.</p>
<p>However, unlike Mac OS and Linux, trying to run the resulting application will fail even if you haven&rsquo;t touched the <code>SomeLibrary.dll</code> in the install folder:</p>


    <img class="image-post" loading="lazy" src="/blog/2021/03/08/cmake-cpp-library/images/dll-was-not-found.png" alt="DLL was not found">

<p>or, if running from Git BASH:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ ./Release/another-application.exe
</span></span><span style="display:flex;"><span>C:/code/cmake-library-example/external-project/build/Release/another-application.exe: error <span style="color:#66d9ef">while</span> loading shared libraries: api-ms-win-crt-heap-l1-1-0.dll: cannot open shared object file: No such file or directory</span></span></code></pre></div>
<p>That is because on Windows you need to explicitly put the DLL either to the same folder where the executable is or somewhere in PATH.</p>
<h1 id="final-words-and-repository">Final words and repository</h1>
<p>Later I will probably update the article, because, like I said, here I touched only &ldquo;normal&rdquo; libraries, but there are also <a href="https://cmake.org/cmake/help/latest/command/add_library.html">other kinds</a>. Plus, one can go further than just making a CMake config and create a <a href="https://cmake.org/cmake/help/git-stage/guide/importing-exporting/index.html#creating-packages">proper package</a>. So there are quite a few things left to talk about.</p>
<p>You might have noticed that most of the stuff I was doing on Mac OS, but actually everything (<em>library and sample applications</em>) builds and works just fine also on Linux and Windows.</p>
<p>Full source code of the library, its parent project and external project are available in <a href="https://github.com/retifrav/cmake-library-example">this repository</a>.</p>
<hr class="updates-separator">
<h1 id="updates">Updates</h1>
<h2 id="2022-07-05--updated-repository">2022-07-05 | Updated repository</h2>
<p>Be aware that I&rsquo;ve been updating the referenced repository as I was discovering new things, but not everything has been synced-up back to the article, and so by now the article contains a somewhat simpler CMake code, while repository has a bit more advanced things (<em>such as installation instructions being a <a href="https://github.com/retifrav/cmake-library-example/blob/master/internal-project/libraries/SomeLibrary/cmake/Installing.cmake">separate CMake module</a></em>).</p>
<p>You might also want to take a look at the article about <a href="/blog/2021/09/23/cmake-cpack-package-deb-apt/">using CPack</a> and its <a href="https://github.com/retifrav/cmake-cpack-example">example project</a> (<em>you can ignore the packing parts</em>), as in particular it has a better organized installation and demonstrates re-using &ldquo;shared&rdquo; CMake modules.</p>
<h2 id="2022-09-17--dynamic-libraries-and-paths">2022-09-17 | Dynamic libraries and paths</h2>
<p>A useful addition about <a href="https://scivision.dev/cmake-libdl-dll/">dynamic libraries and paths</a>.</p>
<h2 id="2023-07-22--about-target_link_libraries-scopes">2023-07-22 | About target_link_libraries() scopes</h2>
<p>At some point later I also <a href="/blog/2023/07/22/cmake-target-link-libraries-scopes">wrote</a> about <code>target_link_libraries()</code> scopes in particular. There you will find <a href="https://github.com/retifrav/cmake-target-link-libraries-example">yet another repository</a>, which I now consider to be my best example of creating C++ libraries with CMake (<em>until I learn some more CMake and make an even better one</em>). Among other improvements, it includes exporting symbols for making a <code>.lib</code> file for DLLs on Windows.</p>
      </div>
    </article>
    <div><div id="tags">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tag">
  <path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path><line x1="7" y1="7" x2="7" y2="7"></line>
</svg>
          <a class="tag" href="https://retifrav.github.io/tags/cmake/">cmake</a><a class="tag" href="https://retifrav.github.io/tags/cpp/">cpp</a></div><hr class="comments-divider"/>
      <div id="comments">
      
          <script>
  var id =  59 ;

  if (id)
  {
    let url = "https://github.com/retifrav/retifrav.github.io/issues/".concat(id);
    let api_url = "https://api.github.com/repos/retifrav/retifrav.github.io/issues/".concat(id, "/comments");
    
    var commentsDiv = document.getElementById("comments");

    let xhr = new XMLHttpRequest();
    xhr.responseType = "json";
    xhr.open("GET", api_url);
    xhr.setRequestHeader("Accept", "application/vnd.github.v3.html+json");
    xhr.send();

    xhr.onload = function()
    {
      if (xhr.status != 200)
      {
        let errorText = document.createElement("p");
        errorText.innerHTML = "<i>Comments for this post yet are not opened yet (or you have GitHub scripts disabled).</i>";
        commentsDiv.appendChild(errorText);
      }
      else
      {
        let comments = xhr.response;

        let mainHeader = document.createElement("h2");
        mainHeader.innerHTML = "Comments: ".concat(comments.length);
        commentsDiv.appendChild(mainHeader);

        let issueLink = document.createElement("p");
        issueLink.innerHTML = "<i>You can leave a comment using this <a href='".concat(url, "'>GitHub issue</a>.</i>");
        commentsDiv.appendChild(issueLink);
        
        comments.forEach(function(comment)
        {
            let commentContent = document.createElement("div");
            commentContent.setAttribute('class', 'gh-comment')
            commentContent.innerHTML = "".concat(
                "<div class='gh-header'>",
                  "<img src='", comment.user.avatar_url, "' />",
                  "<div style='margin:auto 0;'>",
                    "<b><a class='gh-username' href='", comment.user.html_url, "'>", comment.user.login, "</a></b>",
                    " commented at <em>", new Date(comment.created_at), "</em>",
                  "</div>",
                "</div>",
                "<div class='gh-body'>",
                  comment.body_html,
                "</div>"
            );
            commentsDiv.appendChild(commentContent);
        });
      }
    };

    xhr.onerror = function()
    {
      let errorText = document.createElement("p");
      errorText.innerHTML = "<i>Some error loading comments.</i>";
      commentsDiv.appendChild(errorText);
    };
  }
</script>

      
      </div>
    </div>
  </div>

  
        <div id="footer">
          <div>
              2014 - 2024,
              <a href="/about/">retif</a>
          </div>
          <div><a href="/about/#licenses">CC BY-SA 4.0 / GPLv3</a></div>
        </div>
      </main>
      <div class="app-header">
        <div style="margin:0 0 20px;">
            <input id="search-query" placeholder="Search in titles and summaries" />
        </div>
        <div id="search-results" style="display:none;"></div>
        <div id="sidebars">
            <a id="avatar" href="/about"><img class="app-header-avatar" src="/images/avatar.png" /></a>
            <iframe src="https://github.com/sponsors/retifrav/button"
                height="35" style="border:0;"
                title="You can sponsor me">
            </iframe>
            
            <div class="sidebar-section">
              <h3>Feeds</h3>
              <a href="/index.xml" title="Subscribe to RSS"><img src="/images/rss.png" width="50px"></a>
              <a style="margin-left: 5px;" href="https://t.me/decovar" title="Telegram channel"><img src="/images/telegram.png" width="50px"></a>
            </div>
            <div id="telegramWidgetBlock" class="sidebar-section"></div>
            <div class="sidebar-section">
                <h3>Stuff</h3>
                <ul class="sidebar-list">
                    <li><a href="/stuff/kakoi-jvotne-vi-kysaiti/index.html">КАКОИ ЖВОТНЕ ВЫ КУСАИТИ?</a></li>
                </ul>
            </div>
            <div id="social-networks" class="sidebar-section">
              <h3>Social networks</h3>
              <div style="font-family:Courier New;">
                  Zuck: <i>Yeah so if you ever need info about anyone at Harvard</i><br/>
                  Zuck: <i>Just ask</i><br/>
                  Zuck: <i>I have over 4,000 emails, pictures, addresses, SNS</i><br/>
                  smb: <i>What? How'd you manage that one?</i><br/>
                  Zuck: <i>People just submitted it.</i><br/>
                  Zuck: <i>I don't know why.</i><br/>
                  Zuck: <i>They "trust me"</i><br/>
                  Zuck: <i>Dumb fucks</i>
              </div>
            </div>
            <div class="sidebar-section">
              <h3>Tags</h3>
              <ul style="list-style-type:none; padding:0; margin:0;">
                  
                  <li><a href="/tags/web">web (67)</a></li>
                  
                  <li><a href="/tags/fail">fail (40)</a></li>
                  
                  <li><a href="/tags/dotnet">dotnet (36)</a></li>
                  
                  <li><a href="/tags/qt">qt (35)</a></li>
                  
                  <li><a href="/tags/linux">linux (28)</a></li>
                  
                  <li><a href="/tags/review">review (28)</a></li>
                  
                  <li><a href="/tags/devops">devops (23)</a></li>
                  
                  <li><a href="/tags/macos">macos (23)</a></li>
                  
                  <li><a href="/tags/windows">windows (19)</a></li>
                  
                  <li><a href="/tags/mestuff">mestuff (17)</a></li>
                  
                  <li><a href="/tags/movies">movies (15)</a></li>
                  
                  <li><a href="/tags/norway">norway (15)</a></li>
                  
                  <li><a href="/tags/tractor">tractor (15)</a></li>
                  
                  <li><a href="/tags/cpp">cpp (12)</a></li>
                  
                  <li><a href="/tags/irl">irl (12)</a></li>
                  
                  <li><a href="/tags/python">python (12)</a></li>
                  
                  <li><a href="/tags/telegram">telegram (12)</a></li>
                  
                  <li><a href="/tags/cmake">cmake (11)</a></li>
                  
                  <li><a href="/tags/embedded">embedded (11)</a></li>
                  
                  <li><a href="/tags/soft">soft (10)</a></li>
                  
                  <li><a href="/tags/travel">travel (10)</a></li>
                  
                  <li><a href="/tags/applescript">applescript (9)</a></li>
                  
                  <li><a href="/tags/piracy">piracy (9)</a></li>
                  
                  <li><a href="/tags/octopress">octopress (8)</a></li>
                  
                  <li><a href="/tags/banks">banks (7)</a></li>
                  
                  <li><a href="/tags/games">games (7)</a></li>
                  
                  <li><a href="/tags/ios">ios (7)</a></li>
                  
                  <li><a href="/tags/apple">apple (6)</a></li>
                  
                  <li><a href="/tags/javascript">javascript (6)</a></li>
                  
                  <li><a href="/tags/photo">photo (6)</a></li>
                  
                  <li><a href="/tags/sql">sql (6)</a></li>
                  
                  <li><a href="/tags/russia">russia (5)</a></li>
                  
                  <li><a href="/tags/android">android (4)</a></li>
                  
                  <li><a href="/tags/hugo">hugo (4)</a></li>
                  
                  <li><a href="/tags/usa">usa (4)</a></li>
                  
                  <li><a href="/tags/wordpress">wordpress (4)</a></li>
                  
                  <li><a href="/tags/azure">azure (3)</a></li>
                  
                  <li><a href="/tags/tv">tv (3)</a></li>
                  
                  <li><a href="/tags/privacy">privacy (2)</a></li>
                  
                  <li><a href="/tags/steam-deck">steam-deck (2)</a></li>
                  
                  <li><a href="/tags/tvos">tvos (2)</a></li>
                  
                  <li><a href="/tags/unsolved">unsolved (2)</a></li>
                  
                  <li><a href="/tags/books">books (1)</a></li>
                  
                  <li><a href="/tags/ffmpeg">ffmpeg (1)</a></li>
                  
                  <li><a href="/tags/home-automation">home-automation (1)</a></li>
                  
                  <li><a href="/tags/ldap">ldap (1)</a></li>
                  
                  <li><a href="/tags/music">music (1)</a></li>
                  
                  <li><a href="/tags/science">science (1)</a></li>
                  
                  <li><a href="/tags/vr">vr (1)</a></li>
                  
              </ul>
            </div>
        </div>
      </header>
    </div>

    <script src="/js/search.js"></script>

    
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-53340325-1"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag() { dataLayer.push(arguments); }
      gtag("js", new Date());
      gtag("config", "UA-53340325-1");
    </script>

    <script>
        const telegramBlock = document.getElementById("telegramWidgetBlock");
        window.onload = () =>
        {
            const pinnedTelegramPosts = [306,319,323]
            const randomedPostID = pinnedTelegramPosts[
                Math.floor(Math.random() * pinnedTelegramPosts.length)
            ];
            const telegramWidgetScript = document.createElement("script");
            telegramWidgetScript.src = "https://telegram.org/js/telegram-widget.js?21";
            telegramWidgetScript.dataset["telegramPost"] = `decovar/${randomedPostID}`;
            telegramWidgetScript.dataset["color"] = "1E8448";
            telegramWidgetScript.dataset["width"] = "100%";
            telegramWidgetScript.dataset["userpic"] = "false";
            telegramBlock.appendChild(telegramWidgetScript);
        }
    </script>

    
    
  </body>
</html>
