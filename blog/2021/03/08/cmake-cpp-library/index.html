<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Creating a C&#43;&#43; library with CMake | Declaration of VAR</title>

    <meta name="generator" content="Hugo 0.81.0" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <link href="/favicon.png" rel="icon">

    <meta name="author" content="retif" />
    <meta name="description" content="" />

    <link rel="alternate" type="application/rss+xml" href="/index.xml" title="Declaration of VAR" />

    <meta property="og:title" content="Creating a C&#43;&#43; library with CMake" />
<meta property="og:description" content="All of the sudden I found myself in a situation that I have been successfully avoiding so far - I needed to make a C&#43;&#43; library with CMake.



    


To clarify, this will be about so-called normal kind of library." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://retifrav.github.io/blog/2021/03/08/cmake-cpp-library/" /><meta property="article:section" content="blog" />
<meta property="article:published_time" content="2021-03-08T20:41:56&#43;01:00" />
<meta property="article:modified_time" content="2021-03-08T20:41:56&#43;01:00" />



    <link rel="stylesheet" href="https://retifrav.github.io/css/main.min.c1a9d5434fbba746ef09ebde219b0064b5d4318930fc8463f51550f13a0e1b54.css" />
    <link rel="stylesheet" href="/css/default.css" />
    <link rel="stylesheet" href="/css/post.css" />
    <link rel="stylesheet" href="/css/page.css" />
    <link rel="stylesheet" href="/css/comments.css" />

    <script src="/js/mark.js"></script>

    
    
  </head>
  <body>
    <div id="body-hat">
      <div id="title-block">
        <h1 id="blog-title"><a href="/">Declaration of VAR</a></h1>
        <p>and some other stuff</p>
      </div>
    </div>
    <div id="body-flex">
      <main class="app-container">
        
  <div id="main-container">
    <article class="post">
      <header class="post-header">
        <h1 class ="post-title">Creating a C&#43;&#43; library with CMake</h1>
        <div class="post-meta">
          <div><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-calendar">
  <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line>
</svg> 2021-03-08 20:41:56 &#43;0100</div>
          <div><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-clock">
  <circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline>
</svg> 17 min read</div>
        </div>
      </header>
      <div class="post-content">
        <p>All of the sudden I found myself in a situation that I have been successfully avoiding so far - I needed to make a C++ library with CMake.</p>



    <img class="image-post" src="/blog/2021/03/08/cmake-cpp-library/images/cmake-library.png" alt="CMake and a library">


<p>To clarify, this will be about so-called <a href="https://cmake.org/cmake/help/latest/command/add_library.html#normal-libraries">normal</a> kind of library.</p>
<nav id="TableOfContents">
  <ul>
    <li><a href="#the-library">The library</a>
      <ul>
        <li><a href="#folder-structure-and-sources">Folder structure and sources</a></li>
        <li><a href="#cmakelists">CMakeLists</a>
          <ul>
            <li><a href="#top-level-and-nested-projects">Top-level and nested projects</a></li>
            <li><a href="#target">Target</a></li>
            <li><a href="#include-directories">Include directories</a></li>
            <li><a href="#install-instructions">Install instructions</a></li>
          </ul>
        </li>
        <li><a href="#building-and-installing">Building and installing</a></li>
      </ul>
    </li>
    <li><a href="#linking-to-the-library">Linking to the library</a>
      <ul>
        <li><a href="#from-external-project">From external project</a></li>
        <li><a href="#from-internal-top-level-project">From internal top-level project</a>
          <ul>
            <li><a href="#adding-nested-library-to-the-main-project">Adding nested library to the main project</a></li>
            <li><a href="#about-include-paths">About include paths</a></li>
            <li><a href="#building">Building</a>
              <ul>
                <li><a href="#main-project">Main project</a></li>
                <li><a href="#library-as-a-target">Library as a target</a></li>
              </ul>
            </li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#going-deeper">Going deeper</a>
      <ul>
        <li><a href="#package-version">Package version</a></li>
        <li><a href="#static-vs-shared">STATIC vs SHARED</a>
          <ul>
            <li><a href="#shared-dll-on-windows">SHARED DLL on Windows</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#final-words-and-repository">Final words and repository</a></li>
  </ul>
</nav>
<h1 id="the-library">The library</h1>
<h2 id="folder-structure-and-sources">Folder structure and sources</h2>
<p>For the sake of focusing on CMake side of things, the library itself is very trivial:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">├── CMakeLists.txt
├── include
│   └── some.h
└── src
    ├── some.cpp
    └── things.h</code></pre></div>
<p>This particular folder structure is not enforced, but I&rsquo;ve seen it being used around and I think it serves nicely for the purpose of keeping library files organized. Following this structure, you put internal library sources and headers to <code>src</code> folder, and public headers go to <code>include</code> folder.</p>
<p>Public headers is something other projects will use to interface with your library. That is how they will know what functions are available in it and what is their signature (<em>parameters names and types</em>). So, <code>include/some.h</code> is a public header, and here are its contents:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#75715e">#ifndef SOME_H
</span><span style="color:#75715e">#define SOME_H
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">namespace</span> sm
{
    <span style="color:#66d9ef">namespace</span> lbr
    {
        <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">printSomething</span>();
    }
}

<span style="color:#75715e">#endif </span><span style="color:#75715e">// SOME_H
</span></code></pre></div>
<p>So our library has just one function. Its definition is in <code>src/some.cpp</code>:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;iostream&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e">#include</span> <span style="color:#75715e">&#34;things.h&#34;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">namespace</span> sm
{
    <span style="color:#66d9ef">namespace</span> lbr
    {
        <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">printSomething</span>()
        {
            std<span style="color:#f92672">::</span>cout <span style="color:#f92672">&lt;&lt;</span> <span style="color:#e6db74">&#34;ololo, &#34;</span> <span style="color:#f92672">&lt;&lt;</span> someString <span style="color:#f92672">&lt;&lt;</span> std<span style="color:#f92672">::</span>endl;
        }
    }
}
</code></pre></div>
<p>As you can see, this function just prints a message to standard output. The <code>someString</code> variable comes from internal header <code>src/things.h</code>:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;string&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">const</span> std<span style="color:#f92672">::</span>string someString <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;some string&#34;</span>;
</code></pre></div>
<h2 id="cmakelists">CMakeLists</h2>
<p>Making a library with CMake is not that different from making an application - instead of <a href="https://cmake.org/cmake/help/latest/command/add_executable.html">add_executable</a> you call <a href="https://cmake.org/cmake/help/latest/command/add_library.html">add_library</a>. But doing just that would be too easy, wouldn&rsquo;t it.</p>
<p>Here are some of the things you need to take care of:</p>
<ul>
<li>what artifacts should the library produce at install step</li>
<li>where install artifacts should be placed</li>
<li>how other applications can find the library
<ul>
<li>when they are using it pre-built as an external dependency</li>
<li>when its sources are nested in their source tree</li>
</ul>
</li>
<li>will it be static or shared library
<ul>
<li>will you need to have it as DLL on Windows</li>
</ul>
</li>
</ul>
<p>Everything from this list is handled by CMake. So let&rsquo;s gradually create a <code>CMakeLists.txt</code> for the library project.</p>
<h3 id="top-level-and-nested-projects">Top-level and nested projects</h3>
<p>In CMake projects there is a variable called <a href="https://cmake.org/cmake/help/latest/variable/CMAKE_PROJECT_NAME.html">CMAKE_PROJECT_NAME</a>. It stores the top-level project name that you set with <a href="https://cmake.org/cmake/help/latest/command/project.html">project</a> command. This variable persists across all the nested projects, and so calling <code>project</code> command from nested projects will not change <code>CMAKE_PROJECT_NAME</code>, but will set another variable called <a href="https://cmake.org/cmake/help/latest/variable/PROJECT_NAME.html">PROJECT_NAME</a>.</p>
<p>Knowing that, here&rsquo;s how you can check if you are in the top-level project or not:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cmake" data-lang="cmake">project(<span style="color:#e6db74">&#34;SomeLibrary&#34;</span> <span style="color:#e6db74">DESCRIPTION</span> <span style="color:#e6db74">&#34;Some library&#34;</span>)<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>if (<span style="color:#e6db74">NOT</span> <span style="color:#e6db74">CMAKE_PROJECT_NAME</span> <span style="color:#e6db74">STREQUAL</span> <span style="color:#e6db74">PROJECT_NAME</span>)<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>    message(<span style="color:#e6db74">STATUS</span> <span style="color:#e6db74">&#34;This project has a top-level one called [${CMAKE_PROJECT_NAME}]&#34;</span>)<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>else()<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>    message(<span style="color:#e6db74">STATUS</span> <span style="color:#e6db74">&#34;This project is a top-level one&#34;</span>)<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>endif()</code></pre></div>
<p>Why even bother with this? Because later we will be setting certain properties for the <a href="#target">target</a> (<em>our library</em>). And I saw in lots of places how people copy-paste project name value to every command, which I believe is just a bad idea - it is much better to use already defined <code>PROJECT_NAME</code> variable instead, innit.</p>
<h3 id="target">Target</h3>
<p>Here go the library <a href="https://cmake.org/cmake/help/latest/manual/cmake-buildsystem.7.html#introduction">target</a> and its sources:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#75715e"># here you can see how instead of writing &#34;SomeLibrary&#34;
</span><span style="color:#75715e"># we can just use the PROJECT_NAME variable
</span><span style="color:#75715e"></span>add_library(<span style="color:#960050;background-color:#1e0010">$</span>{PROJECT_NAME} STATIC)

target_sources(<span style="color:#960050;background-color:#1e0010">$</span>{PROJECT_NAME}
    PRIVATE
        src<span style="color:#f92672">/</span>some.cpp
)
</code></pre></div>
<p>Here the library is defined as <code>STATIC</code>, but there will be a section about <a href="#static-vs-shared">shared</a> libraries too.</p>
<h3 id="include-directories">Include directories</h3>
<p>Setting include directories correctly with <a href="https://cmake.org/cmake/help/latest/command/target_include_directories.html">target_include_directories</a> is very important:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cmake" data-lang="cmake">target_include_directories(<span style="color:#f92672">${</span>PROJECT_NAME<span style="color:#f92672">}</span>
    <span style="color:#e6db74">PRIVATE</span>
        <span style="color:#75715e"># where the library itself will look for its internal headers
</span><span style="color:#75715e"></span>        <span style="color:#f92672">${</span>CMAKE_CURRENT_SOURCE_DIR<span style="color:#f92672">}</span><span style="color:#e6db74">/src</span>
    <span style="color:#e6db74">PUBLIC</span>
        <span style="color:#75715e"># where top-level project will look for the library&#39;s public headers
</span><span style="color:#75715e"></span>        <span style="color:#f92672">$&lt;</span>BUILD_INTERFACE:${CMAKE_CURRENT_SOURCE_DIR}/include<span style="color:#f92672">&gt;</span>
        <span style="color:#75715e"># where external projects will look for the library&#39;s public headers
</span><span style="color:#75715e"></span>        <span style="color:#f92672">$&lt;</span>INSTALL_INTERFACE:${CMAKE_INSTALL_INCLUDEDIR}<span style="color:#f92672">&gt;</span>
)</code></pre></div>
<p>Paths in <code>PRIVATE</code> section are used by the library to find its own internal headers. So if you would place <code>things.h</code> to <code>./src/hdrs/things.h</code>, then you will need to set this path to <code>${CMAKE_CURRENT_SOURCE_DIR}/src/hdrs</code>.</p>
<p>Paths in <code>PUBLIC</code> section are used by projects that link to this library. That&rsquo;s where they will look for its public headers:</p>
<ul>
<li><code>BUILD_INTERFACE</code> path is meant for projects that will build the library from their source tree, and here you need to add <code>include</code>, because that&rsquo;s where public headers are in the library&rsquo;s source folder</li>
<li><code>INSTALL_INTERFACE</code> is meant for external projects, and here you don&rsquo;t need to add <code>include</code>, because CMake config will do that for you</li>
</ul>
<h3 id="install-instructions">Install instructions</h3>
<p>We need to declare what artifacts should be put to installation directory after building the library. You also need to specify the path of installation directory (<em>where you would like it to be</em>).</p>
<p>Certainly, just building the library is already enough to be able to link to it, but we want to do it in the most comfortable way: not by providing paths to its binaries and headers from both build and sources directories, but by <a href="https://cmake.org/cmake/help/latest/command/install.html">installing</a> just the artifacts we need and using <a href="https://cmake.org/cmake/help/latest/command/find_package.html">find_package</a> command.</p>
<p>With <code>find_package</code> you let CMake to worry about finding the library, its public headers and configuring all that. Here&rsquo;s a more detailed <a href="https://cmake.org/cmake/help/latest/manual/cmake-packages.7.html">documentation</a> about how <code>find_package</code> works, and here&rsquo;s how you can create a <a href="https://cmake.org/cmake/help/git-stage/guide/importing-exporting/index.html#exporting-targets">CMake config</a> of your own.</p>
<p>First thing to think about it is the installation path. If you will not set it during configuration step via <a href="https://cmake.org/cmake/help/latest/variable/CMAKE_INSTALL_PREFIX.html">CMAKE_INSTALL_PREFIX</a> (<em><code>-DCMAKE_INSTALL_PREFIX=&quot;/some/path&quot;</code></em>), then CMake will set it to some system libraries path, which you might not want to use, especially if you are building your library for distribution.</p>
<p>Here&rsquo;s how you can overwrite default installation path to install the artifacts into <code>install</code> folder in your source tree:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cmake" data-lang="cmake"><span style="color:#75715e"># note that it is not CMAKE_INSTALL_PREFIX we are checking here
</span><span style="color:#75715e"></span>if(<span style="color:#e6db74">DEFINED</span> <span style="color:#e6db74">CMAKE_INSTALL_PREFIX_INITIALIZED_TO_DEFAULT</span>)<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>    message(
        <span style="color:#e6db74">STATUS</span>
        <span style="color:#e6db74">&#34;CMAKE_INSTALL_PREFIX is not set\n&#34;</span>
        <span style="color:#e6db74">&#34;Default value: ${CMAKE_INSTALL_PREFIX}\n&#34;</span>
        <span style="color:#e6db74">&#34;Will set it to ${CMAKE_SOURCE_DIR}/install&#34;</span>
    )<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>    set(<span style="color:#e6db74">CMAKE_INSTALL_PREFIX</span>
        <span style="color:#e6db74">&#34;${CMAKE_SOURCE_DIR}/install&#34;</span>
        <span style="color:#e6db74">CACHE</span> <span style="color:#e6db74">PATH</span> <span style="color:#e6db74">&#34;Where the library will be installed to&#34;</span> <span style="color:#e6db74">FORCE</span>
    )<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>else()<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>    message(
        <span style="color:#e6db74">STATUS</span>
        <span style="color:#e6db74">&#34;CMAKE_INSTALL_PREFIX was already set\n&#34;</span>
        <span style="color:#e6db74">&#34;Current value: ${CMAKE_INSTALL_PREFIX}&#34;</span>
    )<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>endif()</code></pre></div>
<p>Next thing you need to do is to declare <a href="https://cmake.org/cmake/help/latest/prop_tgt/PUBLIC_HEADER.html">PUBLIC_HEADER</a> property:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cmake" data-lang="cmake"><span style="color:#75715e"># without it public headers won&#39;t get installed
</span><span style="color:#75715e"></span>set(<span style="color:#e6db74">public_headers</span>
    <span style="color:#e6db74">include/some.h</span>
)<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#75715e"># note that ${public_headers} has to be in quotes
</span><span style="color:#75715e"></span>set_target_properties(<span style="color:#f92672">${</span>PROJECT_NAME<span style="color:#f92672">}</span> <span style="color:#e6db74">PROPERTIES</span> <span style="color:#e6db74">PUBLIC_HEADER</span> <span style="color:#e6db74">&#34;${public_headers}&#34;</span>)</code></pre></div>
<p>Not related to public headers, but it might be a good idea to add <code>d</code> suffix to debug binaries - that way you&rsquo;ll get <code>libSomeLibraryd.a</code> with Debug configuration and <code>libSomeLibrary.a</code> with Release. To do that you need to set the <a href="https://cmake.org/cmake/help/latest/prop_tgt/CONFIG_POSTFIX.html">DEBUG_POSTFIX</a> property:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cmake" data-lang="cmake">set_target_properties(<span style="color:#f92672">${</span>PROJECT_NAME<span style="color:#f92672">}</span> <span style="color:#e6db74">PROPERTIES</span> <span style="color:#e6db74">DEBUG_POSTFIX</span> <span style="color:#e6db74">&#34;d&#34;</span>)</code></pre></div>
<p>And here finally come the actual installation instructions:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cmake" data-lang="cmake"><span style="color:#75715e"># definitions of CMAKE_INSTALL_LIBDIR, CMAKE_INSTALL_INCLUDEDIR and others
</span><span style="color:#75715e"></span>include(<span style="color:#e6db74">GNUInstallDirs</span>)<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#75715e"># paths for binaries and headers
</span><span style="color:#75715e"></span>install(<span style="color:#e6db74">TARGETS</span> <span style="color:#f92672">${</span>PROJECT_NAME<span style="color:#f92672">}</span>
    <span style="color:#e6db74">EXPORT</span> <span style="color:#e6db74">&#34;${PROJECT_NAME}Config&#34;</span>
    <span style="color:#e6db74">LIBRARY</span> <span style="color:#e6db74">DESTINATION</span> <span style="color:#f92672">${</span>CMAKE_INSTALL_LIBDIR<span style="color:#f92672">}</span> <span style="color:#75715e"># lib
</span><span style="color:#75715e"></span>    <span style="color:#e6db74">ARCHIVE</span> <span style="color:#e6db74">DESTINATION</span> <span style="color:#f92672">${</span>CMAKE_INSTALL_LIBDIR<span style="color:#f92672">}</span> <span style="color:#75715e"># lib
</span><span style="color:#75715e"></span>    <span style="color:#e6db74">RUNTIME</span> <span style="color:#e6db74">DESTINATION</span> <span style="color:#f92672">${</span>CMAKE_INSTALL_BINDIR<span style="color:#f92672">}</span> <span style="color:#75715e"># bin
</span><span style="color:#75715e"></span>    <span style="color:#e6db74">INCLUDES</span> <span style="color:#e6db74">DESTINATION</span> <span style="color:#f92672">${</span>CMAKE_INSTALL_INCLUDEDIR<span style="color:#f92672">}</span> <span style="color:#75715e"># include
</span><span style="color:#75715e"></span>    <span style="color:#e6db74">PUBLIC_HEADER</span> <span style="color:#e6db74">DESTINATION</span> <span style="color:#f92672">${</span>CMAKE_INSTALL_INCLUDEDIR<span style="color:#f92672">}</span><span style="color:#e6db74">/</span><span style="color:#f92672">${</span>PROJECT_NAME<span style="color:#f92672">}</span> <span style="color:#75715e"># include/SomeLibrary
</span><span style="color:#75715e"></span>)<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#75715e"># CMake config name, namespace and path
</span><span style="color:#75715e"></span>install(
    <span style="color:#e6db74">EXPORT</span> <span style="color:#e6db74">&#34;${PROJECT_NAME}Config&#34;</span>
    <span style="color:#e6db74">FILE</span> <span style="color:#e6db74">&#34;${PROJECT_NAME}Config.cmake&#34;</span>
    <span style="color:#e6db74">NAMESPACE</span> <span style="color:#e6db74">some::</span>
    <span style="color:#e6db74">DESTINATION</span> <span style="color:#e6db74">cmake</span>
)</code></pre></div>
<p>The <code>NAMESPACE</code> property is exactly what is looks like - a namespace of your library. I reckon, that will help to avoid names collision, but most likely it will allow to group stuff in the namespace similar to <a href="https://doc.qt.io/qt-5/cmake-get-started.html#build-a-gui-executable">how Qt does it</a>:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cmake" data-lang="cmake">target_link_libraries(<span style="color:#e6db74">helloworld</span> <span style="color:#e6db74">Qt5::Widgets</span>)</code></pre></div>
<h2 id="building-and-installing">Building and installing</h2>
<p>Go to library source tree root and run the usual:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">$ mkdir build <span style="color:#f92672">&amp;&amp;</span> cd $_

$ cmake ..
-- The C compiler identification is AppleClang 12.0.0.12000032
-- The CXX compiler identification is AppleClang 12.0.0.12000032
-- Detecting C compiler ABI info
-- Detecting C compiler ABI info - <span style="color:#66d9ef">done</span>
-- Check <span style="color:#66d9ef">for</span> working C compiler: /Applications/Xcode.app/Contents/Developer/Toolchains/XcodeDefault.xctoolchain/usr/bin/cc - skipped
-- Detecting C compile features
-- Detecting C compile features - <span style="color:#66d9ef">done</span>
-- Detecting CXX compiler ABI info
-- Detecting CXX compiler ABI info - <span style="color:#66d9ef">done</span>
-- Check <span style="color:#66d9ef">for</span> working CXX compiler: /Applications/Xcode.app/Contents/Developer/Toolchains/XcodeDefault.xctoolchain/usr/bin/c++ - skipped
-- Detecting CXX compile features
-- Detecting CXX compile features - <span style="color:#66d9ef">done</span>
-- This project is a top-level one
-- CMAKE_INSTALL_PREFIX is not set
Default value: /usr/local
Will set it to /Users/YOURNAME/code/cpp/someLibrary/install
-- Configuring <span style="color:#66d9ef">done</span>
-- Generating <span style="color:#66d9ef">done</span>
-- Build files have been written to: /Users/YOURNAME/code/cpp/someLibrary/build

$ cmake --build . --target install
Scanning dependencies of target SomeLibrary
<span style="color:#f92672">[</span> 50%<span style="color:#f92672">]</span> Building CXX object CMakeFiles/SomeLibrary.dir/src/some.cpp.o
<span style="color:#f92672">[</span>100%<span style="color:#f92672">]</span> Linking CXX static library libSomeLibrary.a
<span style="color:#f92672">[</span>100%<span style="color:#f92672">]</span> Built target SomeLibrary
Install the project...
-- Install configuration: <span style="color:#e6db74">&#34;&#34;</span>
-- Installing: /Users/YOURNAME/code/cpp/someLibrary/install/lib/libSomeLibrary.a
-- Installing: /Users/YOURNAME/code/cpp/someLibrary/install/include/SomeLibrary/some.h
-- Installing: /Users/YOURNAME/code/cpp/someLibrary/install/cmake/SomeLibraryConfig.cmake
-- Installing: /Users/YOURNAME/code/cpp/someLibrary/install/cmake/SomeLibraryConfig-noconfig.cmake

$ tree ../install/
├── cmake
│   ├── SomeLibraryConfig-noconfig.cmake
│   └── SomeLibraryConfig.cmake
├── include
│   └── SomeLibrary
│       └── some.h
└── lib
    └── libSomeLibrary.a</code></pre></div>
<p>Note that <code>SomeLibraryConfig-noconfig.cmake</code> has this weird <code>noconfig</code> suffix. This is because we ran configuration without specifying the build type - better to explicitly set it then, both Debug and Release:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">$ rm -r ../install/* <span style="color:#f92672">&amp;&amp;</span> rm -r ./* <span style="color:#f92672">&amp;&amp;</span> cmake -DCMAKE_BUILD_TYPE<span style="color:#f92672">=</span>Debug ..

$ cmake --build . --target install
Scanning dependencies of target SomeLibrary
<span style="color:#f92672">[</span> 50%<span style="color:#f92672">]</span> Building CXX object CMakeFiles/SomeLibrary.dir/src/some.cpp.o
<span style="color:#f92672">[</span>100%<span style="color:#f92672">]</span> Linking CXX static library libSomeLibraryd.a
<span style="color:#f92672">[</span>100%<span style="color:#f92672">]</span> Built target SomeLibrary
Install the project...
-- Install configuration: <span style="color:#e6db74">&#34;Debug&#34;</span>
-- Installing: /Users/YOURNAME/code/cpp/someLibrary/install/lib/libSomeLibraryd.a
-- Installing: /Users/YOURNAME/code/cpp/someLibrary/install/include/SomeLibrary/some.h
-- Installing: /Users/YOURNAME/code/cpp/someLibrary/install/cmake/SomeLibraryConfig.cmake
-- Installing: /Users/YOURNAME/code/cpp/someLibrary/install/cmake/SomeLibraryConfig-debug.cmake

$ rm -r ./* <span style="color:#f92672">&amp;&amp;</span> cmake -DCMAKE_BUILD_TYPE<span style="color:#f92672">=</span>Release ..

$ cmake --build . --target install
Scanning dependencies of target SomeLibrary
<span style="color:#f92672">[</span> 50%<span style="color:#f92672">]</span> Building CXX object CMakeFiles/SomeLibrary.dir/src/some.cpp.o
<span style="color:#f92672">[</span>100%<span style="color:#f92672">]</span> Linking CXX static library libSomeLibrary.a
<span style="color:#f92672">[</span>100%<span style="color:#f92672">]</span> Built target SomeLibrary
Install the project...
-- Install configuration: <span style="color:#e6db74">&#34;Release&#34;</span>
-- Installing: /Users/YOURNAME/code/cpp/someLibrary/install/lib/libSomeLibrary.a
-- Up-to-date: /Users/YOURNAME/code/cpp/someLibrary/install/include/SomeLibrary/some.h
-- Installing: /Users/YOURNAME/code/cpp/someLibrary/install/cmake/SomeLibraryConfig.cmake
-- Installing: /Users/YOURNAME/code/cpp/someLibrary/install/cmake/SomeLibraryConfig-release.cmake

$ tree ../install/
├── cmake
│   ├── SomeLibraryConfig-debug.cmake
│   ├── SomeLibraryConfig-release.cmake
│   └── SomeLibraryConfig.cmake
├── include
│   └── SomeLibrary
│       └── some.h
└── lib
    ├── libSomeLibrary.a
    └── libSomeLibraryd.a</code></pre></div>
<p>So there you have it! The library has been successfully built and nicely installed, so now you can just zip the <code>install</code> folder contents and distribute it to your users.</p>
<h1 id="linking-to-the-library">Linking to the library</h1>
<p>Now let&rsquo;s see how your users or yourself can link to the <a href="#the-library">library</a>.</p>
<h2 id="from-external-project">From external project</h2>
<p>Let&rsquo;s take a simple project:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">$ cd ~/code/cpp/external-project

$ tree .
├── CMakeLists.txt
└── main.cpp</code></pre></div>
<p>The source:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;iostream&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">// note that you need to prepend some.h with the folder name,
</span><span style="color:#75715e">// because that is how it is in the installation folder:
</span><span style="color:#75715e">// install/include/SomeLibrary/some.h
</span><span style="color:#75715e"></span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;SomeLibrary/some.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>(<span style="color:#66d9ef">int</span> argc, <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>argv[])
{
    std<span style="color:#f92672">::</span>cout <span style="color:#f92672">&lt;&lt;</span> <span style="color:#e6db74">&#34;base application message&#34;</span> <span style="color:#f92672">&lt;&lt;</span> std<span style="color:#f92672">::</span>endl;
    <span style="color:#75715e">// here we call a function from the library
</span><span style="color:#75715e"></span>    sm<span style="color:#f92672">::</span>lbr<span style="color:#f92672">::</span>printSomething();
}
</code></pre></div>
<p>The project file:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cmake" data-lang="cmake">project(<span style="color:#e6db74">&#34;another-application&#34;</span> <span style="color:#e6db74">VERSION</span> <span style="color:#e6db74">0.9</span> <span style="color:#e6db74">DESCRIPTION</span> <span style="color:#e6db74">&#34;A project with external library&#34;</span>)<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#75715e"># provide the library installation folder, so CMake could find its config
</span><span style="color:#75715e"></span>set(<span style="color:#e6db74">CMAKE_PREFIX_PATH</span> <span style="color:#e6db74">&#34;/Users/YOURNAME/code/cpp/someLibrary/install&#34;</span>)<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#75715e"># the rest will be taken care of by CMake
</span><span style="color:#75715e"></span>find_package(<span style="color:#e6db74">SomeLibrary</span> <span style="color:#e6db74">CONFIG</span> <span style="color:#e6db74">REQUIRED</span>)<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#75715e"># it is an application
</span><span style="color:#75715e"></span>add_executable(<span style="color:#f92672">${</span>PROJECT_NAME<span style="color:#f92672">}</span>)<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>target_sources(<span style="color:#f92672">${</span>PROJECT_NAME<span style="color:#f92672">}</span>
    <span style="color:#e6db74">PRIVATE</span>
        <span style="color:#e6db74">main.cpp</span>
)<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#75715e"># linking to the library, here you need to provide the namespace too
</span><span style="color:#75715e"></span>target_link_libraries(<span style="color:#f92672">${</span>PROJECT_NAME<span style="color:#f92672">}</span> <span style="color:#e6db74">PRIVATE</span> <span style="color:#e6db74">some::SomeLibrary</span>)</code></pre></div>
<p>The <code>PRIVATE</code> keyword <a href="https://cmake.org/cmake/help/latest/command/target_link_libraries.html#libraries-for-a-target-and-or-its-dependents">means</a> that the library will be used by this project, but it will not be available to other projects via this project&rsquo;s interface. For example, if this project is in turn a library itself, then yet another external/parent project linking to it won&rsquo;t be able to use <code>printSomething()</code> function from the underlying library.</p>
<p>Let&rsquo;s now try to build and run the application:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">$ mkdir build <span style="color:#f92672">&amp;&amp;</span> cd $_

$ cmake -DCMAKE_BUILD_TYPE<span style="color:#f92672">=</span>Release ..

$ cmake --build .
Scanning dependencies of target another-application
<span style="color:#f92672">[</span> 50%<span style="color:#f92672">]</span> Building CXX object CMakeFiles/another-application.dir/main.cpp.o
<span style="color:#f92672">[</span>100%<span style="color:#f92672">]</span> Linking CXX executable another-application
<span style="color:#f92672">[</span>100%<span style="color:#f92672">]</span> Built target another-application

$ ./another-application
base application message
ololo, some string</code></pre></div>
<p>It works!</p>
<h2 id="from-internal-top-level-project">From internal top-level project</h2>
<p>But what if we have our library as a part of some other top-level project, so the library lives in its source tree? Do we still need to build it first and add it to the main project via <code>find_package</code>? Not exactly - now there is no need to &ldquo;find&rdquo; it: the library will be built together with the parent project and then linked to.</p>
<h3 id="adding-nested-library-to-the-main-project">Adding nested library to the main project</h3>
<p>Here&rsquo;s the full project structure:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">$ cd /Users/YOURNAME/code/cpp/internal-project

$ tree .
├── CMakeLists.txt
├── libraries
│   ├── CMakeLists.txt
│   └── SomeLibrary
│       ├── CMakeLists.txt
│       ├── include
│       │   └── some.h
│       └── src
│           ├── some.cpp
│           └── things.h
└── main.cpp</code></pre></div>
<p>The main <code>CMakeLists.txt</code>:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cmake" data-lang="cmake">project(<span style="color:#e6db74">&#34;some-application&#34;</span> <span style="color:#e6db74">VERSION</span> <span style="color:#e6db74">0.9</span> <span style="color:#e6db74">DESCRIPTION</span> <span style="color:#e6db74">&#34;A project with nested library&#34;</span>)<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>add_subdirectory(<span style="color:#e6db74">libraries</span>)<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>add_executable(<span style="color:#f92672">${</span>PROJECT_NAME<span style="color:#f92672">}</span>)<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>target_sources(<span style="color:#f92672">${</span>PROJECT_NAME<span style="color:#f92672">}</span>
    <span style="color:#e6db74">PRIVATE</span>
        <span style="color:#e6db74">main.cpp</span>
)<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>target_link_libraries(<span style="color:#f92672">${</span>PROJECT_NAME<span style="color:#f92672">}</span> <span style="color:#e6db74">PRIVATE</span> <span style="color:#e6db74">SomeLibrary</span>)</code></pre></div>
<p>Yes, it is all the same as with <a href="#from-external-project">external project</a> - we just need to link to the library. No crazy relative paths, just the very same <code>target_link_libraries</code>.</p>
<p>But this time we don&rsquo;t need <code>find_package</code> and also we don&rsquo;t need to provide the namespace. That last part I don&rsquo;t entirely understand, but perhaps that is because everything in the project is supposed to be within the same namespace already?</p>
<p>Following <a href="https://cmake.org/cmake/help/latest/command/add_subdirectory.html">add_subdirectory</a> statement, we get to <code>libraries</code> folder, which also has a <code>CMakeLists.txt</code>:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cmake" data-lang="cmake">add_subdirectory(<span style="color:#e6db74">SomeLibrary</span>)</code></pre></div>
<p>And there we get to our <a href="#the-library">library project</a>.</p>
<h3 id="about-include-paths">About include paths</h3>
<p>Let&rsquo;s start with <code>main.cpp</code>:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;iostream&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;some.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>(<span style="color:#66d9ef">int</span> argc, <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>argv[])
{
    std<span style="color:#f92672">::</span>cout <span style="color:#f92672">&lt;&lt;</span> <span style="color:#e6db74">&#34;base application message&#34;</span> <span style="color:#f92672">&lt;&lt;</span> std<span style="color:#f92672">::</span>endl;
    sm<span style="color:#f92672">::</span>lbr<span style="color:#f92672">::</span>printSomething();
}
</code></pre></div>
<p>While the code here is the same as the one from external project, there is one notable difference - <code>some.h</code> is not prepended with <code>SomeLibrary/</code> in the <code>#include</code> statement.</p>
<p>Why is that, why is it different from the way in was included in external project? Well, it is because that is how this header is placed in the library&rsquo;s source <code>include</code> folder - there is no <code>SomeLibrary</code> folder nested there. But when you install the library, then there is <code>SomeLibrary</code> folder inside <code>include</code> in the installation folder, so in that case you need to add <code>SomeLibrary/</code> to <code>#include</code> statement.</p>
<p>I wasn&rsquo;t sure if that is really how things are, so I went and asked about this on <a href="https://stackoverflow.com/questions/66507441/library-name-to-prefix-headers-names-in-include-statements">StackOverflow</a>, hoping that there is perhaps some way to handle this in a unified way, but the answer was:</p>
<blockquote>You think too "magically" about what CMake can. CMake just calls a compiler/linker with proper parameters. A compiler requires for #include <SomeLibrary/some.h> that a header file will be in the SomeLibrary directory. CMake cannot overcome this requirement.</blockquote>
<p>So if you would like to unify the way you include the library&rsquo;s public headers both in external and internal projects, then you&rsquo;ll need to create <code>SomeLibrary</code> folder inside library&rsquo;s source <code>include</code> folder (<em>yeah, to get the ugly <code>SomeLibrary/include/SomeLibrary</code> path</em>) and adjust the library&rsquo;s <code>CMakeLists.txt</code> accordingly.</p>
<h3 id="building">Building</h3>
<h4 id="main-project">Main project</h4>
<p>Do the usual in the project source tree root:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">$ mkdir build <span style="color:#f92672">&amp;&amp;</span> cd $_
$ cmake -DCMAKE_BUILD_TYPE<span style="color:#f92672">=</span>Debug ..

$ cmake --build .
Scanning dependencies of target SomeLibrary
<span style="color:#f92672">[</span> 25%<span style="color:#f92672">]</span> Building CXX object libraries/SomeLibrary/CMakeFiles/SomeLibrary.dir/src/some.cpp.o
<span style="color:#f92672">[</span> 50%<span style="color:#f92672">]</span> Linking CXX static library libSomeLibraryd.a
<span style="color:#f92672">[</span> 50%<span style="color:#f92672">]</span> Built target SomeLibrary
Scanning dependencies of target some-application
<span style="color:#f92672">[</span> 75%<span style="color:#f92672">]</span> Building CXX object CMakeFiles/some-application.dir/main.cpp.o
<span style="color:#f92672">[</span>100%<span style="color:#f92672">]</span> Linking CXX executable some-application
<span style="color:#f92672">[</span>100%<span style="color:#f92672">]</span> Built target some-application

$ ./some-application
base application message
ololo, some string</code></pre></div>
<p>Eeeeeeeasy!</p>
<h4 id="library-as-a-target">Library as a target</h4>
<p>We can also build and install just the library, without building the entire project. Aside from just going to the library folder and <a href="#building-and-installing">running CMake</a> from there, you can actually do it from the project root - by setting <code>--target</code> option on build:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">$ rm -r ./* <span style="color:#f92672">&amp;&amp;</span> cmake -DCMAKE_BUILD_TYPE<span style="color:#f92672">=</span>Debug ..

$ cmake --build . --target SomeLibrary
Scanning dependencies of target SomeLibrary
<span style="color:#f92672">[</span> 50%<span style="color:#f92672">]</span> Building CXX object libraries/SomeLibrary/CMakeFiles/SomeLibrary.dir/src/some.cpp.o
<span style="color:#f92672">[</span>100%<span style="color:#f92672">]</span> Linking CXX static library libSomeLibraryd.a
<span style="color:#f92672">[</span>100%<span style="color:#f92672">]</span> Built target SomeLibrary

$ cmake --install ./libraries/SomeLibrary
-- Install configuration: <span style="color:#e6db74">&#34;Debug&#34;</span>
-- Installing: /Users/YOURNAME/code/cpp/cmake-library-example/internal-project/install/lib/libSomeLibraryd.a
-- Installing: /Users/YOURNAME/code/cpp/cmake-library-example/internal-project/install/include/SomeLibrary/some.h
-- Installing: /Users/YOURNAME/code/cpp/cmake-library-example/internal-project/install/cmake/SomeLibraryConfig.cmake
-- Installing: /Users/YOURNAME/code/cpp/cmake-library-example/internal-project/install/cmake/SomeLibraryConfig-debug.cmake</code></pre></div>
<p>Here you can also see how you can install a single target with <code>--install</code> option - by pointing it to the target folder inside <code>build</code> folder. Also note that install folder is now on the project&rsquo;s source tree root level, not in the library&rsquo;s nested source folder.</p>
<h1 id="going-deeper">Going deeper</h1>
<h2 id="package-version">Package version</h2>
<p>You can set a version for your library (<code>cmake-library-example/internal-project/libraries/SomeLibrary/CMakeLists.txt</code>):</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cmake" data-lang="cmake">project(<span style="color:#e6db74">&#34;SomeLibrary&#34;</span> <span style="color:#e6db74">DESCRIPTION</span> <span style="color:#e6db74">&#34;Some library&#34;</span>)<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>set(<span style="color:#e6db74">version</span> <span style="color:#e6db74">0.9.1</span>)<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#75715e"># ...
</span><span style="color:#75715e"></span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>include(<span style="color:#e6db74">CMakePackageConfigHelpers</span>)<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>write_basic_package_version_file(
    <span style="color:#e6db74">&#34;${CMAKE_CURRENT_BINARY_DIR}/${PROJECT_NAME}ConfigVersion.cmake&#34;</span>
    <span style="color:#e6db74">VERSION</span> <span style="color:#e6db74">&#34;${version}&#34;</span>
    <span style="color:#e6db74">COMPATIBILITY</span> <span style="color:#e6db74">AnyNewerVersion</span>
)<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>install(<span style="color:#e6db74">FILES</span>
    <span style="color:#e6db74">&#34;${CMAKE_CURRENT_BINARY_DIR}/${PROJECT_NAME}ConfigVersion.cmake&#34;</span>
    <span style="color:#e6db74">DESTINATION</span> <span style="color:#e6db74">cmake</span>
)</code></pre></div>
<p>As a result you will get one more CMake config file in the <code>install</code> folder: <code>SomeLibraryConfigVersion.cmake</code>.</p>
<p>If you now try to find the package in external project (<code>cmake-library-example/external-project/CMakeLists.txt</code>) like this:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cmake" data-lang="cmake">find_package(<span style="color:#e6db74">SomeLibrary</span> <span style="color:#e6db74">0.9.2</span> <span style="color:#e6db74">CONFIG</span> <span style="color:#e6db74">REQUIRED</span>)</code></pre></div>
<p>then you will get the following error on configuration:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">CMake Error at CMakeLists.txt:9 <span style="color:#f92672">(</span>find_package<span style="color:#f92672">)</span>:
  Could not find a configuration file <span style="color:#66d9ef">for</span> package <span style="color:#e6db74">&#34;SomeLibrary&#34;</span> that is
  compatible with requested version <span style="color:#e6db74">&#34;0.9.2&#34;</span>.

  The following configuration files were considered but not accepted:

    /Users/YOURNAME/code/cpp/cmake-library-example/internal-project/install/cmake/SomeLibraryConfig.cmake, version: 0.9.1</code></pre></div>
<h2 id="static-vs-shared">STATIC vs SHARED</h2>
<p>Hopefully, you already know the difference between static and shared libraries. If not, then, <a href="/blog/2018/02/17/build-qt-statically/#why-build-qt-statically">to put it simple</a>, static libraries are &ldquo;bundled&rdquo; into your binaries, and shared libraries are separate files which need to be discoverable by your binaries in order for the latter to work.</p>
<p>A little practical example: let&rsquo;s build our library as static, link to it from external project, then build it as shared and link to that one.</p>
<p>To make our library shared, simply replace <code>STATIC</code> with <code>SHARED</code> in <code>add_library</code> statement (<em>in the library&rsquo;s <code>CMakeLists.txt</code></em>).</p>
<p>So, first thing that is different about resulting executable (<code>another-application</code>) is its size:</p>
<ul>
<li>statically linked with SomeLibrary: 51 920 bytes</li>
<li>dynamically linked with SomeLibrary: 51 616 bytes</li>
</ul>
<p>Not a very noticeable difference (<em>remember that our library just prints a line of text</em>), but it is there: statically linked executable is bigger, because the library is &ldquo;bundled&rdquo; into it.</p>
<p>Secondly, if you now rename or delete <code>libSomeLibrary.dylib</code> (<em><code>libSomeLibrary.so</code>, <code>SomeLibrary.dll</code></em>), then trying to run this dynamically linked application you&rsquo;ll get an error like this on Mac OS:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">$ ./another-application
dyld: Library not loaded: @rpath/libSomeLibrary.dylib
  Referenced from: /Users/YOURNAME/code/cpp/cmake-library-example/external-project/build/./another-application
  Reason: image not found
Abort trap: <span style="color:#ae81ff">6</span></code></pre></div>
<p>or like this on Linux:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">$ ./another-application
./another-application: error <span style="color:#66d9ef">while</span> loading shared libraries: libSomeLibrary.so: cannot open shared object file: No such file or directory</code></pre></div>
<p>So in case of a shared library on Mac OS or Linux it has to either stay available in its installation path, or be placed into the one of the system libraries paths. Be aware that simply copying it to the same folder with executable won&rsquo;t work, unless you set the <code>LD_LIBRARY_PATH</code> variable on Linux (<em>or <code>DYLD_FALLBACK_LIBRARY_PATH</code>/<code>DYLD_LIBRARY_PATH</code> on Mac OS</em>) before running the application:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">$ LD_LIBRARY_PATH<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;.&#34;</span> ./another-application</code></pre></div>
<p>And on Windows it will fail even if you haven&rsquo;t touched the library in its install folder, however you can just copy it to the same folder where executable is, but more on that below.</p>
<h3 id="shared-dll-on-windows">SHARED DLL on Windows</h3>
<p>Shared libraries on Windows are a special thing. There it is not enough just to replace <code>STATIC</code> with <code>SHARED</code> in <code>add_library</code> statement.</p>
<p>If you build and install it having done nothing else, then you will get this error trying to configure a project that needs to link to it:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">CMake Error at C:/code/cmake-library-example/internal-project/libraries/SomeLibrary/install/cmake/SomeLibraryConfig.cmake:72 <span style="color:#f92672">(</span>message<span style="color:#f92672">)</span>:
  The imported target <span style="color:#e6db74">&#34;some::SomeLibrary&#34;</span> references the file

     <span style="color:#e6db74">&#34;C:/code/cmake-library-example/internal-project/libraries/SomeLibrary/install/lib/SomeLibrary.lib&#34;</span>

  but this file does not exist.  Possible reasons include:

  * The file was deleted, renamed, or moved to another location.

  * An install or uninstall procedure did not complete successfully.

  * The installation package was faulty and contained

     <span style="color:#e6db74">&#34;C:/code/cmake-library-example/internal-project/libraries/SomeLibrary/install/cmake/SomeLibraryConfig.cmake&#34;</span>

  but not all the files it references.

Call Stack <span style="color:#f92672">(</span>most recent call first<span style="color:#f92672">)</span>:
  CMakeLists.txt:9 <span style="color:#f92672">(</span>find_package<span style="color:#f92672">)</span></code></pre></div>
<p>And indeed, there is no <code>SomeLibrary.lib</code> in <code>install/lib/</code>, only <code>SomeLibrary.dll</code> in <code>install/bin/</code>. That is because a <a href="https://en.wikipedia.org/wiki/Dynamic-link_library">DLL on Windows</a> needs an explicit listing of all the symbols that it will export, and apparently this is what <code>SomeLibrary.lib</code> is supposed to be.</p>
<p>As I understood, in order to produce it, in past it was required to add <code>__declspec</code> compiler directives to every public single class or function declaration in your library sources, which is quite a bummer, especially if you have a lot of those. Here&rsquo;s <a href="https://cmake.org/pipermail/cmake/2008-August/023194.html">one example</a> of how this is done.</p>
<p>Fortunately, starting with CMake 3.4, this is <a href="https://blog.kitware.com/create-dlls-on-windows-without-declspec-using-new-cmake-export-all-feature/">no longer required</a>. Instead you can just set the <a href="https://cmake.org/cmake/help/latest/prop_tgt/WINDOWS_EXPORT_ALL_SYMBOLS.html">CMAKE_WINDOWS_EXPORT_ALL_SYMBOLS</a> option when configuring the library:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">$ cmake -DCMAKE_WINDOWS_EXPORT_ALL_SYMBOLS<span style="color:#f92672">=</span>TRUE ..</code></pre></div>
<p>If you haven&rsquo;t set <code>SHARED</code> in <code>add_library</code> and it also doesn&rsquo;t explicitly state <code>STATIC</code>, then you can also set <code>-DBUILD_SHARED_LIBS=TRUE</code> option to make that library <code>SHARED</code>.</p>
<p>Either way, now you can build and install the library as usual. However, if you are using Visual Studio <a href="https://cmake.org/cmake/help/latest/manual/cmake-generators.7.html">CMake generator</a>, then <code>-DCMAKE_BUILD_TYPE</code> won&rsquo;t work, because you need to specify configuration on build step:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">$ cmake --build . --target install --config Release</code></pre></div>
<p>After that configuring and building the external application will also succeed, because now it will get that missing <code>SomeLibrary.lib</code>.</p>
<p>However, unlike Mac OS and Linux, trying to run the resulting application will fail even if you haven&rsquo;t touched the <code>SomeLibrary.dll</code> in the install folder:</p>



    <img class="image-post" src="/blog/2021/03/08/cmake-cpp-library/images/dll-was-not-found.png" alt="DLL was not found">


<p>or, if running from Git BASH:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">$ ./Release/another-application.exe
C:/code/cmake-library-example/external-project/build/Release/another-application.exe: error <span style="color:#66d9ef">while</span> loading shared libraries: api-ms-win-crt-heap-l1-1-0.dll: cannot open shared object file: No such file or directory</code></pre></div>
<p>That is because on Windows you need to explicitly put the DLL either to the same folder where the executable is or somewhere in PATH.</p>
<h1 id="final-words-and-repository">Final words and repository</h1>
<p>Later I will probably update the article, because, like I said, here I touched only &ldquo;normal&rdquo; libraries, but there are also <a href="https://cmake.org/cmake/help/latest/command/add_library.html">other kinds</a>. Plus, one can go further than just making a CMake config and create a <a href="https://cmake.org/cmake/help/git-stage/guide/importing-exporting/index.html#creating-packages">proper package</a>. So there are quite a few things left to talk about.</p>
<p>You might have noticed that most of the stuff I was doing on Mac OS, but actually everything (<em>library and sample applications</em>) builds and works just fine also on Linux and Windows.</p>
<p>Full source code of the library, its parent project and external project is available in <a href="https://github.com/retifrav/cmake-library-example">this repository</a>.</p>
      </div>
    </article>
    <div><div id="tags">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tag">
  <path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path><line x1="7" y1="7" x2="7" y2="7"></line>
</svg>
          <a class="tag" href="https://retifrav.github.io/tags/cmake/">cmake</a><a class="tag" href="https://retifrav.github.io/tags/cpp/">cpp</a></div><hr class="comments-divider"/>
      <div id="comments">
      
          <script>
  var id =  59 ;

  if (id)
  {
    let url = "https://github.com/retifrav/retifrav.github.io/issues/".concat(id);
    let api_url = "https://api.github.com/repos/retifrav/retifrav.github.io/issues/".concat(id, "/comments");
    
    var commentsDiv = document.getElementById("comments");

    let xhr = new XMLHttpRequest();
    xhr.responseType = "json";
    xhr.open("GET", api_url);
    xhr.setRequestHeader("Accept", "application/vnd.github.v3.html+json");
    xhr.send();

    xhr.onload = function()
    {
      if (xhr.status != 200)
      {
        let errorText = document.createElement("p");
        errorText.innerHTML = "<i>Comments for this post yet are not opened yet (or you have GitHub scripts disabled).</i>";
        commentsDiv.appendChild(errorText);
      }
      else
      {
        let comments = xhr.response;

        let mainHeader = document.createElement("h2");
        mainHeader.innerHTML = "Comments: ".concat(comments.length);
        commentsDiv.appendChild(mainHeader);

        let issueLink = document.createElement("p");
        issueLink.innerHTML = "<i>You can leave a comment using this <a href='".concat(url, "'>GitHub issue</a>.</i>");
        commentsDiv.appendChild(issueLink);
        
        comments.forEach(function(comment)
        {
            let commentContent = document.createElement("div");
            commentContent.setAttribute('class', 'gh-comment')
            commentContent.innerHTML = "".concat(
                "<div class='gh-header'>",
                  "<img src='", comment.user.avatar_url, "' />",
                  "<div style='margin:auto 0;'>",
                    "<b><a class='gh-username' href='", comment.user.html_url, "'>", comment.user.login, "</a></b>",
                    " commented at <em>", new Date(comment.created_at), "</em>",
                  "</div>",
                "</div>",
                "<div class='gh-body'>",
                  comment.body_html,
                "</div>"
            );
            commentsDiv.appendChild(commentContent);
        });
      }
    };

    xhr.onerror = function()
    {
      let errorText = document.createElement("p");
      errorText.innerHTML = "<i>Some error loading comments.</i>";
      commentsDiv.appendChild(errorText);
    };
  }
</script>

      
      </div>
    </div>
  </div>

        <div id="footer">
          Copyright &copy; 2014-2021 <a href="/about/">retif</a>
        </div>
      </main>
      <div class="app-header">
        <a id="avatar" href="/about"><img class="app-header-avatar" src="/images/avatar.png" /></a>
        
        <div class="sidebar-section">
            <input id="search-query" placeholder="Search in titles and summaries" />
        </div>
        <div id="search-results" style="display:none;"></div>
        <div id="sidebars">
            <div id="telegram" class="sidebar-section">
              <script async src="https://telegram.org/js/telegram-widget.js?5" data-telegram-post="decovar/279" data-width="100%" data-userpic="false"></script>
            </div>
            <div class="sidebar-section">
              <h3>Feeds</h3>
              <a href="/index.xml" title="Subscribe to RSS"><img src="/images/rss.png" width="50px"></a>
              <a style="margin-left: 5px;" href="https://t.me/decovar" title="Telegram channel"><img src="/images/telegram.png" width="50px"></a>
            </div>
            <div class="sidebar-section">
                <h3>Stuff</h3>
                <ul class="sidebar-list">
                    <li><a href="/stuff/kakoi-jvotne-vi-kysaiti/index.html">КАКОИ ЖВОТНЕ ВЫ КУСАИТИ?</a></li>
                </ul>
            </div>
            <div class="sidebar-section">
                <h3>Top</h3>
                <ul class="sidebar-list">
                    <li><a href="/top/cider">Cider</a></li>
                </ul>
            </div>
            <div id="social-networks" class="sidebar-section">
              <h3>Social networks</h3>
              <div style="font-family:Courier New;">
                  Zuck: <i>Yeah so if you ever need info about anyone at Harvard</i><br/>
                  Zuck: <i>Just ask</i><br/>
                  Zuck: <i>I have over 4,000 emails, pictures, addresses, SNS</i><br/>
                  smb: <i>What? How'd you manage that one?</i><br/>
                  Zuck: <i>People just submitted it.</i><br/>
                  Zuck: <i>I don't know why.</i><br/>
                  Zuck: <i>They "trust me"</i><br/>
                  Zuck: <i>Dumb fucks</i>
              </div>
            </div>
            <div class="sidebar-section">
              <h3>Tags</h3>
              <ul style="list-style-type:none; padding:0; margin:0;">
                  
                  <li><a href="/tags/web">web (58)</a></li>
                  
                  <li><a href="/tags/fail">fail (37)</a></li>
                  
                  <li><a href="/tags/dotnet">dotnet (35)</a></li>
                  
                  <li><a href="/tags/qt">qt (31)</a></li>
                  
                  <li><a href="/tags/review">review (26)</a></li>
                  
                  <li><a href="/tags/macos">macos (23)</a></li>
                  
                  <li><a href="/tags/linux">linux (19)</a></li>
                  
                  <li><a href="/tags/devops">devops (18)</a></li>
                  
                  <li><a href="/tags/windows">windows (18)</a></li>
                  
                  <li><a href="/tags/mestuff">mestuff (16)</a></li>
                  
                  <li><a href="/tags/movies">movies (15)</a></li>
                  
                  <li><a href="/tags/tractor">tractor (13)</a></li>
                  
                  <li><a href="/tags/norway">norway (12)</a></li>
                  
                  <li><a href="/tags/telegram">telegram (12)</a></li>
                  
                  <li><a href="/tags/python">python (10)</a></li>
                  
                  <li><a href="/tags/travel">travel (10)</a></li>
                  
                  <li><a href="/tags/applescript">applescript (9)</a></li>
                  
                  <li><a href="/tags/embedded">embedded (9)</a></li>
                  
                  <li><a href="/tags/piracy">piracy (9)</a></li>
                  
                  <li><a href="/tags/soft">soft (9)</a></li>
                  
                  <li><a href="/tags/octopress">octopress (8)</a></li>
                  
                  <li><a href="/tags/banks">banks (7)</a></li>
                  
                  <li><a href="/tags/ios">ios (7)</a></li>
                  
                  <li><a href="/tags/cpp">cpp (6)</a></li>
                  
                  <li><a href="/tags/games">games (6)</a></li>
                  
                  <li><a href="/tags/javascript">javascript (6)</a></li>
                  
                  <li><a href="/tags/photo">photo (6)</a></li>
                  
                  <li><a href="/tags/sql">sql (6)</a></li>
                  
                  <li><a href="/tags/cmake">cmake (5)</a></li>
                  
                  <li><a href="/tags/apple">apple (4)</a></li>
                  
                  <li><a href="/tags/russia">russia (4)</a></li>
                  
                  <li><a href="/tags/wordpress">wordpress (4)</a></li>
                  
                  <li><a href="/tags/android">android (3)</a></li>
                  
                  <li><a href="/tags/hugo">hugo (3)</a></li>
                  
                  <li><a href="/tags/tv">tv (3)</a></li>
                  
                  <li><a href="/tags/unsolved">unsolved (3)</a></li>
                  
                  <li><a href="/tags/usa">usa (3)</a></li>
                  
                  <li><a href="/tags/books">books (1)</a></li>
                  
                  <li><a href="/tags/ffmpeg">ffmpeg (1)</a></li>
                  
                  <li><a href="/tags/irl">irl (1)</a></li>
                  
                  <li><a href="/tags/microsoft">microsoft (1)</a></li>
                  
                  <li><a href="/tags/music">music (1)</a></li>
                  
                  <li><a href="/tags/privacy">privacy (1)</a></li>
                  
                  <li><a href="/tags/vr">vr (1)</a></li>
                  
              </ul>
            </div>
        </div>
      </header>
    </div>

    <script src="/js/search.js"></script>

    
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-53340325-1"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag() { dataLayer.push(arguments); }
      gtag("js", new Date());
      gtag("config", "UA-53340325-1");
    </script>

    
    
  </body>
</html>
