<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>New server and remark42 comments | Declaration of VAR</title>
    <link rel="canonical" href="https://decovar.dev/blog/2021/05/30/new-server-and-remark42-comments/" />

    <meta name="generator" content="Hugo 0.100.2" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <link href="/favicon.png" rel="icon">

    <meta name="author" content="retif" />
    <meta name="description" content="Moving to a new server and new domain, setting up NGINX, GoAccess for visitors analytics, remark42 comments, canonical URL" />

    <link rel="alternate" type="application/rss+xml" href="/index.xml" title="Declaration of VAR" />

    <meta property="og:title" content="New server and remark42 comments" />
<meta property="og:description" content="Moving to a new server and new domain, setting up NGINX, GoAccess for visitors analytics, remark42 comments, canonical URL" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://retifrav.github.io/blog/2021/05/30/new-server-and-remark42-comments/" /><meta property="article:section" content="blog" />
<meta property="article:published_time" content="2021-05-30T18:32:54+02:00" />
<meta property="article:modified_time" content="2021-05-30T18:32:54+02:00" />



    <link rel="stylesheet" href="https://retifrav.github.io/css/main.min.c1a9d5434fbba746ef09ebde219b0064b5d4318930fc8463f51550f13a0e1b54.css" />
    <link rel="stylesheet" href="/css/default.css" />
    <link rel="stylesheet" href="/css/post.css" />
    <link rel="stylesheet" href="/css/page.css" />
    <link rel="stylesheet" href="/css/comments.css" />

    <script src="/js/mark.js"></script>

    
    
  </head>
  <body>
    <div id="body-hat">
      <div id="title-block">
        <h1 id="blog-title"><a href="/">Declaration of VAR</a></h1>
        <p>and some other stuff</p>
      </div>
    </div>
    <div style="background-color:orange; padding:4px 16px; font-size:0.8em; text-align:center; font-style:italic;">
        On 19.05.2021 the website was moved to
        <a href="https://decovar.dev/blog/2021/05/30/new-server-and-remark42-comments/" style="color:black; font-weight:bold;">
            https://decovar.dev/</a>. This is just a mirror now.
    </div>
    <div id="body-flex">
      <main class="app-container">
        
  <div id="main-container">
    <article class="post">
      <header class="post-header">
        <h1 class ="post-title">New server and remark42 comments</h1>
        <div class="post-meta">
          <div><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-calendar">
  <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line>
</svg> 2021-05-30 18:32:54 &#43;0200</div>
          <div><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-clock">
  <circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline>
</svg> 20 min read</div>
        </div>
      </header>
      <div class="post-content">
        <p>I decided to move from <a href="https://pages.github.com/">GitHub Pages</a> to my own server with my own domain. Also I switched from commenting system based on <a href="/blog/2019/04/19/github-comments-hugo/">GitHub issues</a> to <a href="https://remark42.com/">remark42</a> comment engine.</p>


    <img class="image-post" loading="lazy" src="/blog/2021/05/30/new-server-and-remark42-comments/images/moving.jpg" alt="Moving to a new server">

<p>So the main website and the origin is now on <a href="https://decovar.dev/">https://decovar.dev/</a>, and <a href="https://retifrav.github.io/">https://retifrav.github.io/</a> will continue to exist as a mirror on GitHub Pages.</p>
<nav id="TableOfContents">
  <ul>
    <li><a href="#whats-wrong-with-github-pages">What&rsquo;s wrong with GitHub Pages</a></li>
    <li><a href="#new-server-and-domain">New server and domain</a></li>
    <li><a href="#goaccess">GoAccess</a></li>
    <li><a href="#remark42-comments">remark42 comments</a>
      <ul>
        <li><a href="#system-user-config-and-systemd-service">System user, config and systemd service</a></li>
        <li><a href="#nginx-config-and-certificate">NGINX config and certificate</a></li>
        <li><a href="#adding-remark42-to-hugo">Adding remark42 to Hugo</a></li>
        <li><a href="#styling">Styling</a></li>
        <li><a href="#import-from-disqus">Import from Disqus</a></li>
        <li><a href="#authentication">Authentication</a>
          <ul>
            <li><a href="#e-mail">E-mail</a></li>
          </ul>
        </li>
        <li><a href="#api">API</a></li>
        <li><a href="#notifications">Notifications</a>
          <ul>
            <li><a href="#via-telegram">Via Telegram</a></li>
            <li><a href="#via-e-mail">Via e-mail</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#canonical-url">Canonical URL</a></li>
  </ul>
</nav>
<h1 id="whats-wrong-with-github-pages">What&rsquo;s wrong with GitHub Pages</h1>
<p>There is (<em>almost</em>) nothing wrong with GitHub Pages really. It is an awesome service for hosting static websites (<em>such as blogs</em>) free of charge.</p>
<p>But as my blog is getting bigger, I started to think that I might be &ldquo;abusing&rdquo; GitHub&rsquo;s hospitality by hosting relatively heavy resources (<em>such as videos</em>) on the platform.</p>
<p>Also, looking at the overall SJW-hysteria, I am now a bit concerned that some content in my blog can &ldquo;offend&rdquo; somehow yet another snowflake, and I wouldn&rsquo;t like one day to find my blog repository being blocked all of a sudden. I mean, this nonsense alone about changing default branch from <code>master</code> to <code>main</code> was a good enough sign that one should not rely on GitHub solely.</p>
<p>In addition to that, having one&rsquo;s own server provides one with many capabilities, such as having a backend and/or an API, full control over the web-server, visitors analytics and so on.</p>
<h1 id="new-server-and-domain">New server and domain</h1>
<p>Since I&rsquo;m now on my own without GitHub infrastructure, I needed a domain and a web-server.</p>
<p>For the domain I chose <code>decovar.dev</code>, and <code>.dev</code> mandates the use of HTTPS. I already covered that in the <a href="/blog/2021/04/05/acme-sh-instead-of-certbot/">previous post</a>.</p>
<p>The web-server (<em>NGINX-config</em>) part is not very complicated, as not much is needed for serving a static website:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nginx" data-lang="nginx"><span style="display:flex;"><span><span style="color:#66d9ef">server</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">listen</span> <span style="color:#ae81ff">443</span> <span style="color:#e6db74">ssl</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">listen</span> <span style="color:#e6db74">[::]:443</span> <span style="color:#e6db74">ssl</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">server_name</span> <span style="color:#e6db74">decovar.dev</span> <span style="color:#e6db74">www.decovar.dev</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">ssl_certificate</span> <span style="color:#e6db74">/path/to/certs/</span>$server_name/fullchain.pem;
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">ssl_certificate_key</span> <span style="color:#e6db74">/path/to/certs/</span>$server_name/key.pem;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">charset</span> <span style="color:#e6db74">utf-8</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">root</span> <span style="color:#e6db74">/var/www/decovar.dev</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">index</span> <span style="color:#e6db74">index.html</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">error_page</span> <span style="color:#ae81ff">401</span> <span style="color:#e6db74">/401.html</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">error_page</span> <span style="color:#ae81ff">403</span> <span style="color:#e6db74">/403.html</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">error_page</span> <span style="color:#ae81ff">404</span> <span style="color:#e6db74">/404.html</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">location</span> <span style="color:#e6db74">/admin</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">try_files</span> $uri $uri/ =<span style="color:#ae81ff">404</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">auth_basic</span> <span style="color:#e6db74">&#34;Speak,</span> <span style="color:#e6db74">friend,</span> <span style="color:#e6db74">and</span> <span style="color:#e6db74">enter&#34;</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">auth_basic_user_file</span> <span style="color:#e6db74">/etc/nginx/.htpasswd</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">location</span> <span style="color:#e6db74">/</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">try_files</span> $uri $uri/ =<span style="color:#ae81ff">404</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">server</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">listen</span> <span style="color:#ae81ff">80</span> <span style="color:#e6db74">default_server</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">listen</span> <span style="color:#e6db74">[::]:80</span> <span style="color:#e6db74">default_server</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">server_name</span> <span style="color:#e6db74">decovar.dev</span> <span style="color:#e6db74">www.decovar.dev</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">return</span> <span style="color:#ae81ff">301</span> <span style="color:#e6db74">https://</span>$server_name$request_uri;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>So I could set my own error pages for <code>401</code>, <code>403</code> and <code>404</code> codes. The reason for not having those templated with Hugo is simply the fact the Hugo <a href="https://github.com/gohugoio/hugo/issues/1316">only supports 404</a>.</p>
<p>I also protected <code>/admin</code> route with <a href="https://en.wikipedia.org/wiki/Basic_access_authentication">Basic authentication</a> - to add password protection for <a href="#goaccess">GoAccess</a> reports. They are not that secret, actually, so I might make them public later.</p>
<p>Another nice thing about having full control over the web-server is that you can set whatever HTTP headers and MIME types. In my case I wanted to set <code>text/plain</code> for my public PGP key (<em><code>*.asc</code> extension</em>), and with NGINX this is done in <code>/etc/nginx/mime.types</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nginx" data-lang="nginx"><span style="display:flex;"><span><span style="color:#66d9ef">...</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">text/plain</span> <span style="color:#e6db74">txt</span> <span style="color:#e6db74">asc</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">...</span>
</span></span></code></pre></div><p>To see the difference, try opening <a href="/about/retif-public.asc">this</a> and <a href="https://retifrav.github.io/about/retif-public.asc">that</a> link. By the way, Firefox complained about unknown encoding for a plain-text file, which is why I also needed to set <code>charset utf-8;</code> header in the website config.</p>
<h1 id="goaccess">GoAccess</h1>
<p>Having full access to NGINX logs, it is now a grand time to ditch Google Analytics and to use GoAccess instead. I&rsquo;ve <a href="/blog/2020/05/20/visitors-analytics-with-goaccess/">already described</a> this great visitors analytics tool, and here are some additions to that article.</p>
<p>My current host is provided by Oracle Cloud, and what I immediately noticed in NGINX access logs is lots of probing requests to all sorts of routes - that is from the very first day on a completely empty server with no content at all:</p>


    <img class="image-post" loading="lazy" src="/blog/2021/05/30/new-server-and-remark42-comments/images/goaccess-probing-requests.png" alt="Probing requests in GoAccess report">

<p>So basically everything here is probes for environmental files and common CMS routes (<em>with different HTTP methods too</em>). And the list of such requests goes on and on for several pages.</p>
<p>None (<em>except for <code>/</code> and <code>/index.html</code></em>) of these routes belong to my website, and like I said there was actually no website on the server. So my guess is that since Oracle Cloud (<em>also AWS and Azure</em>) are often(?) rented by businesses, IP-ranges of these providers are more likely to get probed like this, comparing with the hosts from other providers. For instance, I also rent servers from a couple of other smaller providers, and none of them have this amount of such probing requests.</p>
<p>Naturally, such spamming completely messes up the analytics. The total number of unique visitors over the measured period (<em>last two months</em>) was <strong>2918</strong> - a value that normally I would be happy to see for my humble blog, but in this case this is obviously not a real number of actual visitors.</p>
<p>So what can be done here? There is a pretty simple solution - to blacklist these trash requests. For example, if we compose a text file <code>requests-blacklisted.txt</code> with something like this:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-txt" data-lang="txt"><span style="display:flex;"><span>/vendor/phpunit/
</span></span><span style="display:flex;"><span>/_ignition/
</span></span><span style="display:flex;"><span>XDEBUG_SESSION_START
</span></span><span style="display:flex;"><span>/solr/admin/
</span></span><span style="display:flex;"><span>/index.php
</span></span><span style="display:flex;"><span>/dnscfg.cgi
</span></span></code></pre></div><p>then here&rsquo;s how this list can be used in the pipe of generating GoAccess report:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ zcat -f /var/log/nginx/access.log* <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    | grep -v -f /path/to/requests-blacklisted.txt <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    | sudo -u www-data goaccess - -o /var/www/decovar.dev/admin/analytics.html
</span></span></code></pre></div><p>However, this way you are risking to accidentally <em>blacklist</em> some routes which you don&rsquo;t have now, but might have in future, so an even better solution would be to first <em>whitelist</em> all the known routes of your website and then optionally <em>blacklist</em> some sub-routes.</p>
<p>In my case, here&rsquo;s what I whitelisted in <code>requests-whitelisted.txt</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>GET <span style="color:#ae81ff">\/\s</span>
</span></span><span style="display:flex;"><span>GET <span style="color:#ae81ff">\/</span>rss<span style="color:#ae81ff">\.</span>xml<span style="color:#ae81ff">\s</span>
</span></span><span style="display:flex;"><span>GET <span style="color:#ae81ff">\/</span>projects<span style="color:#f92672">(</span><span style="color:#ae81ff">\/</span>|<span style="color:#ae81ff">\s</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>GET <span style="color:#ae81ff">\/</span>stuff<span style="color:#f92672">(</span><span style="color:#ae81ff">\/</span>|<span style="color:#ae81ff">\s</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>GET <span style="color:#ae81ff">\/</span>about<span style="color:#f92672">(</span><span style="color:#ae81ff">\/</span>|<span style="color:#ae81ff">\s</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>GET <span style="color:#ae81ff">\/</span>blog<span style="color:#f92672">(</span><span style="color:#ae81ff">\/</span>|<span style="color:#ae81ff">\s</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>GET <span style="color:#ae81ff">\/</span>etc<span style="color:#f92672">(</span><span style="color:#ae81ff">\/</span>|<span style="color:#ae81ff">\s</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>GET <span style="color:#ae81ff">\/</span>top<span style="color:#f92672">(</span><span style="color:#ae81ff">\/</span>|<span style="color:#ae81ff">\s</span><span style="color:#f92672">)</span>
</span></span></code></pre></div><p>I don&rsquo;t see much point in counting requests with methods other than <code>GET</code>, especially for a static website, so I explicitly whitelisted only requests with <code>GET</code> method.</p>
<p>Just in case, if you don&rsquo;t understand why my rules are like this, take a look at any request in NGINX access log, such as this one:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>36.233.31.141 - - <span style="color:#f92672">[</span>30/May/2021:05:39:47 +0000<span style="color:#f92672">]</span> <span style="color:#e6db74">&#34;GET /blog/2017/09/29/virtual-box-on-mac-os/images/virtualbox-host-only-network-adapter.png HTTP/1.1&#34;</span> <span style="color:#ae81ff">200</span> <span style="color:#ae81ff">210740</span> <span style="color:#e6db74">&#34;https://decovar.dev/blog/2017/09/29/virtual-box-on-mac-os/&#34;</span> <span style="color:#e6db74">&#34;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.77 Safari/537.36&#34;</span>
</span></span></code></pre></div><p>Admittedly, it&rsquo;s not the best RegEx in the world for such purpose, but it seems to work.</p>
<p>I could&rsquo;ve also added <code>GET \/ HTTP</code> and maybe also <code>GET \/css\/</code> and <code>GET \/js\/</code> rules, but they add pretty much useless noise in reports, so I haven&rsquo;t.</p>
<p>Anyway, having added this list to the pipe, I almost completely eliminated trash requests from report. Almost - because there were still some, which did not belong to my website, so I modified the file with blacklisted requests like so:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#ae81ff">\.</span><span style="color:#f92672">(</span>jar|jsp|php|asp|aspx|cgi|pl|cfm|htm|nsf<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>GET <span style="color:#ae81ff">\/</span>blog<span style="color:#ae81ff">\/</span>skin<span style="color:#ae81ff">\/</span>?
</span></span><span style="display:flex;"><span>GET <span style="color:#ae81ff">\/</span>blog<span style="color:#ae81ff">\/</span>bad397<span style="color:#ae81ff">\/</span>?
</span></span><span style="display:flex;"><span>GET <span style="color:#ae81ff">\/</span>blog<span style="color:#ae81ff">\/</span>pivot<span style="color:#ae81ff">\/</span>?
</span></span><span style="display:flex;"><span>GET <span style="color:#ae81ff">\/</span>blog<span style="color:#ae81ff">\/</span>guestbook_entries<span style="color:#ae81ff">\/</span>?
</span></span><span style="display:flex;"><span>GET <span style="color:#ae81ff">\/</span>blog<span style="color:#ae81ff">\/</span>administrator<span style="color:#ae81ff">\/</span>?
</span></span><span style="display:flex;"><span>GET <span style="color:#ae81ff">\/</span>blog<span style="color:#ae81ff">\/</span>core<span style="color:#ae81ff">\/</span>?
</span></span><span style="display:flex;"><span>GET <span style="color:#ae81ff">\/</span>blog<span style="color:#ae81ff">\/</span>wp-links<span style="color:#ae81ff">\/</span>?
</span></span><span style="display:flex;"><span>GET <span style="color:#ae81ff">\/</span>blog<span style="color:#ae81ff">\/</span>modules<span style="color:#ae81ff">\/</span>?
</span></span><span style="display:flex;"><span>GET <span style="color:#ae81ff">\/</span>etc<span style="color:#ae81ff">\/</span>shadow<span style="color:#ae81ff">\/</span>?
</span></span><span style="display:flex;"><span>AhrefsBot<span style="color:#ae81ff">\/</span>
</span></span><span style="display:flex;"><span>bingbot<span style="color:#ae81ff">\/</span>
</span></span><span style="display:flex;"><span>BLEXBot<span style="color:#ae81ff">\/</span>
</span></span><span style="display:flex;"><span>DotBot<span style="color:#ae81ff">\/</span>
</span></span><span style="display:flex;"><span>Googlebot<span style="color:#ae81ff">\/</span>
</span></span><span style="display:flex;"><span>MJ12bot<span style="color:#ae81ff">\/</span>
</span></span><span style="display:flex;"><span>PetalBot
</span></span><span style="display:flex;"><span>SemrushBot<span style="color:#ae81ff">\/</span>
</span></span><span style="display:flex;"><span>SeznamBot<span style="color:#ae81ff">\/</span>
</span></span><span style="display:flex;"><span>YandexZenRss<span style="color:#ae81ff">\/</span>
</span></span><span style="display:flex;"><span>ZoominfoBot
</span></span></code></pre></div><p>The second half of the list excludes crawlers, and actually GoAccess seems to have its own lists of crawlers and even a setting to exclude them, but for some reasons that doesn&rsquo;t work for me. Plus not all the crawlers I&rsquo;ve seen are present in GoAccess&rsquo;es list.</p>
<p>And the updated pipe for generating GoAccess report now looks like this:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ zcat -f /var/log/nginx/access.log* <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    | egrep -if /path/to/requests-whitelisted.txt <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    | egrep -vif /path/to/requests-blacklisted.txt <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    | sudo -u www-data goaccess - -o /var/www/decovar.dev/admin/analytics.html
</span></span></code></pre></div><p>So first I apply whitelist and then blacklist. Also note the <code>egrep</code> here - this is to enable proper (<em>extended</em>) mode for regular expressions.</p>
<p>As a result, I now have a clean visitors analytics report:</p>


    <img class="image-post" loading="lazy" src="/blog/2021/05/30/new-server-and-remark42-comments/images/goaccess-whitelisted-requests.png" alt="Whitelisted requests in GoAccess report">

<p>And the number of unique visitors became <strong>248</strong>, which is not as exciting, but is an actual meaningful value.</p>
<h1 id="remark42-comments">remark42 comments</h1>
<p>Having moved out from GitHub, I can no longer use comments based on GitHub issues. At the very least because of CORS, but also because the whole point of moving to my own server was to become independent from 3rd-party infrastructure.</p>
<p>There are several commenting systems available for &ldquo;in-house&rdquo; hosting, but what really caught my eye was <a href="https://github.com/umputun/remark42">remark42</a>. Right away I liked that:</p>
<ul>
<li>it does not require a PostgreSQL/MySQL database</li>
<li>it is quite lightweight</li>
<li>it has good Markdown support</li>
<li>it supports anonymous users, OAuth and e-mail authentication</li>
<li>there is a voting system</li>
<li>there is RSS, e-mail and Telegram notifications</li>
<li>and there is even an API</li>
</ul>
<p>So here&rsquo;s how I added it to my website.</p>
<h2 id="system-user-config-and-systemd-service">System user, config and systemd service</h2>
<p>As usual, first you create a system user for it:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ sudo adduser <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    --system <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    --group <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    --disabled-password <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    remark42
</span></span></code></pre></div><p>Then you get the binary and install it in the system:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ cd /home/remark42/
</span></span><span style="display:flex;"><span>$ wget https://github.com/umputun/remark42/releases/download/v1.8.1/remark42.linux-amd64.tar.gz
</span></span><span style="display:flex;"><span>$ tar -xvf remark42.linux-amd64.tar.gz
</span></span><span style="display:flex;"><span>$ sudo mv remark42.linux-amd64 /usr/local/bin/
</span></span></code></pre></div><p>Official documentation recommends to run it from Docker, but obviously we won&rsquo;t do so, and that complicates things a bit. The setup without Docker is actually not that hard, but I had to refer to <a href="https://blog.lasall.dev/post/hugo-and-comments-with-remark42/">this article</a> a couple of times, as some things were not entirely clear.</p>
<p>To run remark42 you need to pass several mandatory parameters to it. If you&rsquo;d like to provide non-default paths for things like backup folder and avatars, that can be also done via parameters.</p>
<p>If you&rsquo;ll pass those via CLI, that might look like the following:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ /usr/local/bin/remark42.linux-amd64 server --secret<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;SOME-SECRET&#34;</span> --url<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;https://comments.decovar.dev&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    --site<span style="color:#f92672">=</span>decovar.dev --auth.anon --edit-time<span style="color:#f92672">=</span>10m <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    --store.bolt.path<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;/home/remark42/data&#34;</span> --backup<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;/home/remark42/backup&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    --avatar.fs.path<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;/home/remark42/avatars&#34;</span> --avatar.bolt.file<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;/home/remark42/avatars.db&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    --avatar.uri<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;/home/remark42/avatars&#34;</span> --image.fs.path<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;/home/remark42/img/pictures&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    --image.fs.staging<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;/home/remark42/img/pictures.staging&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    --image.bolt.file<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;/home/remark42/img/pictures.db&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    --web-root<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;/home/remark42/web&#34;</span> --port<span style="color:#f92672">=</span><span style="color:#ae81ff">8765</span>
</span></span></code></pre></div><p>Not very convenient, is it. Fortunately, you can put all this into a config/environmental file:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ sudo -u remark42 nano /home/remark42/remark42.conf
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ini" data-lang="ini"><span style="display:flex;"><span><span style="color:#a6e22e">REMARK_URL</span><span style="color:#f92672">=</span><span style="color:#e6db74">https://comments.decovar.dev</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">SECRET</span><span style="color:#f92672">=</span><span style="color:#e6db74">SOME-SECRET</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">REMARK_PORT</span><span style="color:#f92672">=</span><span style="color:#e6db74">8765</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">SITE</span><span style="color:#f92672">=</span><span style="color:#e6db74">decovar.dev</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">AUTH_ANON</span><span style="color:#f92672">=</span><span style="color:#e6db74">true</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">EDIT_TIME</span><span style="color:#f92672">=</span><span style="color:#e6db74">10m</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">AUTH_GITHUB_CID</span><span style="color:#f92672">=</span><span style="color:#e6db74">YOUR-AUTH-GITHUB-CID</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">AUTH_GITHUB_CSEC</span><span style="color:#f92672">=</span><span style="color:#e6db74">YOUR-AUTH-GITHUB-CSEC</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ADMIN_SHARED_ID</span><span style="color:#f92672">=</span><span style="color:#e6db74">YOUR-ACCOUNT-ID</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#ADMIN_PASSWD=SOME-PASSWORD</span>
</span></span></code></pre></div><p>By that moment I also decided not to customize paths and to go with the default ones, especially that they will appear relatively to the working folder anyway.</p>
<p>Unfortunately, there is no option to bind remark42 only to localhost (<em>if you&rsquo;d like to run it behind reverse-proxy</em>), so its port is exposed to the internet by default, and so you might want to add a blocking rule in your firewall for it. I <a href="https://github.com/umputun/remark42/discussions/1000">have asked</a> about this in remark42 repository, and what would you know, developers responded almost immediately and <a href="https://github.com/umputun/remark42/pull/1001/commits/2a60d267d4432e4bfa378c167a5a98e3cfedd5f3">added</a> this option to sources right away, so the next release should have it.</p>
<p>Having created the config, you can now add a systemd service like this:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ sudo nano /etc/systemd/system/remark42.service
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ini" data-lang="ini"><span style="display:flex;"><span><span style="color:#66d9ef">[Unit]</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">Description</span><span style="color:#f92672">=</span><span style="color:#e6db74">remark42</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">After</span><span style="color:#f92672">=</span><span style="color:#e6db74">network.target</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">[Service]</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">Type</span><span style="color:#f92672">=</span><span style="color:#e6db74">simple</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">EnvironmentFile</span><span style="color:#f92672">=</span><span style="color:#e6db74">/home/remark42/remark42.conf</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">WorkingDirectory</span><span style="color:#f92672">=</span><span style="color:#e6db74">/home/remark42</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ExecStart</span><span style="color:#f92672">=</span><span style="color:#e6db74">/usr/local/bin/remark42.linux-amd64 server</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">Restart</span><span style="color:#f92672">=</span><span style="color:#e6db74">always</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">RestartSec</span><span style="color:#f92672">=</span><span style="color:#e6db74">10</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">SyslogIdentifier</span><span style="color:#f92672">=</span><span style="color:#e6db74">remark42</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">User</span><span style="color:#f92672">=</span><span style="color:#e6db74">remark42</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">Group</span><span style="color:#f92672">=</span><span style="color:#e6db74">remark42</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">[Install]</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">WantedBy</span><span style="color:#f92672">=</span><span style="color:#e6db74">multi-user.target</span>
</span></span></code></pre></div><p>Don&rsquo;t forget to enable and run it.</p>
<h2 id="nginx-config-and-certificate">NGINX config and certificate</h2>
<p>Of course, we&rsquo;ll be running remark42 behind NGINX as a reverse-proxy (<code>/etc/nginx/sites-enabled/comments.decovar.dev</code>):</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nginx" data-lang="nginx"><span style="display:flex;"><span><span style="color:#66d9ef">server</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">listen</span> <span style="color:#ae81ff">443</span> <span style="color:#e6db74">ssl</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">listen</span> <span style="color:#e6db74">[::]:443</span> <span style="color:#e6db74">ssl</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">server_name</span> <span style="color:#e6db74">comments.decovar.dev</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">ssl_certificate</span> <span style="color:#e6db74">/path/to/certs/decovar.dev/fullchain.pem</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">ssl_certificate_key</span> <span style="color:#e6db74">/path/to/certs/decovar.dev/key.pem</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">location</span> <span style="color:#e6db74">/</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">proxy_redirect</span> <span style="color:#66d9ef">off</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">proxy_http_version</span> <span style="color:#ae81ff">1</span><span style="color:#e6db74">.1</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">proxy_set_header</span> <span style="color:#e6db74">Upgrade</span> $http_upgrade;
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">proxy_set_header</span> <span style="color:#e6db74">Connection</span> <span style="color:#e6db74">keep-alive</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">proxy_set_header</span> <span style="color:#e6db74">Host</span> $host;
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">proxy_cache_bypass</span> $http_upgrade;
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">proxy_set_header</span> <span style="color:#e6db74">X-Forwarded-For</span> $proxy_add_x_forwarded_for;
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">proxy_set_header</span> <span style="color:#e6db74">X-Forwarded-Proto</span> $scheme;
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">proxy_pass</span> <span style="color:#e6db74">http://127.0.0.1:8765/</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">server</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">listen</span> <span style="color:#ae81ff">80</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">listen</span> <span style="color:#e6db74">[::]:80</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">server_name</span> <span style="color:#e6db74">comments.decovar.dev</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">return</span> <span style="color:#ae81ff">301</span> <span style="color:#e6db74">https://</span>$server_name$request_uri;
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div>
<p>So the service runs on a subdomain (<em>which means you&rsquo;ll need to declare it at your registrar</em>), and the certificate is the same one as for the main domain. Just in case, here&rsquo;s how you can <a href="/blog/2021/04/05/acme-sh-instead-of-certbot/#getting-lets-encrypt-certificate">issue</a> and install Let&rsquo;s Encrypt certificate for more than one domain:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ acme.sh --issue -d decovar.dev -d www.decovar.dev -d comments.decovar.dev -w /var/www/decovar.dev
</span></span><span style="display:flex;"><span>$ acme.sh --install-cert -d decovar.dev -d www.decovar.dev -d comments.decovar.dev <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    --key-file ~/certs/decovar.dev/key.pem  <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    --fullchain-file ~/certs/decovar.dev/fullchain.pem <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    --reloadcmd <span style="color:#e6db74">&#34;sudo systemctl restart nginx.service&#34;</span>
</span></span></code></pre></div><p>The cron job for renewing would be the same:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#ae81ff">45</span> <span style="color:#ae81ff">0</span> * * * <span style="color:#e6db74">&#34;/home/USERNAME/.acme.sh&#34;</span>/acme.sh --cron --home <span style="color:#e6db74">&#34;/home/USERNAME/.acme.sh&#34;</span> --reloadcmd <span style="color:#e6db74">&#34;sudo systemctl restart nginx.service&#34;</span> &gt;&gt; /home/USERNAME/logs/cron.log</span></span></code></pre></div>
<p>In my setup <code>www.decovar.dev</code> is just a ALIAS/CNAME for <code>decovar.dev</code>, so ACME challenge will find the files in <code>/var/www/decovar.dev/.well-known/acme-challenge/</code>. But <code>comments.decovar.dev</code> is served from remark42, so the challenge will fail. To resolve this I could do either of the following in <code>comments.decovar.dev</code> NGINX config:</p>
<ol>
<li>Set <code>/var/www/decovar.dev</code> as the <code>root</code> and do <code>try_files</code> for the <code>/.well-known/acme-challenge/</code> location;</li>
<li>Or simply add a redirect to <code>decovar.dev</code> for this location.</li>
</ol>
<p>I chose the second option:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid;"><code class="language-nginx" data-lang="nginx"><span style="display:flex;"><span><span style="color:#66d9ef">server</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># ...
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex; background-color:#3c3d38"><span>    <span style="color:#75715e">#root /var/www/decovar.dev;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># ...
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">location</span> <span style="color:#e6db74">/</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">proxy_redirect</span> <span style="color:#66d9ef">off</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">proxy_http_version</span> <span style="color:#ae81ff">1</span><span style="color:#e6db74">.1</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">proxy_set_header</span> <span style="color:#e6db74">Upgrade</span> $http_upgrade;
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">proxy_set_header</span> <span style="color:#e6db74">Connection</span> <span style="color:#e6db74">keep-alive</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">proxy_set_header</span> <span style="color:#e6db74">Host</span> $host;
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">proxy_cache_bypass</span> $http_upgrade;
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">proxy_set_header</span> <span style="color:#e6db74">X-Forwarded-For</span> $proxy_add_x_forwarded_for;
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">proxy_set_header</span> <span style="color:#e6db74">X-Forwarded-Proto</span> $scheme;
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">proxy_pass</span> <span style="color:#e6db74">http://127.0.0.1:8765/</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex; background-color:#3c3d38"><span>    <span style="color:#f92672">location</span> <span style="color:#e6db74">/.well-known/acme-challenge/</span> {
</span></span><span style="display:flex; background-color:#3c3d38"><span>        <span style="color:#75715e">#try_files $uri $uri/ =404;
</span></span></span><span style="display:flex; background-color:#3c3d38"><span><span style="color:#75715e"></span>        <span style="color:#f92672">return</span> <span style="color:#ae81ff">301</span> <span style="color:#e6db74">https://decovar.dev</span>$request_uri;
</span></span><span style="display:flex; background-color:#3c3d38"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># ...
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>}</span></span></code></pre></div>
<p>To test if your remark42 setup is correct, documentation suggest to open <code>/web/</code> route on your comments subdomain, such as <a href="https://comments.decovar.dev/web/">https://comments.decovar.dev/web/</a>, but for me this page <a href="https://github.com/umputun/remark42/discussions/1002">is failing</a> (<em>yet another artifact of running without Docker</em>), although this particular problem should be fixed soon. At the same time, comments on the main website are working fine.</p>
<h2 id="adding-remark42-to-hugo">Adding remark42 to Hugo</h2>
<p>To run the remark42 scripts, I created a <code>/layouts/partials/comments.html</code> partial:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-html" data-lang="html"><span style="display:flex;"><span>&lt;<span style="color:#f92672">script</span>&gt;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">remark_config</span> <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">host</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;{{ .Site.Params.remark42url }}&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">site_id</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;{{ .Site.Params.domain }}&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">components</span><span style="color:#f92672">:</span> [<span style="color:#e6db74">&#34;embed&#34;</span>],
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">url</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;{{ .Permalink }}&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">max_shown_comments</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">25</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">theme</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;light&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">page_title</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;{{ .Title }}&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">locale</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;en&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">show_email_subscription</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">false</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">simple_view</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>    };
</span></span><span style="display:flex;"><span>&lt;/<span style="color:#f92672">script</span>&gt;
</span></span><span style="display:flex;"><span>&lt;<span style="color:#f92672">script</span>&gt;<span style="color:#f92672">!</span><span style="color:#66d9ef">function</span>(<span style="color:#a6e22e">e</span>,<span style="color:#a6e22e">n</span>){<span style="color:#66d9ef">for</span>(<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">o</span><span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>;<span style="color:#a6e22e">o</span><span style="color:#f92672">&lt;</span><span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">length</span>;<span style="color:#a6e22e">o</span><span style="color:#f92672">++</span>){<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">r</span><span style="color:#f92672">=</span><span style="color:#a6e22e">n</span>.<span style="color:#a6e22e">createElement</span>(<span style="color:#e6db74">&#34;script&#34;</span>),<span style="color:#a6e22e">c</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;.js&#34;</span>,<span style="color:#a6e22e">d</span><span style="color:#f92672">=</span><span style="color:#a6e22e">n</span>.<span style="color:#a6e22e">head</span><span style="color:#f92672">||</span><span style="color:#a6e22e">n</span>.<span style="color:#a6e22e">body</span>;<span style="color:#e6db74">&#34;noModule&#34;</span><span style="color:#66d9ef">in</span> <span style="color:#a6e22e">r</span><span style="color:#f92672">?</span>(<span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">type</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;module&#34;</span>,<span style="color:#a6e22e">c</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;.mjs&#34;</span>)<span style="color:#f92672">:</span><span style="color:#a6e22e">r</span>.<span style="color:#66d9ef">async</span><span style="color:#f92672">=!</span><span style="color:#ae81ff">0</span>,<span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">defer</span><span style="color:#f92672">=!</span><span style="color:#ae81ff">0</span>,<span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">src</span><span style="color:#f92672">=</span><span style="color:#a6e22e">remark_config</span>.<span style="color:#a6e22e">host</span><span style="color:#f92672">+</span><span style="color:#e6db74">&#34;/web/&#34;</span><span style="color:#f92672">+</span><span style="color:#a6e22e">e</span>[<span style="color:#a6e22e">o</span>]<span style="color:#f92672">+</span><span style="color:#a6e22e">c</span>,<span style="color:#a6e22e">d</span>.<span style="color:#a6e22e">appendChild</span>(<span style="color:#a6e22e">r</span>)}}(<span style="color:#a6e22e">remark_config</span>.<span style="color:#a6e22e">components</span><span style="color:#f92672">||</span>[<span style="color:#e6db74">&#34;embed&#34;</span>],document);&lt;/<span style="color:#f92672">script</span>&gt;
</span></span></code></pre></div><p>It takes some parameters from <code>config.toml</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-toml" data-lang="toml"><span style="display:flex;"><span>[<span style="color:#a6e22e">params</span>]
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">domain</span> = <span style="color:#e6db74">&#34;decovar.dev&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">remark42url</span> = <span style="color:#e6db74">&#34;https://comments.decovar.dev&#34;</span>
</span></span></code></pre></div><p>And also it conveniently makes use of Hugo variables such as <code>.Permalink</code> and <code>.Title</code>.</p>
<p>If you have <a href="#via-e-mail">e-mail notifications</a> set-up, then set <code>show_email_subscription</code> to <code>true</code>. Back then I didn&rsquo;t have it, so I set it to <code>false</code>.</p>
<p>Then I included this partial in the <code>/layouts/_default/single.html</code> template and also added a <code>&lt;div&gt;</code> for loading the actual comments:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-md" data-lang="md"><span style="display:flex;"><span>{{ define &#34;main&#34; }}
</span></span><span style="display:flex;"><span>    &lt;<span style="color:#f92672">article</span> <span style="color:#a6e22e">class</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;post&#34;</span>&gt;
</span></span><span style="display:flex;"><span>        &lt;<span style="color:#f92672">div</span>&gt;
</span></span><span style="display:flex;"><span>            &lt;<span style="color:#f92672">h1</span> <span style="color:#a6e22e">class </span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;post-title&#34;</span>&gt;{{ .Title }}&lt;/<span style="color:#f92672">h1</span>&gt;
</span></span><span style="display:flex;"><span>        &lt;/<span style="color:#f92672">div</span>&gt;
</span></span><span style="display:flex;"><span>        &lt;<span style="color:#f92672">div</span> <span style="color:#a6e22e">class</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;post-content&#34;</span>&gt;
</span></span><span style="display:flex;"><span>            {{ .Content }}
</span></span><span style="display:flex;"><span>        &lt;/<span style="color:#f92672">div</span>&gt;
</span></span><span style="display:flex;"><span>    &lt;/<span style="color:#f92672">article</span>&gt;
</span></span><span style="display:flex;"><span>    {{ with .Params.comments }}
</span></span><span style="display:flex;"><span>        &lt;<span style="color:#f92672">hr</span> <span style="color:#a6e22e">class</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;comments-divider&#34;</span>/&gt;
</span></span><span style="display:flex;"><span>        &lt;<span style="color:#f92672">div</span> <span style="color:#a6e22e">id</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;comments&#34;</span>&gt;
</span></span><span style="display:flex;"><span>            &lt;<span style="color:#f92672">div</span> <span style="color:#a6e22e">id</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;remark42&#34;</span>&gt;&lt;/<span style="color:#f92672">div</span>&gt;
</span></span><span style="display:flex;"><span>        &lt;/<span style="color:#f92672">div</span>&gt;
</span></span><span style="display:flex;"><span>    {{ end }}
</span></span><span style="display:flex;"><span>{{ end }}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>{{ define &#34;AddToBottom&#34; }}
</span></span><span style="display:flex;"><span>    {{ with .Params.comments }}
</span></span><span style="display:flex;"><span>        {{ partial &#34;comments.html&#34; $ }}
</span></span><span style="display:flex;"><span>    {{ end }}
</span></span><span style="display:flex;"><span>{{ end }}
</span></span></code></pre></div><p>The <code>AddToBottom</code> block is defined in <code>/layouts/_default/baseof.html</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-md" data-lang="md"><span style="display:flex;"><span>        ...
</span></span><span style="display:flex;"><span>        {{- block &#34;AddToBottom&#34; .}}{{- end }}
</span></span><span style="display:flex;"><span>    &lt;/<span style="color:#f92672">body</span>&gt;
</span></span><span style="display:flex;"><span>&lt;/<span style="color:#f92672">html</span>&gt;
</span></span></code></pre></div><p>This way comments scripts will be added only on pages that have <code>comments</code> parameter in the front matter, like so:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-md" data-lang="md"><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span>title: &#34;About me&#34;
</span></span><span style="display:flex;"><span>date: 2014-07-30 10:35:42 +0300
</span></span><span style="display:flex;"><span>comments: true
</span></span><span style="display:flex;"><span>---
</span></span></code></pre></div><p>But for pages in the <code>blog</code> section I&rsquo;d like to have comments enabled by default, without adding this parameter to the front matter, so I added the scripts partial unconditionally in the <code>/layouts/blog/single.html</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-md" data-lang="md"><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>    &lt;<span style="color:#f92672">hr</span> <span style="color:#a6e22e">class</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;comments-divider&#34;</span>&gt;
</span></span><span style="display:flex;"><span>    &lt;<span style="color:#f92672">div</span> <span style="color:#a6e22e">id</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;comments&#34;</span>&gt;
</span></span><span style="display:flex;"><span>        &lt;<span style="color:#f92672">div</span> <span style="color:#a6e22e">id</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;remark42&#34;</span>&gt;&lt;/<span style="color:#f92672">div</span>&gt;
</span></span><span style="display:flex;"><span>    &lt;/<span style="color:#f92672">div</span>&gt;
</span></span><span style="display:flex;"><span>{{ end }}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>{{ define &#34;AddToBottom&#34; }}
</span></span><span style="display:flex;"><span>    {{ partial &#34;comments.html&#34; $ }}
</span></span><span style="display:flex;"><span>{{ end }}
</span></span></code></pre></div><h2 id="styling">Styling</h2>
<p><a href="https://github.com/umputun/remark42/issues/5">At the moment</a> remark42 commenting form and comments tree are added to the page via <code>iframe</code>, so setting a custom CSS would not be a very trivial task. One possible <a href="https://maxmastalerz.com/blog/how-to-customize-remark42-css-via-a-proxy-workaround">workaround</a> for that is overwriting or rather redirecting requests to CSS files.</p>
<p>But actually I am totally fine with the &ldquo;stock&rdquo; styles for both comment form and comments tree. What I did want to customize though was the latest comments widget, and that one is not an <code>iframe</code> but a regular <code>div</code>, so here it cometh in <code>comments.scss</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scss" data-lang="scss"><span style="display:flex;"><span><span style="color:#f92672">div</span><span style="color:#a6e22e">.remark42__last-comments</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">margin</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">30</span><span style="color:#66d9ef">px</span> <span style="color:#ae81ff">0</span> <span style="color:#ae81ff">20</span><span style="color:#66d9ef">px</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">article</span><span style="color:#a6e22e">.comment</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">padding</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">margin</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">0</span> <span style="color:#ae81ff">0</span> <span style="color:#ae81ff">10</span><span style="color:#66d9ef">px</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">div</span><span style="color:#a6e22e">.comment__body</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">padding</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">15</span><span style="color:#66d9ef">px</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">border</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">1</span><span style="color:#66d9ef">px</span> dashed $color-dimmed;
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">font-family</span><span style="color:#f92672">:</span> $font-primary;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">.comment__title</span> {
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">margin-bottom</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">5</span><span style="color:#66d9ef">px</span>;
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">color</span><span style="color:#f92672">:</span> $color-primary;
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">font-size</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">1</span><span style="color:#ae81ff">.2</span><span style="color:#66d9ef">em</span>;
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">font-weight</span><span style="color:#f92672">:</span> bold;
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">.comment__title</span> <span style="color:#f92672">&gt;</span> <span style="color:#f92672">a</span> {
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">color</span><span style="color:#f92672">:</span> inherit;
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">.comment__info</span><span style="color:#a6e22e">::after</span> {
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">content</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;: &#34;</span>;
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">.comment__text</span> {
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">font-style</span><span style="color:#f92672">:</span> italic;
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">article</span><span style="color:#a6e22e">.comment</span><span style="color:#a6e22e">:last-of-type</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">margin-bottom</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>And here&rsquo;re before/after screenshots:</p>


    <img class="image-post" loading="lazy" src="/blog/2021/05/30/new-server-and-remark42-comments/images/remark42-last-comments-styling.png" alt="Styling remark42 last comments widget">

<h2 id="import-from-disqus">Import from Disqus</h2>
<p>Another nice thing about remark42 is that it supports importing comments from Disqus. In the very beginning I was using exactly Disqus, before I switched to GitHub issue-based comments, and so it was nice to be able to move over at least the comments from Disqus.</p>
<p>To do so, go to <a href="https://waspenterprises.disqus.com/admin/discussions/export/">Export</a> page (<em>but first try to find it yourself in the Disqus admin panel</em>) and request an export. Some time later you will receive an e-mail with the link to your exported comments. Having the link, go to your host, download the archive, unpack and import to remark42:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ cd /home/remark42/downloads
</span></span><span style="display:flex;"><span>$ sudo -u remark42 wget https://media.disqus.com/uploads/exports/1/1/waspenterprises-2021-05-22T20:31:45.123456-all.xml.gz
</span></span><span style="display:flex;"><span>$ sudo -u remark42 gunzip ./waspenterprises-2021-05-22T20:31:45.123456-all.xml.gz
</span></span><span style="display:flex;"><span>$ sudo -u remark42 remark42.linux-amd64 import -p disqus <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    --secret SOME-SECRET --url https://comments.decovar.dev <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    --admin-passwd SOME-PASSWORD -s decovar.dev <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    -f ./downloads/waspenterprises-2021-05-22T20:31:45.123456-all.xml
</span></span></code></pre></div><p>For that to work you need to have <code>ADMIN_PASSWD</code> set in your remark42 config file. I didn&rsquo;t see that in import/remapping examples which I found on the internet, but as I recall for me either of the commands was complaining about missing mandatory parameters such as <code>--admin-passwd</code>.</p>
<p>Now you need to remap the imported comments from the old page URLs to the new URLs on your domain. Create a file with mapping rules, like so:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ sudo -u remark42 nano rules.txt
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-txt" data-lang="txt"><span style="display:flex;"><span>https://retifrav.github.io* https://decovar.dev*
</span></span></code></pre></div><p>And execute the remapping:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ sudo -u remark42 remark42.linux-amd64 remap <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    --secret SOME-SECRET --url https://comments.decovar.dev <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    --admin-passwd SOME-PASSWORD -f ./rules.txt -s decovar.dev
</span></span></code></pre></div><p>Actually, it wasn&rsquo;t too obvious to guess what rules exactly are expected here. I tried several combinations of rules and parameters for the remapping command, and eventually something worked. What exactly did work - I don&rsquo;t know, because to see if it worked or not, you need to restart the service, and I figured that out only after some time, so maybe the very first attempt was already successful, and all further actions were redundant.</p>
<p>After the remapping all the old Disqus comments magically appeared under the posts on my new website. Shortly after I went to Disqus admin panel and deleted all the comments from the old website there.</p>
<h2 id="authentication">Authentication</h2>
<p>You can enable several authentication methods for users and you can also allow anonymous comments. I did the latter and also enabled <a href="https://github.com/umputun/remark42#github-auth-provider">GitHub authentication</a>. Facebook and Twitter are for retards, so I won&rsquo;t enable those, and others I will think about, perhaps I will at least enable Microsoft too.</p>
<p>Speaking about anonymous comments, at the moment there is no pre-moderation functionality, although it <a href="https://github.com/umputun/remark42/discussions/1019">might be added</a> soon enough.</p>
<h3 id="e-mail">E-mail</h3>
<p>E-mail authentication is also supported, and obviously you will need to have an e-mail sending service for it.</p>
<p>The complexity here is that most likely you&rsquo;d want to use a nice sender e-mail address with your own domain, not a poor man&rsquo;s <code>vasya@gmail.com</code>, so first you&rsquo;ll need to find some service that will provide you e-mail for your domain. You can of course host your own mail server, but that might be too much of a task for an unprepared mind.</p>
<p>remark42 <a href="https://remark42.com/docs/latest/email/">documentation</a> provides examples for services like <a href="https://www.mailgun.com/">Mailgun</a> and <a href="https://sendgrid.com/">SendGrid</a>, but they are just too expensive (<em>or too strict</em>) for a humble blog-owner, so I went with <a href="https://360.yandex.com/business/">Yandex 360</a>: they have a free-of-charge tier called &ldquo;Mail for Domain&rdquo; - exactly what I needed, and this is what I&rsquo;ll use as an example below.</p>
<p>Once you have the e-mail service, in your DNS records set MX record for it and also add a TXT record for the DKIM. You might need to wait for a couple of hours (<em>or maybe days</em>) until the new DNS records are propagated over the internet.</p>
<p>Then add the following to your <code>remark42.conf</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ini" data-lang="ini"><span style="display:flex;"><span><span style="color:#75715e"># enable authentication via e-mail</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">AUTH_EMAIL_ENABLE</span><span style="color:#f92672">=</span><span style="color:#e6db74">true</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># settings for the service that will be sending e-mails (Yandex, in my case)</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">SMTP_HOST</span><span style="color:#f92672">=</span><span style="color:#e6db74">smtp.yandex.com</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">SMTP_PORT</span><span style="color:#f92672">=</span><span style="color:#e6db74">465</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">SMTP_TLS</span><span style="color:#f92672">=</span><span style="color:#e6db74">true</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">SMTP_USERNAME</span><span style="color:#f92672">=</span><span style="color:#e6db74">noreply@decovar.dev</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">SMTP_PASSWORD</span><span style="color:#f92672">=</span><span style="color:#e6db74">PASSWORD-FOR-THAT-ACCOUNT-AT-EMAIL-SERVICE</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># from what address users will be getting authentication e-mails</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">AUTH_EMAIL_FROM</span><span style="color:#f92672">=</span><span style="color:#e6db74">noreply@decovar.dev</span></span></span></code></pre></div>
<p>After restarting remark42 you&rsquo;ll see that the comment form now has an option to sign-in via e-mail:</p>


    <img class="image-post" loading="lazy" src="/blog/2021/05/30/new-server-and-remark42-comments/images/remark42-signin-with-email.png" alt="remark42 sign-in with email">

<p>When a user will try to do so, he will receive a token to the e-mail address he provided, and after entering this token back in the form he will be authenticated in that browser. If he&rsquo;ll want to get authenticated in a different browser, he&rsquo;ll need to repeat the whole procedure, but he still will be authenticated as the same user, of course.</p>
<h2 id="api">API</h2>
<p>There is a REST API, and to use it for administration purposes you need to be logged-in via either of authentication methods and to have your <a href="https://github.com/umputun/remark42#admin-users">user ID</a> added to the <code>ADMIN_SHARED_ID</code> parameter in the config.</p>
<p>Then you&rsquo;ll need to get a JWT. You can take it with Web Developer Tools from any request on a page with comments:</p>


    <img class="image-post" loading="lazy" src="/blog/2021/05/30/new-server-and-remark42-comments/images/remark42-jwt.png" alt="remark42 JWT in Web Developer Tools">

<p>Now you can perform administrator actions. For example, if you&rsquo;d like to delete a comment with <code>COMMENT-ID</code> from <code>https://decovar.dev/some/page.html</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ curl <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    -X <span style="color:#e6db74">&#34;DELETE&#34;</span> <span style="color:#e6db74">&#34;https://comments.decovar.dev/api/v1/admin/comment/COMMENT-ID?site=decovar.dev&amp;url=https:%2F%2Fdecovar.dev%2Fsome%2Fpage.html&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    -H <span style="color:#e6db74">&#39;X-JWT: HERE-GOES-JWT&#39;</span>
</span></span></code></pre></div><h2 id="notifications">Notifications</h2>
<h3 id="via-telegram">Via Telegram</h3>
<p>You can enable <a href="https://remark42.com/docs/latest/telegram/">Telegram notifications</a> in a minute or so. Get a <a href="https://core.telegram.org/bots#creating-a-new-bot">token</a> from <a href="https://t.me/botfather">BotFather</a> (<em>or reuse one of your existing bots</em>) and add the following to the remark42 config:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ini" data-lang="ini"><span style="display:flex;"><span><span style="color:#a6e22e">NOTIFY_TYPE</span><span style="color:#f92672">=</span><span style="color:#e6db74">telegram</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">NOTIFY_TELEGRAM_CHAN</span><span style="color:#f92672">=</span><span style="color:#e6db74">YOUR-ID</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">NOTIFY_TELEGRAM_TOKEN</span><span style="color:#f92672">=</span><span style="color:#e6db74">YOUR-BOT-TOKEN</span>
</span></span></code></pre></div><p>Despite documentation saying that <code>NOTIFY_TELEGRAM_CHAN</code> is for a channel ID, this value can actually be set to either of the following:</p>
<ul>
<li><strong>your own ID</strong> (<em>numerical value, or perhaps <code>@</code>-name also works</em>). In that case the bot will be sending notifications directly to you. It might be that you&rsquo;ll need to send <code>/start</code> to the bot first, as bots cannot message users by default</li>
<li><strong>channel ID</strong>. That can be either a private (<em>numerical value</em>) or a public (<em><code>@</code>-name</em>) channel. Either way, the channel needs to be created first and the bot needs to be added to that channel as an admin</li>
<li><strong>group chat ID</strong> (<em>negative numerical value</em>). The bot needs to be added to that group</li>
</ul>
<p>Here&rsquo;s an example of a notification sent directly to me:</p>


    <img class="image-post" loading="lazy" src="/blog/2021/05/30/new-server-and-remark42-comments/images/telegram-notification.jpg" alt="remark42 Telegram notification" style="border:1px solid black;">

<h3 id="via-e-mail">Via e-mail</h3>
<p>If you already set-up <a href="#e-mail">e-mail service</a>, then you&rsquo;ll only need to add the following lines to your <code>remark42.conf</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ini" data-lang="ini"><span style="display:flex;"><span><span style="color:#a6e22e">NOTIFY_TYPE</span><span style="color:#f92672">=</span><span style="color:#e6db74">telegram,email</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># from which e-mail address USERS will be getting notifications about replies</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">NOTIFY_EMAIL_FROM</span><span style="color:#f92672">=</span><span style="color:#e6db74">noreply@decovar.dev</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># where remark42 will be sending ADMIN notifications to, such as about all the new comments</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ADMIN_SHARED_EMAIL</span><span style="color:#f92672">=</span><span style="color:#e6db74">any@email.com</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># in case you already have ADMIN global comments notifications via Telegram</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">NOTIFY_EMAIL_ADMIN</span><span style="color:#f92672">=</span><span style="color:#e6db74">false</span></span></span></code></pre></div>
<p>Now, if you have <code>show_email_subscription</code> set to <code>true</code> in the comment widget settings, then your (<em>logged-in</em>) users will be able to subscribe to replies to their comments:</p>


    <img class="image-post" loading="lazy" src="/blog/2021/05/30/new-server-and-remark42-comments/images/remark42-email-subscription-to-replies.png" alt="remark42 e-mail subscription to replies" style="border:1px solid black;">

<p>It is a bit confusing, but by default this subscription <a href="https://github.com/umputun/remark42/issues/745#issuecomment-656755889">is disabled</a>, so users will need to explicitly subscribe to notifications and once again provide an e-mail address (<em>even though they are already authenticated and likely have an associated e-mail address</em>). The subscription will then apply to all the pages on the website, not just to the one where user subscribed to notifications on.</p>
<p>Here&rsquo;s how an e-mail notification about a comment reply might look like:</p>


    <img class="image-post" loading="lazy" src="/blog/2021/05/30/new-server-and-remark42-comments/images/remark42-email-notification.png" alt="remark42 email notification" style="border:1px solid black;">

<h1 id="canonical-url">Canonical URL</h1>
<p>Something what I was curious about for quite some time: how search engines such as Google handle the same content published on several websites and/or how can one specify which is the main website and which are just mirrors.</p>
<p>Apparently, this is what <a href="https://en.wikipedia.org/wiki/Canonical_link_element">canonical url</a> is (<em>partly</em>) for. So you just need to add it to <code>&lt;head&gt;</code> on your mirrors, pointing to the main website.</p>
<p>However, Google can still <a href="https://developers.google.com/search/docs/advanced/crawling/consolidate-duplicate-urls#how-googlebot-indexes-and-chooses-the-canonical-url">decide on its own</a>, which page is the origin and which is a mirror, despite your explicit intention. Classic Google.</p>
<p>Either way, here&rsquo;s what I did for the mirror on <a href="https://retifrav.github.io/">https://retifrav.github.io/</a>. First I added the main website base URL as a parameter in <code>config.toml</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-toml" data-lang="toml"><span style="display:flex;"><span>[<span style="color:#a6e22e">params</span>]
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">mainSite</span> = <span style="color:#e6db74">&#34;https://decovar.dev&#34;</span>
</span></span></code></pre></div><p>And then added canonical URL in <code>/layouts/_default/baseof.html</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-html" data-lang="html"><span style="display:flex;"><span>&lt;<span style="color:#f92672">link</span> <span style="color:#a6e22e">rel</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;canonical&#34;</span> <span style="color:#a6e22e">href</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;{{ .Site.Params.mainSite }}{{ .RelPermalink }}&#34;</span> /&gt;
</span></span></code></pre></div><p>Plus I added this orange banner right under the page header block:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-html" data-lang="html"><span style="display:flex;"><span>&lt;<span style="color:#f92672">div</span> <span style="color:#a6e22e">style</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;background-color:orange; padding:4px 16px; font-size:0.8em; text-align:center; font-style:italic;&#34;</span>&gt;
</span></span><span style="display:flex;"><span>    On 19.05.2021 the website was moved to
</span></span><span style="display:flex;"><span>    &lt;<span style="color:#f92672">a</span> <span style="color:#a6e22e">href</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;{{ .Site.Params.mainSite }}{{ .RelPermalink }}&#34;</span> <span style="color:#a6e22e">style</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;color:black; font-weight:bold;&#34;</span>&gt;
</span></span><span style="display:flex;"><span>        {{ .Site.Params.mainSite }}/&lt;/<span style="color:#f92672">a</span>&gt;. This is just a mirror now.
</span></span><span style="display:flex;"><span>&lt;/<span style="color:#f92672">div</span>&gt;
</span></span></code></pre></div><p>Instead of adding canonical URL it might have been better to add a <a href="https://en.wikipedia.org/wiki/HTTP_301">301 redirect</a>, but first of all I don&rsquo;t have access to GitHub Pages web-server, and secondly it won&rsquo;t hurt to have a mirror anyway.</p>
<p>It will be interesting to see a few months later, how does Google Analytics (<em>which I kept enabled on the mirror</em>) compare to GoAccess reports on the main server.</p>
<p>But most importantly, I&rsquo;m very curious about which of the websites will be showing up in search results. Hopefully, canonical URL will play its role, and all the new search queries will lead to the main website rather than to the mirror.</p>



<hr class="updates-divider"/>
<div class="alert alert-info">
    <strong>[25.07.2021] Update:</strong> GoAccess and Google Analytics 2 months later
</div>

<p>So, here&rsquo;s how Google Analytics data looked like on the old domain before moving and adding canonical URL:</p>


    <img class="image-post" loading="lazy" src="/blog/2021/05/30/new-server-and-remark42-comments/images/google-analytics-before.png" alt="Google Analytics on old domain before moving">

<p>350 users per day on average and the following pages being top visited ones:</p>
<ol>
<li><code>/blog/2018/12/02/telegram-bot-webhook-ru/</code></li>
<li><code>/blog/2018/07/23/html-js-screenshot/</code></li>
<li><code>/blog/2018/03/02/create-telegram-sticker-pack/</code></li>
<li><code>/blog/2018/02/17/build-qt-statically/</code></li>
<li><code>/blog/2019/04/17/huawei-e3372-macos/</code></li>
<li><code>/blog/2019/05/26/sdl-imgui/</code></li>
<li><code>/blog/2019/08/04/glfw-dear-imgui/</code></li>
</ol>
<p>Here&rsquo;s how GoAccess analytics looks now on the new server under new domain, 2 months after moving and adding canonical URL on the mirror:</p>


    <img class="image-post" loading="lazy" src="/blog/2021/05/30/new-server-and-remark42-comments/images/goaccess-after.png" alt="GoAccess on new domain 2 months later">

<p>Here it&rsquo;s also approximately 350 users per day and the following top visited pages:</p>
<ol>
<li><code>/blog/2018/07/23/html-js-screenshot/</code></li>
<li><code>/blog/2018/12/02/telegram-bot-webhook-ru/</code></li>
<li><code>/blog/2019/05/26/sdl-imgui/</code></li>
<li><code>/blog/2019/08/04/glfw-dear-imgui/</code></li>
<li><code>/blog/2018/02/17/build-qt-statically/</code></li>
<li><code>/blog/2021/04/05/acme-sh-instead-of-certbot/</code></li>
<li><code>/blog/2018/03/02/create-telegram-sticker-pack/</code></li>
</ol>
<p>So everything is almost the same.</p>
<p>Out of curiosity, here&rsquo;s how Google Analytics looks now on the mirror under the old domain:</p>


    <img class="image-post" loading="lazy" src="/blog/2021/05/30/new-server-and-remark42-comments/images/google-analytics-after.png" alt="Google Analytics on old domain now">

<p>There is still some traffic, but the trend is decreasing. Looks like canonical URL did the job, and search engines find the right origin of the content.</p>
<p>As you can see (<em>once again</em>), you can get visitors analytics data without involving 3rd-party probes such as Google Analytics - you already have web-server logs, nothing can be more precise than that. And you can process it without exposing your visitors data to anyone.</p>
<p>To be fair, there is of course a difference between data from web-server logs and client-side data harvested with Google Analytics script, but I have no interest in knowing my visitors age, gender or any other demographics (<em>and also I despise spying on users</em>), so for my purpose this is all completely redundant.</p>
      </div>
    </article>
    <div><div id="tags">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tag">
  <path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path><line x1="7" y1="7" x2="7" y2="7"></line>
</svg>
          <a class="tag" href="https://retifrav.github.io/tags/web/">web</a><a class="tag" href="https://retifrav.github.io/tags/hugo/">hugo</a><a class="tag" href="https://retifrav.github.io/tags/devops/">devops</a><a class="tag" href="https://retifrav.github.io/tags/linux/">linux</a></div><hr class="comments-divider"/>
      <div id="comments">
      
          <div style="border:2px orange solid; background-color: floralwhite; border-radius:0.5rem; padding: 10px 14px; font-style:italic; font-size:0.9em;">
              If you'd like to comment the article, you can do it on the
              <a href="https://decovar.dev/blog/2021/05/30/new-server-and-remark42-comments/#remark42" style="font-weight:bold;">
                  original website</a>. This one is just a mirror without comments.
          </div>
      
      </div>
    </div>
  </div>

        <div id="footer">
          <div>
              2014-2022,
              <a href="/about/">retif</a>
          </div>
          <div><a href="/about/#licenses">CC BY-SA 4.0 / GPLv3</a></div>
        </div>
      </main>
      <div class="app-header">
        <a id="avatar" href="/about"><img class="app-header-avatar" src="/images/avatar.png" /></a>
        <iframe src="https://github.com/sponsors/retifrav/button"
            height="35" style="border:0;"
            title="You can sponsor me">
        </iframe>
        
        <div class="sidebar-section">
            <input id="search-query" placeholder="Search in titles and summaries" />
        </div>
        <div id="search-results" style="display:none;"></div>
        <div id="sidebars">
            <div id="telegram" class="sidebar-section">
              <script async src="https://telegram.org/js/telegram-widget.js?5"
                  data-telegram-post="decovar/312" data-width="100%" data-userpic="false">
              </script>
            </div>
            <div class="sidebar-section">
              <h3>Feeds</h3>
              <a href="/index.xml" title="Subscribe to RSS"><img src="/images/rss.png" width="50px"></a>
              <a style="margin-left: 5px;" href="https://t.me/decovar" title="Telegram channel"><img src="/images/telegram.png" width="50px"></a>
            </div>
            <div class="sidebar-section">
                <h3>Stuff</h3>
                <ul class="sidebar-list">
                    <li><a href="/stuff/kakoi-jvotne-vi-kysaiti/index.html">КАКОИ ЖВОТНЕ ВЫ КУСАИТИ?</a></li>
                </ul>
            </div>
            <div class="sidebar-section">
                <h3>Top</h3>
                <ul class="sidebar-list">
                    <li><a href="/top/cider">Cider</a></li>
                </ul>
            </div>
            <div id="social-networks" class="sidebar-section">
              <h3>Social networks</h3>
              <div style="font-family:Courier New;">
                  Zuck: <i>Yeah so if you ever need info about anyone at Harvard</i><br/>
                  Zuck: <i>Just ask</i><br/>
                  Zuck: <i>I have over 4,000 emails, pictures, addresses, SNS</i><br/>
                  smb: <i>What? How'd you manage that one?</i><br/>
                  Zuck: <i>People just submitted it.</i><br/>
                  Zuck: <i>I don't know why.</i><br/>
                  Zuck: <i>They "trust me"</i><br/>
                  Zuck: <i>Dumb fucks</i>
              </div>
            </div>
            <div class="sidebar-section">
              <h3>Tags</h3>
              <ul style="list-style-type:none; padding:0; margin:0;">
                  
                  <li><a href="/tags/web">web (64)</a></li>
                  
                  <li><a href="/tags/fail">fail (39)</a></li>
                  
                  <li><a href="/tags/dotnet">dotnet (36)</a></li>
                  
                  <li><a href="/tags/qt">qt (32)</a></li>
                  
                  <li><a href="/tags/review">review (27)</a></li>
                  
                  <li><a href="/tags/devops">devops (24)</a></li>
                  
                  <li><a href="/tags/linux">linux (24)</a></li>
                  
                  <li><a href="/tags/macos">macos (22)</a></li>
                  
                  <li><a href="/tags/windows">windows (18)</a></li>
                  
                  <li><a href="/tags/mestuff">mestuff (16)</a></li>
                  
                  <li><a href="/tags/movies">movies (15)</a></li>
                  
                  <li><a href="/tags/tractor">tractor (14)</a></li>
                  
                  <li><a href="/tags/norway">norway (13)</a></li>
                  
                  <li><a href="/tags/irl">irl (12)</a></li>
                  
                  <li><a href="/tags/telegram">telegram (12)</a></li>
                  
                  <li><a href="/tags/python">python (11)</a></li>
                  
                  <li><a href="/tags/soft">soft (10)</a></li>
                  
                  <li><a href="/tags/travel">travel (10)</a></li>
                  
                  <li><a href="/tags/applescript">applescript (9)</a></li>
                  
                  <li><a href="/tags/embedded">embedded (9)</a></li>
                  
                  <li><a href="/tags/piracy">piracy (9)</a></li>
                  
                  <li><a href="/tags/octopress">octopress (8)</a></li>
                  
                  <li><a href="/tags/banks">banks (7)</a></li>
                  
                  <li><a href="/tags/cmake">cmake (7)</a></li>
                  
                  <li><a href="/tags/cpp">cpp (7)</a></li>
                  
                  <li><a href="/tags/ios">ios (7)</a></li>
                  
                  <li><a href="/tags/apple">apple (6)</a></li>
                  
                  <li><a href="/tags/games">games (6)</a></li>
                  
                  <li><a href="/tags/javascript">javascript (6)</a></li>
                  
                  <li><a href="/tags/photo">photo (6)</a></li>
                  
                  <li><a href="/tags/sql">sql (6)</a></li>
                  
                  <li><a href="/tags/hugo">hugo (4)</a></li>
                  
                  <li><a href="/tags/russia">russia (4)</a></li>
                  
                  <li><a href="/tags/wordpress">wordpress (4)</a></li>
                  
                  <li><a href="/tags/android">android (3)</a></li>
                  
                  <li><a href="/tags/tv">tv (3)</a></li>
                  
                  <li><a href="/tags/usa">usa (3)</a></li>
                  
                  <li><a href="/tags/azure">azure (2)</a></li>
                  
                  <li><a href="/tags/privacy">privacy (2)</a></li>
                  
                  <li><a href="/tags/tvos">tvos (2)</a></li>
                  
                  <li><a href="/tags/unsolved">unsolved (2)</a></li>
                  
                  <li><a href="/tags/books">books (1)</a></li>
                  
                  <li><a href="/tags/ffmpeg">ffmpeg (1)</a></li>
                  
                  <li><a href="/tags/ldap">ldap (1)</a></li>
                  
                  <li><a href="/tags/music">music (1)</a></li>
                  
                  <li><a href="/tags/science">science (1)</a></li>
                  
                  <li><a href="/tags/vr">vr (1)</a></li>
                  
              </ul>
            </div>
        </div>
      </header>
    </div>

    <script src="/js/search.js"></script>

    
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-53340325-1"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag() { dataLayer.push(arguments); }
      gtag("js", new Date());
      gtag("config", "UA-53340325-1");
    </script>

    
    
  </body>
</html>
