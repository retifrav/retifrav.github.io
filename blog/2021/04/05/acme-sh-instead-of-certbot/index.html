<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Let&#39;s Encrypt certificate with acme.sh instead of Certbot | Declaration of VAR</title>
    <link rel="canonical" href="https://decovar.dev/blog/2021/04/05/acme-sh-instead-of-certbot/" />

    <meta name="generator" content="Hugo 0.102.3" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <link href="/favicon.png" rel="icon">

    <meta name="author" content="retif" />
    <meta name="description" content="" />

    <link rel="alternate" type="application/rss+xml" href="/index.xml" title="Declaration of VAR" />

    <meta property="og:title" content="Let&#39;s Encrypt certificate with acme.sh instead of Certbot" />
<meta property="og:description" content="I needed to set-up a new website with HTTPS and so I took Let&rsquo;s Encrypt procedure from my past instructions. But to my surprise, Certbot is installed via Snap now, which is just retarded. That discovery triggered me to remember that I read about other ways of getting Let&rsquo;s Encrypt certificate, such as acme.sh.


    

On top of that, last month Electronic Frontier Foundation (creators of Certbot) announced that they have joined the hounding of Richard Stallman, so now they can go fuck themselves for sure." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://retifrav.github.io/blog/2021/04/05/acme-sh-instead-of-certbot/" /><meta property="article:section" content="blog" />
<meta property="article:published_time" content="2021-04-05T13:08:02+02:00" />
<meta property="article:modified_time" content="2021-04-05T13:08:02+02:00" />



    <link rel="stylesheet" href="https://retifrav.github.io/css/main.min.c1a9d5434fbba746ef09ebde219b0064b5d4318930fc8463f51550f13a0e1b54.css" />
    <link rel="stylesheet" href="/css/default.css" />
    <link rel="stylesheet" href="/css/post.css" />
    <link rel="stylesheet" href="/css/page.css" />
    <link rel="stylesheet" href="/css/comments.css" />

    <script src="/js/mark.js"></script>

    
    
  </head>
  <body>
    <div id="body-hat">
      <div id="title-block">
        <h1 id="blog-title"><a href="/">Declaration of VAR</a></h1>
        <p>and some other stuff</p>
      </div>
    </div>
    <div style="background-color:orange; padding:4px 16px; font-size:0.8em; text-align:center; font-style:italic;">
        On 19.05.2021 the website was moved to
        <a href="https://decovar.dev/blog/2021/04/05/acme-sh-instead-of-certbot/" style="color:black; font-weight:bold;">
            https://decovar.dev/</a>. This is just a mirror now.
    </div>
    <div id="body-flex">
      <main class="app-container">
        
  <div id="main-container">
    <article class="post">
      <header class="post-header">
        <h1 class ="post-title">Let&#39;s Encrypt certificate with acme.sh instead of Certbot</h1>
        <div class="post-meta">
          <div><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-calendar">
  <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line>
</svg> 2021-04-05 13:08:02 &#43;0200</div>
          <div><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-clock">
  <circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline>
</svg> 15 min read</div>
        </div>
      </header>
      <div class="post-content">
        <p>I needed to set-up a new website with HTTPS and so I took Let&rsquo;s Encrypt procedure from my past <a href="/blog/2017/11/28/several-domains-same-server-letsencrypt-tls/#lets-encrypt-certificate">instructions</a>. But to my surprise, <a href="https://certbot.eff.org/lets-encrypt/ubuntufocal-nginx">Certbot</a> is installed via <a href="https://en.wikipedia.org/wiki/Snap_(package_manager)">Snap</a> now, which is just retarded. That discovery triggered me to remember that I read about other ways of getting Let&rsquo;s Encrypt certificate, such as <a href="http://acme.sh/">acme.sh</a>.</p>


    <img class="image-post" loading="lazy" src="/blog/2021/04/05/acme-sh-instead-of-certbot/images/lets-encrypt-acme.jpg" alt="acme.sh instead of Certbot" style="border:1px solid black;">

<p>On top of that, last month <a href="https://en.wikipedia.org/wiki/Electronic_Frontier_Foundation">Electronic Frontier Foundation</a> (<em>creators of Certbot</em>) announced that they <a href="https://www.eff.org/deeplinks/2021/03/statement-re-election-richard-stallman-fsf-board">have joined</a> the hounding of Richard Stallman, so now they can go fuck themselves for sure.</p>
<nav id="TableOfContents">
  <ul>
    <li><a href="#your-domain-and-dns-settings">Your domain and DNS settings</a>
      <ul>
        <li><a href="#looking-for-the-cheapest-domain-registration">Looking for the cheapest domain registration</a></li>
      </ul>
    </li>
    <li><a href="#acmesh">acme.sh</a>
      <ul>
        <li><a href="#installation">Installation</a></li>
        <li><a href="#getting-lets-encrypt-certificate">Getting Let&rsquo;s Encrypt certificate</a></li>
      </ul>
    </li>
    <li><a href="#how-to-use-certificate-with-nginx">How to use certificate with NGINX</a></li>
    <li><a href="#open-443-port">Open 443 port</a></li>
    <li><a href="#updates">Updates</a>
      <ul>
        <li><a href="#21102021--acmesh-now-defaults-to-zerossl">21.10.2021 | acme.sh now defaults to ZeroSSL</a></li>
      </ul>
    </li>
  </ul>
</nav>
<h1 id="your-domain-and-dns-settings">Your domain and DNS settings</h1>
<p>Obviously, you need to have a domain (<em>as an example, let&rsquo;s take <code>domain.dev</code></em>):</p>
<ol>
<li>You register it at some <a href="https://en.wikipedia.org/wiki/Domain_name_registrar">domain registrar</a></li>
<li>DNS records for that domain need to point to the IP address of your host: at the very least there should be an <code>A</code> record pointing your <code>domain.dev</code> to the public IP of your host
<ul>
<li>either you add DNS records right at your registrar</li>
<li>or you point your registrar to nameservers of your web-hoster, and then you manage DNS records (<em>create DNS zone</em>) on web-hoster side</li>
</ul>
</li>
</ol>
<p>I usually was going with nameservers option and was managing DNS records on web-hoster side, but this time my host was a virtual machine created in Oracle Cloud under <a href="https://www.oracle.com/cloud/free/">Free Tier</a> subscription (<em>absolutely amazing deal, by the way</em>), and Free Tier users cannot have DNS zones, so my only option was to set DNS records at registrar (<em>which actually turned out to be a more convenient option</em>).</p>
<p>Below I&rsquo;ll describe how I was getting a new domain, but that&rsquo;s almost completely unrelated to the topic of getting a certificate, so you can just skip to the <a href="#acmesh">next section</a>.</p>
<h2 id="looking-for-the-cheapest-domain-registration">Looking for the cheapest domain registration</h2>
<p>So, I needed to register yet another domain, but this time for myself. And at first I wanted <a href="https://en.wikipedia.org/wiki/.io">.io</a>, but it costs 40-50 USD per year. So I started looking at other domains, and <a href="https://en.wikipedia.org/wiki/.dev">.dev</a> seemed like a good alternative: it is also a cool domain (<em>maybe even cooler</em>) and it costs 15-20 USD per year. What I also liked about this domain is that it <strong>requires</strong> your websites to run via HTTPS. What I didn&rsquo;t like about this domain is that apparently it belongs to Google.</p>
<p>It also seemed like a good time to get an overview of the current situation on the domains market. First I&rsquo;ve checked registrars that I&rsquo;ve been using so far, but neither of them had prices for <code>.dev</code> lower than 15 USD. Then, thanks to <a href="https://get.dev/">Google</a>, I got this list:</p>


    <img class="image-post" loading="lazy" src="/blog/2021/04/05/acme-sh-instead-of-certbot/images/google-recommends-domain-registrars.png" alt="Google recommends domain registrars">

<p>Having compared prices from most of those, I didn&rsquo;t find anything significantly better, but then I got to <a href="https://porkbun.com/">Porkbun</a>, and they offer <code>.dev</code> domains for as low as 12 USD per year.</p>
<p>Out of curiosity, I also checked their prices for my other domains that I already have registered at other registrars, and those turned out to be cheaper as well, some even almost twice as cheap! So I am now considering moving all my domains to Porkbun.</p>
<p>These guys are hilarious: from their website design to domain features like &ldquo;Dejigamaflipper&rdquo;. And if you don&rsquo;t like their name, there is a link in the footer just for you.</p>
<p>Jokes aside, it looks like a great registrar. Not only their seem to have the lowest prices on the market, they also do not charge anything on top for the WHOIS privacy protection (<em>quite often this option costs around 5 USD per year</em>), which is awww. Their website looks alright (<em>though a bit too &ldquo;Bootstraped&rdquo;</em>), they provide <a href="https://porkbun.com/account/api">API</a>, there is 2FA and even <a href="https://en.wikipedia.org/wiki/WebAuthn">WebAuthn</a>.</p>
<p>Sadly, they haven&rsquo;t payed me anything for this promotion (<em>sorrowful oink</em>).</p>
<h1 id="acmesh">acme.sh</h1>
<p>Basically, <code>acme.sh</code> is an ACME protocol client written in shell script. As the bare minimum, it supports issuing a new certificate and automatically renewing it with a <code>cron</code> job.</p>
<h2 id="installation">Installation</h2>
<p>The following command downloads and executes an &ldquo;installer&rdquo; script, which in turn will download and &ldquo;install&rdquo; the <code>acme.sh</code> itself and its assets:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ cd ~
</span></span><span style="display:flex;"><span>$ curl https://get.acme.sh | sh -s email<span style="color:#f92672">=</span>YOUR@EMAIL.com
</span></span><span style="display:flex;"><span>  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
</span></span><span style="display:flex;"><span>                                 Dload  Upload   Total   Spent    Left  Speed
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">100</span>   <span style="color:#ae81ff">937</span>    <span style="color:#ae81ff">0</span>   <span style="color:#ae81ff">937</span>    <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>  <span style="color:#ae81ff">12662</span>      <span style="color:#ae81ff">0</span> --:--:-- --:--:-- --:--:-- <span style="color:#ae81ff">12662</span>
</span></span><span style="display:flex;"><span>  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
</span></span><span style="display:flex;"><span>                                 Dload  Upload   Total   Spent    Left  Speed
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">100</span>  204k  <span style="color:#ae81ff">100</span>  204k    <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span>  1169k      <span style="color:#ae81ff">0</span> --:--:-- --:--:-- --:--:-- 1169k
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>Sat Apr  <span style="color:#ae81ff">3</span> 20:44:45 UTC 2021<span style="color:#f92672">]</span> Installing from online archive.
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>Sat Apr  <span style="color:#ae81ff">3</span> 20:44:45 UTC 2021<span style="color:#f92672">]</span> Downloading https://github.com/acmesh-official/acme.sh/archive/master.tar.gz
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>Sat Apr  <span style="color:#ae81ff">3</span> 20:44:45 UTC 2021<span style="color:#f92672">]</span> Extracting master.tar.gz
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>Sat Apr  <span style="color:#ae81ff">3</span> 20:44:45 UTC 2021<span style="color:#f92672">]</span> It is recommended to install socat first.
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>Sat Apr  <span style="color:#ae81ff">3</span> 20:44:45 UTC 2021<span style="color:#f92672">]</span> We use socat <span style="color:#66d9ef">for</span> standalone server <span style="color:#66d9ef">if</span> you use standalone mode.
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>Sat Apr  <span style="color:#ae81ff">3</span> 20:44:45 UTC 2021<span style="color:#f92672">]</span> If you don<span style="color:#e6db74">&#39;t use standalone mode, just ignore this warning.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Sat Apr  3 20:44:45 UTC 2021] Installing to /home/USERNAME/.acme.sh
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Sat Apr  3 20:44:45 UTC 2021] Installed to /home/USERNAME/.acme.sh/acme.sh
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Sat Apr  3 20:44:45 UTC 2021] Installing alias to &#39;</span>/home/USERNAME/.bashrc<span style="color:#960050;background-color:#1e0010">&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>Sat Apr  <span style="color:#ae81ff">3</span> 20:44:45 UTC 2021<span style="color:#f92672">]</span> OK, Close and reopen your terminal to start using acme.sh
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>Sat Apr  <span style="color:#ae81ff">3</span> 20:44:45 UTC 2021<span style="color:#f92672">]</span> Installing cron job
</span></span><span style="display:flex;"><span>no crontab <span style="color:#66d9ef">for</span> USERNAME
</span></span><span style="display:flex;"><span>no crontab <span style="color:#66d9ef">for</span> USERNAME
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>Sat Apr  <span style="color:#ae81ff">3</span> 20:44:45 UTC 2021<span style="color:#f92672">]</span> Good, bash is found, so change the shebang to use bash as preferred.
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>Sat Apr  <span style="color:#ae81ff">3</span> 20:44:46 UTC 2021<span style="color:#f92672">]</span> OK
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>Sat Apr  <span style="color:#ae81ff">3</span> 20:44:46 UTC 2021<span style="color:#f92672">]</span> Install success!</span></span></code></pre></div>
<p>E-mail is needed to register at Let&rsquo;s Encrypt, so they could send you renewal notice.</p>
<p>Let&rsquo;s see what we got:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ ls -lah ~/.acme.sh/
</span></span><span style="display:flex;"><span>total 236K
</span></span><span style="display:flex;"><span>drwx------ <span style="color:#ae81ff">5</span> USERNAME USERNAME 4.0K Apr  <span style="color:#ae81ff">3</span> 20:44 .
</span></span><span style="display:flex;"><span>drwxr-xr-x <span style="color:#ae81ff">6</span> USERNAME USERNAME 4.0K Apr  <span style="color:#ae81ff">3</span> 20:44 ..
</span></span><span style="display:flex;"><span>-rw-rw-r-- <span style="color:#ae81ff">1</span> USERNAME USERNAME  <span style="color:#ae81ff">193</span> Apr  <span style="color:#ae81ff">3</span> 20:44 account.conf
</span></span><span style="display:flex;"><span>-rwxrwxr-x <span style="color:#ae81ff">1</span> USERNAME USERNAME 205K Apr  <span style="color:#ae81ff">3</span> 20:44 acme.sh
</span></span><span style="display:flex;"><span>-rw-rw-r-- <span style="color:#ae81ff">1</span> USERNAME USERNAME   <span style="color:#ae81ff">90</span> Apr  <span style="color:#ae81ff">3</span> 20:44 acme.sh.env
</span></span><span style="display:flex;"><span>drwxrwxr-x <span style="color:#ae81ff">2</span> USERNAME USERNAME 4.0K Apr  <span style="color:#ae81ff">3</span> 20:44 deploy
</span></span><span style="display:flex;"><span>drwxrwxr-x <span style="color:#ae81ff">2</span> USERNAME USERNAME 4.0K Apr  <span style="color:#ae81ff">3</span> 20:44 dnsapi
</span></span><span style="display:flex;"><span>drwxrwxr-x <span style="color:#ae81ff">2</span> USERNAME USERNAME 4.0K Apr  <span style="color:#ae81ff">3</span> 20:44 notify</span></span></code></pre></div>
<p>It also says that it did something with <code>crontab</code>. Let&rsquo;s check what&rsquo;s new there:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span>$ crontab <span style="color:#f92672">-</span>e
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">45</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">*</span> <span style="color:#f92672">*</span> <span style="color:#f92672">*</span> <span style="color:#e6db74">&#34;/home/USERNAME/.acme.sh&#34;</span><span style="color:#f92672">/</span>acme<span style="color:#f92672">.</span>sh <span style="color:#f92672">--</span>cron <span style="color:#f92672">--</span>home <span style="color:#e6db74">&#34;/home/USERNAME/.acme.sh&#34;</span> <span style="color:#f92672">&gt;</span> <span style="color:#f92672">/</span>dev<span style="color:#f92672">/</span><span style="color:#66d9ef">null</span></span></span></code></pre></div>
<p>So it wants to run the script every day at 00:45. Documentation says that this job will be checking if certificate needs renewal, so it will trigger renewal only when certificate is about to expire. For instance, here&rsquo;s the log I got from running this <code>cron</code> job on schedule:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#f92672">[</span>Mon Apr  <span style="color:#ae81ff">5</span> 00:45:01 UTC 2021<span style="color:#f92672">]</span> <span style="color:#f92672">===</span>Starting cron<span style="color:#f92672">===</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>Mon Apr  <span style="color:#ae81ff">5</span> 00:45:01 UTC 2021<span style="color:#f92672">]</span> Renew: <span style="color:#e6db74">&#39;domain.dev&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>Mon Apr  <span style="color:#ae81ff">5</span> 00:45:01 UTC 2021<span style="color:#f92672">]</span> Skip, Next renewal time is: Wed Jun  <span style="color:#ae81ff">2</span> 20:35:54 UTC <span style="color:#ae81ff">2021</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>Mon Apr  <span style="color:#ae81ff">5</span> 00:45:01 UTC 2021<span style="color:#f92672">]</span> Add <span style="color:#e6db74">&#39;--force&#39;</span> to force to renew.
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>Mon Apr  <span style="color:#ae81ff">5</span> 00:45:01 UTC 2021<span style="color:#f92672">]</span> Skipped domain.dev
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>Mon Apr  <span style="color:#ae81ff">5</span> 00:45:01 UTC 2021<span style="color:#f92672">]</span> <span style="color:#f92672">===</span>End cron<span style="color:#f92672">===</span></span></span></code></pre></div>
<h2 id="getting-lets-encrypt-certificate">Getting Let&rsquo;s Encrypt certificate</h2>
<p>The <code>acme.sh</code> script supports different <a href="https://github.com/acmesh-official/acme.sh#supported-ca">certificate authorities</a>, but I&rsquo;m interested in exactly Let&rsquo;s Encrypt.</p>
<p>In order for Let&rsquo;s Encrypt to verify that you do indeed own the <code>domain.dev</code>, your host will need to pass the ACME verification challenge. There are several types of that challenge, but the easiest (<em>I think</em>) is the <a href="https://letsencrypt.org/docs/challenge-types/#http-01-challenge">HTTP-01</a>:</p>
<ol>
<li>It will generate a verification token, put it to <code>.well-known/acme-challenge/</code> of your website root (<em>suppose it&rsquo;s <code>/var/www/domain.dev/</code></em>) and initialize the challenge</li>
<li>Let&rsquo;s Encrypt will then try to reach <code>http://domain.dev/.well-known/acme-challenge/TOKEN</code>. If it succeeds, then you&rsquo;ve proven that the domain is yours and you&rsquo;ll get a certificate. It&rsquo;s not an issue that <code>.dev</code> enforces HTTPS - this concerns only browsers, so Let&rsquo;s Encrypt will be able to reach the HTTP <code>80</code> port on your host just fine</li>
</ol>
<p>Since the script can be run from a non-root user without <code>sudo</code>, I would recommend to do exactly that. Perhaps you should even create a new user for this purpose. Make sure that user has write access to the website root folder. As I am using NGINX, it is enough to add user to <code>www-data</code> group:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ sudo usermod -a -G www-data USERNAME</span></span></code></pre></div>
<p>If user doesn&rsquo;t get <code>www-data</code> in his groups right away:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ id USERNAME
</span></span><span style="display:flex;"><span>uid<span style="color:#f92672">=</span>107<span style="color:#f92672">(</span>USERNAME<span style="color:#f92672">)</span> gid<span style="color:#f92672">=</span>121<span style="color:#f92672">(</span>USERNAME<span style="color:#f92672">)</span> groups<span style="color:#f92672">=</span>121<span style="color:#f92672">(</span>USERNAME<span style="color:#f92672">)</span></span></span></code></pre></div>
<p>log-off, log-in back and check again:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ id USERNAME
</span></span><span style="display:flex;"><span>uid<span style="color:#f92672">=</span>107<span style="color:#f92672">(</span>USERNAME<span style="color:#f92672">)</span> gid<span style="color:#f92672">=</span>121<span style="color:#f92672">(</span>USERNAME<span style="color:#f92672">)</span> groups<span style="color:#f92672">=</span>121<span style="color:#f92672">(</span>USERNAME<span style="color:#f92672">)</span>,33<span style="color:#f92672">(</span>www-data<span style="color:#f92672">)</span></span></span></code></pre></div>
<p>Then grant access to the website folder:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span>$ sudo mkdir <span style="color:#f92672">-</span>p <span style="color:#f92672">/</span><span style="color:#66d9ef">var</span><span style="color:#f92672">/</span>www<span style="color:#f92672">/</span>domain<span style="color:#f92672">.</span>dev<span style="color:#f92672">/.</span>well<span style="color:#f92672">-</span>known<span style="color:#f92672">/</span>acme<span style="color:#f92672">-</span>challenge
</span></span><span style="display:flex;"><span>$ sudo chown <span style="color:#f92672">-</span>R www<span style="color:#f92672">-</span>data<span style="color:#66d9ef">:</span><span style="color:#66d9ef">www-data</span> <span style="color:#66d9ef">/var/www/domain.dev</span>
</span></span><span style="display:flex;"><span>$ sudo chmod <span style="color:#f92672">-</span>R g<span style="color:#f92672">+</span>rw <span style="color:#f92672">/</span><span style="color:#66d9ef">var</span><span style="color:#f92672">/</span>www<span style="color:#f92672">/</span>domain<span style="color:#f92672">.</span>dev</span></span></code></pre></div>
<p>Finally, NGINX settings:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nginx" data-lang="nginx"><span style="display:flex;"><span><span style="color:#66d9ef">server</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">listen</span> <span style="color:#ae81ff">80</span> <span style="color:#e6db74">default_server</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">listen</span> <span style="color:#e6db74">[::]:80</span> <span style="color:#e6db74">default_server</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">server_name</span> <span style="color:#e6db74">domain.dev</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">root</span> <span style="color:#e6db74">/var/www/</span>$server_name;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">index</span> <span style="color:#e6db74">index.html</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">location</span> <span style="color:#e6db74">/</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">try_files</span> $uri $uri/ =<span style="color:#ae81ff">404</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div>
<p>And you are ready to request a certificate and to try pass the challenge:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ acme.sh --issue -d domain.dev -w /var/www/domain.dev
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>Sat Apr  <span style="color:#ae81ff">3</span> 20:52:13 UTC 2021<span style="color:#f92672">]</span> Using CA: https://acme-v02.api.letsencrypt.org/directory
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>Sat Apr  <span style="color:#ae81ff">3</span> 20:52:14 UTC 2021<span style="color:#f92672">]</span> Create account key ok.
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>Sat Apr  <span style="color:#ae81ff">3</span> 20:52:14 UTC 2021<span style="color:#f92672">]</span> Registering account: https://acme-v02.api.letsencrypt.org/directory
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>Sat Apr  <span style="color:#ae81ff">3</span> 20:52:15 UTC 2021<span style="color:#f92672">]</span> Registered
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>Sat Apr  <span style="color:#ae81ff">3</span> 20:52:15 UTC 2021<span style="color:#f92672">]</span> ACCOUNT_THUMBPRINT<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;07D34pqZi498dFtJwZs8tO-PoF8mM5MKFXaWgx2TkjY&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>Sat Apr  <span style="color:#ae81ff">3</span> 20:52:15 UTC 2021<span style="color:#f92672">]</span> Creating domain key
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>Sat Apr  <span style="color:#ae81ff">3</span> 20:52:15 UTC 2021<span style="color:#f92672">]</span> The domain key is here: /home/USERNAME/.acme.sh/domain.dev/domain.dev.key
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>Sat Apr  <span style="color:#ae81ff">3</span> 20:52:15 UTC 2021<span style="color:#f92672">]</span> Single domain<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;domain.dev&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>Sat Apr  <span style="color:#ae81ff">3</span> 20:52:15 UTC 2021<span style="color:#f92672">]</span> Getting domain auth token <span style="color:#66d9ef">for</span> each domain
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>Sat Apr  <span style="color:#ae81ff">3</span> 20:52:16 UTC 2021<span style="color:#f92672">]</span> Getting webroot <span style="color:#66d9ef">for</span> domain<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;domain.dev&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>Sat Apr  <span style="color:#ae81ff">3</span> 20:52:16 UTC 2021<span style="color:#f92672">]</span> Verifying: domain.dev
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>Sat Apr  <span style="color:#ae81ff">3</span> 20:52:20 UTC 2021<span style="color:#f92672">]</span> Pending
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>Sat Apr  <span style="color:#ae81ff">3</span> 20:52:22 UTC 2021<span style="color:#f92672">]</span> Pending
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>Sat Apr  <span style="color:#ae81ff">3</span> 20:52:25 UTC 2021<span style="color:#f92672">]</span> Pending
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>Sat Apr  <span style="color:#ae81ff">3</span> 20:52:28 UTC 2021<span style="color:#f92672">]</span> domain.dev:Verify error:Fetching http://domain.dev/.well-known/acme-challenge/mfRdXgmXwos0wYgxiplwIB45qJJWxMl_B3ZRqWrgswA: Timeout during connect <span style="color:#f92672">(</span>likely firewall problem<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>Sat Apr  <span style="color:#ae81ff">3</span> 20:52:28 UTC 2021<span style="color:#f92672">]</span> Please add <span style="color:#e6db74">&#39;--debug&#39;</span> or <span style="color:#e6db74">&#39;--log&#39;</span> to check more details.
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>Sat Apr  <span style="color:#ae81ff">3</span> 20:52:28 UTC 2021<span style="color:#f92672">]</span> See: https://github.com/acmesh-official/acme.sh/wiki/How-to-debug-acme.sh</span></span></code></pre></div>
<p>As you can see, for me it failed at first. As I realized, that was because I messed up my DNS records a bit, so they were not pointing my new domain to the right host. After I fixed that, the challenge went well:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ acme.sh --issue -d domain.dev -w /var/www/domain.dev
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>Sat Apr  <span style="color:#ae81ff">3</span> 21:05:27 UTC 2021<span style="color:#f92672">]</span> Using CA: https://acme-v02.api.letsencrypt.org/directory
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>Sat Apr  <span style="color:#ae81ff">3</span> 21:05:27 UTC 2021<span style="color:#f92672">]</span> Single domain<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;domain.dev&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>Sat Apr  <span style="color:#ae81ff">3</span> 21:05:27 UTC 2021<span style="color:#f92672">]</span> Getting domain auth token <span style="color:#66d9ef">for</span> each domain
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>Sat Apr  <span style="color:#ae81ff">3</span> 21:05:29 UTC 2021<span style="color:#f92672">]</span> Getting webroot <span style="color:#66d9ef">for</span> domain<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;domain.dev&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>Sat Apr  <span style="color:#ae81ff">3</span> 21:05:29 UTC 2021<span style="color:#f92672">]</span> Verifying: domain.dev
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>Sat Apr  <span style="color:#ae81ff">3</span> 21:05:32 UTC 2021<span style="color:#f92672">]</span> Pending
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>Sat Apr  <span style="color:#ae81ff">3</span> 21:05:35 UTC 2021<span style="color:#f92672">]</span> Pending
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>Sat Apr  <span style="color:#ae81ff">3</span> 21:05:38 UTC 2021<span style="color:#f92672">]</span> Pending
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>Sat Apr  <span style="color:#ae81ff">3</span> 21:05:40 UTC 2021<span style="color:#f92672">]</span> Success
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>Sat Apr  <span style="color:#ae81ff">3</span> 21:05:40 UTC 2021<span style="color:#f92672">]</span> Verify finished, start to sign.
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>Sat Apr  <span style="color:#ae81ff">3</span> 21:05:40 UTC 2021<span style="color:#f92672">]</span> Lets finalize the order.
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>Sat Apr  <span style="color:#ae81ff">3</span> 21:05:40 UTC 2021<span style="color:#f92672">]</span> Le_OrderFinalize<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;https://acme-v02.api.letsencrypt.org/acme/finalize/117340399/8841120922&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>Sat Apr  <span style="color:#ae81ff">3</span> 21:05:41 UTC 2021<span style="color:#f92672">]</span> Downloading cert.
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>Sat Apr  <span style="color:#ae81ff">3</span> 21:05:41 UTC 2021<span style="color:#f92672">]</span> Le_LinkCert<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;https://acme-v02.api.letsencrypt.org/acme/cert/04o8df0db3041a3vf897b6632a163ddlla74&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>Sat Apr  <span style="color:#ae81ff">3</span> 21:05:42 UTC 2021<span style="color:#f92672">]</span> Cert success.
</span></span><span style="display:flex;"><span>-----BEGIN CERTIFICATE-----
</span></span><span style="display:flex;"><span>HERE-GOES-CERTIFICATE
</span></span><span style="display:flex;"><span>-----END CERTIFICATE-----
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>Sat Apr  <span style="color:#ae81ff">3</span> 21:05:42 UTC 2021<span style="color:#f92672">]</span> Your cert is in  /home/USERNAME/.acme.sh/domain.dev/domain.dev.cer
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>Sat Apr  <span style="color:#ae81ff">3</span> 21:05:42 UTC 2021<span style="color:#f92672">]</span> Your cert key is in  /home/USERNAME/.acme.sh/domain.dev/domain.dev.key
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>Sat Apr  <span style="color:#ae81ff">3</span> 21:05:42 UTC 2021<span style="color:#f92672">]</span> The intermediate CA cert is in  /home/USERNAME/.acme.sh/domain.dev/ca.cer
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>Sat Apr  <span style="color:#ae81ff">3</span> 21:05:42 UTC 2021<span style="color:#f92672">]</span> And the full chain certs is there:  /home/USERNAME/.acme.sh/domain.dev/fullchain.cer</span></span></code></pre></div>
<p>You might also get these errors in the output:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#f92672">[</span>Sat Apr  <span style="color:#ae81ff">3</span> 21:05:27 UTC 2021<span style="color:#f92672">]</span> writing token:9OMrOenJSJl3nYnNelPcXpl3ugQzZ8hbwokAsAcDD0M to /var/www/domain.dev/.well-known/acme-challenge/9OMrOenJSJl3nYnNelPcXpl3ugQzZ8hbwokAsAcDD0M
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>Sat Apr  <span style="color:#ae81ff">3</span> 21:05:27 UTC 2021<span style="color:#f92672">]</span> Changing owner/group of .well-known to www-data:www-data
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>Sat Apr  <span style="color:#ae81ff">3</span> 21:05:27 UTC 2021<span style="color:#f92672">]</span> chown: changing ownership of <span style="color:#e6db74">&#39;/var/www/domain.dev/.well-known/acme-challenge/9OMrOenJSJl3nYnNelPcXpl3ugQzZ8hbwokAsAcDD0M&#39;</span>: Operation not permitted
</span></span><span style="display:flex;"><span>chown: changing ownership of <span style="color:#e6db74">&#39;/var/www/domain.dev/.well-known/acme-challenge&#39;</span>: Operation not permitted
</span></span><span style="display:flex;"><span>chown: changing ownership of <span style="color:#e6db74">&#39;/var/www/domain.dev/.well-known&#39;</span>: Operation not permitted</span></span></code></pre></div>
<p>But it will likely succeed anyway. If not, then you might need to add <code>www-data</code> user to the group of the user that executes <code>acme.sh</code> (<em>as challenge tokens get his ownership</em>).</p>
<p>Now let&rsquo;s see what&rsquo;s new in the folder:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ ls -lah ~/.acme.sh/
</span></span><span style="display:flex;"><span>total 248K
</span></span><span style="display:flex;"><span>drwx------ <span style="color:#ae81ff">7</span> USERNAME USERNAME 4.0K Apr  <span style="color:#ae81ff">3</span> 20:52 .
</span></span><span style="display:flex;"><span>drwxr-xr-x <span style="color:#ae81ff">7</span> USERNAME USERNAME 4.0K Apr  <span style="color:#ae81ff">3</span> 20:46 ..
</span></span><span style="display:flex;"><span>-rw-rw-r-- <span style="color:#ae81ff">1</span> USERNAME USERNAME  <span style="color:#ae81ff">304</span> Apr  <span style="color:#ae81ff">3</span> 21:05 account.conf
</span></span><span style="display:flex;"><span>-rwxrwxr-x <span style="color:#ae81ff">1</span> USERNAME USERNAME 205K Apr  <span style="color:#ae81ff">3</span> 20:44 acme.sh
</span></span><span style="display:flex;"><span>-rw-rw-r-- <span style="color:#ae81ff">1</span> USERNAME USERNAME   <span style="color:#ae81ff">90</span> Apr  <span style="color:#ae81ff">3</span> 20:44 acme.sh.env
</span></span><span style="display:flex;"><span>drwxrwxr-x <span style="color:#ae81ff">3</span> USERNAME USERNAME 4.0K Apr  <span style="color:#ae81ff">3</span> 20:52 ca
</span></span><span style="display:flex;"><span>drwxrwxr-x <span style="color:#ae81ff">2</span> USERNAME USERNAME 4.0K Apr  <span style="color:#ae81ff">3</span> 21:05 domain.dev
</span></span><span style="display:flex;"><span>drwxrwxr-x <span style="color:#ae81ff">2</span> USERNAME USERNAME 4.0K Apr  <span style="color:#ae81ff">3</span> 20:44 deploy
</span></span><span style="display:flex;"><span>drwxrwxr-x <span style="color:#ae81ff">2</span> USERNAME USERNAME 4.0K Apr  <span style="color:#ae81ff">3</span> 20:44 dnsapi
</span></span><span style="display:flex;"><span>-rw-rw-r-- <span style="color:#ae81ff">1</span> USERNAME USERNAME  <span style="color:#ae81ff">490</span> Apr  <span style="color:#ae81ff">3</span> 21:05 http.header
</span></span><span style="display:flex;"><span>drwxrwxr-x <span style="color:#ae81ff">2</span> USERNAME USERNAME 4.0K Apr  <span style="color:#ae81ff">3</span> 20:44 notify</span></span></code></pre></div>
<p>And here&rsquo;s what&rsquo;s inside <code>domain.dev</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ ls -lah ~/.acme.sh/domain.dev/
</span></span><span style="display:flex;"><span>total 36K
</span></span><span style="display:flex;"><span>drwxrwxr-x <span style="color:#ae81ff">2</span> USERNAME USERNAME 4.0K Apr  <span style="color:#ae81ff">3</span> 21:05 .
</span></span><span style="display:flex;"><span>drwx------ <span style="color:#ae81ff">7</span> USERNAME USERNAME 4.0K Apr  <span style="color:#ae81ff">3</span> 20:52 ..
</span></span><span style="display:flex;"><span>-rw-rw-r-- <span style="color:#ae81ff">1</span> USERNAME USERNAME 1.6K Apr  <span style="color:#ae81ff">3</span> 21:05 ca.cer
</span></span><span style="display:flex;"><span>-rw-rw-r-- <span style="color:#ae81ff">1</span> USERNAME USERNAME 1.8K Apr  <span style="color:#ae81ff">3</span> 21:05 domain.dev.cer
</span></span><span style="display:flex;"><span>-rw-rw-r-- <span style="color:#ae81ff">1</span> USERNAME USERNAME  <span style="color:#ae81ff">624</span> Apr  <span style="color:#ae81ff">3</span> 21:05 domain.dev.conf
</span></span><span style="display:flex;"><span>-rw-rw-r-- <span style="color:#ae81ff">1</span> USERNAME USERNAME  <span style="color:#ae81ff">968</span> Apr  <span style="color:#ae81ff">3</span> 21:05 domain.dev.csr
</span></span><span style="display:flex;"><span>-rw-rw-r-- <span style="color:#ae81ff">1</span> USERNAME USERNAME  <span style="color:#ae81ff">206</span> Apr  <span style="color:#ae81ff">3</span> 21:05 domain.dev.csr.conf
</span></span><span style="display:flex;"><span>-rw-rw-r-- <span style="color:#ae81ff">1</span> USERNAME USERNAME 1.7K Apr  <span style="color:#ae81ff">3</span> 20:52 domain.dev.key
</span></span><span style="display:flex;"><span>-rw-rw-r-- <span style="color:#ae81ff">1</span> USERNAME USERNAME 3.4K Apr  <span style="color:#ae81ff">3</span> 21:05 fullchain.cer</span></span></code></pre></div>
<h1 id="how-to-use-certificate-with-nginx">How to use certificate with NGINX</h1>
<p>You could simply use files from <code>~/.acme.sh/domain.dev/</code>, but documentation explicitly says not to do so. Instead you should &ldquo;install&rdquo; the certificate into some other folder (<em>accessible by NGINX&rsquo;s user</em>), for example:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ sudo mkdir -p /home/www-data/certs/domain.dev
</span></span><span style="display:flex;"><span>$ sudo chown -R www-data:www-data /home/www-data
</span></span><span style="display:flex;"><span>$ sudo chmod -R g+rw /home/www-data/certs
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ acme.sh --install-cert -d domain.dev <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--key-file /home/www-data/certs/domain.dev/key.pem  <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--fullchain-file /home/www-data/certs/domain.dev/fullchain.pem <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--reloadcmd <span style="color:#e6db74">&#34;sudo systemctl restart nginx.service&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ sudo chown -R ubuntu:www-data /home/www-data/certs
</span></span><span style="display:flex;"><span>$ sudo chmod -R g+rw /home/www-data/certs
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ ls -l /home/www-data/certs/domain.dev/
</span></span><span style="display:flex;"><span>total <span style="color:#ae81ff">12</span>
</span></span><span style="display:flex;"><span>-rw-rw-r-- <span style="color:#ae81ff">1</span> ubuntu www-data <span style="color:#ae81ff">6696</span> Apr  <span style="color:#ae81ff">3</span> 21:36 fullchain.pem
</span></span><span style="display:flex;"><span>-rw-rw---- <span style="color:#ae81ff">1</span> ubuntu www-data <span style="color:#ae81ff">1675</span> Apr  <span style="color:#ae81ff">3</span> 21:36 key.pem</span></span></code></pre></div>
<p>You might need to allow your user to restart NGINX service by adding a permission for it in <code>/etc/sudoers.d/</code>.</p>
<p>Now you can modify the NGINX config like this:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nginx" data-lang="nginx"><span style="display:flex;"><span><span style="color:#66d9ef">server</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">listen</span> <span style="color:#ae81ff">443</span> <span style="color:#e6db74">ssl</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">listen</span> <span style="color:#e6db74">[::]:443</span> <span style="color:#e6db74">ssl</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">server_name</span> <span style="color:#e6db74">domain.dev</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># if you get SSL_ERROR_INTERNAL_ERROR_ALERT or other errors,
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e"># replace $server_name with actual folder name (domain.dev)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e"># -
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e"># it is also assumed that NGINX is run from www-data user,
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e"># you can verify that in /etc/nginx/nginx.conf
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#f92672">ssl_certificate</span> <span style="color:#e6db74">/home/www-data/certs/</span>$server_name/fullchain.pem;
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">ssl_certificate_key</span> <span style="color:#e6db74">/home/www-data/certs/</span>$server_name/key.pem;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">root</span> <span style="color:#e6db74">/var/www/</span>$server_name;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">index</span> <span style="color:#e6db74">index.html</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">location</span> <span style="color:#e6db74">/</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">try_files</span> $uri $uri/ =<span style="color:#ae81ff">404</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">server</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">listen</span> <span style="color:#ae81ff">80</span> <span style="color:#e6db74">default_server</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">listen</span> <span style="color:#e6db74">[::]:80</span> <span style="color:#e6db74">default_server</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">server_name</span> <span style="color:#e6db74">domain.dev</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">return</span> <span style="color:#ae81ff">301</span> <span style="color:#e6db74">https://</span>$server_name$request_uri;
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div>
<p>Yes, you need to do that manually, as, unlike Certbot, <code>acme.sh</code> does not edit NGINX config files, which is actually nice of it. And as you can see for yourself, the only things required for your website to be served with NGINX via HTTPS are:</p>
<ol>
<li>Listen on <code>443</code> (<em>HTTPS</em>) port
<ul>
<li>also listen on <code>80</code> (<em>HTTP</em>) port, but redirect everything to <code>443</code>
<ul>
<li>for <code>.dev</code> domains that might be redundant, as in browsers they always load over HTTPS due to <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Strict-Transport-Security#preloading_strict_transport_security">HSTS preload</a></li>
</ul>
</li>
</ul>
</li>
<li>Have <code>ssl_certificate</code> and <code>ssl_certificate_key</code> variables set to paths of your certificate and key</li>
</ol>
<p>Coming back to the <code>install-cert</code> command, at first I was confused, because the <code>cron</code> job is only set to renew the certificate when it expires, but there is no job to run <code>install-cert</code>, so who will do that? Then I reckoned that after I ran the initial <code>install-cert</code>, it did something else aside from just copying certificate files to <code>~/certs/domain.dev</code>, and indeed, the <code>~/.acme.sh/domain.dev/domain.dev.conf</code> file seems to have relevant changes:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ini" data-lang="ini"><span style="display:flex;"><span><span style="color:#a6e22e">Le_Domain</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#39;domain.dev&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">...</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">Le_RealKeyPath</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#39;/home/USERNAME/certs/domain.dev/key.pem&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">Le_ReloadCmd</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#39;__ACME_BASE64__START_c3VkbyBzeXN0ZW1jdGwgcmVzdGFydCBuZ2lueC5zZXJ2aWNl__ACME_BASE64__END_&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">Le_RealFullChainPath</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#39;/home/USERNAME/certs/domain.dev/fullchain.pem&#39;</span></span></span></code></pre></div>
<p>So it should be all good then, though I am still confused about the fact that reload command is present both in this config and in the <code>cron</code> job. But okay, I guess, I&rsquo;ll see how it is in a couple of months or so.</p>
<h1 id="open-443-port">Open 443 port</h1>
<p>If your website is still not available via HTTPS, it could be that your host doesn&rsquo;t accept connections on <code>443</code> port. There could be two reasons why.</p>
<p>First, if you are using Oracle Cloud, Microsoft Azure or similar cloud provider, then those have a very limited amount of ports open in their virtual networks by default. In fact, you might need to explicitly open even <code>80</code> port. For example, here&rsquo;s how it looks in my Oracle Cloud panel now:</p>


    <img class="image-post" loading="lazy" src="/blog/2021/04/05/acme-sh-instead-of-certbot/images/oracle-cloud-ports.png" alt="Oracle Cloud ports">

<p>As you see, I needed to add both <code>80</code> and <code>443</code>.</p>
<p>Another reason of blocked <code>443</code> port could be that it is not allowed in firewall rules on the host. Here&rsquo;s what I had:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ sudo iptables -L
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>Chain IN_public_allow <span style="color:#f92672">(</span><span style="color:#ae81ff">1</span> references<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>target     prot opt source               destination
</span></span><span style="display:flex;"><span>ACCEPT     tcp  --  anywhere             anywhere             tcp dpt:ssh ctstate NEW,UNTRACKED
</span></span><span style="display:flex;"><span>ACCEPT     tcp  --  anywhere             anywhere             tcp dpt:http ctstate NEW,UNTRACKED
</span></span><span style="display:flex;"><span>...</span></span></code></pre></div>
<p>So I needed to add a rule for HTTPS too:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ sudo iptables -A IN_public_allow -p tcp --dport <span style="color:#ae81ff">443</span> -j ACCEPT -m conntrack --ctstate NEW,UNTRACKED
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ sudo netfilter-persistent save
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ sudo iptables -L
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>Chain IN_public_allow <span style="color:#f92672">(</span><span style="color:#ae81ff">1</span> references<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>target     prot opt source               destination
</span></span><span style="display:flex;"><span>ACCEPT     tcp  --  anywhere             anywhere             tcp dpt:ssh ctstate NEW,UNTRACKED
</span></span><span style="display:flex;"><span>ACCEPT     tcp  --  anywhere             anywhere             tcp dpt:http ctstate NEW,UNTRACKED
</span></span><span style="display:flex;"><span>ACCEPT     tcp  --  anywhere             anywhere             tcp dpt:https ctstate NEW,UNTRACKED
</span></span><span style="display:flex;"><span>...</span></span></code></pre></div>
<p>To diagnose, which one of these two reasons is causing problems, you can use <code>cURL</code>.</p>
<p>If you get this output after some time of cURL trying to send the request:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ curl -I https://domain.dev
</span></span><span style="display:flex;"><span>curl: <span style="color:#f92672">(</span>7<span style="color:#f92672">)</span> Failed to connect to domain.dev port 443: Operation timed out</span></span></code></pre></div>
<p>&hellip;then the port is likely not allowed in your cloud provider network settings.</p>
<p>If you get this output right away:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ curl -I https://domain.dev
</span></span><span style="display:flex;"><span>curl: <span style="color:#f92672">(</span>7<span style="color:#f92672">)</span> Failed to connect to domain.dev port 443: Connection refused</span></span></code></pre></div>
<p>&hellip;then it means that you need to allow connections to this port in firewall rules on the host.</p>
<p>And successful request would look like this:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ curl -I https://domain.dev
</span></span><span style="display:flex;"><span>HTTP/1.1 <span style="color:#ae81ff">200</span> OK
</span></span><span style="display:flex;"><span>Server: nginx/1.18.0 <span style="color:#f92672">(</span>Ubuntu<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>Date: Mon, <span style="color:#ae81ff">05</span> Apr <span style="color:#ae81ff">2021</span> 11:48:07 GMT
</span></span><span style="display:flex;"><span>Content-Type: text/html
</span></span><span style="display:flex;"><span>Content-Length: <span style="color:#ae81ff">391</span>
</span></span><span style="display:flex;"><span>Last-Modified: Mon, <span style="color:#ae81ff">05</span> Apr <span style="color:#ae81ff">2021</span> 09:43:18 GMT
</span></span><span style="display:flex;"><span>Connection: keep-alive
</span></span><span style="display:flex;"><span>ETag: <span style="color:#e6db74">&#34;606aowe6-324&#34;</span>
</span></span><span style="display:flex;"><span>Accept-Ranges: bytes</span></span></code></pre></div>
<hr class="updates-separator">
<h1 id="updates">Updates</h1>
<h2 id="21102021--acmesh-now-defaults-to-zerossl">21.10.2021 | acme.sh now defaults to ZeroSSL</h2>
<p><a href="https://github.com/acmesh-official/acme.sh/wiki/Change-default-CA-to-ZeroSSL">Starting from 01.08.2021</a> acme.sh defaults to <a href="https://zerossl.com/letsencrypt-alternative/#acme">ZeroSSL</a>.</p>
<p>Can&rsquo;t say if it&rsquo;s bad or good, I noticed it by accident, after I issued a certificate for a new domain on a new server. Can&rsquo;t complain about anything, it seems to just work.</p>
<p>And it is still possible to use Let&rsquo;s Encrypt (<em>or any other <a href="https://github.com/acmesh-official/acme.sh#supported-ca">supported CA</a></em>) with <code>--server letsencrypt</code> parameter.</p>
      </div>
    </article>
    <div><div id="tags">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tag">
  <path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path><line x1="7" y1="7" x2="7" y2="7"></line>
</svg>
          <a class="tag" href="https://retifrav.github.io/tags/web/">web</a><a class="tag" href="https://retifrav.github.io/tags/devops/">devops</a><a class="tag" href="https://retifrav.github.io/tags/linux/">linux</a></div><hr class="comments-divider"/>
      <div id="comments">
      
          <script>
  var id =  61 ;

  if (id)
  {
    let url = "https://github.com/retifrav/retifrav.github.io/issues/".concat(id);
    let api_url = "https://api.github.com/repos/retifrav/retifrav.github.io/issues/".concat(id, "/comments");
    
    var commentsDiv = document.getElementById("comments");

    let xhr = new XMLHttpRequest();
    xhr.responseType = "json";
    xhr.open("GET", api_url);
    xhr.setRequestHeader("Accept", "application/vnd.github.v3.html+json");
    xhr.send();

    xhr.onload = function()
    {
      if (xhr.status != 200)
      {
        let errorText = document.createElement("p");
        errorText.innerHTML = "<i>Comments for this post yet are not opened yet (or you have GitHub scripts disabled).</i>";
        commentsDiv.appendChild(errorText);
      }
      else
      {
        let comments = xhr.response;

        let mainHeader = document.createElement("h2");
        mainHeader.innerHTML = "Comments: ".concat(comments.length);
        commentsDiv.appendChild(mainHeader);

        let issueLink = document.createElement("p");
        issueLink.innerHTML = "<i>You can leave a comment using this <a href='".concat(url, "'>GitHub issue</a>.</i>");
        commentsDiv.appendChild(issueLink);
        
        comments.forEach(function(comment)
        {
            let commentContent = document.createElement("div");
            commentContent.setAttribute('class', 'gh-comment')
            commentContent.innerHTML = "".concat(
                "<div class='gh-header'>",
                  "<img src='", comment.user.avatar_url, "' />",
                  "<div style='margin:auto 0;'>",
                    "<b><a class='gh-username' href='", comment.user.html_url, "'>", comment.user.login, "</a></b>",
                    " commented at <em>", new Date(comment.created_at), "</em>",
                  "</div>",
                "</div>",
                "<div class='gh-body'>",
                  comment.body_html,
                "</div>"
            );
            commentsDiv.appendChild(commentContent);
        });
      }
    };

    xhr.onerror = function()
    {
      let errorText = document.createElement("p");
      errorText.innerHTML = "<i>Some error loading comments.</i>";
      commentsDiv.appendChild(errorText);
    };
  }
</script>

      
      </div>
    </div>
  </div>

        <div id="footer">
          <div>
              2014-2022,
              <a href="/about/">retif</a>
          </div>
          <div><a href="/about/#licenses">CC BY-SA 4.0 / GPLv3</a></div>
        </div>
      </main>
      <div class="app-header">
        <a id="avatar" href="/about"><img class="app-header-avatar" src="/images/avatar.png" /></a>
        <iframe src="https://github.com/sponsors/retifrav/button"
            height="35" style="border:0;"
            title="You can sponsor me">
        </iframe>
        
        <div class="sidebar-section">
            <input id="search-query" placeholder="Search in titles and summaries" />
        </div>
        <div id="search-results" style="display:none;"></div>
        <div id="sidebars">
            <div id="telegram" class="sidebar-section">
              <script async src="https://telegram.org/js/telegram-widget.js?5"
                  data-telegram-post="decovar/312" data-width="100%" data-userpic="false">
              </script>
            </div>
            <div class="sidebar-section">
              <h3>Feeds</h3>
              <a href="/index.xml" title="Subscribe to RSS"><img src="/images/rss.png" width="50px"></a>
              <a style="margin-left: 5px;" href="https://t.me/decovar" title="Telegram channel"><img src="/images/telegram.png" width="50px"></a>
            </div>
            <div class="sidebar-section">
                <h3>Stuff</h3>
                <ul class="sidebar-list">
                    <li><a href="/stuff/kakoi-jvotne-vi-kysaiti/index.html">КАКОИ ЖВОТНЕ ВЫ КУСАИТИ?</a></li>
                </ul>
            </div>
            <div id="social-networks" class="sidebar-section">
              <h3>Social networks</h3>
              <div style="font-family:Courier New;">
                  Zuck: <i>Yeah so if you ever need info about anyone at Harvard</i><br/>
                  Zuck: <i>Just ask</i><br/>
                  Zuck: <i>I have over 4,000 emails, pictures, addresses, SNS</i><br/>
                  smb: <i>What? How'd you manage that one?</i><br/>
                  Zuck: <i>People just submitted it.</i><br/>
                  Zuck: <i>I don't know why.</i><br/>
                  Zuck: <i>They "trust me"</i><br/>
                  Zuck: <i>Dumb fucks</i>
              </div>
            </div>
            <div class="sidebar-section">
              <h3>Tags</h3>
              <ul style="list-style-type:none; padding:0; margin:0;">
                  
                  <li><a href="/tags/web">web (65)</a></li>
                  
                  <li><a href="/tags/fail">fail (39)</a></li>
                  
                  <li><a href="/tags/dotnet">dotnet (36)</a></li>
                  
                  <li><a href="/tags/qt">qt (32)</a></li>
                  
                  <li><a href="/tags/review">review (27)</a></li>
                  
                  <li><a href="/tags/devops">devops (24)</a></li>
                  
                  <li><a href="/tags/linux">linux (24)</a></li>
                  
                  <li><a href="/tags/macos">macos (22)</a></li>
                  
                  <li><a href="/tags/windows">windows (18)</a></li>
                  
                  <li><a href="/tags/mestuff">mestuff (16)</a></li>
                  
                  <li><a href="/tags/movies">movies (15)</a></li>
                  
                  <li><a href="/tags/tractor">tractor (14)</a></li>
                  
                  <li><a href="/tags/norway">norway (13)</a></li>
                  
                  <li><a href="/tags/irl">irl (12)</a></li>
                  
                  <li><a href="/tags/python">python (12)</a></li>
                  
                  <li><a href="/tags/telegram">telegram (12)</a></li>
                  
                  <li><a href="/tags/soft">soft (10)</a></li>
                  
                  <li><a href="/tags/travel">travel (10)</a></li>
                  
                  <li><a href="/tags/applescript">applescript (9)</a></li>
                  
                  <li><a href="/tags/embedded">embedded (9)</a></li>
                  
                  <li><a href="/tags/piracy">piracy (9)</a></li>
                  
                  <li><a href="/tags/octopress">octopress (8)</a></li>
                  
                  <li><a href="/tags/banks">banks (7)</a></li>
                  
                  <li><a href="/tags/cmake">cmake (7)</a></li>
                  
                  <li><a href="/tags/cpp">cpp (7)</a></li>
                  
                  <li><a href="/tags/ios">ios (7)</a></li>
                  
                  <li><a href="/tags/apple">apple (6)</a></li>
                  
                  <li><a href="/tags/games">games (6)</a></li>
                  
                  <li><a href="/tags/javascript">javascript (6)</a></li>
                  
                  <li><a href="/tags/photo">photo (6)</a></li>
                  
                  <li><a href="/tags/sql">sql (6)</a></li>
                  
                  <li><a href="/tags/hugo">hugo (4)</a></li>
                  
                  <li><a href="/tags/russia">russia (4)</a></li>
                  
                  <li><a href="/tags/wordpress">wordpress (4)</a></li>
                  
                  <li><a href="/tags/android">android (3)</a></li>
                  
                  <li><a href="/tags/azure">azure (3)</a></li>
                  
                  <li><a href="/tags/tv">tv (3)</a></li>
                  
                  <li><a href="/tags/usa">usa (3)</a></li>
                  
                  <li><a href="/tags/privacy">privacy (2)</a></li>
                  
                  <li><a href="/tags/tvos">tvos (2)</a></li>
                  
                  <li><a href="/tags/unsolved">unsolved (2)</a></li>
                  
                  <li><a href="/tags/books">books (1)</a></li>
                  
                  <li><a href="/tags/ffmpeg">ffmpeg (1)</a></li>
                  
                  <li><a href="/tags/ldap">ldap (1)</a></li>
                  
                  <li><a href="/tags/music">music (1)</a></li>
                  
                  <li><a href="/tags/science">science (1)</a></li>
                  
                  <li><a href="/tags/vr">vr (1)</a></li>
                  
              </ul>
            </div>
        </div>
      </header>
    </div>

    <script src="/js/search.js"></script>

    
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-53340325-1"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag() { dataLayer.push(arguments); }
      gtag("js", new Date());
      gtag("config", "UA-53340325-1");
    </script>

    
    
  </body>
</html>
